<html>
 <head>
  <meta charset="utf-8"/>
  <meta content="width=device-width, initial-scale=1.0" name="viewport"/>
  <title>
   Notebook
  </title>
  <style type="text/css">
   /*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*
 * Mozilla scrollbar styling
 */

/* use standard opaque scrollbars for most nodes */
[data-jp-theme-scrollbars='true'] {
  scrollbar-color: rgb(var(--jp-scrollbar-thumb-color))
    var(--jp-scrollbar-background-color);
}

/* for code nodes, use a transparent style of scrollbar. These selectors
 * will match lower in the tree, and so will override the above */
[data-jp-theme-scrollbars='true'] .CodeMirror-hscrollbar,
[data-jp-theme-scrollbars='true'] .CodeMirror-vscrollbar {
  scrollbar-color: rgba(var(--jp-scrollbar-thumb-color), 0.5) transparent;
}

/* tiny scrollbar */

.jp-scrollbar-tiny {
  scrollbar-color: rgba(var(--jp-scrollbar-thumb-color), 0.5) transparent;
  scrollbar-width: thin;
}

/* tiny scrollbar */

.jp-scrollbar-tiny::-webkit-scrollbar,
.jp-scrollbar-tiny::-webkit-scrollbar-corner {
  background-color: transparent;
  height: 4px;
  width: 4px;
}

.jp-scrollbar-tiny::-webkit-scrollbar-thumb {
  background: rgba(var(--jp-scrollbar-thumb-color), 0.5);
}

.jp-scrollbar-tiny::-webkit-scrollbar-track:horizontal {
  border-left: 0 solid transparent;
  border-right: 0 solid transparent;
}

.jp-scrollbar-tiny::-webkit-scrollbar-track:vertical {
  border-top: 0 solid transparent;
  border-bottom: 0 solid transparent;
}

/*
 * Lumino
 */

.lm-ScrollBar[data-orientation='horizontal'] {
  min-height: 16px;
  max-height: 16px;
  min-width: 45px;
  border-top: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='vertical'] {
  min-width: 16px;
  max-width: 16px;
  min-height: 45px;
  border-left: 1px solid #a0a0a0;
}

.lm-ScrollBar-button {
  background-color: #f0f0f0;
  background-position: center center;
  min-height: 15px;
  max-height: 15px;
  min-width: 15px;
  max-width: 15px;
}

.lm-ScrollBar-button:hover {
  background-color: #dadada;
}

.lm-ScrollBar-button.lm-mod-active {
  background-color: #cdcdcd;
}

.lm-ScrollBar-track {
  background: #f0f0f0;
}

.lm-ScrollBar-thumb {
  background: #cdcdcd;
}

.lm-ScrollBar-thumb:hover {
  background: #bababa;
}

.lm-ScrollBar-thumb.lm-mod-active {
  background: #a0a0a0;
}

.lm-ScrollBar[data-orientation='horizontal'] .lm-ScrollBar-thumb {
  height: 100%;
  min-width: 15px;
  border-left: 1px solid #a0a0a0;
  border-right: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='vertical'] .lm-ScrollBar-thumb {
  width: 100%;
  min-height: 15px;
  border-top: 1px solid #a0a0a0;
  border-bottom: 1px solid #a0a0a0;
}

.lm-ScrollBar[data-orientation='horizontal']
  .lm-ScrollBar-button[data-action='decrement'] {
  background-image: var(--jp-icon-caret-left);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='horizontal']
  .lm-ScrollBar-button[data-action='increment'] {
  background-image: var(--jp-icon-caret-right);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='vertical']
  .lm-ScrollBar-button[data-action='decrement'] {
  background-image: var(--jp-icon-caret-up);
  background-size: 17px;
}

.lm-ScrollBar[data-orientation='vertical']
  .lm-ScrollBar-button[data-action='increment'] {
  background-image: var(--jp-icon-caret-down);
  background-size: 17px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-Widget {
  box-sizing: border-box;
  position: relative;
  overflow: hidden;
}

.lm-Widget.lm-mod-hidden {
  display: none !important;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.lm-AccordionPanel[data-orientation='horizontal'] > .lm-AccordionPanel-title {
  /* Title is rotated for horizontal accordion panel using CSS */
  display: block;
  transform-origin: top left;
  transform: rotate(-90deg) translate(-100%);
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-CommandPalette {
  display: flex;
  flex-direction: column;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-CommandPalette-search {
  flex: 0 0 auto;
}

.lm-CommandPalette-content {
  flex: 1 1 auto;
  margin: 0;
  padding: 0;
  min-height: 0;
  overflow: auto;
  list-style-type: none;
}

.lm-CommandPalette-header {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.lm-CommandPalette-item {
  display: flex;
  flex-direction: row;
}

.lm-CommandPalette-itemIcon {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemContent {
  flex: 1 1 auto;
  overflow: hidden;
}

.lm-CommandPalette-itemShortcut {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemLabel {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.lm-close-icon {
  border: 1px solid transparent;
  background-color: transparent;
  position: absolute;
  z-index: 1;
  right: 3%;
  top: 0;
  bottom: 0;
  margin: auto;
  padding: 7px 0;
  display: none;
  vertical-align: middle;
  outline: 0;
  cursor: pointer;
}
.lm-close-icon:after {
  content: 'X';
  display: block;
  width: 15px;
  height: 15px;
  text-align: center;
  color: #000;
  font-weight: normal;
  font-size: 12px;
  cursor: pointer;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-DockPanel {
  z-index: 0;
}

.lm-DockPanel-widget {
  z-index: 0;
}

.lm-DockPanel-tabBar {
  z-index: 1;
}

.lm-DockPanel-handle {
  z-index: 2;
}

.lm-DockPanel-handle.lm-mod-hidden {
  display: none !important;
}

.lm-DockPanel-handle:after {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  content: '';
}

.lm-DockPanel-handle[data-orientation='horizontal'] {
  cursor: ew-resize;
}

.lm-DockPanel-handle[data-orientation='vertical'] {
  cursor: ns-resize;
}

.lm-DockPanel-handle[data-orientation='horizontal']:after {
  left: 50%;
  min-width: 8px;
  transform: translateX(-50%);
}

.lm-DockPanel-handle[data-orientation='vertical']:after {
  top: 50%;
  min-height: 8px;
  transform: translateY(-50%);
}

.lm-DockPanel-overlay {
  z-index: 3;
  box-sizing: border-box;
  pointer-events: none;
}

.lm-DockPanel-overlay.lm-mod-hidden {
  display: none !important;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-Menu {
  z-index: 10000;
  position: absolute;
  white-space: nowrap;
  overflow-x: hidden;
  overflow-y: auto;
  outline: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-Menu-content {
  margin: 0;
  padding: 0;
  display: table;
  list-style-type: none;
}

.lm-Menu-item {
  display: table-row;
}

.lm-Menu-item.lm-mod-hidden,
.lm-Menu-item.lm-mod-collapsed {
  display: none !important;
}

.lm-Menu-itemIcon,
.lm-Menu-itemSubmenuIcon {
  display: table-cell;
  text-align: center;
}

.lm-Menu-itemLabel {
  display: table-cell;
  text-align: left;
}

.lm-Menu-itemShortcut {
  display: table-cell;
  text-align: right;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-MenuBar {
  outline: none;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-MenuBar-content {
  margin: 0;
  padding: 0;
  display: flex;
  flex-direction: row;
  list-style-type: none;
}

.lm-MenuBar-item {
  box-sizing: border-box;
}

.lm-MenuBar-itemIcon,
.lm-MenuBar-itemLabel {
  display: inline-block;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-ScrollBar {
  display: flex;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-ScrollBar[data-orientation='horizontal'] {
  flex-direction: row;
}

.lm-ScrollBar[data-orientation='vertical'] {
  flex-direction: column;
}

.lm-ScrollBar-button {
  box-sizing: border-box;
  flex: 0 0 auto;
}

.lm-ScrollBar-track {
  box-sizing: border-box;
  position: relative;
  overflow: hidden;
  flex: 1 1 auto;
}

.lm-ScrollBar-thumb {
  box-sizing: border-box;
  position: absolute;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-SplitPanel-child {
  z-index: 0;
}

.lm-SplitPanel-handle {
  z-index: 1;
}

.lm-SplitPanel-handle.lm-mod-hidden {
  display: none !important;
}

.lm-SplitPanel-handle:after {
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  content: '';
}

.lm-SplitPanel[data-orientation='horizontal'] > .lm-SplitPanel-handle {
  cursor: ew-resize;
}

.lm-SplitPanel[data-orientation='vertical'] > .lm-SplitPanel-handle {
  cursor: ns-resize;
}

.lm-SplitPanel[data-orientation='horizontal'] > .lm-SplitPanel-handle:after {
  left: 50%;
  min-width: 8px;
  transform: translateX(-50%);
}

.lm-SplitPanel[data-orientation='vertical'] > .lm-SplitPanel-handle:after {
  top: 50%;
  min-height: 8px;
  transform: translateY(-50%);
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-TabBar {
  display: flex;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.lm-TabBar[data-orientation='horizontal'] {
  flex-direction: row;
  align-items: flex-end;
}

.lm-TabBar[data-orientation='vertical'] {
  flex-direction: column;
  align-items: flex-end;
}

.lm-TabBar-content {
  margin: 0;
  padding: 0;
  display: flex;
  flex: 1 1 auto;
  list-style-type: none;
}

.lm-TabBar[data-orientation='horizontal'] > .lm-TabBar-content {
  flex-direction: row;
}

.lm-TabBar[data-orientation='vertical'] > .lm-TabBar-content {
  flex-direction: column;
}

.lm-TabBar-tab {
  display: flex;
  flex-direction: row;
  box-sizing: border-box;
  overflow: hidden;
  touch-action: none; /* Disable native Drag/Drop */
}

.lm-TabBar-tabIcon,
.lm-TabBar-tabCloseIcon {
  flex: 0 0 auto;
}

.lm-TabBar-tabLabel {
  flex: 1 1 auto;
  overflow: hidden;
  white-space: nowrap;
}

.lm-TabBar-tabInput {
  user-select: all;
  width: 100%;
  box-sizing: border-box;
}

.lm-TabBar-tab.lm-mod-hidden {
  display: none !important;
}

.lm-TabBar-addButton.lm-mod-hidden {
  display: none !important;
}

.lm-TabBar.lm-mod-dragging .lm-TabBar-tab {
  position: relative;
}

.lm-TabBar.lm-mod-dragging[data-orientation='horizontal'] .lm-TabBar-tab {
  left: 0;
  transition: left 150ms ease;
}

.lm-TabBar.lm-mod-dragging[data-orientation='vertical'] .lm-TabBar-tab {
  top: 0;
  transition: top 150ms ease;
}

.lm-TabBar.lm-mod-dragging .lm-TabBar-tab.lm-mod-dragging {
  transition: none;
}

.lm-TabBar-tabLabel .lm-TabBar-tabInput {
  user-select: all;
  width: 100%;
  box-sizing: border-box;
  background: inherit;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-TabPanel-tabBar {
  z-index: 1;
}

.lm-TabPanel-stackedPanel {
  z-index: 0;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Collapse {
  display: flex;
  flex-direction: column;
  align-items: stretch;
}

.jp-Collapse-header {
  padding: 1px 12px;
  background-color: var(--jp-layout-color1);
  border-bottom: solid var(--jp-border-width) var(--jp-border-color2);
  color: var(--jp-ui-font-color1);
  cursor: pointer;
  display: flex;
  align-items: center;
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  text-transform: uppercase;
  user-select: none;
}

.jp-Collapser-icon {
  height: 16px;
}

.jp-Collapse-header-collapsed .jp-Collapser-icon {
  transform: rotate(-90deg);
  margin: auto 0;
}

.jp-Collapser-title {
  line-height: 25px;
}

.jp-Collapse-contents {
  padding: 0 12px;
  background-color: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  overflow: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/* This file was auto-generated by ensureUiComponents() in @jupyterlab/buildutils */

/**
 * (DEPRECATED) Support for consuming icons as CSS background images
 */

/* Icons urls */

:root {
  --jp-icon-add-above: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzEzN18xOTQ5MikiPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGQ9Ik00Ljc1IDQuOTMwNjZINi42MjVWNi44MDU2NkM2LjYyNSA3LjAxMTkxIDYuNzkzNzUgNy4xODA2NiA3IDcuMTgwNjZDNy4yMDYyNSA3LjE4MDY2IDcuMzc1IDcuMDExOTEgNy4zNzUgNi44MDU2NlY0LjkzMDY2SDkuMjVDOS40NTYyNSA0LjkzMDY2IDkuNjI1IDQuNzYxOTEgOS42MjUgNC41NTU2NkM5LjYyNSA0LjM0OTQxIDkuNDU2MjUgNC4xODA2NiA5LjI1IDQuMTgwNjZINy4zNzVWMi4zMDU2NkM3LjM3NSAyLjA5OTQxIDcuMjA2MjUgMS45MzA2NiA3IDEuOTMwNjZDNi43OTM3NSAxLjkzMDY2IDYuNjI1IDIuMDk5NDEgNi42MjUgMi4zMDU2NlY0LjE4MDY2SDQuNzVDNC41NDM3NSA0LjE4MDY2IDQuMzc1IDQuMzQ5NDEgNC4zNzUgNC41NTU2NkM0LjM3NSA0Ljc2MTkxIDQuNTQzNzUgNC45MzA2NiA0Ljc1IDQuOTMwNjZaIiBmaWxsPSIjNjE2MTYxIiBzdHJva2U9IiM2MTYxNjEiIHN0cm9rZS13aWR0aD0iMC43Ii8+CjwvZz4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTExLjUgOS41VjExLjVMMi41IDExLjVWOS41TDExLjUgOS41Wk0xMiA4QzEyLjU1MjMgOCAxMyA4LjQ0NzcyIDEzIDlWMTJDMTMgMTIuNTUyMyAxMi41NTIzIDEzIDEyIDEzTDIgMTNDMS40NDc3MiAxMyAxIDEyLjU1MjMgMSAxMlY5QzEgOC40NDc3MiAxLjQ0NzcxIDggMiA4TDEyIDhaIiBmaWxsPSIjNjE2MTYxIi8+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzEzN18xOTQ5MiI+CjxyZWN0IGNsYXNzPSJqcC1pY29uMyIgd2lkdGg9IjYiIGhlaWdodD0iNiIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0ibWF0cml4KC0xIDAgMCAxIDEwIDEuNTU1NjYpIi8+CjwvY2xpcFBhdGg+CjwvZGVmcz4KPC9zdmc+Cg==);
  --jp-icon-add-below: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPGcgY2xpcC1wYXRoPSJ1cmwoI2NsaXAwXzEzN18xOTQ5OCkiPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGQ9Ik05LjI1IDEwLjA2OTNMNy4zNzUgMTAuMDY5M0w3LjM3NSA4LjE5NDM0QzcuMzc1IDcuOTg4MDkgNy4yMDYyNSA3LjgxOTM0IDcgNy44MTkzNEM2Ljc5Mzc1IDcuODE5MzQgNi42MjUgNy45ODgwOSA2LjYyNSA4LjE5NDM0TDYuNjI1IDEwLjA2OTNMNC43NSAxMC4wNjkzQzQuNTQzNzUgMTAuMDY5MyA0LjM3NSAxMC4yMzgxIDQuMzc1IDEwLjQ0NDNDNC4zNzUgMTAuNjUwNiA0LjU0Mzc1IDEwLjgxOTMgNC43NSAxMC44MTkzTDYuNjI1IDEwLjgxOTNMNi42MjUgMTIuNjk0M0M2LjYyNSAxMi45MDA2IDYuNzkzNzUgMTMuMDY5MyA3IDEzLjA2OTNDNy4yMDYyNSAxMy4wNjkzIDcuMzc1IDEyLjkwMDYgNy4zNzUgMTIuNjk0M0w3LjM3NSAxMC44MTkzTDkuMjUgMTAuODE5M0M5LjQ1NjI1IDEwLjgxOTMgOS42MjUgMTAuNjUwNiA5LjYyNSAxMC40NDQzQzkuNjI1IDEwLjIzODEgOS40NTYyNSAxMC4wNjkzIDkuMjUgMTAuMDY5M1oiIGZpbGw9IiM2MTYxNjEiIHN0cm9rZT0iIzYxNjE2MSIgc3Ryb2tlLXdpZHRoPSIwLjciLz4KPC9nPgo8cGF0aCBjbGFzcz0ianAtaWNvbjMiIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMi41IDUuNUwyLjUgMy41TDExLjUgMy41TDExLjUgNS41TDIuNSA1LjVaTTIgN0MxLjQ0NzcyIDcgMSA2LjU1MjI4IDEgNkwxIDNDMSAyLjQ0NzcyIDEuNDQ3NzIgMiAyIDJMMTIgMkMxMi41NTIzIDIgMTMgMi40NDc3MiAxMyAzTDEzIDZDMTMgNi41NTIyOSAxMi41NTIzIDcgMTIgN0wyIDdaIiBmaWxsPSIjNjE2MTYxIi8+CjxkZWZzPgo8Y2xpcFBhdGggaWQ9ImNsaXAwXzEzN18xOTQ5OCI+CjxyZWN0IGNsYXNzPSJqcC1pY29uMyIgd2lkdGg9IjYiIGhlaWdodD0iNiIgZmlsbD0id2hpdGUiIHRyYW5zZm9ybT0ibWF0cml4KDEgMS43NDg0NmUtMDcgMS43NDg0NmUtMDcgLTEgNCAxMy40NDQzKSIvPgo8L2NsaXBQYXRoPgo8L2RlZnM+Cjwvc3ZnPgo=);
  --jp-icon-add: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE5IDEzaC02djZoLTJ2LTZINXYtMmg2VjVoMnY2aDZ2MnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-bell: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE2IDE2IiB2ZXJzaW9uPSIxLjEiPgogICA8cGF0aCBjbGFzcz0ianAtaWNvbjIganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMzMzMzMzIgogICAgICBkPSJtOCAwLjI5Yy0xLjQgMC0yLjcgMC43My0zLjYgMS44LTEuMiAxLjUtMS40IDMuNC0xLjUgNS4yLTAuMTggMi4yLTAuNDQgNC0yLjMgNS4zbDAuMjggMS4zaDVjMC4wMjYgMC42NiAwLjMyIDEuMSAwLjcxIDEuNSAwLjg0IDAuNjEgMiAwLjYxIDIuOCAwIDAuNTItMC40IDAuNi0xIDAuNzEtMS41aDVsMC4yOC0xLjNjLTEuOS0wLjk3LTIuMi0zLjMtMi4zLTUuMy0wLjEzLTEuOC0wLjI2LTMuNy0xLjUtNS4yLTAuODUtMS0yLjItMS44LTMuNi0xLjh6bTAgMS40YzAuODggMCAxLjkgMC41NSAyLjUgMS4zIDAuODggMS4xIDEuMSAyLjcgMS4yIDQuNCAwLjEzIDEuNyAwLjIzIDMuNiAxLjMgNS4yaC0xMGMxLjEtMS42IDEuMi0zLjQgMS4zLTUuMiAwLjEzLTEuNyAwLjMtMy4zIDEuMi00LjQgMC41OS0wLjcyIDEuNi0xLjMgMi41LTEuM3ptLTAuNzQgMTJoMS41Yy0wLjAwMTUgMC4yOCAwLjAxNSAwLjc5LTAuNzQgMC43OS0wLjczIDAuMDAxNi0wLjcyLTAuNTMtMC43NC0wLjc5eiIgLz4KPC9zdmc+Cg==);
  --jp-icon-bug-dot: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiPgogICAgICAgIDxwYXRoIGZpbGwtcnVsZT0iZXZlbm9kZCIgY2xpcC1ydWxlPSJldmVub2RkIiBkPSJNMTcuMTkgOEgyMFYxMEgxNy45MUMxNy45NiAxMC4zMyAxOCAxMC42NiAxOCAxMVYxMkgyMFYxNEgxOC41SDE4VjE0LjAyNzVDMTUuNzUgMTQuMjc2MiAxNCAxNi4xODM3IDE0IDE4LjVDMTQgMTkuMjA4IDE0LjE2MzUgMTkuODc3OSAxNC40NTQ5IDIwLjQ3MzlDMTMuNzA2MyAyMC44MTE3IDEyLjg3NTcgMjEgMTIgMjFDOS43OCAyMSA3Ljg1IDE5Ljc5IDYuODEgMThINFYxNkg2LjA5QzYuMDQgMTUuNjcgNiAxNS4zNCA2IDE1VjE0SDRWMTJINlYxMUM2IDEwLjY2IDYuMDQgMTAuMzMgNi4wOSAxMEg0VjhINi44MUM3LjI2IDcuMjIgNy44OCA2LjU1IDguNjIgNi4wNEw3IDQuNDFMOC40MSAzTDEwLjU5IDUuMTdDMTEuMDQgNS4wNiAxMS41MSA1IDEyIDVDMTIuNDkgNSAxMi45NiA1LjA2IDEzLjQyIDUuMTdMMTUuNTkgM0wxNyA0LjQxTDE1LjM3IDYuMDRDMTYuMTIgNi41NSAxNi43NCA3LjIyIDE3LjE5IDhaTTEwIDE2SDE0VjE0SDEwVjE2Wk0xMCAxMkgxNFYxMEgxMFYxMloiIGZpbGw9IiM2MTYxNjEiLz4KICAgICAgICA8cGF0aCBkPSJNMjIgMTguNUMyMiAyMC40MzMgMjAuNDMzIDIyIDE4LjUgMjJDMTYuNTY3IDIyIDE1IDIwLjQzMyAxNSAxOC41QzE1IDE2LjU2NyAxNi41NjcgMTUgMTguNSAxNUMyMC40MzMgMTUgMjIgMTYuNTY3IDIyIDE4LjVaIiBmaWxsPSIjNjE2MTYxIi8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-bug: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0yMCA4aC0yLjgxYy0uNDUtLjc4LTEuMDctMS40NS0xLjgyLTEuOTZMMTcgNC40MSAxNS41OSAzbC0yLjE3IDIuMTdDMTIuOTYgNS4wNiAxMi40OSA1IDEyIDVjLS40OSAwLS45Ni4wNi0xLjQxLjE3TDguNDEgMyA3IDQuNDFsMS42MiAxLjYzQzcuODggNi41NSA3LjI2IDcuMjIgNi44MSA4SDR2MmgyLjA5Yy0uMDUuMzMtLjA5LjY2LS4wOSAxdjFINHYyaDJ2MWMwIC4zNC4wNC42Ny4wOSAxSDR2MmgyLjgxYzEuMDQgMS43OSAyLjk3IDMgNS4xOSAzczQuMTUtMS4yMSA1LjE5LTNIMjB2LTJoLTIuMDljLjA1LS4zMy4wOS0uNjYuMDktMXYtMWgydi0yaC0ydi0xYzAtLjM0LS4wNC0uNjctLjA5LTFIMjBWOHptLTYgOGgtNHYtMmg0djJ6bTAtNGgtNHYtMmg0djJ6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-build: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE0LjkgMTcuNDVDMTYuMjUgMTcuNDUgMTcuMzUgMTYuMzUgMTcuMzUgMTVDMTcuMzUgMTMuNjUgMTYuMjUgMTIuNTUgMTQuOSAxMi41NUMxMy41NCAxMi41NSAxMi40NSAxMy42NSAxMi40NSAxNUMxMi40NSAxNi4zNSAxMy41NCAxNy40NSAxNC45IDE3LjQ1Wk0yMC4xIDE1LjY4TDIxLjU4IDE2Ljg0QzIxLjcxIDE2Ljk1IDIxLjc1IDE3LjEzIDIxLjY2IDE3LjI5TDIwLjI2IDE5LjcxQzIwLjE3IDE5Ljg2IDIwIDE5LjkyIDE5LjgzIDE5Ljg2TDE4LjA5IDE5LjE2QzE3LjczIDE5LjQ0IDE3LjMzIDE5LjY3IDE2LjkxIDE5Ljg1TDE2LjY0IDIxLjdDMTYuNjIgMjEuODcgMTYuNDcgMjIgMTYuMyAyMkgxMy41QzEzLjMyIDIyIDEzLjE4IDIxLjg3IDEzLjE1IDIxLjdMMTIuODkgMTkuODVDMTIuNDYgMTkuNjcgMTIuMDcgMTkuNDQgMTEuNzEgMTkuMTZMOS45NjAwMiAxOS44NkM5LjgxMDAyIDE5LjkyIDkuNjIwMDIgMTkuODYgOS41NDAwMiAxOS43MUw4LjE0MDAyIDE3LjI5QzguMDUwMDIgMTcuMTMgOC4wOTAwMiAxNi45NSA4LjIyMDAyIDE2Ljg0TDkuNzAwMDIgMTUuNjhMOS42NTAwMSAxNUw5LjcwMDAyIDE0LjMxTDguMjIwMDIgMTMuMTZDOC4wOTAwMiAxMy4wNSA4LjA1MDAyIDEyLjg2IDguMTQwMDIgMTIuNzFMOS41NDAwMiAxMC4yOUM5LjYyMDAyIDEwLjEzIDkuODEwMDIgMTAuMDcgOS45NjAwMiAxMC4xM0wxMS43MSAxMC44NEMxMi4wNyAxMC41NiAxMi40NiAxMC4zMiAxMi44OSAxMC4xNUwxMy4xNSA4LjI4OTk4QzEzLjE4IDguMTI5OTggMTMuMzIgNy45OTk5OCAxMy41IDcuOTk5OThIMTYuM0MxNi40NyA3Ljk5OTk4IDE2LjYyIDguMTI5OTggMTYuNjQgOC4yODk5OEwxNi45MSAxMC4xNUMxNy4zMyAxMC4zMiAxNy43MyAxMC41NiAxOC4wOSAxMC44NEwxOS44MyAxMC4xM0MyMCAxMC4wNyAyMC4xNyAxMC4xMyAyMC4yNiAxMC4yOUwyMS42NiAxMi43MUMyMS43NSAxMi44NiAyMS43MSAxMy4wNSAyMS41OCAxMy4xNkwyMC4xIDE0LjMxTDIwLjE1IDE1TDIwLjEgMTUuNjhaIi8+CiAgICA8cGF0aCBkPSJNNy4zMjk2NiA3LjQ0NDU0QzguMDgzMSA3LjAwOTU0IDguMzM5MzIgNi4wNTMzMiA3LjkwNDMyIDUuMjk5ODhDNy40NjkzMiA0LjU0NjQzIDYuNTA4MSA0LjI4MTU2IDUuNzU0NjYgNC43MTY1NkM1LjM5MTc2IDQuOTI2MDggNS4xMjY5NSA1LjI3MTE4IDUuMDE4NDkgNS42NzU5NEM0LjkxMDA0IDYuMDgwNzEgNC45NjY4MiA2LjUxMTk4IDUuMTc2MzQgNi44NzQ4OEM1LjYxMTM0IDcuNjI4MzIgNi41NzYyMiA3Ljg3OTU0IDcuMzI5NjYgNy40NDQ1NFpNOS42NTcxOCA0Ljc5NTkzTDEwLjg2NzIgNC45NTE3OUMxMC45NjI4IDQuOTc3NDEgMTEuMDQwMiA1LjA3MTMzIDExLjAzODIgNS4xODc5M0wxMS4wMzg4IDYuOTg4OTNDMTEuMDQ1NSA3LjEwMDU0IDEwLjk2MTYgNy4xOTUxOCAxMC44NTUgNy4yMTA1NEw5LjY2MDAxIDcuMzgwODNMOS4yMzkxNSA4LjEzMTg4TDkuNjY5NjEgOS4yNTc0NUM5LjcwNzI5IDkuMzYyNzEgOS42NjkzNCA5LjQ3Njk5IDkuNTc0MDggOS41MzE5OUw4LjAxNTIzIDEwLjQzMkM3LjkxMTMxIDEwLjQ5MiA3Ljc5MzM3IDEwLjQ2NzcgNy43MjEwNSAxMC4zODI0TDYuOTg3NDggOS40MzE4OEw2LjEwOTMxIDkuNDMwODNMNS4zNDcwNCAxMC4zOTA1QzUuMjg5MDkgMTAuNDcwMiA1LjE3MzgzIDEwLjQ5MDUgNS4wNzE4NyAxMC40MzM5TDMuNTEyNDUgOS41MzI5M0MzLjQxMDQ5IDkuNDc2MzMgMy4zNzY0NyA5LjM1NzQxIDMuNDEwNzUgOS4yNTY3OUwzLjg2MzQ3IDguMTQwOTNMMy42MTc0OSA3Ljc3NDg4TDMuNDIzNDcgNy4zNzg4M0wyLjIzMDc1IDcuMjEyOTdDMi4xMjY0NyA3LjE5MjM1IDIuMDQwNDkgNy4xMDM0MiAyLjA0MjQ1IDYuOTg2ODJMMi4wNDE4NyA1LjE4NTgyQzIuMDQzODMgNS4wNjkyMiAyLjExOTA5IDQuOTc5NTggMi4yMTcwNCA0Ljk2OTIyTDMuNDIwNjUgNC43OTM5M0wzLjg2NzQ5IDQuMDI3ODhMMy40MTEwNSAyLjkxNzMxQzMuMzczMzcgMi44MTIwNCAzLjQxMTMxIDIuNjk3NzYgMy41MTUyMyAyLjYzNzc2TDUuMDc0MDggMS43Mzc3NkM1LjE2OTM0IDEuNjgyNzYgNS4yODcyOSAxLjcwNzA0IDUuMzU5NjEgMS43OTIzMUw2LjExOTE1IDIuNzI3ODhMNi45ODAwMSAyLjczODkzTDcuNzI0OTYgMS43ODkyMkM3Ljc5MTU2IDEuNzA0NTggNy45MTU0OCAxLjY3OTIyIDguMDA4NzkgMS43NDA4Mkw5LjU2ODIxIDIuNjQxODJDOS42NzAxNyAyLjY5ODQyIDkuNzEyODUgMi44MTIzNCA5LjY4NzIzIDIuOTA3OTdMOS4yMTcxOCA0LjAzMzgzTDkuNDYzMTYgNC4zOTk4OEw5LjY1NzE4IDQuNzk1OTNaIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down-empty-thin: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwb2x5Z29uIGNsYXNzPSJzdDEiIHBvaW50cz0iOS45LDEzLjYgMy42LDcuNCA0LjQsNi42IDkuOSwxMi4yIDE1LjQsNi43IDE2LjEsNy40ICIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down-empty: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik01LjIsNS45TDksOS43bDMuOC0zLjhsMS4yLDEuMmwtNC45LDVsLTQuOS01TDUuMiw1Ljl6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-caret-down: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik01LjIsNy41TDksMTEuMmwzLjgtMy44SDUuMnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-caret-left: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwYXRoIGQ9Ik0xMC44LDEyLjhMNy4xLDlsMy44LTMuOGwwLDcuNkgxMC44eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-caret-right: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiIHNoYXBlLXJlbmRlcmluZz0iZ2VvbWV0cmljUHJlY2lzaW9uIj4KICAgIDxwYXRoIGQ9Ik03LjIsNS4yTDEwLjksOWwtMy44LDMuOFY1LjJINy4yeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-caret-up-empty-thin: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwb2x5Z29uIGNsYXNzPSJzdDEiIHBvaW50cz0iMTUuNCwxMy4zIDkuOSw3LjcgNC40LDEzLjIgMy42LDEyLjUgOS45LDYuMyAxNi4xLDEyLjYgIi8+Cgk8L2c+Cjwvc3ZnPgo=);
  --jp-icon-caret-up: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSIgc2hhcGUtcmVuZGVyaW5nPSJnZW9tZXRyaWNQcmVjaXNpb24iPgoJCTxwYXRoIGQ9Ik01LjIsMTAuNUw5LDYuOGwzLjgsMy44SDUuMnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-case-sensitive: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0MTQxNDEiPgogICAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiAgPC9nPgogIDxnIGNsYXNzPSJqcC1pY29uLWFjY2VudDIiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTcuNiw4aDAuOWwzLjUsOGgtMS4xTDEwLDE0SDZsLTAuOSwySDRMNy42LDh6IE04LDkuMUw2LjQsMTNoMy4yTDgsOS4xeiIvPgogICAgPHBhdGggZD0iTTE2LjYsOS44Yy0wLjIsMC4xLTAuNCwwLjEtMC43LDAuMWMtMC4yLDAtMC40LTAuMS0wLjYtMC4yYy0wLjEtMC4xLTAuMi0wLjQtMC4yLTAuNyBjLTAuMywwLjMtMC42LDAuNS0wLjksMC43Yy0wLjMsMC4xLTAuNywwLjItMS4xLDAuMmMtMC4zLDAtMC41LDAtMC43LTAuMWMtMC4yLTAuMS0wLjQtMC4yLTAuNi0wLjNjLTAuMi0wLjEtMC4zLTAuMy0wLjQtMC41IGMtMC4xLTAuMi0wLjEtMC40LTAuMS0wLjdjMC0wLjMsMC4xLTAuNiwwLjItMC44YzAuMS0wLjIsMC4zLTAuNCwwLjQtMC41QzEyLDcsMTIuMiw2LjksMTIuNSw2LjhjMC4yLTAuMSwwLjUtMC4xLDAuNy0wLjIgYzAuMy0wLjEsMC41LTAuMSwwLjctMC4xYzAuMiwwLDAuNC0wLjEsMC42LTAuMWMwLjIsMCwwLjMtMC4xLDAuNC0wLjJjMC4xLTAuMSwwLjItMC4yLDAuMi0wLjRjMC0xLTEuMS0xLTEuMy0xIGMtMC40LDAtMS40LDAtMS40LDEuMmgtMC45YzAtMC40LDAuMS0wLjcsMC4yLTFjMC4xLTAuMiwwLjMtMC40LDAuNS0wLjZjMC4yLTAuMiwwLjUtMC4zLDAuOC0wLjNDMTMuMyw0LDEzLjYsNCwxMy45LDQgYzAuMywwLDAuNSwwLDAuOCwwLjFjMC4zLDAsMC41LDAuMSwwLjcsMC4yYzAuMiwwLjEsMC40LDAuMywwLjUsMC41QzE2LDUsMTYsNS4yLDE2LDUuNnYyLjljMCwwLjIsMCwwLjQsMCwwLjUgYzAsMC4xLDAuMSwwLjIsMC4zLDAuMmMwLjEsMCwwLjIsMCwwLjMsMFY5Ljh6IE0xNS4yLDYuOWMtMS4yLDAuNi0zLjEsMC4yLTMuMSwxLjRjMCwxLjQsMy4xLDEsMy4xLTAuNVY2Ljl6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-check: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik05IDE2LjE3TDQuODMgMTJsLTEuNDIgMS40MUw5IDE5IDIxIDdsLTEuNDEtMS40MXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-circle-empty: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyIDJDNi40NyAyIDIgNi40NyAyIDEyczQuNDcgMTAgMTAgMTAgMTAtNC40NyAxMC0xMFMxNy41MyAyIDEyIDJ6bTAgMThjLTQuNDEgMC04LTMuNTktOC04czMuNTktOCA4LTggOCAzLjU5IDggOC0zLjU5IDgtOCA4eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-circle: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPGNpcmNsZSBjeD0iOSIgY3k9IjkiIHI9IjgiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-clear: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8bWFzayBpZD0iZG9udXRIb2xlIj4KICAgIDxyZWN0IHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgZmlsbD0id2hpdGUiIC8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSI4IiBmaWxsPSJibGFjayIvPgogIDwvbWFzaz4KCiAgPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxyZWN0IGhlaWdodD0iMTgiIHdpZHRoPSIyIiB4PSIxMSIgeT0iMyIgdHJhbnNmb3JtPSJyb3RhdGUoMzE1LCAxMiwgMTIpIi8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIxMCIgbWFzaz0idXJsKCNkb251dEhvbGUpIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-close: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbi1ub25lIGpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIGpwLWljb24zLWhvdmVyIiBmaWxsPSJub25lIj4KICAgIDxjaXJjbGUgY3g9IjEyIiBjeT0iMTIiIHI9IjExIi8+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIGpwLWljb24tYWNjZW50Mi1ob3ZlciIgZmlsbD0iIzYxNjE2MSI+CiAgICA8cGF0aCBkPSJNMTkgNi40MUwxNy41OSA1IDEyIDEwLjU5IDYuNDEgNSA1IDYuNDEgMTAuNTkgMTIgNSAxNy41OSA2LjQxIDE5IDEyIDEzLjQxIDE3LjU5IDE5IDE5IDE3LjU5IDEzLjQxIDEyeiIvPgogIDwvZz4KCiAgPGcgY2xhc3M9ImpwLWljb24tbm9uZSBqcC1pY29uLWJ1c3kiIGZpbGw9Im5vbmUiPgogICAgPGNpcmNsZSBjeD0iMTIiIGN5PSIxMiIgcj0iNyIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-code-check: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBzaGFwZS1yZW5kZXJpbmc9Imdlb21ldHJpY1ByZWNpc2lvbiI+CiAgICA8cGF0aCBkPSJNNi41OSwzLjQxTDIsOEw2LjU5LDEyLjZMOCwxMS4xOEw0LjgyLDhMOCw0LjgyTDYuNTksMy40MU0xMi40MSwzLjQxTDExLDQuODJMMTQuMTgsOEwxMSwxMS4xOEwxMi40MSwxMi42TDE3LDhMMTIuNDEsMy40MU0yMS41OSwxMS41OUwxMy41LDE5LjY4TDkuODMsMTZMOC40MiwxNy40MUwxMy41LDIyLjVMMjMsMTNMMjEuNTksMTEuNTlaIiAvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-code: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHZpZXdCb3g9IjAgMCAyOCAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTExLjQgMTguNkw2LjggMTRMMTEuNCA5LjRMMTAgOEw0IDE0TDEwIDIwTDExLjQgMTguNlpNMTYuNiAxOC42TDIxLjIgMTRMMTYuNiA5LjRMMTggOEwyNCAxNEwxOCAyMEwxNi42IDE4LjZWMTguNloiLz4KCTwvZz4KPC9zdmc+Cg==);
  --jp-icon-collapse-all: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTggMmMxIDAgMTEgMCAxMiAwczIgMSAyIDJjMCAxIDAgMTEgMCAxMnMwIDItMiAyQzIwIDE0IDIwIDQgMjAgNFMxMCA0IDYgNGMwLTIgMS0yIDItMnoiIC8+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTE4IDhjMC0xLTEtMi0yLTJTNSA2IDQgNnMtMiAxLTIgMmMwIDEgMCAxMSAwIDEyczEgMiAyIDJjMSAwIDExIDAgMTIgMHMyLTEgMi0yYzAtMSAwLTExIDAtMTJ6bS0yIDB2MTJINFY4eiIgLz4KICAgICAgICA8cGF0aCBkPSJNNiAxM3YyaDh2LTJ6IiAvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-console: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwMCAyMDAiPgogIDxnIGNsYXNzPSJqcC1jb25zb2xlLWljb24tYmFja2dyb3VuZC1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiMwMjg4RDEiPgogICAgPHBhdGggZD0iTTIwIDE5LjhoMTYwdjE1OS45SDIweiIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtY29uc29sZS1pY29uLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIiBmaWxsPSIjZmZmIj4KICAgIDxwYXRoIGQ9Ik0xMDUgMTI3LjNoNDB2MTIuOGgtNDB6TTUxLjEgNzdMNzQgOTkuOWwtMjMuMyAyMy4zIDEwLjUgMTAuNSAyMy4zLTIzLjNMOTUgOTkuOSA4NC41IDg5LjQgNjEuNiA2Ni41eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-copy: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTExLjksMUgzLjJDMi40LDEsMS43LDEuNywxLjcsMi41djEwLjJoMS41VjIuNWg4LjdWMXogTTE0LjEsMy45aC04Yy0wLjgsMC0xLjUsMC43LTEuNSwxLjV2MTAuMmMwLDAuOCwwLjcsMS41LDEuNSwxLjVoOCBjMC44LDAsMS41LTAuNywxLjUtMS41VjUuNEMxNS41LDQuNiwxNC45LDMuOSwxNC4xLDMuOXogTTE0LjEsMTUuNWgtOFY1LjRoOFYxNS41eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-copyright: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGVuYWJsZS1iYWNrZ3JvdW5kPSJuZXcgMCAwIDI0IDI0IiBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCI+CiAgPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0xMS44OCw5LjE0YzEuMjgsMC4wNiwxLjYxLDEuMTUsMS42MywxLjY2aDEuNzljLTAuMDgtMS45OC0xLjQ5LTMuMTktMy40NS0zLjE5QzkuNjQsNy42MSw4LDksOCwxMi4xNCBjMCwxLjk0LDAuOTMsNC4yNCwzLjg0LDQuMjRjMi4yMiwwLDMuNDEtMS42NSwzLjQ0LTIuOTVoLTEuNzljLTAuMDMsMC41OS0wLjQ1LDEuMzgtMS42MywxLjQ0QzEwLjU1LDE0LjgzLDEwLDEzLjgxLDEwLDEyLjE0IEMxMCw5LjI1LDExLjI4LDkuMTYsMTEuODgsOS4xNHogTTEyLDJDNi40OCwyLDIsNi40OCwyLDEyczQuNDgsMTAsMTAsMTBzMTAtNC40OCwxMC0xMFMxNy41MiwyLDEyLDJ6IE0xMiwyMGMtNC40MSwwLTgtMy41OS04LTggczMuNTktOCw4LThzOCwzLjU5LDgsOFMxNi40MSwyMCwxMiwyMHoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-cut: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTkuNjQgNy42NGMuMjMtLjUuMzYtMS4wNS4zNi0xLjY0IDAtMi4yMS0xLjc5LTQtNC00UzIgMy43OSAyIDZzMS43OSA0IDQgNGMuNTkgMCAxLjE0LS4xMyAxLjY0LS4zNkwxMCAxMmwtMi4zNiAyLjM2QzcuMTQgMTQuMTMgNi41OSAxNCA2IDE0Yy0yLjIxIDAtNCAxLjc5LTQgNHMxLjc5IDQgNCA0IDQtMS43OSA0LTRjMC0uNTktLjEzLTEuMTQtLjM2LTEuNjRMMTIgMTRsNyA3aDN2LTFMOS42NCA3LjY0ek02IDhjLTEuMSAwLTItLjg5LTItMnMuOS0yIDItMiAyIC44OSAyIDItLjkgMi0yIDJ6bTAgMTJjLTEuMSAwLTItLjg5LTItMnMuOS0yIDItMiAyIC44OSAyIDItLjkgMi0yIDJ6bTYtNy41Yy0uMjggMC0uNS0uMjItLjUtLjVzLjIyLS41LjUtLjUuNS4yMi41LjUtLjIyLjUtLjUuNXpNMTkgM2wtNiA2IDIgMiA3LTdWM3oiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-delete: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2cHgiIGhlaWdodD0iMTZweCI+CiAgICA8cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIiAvPgogICAgPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjI2MjYyIiBkPSJNNiAxOWMwIDEuMS45IDIgMiAyaDhjMS4xIDAgMi0uOSAyLTJWN0g2djEyek0xOSA0aC0zLjVsLTEtMWgtNWwtMSAxSDV2MmgxNFY0eiIgLz4KPC9zdmc+Cg==);
  --jp-icon-download: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE5IDloLTRWM0g5djZINWw3IDcgNy03ek01IDE4djJoMTR2LTJINXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-duplicate: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBmaWxsLXJ1bGU9ImV2ZW5vZGQiIGNsaXAtcnVsZT0iZXZlbm9kZCIgZD0iTTIuNzk5OTggMC44NzVIOC44OTU4MkM5LjIwMDYxIDAuODc1IDkuNDQ5OTggMS4xMzkxNCA5LjQ0OTk4IDEuNDYxOThDOS40NDk5OCAxLjc4NDgyIDkuMjAwNjEgMi4wNDg5NiA4Ljg5NTgyIDIuMDQ4OTZIMy4zNTQxNUMzLjA0OTM2IDIuMDQ4OTYgMi43OTk5OCAyLjMxMzEgMi43OTk5OCAyLjYzNTk0VjkuNjc5NjlDMi43OTk5OCAxMC4wMDI1IDIuNTUwNjEgMTAuMjY2NyAyLjI0NTgyIDEwLjI2NjdDMS45NDEwMyAxMC4yNjY3IDEuNjkxNjUgMTAuMDAyNSAxLjY5MTY1IDkuNjc5NjlWMi4wNDg5NkMxLjY5MTY1IDEuNDAzMjggMi4xOTA0IDAuODc1IDIuNzk5OTggMC44NzVaTTUuMzY2NjUgMTEuOVY0LjU1SDExLjA4MzNWMTEuOUg1LjM2NjY1Wk00LjE0MTY1IDQuMTQxNjdDNC4xNDE2NSAzLjY5MDYzIDQuNTA3MjggMy4zMjUgNC45NTgzMiAzLjMyNUgxMS40OTE3QzExLjk0MjcgMy4zMjUgMTIuMzA4MyAzLjY5MDYzIDEyLjMwODMgNC4xNDE2N1YxMi4zMDgzQzEyLjMwODMgMTIuNzU5NCAxMS45NDI3IDEzLjEyNSAxMS40OTE3IDEzLjEyNUg0Ljk1ODMyQzQuNTA3MjggMTMuMTI1IDQuMTQxNjUgMTIuNzU5NCA0LjE0MTY1IDEyLjMwODNWNC4xNDE2N1oiIGZpbGw9IiM2MTYxNjEiLz4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNOS40MzU3NCA4LjI2NTA3SDguMzY0MzFWOS4zMzY1QzguMzY0MzEgOS40NTQzNSA4LjI2Nzg4IDkuNTUwNzggOC4xNTAwMiA5LjU1MDc4QzguMDMyMTcgOS41NTA3OCA3LjkzNTc0IDkuNDU0MzUgNy45MzU3NCA5LjMzNjVWOC4yNjUwN0g2Ljg2NDMxQzYuNzQ2NDUgOC4yNjUwNyA2LjY1MDAyIDguMTY4NjQgNi42NTAwMiA4LjA1MDc4QzYuNjUwMDIgNy45MzI5MiA2Ljc0NjQ1IDcuODM2NSA2Ljg2NDMxIDcuODM2NUg3LjkzNTc0VjYuNzY1MDdDNy45MzU3NCA2LjY0NzIxIDguMDMyMTcgNi41NTA3OCA4LjE1MDAyIDYuNTUwNzhDOC4yNjc4OCA2LjU1MDc4IDguMzY0MzEgNi42NDcyMSA4LjM2NDMxIDYuNzY1MDdWNy44MzY1SDkuNDM1NzRDOS41NTM2IDcuODM2NSA5LjY1MDAyIDcuOTMyOTIgOS42NTAwMiA4LjA1MDc4QzkuNjUwMDIgOC4xNjg2NCA5LjU1MzYgOC4yNjUwNyA5LjQzNTc0IDguMjY1MDdaIiBmaWxsPSIjNjE2MTYxIiBzdHJva2U9IiM2MTYxNjEiIHN0cm9rZS13aWR0aD0iMC41Ii8+Cjwvc3ZnPgo=);
  --jp-icon-edit: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTMgMTcuMjVWMjFoMy43NUwxNy44MSA5Ljk0bC0zLjc1LTMuNzVMMyAxNy4yNXpNMjAuNzEgNy4wNGMuMzktLjM5LjM5LTEuMDIgMC0xLjQxbC0yLjM0LTIuMzRjLS4zOS0uMzktMS4wMi0uMzktMS40MSAwbC0xLjgzIDEuODMgMy43NSAzLjc1IDEuODMtMS44M3oiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-ellipses: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPGNpcmNsZSBjeD0iNSIgY3k9IjEyIiByPSIyIi8+CiAgICA8Y2lyY2xlIGN4PSIxMiIgY3k9IjEyIiByPSIyIi8+CiAgICA8Y2lyY2xlIGN4PSIxOSIgY3k9IjEyIiByPSIyIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-error: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj48Y2lyY2xlIGN4PSIxMiIgY3k9IjE5IiByPSIyIi8+PHBhdGggZD0iTTEwIDNoNHYxMmgtNHoiLz48L2c+CjxwYXRoIGZpbGw9Im5vbmUiIGQ9Ik0wIDBoMjR2MjRIMHoiLz4KPC9zdmc+Cg==);
  --jp-icon-expand-all: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTggMmMxIDAgMTEgMCAxMiAwczIgMSAyIDJjMCAxIDAgMTEgMCAxMnMwIDItMiAyQzIwIDE0IDIwIDQgMjAgNFMxMCA0IDYgNGMwLTIgMS0yIDItMnoiIC8+CiAgICAgICAgPHBhdGgKICAgICAgICAgICAgZD0iTTE4IDhjMC0xLTEtMi0yLTJTNSA2IDQgNnMtMiAxLTIgMmMwIDEgMCAxMSAwIDEyczEgMiAyIDJjMSAwIDExIDAgMTIgMHMyLTEgMi0yYzAtMSAwLTExIDAtMTJ6bS0yIDB2MTJINFY4eiIgLz4KICAgICAgICA8cGF0aCBkPSJNMTEgMTBIOXYzSDZ2MmgzdjNoMnYtM2gzdi0yaC0zeiIgLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-extension: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIwLjUgMTFIMTlWN2MwLTEuMS0uOS0yLTItMmgtNFYzLjVDMTMgMi4xMiAxMS44OCAxIDEwLjUgMVM4IDIuMTIgOCAzLjVWNUg0Yy0xLjEgMC0xLjk5LjktMS45OSAydjMuOEgzLjVjMS40OSAwIDIuNyAxLjIxIDIuNyAyLjdzLTEuMjEgMi43LTIuNyAyLjdIMlYyMGMwIDEuMS45IDIgMiAyaDMuOHYtMS41YzAtMS40OSAxLjIxLTIuNyAyLjctMi43IDEuNDkgMCAyLjcgMS4yMSAyLjcgMi43VjIySDE3YzEuMSAwIDItLjkgMi0ydi00aDEuNWMxLjM4IDAgMi41LTEuMTIgMi41LTIuNVMyMS44OCAxMSAyMC41IDExeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-fast-forward: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTQgMThsOC41LTZMNCA2djEyem05LTEydjEybDguNS02TDEzIDZ6Ii8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-file-upload: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTkgMTZoNnYtNmg0bC03LTctNyA3aDR6bS00IDJoMTR2Mkg1eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-file: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkuMyA4LjJsLTUuNS01LjVjLS4zLS4zLS43LS41LTEuMi0uNUgzLjljLS44LjEtMS42LjktMS42IDEuOHYxNC4xYzAgLjkuNyAxLjYgMS42IDEuNmgxNC4yYy45IDAgMS42LS43IDEuNi0xLjZWOS40Yy4xLS41LS4xLS45LS40LTEuMnptLTUuOC0zLjNsMy40IDMuNmgtMy40VjQuOXptMy45IDEyLjdINC43Yy0uMSAwLS4yIDAtLjItLjJWNC43YzAtLjIuMS0uMy4yLS4zaDcuMnY0LjRzMCAuOC4zIDEuMWMuMy4zIDEuMS4zIDEuMS4zaDQuM3Y3LjJzLS4xLjItLjIuMnoiLz4KPC9zdmc+Cg==);
  --jp-icon-filter-dot: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTE0LDEyVjE5Ljg4QzE0LjA0LDIwLjE4IDEzLjk0LDIwLjUgMTMuNzEsMjAuNzFDMTMuMzIsMjEuMSAxMi42OSwyMS4xIDEyLjMsMjAuNzFMMTAuMjksMTguN0MxMC4wNiwxOC40NyA5Ljk2LDE4LjE2IDEwLDE3Ljg3VjEySDkuOTdMNC4yMSw0LjYyQzMuODcsNC4xOSAzLjk1LDMuNTYgNC4zOCwzLjIyQzQuNTcsMy4wOCA0Ljc4LDMgNSwzVjNIMTlWM0MxOS4yMiwzIDE5LjQzLDMuMDggMTkuNjIsMy4yMkMyMC4wNSwzLjU2IDIwLjEzLDQuMTkgMTkuNzksNC42MkwxNC4wMywxMkgxNFoiIC8+CiAgPC9nPgogIDxnIGNsYXNzPSJqcC1pY29uLWRvdCIgZmlsbD0iI0ZGRiI+CiAgICA8Y2lyY2xlIGN4PSIxOCIgY3k9IjE3IiByPSIzIj48L2NpcmNsZT4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-filter-list: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEwIDE4aDR2LTJoLTR2MnpNMyA2djJoMThWNkgzem0zIDdoMTJ2LTJINnYyeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-filter: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiNGRkYiPgogICAgPHBhdGggZD0iTTE0LDEyVjE5Ljg4QzE0LjA0LDIwLjE4IDEzLjk0LDIwLjUgMTMuNzEsMjAuNzFDMTMuMzIsMjEuMSAxMi42OSwyMS4xIDEyLjMsMjAuNzFMMTAuMjksMTguN0MxMC4wNiwxOC40NyA5Ljk2LDE4LjE2IDEwLDE3Ljg3VjEySDkuOTdMNC4yMSw0LjYyQzMuODcsNC4xOSAzLjk1LDMuNTYgNC4zOCwzLjIyQzQuNTcsMy4wOCA0Ljc4LDMgNSwzVjNIMTlWM0MxOS4yMiwzIDE5LjQzLDMuMDggMTkuNjIsMy4yMkMyMC4wNSwzLjU2IDIwLjEzLDQuMTkgMTkuNzksNC42MkwxNC4wMywxMkgxNFoiIC8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-folder-favorite: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iIzAwMDAwMCI+CiAgPHBhdGggZD0iTTAgMGgyNHYyNEgwVjB6IiBmaWxsPSJub25lIi8+PHBhdGggY2xhc3M9ImpwLWljb24zIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzYxNjE2MSIgZD0iTTIwIDZoLThsLTItMkg0Yy0xLjEgMC0yIC45LTIgMnYxMmMwIDEuMS45IDIgMiAyaDE2YzEuMSAwIDItLjkgMi0yVjhjMC0xLjEtLjktMi0yLTJ6bS0yLjA2IDExTDE1IDE1LjI4IDEyLjA2IDE3bC43OC0zLjMzLTIuNTktMi4yNCAzLjQxLS4yOUwxNSA4bDEuMzQgMy4xNCAzLjQxLjI5LTIuNTkgMi4yNC43OCAzLjMzeiIvPgo8L3N2Zz4K);
  --jp-icon-folder: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTAgNEg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMThjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY4YzAtMS4xLS45LTItMi0yaC04bC0yLTJ6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-home: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjRweCIgdmlld0JveD0iMCAwIDI0IDI0IiB3aWR0aD0iMjRweCIgZmlsbD0iIzAwMDAwMCI+CiAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPjxwYXRoIGNsYXNzPSJqcC1pY29uMyBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xMCAyMHYtNmg0djZoNXYtOGgzTDEyIDMgMiAxMmgzdjh6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-html5: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUxMiA1MTIiPgogIDxwYXRoIGNsYXNzPSJqcC1pY29uMCBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiMwMDAiIGQ9Ik0xMDguNCAwaDIzdjIyLjhoMjEuMlYwaDIzdjY5aC0yM1Y0NmgtMjF2MjNoLTIzLjJNMjA2IDIzaC0yMC4zVjBoNjMuN3YyM0gyMjl2NDZoLTIzbTUzLjUtNjloMjQuMWwxNC44IDI0LjNMMzEzLjIgMGgyNC4xdjY5aC0yM1YzNC44bC0xNi4xIDI0LjgtMTYuMS0yNC44VjY5aC0yMi42bTg5LjItNjloMjN2NDYuMmgzMi42VjY5aC01NS42Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI2U0NGQyNiIgZD0iTTEwNy42IDQ3MWwtMzMtMzcwLjRoMzYyLjhsLTMzIDM3MC4yTDI1NS43IDUxMiIvPgogIDxwYXRoIGNsYXNzPSJqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiNmMTY1MjkiIGQ9Ik0yNTYgNDgwLjVWMTMxaDE0OC4zTDM3NiA0NDciLz4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1zZWxlY3RhYmxlLWludmVyc2UiIGZpbGw9IiNlYmViZWIiIGQ9Ik0xNDIgMTc2LjNoMTE0djQ1LjRoLTY0LjJsNC4yIDQ2LjVoNjB2NDUuM0gxNTQuNG0yIDIyLjhIMjAybDMuMiAzNi4zIDUwLjggMTMuNnY0Ny40bC05My4yLTI2Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZS1pbnZlcnNlIiBmaWxsPSIjZmZmIiBkPSJNMzY5LjYgMTc2LjNIMjU1Ljh2NDUuNGgxMDkuNm0tNC4xIDQ2LjVIMjU1Ljh2NDUuNGg1NmwtNS4zIDU5LTUwLjcgMTMuNnY0Ny4ybDkzLTI1LjgiLz4KPC9zdmc+Cg==);
  --jp-icon-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1icmFuZDQganAtaWNvbi1zZWxlY3RhYmxlLWludmVyc2UiIGZpbGw9IiNGRkYiIGQ9Ik0yLjIgMi4yaDE3LjV2MTcuNUgyLjJ6Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzNGNTFCNSIgZD0iTTIuMiAyLjJ2MTcuNWgxNy41bC4xLTE3LjVIMi4yem0xMi4xIDIuMmMxLjIgMCAyLjIgMSAyLjIgMi4ycy0xIDIuMi0yLjIgMi4yLTIuMi0xLTIuMi0yLjIgMS0yLjIgMi4yLTIuMnpNNC40IDE3LjZsMy4zLTguOCAzLjMgNi42IDIuMi0zLjIgNC40IDUuNEg0LjR6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-info: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUwLjk3OCA1MC45NzgiPgoJPGcgY2xhc3M9ImpwLWljb24zIiBmaWxsPSIjNjE2MTYxIj4KCQk8cGF0aCBkPSJNNDMuNTIsNy40NThDMzguNzExLDIuNjQ4LDMyLjMwNywwLDI1LjQ4OSwwQzE4LjY3LDAsMTIuMjY2LDIuNjQ4LDcuNDU4LDcuNDU4CgkJCWMtOS45NDMsOS45NDEtOS45NDMsMjYuMTE5LDAsMzYuMDYyYzQuODA5LDQuODA5LDExLjIxMiw3LjQ1NiwxOC4wMzEsNy40NThjMCwwLDAuMDAxLDAsMC4wMDIsMAoJCQljNi44MTYsMCwxMy4yMjEtMi42NDgsMTguMDI5LTcuNDU4YzQuODA5LTQuODA5LDcuNDU3LTExLjIxMiw3LjQ1Ny0xOC4wM0M1MC45NzcsMTguNjcsNDguMzI4LDEyLjI2Niw0My41Miw3LjQ1OHoKCQkJIE00Mi4xMDYsNDIuMTA1Yy00LjQzMiw0LjQzMS0xMC4zMzIsNi44NzItMTYuNjE1LDYuODcyaC0wLjAwMmMtNi4yODUtMC4wMDEtMTIuMTg3LTIuNDQxLTE2LjYxNy02Ljg3MgoJCQljLTkuMTYyLTkuMTYzLTkuMTYyLTI0LjA3MSwwLTMzLjIzM0MxMy4zMDMsNC40NCwxOS4yMDQsMiwyNS40ODksMmM2LjI4NCwwLDEyLjE4NiwyLjQ0LDE2LjYxNyw2Ljg3MgoJCQljNC40MzEsNC40MzEsNi44NzEsMTAuMzMyLDYuODcxLDE2LjYxN0M0OC45NzcsMzEuNzcyLDQ2LjUzNiwzNy42NzUsNDIuMTA2LDQyLjEwNXoiLz4KCQk8cGF0aCBkPSJNMjMuNTc4LDMyLjIxOGMtMC4wMjMtMS43MzQsMC4xNDMtMy4wNTksMC40OTYtMy45NzJjMC4zNTMtMC45MTMsMS4xMS0xLjk5NywyLjI3Mi0zLjI1MwoJCQljMC40NjgtMC41MzYsMC45MjMtMS4wNjIsMS4zNjctMS41NzVjMC42MjYtMC43NTMsMS4xMDQtMS40NzgsMS40MzYtMi4xNzVjMC4zMzEtMC43MDcsMC40OTUtMS41NDEsMC40OTUtMi41CgkJCWMwLTEuMDk2LTAuMjYtMi4wODgtMC43NzktMi45NzljLTAuNTY1LTAuODc5LTEuNTAxLTEuMzM2LTIuODA2LTEuMzY5Yy0xLjgwMiwwLjA1Ny0yLjk4NSwwLjY2Ny0zLjU1LDEuODMyCgkJCWMtMC4zMDEsMC41MzUtMC41MDMsMS4xNDEtMC42MDcsMS44MTRjLTAuMTM5LDAuNzA3LTAuMjA3LDEuNDMyLTAuMjA3LDIuMTc0aC0yLjkzN2MtMC4wOTEtMi4yMDgsMC40MDctNC4xMTQsMS40OTMtNS43MTkKCQkJYzEuMDYyLTEuNjQsMi44NTUtMi40ODEsNS4zNzgtMi41MjdjMi4xNiwwLjAyMywzLjg3NCwwLjYwOCw1LjE0MSwxLjc1OGMxLjI3OCwxLjE2LDEuOTI5LDIuNzY0LDEuOTUsNC44MTEKCQkJYzAsMS4xNDItMC4xMzcsMi4xMTEtMC40MSwyLjkxMWMtMC4zMDksMC44NDUtMC43MzEsMS41OTMtMS4yNjgsMi4yNDNjLTAuNDkyLDAuNjUtMS4wNjgsMS4zMTgtMS43MywyLjAwMgoJCQljLTAuNjUsMC42OTctMS4zMTMsMS40NzktMS45ODcsMi4zNDZjLTAuMjM5LDAuMzc3LTAuNDI5LDAuNzc3LTAuNTY1LDEuMTk5Yy0wLjE2LDAuOTU5LTAuMjE3LDEuOTUxLTAuMTcxLDIuOTc5CgkJCUMyNi41ODksMzIuMjE4LDIzLjU3OCwzMi4yMTgsMjMuNTc4LDMyLjIxOHogTTIzLjU3OCwzOC4yMnYtMy40ODRoMy4wNzZ2My40ODRIMjMuNTc4eiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-inspector: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaW5zcGVjdG9yLWljb24tY29sb3IganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMjAgNEg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMThjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY2YzAtMS4xLS45LTItMi0yem0tNSAxNEg0di00aDExdjR6bTAtNUg0VjloMTF2NHptNSA1aC00VjloNHY5eiIvPgo8L3N2Zz4K);
  --jp-icon-json: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtanNvbi1pY29uLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI0Y5QTgyNSI+CiAgICA8cGF0aCBkPSJNMjAuMiAxMS44Yy0xLjYgMC0xLjcuNS0xLjcgMSAwIC40LjEuOS4xIDEuMy4xLjUuMS45LjEgMS4zIDAgMS43LTEuNCAyLjMtMy41IDIuM2gtLjl2LTEuOWguNWMxLjEgMCAxLjQgMCAxLjQtLjggMC0uMyAwLS42LS4xLTEgMC0uNC0uMS0uOC0uMS0xLjIgMC0xLjMgMC0xLjggMS4zLTItMS4zLS4yLTEuMy0uNy0xLjMtMiAwLS40LjEtLjguMS0xLjIuMS0uNC4xLS43LjEtMSAwLS44LS40LS43LTEuNC0uOGgtLjVWNC4xaC45YzIuMiAwIDMuNS43IDMuNSAyLjMgMCAuNC0uMS45LS4xIDEuMy0uMS41LS4xLjktLjEgMS4zIDAgLjUuMiAxIDEuNyAxdjEuOHpNMS44IDEwLjFjMS42IDAgMS43LS41IDEuNy0xIDAtLjQtLjEtLjktLjEtMS4zLS4xLS41LS4xLS45LS4xLTEuMyAwLTEuNiAxLjQtMi4zIDMuNS0yLjNoLjl2MS45aC0uNWMtMSAwLTEuNCAwLTEuNC44IDAgLjMgMCAuNi4xIDEgMCAuMi4xLjYuMSAxIDAgMS4zIDAgMS44LTEuMyAyQzYgMTEuMiA2IDExLjcgNiAxM2MwIC40LS4xLjgtLjEgMS4yLS4xLjMtLjEuNy0uMSAxIDAgLjguMy44IDEuNC44aC41djEuOWgtLjljLTIuMSAwLTMuNS0uNi0zLjUtMi4zIDAtLjQuMS0uOS4xLTEuMy4xLS41LjEtLjkuMS0xLjMgMC0uNS0uMi0xLTEuNy0xdi0xLjl6Ii8+CiAgICA8Y2lyY2xlIGN4PSIxMSIgY3k9IjEzLjgiIHI9IjIuMSIvPgogICAgPGNpcmNsZSBjeD0iMTEiIGN5PSI4LjIiIHI9IjIuMSIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-julia: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDMyNSAzMDAiPgogIDxnIGNsYXNzPSJqcC1icmFuZDAganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjY2IzYzMzIj4KICAgIDxwYXRoIGQ9Ik0gMTUwLjg5ODQzOCAyMjUgQyAxNTAuODk4NDM4IDI2Ni40MjE4NzUgMTE3LjMyMDMxMiAzMDAgNzUuODk4NDM4IDMwMCBDIDM0LjQ3NjU2MiAzMDAgMC44OTg0MzggMjY2LjQyMTg3NSAwLjg5ODQzOCAyMjUgQyAwLjg5ODQzOCAxODMuNTc4MTI1IDM0LjQ3NjU2MiAxNTAgNzUuODk4NDM4IDE1MCBDIDExNy4zMjAzMTIgMTUwIDE1MC44OTg0MzggMTgzLjU3ODEyNSAxNTAuODk4NDM4IDIyNSIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzM4OTgyNiI+CiAgICA8cGF0aCBkPSJNIDIzNy41IDc1IEMgMjM3LjUgMTE2LjQyMTg3NSAyMDMuOTIxODc1IDE1MCAxNjIuNSAxNTAgQyAxMjEuMDc4MTI1IDE1MCA4Ny41IDExNi40MjE4NzUgODcuNSA3NSBDIDg3LjUgMzMuNTc4MTI1IDEyMS4wNzgxMjUgMCAxNjIuNSAwIEMgMjAzLjkyMTg3NSAwIDIzNy41IDMzLjU3ODEyNSAyMzcuNSA3NSIvPgogIDwvZz4KICA8ZyBjbGFzcz0ianAtYnJhbmQwIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzk1NThiMiI+CiAgICA8cGF0aCBkPSJNIDMyNC4xMDE1NjIgMjI1IEMgMzI0LjEwMTU2MiAyNjYuNDIxODc1IDI5MC41MjM0MzggMzAwIDI0OS4xMDE1NjIgMzAwIEMgMjA3LjY3OTY4OCAzMDAgMTc0LjEwMTU2MiAyNjYuNDIxODc1IDE3NC4xMDE1NjIgMjI1IEMgMTc0LjEwMTU2MiAxODMuNTc4MTI1IDIwNy42Nzk2ODggMTUwIDI0OS4xMDE1NjIgMTUwIEMgMjkwLjUyMzQzOCAxNTAgMzI0LjEwMTU2MiAxODMuNTc4MTI1IDMyNC4xMDE1NjIgMjI1Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-jupyter-favicon: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTUyIiBoZWlnaHQ9IjE2NSIgdmlld0JveD0iMCAwIDE1MiAxNjUiIHZlcnNpb249IjEuMSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgPGcgY2xhc3M9ImpwLWp1cHl0ZXItaWNvbi1jb2xvciIgZmlsbD0iI0YzNzcyNiI+CiAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjA3ODk0NywgMTEwLjU4MjkyNykiIGQ9Ik03NS45NDIyODQyLDI5LjU4MDQ1NjEgQzQzLjMwMjM5NDcsMjkuNTgwNDU2MSAxNC43OTY3ODMyLDE3LjY1MzQ2MzQgMCwwIEM1LjUxMDgzMjExLDE1Ljg0MDY4MjkgMTUuNzgxNTM4OSwyOS41NjY3NzMyIDI5LjM5MDQ5NDcsMzkuMjc4NDE3MSBDNDIuOTk5Nyw0OC45ODk4NTM3IDU5LjI3MzcsNTQuMjA2NzgwNSA3NS45NjA1Nzg5LDU0LjIwNjc4MDUgQzkyLjY0NzQ1NzksNTQuMjA2NzgwNSAxMDguOTIxNDU4LDQ4Ljk4OTg1MzcgMTIyLjUzMDY2MywzOS4yNzg0MTcxIEMxMzYuMTM5NDUzLDI5LjU2Njc3MzIgMTQ2LjQxMDI4NCwxNS44NDA2ODI5IDE1MS45MjExNTgsMCBDMTM3LjA4Nzg2OCwxNy42NTM0NjM0IDEwOC41ODI1ODksMjkuNTgwNDU2MSA3NS45NDIyODQyLDI5LjU4MDQ1NjEgTDc1Ljk0MjI4NDIsMjkuNTgwNDU2MSBaIiAvPgogICAgPHBhdGggdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC4wMzczNjgsIDAuNzA0ODc4KSIgZD0iTTc1Ljk3ODQ1NzksMjQuNjI2NDA3MyBDMTA4LjYxODc2MywyNC42MjY0MDczIDEzNy4xMjQ0NTgsMzYuNTUzNDQxNSAxNTEuOTIxMTU4LDU0LjIwNjc4MDUgQzE0Ni40MTAyODQsMzguMzY2MjIyIDEzNi4xMzk0NTMsMjQuNjQwMTMxNyAxMjIuNTMwNjYzLDE0LjkyODQ4NzggQzEwOC45MjE0NTgsNS4yMTY4NDM5IDkyLjY0NzQ1NzksMCA3NS45NjA1Nzg5LDAgQzU5LjI3MzcsMCA0Mi45OTk3LDUuMjE2ODQzOSAyOS4zOTA0OTQ3LDE0LjkyODQ4NzggQzE1Ljc4MTUzODksMjQuNjQwMTMxNyA1LjUxMDgzMjExLDM4LjM2NjIyMiAwLDU0LjIwNjc4MDUgQzE0LjgzMzA4MTYsMzYuNTg5OTI5MyA0My4zMzg1Njg0LDI0LjYyNjQwNzMgNzUuOTc4NDU3OSwyNC42MjY0MDczIEw3NS45Nzg0NTc5LDI0LjYyNjQwNzMgWiIgLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-jupyter: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzkiIGhlaWdodD0iNTEiIHZpZXdCb3g9IjAgMCAzOSA1MSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgtMTYzOCAtMjI4MSkiPgogICAgIDxnIGNsYXNzPSJqcC1qdXB5dGVyLWljb24tY29sb3IiIGZpbGw9IiNGMzc3MjYiPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM5Ljc0IDIzMTEuOTgpIiBkPSJNIDE4LjI2NDYgNy4xMzQxMUMgMTAuNDE0NSA3LjEzNDExIDMuNTU4NzIgNC4yNTc2IDAgMEMgMS4zMjUzOSAzLjgyMDQgMy43OTU1NiA3LjEzMDgxIDcuMDY4NiA5LjQ3MzAzQyAxMC4zNDE3IDExLjgxNTIgMTQuMjU1NyAxMy4wNzM0IDE4LjI2OSAxMy4wNzM0QyAyMi4yODIzIDEzLjA3MzQgMjYuMTk2MyAxMS44MTUyIDI5LjQ2OTQgOS40NzMwM0MgMzIuNzQyNCA3LjEzMDgxIDM1LjIxMjYgMy44MjA0IDM2LjUzOCAwQyAzMi45NzA1IDQuMjU3NiAyNi4xMTQ4IDcuMTM0MTEgMTguMjY0NiA3LjEzNDExWiIvPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM5LjczIDIyODUuNDgpIiBkPSJNIDE4LjI3MzMgNS45MzkzMUMgMjYuMTIzNSA1LjkzOTMxIDMyLjk3OTMgOC44MTU4MyAzNi41MzggMTMuMDczNEMgMzUuMjEyNiA5LjI1MzAzIDMyLjc0MjQgNS45NDI2MiAyOS40Njk0IDMuNjAwNEMgMjYuMTk2MyAxLjI1ODE4IDIyLjI4MjMgMCAxOC4yNjkgMEMgMTQuMjU1NyAwIDEwLjM0MTcgMS4yNTgxOCA3LjA2ODYgMy42MDA0QyAzLjc5NTU2IDUuOTQyNjIgMS4zMjUzOSA5LjI1MzAzIDAgMTMuMDczNEMgMy41Njc0NSA4LjgyNDYzIDEwLjQyMzIgNS45MzkzMSAxOC4yNzMzIDUuOTM5MzFaIi8+CiAgICA8L2c+CiAgICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjY5LjMgMjI4MS4zMSkiIGQ9Ik0gNS44OTM1MyAyLjg0NEMgNS45MTg4OSAzLjQzMTY1IDUuNzcwODUgNC4wMTM2NyA1LjQ2ODE1IDQuNTE2NDVDIDUuMTY1NDUgNS4wMTkyMiA0LjcyMTY4IDUuNDIwMTUgNC4xOTI5OSA1LjY2ODUxQyAzLjY2NDMgNS45MTY4OCAzLjA3NDQ0IDYuMDAxNTEgMi40OTgwNSA1LjkxMTcxQyAxLjkyMTY2IDUuODIxOSAxLjM4NDYzIDUuNTYxNyAwLjk1NDg5OCA1LjE2NDAxQyAwLjUyNTE3IDQuNzY2MzMgMC4yMjIwNTYgNC4yNDkwMyAwLjA4MzkwMzcgMy42Nzc1N0MgLTAuMDU0MjQ4MyAzLjEwNjExIC0wLjAyMTIzIDIuNTA2MTcgMC4xNzg3ODEgMS45NTM2NEMgMC4zNzg3OTMgMS40MDExIDAuNzM2ODA5IDAuOTIwODE3IDEuMjA3NTQgMC41NzM1MzhDIDEuNjc4MjYgMC4yMjYyNTkgMi4yNDA1NSAwLjAyNzU5MTkgMi44MjMyNiAwLjAwMjY3MjI5QyAzLjYwMzg5IC0wLjAzMDcxMTUgNC4zNjU3MyAwLjI0OTc4OSA0Ljk0MTQyIDAuNzgyNTUxQyA1LjUxNzExIDEuMzE1MzEgNS44NTk1NiAyLjA1Njc2IDUuODkzNTMgMi44NDRaIi8+CiAgICAgIDxwYXRoIHRyYW5zZm9ybT0idHJhbnNsYXRlKDE2MzkuOCAyMzIzLjgxKSIgZD0iTSA3LjQyNzg5IDMuNTgzMzhDIDcuNDYwMDggNC4zMjQzIDcuMjczNTUgNS4wNTgxOSA2Ljg5MTkzIDUuNjkyMTNDIDYuNTEwMzEgNi4zMjYwNyA1Ljk1MDc1IDYuODMxNTYgNS4yODQxMSA3LjE0NDZDIDQuNjE3NDcgNy40NTc2MyAzLjg3MzcxIDcuNTY0MTQgMy4xNDcwMiA3LjQ1MDYzQyAyLjQyMDMyIDcuMzM3MTIgMS43NDMzNiA3LjAwODcgMS4yMDE4NCA2LjUwNjk1QyAwLjY2MDMyOCA2LjAwNTIgMC4yNzg2MSA1LjM1MjY4IDAuMTA1MDE3IDQuNjMyMDJDIC0wLjA2ODU3NTcgMy45MTEzNSAtMC4wMjYyMzYxIDMuMTU0OTQgMC4yMjY2NzUgMi40NTg1NkMgMC40Nzk1ODcgMS43NjIxNyAwLjkzMTY5NyAxLjE1NzEzIDEuNTI1NzYgMC43MjAwMzNDIDIuMTE5ODMgMC4yODI5MzUgMi44MjkxNCAwLjAzMzQzOTUgMy41NjM4OSAwLjAwMzEzMzQ0QyA0LjU0NjY3IC0wLjAzNzQwMzMgNS41MDUyOSAwLjMxNjcwNiA2LjIyOTYxIDAuOTg3ODM1QyA2Ljk1MzkzIDEuNjU4OTYgNy4zODQ4NCAyLjU5MjM1IDcuNDI3ODkgMy41ODMzOEwgNy40Mjc4OSAzLjU4MzM4WiIvPgogICAgICA8cGF0aCB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxNjM4LjM2IDIyODYuMDYpIiBkPSJNIDIuMjc0NzEgNC4zOTYyOUMgMS44NDM2MyA0LjQxNTA4IDEuNDE2NzEgNC4zMDQ0NSAxLjA0Nzk5IDQuMDc4NDNDIDAuNjc5MjY4IDMuODUyNCAwLjM4NTMyOCAzLjUyMTE0IDAuMjAzMzcxIDMuMTI2NTZDIDAuMDIxNDEzNiAyLjczMTk4IC0wLjA0MDM3OTggMi4yOTE4MyAwLjAyNTgxMTYgMS44NjE4MUMgMC4wOTIwMDMxIDEuNDMxOCAwLjI4MzIwNCAxLjAzMTI2IDAuNTc1MjEzIDAuNzEwODgzQyAwLjg2NzIyMiAwLjM5MDUxIDEuMjQ2OTEgMC4xNjQ3MDggMS42NjYyMiAwLjA2MjA1OTJDIDIuMDg1NTMgLTAuMDQwNTg5NyAyLjUyNTYxIC0wLjAxNTQ3MTQgMi45MzA3NiAwLjEzNDIzNUMgMy4zMzU5MSAwLjI4Mzk0MSAzLjY4NzkyIDAuNTUxNTA1IDMuOTQyMjIgMC45MDMwNkMgNC4xOTY1MiAxLjI1NDYyIDQuMzQxNjkgMS42NzQzNiA0LjM1OTM1IDIuMTA5MTZDIDQuMzgyOTkgMi42OTEwNyA0LjE3Njc4IDMuMjU4NjkgMy43ODU5NyAzLjY4NzQ2QyAzLjM5NTE2IDQuMTE2MjQgMi44NTE2NiA0LjM3MTE2IDIuMjc0NzEgNC4zOTYyOUwgMi4yNzQ3MSA0LjM5NjI5WiIvPgogICAgPC9nPgogIDwvZz4+Cjwvc3ZnPgo=);
  --jp-icon-jupyterlab-wordmark: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyMDAiIHZpZXdCb3g9IjAgMCAxODYwLjggNDc1Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0RTRFNEUiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDQ4MC4xMzY0MDEsIDY0LjI3MTQ5MykiPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC4wMDAwMDAsIDU4Ljg3NTU2NikiPgogICAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgwLjA4NzYwMywgMC4xNDAyOTQpIj4KICAgICAgICA8cGF0aCBkPSJNLTQyNi45LDE2OS44YzAsNDguNy0zLjcsNjQuNy0xMy42LDc2LjRjLTEwLjgsMTAtMjUsMTUuNS0zOS43LDE1LjVsMy43LDI5IGMyMi44LDAuMyw0NC44LTcuOSw2MS45LTIzLjFjMTcuOC0xOC41LDI0LTQ0LjEsMjQtODMuM1YwSC00Mjd2MTcwLjFMLTQyNi45LDE2OS44TC00MjYuOSwxNjkuOHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMTU1LjA0NTI5NiwgNTYuODM3MTA0KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEuNTYyNDUzLCAxLjc5OTg0MikiPgogICAgICAgIDxwYXRoIGQ9Ik0tMzEyLDE0OGMwLDIxLDAsMzkuNSwxLjcsNTUuNGgtMzEuOGwtMi4xLTMzLjNoLTAuOGMtNi43LDExLjYtMTYuNCwyMS4zLTI4LDI3LjkgYy0xMS42LDYuNi0yNC44LDEwLTM4LjIsOS44Yy0zMS40LDAtNjktMTcuNy02OS04OVYwaDM2LjR2MTEyLjdjMCwzOC43LDExLjYsNjQuNyw0NC42LDY0LjdjMTAuMy0wLjIsMjAuNC0zLjUsMjguOS05LjQgYzguNS01LjksMTUuMS0xNC4zLDE4LjktMjMuOWMyLjItNi4xLDMuMy0xMi41LDMuMy0xOC45VjAuMmgzNi40VjE0OEgtMzEyTC0zMTIsMTQ4eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgzOTAuMDEzMzIyLCA1My40Nzk2MzgpIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS43MDY0NTgsIDAuMjMxNDI1KSI+CiAgICAgICAgPHBhdGggZD0iTS00NzguNiw3MS40YzAtMjYtMC44LTQ3LTEuNy02Ni43aDMyLjdsMS43LDM0LjhoMC44YzcuMS0xMi41LDE3LjUtMjIuOCwzMC4xLTI5LjcgYzEyLjUtNywyNi43LTEwLjMsNDEtOS44YzQ4LjMsMCw4NC43LDQxLjcsODQuNywxMDMuM2MwLDczLjEtNDMuNywxMDkuMi05MSwxMDkuMmMtMTIuMSwwLjUtMjQuMi0yLjItMzUtNy44IGMtMTAuOC01LjYtMTkuOS0xMy45LTI2LjYtMjQuMmgtMC44VjI5MWgtMzZ2LTIyMEwtNDc4LjYsNzEuNEwtNDc4LjYsNzEuNHogTS00NDIuNiwxMjUuNmMwLjEsNS4xLDAuNiwxMC4xLDEuNywxNS4xIGMzLDEyLjMsOS45LDIzLjMsMTkuOCwzMS4xYzkuOSw3LjgsMjIuMSwxMi4xLDM0LjcsMTIuMWMzOC41LDAsNjAuNy0zMS45LDYwLjctNzguNWMwLTQwLjctMjEuMS03NS42LTU5LjUtNzUuNiBjLTEyLjksMC40LTI1LjMsNS4xLTM1LjMsMTMuNGMtOS45LDguMy0xNi45LDE5LjctMTkuNiwzMi40Yy0xLjUsNC45LTIuMywxMC0yLjUsMTUuMVYxMjUuNkwtNDQyLjYsMTI1LjZMLTQ0Mi42LDEyNS42eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSg2MDYuNzQwNzI2LCA1Ni44MzcxMDQpIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMC43NTEyMjYsIDEuOTg5Mjk5KSI+CiAgICAgICAgPHBhdGggZD0iTS00NDAuOCwwbDQzLjcsMTIwLjFjNC41LDEzLjQsOS41LDI5LjQsMTIuOCw0MS43aDAuOGMzLjctMTIuMiw3LjktMjcuNywxMi44LTQyLjQgbDM5LjctMTE5LjJoMzguNUwtMzQ2LjksMTQ1Yy0yNiw2OS43LTQzLjcsMTA1LjQtNjguNiwxMjcuMmMtMTIuNSwxMS43LTI3LjksMjAtNDQuNiwyMy45bC05LjEtMzEuMSBjMTEuNy0zLjksMjIuNS0xMC4xLDMxLjgtMTguMWMxMy4yLTExLjEsMjMuNy0yNS4yLDMwLjYtNDEuMmMxLjUtMi44LDIuNS01LjcsMi45LTguOGMtMC4zLTMuMy0xLjItNi42LTIuNS05LjdMLTQ4MC4yLDAuMSBoMzkuN0wtNDQwLjgsMEwtNDQwLjgsMHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoODIyLjc0ODEwNCwgMC4wMDAwMDApIj4KICAgICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoMS40NjQwNTAsIDAuMzc4OTE0KSI+CiAgICAgICAgPHBhdGggZD0iTS00MTMuNywwdjU4LjNoNTJ2MjguMmgtNTJWMTk2YzAsMjUsNywzOS41LDI3LjMsMzkuNWM3LjEsMC4xLDE0LjItMC43LDIxLjEtMi41IGwxLjcsMjcuN2MtMTAuMywzLjctMjEuMyw1LjQtMzIuMiw1Yy03LjMsMC40LTE0LjYtMC43LTIxLjMtMy40Yy02LjgtMi43LTEyLjktNi44LTE3LjktMTIuMWMtMTAuMy0xMC45LTE0LjEtMjktMTQuMS01Mi45IFY4Ni41aC0zMVY1OC4zaDMxVjkuNkwtNDEzLjcsMEwtNDEzLjcsMHoiLz4KICAgICAgPC9nPgogICAgPC9nPgogICAgPGcgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOTc0LjQzMzI4NiwgNTMuNDc5NjM4KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDAuOTkwMDM0LCAwLjYxMDMzOSkiPgogICAgICAgIDxwYXRoIGQ9Ik0tNDQ1LjgsMTEzYzAuOCw1MCwzMi4yLDcwLjYsNjguNiw3MC42YzE5LDAuNiwzNy45LTMsNTUuMy0xMC41bDYuMiwyNi40IGMtMjAuOSw4LjktNDMuNSwxMy4xLTY2LjIsMTIuNmMtNjEuNSwwLTk4LjMtNDEuMi05OC4zLTEwMi41Qy00ODAuMiw0OC4yLTQ0NC43LDAtMzg2LjUsMGM2NS4yLDAsODIuNyw1OC4zLDgyLjcsOTUuNyBjLTAuMSw1LjgtMC41LDExLjUtMS4yLDE3LjJoLTE0MC42SC00NDUuOEwtNDQ1LjgsMTEzeiBNLTMzOS4yLDg2LjZjMC40LTIzLjUtOS41LTYwLjEtNTAuNC02MC4xIGMtMzYuOCwwLTUyLjgsMzQuNC01NS43LDYwLjFILTMzOS4yTC0zMzkuMiw4Ni42TC0zMzkuMiw4Ni42eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgICA8ZyB0cmFuc2Zvcm09InRyYW5zbGF0ZSgxMjAxLjk2MTA1OCwgNTMuNDc5NjM4KSI+CiAgICAgIDxnIHRyYW5zZm9ybT0idHJhbnNsYXRlKDEuMTc5NjQwLCAwLjcwNTA2OCkiPgogICAgICAgIDxwYXRoIGQ9Ik0tNDc4LjYsNjhjMC0yMy45LTAuNC00NC41LTEuNy02My40aDMxLjhsMS4yLDM5LjloMS43YzkuMS0yNy4zLDMxLTQ0LjUsNTUuMy00NC41IGMzLjUtMC4xLDcsMC40LDEwLjMsMS4ydjM0LjhjLTQuMS0wLjktOC4yLTEuMy0xMi40LTEuMmMtMjUuNiwwLTQzLjcsMTkuNy00OC43LDQ3LjRjLTEsNS43LTEuNiwxMS41LTEuNywxNy4ydjEwOC4zaC0zNlY2OCBMLTQ3OC42LDY4eiIvPgogICAgICA8L2c+CiAgICA8L2c+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbi13YXJuMCIgZmlsbD0iI0YzNzcyNiI+CiAgICA8cGF0aCBkPSJNMTM1Mi4zLDMyNi4yaDM3VjI4aC0zN1YzMjYuMnogTTE2MDQuOCwzMjYuMmMtMi41LTEzLjktMy40LTMxLjEtMy40LTQ4Ljd2LTc2IGMwLTQwLjctMTUuMS04My4xLTc3LjMtODMuMWMtMjUuNiwwLTUwLDcuMS02Ni44LDE4LjFsOC40LDI0LjRjMTQuMy05LjIsMzQtMTUuMSw1My0xNS4xYzQxLjYsMCw0Ni4yLDMwLjIsNDYuMiw0N3Y0LjIgYy03OC42LTAuNC0xMjIuMywyNi41LTEyMi4zLDc1LjZjMCwyOS40LDIxLDU4LjQsNjIuMiw1OC40YzI5LDAsNTAuOS0xNC4zLDYyLjItMzAuMmgxLjNsMi45LDI1LjZIMTYwNC44eiBNMTU2NS43LDI1Ny43IGMwLDMuOC0wLjgsOC0yLjEsMTEuOGMtNS45LDE3LjItMjIuNywzNC00OS4yLDM0Yy0xOC45LDAtMzQuOS0xMS4zLTM0LjktMzUuM2MwLTM5LjUsNDUuOC00Ni42LDg2LjItNDUuOFYyNTcuN3ogTTE2OTguNSwzMjYuMiBsMS43LTMzLjZoMS4zYzE1LjEsMjYuOSwzOC43LDM4LjIsNjguMSwzOC4yYzQ1LjQsMCw5MS4yLTM2LjEsOTEuMi0xMDguOGMwLjQtNjEuNy0zNS4zLTEwMy43LTg1LjctMTAzLjcgYy0zMi44LDAtNTYuMywxNC43LTY5LjMsMzcuNGgtMC44VjI4aC0zNi42djI0NS43YzAsMTguMS0wLjgsMzguNi0xLjcsNTIuNUgxNjk4LjV6IE0xNzA0LjgsMjA4LjJjMC01LjksMS4zLTEwLjksMi4xLTE1LjEgYzcuNi0yOC4xLDMxLjEtNDUuNCw1Ni4zLTQ1LjRjMzkuNSwwLDYwLjUsMzQuOSw2MC41LDc1LjZjMCw0Ni42LTIzLjEsNzguMS02MS44LDc4LjFjLTI2LjksMC00OC4zLTE3LjYtNTUuNS00My4zIGMtMC44LTQuMi0xLjctOC44LTEuNy0xMy40VjIwOC4yeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-kernel: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgZmlsbD0iIzYxNjE2MSIgZD0iTTE1IDlIOXY2aDZWOXptLTIgNGgtMnYtMmgydjJ6bTgtMlY5aC0yVjdjMC0xLjEtLjktMi0yLTJoLTJWM2gtMnYyaC0yVjNIOXYySDdjLTEuMSAwLTIgLjktMiAydjJIM3YyaDJ2MkgzdjJoMnYyYzAgMS4xLjkgMiAyIDJoMnYyaDJ2LTJoMnYyaDJ2LTJoMmMxLjEgMCAyLS45IDItMnYtMmgydi0yaC0ydi0yaDJ6bS00IDZIN1Y3aDEwdjEweiIvPgo8L3N2Zz4K);
  --jp-icon-keyboard: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMjAgNUg0Yy0xLjEgMC0xLjk5LjktMS45OSAyTDIgMTdjMCAxLjEuOSAyIDIgMmgxNmMxLjEgMCAyLS45IDItMlY3YzAtMS4xLS45LTItMi0yem0tOSAzaDJ2MmgtMlY4em0wIDNoMnYyaC0ydi0yek04IDhoMnYySDhWOHptMCAzaDJ2Mkg4di0yem0tMSAySDV2LTJoMnYyem0wLTNINVY4aDJ2MnptOSA3SDh2LTJoOHYyem0wLTRoLTJ2LTJoMnYyem0wLTNoLTJWOGgydjJ6bTMgM2gtMnYtMmgydjJ6bTAtM2gtMlY4aDJ2MnoiLz4KPC9zdmc+Cg==);
  --jp-icon-launch: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMzIgMzIiIHdpZHRoPSIzMiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik0yNiwyOEg2YTIuMDAyNywyLjAwMjcsMCwwLDEtMi0yVjZBMi4wMDI3LDIuMDAyNywwLDAsMSw2LDRIMTZWNkg2VjI2SDI2VjE2aDJWMjZBMi4wMDI3LDIuMDAyNywwLDAsMSwyNiwyOFoiLz4KICAgIDxwb2x5Z29uIHBvaW50cz0iMjAgMiAyMCA0IDI2LjU4NiA0IDE4IDEyLjU4NiAxOS40MTQgMTQgMjggNS40MTQgMjggMTIgMzAgMTIgMzAgMiAyMCAyIi8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-launcher: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkgMTlINVY1aDdWM0g1YTIgMiAwIDAwLTIgMnYxNGEyIDIgMCAwMDIgMmgxNGMxLjEgMCAyLS45IDItMnYtN2gtMnY3ek0xNCAzdjJoMy41OWwtOS44MyA5LjgzIDEuNDEgMS40MUwxOSA2LjQxVjEwaDJWM2gtN3oiLz4KPC9zdmc+Cg==);
  --jp-icon-line-form: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGZpbGw9IndoaXRlIiBkPSJNNS44OCA0LjEyTDEzLjc2IDEybC03Ljg4IDcuODhMOCAyMmwxMC0xMEw4IDJ6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-link: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTMuOSAxMmMwLTEuNzEgMS4zOS0zLjEgMy4xLTMuMWg0VjdIN2MtMi43NiAwLTUgMi4yNC01IDVzMi4yNCA1IDUgNWg0di0xLjlIN2MtMS43MSAwLTMuMS0xLjM5LTMuMS0zLjF6TTggMTNoOHYtMkg4djJ6bTktNmgtNHYxLjloNGMxLjcxIDAgMy4xIDEuMzkgMy4xIDMuMXMtMS4zOSAzLjEtMy4xIDMuMWgtNFYxN2g0YzIuNzYgMCA1LTIuMjQgNS01cy0yLjI0LTUtNS01eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-list: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xOSA1djE0SDVWNWgxNG0xLjEtMkgzLjljLS41IDAtLjkuNC0uOS45djE2LjJjMCAuNC40LjkuOS45aDE2LjJjLjQgMCAuOS0uNS45LS45VjMuOWMwLS41LS41LS45LS45LS45ek0xMSA3aDZ2MmgtNlY3em0wIDRoNnYyaC02di0yem0wIDRoNnYyaC02ek03IDdoMnYySDd6bTAgNGgydjJIN3ptMCA0aDJ2Mkg3eiIvPgo8L3N2Zz4K);
  --jp-icon-markdown: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDAganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjN0IxRkEyIiBkPSJNNSAxNC45aDEybC02LjEgNnptOS40LTYuOGMwLTEuMy0uMS0yLjktLjEtNC41LS40IDEuNC0uOSAyLjktMS4zIDQuM2wtMS4zIDQuM2gtMkw4LjUgNy45Yy0uNC0xLjMtLjctMi45LTEtNC4zLS4xIDEuNi0uMSAzLjItLjIgNC42TDcgMTIuNEg0LjhsLjctMTFoMy4zTDEwIDVjLjQgMS4yLjcgMi43IDEgMy45LjMtMS4yLjctMi42IDEtMy45bDEuMi0zLjdoMy4zbC42IDExaC0yLjRsLS4zLTQuMnoiLz4KPC9zdmc+Cg==);
  --jp-icon-move-down: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNMTIuNDcxIDcuNTI4OTlDMTIuNzYzMiA3LjIzNjg0IDEyLjc2MzIgNi43NjMxNiAxMi40NzEgNi40NzEwMVY2LjQ3MTAxQzEyLjE3OSA2LjE3OTA1IDExLjcwNTcgNi4xNzg4NCAxMS40MTM1IDYuNDcwNTRMNy43NSAxMC4xMjc1VjEuNzVDNy43NSAxLjMzNTc5IDcuNDE0MjEgMSA3IDFWMUM2LjU4NTc5IDEgNi4yNSAxLjMzNTc5IDYuMjUgMS43NVYxMC4xMjc1TDIuNTk3MjYgNi40NjgyMkMyLjMwMzM4IDYuMTczODEgMS44MjY0MSA2LjE3MzU5IDEuNTMyMjYgNi40Njc3NFY2LjQ2Nzc0QzEuMjM4MyA2Ljc2MTcgMS4yMzgzIDcuMjM4MyAxLjUzMjI2IDcuNTMyMjZMNi4yOTI4OSAxMi4yOTI5QzYuNjgzNDIgMTIuNjgzNCA3LjMxNjU4IDEyLjY4MzQgNy43MDcxMSAxMi4yOTI5TDEyLjQ3MSA3LjUyODk5WiIgZmlsbD0iIzYxNjE2MSIvPgo8L3N2Zz4K);
  --jp-icon-move-up: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTQiIGhlaWdodD0iMTQiIHZpZXdCb3g9IjAgMCAxNCAxNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggY2xhc3M9ImpwLWljb24zIiBkPSJNMS41Mjg5OSA2LjQ3MTAxQzEuMjM2ODQgNi43NjMxNiAxLjIzNjg0IDcuMjM2ODQgMS41Mjg5OSA3LjUyODk5VjcuNTI4OTlDMS44MjA5NSA3LjgyMDk1IDIuMjk0MjYgNy44MjExNiAyLjU4NjQ5IDcuNTI5NDZMNi4yNSAzLjg3MjVWMTIuMjVDNi4yNSAxMi42NjQyIDYuNTg1NzkgMTMgNyAxM1YxM0M3LjQxNDIxIDEzIDcuNzUgMTIuNjY0MiA3Ljc1IDEyLjI1VjMuODcyNUwxMS40MDI3IDcuNTMxNzhDMTEuNjk2NiA3LjgyNjE5IDEyLjE3MzYgNy44MjY0MSAxMi40Njc3IDcuNTMyMjZWNy41MzIyNkMxMi43NjE3IDcuMjM4MyAxMi43NjE3IDYuNzYxNyAxMi40Njc3IDYuNDY3NzRMNy43MDcxMSAxLjcwNzExQzcuMzE2NTggMS4zMTY1OCA2LjY4MzQyIDEuMzE2NTggNi4yOTI4OSAxLjcwNzExTDEuNTI4OTkgNi40NzEwMVoiIGZpbGw9IiM2MTYxNjEiLz4KPC9zdmc+Cg==);
  --jp-icon-new-folder: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIwIDZoLThsLTItMkg0Yy0xLjExIDAtMS45OS44OS0xLjk5IDJMMiAxOGMwIDEuMTEuODkgMiAyIDJoMTZjMS4xMSAwIDItLjg5IDItMlY4YzAtMS4xMS0uODktMi0yLTJ6bS0xIDhoLTN2M2gtMnYtM2gtM3YtMmgzVjloMnYzaDN2MnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-not-trusted: url(data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI1IDI1Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMgMykiIGQ9Ik0xLjg2MDk0IDExLjQ0MDlDMC44MjY0NDggOC43NzAyNyAwLjg2Mzc3OSA2LjA1NzY0IDEuMjQ5MDcgNC4xOTkzMkMyLjQ4MjA2IDMuOTMzNDcgNC4wODA2OCAzLjQwMzQ3IDUuNjAxMDIgMi44NDQ5QzcuMjM1NDkgMi4yNDQ0IDguODU2NjYgMS41ODE1IDkuOTg3NiAxLjA5NTM5QzExLjA1OTcgMS41ODM0MSAxMi42MDk0IDIuMjQ0NCAxNC4yMTggMi44NDMzOUMxNS43NTAzIDMuNDEzOTQgMTcuMzk5NSAzLjk1MjU4IDE4Ljc1MzkgNC4yMTM4NUMxOS4xMzY0IDYuMDcxNzcgMTkuMTcwOSA4Ljc3NzIyIDE4LjEzOSAxMS40NDA5QzE3LjAzMDMgMTQuMzAzMiAxNC42NjY4IDE3LjE4NDQgOS45OTk5OSAxOC45MzU0QzUuMzMzMTkgMTcuMTg0NCAyLjk2OTY4IDE0LjMwMzIgMS44NjA5NCAxMS40NDA5WiIvPgogICAgPHBhdGggY2xhc3M9ImpwLWljb24yIiBzdHJva2U9IiMzMzMzMzMiIHN0cm9rZS13aWR0aD0iMiIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOS4zMTU5MiA5LjMyMDMxKSIgZD0iTTcuMzY4NDIgMEwwIDcuMzY0NzkiLz4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDkuMzE1OTIgMTYuNjgzNikgc2NhbGUoMSAtMSkiIGQ9Ik03LjM2ODQyIDBMMCA3LjM2NDc5Ii8+Cjwvc3ZnPgo=);
  --jp-icon-notebook: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtbm90ZWJvb2staWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiNFRjZDMDAiPgogICAgPHBhdGggZD0iTTE4LjcgMy4zdjE1LjRIMy4zVjMuM2gxNS40bTEuNS0xLjVIMS44djE4LjNoMTguM2wuMS0xOC4zeiIvPgogICAgPHBhdGggZD0iTTE2LjUgMTYuNWwtNS40LTQuMy01LjYgNC4zdi0xMWgxMXoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-numbering: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjIiIGhlaWdodD0iMjIiIHZpZXdCb3g9IjAgMCAyOCAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTQgMTlINlYxOS41SDVWMjAuNUg2VjIxSDRWMjJIN1YxOEg0VjE5Wk01IDEwSDZWNkg0VjdINVYxMFpNNCAxM0g1LjhMNCAxNS4xVjE2SDdWMTVINS4yTDcgMTIuOVYxMkg0VjEzWk05IDdWOUgyM1Y3SDlaTTkgMjFIMjNWMTlIOVYyMVpNOSAxNUgyM1YxM0g5VjE1WiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-offline-bolt: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyIDIuMDJjLTUuNTEgMC05Ljk4IDQuNDctOS45OCA5Ljk4czQuNDcgOS45OCA5Ljk4IDkuOTggOS45OC00LjQ3IDkuOTgtOS45OFMxNy41MSAyLjAyIDEyIDIuMDJ6TTExLjQ4IDIwdi02LjI2SDhMMTMgNHY2LjI2aDMuMzVMMTEuNDggMjB6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-palette: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE4IDEzVjIwSDRWNkg5LjAyQzkuMDcgNS4yOSA5LjI0IDQuNjIgOS41IDRINEMyLjkgNCAyIDQuOSAyIDZWMjBDMiAyMS4xIDIuOSAyMiA0IDIySDE4QzE5LjEgMjIgMjAgMjEuMSAyMCAyMFYxNUwxOCAxM1pNMTkuMyA4Ljg5QzE5Ljc0IDguMTkgMjAgNy4zOCAyMCA2LjVDMjAgNC4wMSAxNy45OSAyIDE1LjUgMkMxMy4wMSAyIDExIDQuMDEgMTEgNi41QzExIDguOTkgMTMuMDEgMTEgMTUuNDkgMTFDMTYuMzcgMTEgMTcuMTkgMTAuNzQgMTcuODggMTAuM0wyMSAxMy40MkwyMi40MiAxMkwxOS4zIDguODlaTTE1LjUgOUMxNC4xMiA5IDEzIDcuODggMTMgNi41QzEzIDUuMTIgMTQuMTIgNCAxNS41IDRDMTYuODggNCAxOCA1LjEyIDE4IDYuNUMxOCA3Ljg4IDE2Ljg4IDkgMTUuNSA5WiIvPgogICAgPHBhdGggZmlsbC1ydWxlPSJldmVub2RkIiBjbGlwLXJ1bGU9ImV2ZW5vZGQiIGQ9Ik00IDZIOS4wMTg5NEM5LjAwNjM5IDYuMTY1MDIgOSA2LjMzMTc2IDkgNi41QzkgOC44MTU3NyAxMC4yMTEgMTAuODQ4NyAxMi4wMzQzIDEySDlWMTRIMTZWMTIuOTgxMUMxNi41NzAzIDEyLjkzNzcgMTcuMTIgMTIuODIwNyAxNy42Mzk2IDEyLjYzOTZMMTggMTNWMjBINFY2Wk04IDhINlYxMEg4VjhaTTYgMTJIOFYxNEg2VjEyWk04IDE2SDZWMThIOFYxNlpNOSAxNkgxNlYxOEg5VjE2WiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-paste: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTE5IDJoLTQuMThDMTQuNC44NCAxMy4zIDAgMTIgMGMtMS4zIDAtMi40Ljg0LTIuODIgMkg1Yy0xLjEgMC0yIC45LTIgMnYxNmMwIDEuMS45IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjRjMC0xLjEtLjktMi0yLTJ6bS03IDBjLjU1IDAgMSAuNDUgMSAxcy0uNDUgMS0xIDEtMS0uNDUtMS0xIC40NS0xIDEtMXptNyAxOEg1VjRoMnYzaDEwVjRoMnYxNnoiLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-pdf: url(data:image/svg+xml;base64,PHN2ZwogICB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCAyMiAyMiIgd2lkdGg9IjE2Ij4KICAgIDxwYXRoIHRyYW5zZm9ybT0icm90YXRlKDQ1KSIgY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI0ZGMkEyQSIKICAgICAgIGQ9Im0gMjIuMzQ0MzY5LC0zLjAxNjM2NDIgaCA1LjYzODYwNCB2IDEuNTc5MjQzMyBoIC0zLjU0OTIyNyB2IDEuNTA4NjkyOTkgaCAzLjMzNzU3NiBWIDEuNjUwODE1NCBoIC0zLjMzNzU3NiB2IDMuNDM1MjYxMyBoIC0yLjA4OTM3NyB6IG0gLTcuMTM2NDQ0LDEuNTc5MjQzMyB2IDQuOTQzOTU0MyBoIDAuNzQ4OTIgcSAxLjI4MDc2MSwwIDEuOTUzNzAzLC0wLjYzNDk1MzUgMC42NzgzNjksLTAuNjM0OTUzNSAwLjY3ODM2OSwtMS44NDUxNjQxIDAsLTEuMjA0NzgzNTUgLTAuNjcyOTQyLC0xLjgzNDMxMDExIC0wLjY3Mjk0MiwtMC42Mjk1MjY1OSAtMS45NTkxMywtMC42Mjk1MjY1OSB6IG0gLTIuMDg5Mzc3LC0xLjU3OTI0MzMgaCAyLjIwMzM0MyBxIDEuODQ1MTY0LDAgMi43NDYwMzksMC4yNjU5MjA3IDAuOTA2MzAxLDAuMjYwNDkzNyAxLjU1MjEwOCwwLjg5MDAyMDMgMC41Njk4MywwLjU0ODEyMjMgMC44NDY2MDUsMS4yNjQ0ODAwNiAwLjI3Njc3NCwwLjcxNjM1NzgxIDAuMjc2Nzc0LDEuNjIyNjU4OTQgMCwwLjkxNzE1NTEgLTAuMjc2Nzc0LDEuNjM4OTM5OSAtMC4yNzY3NzUsMC43MTYzNTc4IC0wLjg0NjYwNSwxLjI2NDQ4IC0wLjY1MTIzNCwwLjYyOTUyNjYgLTEuNTYyOTYyLDAuODk1NDQ3MyAtMC45MTE3MjgsMC4yNjA0OTM3IC0yLjczNTE4NSwwLjI2MDQ5MzcgaCAtMi4yMDMzNDMgeiBtIC04LjE0NTg1NjUsMCBoIDMuNDY3ODIzIHEgMS41NDY2ODE2LDAgMi4zNzE1Nzg1LDAuNjg5MjIzIDAuODMwMzI0LDAuNjgzNzk2MSAwLjgzMDMyNCwxLjk1MzcwMzE0IDAsMS4yNzUzMzM5NyAtMC44MzAzMjQsMS45NjQ1NTcwNiBRIDkuOTg3MTk2MSwyLjI3NDkxNSA4LjQ0MDUxNDUsMi4yNzQ5MTUgSCA3LjA2MjA2ODQgViA1LjA4NjA3NjcgSCA0Ljk3MjY5MTUgWiBtIDIuMDg5Mzc2OSwxLjUxNDExOTkgdiAyLjI2MzAzOTQzIGggMS4xNTU5NDEgcSAwLjYwNzgxODgsMCAwLjkzODg2MjksLTAuMjkzMDU1NDcgMC4zMzEwNDQxLC0wLjI5ODQ4MjQxIDAuMzMxMDQ0MSwtMC44NDExNzc3MiAwLC0wLjU0MjY5NTMxIC0wLjMzMTA0NDEsLTAuODM1NzUwNzQgLTAuMzMxMDQ0MSwtMC4yOTMwNTU1IC0wLjkzODg2MjksLTAuMjkzMDU1NSB6IgovPgo8L3N2Zz4K);
  --jp-icon-python: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iLTEwIC0xMCAxMzEuMTYxMzYxNjk0MzM1OTQgMTMyLjM4ODk5OTkzODk2NDg0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMzA2OTk4IiBkPSJNIDU0LjkxODc4NSw5LjE5Mjc0MjFlLTQgQyA1MC4zMzUxMzIsMC4wMjIyMTcyNyA0NS45NTc4NDYsMC40MTMxMzY5NyA0Mi4xMDYyODUsMS4wOTQ2NjkzIDMwLjc2MDA2OSwzLjA5OTE3MzEgMjguNzAwMDM2LDcuMjk0NzcxNCAyOC43MDAwMzUsMTUuMDMyMTY5IHYgMTAuMjE4NzUgaCAyNi44MTI1IHYgMy40MDYyNSBoIC0yNi44MTI1IC0xMC4wNjI1IGMgLTcuNzkyNDU5LDAgLTE0LjYxNTc1ODgsNC42ODM3MTcgLTE2Ljc0OTk5OTgsMTMuNTkzNzUgLTIuNDYxODE5OTgsMTAuMjEyOTY2IC0yLjU3MTAxNTA4LDE2LjU4NjAyMyAwLDI3LjI1IDEuOTA1OTI4Myw3LjkzNzg1MiA2LjQ1NzU0MzIsMTMuNTkzNzQ4IDE0LjI0OTk5OTgsMTMuNTkzNzUgaCA5LjIxODc1IHYgLTEyLjI1IGMgMCwtOC44NDk5MDIgNy42NTcxNDQsLTE2LjY1NjI0OCAxNi43NSwtMTYuNjU2MjUgaCAyNi43ODEyNSBjIDcuNDU0OTUxLDAgMTMuNDA2MjUzLC02LjEzODE2NCAxMy40MDYyNSwtMTMuNjI1IHYgLTI1LjUzMTI1IGMgMCwtNy4yNjYzMzg2IC02LjEyOTk4LC0xMi43MjQ3NzcxIC0xMy40MDYyNSwtMTMuOTM3NDk5NyBDIDY0LjI4MTU0OCwwLjMyNzk0Mzk3IDU5LjUwMjQzOCwtMC4wMjAzNzkwMyA1NC45MTg3ODUsOS4xOTI3NDIxZS00IFogbSAtMTQuNSw4LjIxODc1MDEyNTc5IGMgMi43Njk1NDcsMCA1LjAzMTI1LDIuMjk4NjQ1NiA1LjAzMTI1LDUuMTI0OTk5NiAtMmUtNiwyLjgxNjMzNiAtMi4yNjE3MDMsNS4wOTM3NSAtNS4wMzEyNSw1LjA5Mzc1IC0yLjc3OTQ3NiwtMWUtNiAtNS4wMzEyNSwtMi4yNzc0MTUgLTUuMDMxMjUsLTUuMDkzNzUgLTEwZS03LC0yLjgyNjM1MyAyLjI1MTc3NCwtNS4xMjQ5OTk2IDUuMDMxMjUsLTUuMTI0OTk5NiB6Ii8+CiAgPHBhdGggY2xhc3M9ImpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iI2ZmZDQzYiIgZD0ibSA4NS42Mzc1MzUsMjguNjU3MTY5IHYgMTEuOTA2MjUgYyAwLDkuMjMwNzU1IC03LjgyNTg5NSwxNi45OTk5OTkgLTE2Ljc1LDE3IGggLTI2Ljc4MTI1IGMgLTcuMzM1ODMzLDAgLTEzLjQwNjI0OSw2LjI3ODQ4MyAtMTMuNDA2MjUsMTMuNjI1IHYgMjUuNTMxMjQ3IGMgMCw3LjI2NjM0NCA2LjMxODU4OCwxMS41NDAzMjQgMTMuNDA2MjUsMTMuNjI1MDA0IDguNDg3MzMxLDIuNDk1NjEgMTYuNjI2MjM3LDIuOTQ2NjMgMjYuNzgxMjUsMCA2Ljc1MDE1NSwtMS45NTQzOSAxMy40MDYyNTMsLTUuODg3NjEgMTMuNDA2MjUsLTEzLjYyNTAwNCBWIDg2LjUwMDkxOSBoIC0yNi43ODEyNSB2IC0zLjQwNjI1IGggMjYuNzgxMjUgMTMuNDA2MjU0IGMgNy43OTI0NjEsMCAxMC42OTYyNTEsLTUuNDM1NDA4IDEzLjQwNjI0MSwtMTMuNTkzNzUgMi43OTkzMywtOC4zOTg4ODYgMi42ODAyMiwtMTYuNDc1Nzc2IDAsLTI3LjI1IC0xLjkyNTc4LC03Ljc1NzQ0MSAtNS42MDM4NywtMTMuNTkzNzUgLTEzLjQwNjI0MSwtMTMuNTkzNzUgeiBtIC0xNS4wNjI1LDY0LjY1NjI1IGMgMi43Nzk0NzgsM2UtNiA1LjAzMTI1LDIuMjc3NDE3IDUuMDMxMjUsNS4wOTM3NDcgLTJlLTYsMi44MjYzNTQgLTIuMjUxNzc1LDUuMTI1MDA0IC01LjAzMTI1LDUuMTI1MDA0IC0yLjc2OTU1LDAgLTUuMDMxMjUsLTIuMjk4NjUgLTUuMDMxMjUsLTUuMTI1MDA0IDJlLTYsLTIuODE2MzMgMi4yNjE2OTcsLTUuMDkzNzQ3IDUuMDMxMjUsLTUuMDkzNzQ3IHoiLz4KPC9zdmc+Cg==);
  --jp-icon-r-kernel: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMjE5NkYzIiBkPSJNNC40IDIuNWMxLjItLjEgMi45LS4zIDQuOS0uMyAyLjUgMCA0LjEuNCA1LjIgMS4zIDEgLjcgMS41IDEuOSAxLjUgMy41IDAgMi0xLjQgMy41LTIuOSA0LjEgMS4yLjQgMS43IDEuNiAyLjIgMyAuNiAxLjkgMSAzLjkgMS4zIDQuNmgtMy44Yy0uMy0uNC0uOC0xLjctMS4yLTMuN3MtMS4yLTIuNi0yLjYtMi42aC0uOXY2LjRINC40VjIuNXptMy43IDYuOWgxLjRjMS45IDAgMi45LS45IDIuOS0yLjNzLTEtMi4zLTIuOC0yLjNjLS43IDAtMS4zIDAtMS42LjJ2NC41aC4xdi0uMXoiLz4KPC9zdmc+Cg==);
  --jp-icon-react: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMTUwIDE1MCA1NDEuOSAyOTUuMyI+CiAgPGcgY2xhc3M9ImpwLWljb24tYnJhbmQyIGpwLWljb24tc2VsZWN0YWJsZSIgZmlsbD0iIzYxREFGQiI+CiAgICA8cGF0aCBkPSJNNjY2LjMgMjk2LjVjMC0zMi41LTQwLjctNjMuMy0xMDMuMS04Mi40IDE0LjQtNjMuNiA4LTExNC4yLTIwLjItMTMwLjQtNi41LTMuOC0xNC4xLTUuNi0yMi40LTUuNnYyMi4zYzQuNiAwIDguMy45IDExLjQgMi42IDEzLjYgNy44IDE5LjUgMzcuNSAxNC45IDc1LjctMS4xIDkuNC0yLjkgMTkuMy01LjEgMjkuNC0xOS42LTQuOC00MS04LjUtNjMuNS0xMC45LTEzLjUtMTguNS0yNy41LTM1LjMtNDEuNi01MCAzMi42LTMwLjMgNjMuMi00Ni45IDg0LTQ2LjlWNzhjLTI3LjUgMC02My41IDE5LjYtOTkuOSA1My42LTM2LjQtMzMuOC03Mi40LTUzLjItOTkuOS01My4ydjIyLjNjMjAuNyAwIDUxLjQgMTYuNSA4NCA0Ni42LTE0IDE0LjctMjggMzEuNC00MS4zIDQ5LjktMjIuNiAyLjQtNDQgNi4xLTYzLjYgMTEtMi4zLTEwLTQtMTkuNy01LjItMjktNC43LTM4LjIgMS4xLTY3LjkgMTQuNi03NS44IDMtMS44IDYuOS0yLjYgMTEuNS0yLjZWNzguNWMtOC40IDAtMTYgMS44LTIyLjYgNS42LTI4LjEgMTYuMi0zNC40IDY2LjctMTkuOSAxMzAuMS02Mi4yIDE5LjItMTAyLjcgNDkuOS0xMDIuNyA4Mi4zIDAgMzIuNSA0MC43IDYzLjMgMTAzLjEgODIuNC0xNC40IDYzLjYtOCAxMTQuMiAyMC4yIDEzMC40IDYuNSAzLjggMTQuMSA1LjYgMjIuNSA1LjYgMjcuNSAwIDYzLjUtMTkuNiA5OS45LTUzLjYgMzYuNCAzMy44IDcyLjQgNTMuMiA5OS45IDUzLjIgOC40IDAgMTYtMS44IDIyLjYtNS42IDI4LjEtMTYuMiAzNC40LTY2LjcgMTkuOS0xMzAuMSA2Mi0xOS4xIDEwMi41LTQ5LjkgMTAyLjUtODIuM3ptLTEzMC4yLTY2LjdjLTMuNyAxMi45LTguMyAyNi4yLTEzLjUgMzkuNS00LjEtOC04LjQtMTYtMTMuMS0yNC00LjYtOC05LjUtMTUuOC0xNC40LTIzLjQgMTQuMiAyLjEgMjcuOSA0LjcgNDEgNy45em0tNDUuOCAxMDYuNWMtNy44IDEzLjUtMTUuOCAyNi4zLTI0LjEgMzguMi0xNC45IDEuMy0zMCAyLTQ1LjIgMi0xNS4xIDAtMzAuMi0uNy00NS0xLjktOC4zLTExLjktMTYuNC0yNC42LTI0LjItMzgtNy42LTEzLjEtMTQuNS0yNi40LTIwLjgtMzkuOCA2LjItMTMuNCAxMy4yLTI2LjggMjAuNy0zOS45IDcuOC0xMy41IDE1LjgtMjYuMyAyNC4xLTM4LjIgMTQuOS0xLjMgMzAtMiA0NS4yLTIgMTUuMSAwIDMwLjIuNyA0NSAxLjkgOC4zIDExLjkgMTYuNCAyNC42IDI0LjIgMzggNy42IDEzLjEgMTQuNSAyNi40IDIwLjggMzkuOC02LjMgMTMuNC0xMy4yIDI2LjgtMjAuNyAzOS45em0zMi4zLTEzYzUuNCAxMy40IDEwIDI2LjggMTMuOCAzOS44LTEzLjEgMy4yLTI2LjkgNS45LTQxLjIgOCA0LjktNy43IDkuOC0xNS42IDE0LjQtMjMuNyA0LjYtOCA4LjktMTYuMSAxMy0yNC4xek00MjEuMiA0MzBjLTkuMy05LjYtMTguNi0yMC4zLTI3LjgtMzIgOSAuNCAxOC4yLjcgMjcuNS43IDkuNCAwIDE4LjctLjIgMjcuOC0uNy05IDExLjctMTguMyAyMi40LTI3LjUgMzJ6bS03NC40LTU4LjljLTE0LjItMi4xLTI3LjktNC43LTQxLTcuOSAzLjctMTIuOSA4LjMtMjYuMiAxMy41LTM5LjUgNC4xIDggOC40IDE2IDEzLjEgMjQgNC43IDggOS41IDE1LjggMTQuNCAyMy40ek00MjAuNyAxNjNjOS4zIDkuNiAxOC42IDIwLjMgMjcuOCAzMi05LS40LTE4LjItLjctMjcuNS0uNy05LjQgMC0xOC43LjItMjcuOC43IDktMTEuNyAxOC4zLTIyLjQgMjcuNS0zMnptLTc0IDU4LjljLTQuOSA3LjctOS44IDE1LjYtMTQuNCAyMy43LTQuNiA4LTguOSAxNi0xMyAyNC01LjQtMTMuNC0xMC0yNi44LTEzLjgtMzkuOCAxMy4xLTMuMSAyNi45LTUuOCA0MS4yLTcuOXptLTkwLjUgMTI1LjJjLTM1LjQtMTUuMS01OC4zLTM0LjktNTguMy01MC42IDAtMTUuNyAyMi45LTM1LjYgNTguMy01MC42IDguNi0zLjcgMTgtNyAyNy43LTEwLjEgNS43IDE5LjYgMTMuMiA0MCAyMi41IDYwLjktOS4yIDIwLjgtMTYuNiA0MS4xLTIyLjIgNjAuNi05LjktMy4xLTE5LjMtNi41LTI4LTEwLjJ6TTMxMCA0OTBjLTEzLjYtNy44LTE5LjUtMzcuNS0xNC45LTc1LjcgMS4xLTkuNCAyLjktMTkuMyA1LjEtMjkuNCAxOS42IDQuOCA0MSA4LjUgNjMuNSAxMC45IDEzLjUgMTguNSAyNy41IDM1LjMgNDEuNiA1MC0zMi42IDMwLjMtNjMuMiA0Ni45LTg0IDQ2LjktNC41LS4xLTguMy0xLTExLjMtMi43em0yMzcuMi03Ni4yYzQuNyAzOC4yLTEuMSA2Ny45LTE0LjYgNzUuOC0zIDEuOC02LjkgMi42LTExLjUgMi42LTIwLjcgMC01MS40LTE2LjUtODQtNDYuNiAxNC0xNC43IDI4LTMxLjQgNDEuMy00OS45IDIyLjYtMi40IDQ0LTYuMSA2My42LTExIDIuMyAxMC4xIDQuMSAxOS44IDUuMiAyOS4xem0zOC41LTY2LjdjLTguNiAzLjctMTggNy0yNy43IDEwLjEtNS43LTE5LjYtMTMuMi00MC0yMi41LTYwLjkgOS4yLTIwLjggMTYuNi00MS4xIDIyLjItNjAuNiA5LjkgMy4xIDE5LjMgNi41IDI4LjEgMTAuMiAzNS40IDE1LjEgNTguMyAzNC45IDU4LjMgNTAuNi0uMSAxNS43LTIzIDM1LjYtNTguNCA1MC42ek0zMjAuOCA3OC40eiIvPgogICAgPGNpcmNsZSBjeD0iNDIwLjkiIGN5PSIyOTYuNSIgcj0iNDUuNyIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-redo: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgd2lkdGg9IjE2Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgICA8cGF0aCBkPSJNMCAwaDI0djI0SDB6IiBmaWxsPSJub25lIi8+PHBhdGggZD0iTTE4LjQgMTAuNkMxNi41NSA4Ljk5IDE0LjE1IDggMTEuNSA4Yy00LjY1IDAtOC41OCAzLjAzLTkuOTYgNy4yMkwzLjkgMTZjMS4wNS0zLjE5IDQuMDUtNS41IDcuNi01LjUgMS45NSAwIDMuNzMuNzIgNS4xMiAxLjg4TDEzIDE2aDlWN2wtMy42IDMuNnoiLz4KICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-refresh: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDE4IDE4Ij4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTkgMTMuNWMtMi40OSAwLTQuNS0yLjAxLTQuNS00LjVTNi41MSA0LjUgOSA0LjVjMS4yNCAwIDIuMzYuNTIgMy4xNyAxLjMzTDEwIDhoNVYzbC0xLjc2IDEuNzZDMTIuMTUgMy42OCAxMC42NiAzIDkgMyA1LjY5IDMgMy4wMSA1LjY5IDMuMDEgOVM1LjY5IDE1IDkgMTVjMi45NyAwIDUuNDMtMi4xNiA1LjktNWgtMS41MmMtLjQ2IDItMi4yNCAzLjUtNC4zOCAzLjV6Ii8+CiAgICA8L2c+Cjwvc3ZnPgo=);
  --jp-icon-regex: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KICA8ZyBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiM0MTQxNDEiPgogICAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiAgPC9nPgoKICA8ZyBjbGFzcz0ianAtaWNvbi1hY2NlbnQyIiBmaWxsPSIjRkZGIj4KICAgIDxjaXJjbGUgY2xhc3M9InN0MiIgY3g9IjUuNSIgY3k9IjE0LjUiIHI9IjEuNSIvPgogICAgPHJlY3QgeD0iMTIiIHk9IjQiIGNsYXNzPSJzdDIiIHdpZHRoPSIxIiBoZWlnaHQ9IjgiLz4KICAgIDxyZWN0IHg9IjguNSIgeT0iNy41IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjg2NiAtMC41IDAuNSAwLjg2NiAtMi4zMjU1IDcuMzIxOSkiIGNsYXNzPSJzdDIiIHdpZHRoPSI4IiBoZWlnaHQ9IjEiLz4KICAgIDxyZWN0IHg9IjEyIiB5PSI0IiB0cmFuc2Zvcm09Im1hdHJpeCgwLjUgLTAuODY2IDAuODY2IDAuNSAtMC42Nzc5IDE0LjgyNTIpIiBjbGFzcz0ic3QyIiB3aWR0aD0iMSIgaGVpZ2h0PSI4Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-run: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTggNXYxNGwxMS03eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-running: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDUxMiA1MTIiPgogIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICA8cGF0aCBkPSJNMjU2IDhDMTE5IDggOCAxMTkgOCAyNTZzMTExIDI0OCAyNDggMjQ4IDI0OC0xMTEgMjQ4LTI0OFMzOTMgOCAyNTYgOHptOTYgMzI4YzAgOC44LTcuMiAxNi0xNiAxNkgxNzZjLTguOCAwLTE2LTcuMi0xNi0xNlYxNzZjMC04LjggNy4yLTE2IDE2LTE2aDE2MGM4LjggMCAxNiA3LjIgMTYgMTZ2MTYweiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-save: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTE3IDNINWMtMS4xMSAwLTIgLjktMiAydjE0YzAgMS4xLjg5IDIgMiAyaDE0YzEuMSAwIDItLjkgMi0yVjdsLTQtNHptLTUgMTZjLTEuNjYgMC0zLTEuMzQtMy0zczEuMzQtMyAzLTMgMyAxLjM0IDMgMy0xLjM0IDMtMyAzem0zLTEwSDVWNWgxMHY0eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-search: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMTggMTgiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyLjEsMTAuOWgtMC43bC0wLjItMC4yYzAuOC0wLjksMS4zLTIuMiwxLjMtMy41YzAtMy0yLjQtNS40LTUuNC01LjRTMS44LDQuMiwxLjgsNy4xczIuNCw1LjQsNS40LDUuNCBjMS4zLDAsMi41LTAuNSwzLjUtMS4zbDAuMiwwLjJ2MC43bDQuMSw0LjFsMS4yLTEuMkwxMi4xLDEwLjl6IE03LjEsMTAuOWMtMi4xLDAtMy43LTEuNy0zLjctMy43czEuNy0zLjcsMy43LTMuN3MzLjcsMS43LDMuNywzLjcgUzkuMiwxMC45LDcuMSwxMC45eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-settings: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIiBkPSJNMTkuNDMgMTIuOThjLjA0LS4zMi4wNy0uNjQuMDctLjk4cy0uMDMtLjY2LS4wNy0uOThsMi4xMS0xLjY1Yy4xOS0uMTUuMjQtLjQyLjEyLS42NGwtMi0zLjQ2Yy0uMTItLjIyLS4zOS0uMy0uNjEtLjIybC0yLjQ5IDFjLS41Mi0uNC0xLjA4LS43My0xLjY5LS45OGwtLjM4LTIuNjVBLjQ4OC40ODggMCAwMDE0IDJoLTRjLS4yNSAwLS40Ni4xOC0uNDkuNDJsLS4zOCAyLjY1Yy0uNjEuMjUtMS4xNy41OS0xLjY5Ljk4bC0yLjQ5LTFjLS4yMy0uMDktLjQ5IDAtLjYxLjIybC0yIDMuNDZjLS4xMy4yMi0uMDcuNDkuMTIuNjRsMi4xMSAxLjY1Yy0uMDQuMzItLjA3LjY1LS4wNy45OHMuMDMuNjYuMDcuOThsLTIuMTEgMS42NWMtLjE5LjE1LS4yNC40Mi0uMTIuNjRsMiAzLjQ2Yy4xMi4yMi4zOS4zLjYxLjIybDIuNDktMWMuNTIuNCAxLjA4LjczIDEuNjkuOThsLjM4IDIuNjVjLjAzLjI0LjI0LjQyLjQ5LjQyaDRjLjI1IDAgLjQ2LS4xOC40OS0uNDJsLjM4LTIuNjVjLjYxLS4yNSAxLjE3LS41OSAxLjY5LS45OGwyLjQ5IDFjLjIzLjA5LjQ5IDAgLjYxLS4yMmwyLTMuNDZjLjEyLS4yMi4wNy0uNDktLjEyLS42NGwtMi4xMS0xLjY1ek0xMiAxNS41Yy0xLjkzIDAtMy41LTEuNTctMy41LTMuNXMxLjU3LTMuNSAzLjUtMy41IDMuNSAxLjU3IDMuNSAzLjUtMS41NyAzLjUtMy41IDMuNXoiLz4KPC9zdmc+Cg==);
  --jp-icon-share: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTSAxOCAyIEMgMTYuMzU0OTkgMiAxNSAzLjM1NDk5MDQgMTUgNSBDIDE1IDUuMTkwOTUyOSAxNS4wMjE3OTEgNS4zNzcxMjI0IDE1LjA1NjY0MSA1LjU1ODU5MzggTCA3LjkyMTg3NSA5LjcyMDcwMzEgQyA3LjM5ODUzOTkgOS4yNzc4NTM5IDYuNzMyMDc3MSA5IDYgOSBDIDQuMzU0OTkwNCA5IDMgMTAuMzU0OTkgMyAxMiBDIDMgMTMuNjQ1MDEgNC4zNTQ5OTA0IDE1IDYgMTUgQyA2LjczMjA3NzEgMTUgNy4zOTg1Mzk5IDE0LjcyMjE0NiA3LjkyMTg3NSAxNC4yNzkyOTcgTCAxNS4wNTY2NDEgMTguNDM5NDUzIEMgMTUuMDIxNTU1IDE4LjYyMTUxNCAxNSAxOC44MDgzODYgMTUgMTkgQyAxNSAyMC42NDUwMSAxNi4zNTQ5OSAyMiAxOCAyMiBDIDE5LjY0NTAxIDIyIDIxIDIwLjY0NTAxIDIxIDE5IEMgMjEgMTcuMzU0OTkgMTkuNjQ1MDEgMTYgMTggMTYgQyAxNy4yNjc0OCAxNiAxNi42MDE1OTMgMTYuMjc5MzI4IDE2LjA3ODEyNSAxNi43MjI2NTYgTCA4Ljk0MzM1OTQgMTIuNTU4NTk0IEMgOC45NzgyMDk1IDEyLjM3NzEyMiA5IDEyLjE5MDk1MyA5IDEyIEMgOSAxMS44MDkwNDcgOC45NzgyMDk1IDExLjYyMjg3OCA4Ljk0MzM1OTQgMTEuNDQxNDA2IEwgMTYuMDc4MTI1IDcuMjc5Mjk2OSBDIDE2LjYwMTQ2IDcuNzIyMTQ2MSAxNy4yNjc5MjMgOCAxOCA4IEMgMTkuNjQ1MDEgOCAyMSA2LjY0NTAwOTYgMjEgNSBDIDIxIDMuMzU0OTkwNCAxOS42NDUwMSAyIDE4IDIgeiBNIDE4IDQgQyAxOC41NjQxMjkgNCAxOSA0LjQzNTg3MDYgMTkgNSBDIDE5IDUuNTY0MTI5NCAxOC41NjQxMjkgNiAxOCA2IEMgMTcuNDM1ODcxIDYgMTcgNS41NjQxMjk0IDE3IDUgQyAxNyA0LjQzNTg3MDYgMTcuNDM1ODcxIDQgMTggNCB6IE0gNiAxMSBDIDYuNTY0MTI5NCAxMSA3IDExLjQzNTg3MSA3IDEyIEMgNyAxMi41NjQxMjkgNi41NjQxMjk0IDEzIDYgMTMgQyA1LjQzNTg3MDYgMTMgNSAxMi41NjQxMjkgNSAxMiBDIDUgMTEuNDM1ODcxIDUuNDM1ODcwNiAxMSA2IDExIHogTSAxOCAxOCBDIDE4LjU2NDEyOSAxOCAxOSAxOC40MzU4NzEgMTkgMTkgQyAxOSAxOS41NjQxMjkgMTguNTY0MTI5IDIwIDE4IDIwIEMgMTcuNDM1ODcxIDIwIDE3IDE5LjU2NDEyOSAxNyAxOSBDIDE3IDE4LjQzNTg3MSAxNy40MzU4NzEgMTggMTggMTggeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-spreadsheet: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8cGF0aCBjbGFzcz0ianAtaWNvbi1jb250cmFzdDEganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNENBRjUwIiBkPSJNMi4yIDIuMnYxNy42aDE3LjZWMi4ySDIuMnptMTUuNCA3LjdoLTUuNVY0LjRoNS41djUuNXpNOS45IDQuNHY1LjVINC40VjQuNGg1LjV6bS01LjUgNy43aDUuNXY1LjVINC40di01LjV6bTcuNyA1LjV2LTUuNWg1LjV2NS41aC01LjV6Ii8+Cjwvc3ZnPgo=);
  --jp-icon-stop: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik02IDZoMTJ2MTJINnoiLz4KICAgIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-tab: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTIxIDNIM2MtMS4xIDAtMiAuOS0yIDJ2MTRjMCAxLjEuOSAyIDIgMmgxOGMxLjEgMCAyLS45IDItMlY1YzAtMS4xLS45LTItMi0yem0wIDE2SDNWNWgxMHY0aDh2MTB6Ii8+CiAgPC9nPgo8L3N2Zz4K);
  --jp-icon-table-rows: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik0yMSw4SDNWNGgxOFY4eiBNMjEsMTBIM3Y0aDE4VjEweiBNMjEsMTZIM3Y0aDE4VjE2eiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-tag: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjgiIGhlaWdodD0iMjgiIHZpZXdCb3g9IjAgMCA0MyAyOCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KCTxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CgkJPHBhdGggZD0iTTI4LjgzMzIgMTIuMzM0TDMyLjk5OTggMTYuNTAwN0wzNy4xNjY1IDEyLjMzNEgyOC44MzMyWiIvPgoJCTxwYXRoIGQ9Ik0xNi4yMDk1IDIxLjYxMDRDMTUuNjg3MyAyMi4xMjk5IDE0Ljg0NDMgMjIuMTI5OSAxNC4zMjQ4IDIxLjYxMDRMNi45ODI5IDE0LjcyNDVDNi41NzI0IDE0LjMzOTQgNi4wODMxMyAxMy42MDk4IDYuMDQ3ODYgMTMuMDQ4MkM1Ljk1MzQ3IDExLjUyODggNi4wMjAwMiA4LjYxOTQ0IDYuMDY2MjEgNy4wNzY5NUM2LjA4MjgxIDYuNTE0NzcgNi41NTU0OCA2LjA0MzQ3IDcuMTE4MDQgNi4wMzA1NUM5LjA4ODYzIDUuOTg0NzMgMTMuMjYzOCA1LjkzNTc5IDEzLjY1MTggNi4zMjQyNUwyMS43MzY5IDEzLjYzOUMyMi4yNTYgMTQuMTU4NSAyMS43ODUxIDE1LjQ3MjQgMjEuMjYyIDE1Ljk5NDZMMTYuMjA5NSAyMS42MTA0Wk05Ljc3NTg1IDguMjY1QzkuMzM1NTEgNy44MjU2NiA4LjYyMzUxIDcuODI1NjYgOC4xODI4IDguMjY1QzcuNzQzNDYgOC43MDU3MSA3Ljc0MzQ2IDkuNDE3MzMgOC4xODI4IDkuODU2NjdDOC42MjM4MiAxMC4yOTY0IDkuMzM1ODIgMTAuMjk2NCA5Ljc3NTg1IDkuODU2NjdDMTAuMjE1NiA5LjQxNzMzIDEwLjIxNTYgOC43MDUzMyA5Ljc3NTg1IDguMjY1WiIvPgoJPC9nPgo8L3N2Zz4K);
  --jp-icon-terminal: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0IiA+CiAgICA8cmVjdCBjbGFzcz0ianAtdGVybWluYWwtaWNvbi1iYWNrZ3JvdW5kLWNvbG9yIGpwLWljb24tc2VsZWN0YWJsZSIgd2lkdGg9IjIwIiBoZWlnaHQ9IjIwIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSgyIDIpIiBmaWxsPSIjMzMzMzMzIi8+CiAgICA8cGF0aCBjbGFzcz0ianAtdGVybWluYWwtaWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUtaW52ZXJzZSIgZD0iTTUuMDU2NjQgOC43NjE3MkM1LjA1NjY0IDguNTk3NjYgNS4wMzEyNSA4LjQ1MzEyIDQuOTgwNDcgOC4zMjgxMkM0LjkzMzU5IDguMTk5MjIgNC44NTU0NyA4LjA4MjAzIDQuNzQ2MDkgNy45NzY1NkM0LjY0MDYyIDcuODcxMDkgNC41IDcuNzc1MzkgNC4zMjQyMiA3LjY4OTQ1QzQuMTUyMzQgNy41OTk2MSAzLjk0MzM2IDcuNTExNzIgMy42OTcyNyA3LjQyNTc4QzMuMzAyNzMgNy4yODUxNiAyLjk0MzM2IDcuMTM2NzIgMi42MTkxNCA2Ljk4MDQ3QzIuMjk0OTIgNi44MjQyMiAyLjAxNzU4IDYuNjQyNTggMS43ODcxMSA2LjQzNTU1QzEuNTYwNTUgNi4yMjg1MiAxLjM4NDc3IDUuOTg4MjggMS4yNTk3NyA1LjcxNDg0QzEuMTM0NzcgNS40Mzc1IDEuMDcyMjcgNS4xMDkzOCAxLjA3MjI3IDQuNzMwNDdDMS4wNzIyNyA0LjM5ODQ0IDEuMTI4OTEgNC4wOTU3IDEuMjQyMTkgMy44MjIyN0MxLjM1NTQ3IDMuNTQ0OTIgMS41MTU2MiAzLjMwNDY5IDEuNzIyNjYgMy4xMDE1NkMxLjkyOTY5IDIuODk4NDQgMi4xNzk2OSAyLjczNDM3IDIuNDcyNjYgMi42MDkzOEMyLjc2NTYyIDIuNDg0MzggMy4wOTE4IDIuNDA0MyAzLjQ1MTE3IDIuMzY5MTRWMS4xMDkzOEg0LjM4ODY3VjIuMzgwODZDNC43NDAyMyAyLjQyNzczIDUuMDU2NjQgMi41MjM0NCA1LjMzNzg5IDIuNjY3OTdDNS42MTkxNCAyLjgxMjUgNS44NTc0MiAzLjAwMTk1IDYuMDUyNzMgMy4yMzYzM0M2LjI1MTk1IDMuNDY2OCA2LjQwNDMgMy43NDAyMyA2LjUwOTc3IDQuMDU2NjRDNi42MTkxNCA0LjM2OTE0IDYuNjczODMgNC43MjA3IDYuNjczODMgNS4xMTEzM0g1LjA0NDkyQzUuMDQ0OTIgNC42Mzg2NyA0LjkzNzUgNC4yODEyNSA0LjcyMjY2IDQuMDM5MDZDNC41MDc4MSAzLjc5Mjk3IDQuMjE2OCAzLjY2OTkyIDMuODQ5NjEgMy42Njk5MkMzLjY1MDM5IDMuNjY5OTIgMy40NzY1NiAzLjY5NzI3IDMuMzI4MTIgMy43NTE5NUMzLjE4MzU5IDMuODAyNzMgMy4wNjQ0NSAzLjg3Njk1IDIuOTcwNyAzLjk3NDYxQzIuODc2OTUgNC4wNjgzNiAyLjgwNjY0IDQuMTc5NjkgMi43NTk3NyA0LjMwODU5QzIuNzE2OCA0LjQzNzUgMi42OTUzMSA0LjU3ODEyIDIuNjk1MzEgNC43MzA0N0MyLjY5NTMxIDQuODgyODEgMi43MTY4IDUuMDE5NTMgMi43NTk3NyA1LjE0MDYyQzIuODA2NjQgNS4yNTc4MSAyLjg4MjgxIDUuMzY3MTkgMi45ODgyOCA1LjQ2ODc1QzMuMDk3NjYgNS41NzAzMSAzLjI0MDIzIDUuNjY3OTcgMy40MTYwMiA1Ljc2MTcyQzMuNTkxOCA1Ljg1MTU2IDMuODEwNTUgNS45NDMzNiA0LjA3MjI3IDYuMDM3MTFDNC40NjY4IDYuMTg1NTUgNC44MjQyMiA2LjMzOTg0IDUuMTQ0NTMgNi41QzUuNDY0ODQgNi42NTYyNSA1LjczODI4IDYuODM5ODQgNS45NjQ4NCA3LjA1MDc4QzYuMTk1MzEgNy4yNTc4MSA2LjM3MTA5IDcuNSA2LjQ5MjE5IDcuNzc3MzRDNi42MTcxOSA4LjA1MDc4IDYuNjc5NjkgOC4zNzUgNi42Nzk2OSA4Ljc1QzYuNjc5NjkgOS4wOTM3NSA2LjYyMzA1IDkuNDA0MyA2LjUwOTc3IDkuNjgxNjRDNi4zOTY0OCA5Ljk1NTA4IDYuMjM0MzggMTAuMTkxNCA2LjAyMzQ0IDEwLjM5MDZDNS44MTI1IDEwLjU4OTggNS41NTg1OSAxMC43NSA1LjI2MTcyIDEwLjg3MTFDNC45NjQ4NCAxMC45ODgzIDQuNjMyODEgMTEuMDY0NSA0LjI2NTYyIDExLjA5OTZWMTIuMjQ4SDMuMzMzOThWMTEuMDk5NkMzLjAwMTk1IDExLjA2ODQgMi42Nzk2OSAxMC45OTYxIDIuMzY3MTkgMTAuODgyOEMyLjA1NDY5IDEwLjc2NTYgMS43NzczNCAxMC41OTc3IDEuNTM1MTYgMTAuMzc4OUMxLjI5Njg4IDEwLjE2MDIgMS4xMDU0NyA5Ljg4NDc3IDAuOTYwOTM4IDkuNTUyNzNDMC44MTY0MDYgOS4yMTY4IDAuNzQ0MTQxIDguODE0NDUgMC43NDQxNDEgOC4zNDU3SDIuMzc4OTFDMi4zNzg5MSA4LjYyNjk1IDIuNDE5OTIgOC44NjMyOCAyLjUwMTk1IDkuMDU0NjlDMi41ODM5OCA5LjI0MjE5IDIuNjg5NDUgOS4zOTI1OCAyLjgxODM2IDkuNTA1ODZDMi45NTExNyA5LjYxNTIzIDMuMTAxNTYgOS42OTMzNiAzLjI2OTUzIDkuNzQwMjNDMy40Mzc1IDkuNzg3MTEgMy42MDkzOCA5LjgxMDU1IDMuNzg1MTYgOS44MTA1NUM0LjIwMzEyIDkuODEwNTUgNC41MTk1MyA5LjcxMjg5IDQuNzM0MzggOS41MTc1OEM0Ljk0OTIyIDkuMzIyMjcgNS4wNTY2NCA5LjA3MDMxIDUuMDU2NjQgOC43NjE3MlpNMTMuNDE4IDEyLjI3MTVIOC4wNzQyMlYxMUgxMy40MThWMTIuMjcxNVoiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDMuOTUyNjQgNikiIGZpbGw9IndoaXRlIi8+Cjwvc3ZnPgo=);
  --jp-icon-text-editor: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8cGF0aCBjbGFzcz0ianAtdGV4dC1lZGl0b3ItaWNvbi1jb2xvciBqcC1pY29uLXNlbGVjdGFibGUiIGZpbGw9IiM2MTYxNjEiIGQ9Ik0xNSAxNUgzdjJoMTJ2LTJ6bTAtOEgzdjJoMTJWN3pNMyAxM2gxOHYtMkgzdjJ6bTAgOGgxOHYtMkgzdjJ6TTMgM3YyaDE4VjNIM3oiLz4KPC9zdmc+Cg==);
  --jp-icon-toc: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIyNCIgaGVpZ2h0PSIyNCIgdmlld0JveD0iMCAwIDI0IDI0Ij4KICA8ZyBjbGFzcz0ianAtaWNvbjMganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjNjE2MTYxIj4KICAgIDxwYXRoIGQ9Ik03LDVIMjFWN0g3VjVNNywxM1YxMUgyMVYxM0g3TTQsNC41QTEuNSwxLjUgMCAwLDEgNS41LDZBMS41LDEuNSAwIDAsMSA0LDcuNUExLjUsMS41IDAgMCwxIDIuNSw2QTEuNSwxLjUgMCAwLDEgNCw0LjVNNCwxMC41QTEuNSwxLjUgMCAwLDEgNS41LDEyQTEuNSwxLjUgMCAwLDEgNCwxMy41QTEuNSwxLjUgMCAwLDEgMi41LDEyQTEuNSwxLjUgMCAwLDEgNCwxMC41TTcsMTlWMTdIMjFWMTlIN000LDE2LjVBMS41LDEuNSAwIDAsMSA1LjUsMThBMS41LDEuNSAwIDAsMSA0LDE5LjVBMS41LDEuNSAwIDAsMSAyLjUsMThBMS41LDEuNSAwIDAsMSA0LDE2LjVaIiAvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-tree-view: url(data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjI0IiB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICAgIDxnIGNsYXNzPSJqcC1pY29uMyIgZmlsbD0iIzYxNjE2MSI+CiAgICAgICAgPHBhdGggZD0iTTAgMGgyNHYyNEgweiIgZmlsbD0ibm9uZSIvPgogICAgICAgIDxwYXRoIGQ9Ik0yMiAxMVYzaC03djNIOVYzSDJ2OGg3VjhoMnYxMGg0djNoN3YtOGgtN3YzaC0yVjhoMnYzeiIvPgogICAgPC9nPgo8L3N2Zz4K);
  --jp-icon-trusted: url(data:image/svg+xml;base64,PHN2ZyBmaWxsPSJub25lIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDI0IDI1Ij4KICAgIDxwYXRoIGNsYXNzPSJqcC1pY29uMiIgc3Ryb2tlPSIjMzMzMzMzIiBzdHJva2Utd2lkdGg9IjIiIHRyYW5zZm9ybT0idHJhbnNsYXRlKDIgMykiIGQ9Ik0xLjg2MDk0IDExLjQ0MDlDMC44MjY0NDggOC43NzAyNyAwLjg2Mzc3OSA2LjA1NzY0IDEuMjQ5MDcgNC4xOTkzMkMyLjQ4MjA2IDMuOTMzNDcgNC4wODA2OCAzLjQwMzQ3IDUuNjAxMDIgMi44NDQ5QzcuMjM1NDkgMi4yNDQ0IDguODU2NjYgMS41ODE1IDkuOTg3NiAxLjA5NTM5QzExLjA1OTcgMS41ODM0MSAxMi42MDk0IDIuMjQ0NCAxNC4yMTggMi44NDMzOUMxNS43NTAzIDMuNDEzOTQgMTcuMzk5NSAzLjk1MjU4IDE4Ljc1MzkgNC4yMTM4NUMxOS4xMzY0IDYuMDcxNzcgMTkuMTcwOSA4Ljc3NzIyIDE4LjEzOSAxMS40NDA5QzE3LjAzMDMgMTQuMzAzMiAxNC42NjY4IDE3LjE4NDQgOS45OTk5OSAxOC45MzU0QzUuMzMzMiAxNy4xODQ0IDIuOTY5NjggMTQuMzAzMiAxLjg2MDk0IDExLjQ0MDlaIi8+CiAgICA8cGF0aCBjbGFzcz0ianAtaWNvbjIiIGZpbGw9IiMzMzMzMzMiIHN0cm9rZT0iIzMzMzMzMyIgdHJhbnNmb3JtPSJ0cmFuc2xhdGUoOCA5Ljg2NzE5KSIgZD0iTTIuODYwMTUgNC44NjUzNUwwLjcyNjU0OSAyLjk5OTU5TDAgMy42MzA0NUwyLjg2MDE1IDYuMTMxNTdMOCAwLjYzMDg3Mkw3LjI3ODU3IDBMMi44NjAxNSA0Ljg2NTM1WiIvPgo8L3N2Zz4K);
  --jp-icon-undo: url(data:image/svg+xml;base64,PHN2ZyB2aWV3Qm94PSIwIDAgMjQgMjQiIHdpZHRoPSIxNiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTEyLjUgOGMtMi42NSAwLTUuMDUuOTktNi45IDIuNkwyIDd2OWg5bC0zLjYyLTMuNjJjMS4zOS0xLjE2IDMuMTYtMS44OCA1LjEyLTEuODggMy41NCAwIDYuNTUgMi4zMSA3LjYgNS41bDIuMzctLjc4QzIxLjA4IDExLjAzIDE3LjE1IDggMTIuNSA4eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-user: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTYiIHZpZXdCb3g9IjAgMCAyNCAyNCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8ZyBjbGFzcz0ianAtaWNvbjMiIGZpbGw9IiM2MTYxNjEiPgogICAgPHBhdGggZD0iTTE2IDdhNCA0IDAgMTEtOCAwIDQgNCAwIDAxOCAwek0xMiAxNGE3IDcgMCAwMC03IDdoMTRhNyA3IDAgMDAtNy03eiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-users: url(data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZlcnNpb249IjEuMSIgdmlld0JveD0iMCAwIDM2IDI0IiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPgogPGcgY2xhc3M9ImpwLWljb24zIiB0cmFuc2Zvcm09Im1hdHJpeCgxLjczMjcgMCAwIDEuNzMyNyAtMy42MjgyIC4wOTk1NzcpIiBmaWxsPSIjNjE2MTYxIj4KICA8cGF0aCB0cmFuc2Zvcm09Im1hdHJpeCgxLjUsMCwwLDEuNSwwLC02KSIgZD0ibTEyLjE4NiA3LjUwOThjLTEuMDUzNSAwLTEuOTc1NyAwLjU2NjUtMi40Nzg1IDEuNDEwMiAwLjc1MDYxIDAuMzEyNzcgMS4zOTc0IDAuODI2NDggMS44NzMgMS40NzI3aDMuNDg2M2MwLTEuNTkyLTEuMjg4OS0yLjg4MjgtMi44ODA5LTIuODgyOHoiLz4KICA8cGF0aCBkPSJtMjAuNDY1IDIuMzg5NWEyLjE4ODUgMi4xODg1IDAgMCAxLTIuMTg4NCAyLjE4ODUgMi4xODg1IDIuMTg4NSAwIDAgMS0yLjE4ODUtMi4xODg1IDIuMTg4NSAyLjE4ODUgMCAwIDEgMi4xODg1LTIuMTg4NSAyLjE4ODUgMi4xODg1IDAgMCAxIDIuMTg4NCAyLjE4ODV6Ii8+CiAgPHBhdGggdHJhbnNmb3JtPSJtYXRyaXgoMS41LDAsMCwxLjUsMCwtNikiIGQ9Im0zLjU4OTggOC40MjE5Yy0xLjExMjYgMC0yLjAxMzcgMC45MDExMS0yLjAxMzcgMi4wMTM3aDIuODE0NWMwLjI2Nzk3LTAuMzczMDkgMC41OTA3LTAuNzA0MzUgMC45NTg5OC0wLjk3ODUyLTAuMzQ0MzMtMC42MTY4OC0xLjAwMzEtMS4wMzUyLTEuNzU5OC0xLjAzNTJ6Ii8+CiAgPHBhdGggZD0ibTYuOTE1NCA0LjYyM2ExLjUyOTQgMS41Mjk0IDAgMCAxLTEuNTI5NCAxLjUyOTQgMS41Mjk0IDEuNTI5NCAwIDAgMS0xLjUyOTQtMS41Mjk0IDEuNTI5NCAxLjUyOTQgMCAwIDEgMS41Mjk0LTEuNTI5NCAxLjUyOTQgMS41Mjk0IDAgMCAxIDEuNTI5NCAxLjUyOTR6Ii8+CiAgPHBhdGggZD0ibTYuMTM1IDEzLjUzNWMwLTMuMjM5MiAyLjYyNTktNS44NjUgNS44NjUtNS44NjUgMy4yMzkyIDAgNS44NjUgMi42MjU5IDUuODY1IDUuODY1eiIvPgogIDxjaXJjbGUgY3g9IjEyIiBjeT0iMy43Njg1IiByPSIyLjk2ODUiLz4KIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-vega: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtaWNvbjEganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjMjEyMTIxIj4KICAgIDxwYXRoIGQ9Ik0xMC42IDUuNGwyLjItMy4ySDIuMnY3LjNsNC02LjZ6Ii8+CiAgICA8cGF0aCBkPSJNMTUuOCAyLjJsLTQuNCA2LjZMNyA2LjNsLTQuOCA4djUuNWgxNy42VjIuMmgtNHptLTcgMTUuNEg1LjV2LTQuNGgzLjN2NC40em00LjQgMEg5LjhWOS44aDMuNHY3Ljh6bTQuNCAwaC0zLjRWNi41aDMuNHYxMS4xeiIvPgogIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-word: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIwIDIwIj4KIDxnIGNsYXNzPSJqcC1pY29uMiIgZmlsbD0iIzQxNDE0MSI+CiAgPHJlY3QgeD0iMiIgeT0iMiIgd2lkdGg9IjE2IiBoZWlnaHQ9IjE2Ii8+CiA8L2c+CiA8ZyBjbGFzcz0ianAtaWNvbi1hY2NlbnQyIiB0cmFuc2Zvcm09InRyYW5zbGF0ZSguNDMgLjA0MDEpIiBmaWxsPSIjZmZmIj4KICA8cGF0aCBkPSJtNC4xNCA4Ljc2cTAuMDY4Mi0xLjg5IDIuNDItMS44OSAxLjE2IDAgMS42OCAwLjQyIDAuNTY3IDAuNDEgMC41NjcgMS4xNnYzLjQ3cTAgMC40NjIgMC41MTQgMC40NjIgMC4xMDMgMCAwLjItMC4wMjMxdjAuNzE0cS0wLjM5OSAwLjEwMy0wLjY1MSAwLjEwMy0wLjQ1MiAwLTAuNjkzLTAuMjItMC4yMzEtMC4yLTAuMjg0LTAuNjYyLTAuOTU2IDAuODcyLTIgMC44NzItMC45MDMgMC0xLjQ3LTAuNDcyLTAuNTI1LTAuNDcyLTAuNTI1LTEuMjYgMC0wLjI2MiAwLjA0NTItMC40NzIgMC4wNTY3LTAuMjIgMC4xMTYtMC4zNzggMC4wNjgyLTAuMTY4IDAuMjMxLTAuMzA0IDAuMTU4LTAuMTQ3IDAuMjYyLTAuMjQyIDAuMTE2LTAuMDkxNCAwLjM2OC0wLjE2OCAwLjI2Mi0wLjA5MTQgMC4zOTktMC4xMjYgMC4xMzYtMC4wNDUyIDAuNDcyLTAuMTAzIDAuMzM2LTAuMDU3OCAwLjUwNC0wLjA3OTggMC4xNTgtMC4wMjMxIDAuNTY3LTAuMDc5OCAwLjU1Ni0wLjA2ODIgMC43NzctMC4yMjEgMC4yMi0wLjE1MiAwLjIyLTAuNDQxdi0wLjI1MnEwLTAuNDMtMC4zNTctMC42NjItMC4zMzYtMC4yMzEtMC45NzYtMC4yMzEtMC42NjIgMC0wLjk5OCAwLjI2Mi0wLjMzNiAwLjI1Mi0wLjM5OSAwLjc5OHptMS44OSAzLjY4cTAuNzg4IDAgMS4yNi0wLjQxIDAuNTA0LTAuNDIgMC41MDQtMC45MDN2LTEuMDVxLTAuMjg0IDAuMTM2LTAuODYxIDAuMjMxLTAuNTY3IDAuMDkxNC0wLjk4NyAwLjE1OC0wLjQyIDAuMDY4Mi0wLjc2NiAwLjMyNi0wLjMzNiAwLjI1Mi0wLjMzNiAwLjcwNHQwLjMwNCAwLjcwNCAwLjg2MSAwLjI1MnoiIHN0cm9rZS13aWR0aD0iMS4wNSIvPgogIDxwYXRoIGQ9Im0xMCA0LjU2aDAuOTQ1djMuMTVxMC42NTEtMC45NzYgMS44OS0wLjk3NiAxLjE2IDAgMS44OSAwLjg0IDAuNjgyIDAuODQgMC42ODIgMi4zMSAwIDEuNDctMC43MDQgMi40Mi0wLjcwNCAwLjg4Mi0xLjg5IDAuODgyLTEuMjYgMC0xLjg5LTEuMDJ2MC43NjZoLTAuODV6bTIuNjIgMy4wNHEtMC43NDYgMC0xLjE2IDAuNjQtMC40NTIgMC42My0wLjQ1MiAxLjY4IDAgMS4wNSAwLjQ1MiAxLjY4dDEuMTYgMC42M3EwLjc3NyAwIDEuMjYtMC42MyAwLjQ5NC0wLjY0IDAuNDk0LTEuNjggMC0xLjA1LTAuNDcyLTEuNjgtMC40NjItMC42NC0xLjI2LTAuNjR6IiBzdHJva2Utd2lkdGg9IjEuMDUiLz4KICA8cGF0aCBkPSJtMi43MyAxNS44IDEzLjYgMC4wMDgxYzAuMDA2OSAwIDAtMi42IDAtMi42IDAtMC4wMDc4LTEuMTUgMC0xLjE1IDAtMC4wMDY5IDAtMC4wMDgzIDEuNS0wLjAwODMgMS41LTJlLTMgLTAuMDAxNC0xMS4zLTAuMDAxNC0xMS4zLTAuMDAxNGwtMC4wMDU5Mi0xLjVjMC0wLjAwNzgtMS4xNyAwLjAwMTMtMS4xNyAwLjAwMTN6IiBzdHJva2Utd2lkdGg9Ii45NzUiLz4KIDwvZz4KPC9zdmc+Cg==);
  --jp-icon-yaml: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxNiIgdmlld0JveD0iMCAwIDIyIDIyIj4KICA8ZyBjbGFzcz0ianAtaWNvbi1jb250cmFzdDIganAtaWNvbi1zZWxlY3RhYmxlIiBmaWxsPSIjRDgxQjYwIj4KICAgIDxwYXRoIGQ9Ik03LjIgMTguNnYtNS40TDMgNS42aDMuM2wxLjQgMy4xYy4zLjkuNiAxLjYgMSAyLjUuMy0uOC42LTEuNiAxLTIuNWwxLjQtMy4xaDMuNGwtNC40IDcuNnY1LjVsLTIuOS0uMXoiLz4KICAgIDxjaXJjbGUgY2xhc3M9InN0MCIgY3g9IjE3LjYiIGN5PSIxNi41IiByPSIyLjEiLz4KICAgIDxjaXJjbGUgY2xhc3M9InN0MCIgY3g9IjE3LjYiIGN5PSIxMSIgcj0iMi4xIi8+CiAgPC9nPgo8L3N2Zz4K);
}

/* Icon CSS class declarations */

.jp-AddAboveIcon {
  background-image: var(--jp-icon-add-above);
}

.jp-AddBelowIcon {
  background-image: var(--jp-icon-add-below);
}

.jp-AddIcon {
  background-image: var(--jp-icon-add);
}

.jp-BellIcon {
  background-image: var(--jp-icon-bell);
}

.jp-BugDotIcon {
  background-image: var(--jp-icon-bug-dot);
}

.jp-BugIcon {
  background-image: var(--jp-icon-bug);
}

.jp-BuildIcon {
  background-image: var(--jp-icon-build);
}

.jp-CaretDownEmptyIcon {
  background-image: var(--jp-icon-caret-down-empty);
}

.jp-CaretDownEmptyThinIcon {
  background-image: var(--jp-icon-caret-down-empty-thin);
}

.jp-CaretDownIcon {
  background-image: var(--jp-icon-caret-down);
}

.jp-CaretLeftIcon {
  background-image: var(--jp-icon-caret-left);
}

.jp-CaretRightIcon {
  background-image: var(--jp-icon-caret-right);
}

.jp-CaretUpEmptyThinIcon {
  background-image: var(--jp-icon-caret-up-empty-thin);
}

.jp-CaretUpIcon {
  background-image: var(--jp-icon-caret-up);
}

.jp-CaseSensitiveIcon {
  background-image: var(--jp-icon-case-sensitive);
}

.jp-CheckIcon {
  background-image: var(--jp-icon-check);
}

.jp-CircleEmptyIcon {
  background-image: var(--jp-icon-circle-empty);
}

.jp-CircleIcon {
  background-image: var(--jp-icon-circle);
}

.jp-ClearIcon {
  background-image: var(--jp-icon-clear);
}

.jp-CloseIcon {
  background-image: var(--jp-icon-close);
}

.jp-CodeCheckIcon {
  background-image: var(--jp-icon-code-check);
}

.jp-CodeIcon {
  background-image: var(--jp-icon-code);
}

.jp-CollapseAllIcon {
  background-image: var(--jp-icon-collapse-all);
}

.jp-ConsoleIcon {
  background-image: var(--jp-icon-console);
}

.jp-CopyIcon {
  background-image: var(--jp-icon-copy);
}

.jp-CopyrightIcon {
  background-image: var(--jp-icon-copyright);
}

.jp-CutIcon {
  background-image: var(--jp-icon-cut);
}

.jp-DeleteIcon {
  background-image: var(--jp-icon-delete);
}

.jp-DownloadIcon {
  background-image: var(--jp-icon-download);
}

.jp-DuplicateIcon {
  background-image: var(--jp-icon-duplicate);
}

.jp-EditIcon {
  background-image: var(--jp-icon-edit);
}

.jp-EllipsesIcon {
  background-image: var(--jp-icon-ellipses);
}

.jp-ErrorIcon {
  background-image: var(--jp-icon-error);
}

.jp-ExpandAllIcon {
  background-image: var(--jp-icon-expand-all);
}

.jp-ExtensionIcon {
  background-image: var(--jp-icon-extension);
}

.jp-FastForwardIcon {
  background-image: var(--jp-icon-fast-forward);
}

.jp-FileIcon {
  background-image: var(--jp-icon-file);
}

.jp-FileUploadIcon {
  background-image: var(--jp-icon-file-upload);
}

.jp-FilterDotIcon {
  background-image: var(--jp-icon-filter-dot);
}

.jp-FilterIcon {
  background-image: var(--jp-icon-filter);
}

.jp-FilterListIcon {
  background-image: var(--jp-icon-filter-list);
}

.jp-FolderFavoriteIcon {
  background-image: var(--jp-icon-folder-favorite);
}

.jp-FolderIcon {
  background-image: var(--jp-icon-folder);
}

.jp-HomeIcon {
  background-image: var(--jp-icon-home);
}

.jp-Html5Icon {
  background-image: var(--jp-icon-html5);
}

.jp-ImageIcon {
  background-image: var(--jp-icon-image);
}

.jp-InfoIcon {
  background-image: var(--jp-icon-info);
}

.jp-InspectorIcon {
  background-image: var(--jp-icon-inspector);
}

.jp-JsonIcon {
  background-image: var(--jp-icon-json);
}

.jp-JuliaIcon {
  background-image: var(--jp-icon-julia);
}

.jp-JupyterFaviconIcon {
  background-image: var(--jp-icon-jupyter-favicon);
}

.jp-JupyterIcon {
  background-image: var(--jp-icon-jupyter);
}

.jp-JupyterlabWordmarkIcon {
  background-image: var(--jp-icon-jupyterlab-wordmark);
}

.jp-KernelIcon {
  background-image: var(--jp-icon-kernel);
}

.jp-KeyboardIcon {
  background-image: var(--jp-icon-keyboard);
}

.jp-LaunchIcon {
  background-image: var(--jp-icon-launch);
}

.jp-LauncherIcon {
  background-image: var(--jp-icon-launcher);
}

.jp-LineFormIcon {
  background-image: var(--jp-icon-line-form);
}

.jp-LinkIcon {
  background-image: var(--jp-icon-link);
}

.jp-ListIcon {
  background-image: var(--jp-icon-list);
}

.jp-MarkdownIcon {
  background-image: var(--jp-icon-markdown);
}

.jp-MoveDownIcon {
  background-image: var(--jp-icon-move-down);
}

.jp-MoveUpIcon {
  background-image: var(--jp-icon-move-up);
}

.jp-NewFolderIcon {
  background-image: var(--jp-icon-new-folder);
}

.jp-NotTrustedIcon {
  background-image: var(--jp-icon-not-trusted);
}

.jp-NotebookIcon {
  background-image: var(--jp-icon-notebook);
}

.jp-NumberingIcon {
  background-image: var(--jp-icon-numbering);
}

.jp-OfflineBoltIcon {
  background-image: var(--jp-icon-offline-bolt);
}

.jp-PaletteIcon {
  background-image: var(--jp-icon-palette);
}

.jp-PasteIcon {
  background-image: var(--jp-icon-paste);
}

.jp-PdfIcon {
  background-image: var(--jp-icon-pdf);
}

.jp-PythonIcon {
  background-image: var(--jp-icon-python);
}

.jp-RKernelIcon {
  background-image: var(--jp-icon-r-kernel);
}

.jp-ReactIcon {
  background-image: var(--jp-icon-react);
}

.jp-RedoIcon {
  background-image: var(--jp-icon-redo);
}

.jp-RefreshIcon {
  background-image: var(--jp-icon-refresh);
}

.jp-RegexIcon {
  background-image: var(--jp-icon-regex);
}

.jp-RunIcon {
  background-image: var(--jp-icon-run);
}

.jp-RunningIcon {
  background-image: var(--jp-icon-running);
}

.jp-SaveIcon {
  background-image: var(--jp-icon-save);
}

.jp-SearchIcon {
  background-image: var(--jp-icon-search);
}

.jp-SettingsIcon {
  background-image: var(--jp-icon-settings);
}

.jp-ShareIcon {
  background-image: var(--jp-icon-share);
}

.jp-SpreadsheetIcon {
  background-image: var(--jp-icon-spreadsheet);
}

.jp-StopIcon {
  background-image: var(--jp-icon-stop);
}

.jp-TabIcon {
  background-image: var(--jp-icon-tab);
}

.jp-TableRowsIcon {
  background-image: var(--jp-icon-table-rows);
}

.jp-TagIcon {
  background-image: var(--jp-icon-tag);
}

.jp-TerminalIcon {
  background-image: var(--jp-icon-terminal);
}

.jp-TextEditorIcon {
  background-image: var(--jp-icon-text-editor);
}

.jp-TocIcon {
  background-image: var(--jp-icon-toc);
}

.jp-TreeViewIcon {
  background-image: var(--jp-icon-tree-view);
}

.jp-TrustedIcon {
  background-image: var(--jp-icon-trusted);
}

.jp-UndoIcon {
  background-image: var(--jp-icon-undo);
}

.jp-UserIcon {
  background-image: var(--jp-icon-user);
}

.jp-UsersIcon {
  background-image: var(--jp-icon-users);
}

.jp-VegaIcon {
  background-image: var(--jp-icon-vega);
}

.jp-WordIcon {
  background-image: var(--jp-icon-word);
}

.jp-YamlIcon {
  background-image: var(--jp-icon-yaml);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * (DEPRECATED) Support for consuming icons as CSS background images
 */

.jp-Icon,
.jp-MaterialIcon {
  background-position: center;
  background-repeat: no-repeat;
  background-size: 16px;
  min-width: 16px;
  min-height: 16px;
}

.jp-Icon-cover {
  background-position: center;
  background-repeat: no-repeat;
  background-size: cover;
}

/**
 * (DEPRECATED) Support for specific CSS icon sizes
 */

.jp-Icon-16 {
  background-size: 16px;
  min-width: 16px;
  min-height: 16px;
}

.jp-Icon-18 {
  background-size: 18px;
  min-width: 18px;
  min-height: 18px;
}

.jp-Icon-20 {
  background-size: 20px;
  min-width: 20px;
  min-height: 20px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.lm-TabBar .lm-TabBar-addButton {
  align-items: center;
  display: flex;
  padding: 4px;
  padding-bottom: 5px;
  margin-right: 1px;
  background-color: var(--jp-layout-color2);
}

.lm-TabBar .lm-TabBar-addButton:hover {
  background-color: var(--jp-layout-color1);
}

.lm-DockPanel-tabBar .lm-TabBar-tab {
  width: var(--jp-private-horizontal-tab-width);
}

.lm-DockPanel-tabBar .lm-TabBar-content {
  flex: unset;
}

.lm-DockPanel-tabBar[data-orientation='horizontal'] {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * Support for icons as inline SVG HTMLElements
 */

/* recolor the primary elements of an icon */
.jp-icon0[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon1[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon2[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon3[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon4[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon0[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon1[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon2[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon3[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon4[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/* recolor the accent elements of an icon */
.jp-icon-accent0[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-accent1[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-accent2[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-accent3[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-accent4[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-accent0[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-accent1[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-accent2[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-accent3[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-accent4[stroke] {
  stroke: var(--jp-layout-color4);
}

/* set the color of an icon to transparent */
.jp-icon-none[fill] {
  fill: none;
}

.jp-icon-none[stroke] {
  stroke: none;
}

/* brand icon colors. Same for light and dark */
.jp-icon-brand0[fill] {
  fill: var(--jp-brand-color0);
}

.jp-icon-brand1[fill] {
  fill: var(--jp-brand-color1);
}

.jp-icon-brand2[fill] {
  fill: var(--jp-brand-color2);
}

.jp-icon-brand3[fill] {
  fill: var(--jp-brand-color3);
}

.jp-icon-brand4[fill] {
  fill: var(--jp-brand-color4);
}

.jp-icon-brand0[stroke] {
  stroke: var(--jp-brand-color0);
}

.jp-icon-brand1[stroke] {
  stroke: var(--jp-brand-color1);
}

.jp-icon-brand2[stroke] {
  stroke: var(--jp-brand-color2);
}

.jp-icon-brand3[stroke] {
  stroke: var(--jp-brand-color3);
}

.jp-icon-brand4[stroke] {
  stroke: var(--jp-brand-color4);
}

/* warn icon colors. Same for light and dark */
.jp-icon-warn0[fill] {
  fill: var(--jp-warn-color0);
}

.jp-icon-warn1[fill] {
  fill: var(--jp-warn-color1);
}

.jp-icon-warn2[fill] {
  fill: var(--jp-warn-color2);
}

.jp-icon-warn3[fill] {
  fill: var(--jp-warn-color3);
}

.jp-icon-warn0[stroke] {
  stroke: var(--jp-warn-color0);
}

.jp-icon-warn1[stroke] {
  stroke: var(--jp-warn-color1);
}

.jp-icon-warn2[stroke] {
  stroke: var(--jp-warn-color2);
}

.jp-icon-warn3[stroke] {
  stroke: var(--jp-warn-color3);
}

/* icon colors that contrast well with each other and most backgrounds */
.jp-icon-contrast0[fill] {
  fill: var(--jp-icon-contrast-color0);
}

.jp-icon-contrast1[fill] {
  fill: var(--jp-icon-contrast-color1);
}

.jp-icon-contrast2[fill] {
  fill: var(--jp-icon-contrast-color2);
}

.jp-icon-contrast3[fill] {
  fill: var(--jp-icon-contrast-color3);
}

.jp-icon-contrast0[stroke] {
  stroke: var(--jp-icon-contrast-color0);
}

.jp-icon-contrast1[stroke] {
  stroke: var(--jp-icon-contrast-color1);
}

.jp-icon-contrast2[stroke] {
  stroke: var(--jp-icon-contrast-color2);
}

.jp-icon-contrast3[stroke] {
  stroke: var(--jp-icon-contrast-color3);
}

.jp-icon-dot[fill] {
  fill: var(--jp-warn-color0);
}

.jp-jupyter-icon-color[fill] {
  fill: var(--jp-jupyter-icon-color, var(--jp-warn-color0));
}

.jp-notebook-icon-color[fill] {
  fill: var(--jp-notebook-icon-color, var(--jp-warn-color0));
}

.jp-json-icon-color[fill] {
  fill: var(--jp-json-icon-color, var(--jp-warn-color1));
}

.jp-console-icon-color[fill] {
  fill: var(--jp-console-icon-color, white);
}

.jp-console-icon-background-color[fill] {
  fill: var(--jp-console-icon-background-color, var(--jp-brand-color1));
}

.jp-terminal-icon-color[fill] {
  fill: var(--jp-terminal-icon-color, var(--jp-layout-color2));
}

.jp-terminal-icon-background-color[fill] {
  fill: var(
    --jp-terminal-icon-background-color,
    var(--jp-inverse-layout-color2)
  );
}

.jp-text-editor-icon-color[fill] {
  fill: var(--jp-text-editor-icon-color, var(--jp-inverse-layout-color3));
}

.jp-inspector-icon-color[fill] {
  fill: var(--jp-inspector-icon-color, var(--jp-inverse-layout-color3));
}

/* CSS for icons in selected filebrowser listing items */
.jp-DirListing-item.jp-mod-selected .jp-icon-selectable[fill] {
  fill: #fff;
}

.jp-DirListing-item.jp-mod-selected .jp-icon-selectable-inverse[fill] {
  fill: var(--jp-brand-color1);
}

/* stylelint-disable selector-max-class, selector-max-compound-selectors */

/**
*
*  of the close icon
* CSS for complex behavior of close icon of tabs in the main area tabbar
*/
.lm-DockPanel-tabBar
  .lm-TabBar-tab.lm-mod-closable.jp-mod-dirty
  > .lm-TabBar-tabCloseIcon
  > :not(:hover)
  > .jp-icon3[fill] {
  fill: none;
}

.lm-DockPanel-tabBar
  .lm-TabBar-tab.lm-mod-closable.jp-mod-dirty
  > .lm-TabBar-tabCloseIcon
  > :not(:hover)
  > .jp-icon-busy[fill] {
  fill: var(--jp-inverse-layout-color3);
}

/* stylelint-enable selector-max-class, selector-max-compound-selectors */

/* CSS for icons in status bar */
#jp-main-statusbar .jp-mod-selected .jp-icon-selectable[fill] {
  fill: #fff;
}

#jp-main-statusbar .jp-mod-selected .jp-icon-selectable-inverse[fill] {
  fill: var(--jp-brand-color1);
}

/* special handling for splash icon CSS. While the theme CSS reloads during
   splash, the splash icon can loose theming. To prevent that, we set a
   default for its color variable */
:root {
  --jp-warn-color0: var(--md-orange-700);
}

/* not sure what to do with this one, used in filebrowser listing */
.jp-DragIcon {
  margin-right: 4px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/**
 * Support for alt colors for icons as inline SVG HTMLElements
 */

/* alt recolor the primary elements of an icon */
.jp-icon-alt .jp-icon0[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-alt .jp-icon1[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-alt .jp-icon2[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-alt .jp-icon3[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-alt .jp-icon4[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-alt .jp-icon0[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-alt .jp-icon1[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-alt .jp-icon2[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-alt .jp-icon3[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-alt .jp-icon4[stroke] {
  stroke: var(--jp-layout-color4);
}

/* alt recolor the accent elements of an icon */
.jp-icon-alt .jp-icon-accent0[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-alt .jp-icon-accent1[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-alt .jp-icon-accent2[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-alt .jp-icon-accent3[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-alt .jp-icon-accent4[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-alt .jp-icon-accent0[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-alt .jp-icon-accent1[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-alt .jp-icon-accent2[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-alt .jp-icon-accent3[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-alt .jp-icon-accent4[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-icon-hoverShow:not(:hover) .jp-icon-hoverShow-content {
  display: none !important;
}

/**
 * Support for hover colors for icons as inline SVG HTMLElements
 */

/**
 * regular colors
 */

/* recolor the primary elements of an icon */
.jp-icon-hover :hover .jp-icon0-hover[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-hover :hover .jp-icon1-hover[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-hover :hover .jp-icon2-hover[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-hover :hover .jp-icon3-hover[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-hover :hover .jp-icon4-hover[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-hover :hover .jp-icon0-hover[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-hover :hover .jp-icon1-hover[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-hover :hover .jp-icon2-hover[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-hover :hover .jp-icon3-hover[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-hover :hover .jp-icon4-hover[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/* recolor the accent elements of an icon */
.jp-icon-hover :hover .jp-icon-accent0-hover[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-hover :hover .jp-icon-accent1-hover[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-hover :hover .jp-icon-accent2-hover[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-hover :hover .jp-icon-accent3-hover[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-hover :hover .jp-icon-accent4-hover[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-hover :hover .jp-icon-accent0-hover[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-hover :hover .jp-icon-accent1-hover[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-hover :hover .jp-icon-accent2-hover[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-hover :hover .jp-icon-accent3-hover[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-hover :hover .jp-icon-accent4-hover[stroke] {
  stroke: var(--jp-layout-color4);
}

/* set the color of an icon to transparent */
.jp-icon-hover :hover .jp-icon-none-hover[fill] {
  fill: none;
}

.jp-icon-hover :hover .jp-icon-none-hover[stroke] {
  stroke: none;
}

/**
 * inverse colors
 */

/* inverse recolor the primary elements of an icon */
.jp-icon-hover.jp-icon-alt :hover .jp-icon0-hover[fill] {
  fill: var(--jp-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon1-hover[fill] {
  fill: var(--jp-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon2-hover[fill] {
  fill: var(--jp-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon3-hover[fill] {
  fill: var(--jp-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon4-hover[fill] {
  fill: var(--jp-layout-color4);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon0-hover[stroke] {
  stroke: var(--jp-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon1-hover[stroke] {
  stroke: var(--jp-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon2-hover[stroke] {
  stroke: var(--jp-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon3-hover[stroke] {
  stroke: var(--jp-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon4-hover[stroke] {
  stroke: var(--jp-layout-color4);
}

/* inverse recolor the accent elements of an icon */
.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent0-hover[fill] {
  fill: var(--jp-inverse-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent1-hover[fill] {
  fill: var(--jp-inverse-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent2-hover[fill] {
  fill: var(--jp-inverse-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent3-hover[fill] {
  fill: var(--jp-inverse-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent4-hover[fill] {
  fill: var(--jp-inverse-layout-color4);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent0-hover[stroke] {
  stroke: var(--jp-inverse-layout-color0);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent1-hover[stroke] {
  stroke: var(--jp-inverse-layout-color1);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent2-hover[stroke] {
  stroke: var(--jp-inverse-layout-color2);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent3-hover[stroke] {
  stroke: var(--jp-inverse-layout-color3);
}

.jp-icon-hover.jp-icon-alt :hover .jp-icon-accent4-hover[stroke] {
  stroke: var(--jp-inverse-layout-color4);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-IFrame {
  width: 100%;
  height: 100%;
}

.jp-IFrame > iframe {
  border: none;
}

/*
When drag events occur, `lm-mod-override-cursor` is added to the body.
Because iframes steal all cursor events, the following two rules are necessary
to suppress pointer events while resize drags are occurring. There may be a
better solution to this problem.
*/
body.lm-mod-override-cursor .jp-IFrame {
  position: relative;
}

body.lm-mod-override-cursor .jp-IFrame::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-HoverBox {
  position: fixed;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-FormGroup-content fieldset {
  border: none;
  padding: 0;
  min-width: 0;
  width: 100%;
}

/* stylelint-disable selector-max-type */

.jp-FormGroup-content fieldset .jp-inputFieldWrapper input,
.jp-FormGroup-content fieldset .jp-inputFieldWrapper select,
.jp-FormGroup-content fieldset .jp-inputFieldWrapper textarea {
  font-size: var(--jp-content-font-size2);
  border-color: var(--jp-input-border-color);
  border-style: solid;
  border-radius: var(--jp-border-radius);
  border-width: 1px;
  padding: 6px 8px;
  background: none;
  color: var(--jp-ui-font-color0);
  height: inherit;
}

.jp-FormGroup-content fieldset input[type='checkbox'] {
  position: relative;
  top: 2px;
  margin-left: 0;
}

.jp-FormGroup-content button.jp-mod-styled {
  cursor: pointer;
}

.jp-FormGroup-content .checkbox label {
  cursor: pointer;
  font-size: var(--jp-content-font-size1);
}

.jp-FormGroup-content .jp-root > fieldset > legend {
  display: none;
}

.jp-FormGroup-content .jp-root > fieldset > p {
  display: none;
}

/** copy of `input.jp-mod-styled:focus` style */
.jp-FormGroup-content fieldset input:focus,
.jp-FormGroup-content fieldset select:focus {
  -moz-outline-radius: unset;
  outline: var(--jp-border-width) solid var(--md-blue-500);
  outline-offset: -1px;
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-FormGroup-content fieldset input:hover:not(:focus),
.jp-FormGroup-content fieldset select:hover:not(:focus) {
  background-color: var(--jp-border-color2);
}

/* stylelint-enable selector-max-type */

.jp-FormGroup-content .checkbox .field-description {
  /* Disable default description field for checkbox:
   because other widgets do not have description fields,
   we add descriptions to each widget on the field level.
  */
  display: none;
}

.jp-FormGroup-content #root__description {
  display: none;
}

.jp-FormGroup-content .jp-modifiedIndicator {
  width: 5px;
  background-color: var(--jp-brand-color2);
  margin-top: 0;
  margin-left: calc(var(--jp-private-settingeditor-modifier-indent) * -1);
  flex-shrink: 0;
}

.jp-FormGroup-content .jp-modifiedIndicator.jp-errorIndicator {
  background-color: var(--jp-error-color0);
  margin-right: 0.5em;
}

/* RJSF ARRAY style */

.jp-arrayFieldWrapper legend {
  font-size: var(--jp-content-font-size2);
  color: var(--jp-ui-font-color0);
  flex-basis: 100%;
  padding: 4px 0;
  font-weight: var(--jp-content-heading-font-weight);
  border-bottom: 1px solid var(--jp-border-color2);
}

.jp-arrayFieldWrapper .field-description {
  padding: 4px 0;
  white-space: pre-wrap;
}

.jp-arrayFieldWrapper .array-item {
  width: 100%;
  border: 1px solid var(--jp-border-color2);
  border-radius: 4px;
  margin: 4px;
}

.jp-ArrayOperations {
  display: flex;
  margin-left: 8px;
}

.jp-ArrayOperationsButton {
  margin: 2px;
}

.jp-ArrayOperationsButton .jp-icon3[fill] {
  fill: var(--jp-ui-font-color0);
}

button.jp-ArrayOperationsButton.jp-mod-styled:disabled {
  cursor: not-allowed;
  opacity: 0.5;
}

/* RJSF form validation error */

.jp-FormGroup-content .validationErrors {
  color: var(--jp-error-color0);
}

/* Hide panel level error as duplicated the field level error */
.jp-FormGroup-content .panel.errors {
  display: none;
}

/* RJSF normal content (settings-editor) */

.jp-FormGroup-contentNormal {
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.jp-FormGroup-contentNormal .jp-FormGroup-contentItem {
  margin-left: 7px;
  color: var(--jp-ui-font-color0);
}

.jp-FormGroup-contentNormal .jp-FormGroup-description {
  flex-basis: 100%;
  padding: 4px 7px;
}

.jp-FormGroup-contentNormal .jp-FormGroup-default {
  flex-basis: 100%;
  padding: 4px 7px;
}

.jp-FormGroup-contentNormal .jp-FormGroup-fieldLabel {
  font-size: var(--jp-content-font-size1);
  font-weight: normal;
  min-width: 120px;
}

.jp-FormGroup-contentNormal fieldset:not(:first-child) {
  margin-left: 7px;
}

.jp-FormGroup-contentNormal .field-array-of-string .array-item {
  /* Display `jp-ArrayOperations` buttons side-by-side with content except
    for small screens where flex-wrap will place them one below the other.
  */
  display: flex;
  align-items: center;
  flex-wrap: wrap;
}

.jp-FormGroup-contentNormal .jp-objectFieldWrapper .form-group {
  padding: 2px 8px 2px var(--jp-private-settingeditor-modifier-indent);
  margin-top: 2px;
}

/* RJSF compact content (metadata-form) */

.jp-FormGroup-content.jp-FormGroup-contentCompact {
  width: 100%;
}

.jp-FormGroup-contentCompact .form-group {
  display: flex;
  padding: 0.5em 0.2em 0.5em 0;
}

.jp-FormGroup-contentCompact
  .jp-FormGroup-compactTitle
  .jp-FormGroup-description {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color2);
}

.jp-FormGroup-contentCompact .jp-FormGroup-fieldLabel {
  padding-bottom: 0.3em;
}

.jp-FormGroup-contentCompact .jp-inputFieldWrapper .form-control {
  width: 100%;
  box-sizing: border-box;
}

.jp-FormGroup-contentCompact .jp-arrayFieldWrapper .jp-FormGroup-compactTitle {
  padding-bottom: 7px;
}

.jp-FormGroup-contentCompact
  .jp-objectFieldWrapper
  .jp-objectFieldWrapper
  .form-group {
  padding: 2px 8px 2px var(--jp-private-settingeditor-modifier-indent);
  margin-top: 2px;
}

.jp-FormGroup-contentCompact ul.error-detail {
  margin-block-start: 0.5em;
  margin-block-end: 0.5em;
  padding-inline-start: 1em;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-SidePanel {
  display: flex;
  flex-direction: column;
  min-width: var(--jp-sidebar-min-width);
  overflow-y: auto;
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);
  font-size: var(--jp-ui-font-size1);
}

.jp-SidePanel-header {
  flex: 0 0 auto;
  display: flex;
  border-bottom: var(--jp-border-width) solid var(--jp-border-color2);
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  letter-spacing: 1px;
  margin: 0;
  padding: 2px;
  text-transform: uppercase;
}

.jp-SidePanel-toolbar {
  flex: 0 0 auto;
}

.jp-SidePanel-content {
  flex: 1 1 auto;
}

.jp-SidePanel-toolbar,
.jp-AccordionPanel-toolbar {
  height: var(--jp-private-toolbar-height);
}

.jp-SidePanel-toolbar.jp-Toolbar-micro {
  display: none;
}

.lm-AccordionPanel .jp-AccordionPanel-title {
  box-sizing: border-box;
  line-height: 25px;
  margin: 0;
  display: flex;
  align-items: center;
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  font-size: var(--jp-ui-font-size0);
}

.jp-AccordionPanel-title {
  cursor: pointer;
  user-select: none;
  -moz-user-select: none;
  -webkit-user-select: none;
  text-transform: uppercase;
}

.lm-AccordionPanel[data-orientation='horizontal'] > .jp-AccordionPanel-title {
  /* Title is rotated for horizontal accordion panel using CSS */
  display: block;
  transform-origin: top left;
  transform: rotate(-90deg) translate(-100%);
}

.jp-AccordionPanel-title .lm-AccordionPanel-titleLabel {
  user-select: none;
  text-overflow: ellipsis;
  white-space: nowrap;
  overflow: hidden;
}

.jp-AccordionPanel-title .lm-AccordionPanel-titleCollapser {
  transform: rotate(-90deg);
  margin: auto 0;
  height: 16px;
}

.jp-AccordionPanel-title.lm-mod-expanded .lm-AccordionPanel-titleCollapser {
  transform: rotate(0deg);
}

.lm-AccordionPanel .jp-AccordionPanel-toolbar {
  background: none;
  box-shadow: none;
  border: none;
  margin-left: auto;
}

.lm-AccordionPanel .lm-SplitPanel-handle:hover {
  background: var(--jp-layout-color3);
}

.jp-text-truncated {
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Spinner {
  position: absolute;
  display: flex;
  justify-content: center;
  align-items: center;
  z-index: 10;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background: var(--jp-layout-color0);
  outline: none;
}

.jp-SpinnerContent {
  font-size: 10px;
  margin: 50px auto;
  text-indent: -9999em;
  width: 3em;
  height: 3em;
  border-radius: 50%;
  background: var(--jp-brand-color3);
  background: linear-gradient(
    to right,
    #f37626 10%,
    rgba(255, 255, 255, 0) 42%
  );
  position: relative;
  animation: load3 1s infinite linear, fadeIn 1s;
}

.jp-SpinnerContent::before {
  width: 50%;
  height: 50%;
  background: #f37626;
  border-radius: 100% 0 0;
  position: absolute;
  top: 0;
  left: 0;
  content: '';
}

.jp-SpinnerContent::after {
  background: var(--jp-layout-color0);
  width: 75%;
  height: 75%;
  border-radius: 50%;
  content: '';
  margin: auto;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0;
  right: 0;
}

@keyframes fadeIn {
  0% {
    opacity: 0;
  }

  100% {
    opacity: 1;
  }
}

@keyframes load3 {
  0% {
    transform: rotate(0deg);
  }

  100% {
    transform: rotate(360deg);
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

button.jp-mod-styled {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  border: none;
  box-sizing: border-box;
  text-align: center;
  line-height: 32px;
  height: 32px;
  padding: 0 12px;
  letter-spacing: 0.8px;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

input.jp-mod-styled {
  background: var(--jp-input-background);
  height: 28px;
  box-sizing: border-box;
  border: var(--jp-border-width) solid var(--jp-border-color1);
  padding-left: 7px;
  padding-right: 7px;
  font-size: var(--jp-ui-font-size2);
  color: var(--jp-ui-font-color0);
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

input[type='checkbox'].jp-mod-styled {
  appearance: checkbox;
  -webkit-appearance: checkbox;
  -moz-appearance: checkbox;
  height: auto;
}

input.jp-mod-styled:focus {
  border: var(--jp-border-width) solid var(--md-blue-500);
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-select-wrapper {
  display: flex;
  position: relative;
  flex-direction: column;
  padding: 1px;
  background-color: var(--jp-layout-color1);
  box-sizing: border-box;
  margin-bottom: 12px;
}

.jp-select-wrapper:not(.multiple) {
  height: 28px;
}

.jp-select-wrapper.jp-mod-focused select.jp-mod-styled {
  border: var(--jp-border-width) solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
  background-color: var(--jp-input-active-background);
}

select.jp-mod-styled:hover {
  cursor: pointer;
  color: var(--jp-ui-font-color0);
  background-color: var(--jp-input-hover-background);
  box-shadow: inset 0 0 1px rgba(0, 0, 0, 0.5);
}

select.jp-mod-styled {
  flex: 1 1 auto;
  width: 100%;
  font-size: var(--jp-ui-font-size2);
  background: var(--jp-input-background);
  color: var(--jp-ui-font-color0);
  padding: 0 25px 0 8px;
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  border-radius: 0;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
}

select.jp-mod-styled:not([multiple]) {
  height: 32px;
}

select.jp-mod-styled[multiple] {
  max-height: 200px;
  overflow-y: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-switch {
  display: flex;
  align-items: center;
  padding-left: 4px;
  padding-right: 4px;
  font-size: var(--jp-ui-font-size1);
  background-color: transparent;
  color: var(--jp-ui-font-color1);
  border: none;
  height: 20px;
}

.jp-switch:hover {
  background-color: var(--jp-layout-color2);
}

.jp-switch-label {
  margin-right: 5px;
  font-family: var(--jp-ui-font-family);
}

.jp-switch-track {
  cursor: pointer;
  background-color: var(--jp-switch-color, var(--jp-border-color1));
  -webkit-transition: 0.4s;
  transition: 0.4s;
  border-radius: 34px;
  height: 16px;
  width: 35px;
  position: relative;
}

.jp-switch-track::before {
  content: '';
  position: absolute;
  height: 10px;
  width: 10px;
  margin: 3px;
  left: 0;
  background-color: var(--jp-ui-inverse-font-color1);
  -webkit-transition: 0.4s;
  transition: 0.4s;
  border-radius: 50%;
}

.jp-switch[aria-checked='true'] .jp-switch-track {
  background-color: var(--jp-switch-true-position-color, var(--jp-warn-color0));
}

.jp-switch[aria-checked='true'] .jp-switch-track::before {
  /* track width (35) - margins (3 + 3) - thumb width (10) */
  left: 19px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

:root {
  --jp-private-toolbar-height: calc(
    28px + var(--jp-border-width)
  ); /* leave 28px for content */
}

.jp-Toolbar {
  color: var(--jp-ui-font-color1);
  flex: 0 0 auto;
  display: flex;
  flex-direction: row;
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  background: var(--jp-toolbar-background);
  min-height: var(--jp-toolbar-micro-height);
  padding: 2px;
  z-index: 8;
  overflow-x: hidden;
}

/* Toolbar items */

.jp-Toolbar > .jp-Toolbar-item.jp-Toolbar-spacer {
  flex-grow: 1;
  flex-shrink: 1;
}

.jp-Toolbar-item.jp-Toolbar-kernelStatus {
  display: inline-block;
  width: 32px;
  background-repeat: no-repeat;
  background-position: center;
  background-size: 16px;
}

.jp-Toolbar > .jp-Toolbar-item {
  flex: 0 0 auto;
  display: flex;
  padding-left: 1px;
  padding-right: 1px;
  font-size: var(--jp-ui-font-size1);
  line-height: var(--jp-private-toolbar-height);
  height: 100%;
}

/* Toolbar buttons */

/* This is the div we use to wrap the react component into a Widget */
div.jp-ToolbarButton {
  color: transparent;
  border: none;
  box-sizing: border-box;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 0;
  margin: 0;
}

button.jp-ToolbarButtonComponent {
  background: var(--jp-layout-color1);
  border: none;
  box-sizing: border-box;
  outline: none;
  appearance: none;
  -webkit-appearance: none;
  -moz-appearance: none;
  padding: 0 6px;
  margin: 0;
  height: 24px;
  border-radius: var(--jp-border-radius);
  display: flex;
  align-items: center;
  text-align: center;
  font-size: 14px;
  min-width: unset;
  min-height: unset;
}

button.jp-ToolbarButtonComponent:disabled {
  opacity: 0.4;
}

button.jp-ToolbarButtonComponent > span {
  padding: 0;
  flex: 0 0 auto;
}

button.jp-ToolbarButtonComponent .jp-ToolbarButtonComponent-label {
  font-size: var(--jp-ui-font-size1);
  line-height: 100%;
  padding-left: 2px;
  color: var(--jp-ui-font-color1);
  font-family: var(--jp-ui-font-family);
}

#jp-main-dock-panel[data-mode='single-document']
  .jp-MainAreaWidget
  > .jp-Toolbar.jp-Toolbar-micro {
  padding: 0;
  min-height: 0;
}

#jp-main-dock-panel[data-mode='single-document']
  .jp-MainAreaWidget
  > .jp-Toolbar {
  border: none;
  box-shadow: none;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-WindowedPanel-outer {
  position: relative;
  overflow-y: auto;
}

.jp-WindowedPanel-inner {
  position: relative;
}

.jp-WindowedPanel-window {
  position: absolute;
  left: 0;
  right: 0;
  overflow: visible;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/* Sibling imports */

body {
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
}

/* Disable native link decoration styles everywhere outside of dialog boxes */
a {
  text-decoration: unset;
  color: unset;
}

a:hover {
  text-decoration: unset;
  color: unset;
}

/* Accessibility for links inside dialog box text */
.jp-Dialog-content a {
  text-decoration: revert;
  color: var(--jp-content-link-color);
}

.jp-Dialog-content a:hover {
  text-decoration: revert;
}

/* Styles for ui-components */
.jp-Button {
  color: var(--jp-ui-font-color2);
  border-radius: var(--jp-border-radius);
  padding: 0 12px;
  font-size: var(--jp-ui-font-size1);

  /* Copy from blueprint 3 */
  display: inline-flex;
  flex-direction: row;
  border: none;
  cursor: pointer;
  align-items: center;
  justify-content: center;
  text-align: left;
  vertical-align: middle;
  min-height: 30px;
  min-width: 30px;
}

.jp-Button:disabled {
  cursor: not-allowed;
}

.jp-Button:empty {
  padding: 0 !important;
}

.jp-Button.jp-mod-small {
  min-height: 24px;
  min-width: 24px;
  font-size: 12px;
  padding: 0 7px;
}

/* Use our own theme for hover styles */
.jp-Button.jp-mod-minimal:hover {
  background-color: var(--jp-layout-color2);
}

.jp-Button.jp-mod-minimal {
  background: none;
}

.jp-InputGroup {
  display: block;
  position: relative;
}

.jp-InputGroup input {
  box-sizing: border-box;
  border: none;
  border-radius: 0;
  background-color: transparent;
  color: var(--jp-ui-font-color0);
  box-shadow: inset 0 0 0 var(--jp-border-width) var(--jp-input-border-color);
  padding-bottom: 0;
  padding-top: 0;
  padding-left: 10px;
  padding-right: 28px;
  position: relative;
  width: 100%;
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  font-size: 14px;
  font-weight: 400;
  height: 30px;
  line-height: 30px;
  outline: none;
  vertical-align: middle;
}

.jp-InputGroup input:focus {
  box-shadow: inset 0 0 0 var(--jp-border-width)
      var(--jp-input-active-box-shadow-color),
    inset 0 0 0 3px var(--jp-input-active-box-shadow-color);
}

.jp-InputGroup input:disabled {
  cursor: not-allowed;
  resize: block;
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color2);
}

.jp-InputGroup input:disabled ~ span {
  cursor: not-allowed;
  color: var(--jp-ui-font-color2);
}

.jp-InputGroup input::placeholder,
input::placeholder {
  color: var(--jp-ui-font-color2);
}

.jp-InputGroupAction {
  position: absolute;
  bottom: 1px;
  right: 0;
  padding: 6px;
}

.jp-HTMLSelect.jp-DefaultStyle select {
  background-color: initial;
  border: none;
  border-radius: 0;
  box-shadow: none;
  color: var(--jp-ui-font-color0);
  display: block;
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  height: 24px;
  line-height: 14px;
  padding: 0 25px 0 10px;
  text-align: left;
  -moz-appearance: none;
  -webkit-appearance: none;
}

.jp-HTMLSelect.jp-DefaultStyle select:disabled {
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color2);
  cursor: not-allowed;
  resize: block;
}

.jp-HTMLSelect.jp-DefaultStyle select:disabled ~ span {
  cursor: not-allowed;
}

/* Use our own theme for hover and option styles */
/* stylelint-disable-next-line selector-max-type */
.jp-HTMLSelect.jp-DefaultStyle select:hover,
.jp-HTMLSelect.jp-DefaultStyle select > option {
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color0);
}

select {
  box-sizing: border-box;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-StatusBar-Widget {
  display: flex;
  align-items: center;
  background: var(--jp-layout-color2);
  min-height: var(--jp-statusbar-height);
  justify-content: space-between;
  padding: 0 10px;
}

.jp-StatusBar-Left {
  display: flex;
  align-items: center;
  flex-direction: row;
}

.jp-StatusBar-Middle {
  display: flex;
  align-items: center;
}

.jp-StatusBar-Right {
  display: flex;
  align-items: center;
  flex-direction: row-reverse;
}

.jp-StatusBar-Item {
  max-height: var(--jp-statusbar-height);
  margin: 0 2px;
  height: var(--jp-statusbar-height);
  white-space: nowrap;
  text-overflow: ellipsis;
  color: var(--jp-ui-font-color1);
  padding: 0 6px;
}

.jp-mod-highlighted:hover {
  background-color: var(--jp-layout-color3);
}

.jp-mod-clicked {
  background-color: var(--jp-brand-color1);
}

.jp-mod-clicked:hover {
  background-color: var(--jp-brand-color0);
}

.jp-mod-clicked .jp-StatusBar-TextItem {
  color: var(--jp-ui-inverse-font-color1);
}

.jp-StatusBar-HoverItem {
  box-shadow: '0px 4px 4px rgba(0, 0, 0, 0.25)';
}

.jp-StatusBar-TextItem {
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  line-height: 24px;
  color: var(--jp-ui-font-color1);
}

.jp-StatusBar-GroupItem {
  display: flex;
  align-items: center;
  flex-direction: row;
}

.jp-Statusbar-ProgressCircle svg {
  display: block;
  margin: 0 auto;
  width: 16px;
  height: 24px;
  align-self: normal;
}

.jp-Statusbar-ProgressCircle path {
  fill: var(--jp-inverse-layout-color3);
}

.jp-Statusbar-ProgressBar-progress-bar {
  height: 10px;
  width: 100px;
  border: solid 0.25px var(--jp-brand-color2);
  border-radius: 3px;
  overflow: hidden;
  align-self: center;
}

.jp-Statusbar-ProgressBar-progress-bar > div {
  background-color: var(--jp-brand-color2);
  background-image: linear-gradient(
    -45deg,
    rgba(255, 255, 255, 0.2) 25%,
    transparent 25%,
    transparent 50%,
    rgba(255, 255, 255, 0.2) 50%,
    rgba(255, 255, 255, 0.2) 75%,
    transparent 75%,
    transparent
  );
  background-size: 40px 40px;
  float: left;
  width: 0%;
  height: 100%;
  font-size: 12px;
  line-height: 14px;
  color: #fff;
  text-align: center;
  animation: jp-Statusbar-ExecutionTime-progress-bar 2s linear infinite;
}

.jp-Statusbar-ProgressBar-progress-bar p {
  color: var(--jp-ui-font-color1);
  font-family: var(--jp-ui-font-family);
  font-size: var(--jp-ui-font-size1);
  line-height: 10px;
  width: 100px;
}

@keyframes jp-Statusbar-ExecutionTime-progress-bar {
  0% {
    background-position: 0 0;
  }

  100% {
    background-position: 40px 40px;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-commandpalette-search-height: 28px;
}

/*-----------------------------------------------------------------------------
| Overall styles
|----------------------------------------------------------------------------*/

.lm-CommandPalette {
  padding-bottom: 0;
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);

  /* This is needed so that all font sizing of children done in ems is
   * relative to this base size */
  font-size: var(--jp-ui-font-size1);
}

/*-----------------------------------------------------------------------------
| Modal variant
|----------------------------------------------------------------------------*/

.jp-ModalCommandPalette {
  position: absolute;
  z-index: 10000;
  top: 38px;
  left: 30%;
  margin: 0;
  padding: 4px;
  width: 40%;
  box-shadow: var(--jp-elevation-z4);
  border-radius: 4px;
  background: var(--jp-layout-color0);
}

.jp-ModalCommandPalette .lm-CommandPalette {
  max-height: 40vh;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-close-icon::after {
  display: none;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-CommandPalette-header {
  display: none;
}

.jp-ModalCommandPalette .lm-CommandPalette .lm-CommandPalette-item {
  margin-left: 4px;
  margin-right: 4px;
}

.jp-ModalCommandPalette
  .lm-CommandPalette
  .lm-CommandPalette-item.lm-mod-disabled {
  display: none;
}

/*-----------------------------------------------------------------------------
| Search
|----------------------------------------------------------------------------*/

.lm-CommandPalette-search {
  padding: 4px;
  background-color: var(--jp-layout-color1);
  z-index: 2;
}

.lm-CommandPalette-wrapper {
  overflow: overlay;
  padding: 0 9px;
  background-color: var(--jp-input-active-background);
  height: 30px;
  box-shadow: inset 0 0 0 var(--jp-border-width) var(--jp-input-border-color);
}

.lm-CommandPalette.lm-mod-focused .lm-CommandPalette-wrapper {
  box-shadow: inset 0 0 0 1px var(--jp-input-active-box-shadow-color),
    inset 0 0 0 3px var(--jp-input-active-box-shadow-color);
}

.jp-SearchIconGroup {
  color: white;
  background-color: var(--jp-brand-color1);
  position: absolute;
  top: 4px;
  right: 4px;
  padding: 5px 5px 1px;
}

.jp-SearchIconGroup svg {
  height: 20px;
  width: 20px;
}

.jp-SearchIconGroup .jp-icon3[fill] {
  fill: var(--jp-layout-color0);
}

.lm-CommandPalette-input {
  background: transparent;
  width: calc(100% - 18px);
  float: left;
  border: none;
  outline: none;
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  line-height: var(--jp-private-commandpalette-search-height);
}

.lm-CommandPalette-input::-webkit-input-placeholder,
.lm-CommandPalette-input::-moz-placeholder,
.lm-CommandPalette-input:-ms-input-placeholder {
  color: var(--jp-ui-font-color2);
  font-size: var(--jp-ui-font-size1);
}

/*-----------------------------------------------------------------------------
| Results
|----------------------------------------------------------------------------*/

.lm-CommandPalette-header:first-child {
  margin-top: 0;
}

.lm-CommandPalette-header {
  border-bottom: solid var(--jp-border-width) var(--jp-border-color2);
  color: var(--jp-ui-font-color1);
  cursor: pointer;
  display: flex;
  font-size: var(--jp-ui-font-size0);
  font-weight: 600;
  letter-spacing: 1px;
  margin-top: 8px;
  padding: 8px 0 8px 12px;
  text-transform: uppercase;
}

.lm-CommandPalette-header.lm-mod-active {
  background: var(--jp-layout-color2);
}

.lm-CommandPalette-header > mark {
  background-color: transparent;
  font-weight: bold;
  color: var(--jp-ui-font-color1);
}

.lm-CommandPalette-item {
  padding: 4px 12px 4px 4px;
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  font-weight: 400;
  display: flex;
}

.lm-CommandPalette-item.lm-mod-disabled {
  color: var(--jp-ui-font-color2);
}

.lm-CommandPalette-item.lm-mod-active {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.lm-CommandPalette-item.lm-mod-active .lm-CommandPalette-itemLabel > mark {
  color: var(--jp-ui-inverse-font-color0);
}

.lm-CommandPalette-item.lm-mod-active .jp-icon-selectable[fill] {
  fill: var(--jp-layout-color0);
}

.lm-CommandPalette-item.lm-mod-active:hover:not(.lm-mod-disabled) {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.lm-CommandPalette-item:hover:not(.lm-mod-active):not(.lm-mod-disabled) {
  background: var(--jp-layout-color2);
}

.lm-CommandPalette-itemContent {
  overflow: hidden;
}

.lm-CommandPalette-itemLabel > mark {
  color: var(--jp-ui-font-color0);
  background-color: transparent;
  font-weight: bold;
}

.lm-CommandPalette-item.lm-mod-disabled mark {
  color: var(--jp-ui-font-color2);
}

.lm-CommandPalette-item .lm-CommandPalette-itemIcon {
  margin: 0 4px 0 0;
  position: relative;
  width: 16px;
  top: 2px;
  flex: 0 0 auto;
}

.lm-CommandPalette-item.lm-mod-disabled .lm-CommandPalette-itemIcon {
  opacity: 0.6;
}

.lm-CommandPalette-item .lm-CommandPalette-itemShortcut {
  flex: 0 0 auto;
}

.lm-CommandPalette-itemCaption {
  display: none;
}

.lm-CommandPalette-content {
  background-color: var(--jp-layout-color1);
}

.lm-CommandPalette-content:empty::after {
  content: 'No results';
  margin: auto;
  margin-top: 20px;
  width: 100px;
  display: block;
  font-size: var(--jp-ui-font-size2);
  font-family: var(--jp-ui-font-family);
  font-weight: lighter;
}

.lm-CommandPalette-emptyMessage {
  text-align: center;
  margin-top: 24px;
  line-height: 1.32;
  padding: 0 8px;
  color: var(--jp-content-font-color3);
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Dialog {
  position: absolute;
  z-index: 10000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  top: 0;
  left: 0;
  margin: 0;
  padding: 0;
  width: 100%;
  height: 100%;
  background: var(--jp-dialog-background);
}

.jp-Dialog-content {
  display: flex;
  flex-direction: column;
  margin-left: auto;
  margin-right: auto;
  background: var(--jp-layout-color1);
  padding: 24px 24px 12px;
  min-width: 300px;
  min-height: 150px;
  max-width: 1000px;
  max-height: 500px;
  box-sizing: border-box;
  box-shadow: var(--jp-elevation-z20);
  word-wrap: break-word;
  border-radius: var(--jp-border-radius);

  /* This is needed so that all font sizing of children done in ems is
   * relative to this base size */
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color1);
  resize: both;
}

.jp-Dialog-content.jp-Dialog-content-small {
  max-width: 500px;
}

.jp-Dialog-button {
  overflow: visible;
}

button.jp-Dialog-button:focus {
  outline: 1px solid var(--jp-brand-color1);
  outline-offset: 4px;
  -moz-outline-radius: 0;
}

button.jp-Dialog-button:focus::-moz-focus-inner {
  border: 0;
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-accept:focus,
button.jp-Dialog-button.jp-mod-styled.jp-mod-warn:focus,
button.jp-Dialog-button.jp-mod-styled.jp-mod-reject:focus {
  outline-offset: 4px;
  -moz-outline-radius: 0;
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-accept:focus {
  outline: 1px solid var(--jp-accept-color-normal, var(--jp-brand-color1));
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-warn:focus {
  outline: 1px solid var(--jp-warn-color-normal, var(--jp-error-color1));
}

button.jp-Dialog-button.jp-mod-styled.jp-mod-reject:focus {
  outline: 1px solid var(--jp-reject-color-normal, var(--md-grey-600));
}

button.jp-Dialog-close-button {
  padding: 0;
  height: 100%;
  min-width: unset;
  min-height: unset;
}

.jp-Dialog-header {
  display: flex;
  justify-content: space-between;
  flex: 0 0 auto;
  padding-bottom: 12px;
  font-size: var(--jp-ui-font-size3);
  font-weight: 400;
  color: var(--jp-ui-font-color1);
}

.jp-Dialog-body {
  display: flex;
  flex-direction: column;
  flex: 1 1 auto;
  font-size: var(--jp-ui-font-size1);
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  overflow: auto;
}

.jp-Dialog-footer {
  display: flex;
  flex-direction: row;
  justify-content: flex-end;
  align-items: center;
  flex: 0 0 auto;
  margin-left: -12px;
  margin-right: -12px;
  padding: 12px;
}

.jp-Dialog-checkbox {
  padding-right: 5px;
}

.jp-Dialog-checkbox > input:focus-visible {
  outline: 1px solid var(--jp-input-active-border-color);
  outline-offset: 1px;
}

.jp-Dialog-spacer {
  flex: 1 1 auto;
}

.jp-Dialog-title {
  overflow: hidden;
  white-space: nowrap;
  text-overflow: ellipsis;
}

.jp-Dialog-body > .jp-select-wrapper {
  width: 100%;
}

.jp-Dialog-body > button {
  padding: 0 16px;
}

.jp-Dialog-body > label {
  line-height: 1.4;
  color: var(--jp-ui-font-color0);
}

.jp-Dialog-button.jp-mod-styled:not(:last-child) {
  margin-right: 12px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-Input-Boolean-Dialog {
  flex-direction: row-reverse;
  align-items: end;
  width: 100%;
}

.jp-Input-Boolean-Dialog > label {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-MainAreaWidget > :focus {
  outline: none;
}

.jp-MainAreaWidget .jp-MainAreaWidget-error {
  padding: 6px;
}

.jp-MainAreaWidget .jp-MainAreaWidget-error > pre {
  width: auto;
  padding: 10px;
  background: var(--jp-error-color3);
  border: var(--jp-border-width) solid var(--jp-error-color1);
  border-radius: var(--jp-border-radius);
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  white-space: pre-wrap;
  word-wrap: break-word;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/**
 * google-material-color v1.2.6
 * https://github.com/danlevan/google-material-color
 */
:root {
  --md-red-50: #ffebee;
  --md-red-100: #ffcdd2;
  --md-red-200: #ef9a9a;
  --md-red-300: #e57373;
  --md-red-400: #ef5350;
  --md-red-500: #f44336;
  --md-red-600: #e53935;
  --md-red-700: #d32f2f;
  --md-red-800: #c62828;
  --md-red-900: #b71c1c;
  --md-red-A100: #ff8a80;
  --md-red-A200: #ff5252;
  --md-red-A400: #ff1744;
  --md-red-A700: #d50000;
  --md-pink-50: #fce4ec;
  --md-pink-100: #f8bbd0;
  --md-pink-200: #f48fb1;
  --md-pink-300: #f06292;
  --md-pink-400: #ec407a;
  --md-pink-500: #e91e63;
  --md-pink-600: #d81b60;
  --md-pink-700: #c2185b;
  --md-pink-800: #ad1457;
  --md-pink-900: #880e4f;
  --md-pink-A100: #ff80ab;
  --md-pink-A200: #ff4081;
  --md-pink-A400: #f50057;
  --md-pink-A700: #c51162;
  --md-purple-50: #f3e5f5;
  --md-purple-100: #e1bee7;
  --md-purple-200: #ce93d8;
  --md-purple-300: #ba68c8;
  --md-purple-400: #ab47bc;
  --md-purple-500: #9c27b0;
  --md-purple-600: #8e24aa;
  --md-purple-700: #7b1fa2;
  --md-purple-800: #6a1b9a;
  --md-purple-900: #4a148c;
  --md-purple-A100: #ea80fc;
  --md-purple-A200: #e040fb;
  --md-purple-A400: #d500f9;
  --md-purple-A700: #a0f;
  --md-deep-purple-50: #ede7f6;
  --md-deep-purple-100: #d1c4e9;
  --md-deep-purple-200: #b39ddb;
  --md-deep-purple-300: #9575cd;
  --md-deep-purple-400: #7e57c2;
  --md-deep-purple-500: #673ab7;
  --md-deep-purple-600: #5e35b1;
  --md-deep-purple-700: #512da8;
  --md-deep-purple-800: #4527a0;
  --md-deep-purple-900: #311b92;
  --md-deep-purple-A100: #b388ff;
  --md-deep-purple-A200: #7c4dff;
  --md-deep-purple-A400: #651fff;
  --md-deep-purple-A700: #6200ea;
  --md-indigo-50: #e8eaf6;
  --md-indigo-100: #c5cae9;
  --md-indigo-200: #9fa8da;
  --md-indigo-300: #7986cb;
  --md-indigo-400: #5c6bc0;
  --md-indigo-500: #3f51b5;
  --md-indigo-600: #3949ab;
  --md-indigo-700: #303f9f;
  --md-indigo-800: #283593;
  --md-indigo-900: #1a237e;
  --md-indigo-A100: #8c9eff;
  --md-indigo-A200: #536dfe;
  --md-indigo-A400: #3d5afe;
  --md-indigo-A700: #304ffe;
  --md-blue-50: #e3f2fd;
  --md-blue-100: #bbdefb;
  --md-blue-200: #90caf9;
  --md-blue-300: #64b5f6;
  --md-blue-400: #42a5f5;
  --md-blue-500: #2196f3;
  --md-blue-600: #1e88e5;
  --md-blue-700: #1976d2;
  --md-blue-800: #1565c0;
  --md-blue-900: #0d47a1;
  --md-blue-A100: #82b1ff;
  --md-blue-A200: #448aff;
  --md-blue-A400: #2979ff;
  --md-blue-A700: #2962ff;
  --md-light-blue-50: #e1f5fe;
  --md-light-blue-100: #b3e5fc;
  --md-light-blue-200: #81d4fa;
  --md-light-blue-300: #4fc3f7;
  --md-light-blue-400: #29b6f6;
  --md-light-blue-500: #03a9f4;
  --md-light-blue-600: #039be5;
  --md-light-blue-700: #0288d1;
  --md-light-blue-800: #0277bd;
  --md-light-blue-900: #01579b;
  --md-light-blue-A100: #80d8ff;
  --md-light-blue-A200: #40c4ff;
  --md-light-blue-A400: #00b0ff;
  --md-light-blue-A700: #0091ea;
  --md-cyan-50: #e0f7fa;
  --md-cyan-100: #b2ebf2;
  --md-cyan-200: #80deea;
  --md-cyan-300: #4dd0e1;
  --md-cyan-400: #26c6da;
  --md-cyan-500: #00bcd4;
  --md-cyan-600: #00acc1;
  --md-cyan-700: #0097a7;
  --md-cyan-800: #00838f;
  --md-cyan-900: #006064;
  --md-cyan-A100: #84ffff;
  --md-cyan-A200: #18ffff;
  --md-cyan-A400: #00e5ff;
  --md-cyan-A700: #00b8d4;
  --md-teal-50: #e0f2f1;
  --md-teal-100: #b2dfdb;
  --md-teal-200: #80cbc4;
  --md-teal-300: #4db6ac;
  --md-teal-400: #26a69a;
  --md-teal-500: #009688;
  --md-teal-600: #00897b;
  --md-teal-700: #00796b;
  --md-teal-800: #00695c;
  --md-teal-900: #004d40;
  --md-teal-A100: #a7ffeb;
  --md-teal-A200: #64ffda;
  --md-teal-A400: #1de9b6;
  --md-teal-A700: #00bfa5;
  --md-green-50: #e8f5e9;
  --md-green-100: #c8e6c9;
  --md-green-200: #a5d6a7;
  --md-green-300: #81c784;
  --md-green-400: #66bb6a;
  --md-green-500: #4caf50;
  --md-green-600: #43a047;
  --md-green-700: #388e3c;
  --md-green-800: #2e7d32;
  --md-green-900: #1b5e20;
  --md-green-A100: #b9f6ca;
  --md-green-A200: #69f0ae;
  --md-green-A400: #00e676;
  --md-green-A700: #00c853;
  --md-light-green-50: #f1f8e9;
  --md-light-green-100: #dcedc8;
  --md-light-green-200: #c5e1a5;
  --md-light-green-300: #aed581;
  --md-light-green-400: #9ccc65;
  --md-light-green-500: #8bc34a;
  --md-light-green-600: #7cb342;
  --md-light-green-700: #689f38;
  --md-light-green-800: #558b2f;
  --md-light-green-900: #33691e;
  --md-light-green-A100: #ccff90;
  --md-light-green-A200: #b2ff59;
  --md-light-green-A400: #76ff03;
  --md-light-green-A700: #64dd17;
  --md-lime-50: #f9fbe7;
  --md-lime-100: #f0f4c3;
  --md-lime-200: #e6ee9c;
  --md-lime-300: #dce775;
  --md-lime-400: #d4e157;
  --md-lime-500: #cddc39;
  --md-lime-600: #c0ca33;
  --md-lime-700: #afb42b;
  --md-lime-800: #9e9d24;
  --md-lime-900: #827717;
  --md-lime-A100: #f4ff81;
  --md-lime-A200: #eeff41;
  --md-lime-A400: #c6ff00;
  --md-lime-A700: #aeea00;
  --md-yellow-50: #fffde7;
  --md-yellow-100: #fff9c4;
  --md-yellow-200: #fff59d;
  --md-yellow-300: #fff176;
  --md-yellow-400: #ffee58;
  --md-yellow-500: #ffeb3b;
  --md-yellow-600: #fdd835;
  --md-yellow-700: #fbc02d;
  --md-yellow-800: #f9a825;
  --md-yellow-900: #f57f17;
  --md-yellow-A100: #ffff8d;
  --md-yellow-A200: #ff0;
  --md-yellow-A400: #ffea00;
  --md-yellow-A700: #ffd600;
  --md-amber-50: #fff8e1;
  --md-amber-100: #ffecb3;
  --md-amber-200: #ffe082;
  --md-amber-300: #ffd54f;
  --md-amber-400: #ffca28;
  --md-amber-500: #ffc107;
  --md-amber-600: #ffb300;
  --md-amber-700: #ffa000;
  --md-amber-800: #ff8f00;
  --md-amber-900: #ff6f00;
  --md-amber-A100: #ffe57f;
  --md-amber-A200: #ffd740;
  --md-amber-A400: #ffc400;
  --md-amber-A700: #ffab00;
  --md-orange-50: #fff3e0;
  --md-orange-100: #ffe0b2;
  --md-orange-200: #ffcc80;
  --md-orange-300: #ffb74d;
  --md-orange-400: #ffa726;
  --md-orange-500: #ff9800;
  --md-orange-600: #fb8c00;
  --md-orange-700: #f57c00;
  --md-orange-800: #ef6c00;
  --md-orange-900: #e65100;
  --md-orange-A100: #ffd180;
  --md-orange-A200: #ffab40;
  --md-orange-A400: #ff9100;
  --md-orange-A700: #ff6d00;
  --md-deep-orange-50: #fbe9e7;
  --md-deep-orange-100: #ffccbc;
  --md-deep-orange-200: #ffab91;
  --md-deep-orange-300: #ff8a65;
  --md-deep-orange-400: #ff7043;
  --md-deep-orange-500: #ff5722;
  --md-deep-orange-600: #f4511e;
  --md-deep-orange-700: #e64a19;
  --md-deep-orange-800: #d84315;
  --md-deep-orange-900: #bf360c;
  --md-deep-orange-A100: #ff9e80;
  --md-deep-orange-A200: #ff6e40;
  --md-deep-orange-A400: #ff3d00;
  --md-deep-orange-A700: #dd2c00;
  --md-brown-50: #efebe9;
  --md-brown-100: #d7ccc8;
  --md-brown-200: #bcaaa4;
  --md-brown-300: #a1887f;
  --md-brown-400: #8d6e63;
  --md-brown-500: #795548;
  --md-brown-600: #6d4c41;
  --md-brown-700: #5d4037;
  --md-brown-800: #4e342e;
  --md-brown-900: #3e2723;
  --md-grey-50: #fafafa;
  --md-grey-100: #f5f5f5;
  --md-grey-200: #eee;
  --md-grey-300: #e0e0e0;
  --md-grey-400: #bdbdbd;
  --md-grey-500: #9e9e9e;
  --md-grey-600: #757575;
  --md-grey-700: #616161;
  --md-grey-800: #424242;
  --md-grey-900: #212121;
  --md-blue-grey-50: #eceff1;
  --md-blue-grey-100: #cfd8dc;
  --md-blue-grey-200: #b0bec5;
  --md-blue-grey-300: #90a4ae;
  --md-blue-grey-400: #78909c;
  --md-blue-grey-500: #607d8b;
  --md-blue-grey-600: #546e7a;
  --md-blue-grey-700: #455a64;
  --md-blue-grey-800: #37474f;
  --md-blue-grey-900: #263238;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2017, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| RenderedText
|----------------------------------------------------------------------------*/

:root {
  /* This is the padding value to fill the gaps between lines containing spans with background color. */
  --jp-private-code-span-padding: calc(
    (var(--jp-code-line-height) - 1) * var(--jp-code-font-size) / 2
  );
}

.jp-RenderedText {
  text-align: left;
  padding-left: var(--jp-code-padding);
  line-height: var(--jp-code-line-height);
  font-family: var(--jp-code-font-family);
}

.jp-RenderedText pre,
.jp-RenderedJavaScript pre,
.jp-RenderedHTMLCommon pre {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-code-font-size);
  border: none;
  margin: 0;
  padding: 0;
}

.jp-RenderedText pre a:link {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

.jp-RenderedText pre a:hover {
  text-decoration: underline;
  color: var(--jp-content-link-color);
}

.jp-RenderedText pre a:visited {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

/* console foregrounds and backgrounds */
.jp-RenderedText pre .ansi-black-fg {
  color: #3e424d;
}

.jp-RenderedText pre .ansi-red-fg {
  color: #e75c58;
}

.jp-RenderedText pre .ansi-green-fg {
  color: #00a250;
}

.jp-RenderedText pre .ansi-yellow-fg {
  color: #ddb62b;
}

.jp-RenderedText pre .ansi-blue-fg {
  color: #208ffb;
}

.jp-RenderedText pre .ansi-magenta-fg {
  color: #d160c4;
}

.jp-RenderedText pre .ansi-cyan-fg {
  color: #60c6c8;
}

.jp-RenderedText pre .ansi-white-fg {
  color: #c5c1b4;
}

.jp-RenderedText pre .ansi-black-bg {
  background-color: #3e424d;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-red-bg {
  background-color: #e75c58;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-green-bg {
  background-color: #00a250;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-yellow-bg {
  background-color: #ddb62b;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-blue-bg {
  background-color: #208ffb;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-magenta-bg {
  background-color: #d160c4;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-cyan-bg {
  background-color: #60c6c8;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-white-bg {
  background-color: #c5c1b4;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-black-intense-fg {
  color: #282c36;
}

.jp-RenderedText pre .ansi-red-intense-fg {
  color: #b22b31;
}

.jp-RenderedText pre .ansi-green-intense-fg {
  color: #007427;
}

.jp-RenderedText pre .ansi-yellow-intense-fg {
  color: #b27d12;
}

.jp-RenderedText pre .ansi-blue-intense-fg {
  color: #0065ca;
}

.jp-RenderedText pre .ansi-magenta-intense-fg {
  color: #a03196;
}

.jp-RenderedText pre .ansi-cyan-intense-fg {
  color: #258f8f;
}

.jp-RenderedText pre .ansi-white-intense-fg {
  color: #a1a6b2;
}

.jp-RenderedText pre .ansi-black-intense-bg {
  background-color: #282c36;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-red-intense-bg {
  background-color: #b22b31;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-green-intense-bg {
  background-color: #007427;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-yellow-intense-bg {
  background-color: #b27d12;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-blue-intense-bg {
  background-color: #0065ca;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-magenta-intense-bg {
  background-color: #a03196;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-cyan-intense-bg {
  background-color: #258f8f;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-white-intense-bg {
  background-color: #a1a6b2;
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-default-inverse-fg {
  color: var(--jp-ui-inverse-font-color0);
}

.jp-RenderedText pre .ansi-default-inverse-bg {
  background-color: var(--jp-inverse-layout-color0);
  padding: var(--jp-private-code-span-padding) 0;
}

.jp-RenderedText pre .ansi-bold {
  font-weight: bold;
}

.jp-RenderedText pre .ansi-underline {
  text-decoration: underline;
}

.jp-RenderedText[data-mime-type='application/vnd.jupyter.stderr'] {
  background: var(--jp-rendermime-error-background);
  padding-top: var(--jp-code-padding);
}

/*-----------------------------------------------------------------------------
| RenderedLatex
|----------------------------------------------------------------------------*/

.jp-RenderedLatex {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-content-font-size1);
  line-height: var(--jp-content-line-height);
}

/* Left-justify outputs.*/
.jp-OutputArea-output.jp-RenderedLatex {
  padding: var(--jp-code-padding);
  text-align: left;
}

/*-----------------------------------------------------------------------------
| RenderedHTML
|----------------------------------------------------------------------------*/

.jp-RenderedHTMLCommon {
  color: var(--jp-content-font-color1);
  font-family: var(--jp-content-font-family);
  font-size: var(--jp-content-font-size1);
  line-height: var(--jp-content-line-height);

  /* Give a bit more R padding on Markdown text to keep line lengths reasonable */
  padding-right: 20px;
}

.jp-RenderedHTMLCommon em {
  font-style: italic;
}

.jp-RenderedHTMLCommon strong {
  font-weight: bold;
}

.jp-RenderedHTMLCommon u {
  text-decoration: underline;
}

.jp-RenderedHTMLCommon a:link {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

.jp-RenderedHTMLCommon a:hover {
  text-decoration: underline;
  color: var(--jp-content-link-color);
}

.jp-RenderedHTMLCommon a:visited {
  text-decoration: none;
  color: var(--jp-content-link-color);
}

/* Headings */

.jp-RenderedHTMLCommon h1,
.jp-RenderedHTMLCommon h2,
.jp-RenderedHTMLCommon h3,
.jp-RenderedHTMLCommon h4,
.jp-RenderedHTMLCommon h5,
.jp-RenderedHTMLCommon h6 {
  line-height: var(--jp-content-heading-line-height);
  font-weight: var(--jp-content-heading-font-weight);
  font-style: normal;
  margin: var(--jp-content-heading-margin-top) 0
    var(--jp-content-heading-margin-bottom) 0;
}

.jp-RenderedHTMLCommon h1:first-child,
.jp-RenderedHTMLCommon h2:first-child,
.jp-RenderedHTMLCommon h3:first-child,
.jp-RenderedHTMLCommon h4:first-child,
.jp-RenderedHTMLCommon h5:first-child,
.jp-RenderedHTMLCommon h6:first-child {
  margin-top: calc(0.5 * var(--jp-content-heading-margin-top));
}

.jp-RenderedHTMLCommon h1:last-child,
.jp-RenderedHTMLCommon h2:last-child,
.jp-RenderedHTMLCommon h3:last-child,
.jp-RenderedHTMLCommon h4:last-child,
.jp-RenderedHTMLCommon h5:last-child,
.jp-RenderedHTMLCommon h6:last-child {
  margin-bottom: calc(0.5 * var(--jp-content-heading-margin-bottom));
}

.jp-RenderedHTMLCommon h1 {
  font-size: var(--jp-content-font-size5);
}

.jp-RenderedHTMLCommon h2 {
  font-size: var(--jp-content-font-size4);
}

.jp-RenderedHTMLCommon h3 {
  font-size: var(--jp-content-font-size3);
}

.jp-RenderedHTMLCommon h4 {
  font-size: var(--jp-content-font-size2);
}

.jp-RenderedHTMLCommon h5 {
  font-size: var(--jp-content-font-size1);
}

.jp-RenderedHTMLCommon h6 {
  font-size: var(--jp-content-font-size0);
}

/* Lists */

/* stylelint-disable selector-max-type, selector-max-compound-selectors */

.jp-RenderedHTMLCommon ul:not(.list-inline),
.jp-RenderedHTMLCommon ol:not(.list-inline) {
  padding-left: 2em;
}

.jp-RenderedHTMLCommon ul {
  list-style: disc;
}

.jp-RenderedHTMLCommon ul ul {
  list-style: square;
}

.jp-RenderedHTMLCommon ul ul ul {
  list-style: circle;
}

.jp-RenderedHTMLCommon ol {
  list-style: decimal;
}

.jp-RenderedHTMLCommon ol ol {
  list-style: upper-alpha;
}

.jp-RenderedHTMLCommon ol ol ol {
  list-style: lower-alpha;
}

.jp-RenderedHTMLCommon ol ol ol ol {
  list-style: lower-roman;
}

.jp-RenderedHTMLCommon ol ol ol ol ol {
  list-style: decimal;
}

.jp-RenderedHTMLCommon ol,
.jp-RenderedHTMLCommon ul {
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon ul ul,
.jp-RenderedHTMLCommon ul ol,
.jp-RenderedHTMLCommon ol ul,
.jp-RenderedHTMLCommon ol ol {
  margin-bottom: 0;
}

/* stylelint-enable selector-max-type, selector-max-compound-selectors */

.jp-RenderedHTMLCommon hr {
  color: var(--jp-border-color2);
  background-color: var(--jp-border-color1);
  margin-top: 1em;
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon > pre {
  margin: 1.5em 2em;
}

.jp-RenderedHTMLCommon pre,
.jp-RenderedHTMLCommon code {
  border: 0;
  background-color: var(--jp-layout-color0);
  color: var(--jp-content-font-color1);
  font-family: var(--jp-code-font-family);
  font-size: inherit;
  line-height: var(--jp-code-line-height);
  padding: 0;
  white-space: pre-wrap;
}

.jp-RenderedHTMLCommon :not(pre) > code {
  background-color: var(--jp-layout-color2);
  padding: 1px 5px;
}

/* Tables */

.jp-RenderedHTMLCommon table {
  border-collapse: collapse;
  border-spacing: 0;
  border: none;
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  table-layout: fixed;
  margin-left: auto;
  margin-bottom: 1em;
  margin-right: auto;
}

.jp-RenderedHTMLCommon thead {
  border-bottom: var(--jp-border-width) solid var(--jp-border-color1);
  vertical-align: bottom;
}

.jp-RenderedHTMLCommon td,
.jp-RenderedHTMLCommon th,
.jp-RenderedHTMLCommon tr {
  vertical-align: middle;
  padding: 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}

.jp-RenderedMarkdown.jp-RenderedHTMLCommon td,
.jp-RenderedMarkdown.jp-RenderedHTMLCommon th {
  max-width: none;
}

:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon td,
:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon th,
:not(.jp-RenderedMarkdown).jp-RenderedHTMLCommon tr {
  text-align: right;
}

.jp-RenderedHTMLCommon th {
  font-weight: bold;
}

.jp-RenderedHTMLCommon tbody tr:nth-child(odd) {
  background: var(--jp-layout-color0);
}

.jp-RenderedHTMLCommon tbody tr:nth-child(even) {
  background: var(--jp-rendermime-table-row-background);
}

.jp-RenderedHTMLCommon tbody tr:hover {
  background: var(--jp-rendermime-table-row-hover-background);
}

.jp-RenderedHTMLCommon p {
  text-align: left;
  margin: 0;
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon img {
  -moz-force-broken-image-icon: 1;
}

/* Restrict to direct children as other images could be nested in other content. */
.jp-RenderedHTMLCommon > img {
  display: block;
  margin-left: 0;
  margin-right: 0;
  margin-bottom: 1em;
}

/* Change color behind transparent images if they need it... */
[data-jp-theme-light='false'] .jp-RenderedImage img.jp-needs-light-background {
  background-color: var(--jp-inverse-layout-color1);
}

[data-jp-theme-light='true'] .jp-RenderedImage img.jp-needs-dark-background {
  background-color: var(--jp-inverse-layout-color1);
}

.jp-RenderedHTMLCommon img,
.jp-RenderedImage img,
.jp-RenderedHTMLCommon svg,
.jp-RenderedSVG svg {
  max-width: 100%;
  height: auto;
}

.jp-RenderedHTMLCommon img.jp-mod-unconfined,
.jp-RenderedImage img.jp-mod-unconfined,
.jp-RenderedHTMLCommon svg.jp-mod-unconfined,
.jp-RenderedSVG svg.jp-mod-unconfined {
  max-width: none;
}

.jp-RenderedHTMLCommon .alert {
  padding: var(--jp-notebook-padding);
  border: var(--jp-border-width) solid transparent;
  border-radius: var(--jp-border-radius);
  margin-bottom: 1em;
}

.jp-RenderedHTMLCommon .alert-info {
  color: var(--jp-info-color0);
  background-color: var(--jp-info-color3);
  border-color: var(--jp-info-color2);
}

.jp-RenderedHTMLCommon .alert-info hr {
  border-color: var(--jp-info-color3);
}

.jp-RenderedHTMLCommon .alert-info > p:last-child,
.jp-RenderedHTMLCommon .alert-info > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-warning {
  color: var(--jp-warn-color0);
  background-color: var(--jp-warn-color3);
  border-color: var(--jp-warn-color2);
}

.jp-RenderedHTMLCommon .alert-warning hr {
  border-color: var(--jp-warn-color3);
}

.jp-RenderedHTMLCommon .alert-warning > p:last-child,
.jp-RenderedHTMLCommon .alert-warning > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-success {
  color: var(--jp-success-color0);
  background-color: var(--jp-success-color3);
  border-color: var(--jp-success-color2);
}

.jp-RenderedHTMLCommon .alert-success hr {
  border-color: var(--jp-success-color3);
}

.jp-RenderedHTMLCommon .alert-success > p:last-child,
.jp-RenderedHTMLCommon .alert-success > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon .alert-danger {
  color: var(--jp-error-color0);
  background-color: var(--jp-error-color3);
  border-color: var(--jp-error-color2);
}

.jp-RenderedHTMLCommon .alert-danger hr {
  border-color: var(--jp-error-color3);
}

.jp-RenderedHTMLCommon .alert-danger > p:last-child,
.jp-RenderedHTMLCommon .alert-danger > ul:last-child {
  margin-bottom: 0;
}

.jp-RenderedHTMLCommon blockquote {
  margin: 1em 2em;
  padding: 0 1em;
  border-left: 5px solid var(--jp-border-color2);
}

a.jp-InternalAnchorLink {
  visibility: hidden;
  margin-left: 8px;
  color: var(--md-blue-800);
}

h1:hover .jp-InternalAnchorLink,
h2:hover .jp-InternalAnchorLink,
h3:hover .jp-InternalAnchorLink,
h4:hover .jp-InternalAnchorLink,
h5:hover .jp-InternalAnchorLink,
h6:hover .jp-InternalAnchorLink {
  visibility: visible;
}

.jp-RenderedHTMLCommon kbd {
  background-color: var(--jp-rendermime-table-row-background);
  border: 1px solid var(--jp-border-color0);
  border-bottom-color: var(--jp-border-color2);
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.25);
  display: inline-block;
  font-size: var(--jp-ui-font-size0);
  line-height: 1em;
  padding: 0.2em 0.5em;
}

/* Most direct children of .jp-RenderedHTMLCommon have a margin-bottom of 1.0.
 * At the bottom of cells this is a bit too much as there is also spacing
 * between cells. Going all the way to 0 gets too tight between markdown and
 * code cells.
 */
.jp-RenderedHTMLCommon > *:last-child {
  margin-bottom: 0.5em;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Copyright (c) 2014-2017, PhosphorJS Contributors
|
| Distributed under the terms of the BSD 3-Clause License.
|
| The full license is in the file LICENSE, distributed with this software.
|----------------------------------------------------------------------------*/

.lm-cursor-backdrop {
  position: fixed;
  width: 200px;
  height: 200px;
  margin-top: -100px;
  margin-left: -100px;
  will-change: transform;
  z-index: 100;
}

.lm-mod-drag-image {
  will-change: transform;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-lineFormSearch {
  padding: 4px 12px;
  background-color: var(--jp-layout-color2);
  box-shadow: var(--jp-toolbar-box-shadow);
  z-index: 2;
  font-size: var(--jp-ui-font-size1);
}

.jp-lineFormCaption {
  font-size: var(--jp-ui-font-size0);
  line-height: var(--jp-ui-font-size1);
  margin-top: 4px;
  color: var(--jp-ui-font-color0);
}

.jp-baseLineForm {
  border: none;
  border-radius: 0;
  position: absolute;
  background-size: 16px;
  background-repeat: no-repeat;
  background-position: center;
  outline: none;
}

.jp-lineFormButtonContainer {
  top: 4px;
  right: 8px;
  height: 24px;
  padding: 0 12px;
  width: 12px;
}

.jp-lineFormButtonIcon {
  top: 0;
  right: 0;
  background-color: var(--jp-brand-color1);
  height: 100%;
  width: 100%;
  box-sizing: border-box;
  padding: 4px 6px;
}

.jp-lineFormButton {
  top: 0;
  right: 0;
  background-color: transparent;
  height: 100%;
  width: 100%;
  box-sizing: border-box;
}

.jp-lineFormWrapper {
  overflow: hidden;
  padding: 0 8px;
  border: 1px solid var(--jp-border-color0);
  background-color: var(--jp-input-active-background);
  height: 22px;
}

.jp-lineFormWrapperFocusWithin {
  border: var(--jp-border-width) solid var(--md-blue-500);
  box-shadow: inset 0 0 4px var(--md-blue-300);
}

.jp-lineFormInput {
  background: transparent;
  width: 200px;
  height: 100%;
  border: none;
  outline: none;
  color: var(--jp-ui-font-color0);
  line-height: 28px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) 2014-2016, Jupyter Development Team.
|
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-JSONEditor {
  display: flex;
  flex-direction: column;
  width: 100%;
}

.jp-JSONEditor-host {
  flex: 1 1 auto;
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  border-radius: 0;
  background: var(--jp-layout-color0);
  min-height: 50px;
  padding: 1px;
}

.jp-JSONEditor.jp-mod-error .jp-JSONEditor-host {
  border-color: red;
  outline-color: red;
}

.jp-JSONEditor-header {
  display: flex;
  flex: 1 0 auto;
  padding: 0 0 0 12px;
}

.jp-JSONEditor-header label {
  flex: 0 0 auto;
}

.jp-JSONEditor-commitButton {
  height: 16px;
  width: 16px;
  background-size: 18px;
  background-repeat: no-repeat;
  background-position: center;
}

.jp-JSONEditor-host.jp-mod-focused {
  background-color: var(--jp-input-active-background);
  border: 1px solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
}

.jp-Editor.jp-mod-dropTarget {
  border: var(--jp-border-width) solid var(--jp-input-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/
.jp-DocumentSearch-input {
  border: none;
  outline: none;
  color: var(--jp-ui-font-color0);
  font-size: var(--jp-ui-font-size1);
  background-color: var(--jp-layout-color0);
  font-family: var(--jp-ui-font-family);
  padding: 2px 1px;
  resize: none;
}

.jp-DocumentSearch-overlay {
  position: absolute;
  background-color: var(--jp-toolbar-background);
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  border-left: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  top: 0;
  right: 0;
  z-index: 7;
  min-width: 405px;
  padding: 2px;
  font-size: var(--jp-ui-font-size1);

  --jp-private-document-search-button-height: 20px;
}

.jp-DocumentSearch-overlay button {
  background-color: var(--jp-toolbar-background);
  outline: 0;
}

.jp-DocumentSearch-overlay button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-overlay button:active {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-overlay-row {
  display: flex;
  align-items: center;
  margin-bottom: 2px;
}

.jp-DocumentSearch-button-content {
  display: inline-block;
  cursor: pointer;
  box-sizing: border-box;
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-button-content svg {
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-input-wrapper {
  border: var(--jp-border-width) solid var(--jp-border-color0);
  display: flex;
  background-color: var(--jp-layout-color0);
  margin: 2px;
}

.jp-DocumentSearch-input-wrapper:focus-within {
  border-color: var(--jp-cell-editor-active-border-color);
}

.jp-DocumentSearch-toggle-wrapper,
.jp-DocumentSearch-button-wrapper {
  all: initial;
  overflow: hidden;
  display: inline-block;
  border: none;
  box-sizing: border-box;
}

.jp-DocumentSearch-toggle-wrapper {
  width: 14px;
  height: 14px;
}

.jp-DocumentSearch-button-wrapper {
  width: var(--jp-private-document-search-button-height);
  height: var(--jp-private-document-search-button-height);
}

.jp-DocumentSearch-toggle-wrapper:focus,
.jp-DocumentSearch-button-wrapper:focus {
  outline: var(--jp-border-width) solid
    var(--jp-cell-editor-active-border-color);
  outline-offset: -1px;
}

.jp-DocumentSearch-toggle-wrapper,
.jp-DocumentSearch-button-wrapper,
.jp-DocumentSearch-button-content:focus {
  outline: none;
}

.jp-DocumentSearch-toggle-placeholder {
  width: 5px;
}

.jp-DocumentSearch-input-button::before {
  display: block;
  padding-top: 100%;
}

.jp-DocumentSearch-input-button-off {
  opacity: var(--jp-search-toggle-off-opacity);
}

.jp-DocumentSearch-input-button-off:hover {
  opacity: var(--jp-search-toggle-hover-opacity);
}

.jp-DocumentSearch-input-button-on {
  opacity: var(--jp-search-toggle-on-opacity);
}

.jp-DocumentSearch-index-counter {
  padding-left: 10px;
  padding-right: 10px;
  user-select: none;
  min-width: 35px;
  display: inline-block;
}

.jp-DocumentSearch-up-down-wrapper {
  display: inline-block;
  padding-right: 2px;
  margin-left: auto;
  white-space: nowrap;
}

.jp-DocumentSearch-spacer {
  margin-left: auto;
}

.jp-DocumentSearch-up-down-wrapper button {
  outline: 0;
  border: none;
  width: var(--jp-private-document-search-button-height);
  height: var(--jp-private-document-search-button-height);
  vertical-align: middle;
  margin: 1px 5px 2px;
}

.jp-DocumentSearch-up-down-button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-up-down-button:active {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-filter-button {
  border-radius: var(--jp-border-radius);
}

.jp-DocumentSearch-filter-button:hover {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-filter-button-enabled {
  background-color: var(--jp-layout-color2);
}

.jp-DocumentSearch-filter-button-enabled:hover {
  background-color: var(--jp-layout-color3);
}

.jp-DocumentSearch-search-options {
  padding: 0 8px;
  margin-left: 3px;
  width: 100%;
  display: grid;
  justify-content: start;
  grid-template-columns: 1fr 1fr;
  align-items: center;
  justify-items: stretch;
}

.jp-DocumentSearch-search-filter-disabled {
  color: var(--jp-ui-font-color2);
}

.jp-DocumentSearch-search-filter {
  display: flex;
  align-items: center;
  user-select: none;
}

.jp-DocumentSearch-regex-error {
  color: var(--jp-error-color0);
}

.jp-DocumentSearch-replace-button-wrapper {
  overflow: hidden;
  display: inline-block;
  box-sizing: border-box;
  border: var(--jp-border-width) solid var(--jp-border-color0);
  margin: auto 2px;
  padding: 1px 4px;
  height: calc(var(--jp-private-document-search-button-height) + 2px);
}

.jp-DocumentSearch-replace-button-wrapper:focus {
  border: var(--jp-border-width) solid var(--jp-cell-editor-active-border-color);
}

.jp-DocumentSearch-replace-button {
  display: inline-block;
  text-align: center;
  cursor: pointer;
  box-sizing: border-box;
  color: var(--jp-ui-font-color1);

  /* height - 2 * (padding of wrapper) */
  line-height: calc(var(--jp-private-document-search-button-height) - 2px);
  width: 100%;
  height: 100%;
}

.jp-DocumentSearch-replace-button:focus {
  outline: none;
}

.jp-DocumentSearch-replace-wrapper-class {
  margin-left: 14px;
  display: flex;
}

.jp-DocumentSearch-replace-toggle {
  border: none;
  background-color: var(--jp-toolbar-background);
  border-radius: var(--jp-border-radius);
}

.jp-DocumentSearch-replace-toggle:hover {
  background-color: var(--jp-layout-color2);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.cm-editor {
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  font-family: var(--jp-code-font-family);
  border: 0;
  border-radius: 0;
  height: auto;

  /* Changed to auto to autogrow */
}

.cm-editor pre {
  padding: 0 var(--jp-code-padding);
}

.jp-CodeMirrorEditor[data-type='inline'] .cm-dialog {
  background-color: var(--jp-layout-color0);
  color: var(--jp-content-font-color1);
}

.jp-CodeMirrorEditor {
  cursor: text;
}

/* When zoomed out 67% and 33% on a screen of 1440 width x 900 height */
@media screen and (min-width: 2138px) and (max-width: 4319px) {
  .jp-CodeMirrorEditor[data-type='inline'] .cm-cursor {
    border-left: var(--jp-code-cursor-width1) solid
      var(--jp-editor-cursor-color);
  }
}

/* When zoomed out less than 33% */
@media screen and (min-width: 4320px) {
  .jp-CodeMirrorEditor[data-type='inline'] .cm-cursor {
    border-left: var(--jp-code-cursor-width2) solid
      var(--jp-editor-cursor-color);
  }
}

.cm-editor.jp-mod-readOnly .cm-cursor {
  display: none;
}

.jp-CollaboratorCursor {
  border-left: 5px solid transparent;
  border-right: 5px solid transparent;
  border-top: none;
  border-bottom: 3px solid;
  background-clip: content-box;
  margin-left: -5px;
  margin-right: -5px;
}

.cm-searching,
.cm-searching span {
  /* `.cm-searching span`: we need to override syntax highlighting */
  background-color: var(--jp-search-unselected-match-background-color);
  color: var(--jp-search-unselected-match-color);
}

.cm-searching::selection,
.cm-searching span::selection {
  background-color: var(--jp-search-unselected-match-background-color);
  color: var(--jp-search-unselected-match-color);
}

.jp-current-match > .cm-searching,
.jp-current-match > .cm-searching span,
.cm-searching > .jp-current-match,
.cm-searching > .jp-current-match span {
  background-color: var(--jp-search-selected-match-background-color);
  color: var(--jp-search-selected-match-color);
}

.jp-current-match > .cm-searching::selection,
.cm-searching > .jp-current-match::selection,
.jp-current-match > .cm-searching span::selection {
  background-color: var(--jp-search-selected-match-background-color);
  color: var(--jp-search-selected-match-color);
}

.cm-trailingspace {
  background-image: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAFCAYAAAB4ka1VAAAAsElEQVQIHQGlAFr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA7+r3zKmT0/+pk9P/7+r3zAAAAAAAAAAABAAAAAAAAAAA6OPzM+/q9wAAAAAA6OPzMwAAAAAAAAAAAgAAAAAAAAAAGR8NiRQaCgAZIA0AGR8NiQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQyoYJ/SY80UAAAAASUVORK5CYII=);
  background-position: center left;
  background-repeat: repeat-x;
}

.jp-CollaboratorCursor-hover {
  position: absolute;
  z-index: 1;
  transform: translateX(-50%);
  color: white;
  border-radius: 3px;
  padding-left: 4px;
  padding-right: 4px;
  padding-top: 1px;
  padding-bottom: 1px;
  text-align: center;
  font-size: var(--jp-ui-font-size1);
  white-space: nowrap;
}

.jp-CodeMirror-ruler {
  border-left: 1px dashed var(--jp-border-color2);
}

/* Styles for shared cursors (remote cursor locations and selected ranges) */
.jp-CodeMirrorEditor .cm-ySelectionCaret {
  position: relative;
  border-left: 1px solid black;
  margin-left: -1px;
  margin-right: -1px;
  box-sizing: border-box;
}

.jp-CodeMirrorEditor .cm-ySelectionCaret > .cm-ySelectionInfo {
  white-space: nowrap;
  position: absolute;
  top: -1.15em;
  padding-bottom: 0.05em;
  left: -1px;
  font-size: 0.95em;
  font-family: var(--jp-ui-font-family);
  font-weight: bold;
  line-height: normal;
  user-select: none;
  color: white;
  padding-left: 2px;
  padding-right: 2px;
  z-index: 101;
  transition: opacity 0.3s ease-in-out;
}

.jp-CodeMirrorEditor .cm-ySelectionInfo {
  transition-delay: 0.7s;
  opacity: 0;
}

.jp-CodeMirrorEditor .cm-ySelectionCaret:hover > .cm-ySelectionInfo {
  opacity: 1;
  transition-delay: 0s;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-MimeDocument {
  outline: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-filebrowser-button-height: 28px;
  --jp-private-filebrowser-button-width: 48px;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-FileBrowser .jp-SidePanel-content {
  display: flex;
  flex-direction: column;
}

.jp-FileBrowser-toolbar.jp-Toolbar {
  flex-wrap: wrap;
  row-gap: 12px;
  border-bottom: none;
  height: auto;
  margin: 8px 12px 0;
  box-shadow: none;
  padding: 0;
  justify-content: flex-start;
}

.jp-FileBrowser-Panel {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
}

.jp-BreadCrumbs {
  flex: 0 0 auto;
  margin: 8px 12px;
}

.jp-BreadCrumbs-item {
  margin: 0 2px;
  padding: 0 2px;
  border-radius: var(--jp-border-radius);
  cursor: pointer;
}

.jp-BreadCrumbs-item:hover {
  background-color: var(--jp-layout-color2);
}

.jp-BreadCrumbs-item:first-child {
  margin-left: 0;
}

.jp-BreadCrumbs-item.jp-mod-dropTarget {
  background-color: var(--jp-brand-color2);
  opacity: 0.7;
}

/*-----------------------------------------------------------------------------
| Buttons
|----------------------------------------------------------------------------*/

.jp-FileBrowser-toolbar > .jp-Toolbar-item {
  flex: 0 0 auto;
  padding-left: 0;
  padding-right: 2px;
  align-items: center;
  height: unset;
}

.jp-FileBrowser-toolbar > .jp-Toolbar-item .jp-ToolbarButtonComponent {
  width: 40px;
}

/*-----------------------------------------------------------------------------
| Other styles
|----------------------------------------------------------------------------*/

.jp-FileDialog.jp-mod-conflict input {
  color: var(--jp-error-color1);
}

.jp-FileDialog .jp-new-name-title {
  margin-top: 12px;
}

.jp-LastModified-hidden {
  display: none;
}

.jp-FileSize-hidden {
  display: none;
}

.jp-FileBrowser .lm-AccordionPanel > h3:first-child {
  display: none;
}

/*-----------------------------------------------------------------------------
| DirListing
|----------------------------------------------------------------------------*/

.jp-DirListing {
  flex: 1 1 auto;
  display: flex;
  flex-direction: column;
  outline: 0;
}

.jp-DirListing-header {
  flex: 0 0 auto;
  display: flex;
  flex-direction: row;
  align-items: center;
  overflow: hidden;
  border-top: var(--jp-border-width) solid var(--jp-border-color2);
  border-bottom: var(--jp-border-width) solid var(--jp-border-color1);
  box-shadow: var(--jp-toolbar-box-shadow);
  z-index: 2;
}

.jp-DirListing-headerItem {
  padding: 4px 12px 2px;
  font-weight: 500;
}

.jp-DirListing-headerItem:hover {
  background: var(--jp-layout-color2);
}

.jp-DirListing-headerItem.jp-id-name {
  flex: 1 0 84px;
}

.jp-DirListing-headerItem.jp-id-modified {
  flex: 0 0 112px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
}

.jp-DirListing-headerItem.jp-id-filesize {
  flex: 0 0 75px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
}

.jp-id-narrow {
  display: none;
  flex: 0 0 5px;
  padding: 4px;
  border-left: var(--jp-border-width) solid var(--jp-border-color2);
  text-align: right;
  color: var(--jp-border-color2);
}

.jp-DirListing-narrow .jp-id-narrow {
  display: block;
}

.jp-DirListing-narrow .jp-id-modified,
.jp-DirListing-narrow .jp-DirListing-itemModified {
  display: none;
}

.jp-DirListing-headerItem.jp-mod-selected {
  font-weight: 600;
}

/* increase specificity to override bundled default */
.jp-DirListing-content {
  flex: 1 1 auto;
  margin: 0;
  padding: 0;
  list-style-type: none;
  overflow: auto;
  background-color: var(--jp-layout-color1);
}

.jp-DirListing-content mark {
  color: var(--jp-ui-font-color0);
  background-color: transparent;
  font-weight: bold;
}

.jp-DirListing-content .jp-DirListing-item.jp-mod-selected mark {
  color: var(--jp-ui-inverse-font-color0);
}

/* Style the directory listing content when a user drops a file to upload */
.jp-DirListing.jp-mod-native-drop .jp-DirListing-content {
  outline: 5px dashed rgba(128, 128, 128, 0.5);
  outline-offset: -10px;
  cursor: copy;
}

.jp-DirListing-item {
  display: flex;
  flex-direction: row;
  align-items: center;
  padding: 4px 12px;
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-DirListing-checkboxWrapper {
  /* Increases hit area of checkbox. */
  padding: 4px;
}

.jp-DirListing-header
  .jp-DirListing-checkboxWrapper
  + .jp-DirListing-headerItem {
  padding-left: 4px;
}

.jp-DirListing-content .jp-DirListing-checkboxWrapper {
  position: relative;
  left: -4px;
  margin: -4px 0 -4px -8px;
}

.jp-DirListing-checkboxWrapper.jp-mod-visible {
  visibility: visible;
}

/* For devices that support hovering, hide checkboxes until hovered, selected...
*/
@media (hover: hover) {
  .jp-DirListing-checkboxWrapper {
    visibility: hidden;
  }

  .jp-DirListing-item:hover .jp-DirListing-checkboxWrapper,
  .jp-DirListing-item.jp-mod-selected .jp-DirListing-checkboxWrapper {
    visibility: visible;
  }
}

.jp-DirListing-item[data-is-dot] {
  opacity: 75%;
}

.jp-DirListing-item.jp-mod-selected {
  color: var(--jp-ui-inverse-font-color1);
  background: var(--jp-brand-color1);
}

.jp-DirListing-item.jp-mod-dropTarget {
  background: var(--jp-brand-color3);
}

.jp-DirListing-item:hover:not(.jp-mod-selected) {
  background: var(--jp-layout-color2);
}

.jp-DirListing-itemIcon {
  flex: 0 0 20px;
  margin-right: 4px;
}

.jp-DirListing-itemText {
  flex: 1 0 64px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  user-select: none;
}

.jp-DirListing-itemText:focus {
  outline-width: 2px;
  outline-color: var(--jp-inverse-layout-color1);
  outline-style: solid;
  outline-offset: 1px;
}

.jp-DirListing-item.jp-mod-selected .jp-DirListing-itemText:focus {
  outline-color: var(--jp-layout-color1);
}

.jp-DirListing-itemModified {
  flex: 0 0 125px;
  text-align: right;
}

.jp-DirListing-itemFileSize {
  flex: 0 0 90px;
  text-align: right;
}

.jp-DirListing-editor {
  flex: 1 0 64px;
  outline: none;
  border: none;
  color: var(--jp-ui-font-color1);
  background-color: var(--jp-layout-color1);
}

.jp-DirListing-item.jp-mod-running .jp-DirListing-itemIcon::before {
  color: var(--jp-success-color1);
  content: '\25CF';
  font-size: 8px;
  position: absolute;
  left: -8px;
}

.jp-DirListing-item.jp-mod-running.jp-mod-selected
  .jp-DirListing-itemIcon::before {
  color: var(--jp-ui-inverse-font-color1);
}

.jp-DirListing-item.lm-mod-drag-image,
.jp-DirListing-item.jp-mod-selected.lm-mod-drag-image {
  font-size: var(--jp-ui-font-size1);
  padding-left: 4px;
  margin-left: 4px;
  width: 160px;
  background-color: var(--jp-ui-inverse-font-color2);
  box-shadow: var(--jp-elevation-z2);
  border-radius: 0;
  color: var(--jp-ui-font-color1);
  transform: translateX(-40%) translateY(-58%);
}

.jp-Document {
  min-width: 120px;
  min-height: 120px;
  outline: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Main OutputArea
| OutputArea has a list of Outputs
|----------------------------------------------------------------------------*/

.jp-OutputArea {
  overflow-y: auto;
}

.jp-OutputArea-child {
  display: table;
  table-layout: fixed;
  width: 100%;
  overflow: hidden;
}

.jp-OutputPrompt {
  width: var(--jp-cell-prompt-width);
  color: var(--jp-cell-outprompt-font-color);
  font-family: var(--jp-cell-prompt-font-family);
  padding: var(--jp-code-padding);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;
  opacity: var(--jp-cell-prompt-opacity);

  /* Right align prompt text, don't wrap to handle large prompt numbers */
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  /* Disable text selection */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-OutputArea-prompt {
  display: table-cell;
  vertical-align: top;
}

.jp-OutputArea-output {
  display: table-cell;
  width: 100%;
  height: auto;
  overflow: auto;
  user-select: text;
  -moz-user-select: text;
  -webkit-user-select: text;
  -ms-user-select: text;
}

.jp-OutputArea .jp-RenderedText {
  padding-left: 1ch;
}

/**
 * Prompt overlay.
 */

.jp-OutputArea-promptOverlay {
  position: absolute;
  top: 0;
  width: var(--jp-cell-prompt-width);
  height: 100%;
  opacity: 0.5;
}

.jp-OutputArea-promptOverlay:hover {
  background: var(--jp-layout-color2);
  box-shadow: inset 0 0 1px var(--jp-inverse-layout-color0);
  cursor: zoom-out;
}

.jp-mod-outputsScrolled .jp-OutputArea-promptOverlay:hover {
  cursor: zoom-in;
}

/**
 * Isolated output.
 */
.jp-OutputArea-output.jp-mod-isolated {
  width: 100%;
  display: block;
}

/*
When drag events occur, `lm-mod-override-cursor` is added to the body.
Because iframes steal all cursor events, the following two rules are necessary
to suppress pointer events while resize drags are occurring. There may be a
better solution to this problem.
*/
body.lm-mod-override-cursor .jp-OutputArea-output.jp-mod-isolated {
  position: relative;
}

body.lm-mod-override-cursor .jp-OutputArea-output.jp-mod-isolated::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: transparent;
}

/* pre */

.jp-OutputArea-output pre {
  border: none;
  margin: 0;
  padding: 0;
  overflow-x: auto;
  overflow-y: auto;
  word-break: break-all;
  word-wrap: break-word;
  white-space: pre-wrap;
}

/* tables */

.jp-OutputArea-output.jp-RenderedHTMLCommon table {
  margin-left: 0;
  margin-right: 0;
}

/* description lists */

.jp-OutputArea-output dl,
.jp-OutputArea-output dt,
.jp-OutputArea-output dd {
  display: block;
}

.jp-OutputArea-output dl {
  width: 100%;
  overflow: hidden;
  padding: 0;
  margin: 0;
}

.jp-OutputArea-output dt {
  font-weight: bold;
  float: left;
  width: 20%;
  padding: 0;
  margin: 0;
}

.jp-OutputArea-output dd {
  float: left;
  width: 80%;
  padding: 0;
  margin: 0;
}

.jp-TrimmedOutputs pre {
  background: var(--jp-layout-color3);
  font-size: calc(var(--jp-code-font-size) * 1.4);
  text-align: center;
  text-transform: uppercase;
}

/* Hide the gutter in case of
 *  - nested output areas (e.g. in the case of output widgets)
 *  - mirrored output areas
 */
.jp-OutputArea .jp-OutputArea .jp-OutputArea-prompt {
  display: none;
}

/* Hide empty lines in the output area, for instance due to cleared widgets */
.jp-OutputArea-prompt:empty {
  padding: 0;
  border: 0;
}

/*-----------------------------------------------------------------------------
| executeResult is added to any Output-result for the display of the object
| returned by a cell
|----------------------------------------------------------------------------*/

.jp-OutputArea-output.jp-OutputArea-executeResult {
  margin-left: 0;
  width: 100%;
}

/* Text output with the Out[] prompt needs a top padding to match the
 * alignment of the Out[] prompt itself.
 */
.jp-OutputArea-executeResult .jp-RenderedText.jp-OutputArea-output {
  padding-top: var(--jp-code-padding);
  border-top: var(--jp-border-width) solid transparent;
}

/*-----------------------------------------------------------------------------
| The Stdin output
|----------------------------------------------------------------------------*/

.jp-Stdin-prompt {
  color: var(--jp-content-font-color0);
  padding-right: var(--jp-code-padding);
  vertical-align: baseline;
  flex: 0 0 auto;
}

.jp-Stdin-input {
  font-family: var(--jp-code-font-family);
  font-size: inherit;
  color: inherit;
  background-color: inherit;
  width: 42%;
  min-width: 200px;

  /* make sure input baseline aligns with prompt */
  vertical-align: baseline;

  /* padding + margin = 0.5em between prompt and cursor */
  padding: 0 0.25em;
  margin: 0 0.25em;
  flex: 0 0 70%;
}

.jp-Stdin-input::placeholder {
  opacity: 0;
}

.jp-Stdin-input:focus {
  box-shadow: none;
}

.jp-Stdin-input:focus::placeholder {
  opacity: 1;
}

/*-----------------------------------------------------------------------------
| Output Area View
|----------------------------------------------------------------------------*/

.jp-LinkedOutputView .jp-OutputArea {
  height: 100%;
  display: block;
}

.jp-LinkedOutputView .jp-OutputArea-output:only-child {
  height: 100%;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

@media print {
  .jp-OutputArea-child {
    break-inside: avoid-page;
  }
}

/*-----------------------------------------------------------------------------
| Mobile
|----------------------------------------------------------------------------*/
@media only screen and (max-width: 760px) {
  .jp-OutputPrompt {
    display: table-row;
    text-align: left;
  }

  .jp-OutputArea-child .jp-OutputArea-output {
    display: table-row;
    margin-left: var(--jp-notebook-padding);
  }
}

/* Trimmed outputs warning */
.jp-TrimmedOutputs > a {
  margin: 10px;
  text-decoration: none;
  cursor: pointer;
}

.jp-TrimmedOutputs > a:hover {
  text-decoration: none;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Table of Contents
|----------------------------------------------------------------------------*/

:root {
  --jp-private-toc-active-width: 4px;
}

.jp-TableOfContents {
  display: flex;
  flex-direction: column;
  background: var(--jp-layout-color1);
  color: var(--jp-ui-font-color1);
  font-size: var(--jp-ui-font-size1);
  height: 100%;
}

.jp-TableOfContents-placeholder {
  text-align: center;
}

.jp-TableOfContents-placeholderContent {
  color: var(--jp-content-font-color2);
  padding: 8px;
}

.jp-TableOfContents-placeholderContent > h3 {
  margin-bottom: var(--jp-content-heading-margin-bottom);
}

.jp-TableOfContents .jp-SidePanel-content {
  overflow-y: auto;
}

.jp-TableOfContents-tree {
  margin: 4px;
}

.jp-TableOfContents ol {
  list-style-type: none;
}

/* stylelint-disable-next-line selector-max-type */
.jp-TableOfContents li > ol {
  /* Align left border with triangle icon center */
  padding-left: 11px;
}

.jp-TableOfContents-content {
  /* left margin for the active heading indicator */
  margin: 0 0 0 var(--jp-private-toc-active-width);
  padding: 0;
  background-color: var(--jp-layout-color1);
}

.jp-tocItem {
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

.jp-tocItem-heading {
  display: flex;
  cursor: pointer;
}

.jp-tocItem-heading:hover {
  background-color: var(--jp-layout-color2);
}

.jp-tocItem-content {
  display: block;
  padding: 4px 0;
  white-space: nowrap;
  text-overflow: ellipsis;
  overflow-x: hidden;
}

.jp-tocItem-collapser {
  height: 20px;
  margin: 2px 2px 0;
  padding: 0;
  background: none;
  border: none;
  cursor: pointer;
}

.jp-tocItem-collapser:hover {
  background-color: var(--jp-layout-color3);
}

/* Active heading indicator */

.jp-tocItem-heading::before {
  content: ' ';
  background: transparent;
  width: var(--jp-private-toc-active-width);
  height: 24px;
  position: absolute;
  left: 0;
  border-radius: var(--jp-border-radius);
}

.jp-tocItem-heading.jp-tocItem-active::before {
  background-color: var(--jp-brand-color1);
}

.jp-tocItem-heading:hover.jp-tocItem-active::before {
  background: var(--jp-brand-color0);
  opacity: 1;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

.jp-Collapser {
  flex: 0 0 var(--jp-cell-collapser-width);
  padding: 0;
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
  border-radius: var(--jp-border-radius);
  opacity: 1;
}

.jp-Collapser-child {
  display: block;
  width: 100%;
  box-sizing: border-box;

  /* height: 100% doesn't work because the height of its parent is computed from content */
  position: absolute;
  top: 0;
  bottom: 0;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

/*
Hiding collapsers in print mode.

Note: input and output wrappers have "display: block" propery in print mode.
*/

@media print {
  .jp-Collapser {
    display: none;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Header/Footer
|----------------------------------------------------------------------------*/

/* Hidden by zero height by default */
.jp-CellHeader,
.jp-CellFooter {
  height: 0;
  width: 100%;
  padding: 0;
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Input
|----------------------------------------------------------------------------*/

/* All input areas */
.jp-InputArea {
  display: table;
  table-layout: fixed;
  width: 100%;
  overflow: hidden;
}

.jp-InputArea-editor {
  display: table-cell;
  overflow: hidden;
  vertical-align: top;

  /* This is the non-active, default styling */
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  border-radius: 0;
  background: var(--jp-cell-editor-background);
}

.jp-InputPrompt {
  display: table-cell;
  vertical-align: top;
  width: var(--jp-cell-prompt-width);
  color: var(--jp-cell-inprompt-font-color);
  font-family: var(--jp-cell-prompt-font-family);
  padding: var(--jp-code-padding);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  opacity: var(--jp-cell-prompt-opacity);
  line-height: var(--jp-code-line-height);
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;

  /* Right align prompt text, don't wrap to handle large prompt numbers */
  text-align: right;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;

  /* Disable text selection */
  -webkit-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}

/*-----------------------------------------------------------------------------
| Mobile
|----------------------------------------------------------------------------*/
@media only screen and (max-width: 760px) {
  .jp-InputArea-editor {
    display: table-row;
    margin-left: var(--jp-notebook-padding);
  }

  .jp-InputPrompt {
    display: table-row;
    text-align: left;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Placeholder
|----------------------------------------------------------------------------*/

.jp-Placeholder {
  display: table;
  table-layout: fixed;
  width: 100%;
}

.jp-Placeholder-prompt {
  display: table-cell;
  box-sizing: border-box;
}

.jp-Placeholder-content {
  display: table-cell;
  padding: 4px 6px;
  border: 1px solid transparent;
  border-radius: 0;
  background: none;
  box-sizing: border-box;
  cursor: pointer;
}

.jp-Placeholder-contentContainer {
  display: flex;
}

.jp-Placeholder-content:hover,
.jp-InputPlaceholder > .jp-Placeholder-content:hover {
  border-color: var(--jp-layout-color3);
}

.jp-Placeholder-content .jp-MoreHorizIcon {
  width: 32px;
  height: 16px;
  border: 1px solid transparent;
  border-radius: var(--jp-border-radius);
}

.jp-Placeholder-content .jp-MoreHorizIcon:hover {
  border: 1px solid var(--jp-border-color1);
  box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.25);
  background-color: var(--jp-layout-color0);
}

.jp-PlaceholderText {
  white-space: nowrap;
  overflow-x: hidden;
  color: var(--jp-inverse-layout-color3);
  font-family: var(--jp-code-font-family);
}

.jp-InputPlaceholder > .jp-Placeholder-content {
  border-color: var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background);
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Private CSS variables
|----------------------------------------------------------------------------*/

:root {
  --jp-private-cell-scrolling-output-offset: 5px;
}

/*-----------------------------------------------------------------------------
| Cell
|----------------------------------------------------------------------------*/

.jp-Cell {
  padding: var(--jp-cell-padding);
  margin: 0;
  border: none;
  outline: none;
  background: transparent;
}

/*-----------------------------------------------------------------------------
| Common input/output
|----------------------------------------------------------------------------*/

.jp-Cell-inputWrapper,
.jp-Cell-outputWrapper {
  display: flex;
  flex-direction: row;
  padding: 0;
  margin: 0;

  /* Added to reveal the box-shadow on the input and output collapsers. */
  overflow: visible;
}

/* Only input/output areas inside cells */
.jp-Cell-inputArea,
.jp-Cell-outputArea {
  flex: 1 1 auto;
}

/*-----------------------------------------------------------------------------
| Collapser
|----------------------------------------------------------------------------*/

/* Make the output collapser disappear when there is not output, but do so
 * in a manner that leaves it in the layout and preserves its width.
 */
.jp-Cell.jp-mod-noOutputs .jp-Cell-outputCollapser {
  border: none !important;
  background: transparent !important;
}

.jp-Cell:not(.jp-mod-noOutputs) .jp-Cell-outputCollapser {
  min-height: var(--jp-cell-collapser-min-height);
}

/*-----------------------------------------------------------------------------
| Output
|----------------------------------------------------------------------------*/

/* Put a space between input and output when there IS output */
.jp-Cell:not(.jp-mod-noOutputs) .jp-Cell-outputWrapper {
  margin-top: 5px;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea {
  overflow-y: auto;
  max-height: 24em;
  margin-left: var(--jp-private-cell-scrolling-output-offset);
  resize: vertical;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea[style*='height'] {
  max-height: unset;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-Cell-outputArea::after {
  content: ' ';
  box-shadow: inset 0 0 6px 2px rgb(0 0 0 / 30%);
  width: 100%;
  height: 100%;
  position: sticky;
  bottom: 0;
  top: 0;
  margin-top: -50%;
  float: left;
  display: block;
  pointer-events: none;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-child {
  padding-top: 6px;
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-prompt {
  width: calc(
    var(--jp-cell-prompt-width) - var(--jp-private-cell-scrolling-output-offset)
  );
}

.jp-CodeCell.jp-mod-outputsScrolled .jp-OutputArea-promptOverlay {
  left: calc(-1 * var(--jp-private-cell-scrolling-output-offset));
}

/*-----------------------------------------------------------------------------
| CodeCell
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| MarkdownCell
|----------------------------------------------------------------------------*/

.jp-MarkdownOutput {
  display: table-cell;
  width: 100%;
  margin-top: 0;
  margin-bottom: 0;
  padding-left: var(--jp-code-padding);
}

.jp-MarkdownOutput.jp-RenderedHTMLCommon {
  overflow: auto;
}

/* collapseHeadingButton (show always if hiddenCellsButton is _not_ shown) */
.jp-collapseHeadingButton {
  display: flex;
  min-height: var(--jp-cell-collapser-min-height);
  font-size: var(--jp-code-font-size);
  position: absolute;
  background-color: transparent;
  background-size: 25px;
  background-repeat: no-repeat;
  background-position-x: center;
  background-position-y: top;
  background-image: var(--jp-icon-caret-down);
  right: 0;
  top: 0;
  bottom: 0;
}

.jp-collapseHeadingButton.jp-mod-collapsed {
  background-image: var(--jp-icon-caret-right);
}

/*
 set the container font size to match that of content
 so that the nested collapse buttons have the right size
*/
.jp-MarkdownCell .jp-InputPrompt {
  font-size: var(--jp-content-font-size1);
}

/*
  Align collapseHeadingButton with cell top header
  The font sizes are identical to the ones in packages/rendermime/style/base.css
*/
.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='1'] {
  font-size: var(--jp-content-font-size5);
  background-position-y: calc(0.3 * var(--jp-content-font-size5));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='2'] {
  font-size: var(--jp-content-font-size4);
  background-position-y: calc(0.3 * var(--jp-content-font-size4));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='3'] {
  font-size: var(--jp-content-font-size3);
  background-position-y: calc(0.3 * var(--jp-content-font-size3));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='4'] {
  font-size: var(--jp-content-font-size2);
  background-position-y: calc(0.3 * var(--jp-content-font-size2));
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='5'] {
  font-size: var(--jp-content-font-size1);
  background-position-y: top;
}

.jp-mod-rendered .jp-collapseHeadingButton[data-heading-level='6'] {
  font-size: var(--jp-content-font-size0);
  background-position-y: top;
}

/* collapseHeadingButton (show only on (hover,active) if hiddenCellsButton is shown) */
.jp-Notebook.jp-mod-showHiddenCellsButton .jp-collapseHeadingButton {
  display: none;
}

.jp-Notebook.jp-mod-showHiddenCellsButton
  :is(.jp-MarkdownCell:hover, .jp-mod-active)
  .jp-collapseHeadingButton {
  display: flex;
}

/* showHiddenCellsButton (only show if jp-mod-showHiddenCellsButton is set, which
is a consequence of the showHiddenCellsButton option in Notebook Settings)*/
.jp-Notebook.jp-mod-showHiddenCellsButton .jp-showHiddenCellsButton {
  margin-left: calc(var(--jp-cell-prompt-width) + 2 * var(--jp-code-padding));
  margin-top: var(--jp-code-padding);
  border: 1px solid var(--jp-border-color2);
  background-color: var(--jp-border-color3) !important;
  color: var(--jp-content-font-color0) !important;
  display: flex;
}

.jp-Notebook.jp-mod-showHiddenCellsButton .jp-showHiddenCellsButton:hover {
  background-color: var(--jp-border-color2) !important;
}

.jp-showHiddenCellsButton {
  display: none;
}

/*-----------------------------------------------------------------------------
| Printing
|----------------------------------------------------------------------------*/

/*
Using block instead of flex to allow the use of the break-inside CSS property for
cell outputs.
*/

@media print {
  .jp-Cell-inputWrapper,
  .jp-Cell-outputWrapper {
    display: block;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

:root {
  --jp-notebook-toolbar-padding: 2px 5px 2px 2px;
}

/*-----------------------------------------------------------------------------

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-NotebookPanel-toolbar {
  padding: var(--jp-notebook-toolbar-padding);

  /* disable paint containment from lumino 2.0 default strict CSS containment */
  contain: style size !important;
}

.jp-Toolbar-item.jp-Notebook-toolbarCellType .jp-select-wrapper.jp-mod-focused {
  border: none;
  box-shadow: none;
}

.jp-Notebook-toolbarCellTypeDropdown select {
  height: 24px;
  font-size: var(--jp-ui-font-size1);
  line-height: 14px;
  border-radius: 0;
  display: block;
}

.jp-Notebook-toolbarCellTypeDropdown span {
  top: 5px !important;
}

.jp-Toolbar-responsive-popup {
  position: absolute;
  height: fit-content;
  display: flex;
  flex-direction: row;
  flex-wrap: wrap;
  justify-content: flex-end;
  border-bottom: var(--jp-border-width) solid var(--jp-toolbar-border-color);
  box-shadow: var(--jp-toolbar-box-shadow);
  background: var(--jp-toolbar-background);
  min-height: var(--jp-toolbar-micro-height);
  padding: var(--jp-notebook-toolbar-padding);
  z-index: 1;
  right: 0;
  top: 0;
}

.jp-Toolbar > .jp-Toolbar-responsive-opener {
  margin-left: auto;
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Variables
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------

/*-----------------------------------------------------------------------------
| Styles
|----------------------------------------------------------------------------*/

.jp-Notebook-ExecutionIndicator {
  position: relative;
  display: inline-block;
  height: 100%;
  z-index: 9997;
}

.jp-Notebook-ExecutionIndicator-tooltip {
  visibility: hidden;
  height: auto;
  width: max-content;
  width: -moz-max-content;
  background-color: var(--jp-layout-color2);
  color: var(--jp-ui-font-color1);
  text-align: justify;
  border-radius: 6px;
  padding: 0 5px;
  position: fixed;
  display: table;
}

.jp-Notebook-ExecutionIndicator-tooltip.up {
  transform: translateX(-50%) translateY(-100%) translateY(-32px);
}

.jp-Notebook-ExecutionIndicator-tooltip.down {
  transform: translateX(calc(-100% + 16px)) translateY(5px);
}

.jp-Notebook-ExecutionIndicator-tooltip.hidden {
  display: none;
}

.jp-Notebook-ExecutionIndicator:hover .jp-Notebook-ExecutionIndicator-tooltip {
  visibility: visible;
}

.jp-Notebook-ExecutionIndicator span {
  font-size: var(--jp-ui-font-size1);
  font-family: var(--jp-ui-font-family);
  color: var(--jp-ui-font-color1);
  line-height: 24px;
  display: block;
}

.jp-Notebook-ExecutionIndicator-progress-bar {
  display: flex;
  justify-content: center;
  height: 100%;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

/*
 * Execution indicator
 */
.jp-tocItem-content::after {
  content: '';

  /* Must be identical to form a circle */
  width: 12px;
  height: 12px;
  background: none;
  border: none;
  position: absolute;
  right: 0;
}

.jp-tocItem-content[data-running='0']::after {
  border-radius: 50%;
  border: var(--jp-border-width) solid var(--jp-inverse-layout-color3);
  background: none;
}

.jp-tocItem-content[data-running='1']::after {
  border-radius: 50%;
  border: var(--jp-border-width) solid var(--jp-inverse-layout-color3);
  background-color: var(--jp-inverse-layout-color3);
}

.jp-tocItem-content[data-running='0'],
.jp-tocItem-content[data-running='1'] {
  margin-right: 12px;
}

/*
 * Copyright (c) Jupyter Development Team.
 * Distributed under the terms of the Modified BSD License.
 */

.jp-Notebook-footer {
  height: 27px;
  margin-left: calc(
    var(--jp-cell-prompt-width) + var(--jp-cell-collapser-width) +
      var(--jp-cell-padding)
  );
  width: calc(
    100% -
      (
        var(--jp-cell-prompt-width) + var(--jp-cell-collapser-width) +
          var(--jp-cell-padding) + var(--jp-cell-padding)
      )
  );
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  color: var(--jp-ui-font-color3);
  margin-top: 6px;
  background: none;
  cursor: pointer;
}

.jp-Notebook-footer:focus {
  border-color: var(--jp-cell-editor-active-border-color);
}

/* For devices that support hovering, hide footer until hover */
@media (hover: hover) {
  .jp-Notebook-footer {
    opacity: 0;
  }

  .jp-Notebook-footer:focus,
  .jp-Notebook-footer:hover {
    opacity: 1;
  }
}

/*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| Imports
|----------------------------------------------------------------------------*/

/*-----------------------------------------------------------------------------
| CSS variables
|----------------------------------------------------------------------------*/

:root {
  --jp-side-by-side-output-size: 1fr;
  --jp-side-by-side-resized-cell: var(--jp-side-by-side-output-size);
  --jp-private-notebook-dragImage-width: 304px;
  --jp-private-notebook-dragImage-height: 36px;
  --jp-private-notebook-selected-color: var(--md-blue-400);
  --jp-private-notebook-active-color: var(--md-green-400);
}

/*-----------------------------------------------------------------------------
| Notebook
|----------------------------------------------------------------------------*/

/* stylelint-disable selector-max-class */

.jp-NotebookPanel {
  display: block;
  height: 100%;
}

.jp-NotebookPanel.jp-Document {
  min-width: 240px;
  min-height: 120px;
}

.jp-Notebook {
  padding: var(--jp-notebook-padding);
  outline: none;
  overflow: auto;
  background: var(--jp-layout-color0);
}

.jp-Notebook.jp-mod-scrollPastEnd::after {
  display: block;
  content: '';
  min-height: var(--jp-notebook-scroll-padding);
}

.jp-MainAreaWidget-ContainStrict .jp-Notebook * {
  contain: strict;
}

.jp-Notebook .jp-Cell {
  overflow: visible;
}

.jp-Notebook .jp-Cell .jp-InputPrompt {
  cursor: move;
}

/*-----------------------------------------------------------------------------
| Notebook state related styling
|
| The notebook and cells each have states, here are the possibilities:
|
| - Notebook
|   - Command
|   - Edit
| - Cell
|   - None
|   - Active (only one can be active)
|   - Selected (the cells actions are applied to)
|   - Multiselected (when multiple selected, the cursor)
|   - No outputs
|----------------------------------------------------------------------------*/

/* Command or edit modes */

.jp-Notebook .jp-Cell:not(.jp-mod-active) .jp-InputPrompt {
  opacity: var(--jp-cell-prompt-not-active-opacity);
  color: var(--jp-cell-prompt-not-active-font-color);
}

.jp-Notebook .jp-Cell:not(.jp-mod-active) .jp-OutputPrompt {
  opacity: var(--jp-cell-prompt-not-active-opacity);
  color: var(--jp-cell-prompt-not-active-font-color);
}

/* cell is active */
.jp-Notebook .jp-Cell.jp-mod-active .jp-Collapser {
  background: var(--jp-brand-color1);
}

/* cell is dirty */
.jp-Notebook .jp-Cell.jp-mod-dirty .jp-InputPrompt {
  color: var(--jp-warn-color1);
}

.jp-Notebook .jp-Cell.jp-mod-dirty .jp-InputPrompt::before {
  color: var(--jp-warn-color1);
  content: '•';
}

.jp-Notebook .jp-Cell.jp-mod-active.jp-mod-dirty .jp-Collapser {
  background: var(--jp-warn-color1);
}

/* collapser is hovered */
.jp-Notebook .jp-Cell .jp-Collapser:hover {
  box-shadow: var(--jp-elevation-z2);
  background: var(--jp-brand-color1);
  opacity: var(--jp-cell-collapser-not-active-hover-opacity);
}

/* cell is active and collapser is hovered */
.jp-Notebook .jp-Cell.jp-mod-active .jp-Collapser:hover {
  background: var(--jp-brand-color0);
  opacity: 1;
}

/* Command mode */

.jp-Notebook.jp-mod-commandMode .jp-Cell.jp-mod-selected {
  background: var(--jp-notebook-multiselected-color);
}

.jp-Notebook.jp-mod-commandMode
  .jp-Cell.jp-mod-active.jp-mod-selected:not(.jp-mod-multiSelected) {
  background: transparent;
}

/* Edit mode */

.jp-Notebook.jp-mod-editMode .jp-Cell.jp-mod-active .jp-InputArea-editor {
  border: var(--jp-border-width) solid var(--jp-cell-editor-active-border-color);
  box-shadow: var(--jp-input-box-shadow);
  background-color: var(--jp-cell-editor-active-background);
}

/*-----------------------------------------------------------------------------
| Notebook drag and drop
|----------------------------------------------------------------------------*/

.jp-Notebook-cell.jp-mod-dropSource {
  opacity: 0.5;
}

.jp-Notebook-cell.jp-mod-dropTarget,
.jp-Notebook.jp-mod-commandMode
  .jp-Notebook-cell.jp-mod-active.jp-mod-selected.jp-mod-dropTarget {
  border-top-color: var(--jp-private-notebook-selected-color);
  border-top-style: solid;
  border-top-width: 2px;
}

.jp-dragImage {
  display: block;
  flex-direction: row;
  width: var(--jp-private-notebook-dragImage-width);
  height: var(--jp-private-notebook-dragImage-height);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background);
  overflow: visible;
}

.jp-dragImage-singlePrompt {
  box-shadow: 2px 2px 4px 0 rgba(0, 0, 0, 0.12);
}

.jp-dragImage .jp-dragImage-content {
  flex: 1 1 auto;
  z-index: 2;
  font-size: var(--jp-code-font-size);
  font-family: var(--jp-code-font-family);
  line-height: var(--jp-code-line-height);
  padding: var(--jp-code-padding);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  background: var(--jp-cell-editor-background-color);
  color: var(--jp-content-font-color3);
  text-align: left;
  margin: 4px 4px 4px 0;
}

.jp-dragImage .jp-dragImage-prompt {
  flex: 0 0 auto;
  min-width: 36px;
  color: var(--jp-cell-inprompt-font-color);
  padding: var(--jp-code-padding);
  padding-left: 12px;
  font-family: var(--jp-cell-prompt-font-family);
  letter-spacing: var(--jp-cell-prompt-letter-spacing);
  line-height: 1.9;
  font-size: var(--jp-code-font-size);
  border: var(--jp-border-width) solid transparent;
}

.jp-dragImage-multipleBack {
  z-index: -1;
  position: absolute;
  height: 32px;
  width: 300px;
  top: 8px;
  left: 8px;
  background: var(--jp-layout-color2);
  border: var(--jp-border-width) solid var(--jp-input-border-color);
  box-shadow: 2px 2px 4px 0 rgba(0, 0, 0, 0.12);
}

/*-----------------------------------------------------------------------------
| Cell toolbar
|----------------------------------------------------------------------------*/

.jp-NotebookTools {
  display: block;
  min-width: var(--jp-sidebar-min-width);
  color: var(--jp-ui-font-color1);
  background: var(--jp-layout-color1);

  /* This is needed so that all font sizing of children done in ems is
    * relative to this base size */
  font-size: var(--jp-ui-font-size1);
  overflow: auto;
}

.jp-ActiveCellTool {
  padding: 12px 0;
  display: flex;
}

.jp-ActiveCellTool-Content {
  flex: 1 1 auto;
}

.jp-ActiveCellTool .jp-ActiveCellTool-CellContent {
  background: var(--jp-cell-editor-background);
  border: var(--jp-border-width) solid var(--jp-cell-editor-border-color);
  border-radius: 0;
  min-height: 29px;
}

.jp-ActiveCellTool .jp-InputPrompt {
  min-width: calc(var(--jp-cell-prompt-width) * 0.75);
}

.jp-ActiveCellTool-CellContent > pre {
  padding: 5px 4px;
  margin: 0;
  white-space: normal;
}

.jp-MetadataEditorTool {
  flex-direction: column;
  padding: 12px 0;
}

.jp-RankedPanel > :not(:first-child) {
  margin-top: 12px;
}

.jp-KeySelector select.jp-mod-styled {
  font-size: var(--jp-ui-font-size1);
  color: var(--jp-ui-font-color0);
  border: var(--jp-border-width) solid var(--jp-border-color1);
}

.jp-KeySelector label,
.jp-MetadataEditorTool label,
.jp-NumberSetter label {
  line-height: 1.4;
}

.jp-NotebookTools .jp-select-wrapper {
  margin-top: 4px;
  margin-bottom: 0;
}

.jp-NumberSetter input {
  width: 100%;
  margin-top: 4px;
}

.jp-NotebookTools .jp-Collapse {
  margin-top: 16px;
}

/*-----------------------------------------------------------------------------
| Presentation Mode (.jp-mod-presentationMode)
|----------------------------------------------------------------------------*/

.jp-mod-presentationMode .jp-Notebook {
  --jp-content-font-size1: var(--jp-content-presentation-font-size1);
  --jp-code-font-size: var(--jp-code-presentation-font-size);
}

.jp-mod-presentationMode .jp-Notebook .jp-Cell .jp-InputPrompt,
.jp-mod-presentationMode .jp-Notebook .jp-Cell .jp-OutputPrompt {
  flex: 0 0 110px;
}

/*-----------------------------------------------------------------------------
| Side-by-side Mode (.jp-mod-sideBySide)
|----------------------------------------------------------------------------*/
.jp-mod-sideBySide.jp-Notebook .jp-Notebook-cell {
  margin-top: 3em;
  margin-bottom: 3em;
  margin-left: 5%;
  margin-right: 5%;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell {
  display: grid;
  grid-template-columns: minmax(0, 1fr) min-content minmax(
      0,
      var(--jp-side-by-side-output-size)
    );
  grid-template-rows: auto minmax(0, 1fr) auto;
  grid-template-areas:
    'header header header'
    'input handle output'
    'footer footer footer';
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell.jp-mod-resizedCell {
  grid-template-columns: minmax(0, 1fr) min-content minmax(
      0,
      var(--jp-side-by-side-resized-cell)
    );
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellHeader {
  grid-area: header;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-Cell-inputWrapper {
  grid-area: input;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-Cell-outputWrapper {
  /* overwrite the default margin (no vertical separation needed in side by side move */
  margin-top: 0;
  grid-area: output;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellFooter {
  grid-area: footer;
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellResizeHandle {
  grid-area: handle;
  user-select: none;
  display: block;
  height: 100%;
  cursor: ew-resize;
  padding: 0 var(--jp-cell-padding);
}

.jp-mod-sideBySide.jp-Notebook .jp-CodeCell .jp-CellResizeHandle::after {
  content: '';
  display: block;
  background: var(--jp-border-color2);
  height: 100%;
  width: 5px;
}

.jp-mod-sideBySide.jp-Notebook
  .jp-CodeCell.jp-mod-resizedCell
  .jp-CellResizeHandle::after {
  background: var(--jp-border-color0);
}

.jp-CellResizeHandle {
  display: none;
}

/*-----------------------------------------------------------------------------
| Placeholder
|----------------------------------------------------------------------------*/

.jp-Cell-Placeholder {
  padding-left: 55px;
}

.jp-Cell-Placeholder-wrapper {
  background: #fff;
  border: 1px solid;
  border-color: #e5e6e9 #dfe0e4 #d0d1d5;
  border-radius: 4px;
  -webkit-border-radius: 4px;
  margin: 10px 15px;
}

.jp-Cell-Placeholder-wrapper-inner {
  padding: 15px;
  position: relative;
}

.jp-Cell-Placeholder-wrapper-body {
  background-repeat: repeat;
  background-size: 50% auto;
}

.jp-Cell-Placeholder-wrapper-body div {
  background: #f6f7f8;
  background-image: -webkit-linear-gradient(
    left,
    #f6f7f8 0%,
    #edeef1 20%,
    #f6f7f8 40%,
    #f6f7f8 100%
  );
  background-repeat: no-repeat;
  background-size: 800px 104px;
  height: 104px;
  position: absolute;
  right: 15px;
  left: 15px;
  top: 15px;
}

div.jp-Cell-Placeholder-h1 {
  top: 20px;
  height: 20px;
  left: 15px;
  width: 150px;
}

div.jp-Cell-Placeholder-h2 {
  left: 15px;
  top: 50px;
  height: 10px;
  width: 100px;
}

div.jp-Cell-Placeholder-content-1,
div.jp-Cell-Placeholder-content-2,
div.jp-Cell-Placeholder-content-3 {
  left: 15px;
  right: 15px;
  height: 10px;
}

div.jp-Cell-Placeholder-content-1 {
  top: 100px;
}

div.jp-Cell-Placeholder-content-2 {
  top: 120px;
}

div.jp-Cell-Placeholder-content-3 {
  top: 140px;
}
  </style>
  <style type="text/css">
   /*-----------------------------------------------------------------------------
| Copyright (c) Jupyter Development Team.
| Distributed under the terms of the Modified BSD License.
|----------------------------------------------------------------------------*/

/*
The following CSS variables define the main, public API for styling JupyterLab.
These variables should be used by all plugins wherever possible. In other
words, plugins should not define custom colors, sizes, etc unless absolutely
necessary. This enables users to change the visual theme of JupyterLab
by changing these variables.

Many variables appear in an ordered sequence (0,1,2,3). These sequences
are designed to work well together, so for example, `--jp-border-color1` should
be used with `--jp-layout-color1`. The numbers have the following meanings:

* 0: super-primary, reserved for special emphasis
* 1: primary, most important under normal situations
* 2: secondary, next most important under normal situations
* 3: tertiary, next most important under normal situations

Throughout JupyterLab, we are mostly following principles from Google's
Material Design when selecting colors. We are not, however, following
all of MD as it is not optimized for dense, information rich UIs.
*/

:root {
  /* Elevation
   *
   * We style box-shadows using Material Design's idea of elevation. These particular numbers are taken from here:
   *
   * https://github.com/material-components/material-components-web
   * https://material-components-web.appspot.com/elevation.html
   */

  --jp-shadow-base-lightness: 0;
  --jp-shadow-umbra-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.2
  );
  --jp-shadow-penumbra-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.14
  );
  --jp-shadow-ambient-color: rgba(
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    var(--jp-shadow-base-lightness),
    0.12
  );
  --jp-elevation-z0: none;
  --jp-elevation-z1: 0 2px 1px -1px var(--jp-shadow-umbra-color),
    0 1px 1px 0 var(--jp-shadow-penumbra-color),
    0 1px 3px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z2: 0 3px 1px -2px var(--jp-shadow-umbra-color),
    0 2px 2px 0 var(--jp-shadow-penumbra-color),
    0 1px 5px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z4: 0 2px 4px -1px var(--jp-shadow-umbra-color),
    0 4px 5px 0 var(--jp-shadow-penumbra-color),
    0 1px 10px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z6: 0 3px 5px -1px var(--jp-shadow-umbra-color),
    0 6px 10px 0 var(--jp-shadow-penumbra-color),
    0 1px 18px 0 var(--jp-shadow-ambient-color);
  --jp-elevation-z8: 0 5px 5px -3px var(--jp-shadow-umbra-color),
    0 8px 10px 1px var(--jp-shadow-penumbra-color),
    0 3px 14px 2px var(--jp-shadow-ambient-color);
  --jp-elevation-z12: 0 7px 8px -4px var(--jp-shadow-umbra-color),
    0 12px 17px 2px var(--jp-shadow-penumbra-color),
    0 5px 22px 4px var(--jp-shadow-ambient-color);
  --jp-elevation-z16: 0 8px 10px -5px var(--jp-shadow-umbra-color),
    0 16px 24px 2px var(--jp-shadow-penumbra-color),
    0 6px 30px 5px var(--jp-shadow-ambient-color);
  --jp-elevation-z20: 0 10px 13px -6px var(--jp-shadow-umbra-color),
    0 20px 31px 3px var(--jp-shadow-penumbra-color),
    0 8px 38px 7px var(--jp-shadow-ambient-color);
  --jp-elevation-z24: 0 11px 15px -7px var(--jp-shadow-umbra-color),
    0 24px 38px 3px var(--jp-shadow-penumbra-color),
    0 9px 46px 8px var(--jp-shadow-ambient-color);

  /* Borders
   *
   * The following variables, specify the visual styling of borders in JupyterLab.
   */

  --jp-border-width: 1px;
  --jp-border-color0: var(--md-grey-400);
  --jp-border-color1: var(--md-grey-400);
  --jp-border-color2: var(--md-grey-300);
  --jp-border-color3: var(--md-grey-200);
  --jp-inverse-border-color: var(--md-grey-600);
  --jp-border-radius: 2px;

  /* UI Fonts
   *
   * The UI font CSS variables are used for the typography all of the JupyterLab
   * user interface elements that are not directly user generated content.
   *
   * The font sizing here is done assuming that the body font size of --jp-ui-font-size1
   * is applied to a parent element. When children elements, such as headings, are sized
   * in em all things will be computed relative to that body size.
   */

  --jp-ui-font-scale-factor: 1.2;
  --jp-ui-font-size0: 0.83333em;
  --jp-ui-font-size1: 13px; /* Base font size */
  --jp-ui-font-size2: 1.2em;
  --jp-ui-font-size3: 1.44em;
  --jp-ui-font-family: system-ui, -apple-system, blinkmacsystemfont, 'Segoe UI',
    helvetica, arial, sans-serif, 'Apple Color Emoji', 'Segoe UI Emoji',
    'Segoe UI Symbol';

  /*
   * Use these font colors against the corresponding main layout colors.
   * In a light theme, these go from dark to light.
   */

  /* Defaults use Material Design specification */
  --jp-ui-font-color0: rgba(0, 0, 0, 1);
  --jp-ui-font-color1: rgba(0, 0, 0, 0.87);
  --jp-ui-font-color2: rgba(0, 0, 0, 0.54);
  --jp-ui-font-color3: rgba(0, 0, 0, 0.38);

  /*
   * Use these against the brand/accent/warn/error colors.
   * These will typically go from light to darker, in both a dark and light theme.
   */

  --jp-ui-inverse-font-color0: rgba(255, 255, 255, 1);
  --jp-ui-inverse-font-color1: rgba(255, 255, 255, 1);
  --jp-ui-inverse-font-color2: rgba(255, 255, 255, 0.7);
  --jp-ui-inverse-font-color3: rgba(255, 255, 255, 0.5);

  /* Content Fonts
   *
   * Content font variables are used for typography of user generated content.
   *
   * The font sizing here is done assuming that the body font size of --jp-content-font-size1
   * is applied to a parent element. When children elements, such as headings, are sized
   * in em all things will be computed relative to that body size.
   */

  --jp-content-line-height: 1.6;
  --jp-content-font-scale-factor: 1.2;
  --jp-content-font-size0: 0.83333em;
  --jp-content-font-size1: 14px; /* Base font size */
  --jp-content-font-size2: 1.2em;
  --jp-content-font-size3: 1.44em;
  --jp-content-font-size4: 1.728em;
  --jp-content-font-size5: 2.0736em;

  /* This gives a magnification of about 125% in presentation mode over normal. */
  --jp-content-presentation-font-size1: 17px;
  --jp-content-heading-line-height: 1;
  --jp-content-heading-margin-top: 1.2em;
  --jp-content-heading-margin-bottom: 0.8em;
  --jp-content-heading-font-weight: 500;

  /* Defaults use Material Design specification */
  --jp-content-font-color0: rgba(0, 0, 0, 1);
  --jp-content-font-color1: rgba(0, 0, 0, 0.87);
  --jp-content-font-color2: rgba(0, 0, 0, 0.54);
  --jp-content-font-color3: rgba(0, 0, 0, 0.38);
  --jp-content-link-color: var(--md-blue-900);
  --jp-content-font-family: system-ui, -apple-system, blinkmacsystemfont,
    'Segoe UI', helvetica, arial, sans-serif, 'Apple Color Emoji',
    'Segoe UI Emoji', 'Segoe UI Symbol';

  /*
   * Code Fonts
   *
   * Code font variables are used for typography of code and other monospaces content.
   */

  --jp-code-font-size: 13px;
  --jp-code-line-height: 1.3077; /* 17px for 13px base */
  --jp-code-padding: 5px; /* 5px for 13px base, codemirror highlighting needs integer px value */
  --jp-code-font-family-default: menlo, consolas, 'DejaVu Sans Mono', monospace;
  --jp-code-font-family: var(--jp-code-font-family-default);

  /* This gives a magnification of about 125% in presentation mode over normal. */
  --jp-code-presentation-font-size: 16px;

  /* may need to tweak cursor width if you change font size */
  --jp-code-cursor-width0: 1.4px;
  --jp-code-cursor-width1: 2px;
  --jp-code-cursor-width2: 4px;

  /* Layout
   *
   * The following are the main layout colors use in JupyterLab. In a light
   * theme these would go from light to dark.
   */

  --jp-layout-color0: white;
  --jp-layout-color1: white;
  --jp-layout-color2: var(--md-grey-200);
  --jp-layout-color3: var(--md-grey-400);
  --jp-layout-color4: var(--md-grey-600);

  /* Inverse Layout
   *
   * The following are the inverse layout colors use in JupyterLab. In a light
   * theme these would go from dark to light.
   */

  --jp-inverse-layout-color0: #111;
  --jp-inverse-layout-color1: var(--md-grey-900);
  --jp-inverse-layout-color2: var(--md-grey-800);
  --jp-inverse-layout-color3: var(--md-grey-700);
  --jp-inverse-layout-color4: var(--md-grey-600);

  /* Brand/accent */

  --jp-brand-color0: var(--md-blue-900);
  --jp-brand-color1: var(--md-blue-700);
  --jp-brand-color2: var(--md-blue-300);
  --jp-brand-color3: var(--md-blue-100);
  --jp-brand-color4: var(--md-blue-50);
  --jp-accent-color0: var(--md-green-900);
  --jp-accent-color1: var(--md-green-700);
  --jp-accent-color2: var(--md-green-300);
  --jp-accent-color3: var(--md-green-100);

  /* State colors (warn, error, success, info) */

  --jp-warn-color0: var(--md-orange-900);
  --jp-warn-color1: var(--md-orange-700);
  --jp-warn-color2: var(--md-orange-300);
  --jp-warn-color3: var(--md-orange-100);
  --jp-error-color0: var(--md-red-900);
  --jp-error-color1: var(--md-red-700);
  --jp-error-color2: var(--md-red-300);
  --jp-error-color3: var(--md-red-100);
  --jp-success-color0: var(--md-green-900);
  --jp-success-color1: var(--md-green-700);
  --jp-success-color2: var(--md-green-300);
  --jp-success-color3: var(--md-green-100);
  --jp-info-color0: var(--md-cyan-900);
  --jp-info-color1: var(--md-cyan-700);
  --jp-info-color2: var(--md-cyan-300);
  --jp-info-color3: var(--md-cyan-100);

  /* Cell specific styles */

  --jp-cell-padding: 5px;
  --jp-cell-collapser-width: 8px;
  --jp-cell-collapser-min-height: 20px;
  --jp-cell-collapser-not-active-hover-opacity: 0.6;
  --jp-cell-editor-background: var(--md-grey-100);
  --jp-cell-editor-border-color: var(--md-grey-300);
  --jp-cell-editor-box-shadow: inset 0 0 2px var(--md-blue-300);
  --jp-cell-editor-active-background: var(--jp-layout-color0);
  --jp-cell-editor-active-border-color: var(--jp-brand-color1);
  --jp-cell-prompt-width: 64px;
  --jp-cell-prompt-font-family: var(--jp-code-font-family-default);
  --jp-cell-prompt-letter-spacing: 0;
  --jp-cell-prompt-opacity: 1;
  --jp-cell-prompt-not-active-opacity: 0.5;
  --jp-cell-prompt-not-active-font-color: var(--md-grey-700);

  /* A custom blend of MD grey and blue 600
   * See https://meyerweb.com/eric/tools/color-blend/#546E7A:1E88E5:5:hex */
  --jp-cell-inprompt-font-color: #307fc1;

  /* A custom blend of MD grey and orange 600
   * https://meyerweb.com/eric/tools/color-blend/#546E7A:F4511E:5:hex */
  --jp-cell-outprompt-font-color: #bf5b3d;

  /* Notebook specific styles */

  --jp-notebook-padding: 10px;
  --jp-notebook-select-background: var(--jp-layout-color1);
  --jp-notebook-multiselected-color: var(--md-blue-50);

  /* The scroll padding is calculated to fill enough space at the bottom of the
  notebook to show one single-line cell (with appropriate padding) at the top
  when the notebook is scrolled all the way to the bottom. We also subtract one
  pixel so that no scrollbar appears if we have just one single-line cell in the
  notebook. This padding is to enable a 'scroll past end' feature in a notebook.
  */
  --jp-notebook-scroll-padding: calc(
    100% - var(--jp-code-font-size) * var(--jp-code-line-height) -
      var(--jp-code-padding) - var(--jp-cell-padding) - 1px
  );

  /* Rendermime styles */

  --jp-rendermime-error-background: #fdd;
  --jp-rendermime-table-row-background: var(--md-grey-100);
  --jp-rendermime-table-row-hover-background: var(--md-light-blue-50);

  /* Dialog specific styles */

  --jp-dialog-background: rgba(0, 0, 0, 0.25);

  /* Console specific styles */

  --jp-console-padding: 10px;

  /* Toolbar specific styles */

  --jp-toolbar-border-color: var(--jp-border-color1);
  --jp-toolbar-micro-height: 8px;
  --jp-toolbar-background: var(--jp-layout-color1);
  --jp-toolbar-box-shadow: 0 0 2px 0 rgba(0, 0, 0, 0.24);
  --jp-toolbar-header-margin: 4px 4px 0 4px;
  --jp-toolbar-active-background: var(--md-grey-300);

  /* Statusbar specific styles */

  --jp-statusbar-height: 24px;

  /* Input field styles */

  --jp-input-box-shadow: inset 0 0 2px var(--md-blue-300);
  --jp-input-active-background: var(--jp-layout-color1);
  --jp-input-hover-background: var(--jp-layout-color1);
  --jp-input-background: var(--md-grey-100);
  --jp-input-border-color: var(--jp-inverse-border-color);
  --jp-input-active-border-color: var(--jp-brand-color1);
  --jp-input-active-box-shadow-color: rgba(19, 124, 189, 0.3);

  /* General editor styles */

  --jp-editor-selected-background: #d9d9d9;
  --jp-editor-selected-focused-background: #d7d4f0;
  --jp-editor-cursor-color: var(--jp-ui-font-color0);

  /* Code mirror specific styles */

  --jp-mirror-editor-keyword-color: #008000;
  --jp-mirror-editor-atom-color: #88f;
  --jp-mirror-editor-number-color: #080;
  --jp-mirror-editor-def-color: #00f;
  --jp-mirror-editor-variable-color: var(--md-grey-900);
  --jp-mirror-editor-variable-2-color: rgb(0, 54, 109);
  --jp-mirror-editor-variable-3-color: #085;
  --jp-mirror-editor-punctuation-color: #05a;
  --jp-mirror-editor-property-color: #05a;
  --jp-mirror-editor-operator-color: #a2f;
  --jp-mirror-editor-comment-color: #408080;
  --jp-mirror-editor-string-color: #ba2121;
  --jp-mirror-editor-string-2-color: #708;
  --jp-mirror-editor-meta-color: #a2f;
  --jp-mirror-editor-qualifier-color: #555;
  --jp-mirror-editor-builtin-color: #008000;
  --jp-mirror-editor-bracket-color: #997;
  --jp-mirror-editor-tag-color: #170;
  --jp-mirror-editor-attribute-color: #00c;
  --jp-mirror-editor-header-color: blue;
  --jp-mirror-editor-quote-color: #090;
  --jp-mirror-editor-link-color: #00c;
  --jp-mirror-editor-error-color: #f00;
  --jp-mirror-editor-hr-color: #999;

  /*
    RTC user specific colors.
    These colors are used for the cursor, username in the editor,
    and the icon of the user.
  */

  --jp-collaborator-color1: #ffad8e;
  --jp-collaborator-color2: #dac83d;
  --jp-collaborator-color3: #72dd76;
  --jp-collaborator-color4: #00e4d0;
  --jp-collaborator-color5: #45d4ff;
  --jp-collaborator-color6: #e2b1ff;
  --jp-collaborator-color7: #ff9de6;

  /* Vega extension styles */

  --jp-vega-background: white;

  /* Sidebar-related styles */

  --jp-sidebar-min-width: 250px;

  /* Search-related styles */

  --jp-search-toggle-off-opacity: 0.5;
  --jp-search-toggle-hover-opacity: 0.8;
  --jp-search-toggle-on-opacity: 1;
  --jp-search-selected-match-background-color: rgb(245, 200, 0);
  --jp-search-selected-match-color: black;
  --jp-search-unselected-match-background-color: var(
    --jp-inverse-layout-color0
  );
  --jp-search-unselected-match-color: var(--jp-ui-inverse-font-color0);

  /* Icon colors that work well with light or dark backgrounds */
  --jp-icon-contrast-color0: var(--md-purple-600);
  --jp-icon-contrast-color1: var(--md-green-600);
  --jp-icon-contrast-color2: var(--md-pink-600);
  --jp-icon-contrast-color3: var(--md-blue-600);

  /* Button colors */
  --jp-accept-color-normal: var(--md-blue-700);
  --jp-accept-color-hover: var(--md-blue-800);
  --jp-accept-color-active: var(--md-blue-900);
  --jp-warn-color-normal: var(--md-red-700);
  --jp-warn-color-hover: var(--md-red-800);
  --jp-warn-color-active: var(--md-red-900);
  --jp-reject-color-normal: var(--md-grey-600);
  --jp-reject-color-hover: var(--md-grey-700);
  --jp-reject-color-active: var(--md-grey-800);

  /* File or activity icons and switch semantic variables */
  --jp-jupyter-icon-color: #f37626;
  --jp-notebook-icon-color: #f37626;
  --jp-json-icon-color: var(--md-orange-700);
  --jp-console-icon-background-color: var(--md-blue-700);
  --jp-console-icon-color: white;
  --jp-terminal-icon-background-color: var(--md-grey-800);
  --jp-terminal-icon-color: var(--md-grey-200);
  --jp-text-editor-icon-color: var(--md-grey-700);
  --jp-inspector-icon-color: var(--md-grey-700);
  --jp-switch-color: var(--md-grey-400);
  --jp-switch-true-position-color: var(--md-orange-900);
}
  </style>
  <style type="text/css">
   /* Force rendering true colors when outputing to pdf */
* {
  -webkit-print-color-adjust: exact;
}

/* Misc */
a.anchor-link {
  display: none;
}

/* Input area styling */
.jp-InputArea {
  overflow: hidden;
}

.jp-InputArea-editor {
  overflow: hidden;
}

.cm-editor.cm-s-jupyter .highlight pre {
/* weird, but --jp-code-padding defined to be 5px but 4px horizontal padding is hardcoded for pre.cm-line */
  padding: var(--jp-code-padding) 4px;
  margin: 0;

  font-family: inherit;
  font-size: inherit;
  line-height: inherit;
  color: inherit;

}

.jp-OutputArea-output pre {
  line-height: inherit;
  font-family: inherit;
}

.jp-RenderedText pre {
  color: var(--jp-content-font-color1);
  font-size: var(--jp-code-font-size);
}

/* Hiding the collapser by default */
.jp-Collapser {
  display: none;
}

@page {
    margin: 0.5in; /* Margin for each printed piece of paper */
}

@media print {
  .jp-Cell-inputWrapper,
  .jp-Cell-outputWrapper {
    display: block;
  }
}
  </style>
  <!-- Load mathjax -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.7/latest.js?config=TeX-AMS_CHTML-full,Safe">
  </script>
  <!-- MathJax configuration -->
  <script type="text/x-mathjax-config">
   init_mathjax = function() {
        if (window.MathJax) {
        // MathJax loaded
            MathJax.Hub.Config({
                TeX: {
                    equationNumbers: {
                    autoNumber: "AMS",
                    useLabelIds: true
                    }
                },
                tex2jax: {
                    inlineMath: [ ['$','$'], ["\\(","\\)"] ],
                    displayMath: [ ['$$','$$'], ["\\[","\\]"] ],
                    processEscapes: true,
                    processEnvironments: true
                },
                displayAlign: 'center',
                CommonHTML: {
                    linebreaks: {
                    automatic: true
                    }
                }
            });

            MathJax.Hub.Queue(["Typeset", MathJax.Hub]);
        }
    }
    init_mathjax();
  </script>
  <!-- End of mathjax configuration -->
  <style>
   .jp-Mermaid:not(.jp-RenderedMermaid) {
    display: none;
  }

  .jp-RenderedMermaid {
    overflow: auto;
    display: flex;
  }

  .jp-RenderedMermaid.jp-mod-warning {
    width: auto;
    padding: 0.5em;
    margin-top: 0.5em;
    border: var(--jp-border-width) solid var(--jp-warn-color2);
    border-radius: var(--jp-border-radius);
    color: var(--jp-ui-font-color1);
    font-size: var(--jp-ui-font-size1);
    white-space: pre-wrap;
    word-wrap: break-word;
  }

  .jp-RenderedMermaid figure {
    margin: 0;
    overflow: auto;
    max-width: 100%;
  }

  .jp-RenderedMermaid img {
    max-width: 100%;
  }

  .jp-RenderedMermaid-Details > pre {
    margin-top: 1em;
  }

  .jp-RenderedMermaid-Summary {
    color: var(--jp-warn-color2);
  }

  .jp-RenderedMermaid:not(.jp-mod-warning) pre {
    display: none;
  }

  .jp-RenderedMermaid-Summary > pre {
    display: inline-block;
    white-space: normal;
  }
  </style>
  <!-- End of mermaid configuration -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.1.10/require.min.js">
  </script>
  <style type="text/css">
   pre { line-height: 125%; }
td.linenos .normal { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
span.linenos { color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px; }
td.linenos .special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
span.linenos.special { color: #000000; background-color: #ffffc0; padding-left: 5px; padding-right: 5px; }
.highlight .hll { background-color: var(--jp-cell-editor-active-background) }
.highlight { background: var(--jp-cell-editor-background); color: var(--jp-mirror-editor-variable-color) }
.highlight .c { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment */
.highlight .err { color: var(--jp-mirror-editor-error-color) } /* Error */
.highlight .k { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword */
.highlight .o { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator */
.highlight .p { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation */
.highlight .ch { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Hashbang */
.highlight .cm { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Multiline */
.highlight .cp { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Preproc */
.highlight .cpf { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.PreprocFile */
.highlight .c1 { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Single */
.highlight .cs { color: var(--jp-mirror-editor-comment-color); font-style: italic } /* Comment.Special */
.highlight .kc { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Constant */
.highlight .kd { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Declaration */
.highlight .kn { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Namespace */
.highlight .kp { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Pseudo */
.highlight .kr { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Reserved */
.highlight .kt { color: var(--jp-mirror-editor-keyword-color); font-weight: bold } /* Keyword.Type */
.highlight .m { color: var(--jp-mirror-editor-number-color) } /* Literal.Number */
.highlight .s { color: var(--jp-mirror-editor-string-color) } /* Literal.String */
.highlight .ow { color: var(--jp-mirror-editor-operator-color); font-weight: bold } /* Operator.Word */
.highlight .pm { color: var(--jp-mirror-editor-punctuation-color) } /* Punctuation.Marker */
.highlight .w { color: var(--jp-mirror-editor-variable-color) } /* Text.Whitespace */
.highlight .mb { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Bin */
.highlight .mf { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Float */
.highlight .mh { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Hex */
.highlight .mi { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer */
.highlight .mo { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Oct */
.highlight .sa { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Affix */
.highlight .sb { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Backtick */
.highlight .sc { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Char */
.highlight .dl { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Delimiter */
.highlight .sd { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Doc */
.highlight .s2 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Double */
.highlight .se { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Escape */
.highlight .sh { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Heredoc */
.highlight .si { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Interpol */
.highlight .sx { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Other */
.highlight .sr { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Regex */
.highlight .s1 { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Single */
.highlight .ss { color: var(--jp-mirror-editor-string-color) } /* Literal.String.Symbol */
.highlight .il { color: var(--jp-mirror-editor-number-color) } /* Literal.Number.Integer.Long */
  </style>
  <script type="module">
   document.addEventListener("DOMContentLoaded", async () => {
    const diagrams = document.querySelectorAll(".jp-Mermaid > pre.mermaid");
    // do not load mermaidjs if not needed
    if (!diagrams.length) {
      return;
    }
    const mermaid = (await import("https://cdnjs.cloudflare.com/ajax/libs/mermaid/10.7.0/mermaid.esm.min.mjs")).default;
    const parser = new DOMParser();

    mermaid.initialize({
      maxTextSize: 100000,
      maxEdges: 100000,
      startOnLoad: false,
      fontFamily: window
        .getComputedStyle(document.body)
        .getPropertyValue("--jp-ui-font-family"),
      theme: document.querySelector("body[data-jp-theme-light='true']")
        ? "default"
        : "dark",
    });

    let _nextMermaidId = 0;

    function makeMermaidImage(svg) {
      const img = document.createElement("img");
      const doc = parser.parseFromString(svg, "image/svg+xml");
      const svgEl = doc.querySelector("svg");
      const { maxWidth } = svgEl?.style || {};
      const firstTitle = doc.querySelector("title");
      const firstDesc = doc.querySelector("desc");

      img.setAttribute("src", `data:image/svg+xml,${encodeURIComponent(svg)}`);
      if (maxWidth) {
        img.width = parseInt(maxWidth);
      }
      if (firstTitle) {
        img.setAttribute("alt", firstTitle.textContent);
      }
      if (firstDesc) {
        const caption = document.createElement("figcaption");
        caption.className = "sr-only";
        caption.textContent = firstDesc.textContent;
        return [img, caption];
      }
      return [img];
    }

    async function makeMermaidError(text) {
      let errorMessage = "";
      try {
        await mermaid.parse(text);
      } catch (err) {
        errorMessage = `${err}`;
      }

      const result = document.createElement("details");
      result.className = 'jp-RenderedMermaid-Details';
      const summary = document.createElement("summary");
      summary.className = 'jp-RenderedMermaid-Summary';
      const pre = document.createElement("pre");
      const code = document.createElement("code");
      code.innerText = text;
      pre.appendChild(code);
      summary.appendChild(pre);
      result.appendChild(summary);

      const warning = document.createElement("pre");
      warning.innerText = errorMessage;
      result.appendChild(warning);
      return [result];
    }

    async function renderOneMarmaid(src) {
      const id = `jp-mermaid-${_nextMermaidId++}`;
      const parent = src.parentNode;
      let raw = src.textContent.trim();
      const el = document.createElement("div");
      el.style.visibility = "hidden";
      document.body.appendChild(el);
      let results = null;
      let output = null;
      try {
        let { svg } = await mermaid.render(id, raw, el);
        svg = cleanMermaidSvg(svg);
        results = makeMermaidImage(svg);
        output = document.createElement("figure");
        results.map(output.appendChild, output);
      } catch (err) {
        parent.classList.add("jp-mod-warning");
        results = await makeMermaidError(raw);
        output = results[0];
      } finally {
        el.remove();
      }
      parent.classList.add("jp-RenderedMermaid");
      parent.appendChild(output);
    }


    /**
     * Post-process to ensure mermaid diagrams contain only valid SVG and XHTML.
     */
    function cleanMermaidSvg(svg) {
      return svg.replace(RE_VOID_ELEMENT, replaceVoidElement);
    }


    /**
     * A regular expression for all void elements, which may include attributes and
     * a slash.
     *
     * @see https://developer.mozilla.org/en-US/docs/Glossary/Void_element
     *
     * Of these, only `<br>` is generated by Mermaid in place of `\n`,
     * but _any_ "malformed" tag will break the SVG rendering entirely.
     */
    const RE_VOID_ELEMENT =
      /<\s*(area|base|br|col|embed|hr|img|input|link|meta|param|source|track|wbr)\s*([^>]*?)\s*>/gi;

    /**
     * Ensure a void element is closed with a slash, preserving any attributes.
     */
    function replaceVoidElement(match, tag, rest) {
      rest = rest.trim();
      if (!rest.endsWith('/')) {
        rest = `${rest} /`;
      }
      return `<${tag} ${rest}>`;
    }

    void Promise.all([...diagrams].map(renderOneMarmaid));
  });
  </script>
 </head>
 <body>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># working with arrays</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># plotting functionality</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># typehints</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">risk_waterfall_chart</span><span class="p">,</span> <span class="n">waterfall_chart</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=blind-trauma">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Allocating-diversification-benefits">
        Allocating diversification benefits
        <a class="anchor-link" href="#Allocating-diversification-benefits">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Measuring-diversification-benefits">
        Measuring diversification benefits
        <a class="anchor-link" href="#Measuring-diversification-benefits">
         ¶
        </a>
       </h2>
       <p>
        We can define the portfolio standard deviation using matrix notation
       </p>
       $$
\sigma_P(\mathbf{w}) = \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}
$$
       <p>
        Since portfolio standard deviation is sub-additive, then it must always hold that
       </p>
       $$
\sigma_P(\mathbf{w}) \leq \sum_{i=1}^N w_i \sigma_i = \mathbf{w}^\top \mathbf{v}
$$
       <p>
        where $\mathbf{v}$ is a vector of volatilities. We can define the diversification benefit directly as the difference between the weighted sum of the individual volatilities and the portfolio volatility
       </p>
       $$
\text{Div}_{B} = \mathbf{w}^\top \mathbf{v} - \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}
$$
       <p>
        or normalized by the weighted sum of the individual volatilities
       </p>
       $$
\text{Div}_{RB} = \frac{\mathbf{w}^\top \mathbf{v} - \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}{\mathbf{w}^\top \mathbf{v}}
$$
       <h3 id="Example:-Diversification-benefit-from-investing-in-stocks-and-bonds">
        Example: Diversification benefit from investing in stocks and bonds
        <a class="anchor-link" href="#Example:-Diversification-benefit-from-investing-in-stocks-and-bonds">
         ¶
        </a>
       </h3>
       <p>
        Consider a two asset example with stocks (S) and bonds (B). Stocks are defined by $\mu_S = 0.04, \sigma_S = 0.15$ and bonds are defined by $\mu_B = 0.01, \sigma_B = 0.075$. The correlation between stocks and bonds is $\rho _{S,B} = 0.2$.
       </p>
       <p>
        What is the diversification benefits with an equal allocation to stocks and bonds?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=optical-mortality">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define relevant information </span>
<span class="sd">"""</span>

<span class="n">w_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

<span class="n">sigma_s</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">sigma_b</span> <span class="o">=</span> <span class="mf">0.075</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sigma_s</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">])</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rho</span><span class="p">],</span> <span class="p">[</span><span class="n">rho</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span> <span class="o">*</span> <span class="n">corr_mat</span>

<span class="sd">"""</span>
<span class="sd">Define a function that calculates portfolio standard deviation</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">portfolio_std</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that returns the standard deviation of the portfolio</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: </span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Standard deviation of portfolio</span>
<span class="sd">    """</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span> <span class="o">@</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Calculate diversification benefit</span>
<span class="sd">"""</span>
<span class="n">total_port_risk</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_eq</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">div_benefit</span> <span class="o">=</span> <span class="n">total_port_risk</span> <span class="o">-</span> <span class="n">w_eq</span> <span class="o">@</span> <span class="n">vols</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'The diversification benefit is equal to </span><span class="si">{:.2f}</span><span class="s1">%'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">div_benefit</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=indian-subject">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot a waterfall chart with risk decomposition </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">risk_waterfall_chart</span><span class="p">(</span><span class="n">vols</span> <span class="o">*</span> <span class="n">w_eq</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">total_port_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">"Stocks"</span><span class="p">,</span> <span class="s2">"Bonds"</span><span class="p">],</span>
                     <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span> <span class="n">total_risk_label</span><span class="o">=</span><span class="s2">"Total risk (std)"</span><span class="p">,</span> <span class="n">diversification_label</span><span class="o">=</span><span class="s2">"Diversification"</span><span class="p">);</span>


<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sublime-popularity">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="How-to-allocate-diversification-benefits">
        How to allocate diversification benefits
        <a class="anchor-link" href="#How-to-allocate-diversification-benefits">
         ¶
        </a>
       </h2>
       <p>
        We have just looked at how to calculate the diversification benefit, but how can the diversification benefit be allocated between the different asset classes? We want to know what the risk contribution of a particular asset is when taking the diversification into account. Several methods have been proposed, but we will only present the most commonly used.
       </p>
       <p>
        Since standard deviation satisfies the positiv homogeneity assumption, i.e. standard deviation is homogeneous of degree one, then it follows from the
        <a href="https://en.wikipedia.org/wiki/Homogeneous_function">
         Euler's homogeneous function theorem
        </a>
        that (see e.g.
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2009778">
         Bruder and Roncalli (2012)
        </a>
        )
       </p>
       $$
\sigma_P(\mathbf{w}) = \mathbf{w}^\top \nabla \sigma_P(\mathbf{w}) = \sum_{i=1}^N w_i \frac{\partial \sigma_P(\mathbf{w}) }{\partial w_i}
$$
       <p>
        The portfolio standard deviation (and true risk measures that satisfy the positive homogeneity requirement) can be written as the sum of the product of the exposure, $w_i$, by its marginal risk, $\frac{\partial }{\partial w_i}\sigma_P(\mathbf{w})$. We therefore define the risk contribution of asset $i$ as
       </p>
       $$
\text{RC}_i(\mathbf{w}) = w_i \frac{\partial \sigma_P(\mathbf{w}) }{\partial w_i}
$$
       <p>
        Using the chain rule and
        <a href="https://en.wikipedia.org/wiki/Matrix_calculus">
         matrix calculus
        </a>
        , the gradient is given by
       </p>
       $$
\nabla \sigma_P(\mathbf{w}) = \frac{d \sigma_P(\mathbf{w}) }{d \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}\frac{\partial \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}{\partial \mathbf{w}} = \frac{1}{2\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} 2 \boldsymbol{\Sigma} \mathbf{w} = \frac{\boldsymbol{\Sigma} \mathbf{w} }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
       <p>
        Hence, we have that
       </p>
       $$
\sigma_P(\mathbf{w}) = \mathbf{w}^\top \frac{\boldsymbol{\Sigma} \mathbf{w} }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = \sum_{i=1}^N w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
       <h3 id="Example">
        Example
        <a class="anchor-link" href="#Example">
         ¶
        </a>
       </h3>
       <p>
        Consider a two asset example from above. What is the risk contribution of stocks and bonds respectivly?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=greek-assignment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_marginal_risks</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates marginal risk</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: </span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>
    
    <span class="n">total_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span> <span class="o">@</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">inner_derivative</span> <span class="o">=</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span>
    
    <span class="k">return</span> <span class="n">inner_derivative</span> <span class="o">/</span> <span class="n">total_risk</span>

<span class="k">def</span> <span class="nf">calculate_risk_contributions</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates risk contributions</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: </span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>
    
    <span class="n">mr</span> <span class="o">=</span> <span class="n">calculate_marginal_risks</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">mr</span>

<span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">calculate_risk_contributions</span><span class="p">(</span><span class="n">w_eq</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Risk contribution:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Stocks: </span><span class="si">{:.2f}</span><span class="s2">%'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">risk_contrib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Bonds: </span><span class="si">{:.2f}</span><span class="s2">%'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">risk_contrib</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=western-summary">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Equal-risk-contribution">
        Equal risk contribution
        <a class="anchor-link" href="#Equal-risk-contribution">
         ¶
        </a>
       </h2>
       <p>
        There is a large literature on
        <em>
         risk parity investing
        </em>
        where the focus is on allocating risk instead of capital, e.g. we want an equal amount of risk coming from bonds and stocks. We will talk more about this later in the course, but we will give a very brief introduction. The problem that we want to solve is
       </p>
       $$
w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = b_i \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}
$$
       <p>
        where $b_i$ is the risk coming from the $i$'th asset. In addition, we would likely impose positivity contraints $b_i \geq 0, w_i \geq 0$, weights summing to one $\sum_{i=1}^N w_i = 1$, and $\sum_{i=1}^N b_i = 1$.
       </p>
       <p>
        Generally, we need numerical methods for solving the problem when dealing with more than two assets (more about this later in the course). However,
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2009778">
         Bruder and Roncalli (2012), "Managing Risk Exposures using
the Risk Budgeting Approach"
        </a>
        present an exact solution for the two asset case.
       </p>
       <h3 id="Example">
        Example
        <a class="anchor-link" href="#Example">
         ¶
        </a>
       </h3>
       <p>
        Consider a two asset example from above. What are the portfolio weights that result in equal risk contribution?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=actual-naples">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Implement the solution from Bruder and Roncalli (2012)</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">weights_risk_budget</span><span class="p">(</span><span class="n">sigma1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates the portfolio weights that result in equal risk contribution. Two asset case. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma1: </span>
<span class="sd">        Std. of asset 1</span>
<span class="sd">    sigma2: </span>
<span class="sd">        Std. of asset 2</span>
<span class="sd">    rho: </span>
<span class="sd">        Correlation between asset 1 and asset 2</span>
<span class="sd">    b: </span>
<span class="sd">        Risk contribution from asset 1</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">       Optimal weigths. </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sigma1</span><span class="o">*</span><span class="n">sigma2</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">sigma2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">sigma1</span><span class="o">*</span><span class="n">sigma2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">b</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">rho</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">b</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">))</span>
    <span class="n">den</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">b</span><span class="p">)</span><span class="o">*</span><span class="n">sigma1</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">b</span><span class="o">*</span><span class="n">sigma2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="mf">0.5</span><span class="p">)</span><span class="o">*</span><span class="n">rho</span><span class="o">*</span><span class="n">sigma1</span><span class="o">*</span><span class="n">sigma2</span>
    
    <span class="n">w_opt</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">den</span> 
    
    <span class="k">return</span> <span class="n">w_opt</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w_opt</span>


<span class="n">w_eq_risk</span> <span class="o">=</span> <span class="n">weights_risk_budget</span><span class="p">(</span><span class="n">sigma_s</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Port. weights:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Stocks: </span><span class="si">{:.2f}</span><span class="s2">%'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w_eq_risk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Bonds: </span><span class="si">{:.2f}</span><span class="s2">%'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">w_eq_risk</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

<span class="sd">"""</span>
<span class="sd">Calculate total risk and div. benefit</span>
<span class="sd">"""</span>

<span class="n">total_port_risk</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_eq_risk</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">div_benefit</span> <span class="o">=</span> <span class="n">total_port_risk</span> <span class="o">-</span> <span class="n">w_eq_risk</span> <span class="o">@</span> <span class="n">vols</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'</span><span class="se">\n</span><span class="s1">The diversification benefit is equal to </span><span class="si">{:.2f}</span><span class="s1">%'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">div_benefit</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>

<span class="sd">"""</span>
<span class="sd">Plot a waterfall chart with risk decomposition </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">risk_waterfall_chart</span><span class="p">(</span><span class="n">vols</span> <span class="o">*</span> <span class="n">w_eq_risk</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">total_port_risk</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="p">[</span><span class="s2">"Stocks"</span><span class="p">,</span> <span class="s2">"Bonds"</span><span class="p">],</span>
                     <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span> <span class="n">total_risk_label</span><span class="o">=</span><span class="s2">"Total risk (std)"</span><span class="p">,</span> <span class="n">diversification_label</span><span class="o">=</span><span class="s2">"Diversification"</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b281612a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">calculate_risk_contributions</span><span class="p">(</span><span class="n">w_eq_risk</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">waterfall_chart</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">risk_contrib</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">"Stocks"</span><span class="p">,</span> <span class="s2">"Bonds"</span><span class="p">],</span>
                          <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span>
                          <span class="n">total_label</span><span class="o">=</span><span class="s2">"Total risk (std)"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Risk contribution"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Risk contribution using std. as risk measure"</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1467-9965.00068">
         Artzner et al (1999), "Coherent Measures of Risks"
        </a>
       </p>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2009778">
         Bruder and Roncalli (2012), "Managing Risk Exposures using
the Risk Budgeting Approach"
        </a>
       </p>
       <p>
        <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1467-9965.00068">
         Rosen and Saunders (2010), "Risk factor contributions in portfolio credit risk models"
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.com/Risk-Asset-Allocation-Springer-Finance/dp/3642009646">
         Attilio Meucci, "Risk and Asset Allocation"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="c1"># animations, etc. requires below magic command</span>
<span class="c1"># %matplotlib notebook</span>


<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># matrix square root</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">sqrtm</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># packages for convex programming</span>
<span class="kn">import</span> <span class="nn">cvxopt</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=47306f92">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Convex-optimization">
        Convex optimization
        <a class="anchor-link" href="#Convex-optimization">
         ¶
        </a>
       </h1>
       <p>
        Convex optimization relates to optimization problems where the objective function is a convex function subject to only convex and affine constraints.
       </p>
       <p>
        The main advantage of convex programming problems is that there is only on local minimum, which is also globally optimal, and that we have can use efficient algorithms to solve such problems numerically.
       </p>
       <p>
        In finance, we will encounter convex optimization problems, in particular linear and quadratic programming problems, in many application, e.g. portfolio optimization.
       </p>
       <p>
        This Jupyter notebook will give a brief introduction to convex programming problems relevant for primarily portfolio optimization while the interested reader is refered to
        <a href="https://web.stanford.edu/~boyd/cvxbook/bv_cvxbook.pdf">
         Boyd and Vandenberghe (2004)
        </a>
        . The focus is on how to implement convex optimization problems using the
        <code>
         cvxopt
        </code>
        and
        <code>
         cvxpy
        </code>
        packages.
       </p>
       <h2 id="The-general-problem">
        The general problem
        <a class="anchor-link" href="#The-general-problem">
         ¶
        </a>
       </h2>
       <p>
        Convex programming solves the problem
       </p>
       $$
\begin{align*}
    \min_{\mathbf{x}}  \quad &amp;amp; f(\mathbf{x}) \\
    \textrm{s.t.} \quad &amp;amp; \mathbf{A} \mathbf{x} = \mathbf{b}\\
     &amp;amp; g(\mathbf{x}) \leq \mathbf{0}
\end{align*}
$$
       <p>
        where $\mathbf{x}$ is a n-dimensional vector, $f : \mathbb{R}^n \to \mathbb{R}$ is a convex function, $\mathbf{A}$ and $\mathbf{b}$ defines an affine set, $g(\mathbf{x}) = (g_1 (\mathbf{x}), ..., g_K (\mathbf{x}) )^\top$ is a vector of convex functions defining a convex set.
       </p>
       <p>
        <strong>
         Note
        </strong>
        :  A function $f()$ is said to be convex if
       </p>
       $$
f(\alpha \mathbf{x} + \beta \mathbf{y}) \leq \alpha f(\mathbf{x}) + \beta f(\mathbf{y})
$$
       <p>
        for $\alpha \geq 0$, $\beta \geq 0$, $\alpha + \beta = 1$, $\mathbf{x}, \mathbf{y} \in \mathbb{R}^N$
       </p>
       <h2 id="Linear-programming">
        Linear programming
        <a class="anchor-link" href="#Linear-programming">
         ¶
        </a>
       </h2>
       <p>
        In linear programming the convex objective function is required to be linear and we only allow for linear equality and inequality constraints.
       </p>
       $$
\begin{align*}
    \min_{\mathbf{x}}  \quad &amp;amp; \mathbf{c}^\top \mathbf{x} \\
    \textrm{s.t.} \quad &amp;amp; \mathbf{A} \mathbf{x} = \mathbf{b}\\
     &amp;amp; \mathbf{G} \mathbf{x} \leq \mathbf{h}
\end{align*}
$$
       <p>
        where $\mathbf{A}$ is a $m \times n$ matrix, $\mathbf{b}$ is a $m$-dimensional vector, where $m$ is the number of equality constraints.
       </p>
       <p>
        <strong>
         Example: Solving a linear program
        </strong>
       </p>
       <p>
        Note: Example is taken from
        <a href="https://cvxopt.org/examples/tutorial/lp.html">
         CVXOPT tutorial
        </a>
        .
       </p>
       <p>
        Consider the linear program
       </p>
       $$
\begin{align*}
    \arg \min_{\mathbf{x}}  \quad &amp;amp; 2 x_1 + x_2\\
    \textrm{s.t.} \quad &amp;amp; -x_1 + x_2 \leq 1 \\
     &amp;amp; x_1 + x_2 \geq 2 \\
     &amp;amp; x_2 \geq 0 \\
     &amp;amp; x_1 - 2x_2 \leq 4
\end{align*}
$$
       <p>
        Solve the problem.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=eabbcd98">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">CVXOPT</span>
<span class="sd">"""</span>

<span class="c1"># define input matrices</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">]])</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span> <span class="p">])</span>

<span class="c1"># solve problem </span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">solvers</span><span class="o">.</span><span class="n">lp</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">G</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ae94cd5f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=43ae7d37">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">CVXPY</span>
<span class="sd">"""</span>

<span class="c1"># define variables</span>
<span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span> <span class="p">])</span>

<span class="c1"># define problem </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">c</span> <span class="o">@</span> <span class="n">x</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">G</span> <span class="o">@</span> <span class="n">x</span> <span class="o">&amp;lt;=</span> <span class="n">h</span><span class="p">])</span>

<span class="c1"># solve problem</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># solution </span>
<span class="n">x</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a6463ef8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Quadratic-programming">
        Quadratic programming
        <a class="anchor-link" href="#Quadratic-programming">
         ¶
        </a>
       </h2>
       <p>
        We will often encounter quadratic programming problems in finance and economics, e.g. in relation to portfolio optimization and linear regression. Quadratic programming solves the optimization problem
       </p>
       $$
\begin{align*}
    \min_{\mathbf{x}}  \quad &amp;amp; \frac{1}{2} \mathbf{x}^\top  \mathbf{P}  \mathbf{x}  +  \mathbf{q}^\top \mathbf{x} \\
    \textrm{s.t.} \quad &amp;amp; \mathbf{A} \mathbf{x} = \mathbf{b}\\
     &amp;amp; \mathbf{G} \mathbf{x} \leq \mathbf{h}
\end{align*}
$$
       <p>
        Clearly, linear programming is a special case of quadratic programming.
       </p>
       <p>
        <strong>
         Example:  Portofolio optimization - quadratic utility
        </strong>
       </p>
       <p>
        Assume that an investor has a quadratic utility function
       </p>
       $$
U(\mathbf{w}) = \mathbf{w}^\top \boldsymbol{\mu} - \frac{\lambda}{2} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        where $\mathbf{w}$ is the portfolio weights, $\boldsymbol{\mu}$ is a vector of expected returns, and $\boldsymbol{\Sigma}$ denotes the covariance matrix.
       </p>
       <p>
        The investor seeks to maximize the utility given the constraint that the portfolio weights sum to one
       </p>
       $$
\mathbf{1}^\top \mathbf{w} = 1
$$
       <p>
        The solution to this optimization problem is given by (see e.g.
        <a href="https://www.amazon.com/Portfolio-Management-under-Stress-Bayesian-Net/dp/1107048117">
         Rebonato and Denev, "Portfolio Management under stress"
        </a>
        )
       </p>
       $$
\mathbf{w}^* = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu} - \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \mathbf{A}^\top \mathbf{C}^{-1} \left(\mathbf{A}\boldsymbol{\Sigma}^{-1}\boldsymbol{\mu}  - \lambda \mathbf{b} \right)
$$
       <p>
        with $\mathbf{A} = \mathbf{1}^\top$, $\mathbf{b} = 1$, and $\mathbf{C} = \mathbf{A} \boldsymbol{\Sigma}^{-1}\mathbf{A}^\top$. Note that this solution is valid for more general constraints of the form $\mathbf{A}^\top \mathbf{w} = \mathbf{b}$.
       </p>
       <p>
        We assume that
       </p>
       $$
\boldsymbol{\mu}  = \begin{bmatrix} 0.02 \\ 0.04 \\ 0.08 \end{bmatrix}, \; \mathbf{v} = \begin{bmatrix} 0.075 \\ 0.15 \\ 0.3 \end{bmatrix}, \; \textbf{Corr} = \begin{bmatrix} 1.0 &amp;amp; 0.2 &amp;amp; 0.1 \\
                     0.2 &amp;amp; 1.0 &amp;amp; 0.4 \\
                     0.1 &amp;amp; 0.4 &amp;amp; 1.0 \end{bmatrix}
$$
       <p>
        and $\lambda = 5$.
       </p>
       <p>
        Compare the solution to the one obtained using
        <code>
         cvxopt
        </code>
        or
        <code>
         cvxpy
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=958036f2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define input parameters</span>
<span class="sd">"""</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>

<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span> <span class="o">*</span> <span class="n">corr_mat</span>
<span class="n">cov_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=523bb605">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates optimal port. weights</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu: </span>
<span class="sd">        Expected returns</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    risk_aversion: </span>
<span class="sd">        Risk aversion parameter</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Optimal portfolio weights</span>
<span class="sd">    """</span>
    <span class="n">sigma_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">A</span>
    <span class="n">C_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">C</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
    
    <span class="n">first_part</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">mu</span> 
    <span class="n">second_part</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">A</span> <span class="o">*</span> <span class="n">C_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="n">opt_weights</span> <span class="o">=</span> <span class="n">first_part</span> <span class="o">-</span> <span class="n">second_part</span>
    
    <span class="k">return</span> <span class="n">opt_weights</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8cf6e46b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_aversion</span> <span class="o">=</span> <span class="mi">5</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"optimal weights: "</span><span class="p">)</span>
<span class="n">w_opt</span> <span class="o">=</span> <span class="n">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">)</span>
<span class="n">w_opt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=28069aa2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">CVXOPT</span>
<span class="sd">"""</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">cov_mat</span> <span class="o">*</span> <span class="n">risk_aversion</span><span class="p">)</span> <span class="c1">#&amp;lt;- we need to minimize</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="o">-</span><span class="n">mu</span><span class="p">)</span> <span class="c1">#&amp;lt;- we need to minimize</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>

<span class="c1"># solve problem </span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">solvers</span><span class="o">.</span><span class="n">qp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>

<span class="c1"># solution </span>
<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span> <span class="c1"># &amp;lt;- gives the same solution as the analytical formula</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6a845053">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">CVXPY</span>
<span class="sd">"""</span>
<span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
<span class="c1"># define variables</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">cov_mat</span> <span class="o">*</span> <span class="n">risk_aversion</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">mu</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>


<span class="c1"># define problem </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">q</span> <span class="o">@</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">)),</span>
                  <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># cp.sum(x) == 1 or  A @ x == b</span>

<span class="c1"># solve problem</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># solution </span>
<span class="n">x</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=576cf976">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        If add the constraint that all assets need an allocation above 30%, then we do not have an analytical solution anymore - but luckily we can apply
        <code>
         cvxopt
        </code>
        or
        <code>
         cvxpy
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fd10b135">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
<span class="c1"># define variables</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">cov_mat</span> <span class="o">*</span> <span class="n">risk_aversion</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">mu</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>


<span class="c1"># define problem </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">q</span> <span class="o">@</span> <span class="n">x</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">)),</span>
                  <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">A</span> <span class="o">@</span> <span class="n">x</span> <span class="o">==</span> <span class="n">b</span><span class="p">,</span>
                               <span class="n">x</span> <span class="o">&amp;gt;=</span> <span class="mf">0.3</span><span class="p">])</span> <span class="c1"># &amp;lt;- just add this input, cvxpy will set the matrices up correctly!</span>

<span class="c1"># solve problem</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># solution </span>
<span class="n">x</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8322757e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Second-order-cone-programming">
        Second-order cone programming
        <a class="anchor-link" href="#Second-order-cone-programming">
         ¶
        </a>
       </h2>
       <p>
        A second-order cone program is an optimization problem of the form (following the notation from
        <a href="https://www.cvxpy.org/examples/basic/socp.html">
         CVXPY
        </a>
        )
       </p>
       $$
\begin{align*}
    \arg \min_{\mathbf{x}}  \quad &amp;amp; \mathbf{f}^\top \mathbf{x} \\
    \textrm{s.t.} \quad &amp;amp; \Vert \mathbf{A}_i \mathbf{x} + \mathbf{b}_i \Vert_2  \leq \mathbf{c}_i^\top \mathbf{x} + d_i, \; i = 1, ..., m\\
     &amp;amp; \mathbf{F} \mathbf{x} = \mathbf{g}
\end{align*}
$$
       <p>
        where $\mathbf{x}$ is the optimization variable,  $\mathbf{f}$ is a $n$-dimensional vector, $\mathbf{A}_i$ is a $n_i \times n$  matrix, $\mathbf{b}_i$ is a $n_i$-dimensional vector, $\mathbf{c}_i$ is a $n$-dimensional vector, $d_i$ is a scalar, $\mathbf{F}$ is a $p \times n$ matrix and $\mathbf{g}$ is a $p$-dimensional vector.
       </p>
       <p>
        <strong>
         Example: Portfolio optimization with VaR constraint
        </strong>
       </p>
       <p>
        Assume that the net return is multivariate normal $\mathbf{R} \sim \text{MN}(\boldsymbol{\mu}, \boldsymbol{\Sigma})$ with
       </p>
       $$
\boldsymbol{\mu}  = \begin{bmatrix} 0.02 \\ 0.04 \\ 0.08 \end{bmatrix}, \; \mathbf{v} = \begin{bmatrix} 0.075 \\ 0.15 \\ 0.3 \end{bmatrix}, \; \textbf{Corr} = \begin{bmatrix} 1.0 &amp;amp; 0.2 &amp;amp; 0.1 \\
                     0.2 &amp;amp; 1.0 &amp;amp; 0.4 \\
                     0.1 &amp;amp; 0.4 &amp;amp; 1.0 \end{bmatrix}
$$
       <p>
        Assume that we want to maximize the expected return subject to the (negative) Value at Risk  being larger certain threshold, $b$,
       </p>
       $$
\begin{align*}
    \max_{\mathbf{w}}  \quad &amp;amp; \boldsymbol{\mu}^\top \mathbf{w} \\
    \textrm{s.t.} \quad &amp;amp; \boldsymbol{\mu}^\top \mathbf{w} + \Phi^{-1}(\alpha) \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}} \geq b\\
     &amp;amp; \mathbf{w} \geq \mathbf{0} \\
     &amp;amp; \mathbf{1}^\top \mathbf{w} = 1
\end{align*}
$$
       <p>
        Since $\boldsymbol{\mu}^\top \mathbf{w} + \Phi^{-1}(\alpha) \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}} \geq b$ is equivalent to $\boldsymbol{\mu}^\top \mathbf{w} + \Phi^{-1}(\alpha) \Vert \boldsymbol{\Sigma}^{1/2} \mathbf{w} \Vert \geq b$, we can equivalently write the problem as
       </p>
       $$
\begin{align*}
    \max_{\mathbf{w}}  \quad &amp;amp; \boldsymbol{\mu}^\top \mathbf{w} \\
    \textrm{s.t.} \quad &amp;amp; \Vert \boldsymbol{\Sigma}^{1/2} \mathbf{w} \Vert \leq \frac{1}{\Phi^{-1}(\alpha)}\boldsymbol{\mu}^\top \mathbf{w} -\frac{1}{\Phi^{-1}(\alpha)}b\\
     &amp;amp; \mathbf{w} \geq \mathbf{0} \\    
     &amp;amp; \mathbf{1}^\top \mathbf{w}= 1
\end{align*}
$$
       <p>
        which is a second-order cone programming problem.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ccf1d20a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define input parameters</span>
<span class="sd">"""</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>

<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span> <span class="o">*</span> <span class="n">corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=817ed5dc">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define variables, etc. </span>
<span class="n">tail</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">loss</span> <span class="o">=</span> <span class="mf">0.14112535684744942</span> <span class="c1"># minimum attainable VaR(5%) is ~14.1%</span>

<span class="n">f</span> <span class="o">=</span> <span class="n">mu</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">sqrtm</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span> 
<span class="n">c</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">/</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>
<span class="n">d</span> <span class="o">=</span> <span class="o">-</span><span class="n">loss</span> <span class="o">/</span>  <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">tail</span><span class="p">)</span>

<span class="c1"># variables </span>
<span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

<span class="c1"># constraints </span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> <span class="n">w</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">constraints</span> <span class="o">+=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">SOC</span><span class="p">(</span><span class="n">c</span> <span class="o">@</span> <span class="n">w</span> <span class="o">+</span> <span class="n">d</span><span class="p">,</span> <span class="n">A</span> <span class="o">@</span> <span class="n">w</span><span class="p">)]</span>

<span class="c1"># problem </span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">f</span> <span class="o">@</span> <span class="n">w</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

<span class="c1"># solve problem</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># solution </span>
<span class="n">w</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=0506520b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Semidefinite-programming">
        Semidefinite programming
        <a class="anchor-link" href="#Semidefinite-programming">
         ¶
        </a>
       </h2>
       <p>
        A semidefinite program (SDP) is an optimization problem of the form
       </p>
       $$
\begin{align*}
    \min_{\mathbf{X}}  \quad &amp;amp;  \text{tr}(\mathbf{C} \mathbf{X}) \\
    \textrm{s.t.} \quad &amp;amp; \text{tr}(\mathbf{A}_i \mathbf{X}) = b_i, \; i = 1, ..., m\\
    &amp;amp; \mathbf{X} \succeq 0
\end{align*}
$$
       <p>
        where $\text{tr}$ is the
        <a href="https://en.wikipedia.org/wiki/Trace_(linear_algebra)">
         trace operator
        </a>
        . The optimization variable $\mathbf{X} \in \mathcal{S}^n$ is a $n \times n$ symmetric matrix. The problem data $\mathbf{C}, \mathbf{A}_1, ..., \mathbf{A}_m \in \mathcal{S}^n$ are $n \times n$ symmetric matrices. $\mathbf{X} \succeq 0$ is a matrix inequality requiring $\mathbf{X}$ to be a symmetric and positive semidefinite matrix ($\succ$ means positive definite matrix).
       </p>
       <p>
        See e.g.
        <a href="https://web.stanford.edu/~boyd/cvxbook/bv_cvxbook.pdf">
         Boyd and Vandenberghe (2004)
        </a>
        and
        <a href="https://ocw.mit.edu/courses/15-084j-nonlinear-programming-spring-2004/a632b565602fd2eb3be574c537eea095_lec23_semidef_opt.pdf">
         Freund (2004)
        </a>
        for additional information.
       </p>
       <p>
        <strong>
         Example: How to set up a problem
        </strong>
       </p>
       <p>
        Note: Example taken from
        <a href="https://ocw.mit.edu/courses/15-084j-nonlinear-programming-spring-2004/a632b565602fd2eb3be574c537eea095_lec23_semidef_opt.pdf">
         Freund (2004)
        </a>
        .
       </p>
       <p>
        Consider the case with $m=2$ and $n = 3$ with the following matrices
       </p>
       $$
\mathbf{A}_1 = \begin{pmatrix} 1 &amp;amp; 0 &amp;amp; 1 \\ 0 &amp;amp; 3 &amp;amp; 7 \\ 1 &amp;amp; 7 &amp;amp; 5 \end{pmatrix}, \quad
\mathbf{A}_2 = \begin{pmatrix} 0 &amp;amp; 2 &amp;amp; 8 \\ 2 &amp;amp; 6 &amp;amp; 0 \\ 8 &amp;amp; 0 &amp;amp; 4 \end{pmatrix}, \quad
\mathbf{C} = \begin{pmatrix} 1 &amp;amp; 2 &amp;amp; 3 \\ 2 &amp;amp; 9 &amp;amp; 0 \\ 3 &amp;amp; 0 &amp;amp; 7 \end{pmatrix}
$$
       <p>
        and the values $b_1 = 11$ and $b_2 = 19$. The optimization variable $\mathbf{X}$ will be a $3 \times 3$ symmetric matrix:
       </p>
       $$
\mathbf{X} = \begin{pmatrix} x_{11} &amp;amp; x_{12} &amp;amp; x_{13} \\ x_{21} &amp;amp; x_{22} &amp;amp; x_{23} \\ x_{31} &amp;amp; x_{32} &amp;amp; x_{33} \end{pmatrix}
$$
       <p>
        Doing some tedious matrix calculations, we are able to show that the problem is given by (using that $\mathbf{X}$ is symmetric, e.g. $x_{12} = x_{21}$)
       </p>
       $$
\begin{align*}
    \min  \quad &amp;amp;  x_{11} + 4 x_{12} + 6 x_{13} + 9 x_{22} + 0 x_{23} + 7 x_{33} \\
    \textrm{s.t.} \quad &amp;amp; x_{11} + 0 x_{12} + 2 x_{13} + 3 x_{22} + 14 x_{23} + 5 x_{33} = 11, \\
    &amp;amp; 0 x_{11} + 4 x_{12} + 16 x_{13} + 6 x_{22} + 0 x_{23} + 4 x_{33} = 19 \\
    &amp;amp; \begin{pmatrix} x_{11} &amp;amp; x_{12} &amp;amp; x_{13} \\ x_{21} &amp;amp; x_{22} &amp;amp; x_{23} \\ x_{31} &amp;amp; x_{32} &amp;amp; x_{33} \end{pmatrix} \succeq 0
\end{align*}
$$
       <p>
        In the following code-block, we show how to implement the problem with
        <code>
         cvxpy
        </code>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d9c4979f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define relevant matrices</span>
<span class="sd">"""</span>


<span class="n">A1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> 
               <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">7</span><span class="p">],</span> 
               <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">5</span><span class="p">]])</span>

<span class="n">b1</span> <span class="o">=</span> <span class="mi">11</span>

<span class="n">A2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">8</span><span class="p">],</span> 
               <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
               <span class="p">[</span><span class="mi">8</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">]])</span>

<span class="n">b2</span> <span class="o">=</span> <span class="mi">19</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">],</span> 
              <span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">9</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> 
              <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">7</span><span class="p">]])</span>

<span class="sd">"""</span>
<span class="sd">Define X matrix - optimization variable</span>
<span class="sd">"""</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># tell cvxpy that X is a symmetric n x n matrix</span>

<span class="sd">"""</span>
<span class="sd">Define constraints</span>
<span class="sd">"""</span>

<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="o">&amp;gt;&amp;gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="c1"># matrix X is positive definite</span>

<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A1</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="n">b1</span><span class="p">)</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A2</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="n">b2</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Define problem </span>
<span class="sd">"""</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">C</span> <span class="o">@</span> <span class="n">X</span><span class="p">)),</span> <span class="n">constraints</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Solve problem and print solution</span>
<span class="sd">"""</span>

<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"The optimal value is"</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"A solution X is"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=46c83a03">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Relation to linear programming
        </strong>
       </p>
       <p>
        If we had a linear programming problem of the form
       </p>
       $$
\begin{align*}
    \min_{\mathbf{x}}  \quad &amp;amp; \mathbf{c}^\top \mathbf{x} \\
    \textrm{s.t.} \quad &amp;amp; \mathbf{A} \mathbf{x} = \mathbf{b}\\
\end{align*}
$$
       <p>
        We would be able to define an equivalent semidefinite programming problem by defining
       </p>
       $$
\mathbf{A}_i = \begin{pmatrix} a_{i1} &amp;amp; 0 &amp;amp;  \dots &amp;amp; 0 \\ 0 &amp;amp; a_{i2} &amp;amp; \dots &amp;amp; 0 \\ \vdots &amp;amp; \vdots &amp;amp; \ddots &amp;amp; \vdots \\
0 &amp;amp; 0 &amp;amp; \dots &amp;amp; a_{in}\end{pmatrix}, i = 1, \dots, m \quad \text{and} \quad  \mathbf{C} = \begin{pmatrix} c_1 &amp;amp; 0 &amp;amp;  \dots &amp;amp; 0 \\ 0 &amp;amp; c_2 &amp;amp; \dots &amp;amp; 0 \\ \vdots &amp;amp; \vdots &amp;amp; \ddots &amp;amp; \vdots \\
0 &amp;amp; 0 &amp;amp; \dots &amp;amp; c_n\end{pmatrix}
$$
       <p>
        such that we can write the linear programming problem as
       </p>
       $$
\begin{align*}
    \min_{\mathbf{X}}  \quad &amp;amp;  \text{tr}(\mathbf{C} \mathbf{X}) \\
    \textrm{s.t.} \quad &amp;amp; \text{tr}(\mathbf{A}_i \mathbf{X}) = b_i, \; i = 1, ..., m\\
    &amp;amp; x_{ij} = 0, i = 1, \dots, n, j = i + 1, \dots, n \\
    &amp;amp; \mathbf{X} \succeq 0
\end{align*}
$$
       <p>
        Thus, we are restricting $\mathbf{X}$ to be a diagonal matrix.
       </p>
       <p>
        In practice, we would not transform a linear programming problem to a semidefinite one, but this illustrates that a semidefinite programming problem includes linear programming as a special case.
       </p>
       <p>
        <strong>
         Example: Maximization of entry in correlation matrix
        </strong>
       </p>
       <p>
        Note: This example is adapted from
        <a href="https://en.wikipedia.org/wiki/Semidefinite_programming">
         [W]
        </a>
        .
       </p>
       <p>
        Let $\mathbf{X}$ be a $3 \times 3$ correlation matrix
       </p>
       $$
\mathbf{X} = \begin{pmatrix} 1 &amp;amp; x_{12} &amp;amp; x_{13} \\ x_{21} &amp;amp; 1 &amp;amp; x_{23} \\ x_{31} &amp;amp; x_{32} &amp;amp; 1 \end{pmatrix} \succeq 0
$$
       <p>
        We assume that $x_{12} = -0.15$ and $x_{23} = 0.45$. What is the maximum value that $x_{13}$ can take?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=96c869f8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">3</span>

<span class="sd">"""</span>
<span class="sd">Define X matrix - optimization variable</span>
<span class="sd">"""</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">),</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># tell cvxpy that X is a symmetric n x n matrix</span>

<span class="sd">"""</span>
<span class="sd">Define constraint matrices</span>
<span class="sd">"""</span>

<span class="c1"># positive definite constraint</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="o">&amp;gt;&amp;gt;</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># add diagonal constraints - diagonal must be equal to one</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    
    <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span>
    
<span class="c1"># add constraints on x12 and x23 </span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">)</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span><span class="n">n</span><span class="p">))</span>
<span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.45</span><span class="p">)</span>


<span class="sd">"""</span>
<span class="sd">Define problem </span>
<span class="sd">"""</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
<span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">C</span> <span class="o">@</span> <span class="n">X</span><span class="p">)),</span> <span class="n">constraints</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Solve problem and print solution</span>
<span class="sd">"""</span>

<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"The optimal value is"</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"A solution X is"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d012a0b2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Instead of specifying specific values for $x_{12}$ and $x_{23}$, we could assume $-0.2 \leq x_{12} \leq -0.1$ and $0.4 \leq x_{12} \leq 0.5$.
       </p>
       <p>
        To add inequality constraints, we can add slack variables to the problem, e.g. $x_{12} \leq -0.1$ can be implemented as
       </p>
       $$
\text{tr} \left(\left(\begin{array}{cccccc}
0 &amp;amp; 1 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0\\
0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0\\
0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0\\
0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 1 &amp;amp; 0 &amp;amp; 0\\
0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0\\
0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0\end{array}\right)\cdot\left(\begin{array}{cccccc}
1 &amp;amp; x_{12} &amp;amp; x_{13} &amp;amp; 0 &amp;amp; 0 &amp;amp; 0\\
x_{12} &amp;amp; 1 &amp;amp; x_{23} &amp;amp; 0 &amp;amp; 0 &amp;amp; 0\\
x_{13} &amp;amp; x_{23} &amp;amp; 1 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0\\
0 &amp;amp; 0 &amp;amp; 0 &amp;amp; s_{1} &amp;amp; 0 &amp;amp; 0\\
0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; s_{2} &amp;amp; 0\\
0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; 0 &amp;amp; s_{3}\end{array}\right)\right)=x_{12} + s_{1}=-0.1
$$
       <p>
        Since $s_1$ is restricted to be positive, then $x_{12}$ have to be smaller than $-0.1$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5276fb40">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">num_ineq</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_tot</span> <span class="o">=</span> <span class="n">n</span> <span class="o">+</span> <span class="n">num_ineq</span>

<span class="sd">"""</span>
<span class="sd">Define X matrix - optimization variable</span>
<span class="sd">"""</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">((</span><span class="n">n_tot</span><span class="p">,</span> <span class="n">n_tot</span><span class="p">),</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="c1"># tell cvxpy that X is a symmetric n x n matrix</span>

<span class="sd">"""</span>
<span class="sd">Define constraint matrices</span>
<span class="sd">"""</span>

<span class="c1"># positive definite constraint</span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span> <span class="o">&amp;gt;&amp;gt;</span> <span class="mi">0</span><span class="p">]</span>

<span class="c1"># add diagonal constraints - diagonal must be equal to one</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tot</span><span class="p">,</span> <span class="n">n_tot</span><span class="p">))</span>
    <span class="n">A</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
    
    <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">)</span>
    
<span class="c1"># add constraints on x12</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tot</span><span class="p">,</span> <span class="n">n_tot</span><span class="p">))</span>
<span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">)</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tot</span><span class="p">,</span> <span class="n">n_tot</span><span class="p">))</span>
<span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">A</span><span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">4</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">)</span>

<span class="c1"># add constraints on x23</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tot</span><span class="p">,</span> <span class="n">n_tot</span><span class="p">))</span>
<span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">A</span><span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.5</span><span class="p">)</span>

<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tot</span><span class="p">,</span> <span class="n">n_tot</span><span class="p">))</span>
<span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">A</span><span class="p">[</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>

<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">X</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.4</span><span class="p">)</span>


<span class="sd">"""</span>
<span class="sd">Define problem </span>
<span class="sd">"""</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">n_tot</span><span class="p">,</span> <span class="n">n_tot</span><span class="p">))</span>
<span class="n">C</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">C</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">C</span> <span class="o">@</span> <span class="n">X</span><span class="p">)),</span> <span class="n">constraints</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Solve problem and print solution</span>
<span class="sd">"""</span>

<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"The optimal value is"</span><span class="p">,</span> <span class="n">prob</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"A solution X is"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">value</span><span class="p">[:</span><span class="mi">3</span><span class="p">,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Lecture-notes">
        Lecture notes
        <a class="anchor-link" href="#Lecture-notes">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://ocw.mit.edu/courses/15-084j-nonlinear-programming-spring-2004/a632b565602fd2eb3be574c537eea095_lec23_semidef_opt.pdf">
         Freund (2004)
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://web.stanford.edu/~boyd/cvxbook/bv_cvxbook.pdf">
         Convex Optimization, Boyd and Vandenberghe (2004)
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="c1"># animations, etc. requires below magic command</span>
<span class="c1"># %matplotlib notebook</span>


<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># numpy for working with matrices</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># plotting libraries</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># scipy for statistics and optimization</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>


<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">codelib.dal.fred_yield_data</span> <span class="kn">import</span> <span class="n">get_nominal_yield_data</span>
<span class="kn">from</span> <span class="nn">codelib.fixed_income.curves.nelson_siegel_curve</span> <span class="kn">import</span> <span class="n">NelsonSiegelCurve</span>
<span class="kn">from</span> <span class="nn">codelib.fixed_income.curves.constant_curve</span> <span class="kn">import</span> <span class="n">ConstantCurve</span>
<span class="kn">from</span> <span class="nn">codelib.fixed_income.cash_flows</span> <span class="kn">import</span> <span class="n">CashFlow</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=democratic-compensation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Implementing-curve-and-cash-flow-classes">
        Implementing curve and cash flow classes
        <a class="anchor-link" href="#Implementing-curve-and-cash-flow-classes">
         ¶
        </a>
       </h1>
       <p>
        In this lecture note, we will define a discount curve class and cash flow class that enables us to utilize the power of object oriented programming.
       </p>
       <p>
        Please take the DataCamp course
        <a href="https://app.datacamp.com/learn/courses/object-oriented-programming-in-python">
         Object Oriented Programming in Python
        </a>
        before starting reading this notebook.
       </p>
       <h2 id="Implementing-a-discount-curve">
        Implementing a discount curve
        <a class="anchor-link" href="#Implementing-a-discount-curve">
         ¶
        </a>
       </h2>
       <p>
        In the lecture note
        <code>
         extracting_yield_curves.ipynb
        </code>
        , we implement different yield curves. One example was the often used parameterization of the term structure of interest by
        <a href="https://www.jstor.org/stable/2352957">
         Nelson and Siegel (1987)
        </a>
        . They specified the following parameterization of the instantaneous forward rate
       </p>
       $$
f(\tau) = \beta_0 + \beta_1 e^{-\tau / \theta} + \beta_2 \frac{\tau}{\theta} e^{-\tau / \theta} 
$$
       <p>
        From newly gained knowledge, we know that the continuous zero coupon yield can be written as
       </p>
       $$
y(\tau) = \frac{1}{\tau} \intop_{0}^\tau f(u)  du = \beta_0 + \beta_1 \frac{1 - e^{-\tau / \theta}}{\tau / \theta} + \beta_2 \left(\frac{1 - e^{-\tau / \theta}}{\tau / \theta} - e^{-\tau / \theta} \right)
$$
       <p>
        One possibility would be to follow the same steps as in the previous lecture note, i.e. defining different functions responsible for each step in the calibration / estimation of the term structure model. Another possibility would be to define a class that represents a yield curve and  contains the methods necessary for calibrating the model.
       </p>
       <p>
        When defining different curves, we will create a "generic" curve (abstract class) which contains the methods that we will require all different yield curves to implement. See
        <code>
         codelib.fixed_income.curves.curve_interface
        </code>
        in the course repository.
       </p>
       <p>
        Next, we will define a particular implementation of a yield curve namely the Nelson-Siegel curve. See
        <code>
         codelib.fixed_income.curves.nelson_siegel_curve
        </code>
        in the course repository.
       </p>
       <p>
        <strong>
         Example: Nelson-Siegel
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=compact-class">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Get Nelson-Siegel parameters</span>
<span class="sd">"""</span>

<span class="n">all_ns_parameters</span> <span class="o">=</span> <span class="n">get_nominal_yield_data</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s1">'parameters'</span><span class="p">)</span>
<span class="n">ns_parameters</span> <span class="o">=</span> <span class="n">all_ns_parameters</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'1979-12-31'</span><span class="p">]</span>
<span class="n">ns_parameters</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=varied-utilization">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Get Nelson-Siegel yields</span>
<span class="sd">"""</span>

<span class="n">all_ns_yields</span> <span class="o">=</span> <span class="n">get_nominal_yield_data</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s1">'zero_yields'</span><span class="p">)</span>
<span class="n">ns_yields</span> <span class="o">=</span> <span class="n">all_ns_yields</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'1979-12-31'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">ns_tenors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sensitive-million">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_ns_yields</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'1979-12-31'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=global-schema">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Create Nelson-Siegel curve</span>
<span class="sd">"""</span>

<span class="n">ns_curve</span> <span class="o">=</span> <span class="n">NelsonSiegelCurve</span><span class="p">(</span><span class="n">theta</span><span class="o">=</span><span class="n">ns_parameters</span><span class="p">[</span><span class="s1">'TAU1'</span><span class="p">],</span>
                             <span class="n">beta0</span><span class="o">=</span><span class="n">ns_parameters</span><span class="p">[</span><span class="s1">'BETA0'</span><span class="p">],</span>
                             <span class="n">beta1</span><span class="o">=</span><span class="n">ns_parameters</span><span class="p">[</span><span class="s1">'BETA1'</span><span class="p">],</span>
                             <span class="n">beta2</span><span class="o">=</span><span class="n">ns_parameters</span><span class="p">[</span><span class="s1">'BETA2'</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=roman-burton">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ns_tenors</span><span class="p">,</span> <span class="n">ns_curve</span><span class="o">.</span><span class="n">zero_rate_vector</span><span class="p">(</span><span class="n">ns_tenors</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">ns_tenors</span><span class="p">,</span> <span class="n">ns_yields</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zero yields (cont.)'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=artistic-intake">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Can we back out the correct parameters?</span>
<span class="sd">"""</span>

<span class="n">input_zero_rates</span> <span class="o">=</span> <span class="n">all_ns_yields</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'1979-12-31'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">values</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">input_tenors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">15.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">market_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">input_tenors</span> <span class="o">*</span> <span class="n">input_zero_rates</span><span class="p">)</span>
<span class="n">cash_flow_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>


<span class="n">ns_curve_est</span> <span class="o">=</span> <span class="n">NelsonSiegelCurve</span><span class="o">.</span><span class="n">create_from_cash_flow_matrix</span><span class="p">(</span><span class="n">payments_dates</span><span class="o">=</span><span class="n">input_tenors</span><span class="p">,</span> 
                                                              <span class="n">cash_flow_matrix</span><span class="o">=</span><span class="n">cash_flow_matrix</span><span class="p">,</span>
                                                              <span class="n">market_prices</span><span class="o">=</span><span class="n">market_prices</span><span class="p">,</span>
                                                              <span class="n">grid</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">))</span>

<span class="c1"># Note: Betas scaled with 100</span>
<span class="n">ns_curve_est</span><span class="o">.</span><span class="n">get_coefficients</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=attended-ceramic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Implementing-a-cash-flow-class">
        Implementing a cash flow class
        <a class="anchor-link" href="#Implementing-a-cash-flow-class">
         ¶
        </a>
       </h2>
       <p>
        Working with cash flows is at the heart of fixed income modelling! To find the price of a bond we need to discount its cash flows with appropriate discount rate. See
        <code>
         codelib.fixed_income.cash_flows
        </code>
        for an implementation of a cash flow object (it is assumed that we are working purely with continuous discounting).
       </p>
       <p>
        <strong>
         Example: Working with cash flow
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=funky-criminal">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Create a constant zero yield curve</span>
<span class="sd">"""</span>

<span class="n">constant_curve</span> <span class="o">=</span> <span class="n">ConstantCurve</span><span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="mf">0.02</span><span class="p">)</span>
<span class="n">constant_curve</span><span class="o">.</span><span class="n">zero_rate_vector</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=better-locking">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Create a cash flow and calculate present value using CashFlow class</span>
<span class="sd">"""</span>

<span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">flows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">time_points</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> 
<span class="n">flows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span>

<span class="n">cash_flow</span> <span class="o">=</span> <span class="n">CashFlow</span><span class="p">(</span><span class="n">time_points</span><span class="o">=</span><span class="n">time_points</span><span class="p">,</span> <span class="n">flows</span><span class="o">=</span><span class="n">flows</span><span class="p">)</span>
<span class="n">pv</span> <span class="o">=</span> <span class="n">cash_flow</span><span class="o">.</span><span class="n">present_value</span><span class="p">(</span><span class="n">curve</span><span class="o">=</span><span class="n">constant_curve</span><span class="p">)</span>
<span class="n">pv</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=unnecessary-clear">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Duration</span>
<span class="sd">"""</span>

<span class="n">duration</span> <span class="o">=</span> <span class="n">cash_flow</span><span class="o">.</span><span class="n">fisher_weil_duration</span><span class="p">(</span><span class="n">curve</span><span class="o">=</span><span class="n">constant_curve</span><span class="p">)</span>
<span class="n">duration</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=limiting-coverage">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">We can approximate price change from a 1 bps rate change as </span>
<span class="sd">"""</span>

<span class="n">duration</span> <span class="o">*</span> <span class="n">pv</span> <span class="o">*</span> <span class="mf">0.0001</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=devoted-metallic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">The exact price change</span>
<span class="sd">"""</span>

<span class="n">constant_curve_new</span> <span class="o">=</span> <span class="n">ConstantCurve</span><span class="p">(</span><span class="n">rate</span> <span class="o">=</span> <span class="mf">0.0201</span><span class="p">)</span>
<span class="n">pv_new</span> <span class="o">=</span> <span class="n">cash_flow</span><span class="o">.</span><span class="n">present_value</span><span class="p">(</span><span class="n">curve</span><span class="o">=</span><span class="n">constant_curve_new</span><span class="p">)</span>
<span class="n">pv_new</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=measured-hearts">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">pv</span> <span class="o">-</span> <span class="n">pv_new</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=complimentary-montgomery">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Convexity</span>
<span class="sd">"""</span>

<span class="n">convexity</span> <span class="o">=</span> <span class="n">cash_flow</span><span class="o">.</span><span class="n">fisher_weil_convexity</span><span class="p">(</span><span class="n">curve</span><span class="o">=</span><span class="n">constant_curve</span><span class="p">)</span>
<span class="n">convexity</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.jstor.org/stable/2326860">
         McCulloch (1975)
        </a>
       </p>
       <p>
        <a href="https://www.nber.org/papers/w4871">
         Svensson (1994)
        </a>
       </p>
       <p>
        <a href="https://www.jstor.org/stable/2352957">
         Nelson and Siegel (1987)
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.co.uk/Fixed-Income-Modelling-Claus-Munk/dp/0198716443">
         Claus Munk (2013), "Fixed income modelling"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="c1"># animations, etc. requires below magic command</span>
<span class="c1"># %matplotlib notebook</span>


<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span><span class="p">,</span> <span class="n">cm</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1">#import autograd</span>
<span class="c1"># functions to approx derivative and hessian </span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.numdiff</span> <span class="kn">import</span> <span class="n">approx_fprime</span><span class="p">,</span> <span class="n">approx_hess</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.statistics.moments</span> <span class="kn">import</span> <span class="n">calculate_cov_mat</span><span class="p">,</span>  <span class="n">calculate_cov_mat_factor</span><span class="p">,</span> <span class="n">calculate_outer_product</span>

<span class="kn">import</span> <span class="nn">codelib.statistics.historical_probabilities</span> <span class="k">as</span> <span class="nn">hp</span>

<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.risk_budget</span> <span class="kn">import</span> <span class="n">calculate_risk_contributions_std</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">waterfall_chart</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=funded-accident">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Introduction-to-estimation">
        Introduction to estimation
        <a class="anchor-link" href="#Introduction-to-estimation">
         ¶
        </a>
       </h1>
       <p>
        Estimation is key in financial economics!  The distribution of market invariants (e.g. returns) will generally be unknown and even if we can assume a particular distribution we need to be able to estimate the parameters describing the particular distribution.
       </p>
       <p>
        The choice of estimator will depend on a range of factors. Generally, the
        <a href="https://en.wikipedia.org/wiki/Bias%E2%80%93variance_tradeoff">
         variance-bias tradeoff
        </a>
        tells us that we with large amounts of data can apply very flexible non-parametric estimators while we may need to impose distributional assumptions or even shrinkage with less data.
       </p>
       <h2 id="What-is-an-estimator?">
        What is an estimator?
        <a class="anchor-link" href="#What-is-an-estimator?">
         ¶
        </a>
       </h2>
       <p>
        An
        <a href="https://en.wikipedia.org/wiki/Estimator">
         estimator
        </a>
        , typically denoted $\hat{\theta} (\mathbf{X})$, maps a random sample $X_1, ..., X_n$ (stacked in the vector $\mathbf{X}$) defined by e.g. the pdf $f_X(x;\theta)$, where $\theta$ is an unknown parameter, to a set of
        <em>
         sample estimates
        </em>
        . It is important to note that the estimator is a function of random variables and therefore itself a random variable.
       </p>
       <p>
        For a particular realization of the random sample $x_1, ..., x_n$ (stacked in the vector $\mathbf{x}$), we obtain the estimate $\hat{\theta} (\mathbf{x})$ which is a fixed value.
       </p>
       <p>
        Some well-known estimators include the
        <em>
         sample mean
        </em>
       </p>
       $$
\begin{equation*}
\bar{X} = \frac{1}{n} \sum_{i=1}^n X_i
\end{equation*}
$$
       <p>
        The
        <em>
         sample variance
        </em>
        $$
\begin{equation*}
S^2 = \frac{1}{n-1} \sum_{i=1}^n (X_i - \bar{X})^2
\end{equation*}
$$
       </p>
       <p>
        The
        <em>
         sample covariance
        </em>
       </p>
       $$
\begin{equation*}
C_{X,Y} = \frac{1}{n} \sum_{i=1}^n (X_i - \bar{X})(Y_i - \bar{Y})
\end{equation*}
$$
       <h2 id="Properties-of-estimators">
        Properties of estimators
        <a class="anchor-link" href="#Properties-of-estimators">
         ¶
        </a>
       </h2>
       <p>
        We will discuss some important properties of estimators
       </p>
       <ul>
        <li>
         Unbiasedness
        </li>
        <li>
         Consistency
        </li>
        <li>
         Efficiency
        </li>
        <li>
         Asymptotic normality
        </li>
       </ul>
       <h3 id="Unbiasedness">
        Unbiasedness
        <a class="anchor-link" href="#Unbiasedness">
         ¶
        </a>
       </h3>
       <p>
        An estimator will take on different values from sample to sample (the estimate), but we would like the property that we on average get the right estimate.
       </p>
       <p>
        An estimator is said to be
        <a href="https://en.wikipedia.org/wiki/Bias_of_an_estimator">
         unbiased
        </a>
        if its expected value is equal to the true value $\theta$:
       </p>
       $$
\text{E}[\hat{\theta} (\mathbf{X})]  = \theta
$$
       <p>
        <strong>
         Example: Sample mean
        </strong>
       </p>
       <p>
        Let $X_1,...,X_n$ be an independent sample of size $n$ all with the same pdf and mean $\text{E}[X_i] = \mu$. Define the sample mean
       </p>
       $$
\begin{equation*}
\bar{X}_n = \frac{1}{n} \sum_{i=1}^n X_i
\end{equation*} 
$$
       <p>
        Then due to independence,
       </p>
       $$
\begin{align*}
E[\bar{X}_n] &amp;amp;=  \frac{1}{n} \sum_{i=1}^n \text{E}[X_i] = \mu  \\
\text{Var}[\bar{X}_n] &amp;amp;= \frac{1}{n^2} \sum_{i=1}^n \text{Var}[X_i] = \frac{\sigma^2}{n}
\end{align*}
$$
       <p>
        Thus, the sample mean is an unbiased estimator.
       </p>
       <p>
        <strong>
         Example: A single realization
        </strong>
       </p>
       <p>
        Choosing the value of a single realization will also be an unbiased estimator since $\text{E}[X_i] = \mu$. The problem is of course that the variance of this estimator is $\text{Var}[X_i] = \sigma^2 &amp;gt; \frac{\sigma^2}{n}$.
       </p>
       <p>
        <strong>
         Example: Sample variance
        </strong>
       </p>
       <p>
        An natural estimator for the variance is given by
       </p>
       $$
\begin{equation*}
\hat{\sigma}^2 = \frac{1}{n} \sum_{i=1}^n (X_i - \bar{X})^2
\end{equation*}
$$
       <p>
        However, one can show that 
$$
\begin{equation*}
\text{E}[\hat{\sigma}^2] = \frac{n-1}{n} \sigma^2
\end{equation*}
$$
       </p>
       <p>
        Hence, it is not an unbiased estimator and we therefore typically use
       </p>
       $$
\begin{equation*}
S^2 = \frac{1}{n-1} \sum_{i=1}^n (X_i - \bar{X})^2
\end{equation*}
$$
       <h3 id="Consistency">
        Consistency
        <a class="anchor-link" href="#Consistency">
         ¶
        </a>
       </h3>
       <p>
        An estimator $\hat{\theta}(\mathbf{X})$ is said to be
        <a href="https://en.wikipedia.org/wiki/Consistent_estimator">
         consistent
        </a>
        for $\theta$ if it converges in probability to $\theta$ - that is, if for all $\varepsilon&amp;gt;0$,
       </p>
       $$
\begin{equation*}
\lim_{n\to\infty} P(\vert \hat{\theta}(\mathbf{X}) - \theta\vert &amp;lt; \varepsilon) = 1
\end{equation*}
$$
       <p>
        which we also will write as
       </p>
       $$
\text{plim } \hat{\theta}(\mathbf{X}) = \theta
$$
       <p>
        For consistency, it is sufficient to show that (almost sure convergence)
       </p>
       $$
\begin{equation*}
\lim_{n\to \infty} \text{E}[\hat{\theta}(\mathbf{X})] = \theta
\end{equation*}
$$
       <p>
        and
       </p>
       $$
\begin{equation*}
\lim_{n\to \infty}\text{Var}[\hat{\theta}(\mathbf{X})] = 0
\end{equation*}
$$
       <p>
        <strong>
         Example: The sample mean
        </strong>
       </p>
       <p>
        Again, let $X_1,...,X_n$ be an independent sample of size $n$ all with the same pdf and mean $\text{E}[X_i] = \mu$.
       </p>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Law_of_large_numbers">
         Law of Large Numbers (LLN)
        </a>
        tells us (under some regularity conditions) that
       </p>
       $$
\begin{equation*}
\text{plim } \bar{X}_n = \mu
\end{equation*}
$$
       <p>
        or more precisely
       </p>
       $$
\begin{equation*}
\lim_{n \to \infty} P(\vert \bar{X}_n - \mu \vert &amp;gt; \varepsilon) = 0
\end{equation*}
$$
       <p>
        for all $\varepsilon&amp;gt;0$. We call this for convergence in probability.
       </p>
       <p>
        We note that
       </p>
       $$
\begin{align*}
\text{E}[\bar{X}_n] &amp;amp;=  \frac{1}{n} \sum_{i=1}^n \text{E}[X_i] = \mu  \\
\text{Var}[\bar{X}_n] &amp;amp;= \frac{1}{n^2} \sum_{i=1}^n \text{Var}[X_i] = \frac{\sigma^2}{n}
\end{align*}
$$
       <p>
        implying that the sample mean is unbiased and the variance converges to zero with the sample size. Thus, we have almost sure convergence.
       </p>
       <p>
        As an example, we consider the uniform distribution $X \sim U(-5,5)$. Draw 10, 100, 500 and 1000 observations from the uniform distribution 10,000 times, calculate the sample mean for each iteration and blot the histogram of the sample means.
       </p>
       <p>
        We see that the distribution collapses around the true value!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=round-atlantic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Draw uniform numbers</span>
<span class="sd">"""</span>
<span class="n">a</span> <span class="o">=</span> <span class="o">-</span><span class="mf">5.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">5.0</span>

<span class="n">uniform_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="n">a</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="mi">10000</span><span class="p">))</span>

<span class="n">true_var</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span><span class="o">-</span><span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mi">12</span>
<span class="n">true_mean</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="n">b</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">ax_</span> <span class="o">=</span> <span class="n">ax_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>


<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]):</span> 

    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># get section of generated data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">uniform_data</span><span class="p">[:</span><span class="n">N</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="c1"># calculate sample means</span>
    <span class="n">sample_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># plot histogram </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sample_means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Histogram of sample mean for N = "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axisbelow</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">3.5</span><span class="p">,</span><span class="mf">3.5</span><span class="p">]);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=signal-future">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Efficiency">
        Efficiency
        <a class="anchor-link" href="#Efficiency">
         ¶
        </a>
       </h3>
       <p>
        If we have two unbiased estimators for a parameter $\theta$, $\hat{\theta}_1$ and $\hat{\theta}_2$, then if
       </p>
       $$
\begin{equation*}
\text{Var}[\hat{\theta}_1] &amp;lt; \text{Var}[\hat{\theta}_2]
\end{equation*}
$$
       <p>
        we say that $\hat{\theta}_1$ is more efficient than $\hat{\theta}_2$.
       </p>
       <p>
        A classical example (already mentioned) is that an element in a sample $X_i$ is an unbiased estimator of the expected value, just as the sample mean
       </p>
       $$
\begin{equation*}
\text{E}[X_i] = \mu
\end{equation*}
$$
       <p>
        However, this estimator has the variance $\sigma^2$ while the variance of the sample mean is
       </p>
       $$
\begin{equation*}
\text{Var}[\bar{X}] = \frac{1}{n^2}\sum_{i=1}^n \text{Var}[X_i] = \frac{\sigma^2}{n}
\end{equation*}
$$
       <p>
        Clearly more efficient!
       </p>
       <p>
        <strong>
         Cramér-Rao's lower bound
        </strong>
       </p>
       <p>
        It will generally hold that if we have a random sample $X_1,...,X_n$ from the pdf $f_X(x;\theta)$, where $\theta$ is an unknown parameter and the estimator $\hat{\theta}(\mathbf{X})$, then
       </p>
       $$
\begin{equation*}
\text{Var}[\hat{\theta}] \geq \left[n \text{E} \left[ \left(\frac{\partial \ln f_X(X; \theta)}{\partial \theta} \right)^2\right] \right]^{-1} = \left[ -n \text{E} \left[ \frac{\partial^2 \ln f_X(X; \theta)}{\partial \theta^2}\right]\right]^{-1}
\end{equation*}
$$
       <p>
        which is known as
        <a href="https://en.wikipedia.org/wiki/Cram%C3%A9r%E2%80%93Rao_bound">
         Cramér-Rao's lower bound
        </a>
        . We will later see that the maximum-likelihood estimator satisfies Cramér-Rao's lower bound ensuring that the maximum-likelihood estimator is the most efficient.
       </p>
       <p>
        <strong>
         Example: Sample mean
        </strong>
       </p>
       <p>
        Let $X_1,...,X_n$ be an independent sample of size $n$ all with $X_i \sim N(\mu, \sigma^2)$. Then, we have
       </p>
       $$
\frac{\partial \ln f_X(X; \mu, \sigma)}{\partial \mu} = \frac{\partial }{\partial \mu} \left[- \ln (\sigma \sqrt{2\pi}) -\frac{(X-\mu)^2}{2 \sigma^2} \right] = -2 \frac{X-\mu}{2 \sigma^2} = -\frac{X-\mu}{ \sigma^2} 
$$
       <p>
        and
       </p>
       $$
\text{E}\left[ \left(-\frac{X-\mu}{ \sigma^2} \right)^2 \right] = \text{E}\left[ \frac{1}{\sigma^2} \frac{(X-\mu)^2}{ \sigma^2} \right] =  \frac{1}{\sigma^2}  \frac{ \text{E}\left[(X-\mu)^2 \right]}{ \sigma^2} = \frac{1}{\sigma^2}  \frac{ \sigma^2}{ \sigma^2} = \frac{1}{\sigma^2} 
$$
       <p>
        Thus, the lower-bound for the variance is
       </p>
       $$
\text{Var}[\hat{\mu}] \geq \left[n  \frac{1}{\sigma^2} \right]^{-1} = \frac{\sigma^2}{n}
$$
       <p>
        showing that the sample mean is the most efficient estimator (unbiased) in the normal case.
       </p>
       <h3 id="Asymptotic-normality">
        Asymptotic normality
        <a class="anchor-link" href="#Asymptotic-normality">
         ¶
        </a>
       </h3>
       <p>
        A consistent estimator is said to be asymptotically normally distributed if the distribution of the estimator converges to a normal distribution, typically, at the rate $1 / \sqrt{n}$ (the standard deviation shrinks at this rate). We will write
       </p>
       $$
\sqrt{n} (\hat{\theta} - \theta) \to^d N(0, V)
$$
       <p>
        where $V/n$ is called the asymptotic variance.
       </p>
       <p>
        <strong>
         Example: Sample mean
        </strong>
       </p>
       <p>
        <a href="https://en.wikipedia.org/wiki/Central_limit_theorem">
         The Central Limit Theorem (CLT)
        </a>
        tells us that for an iid random sample of size $n$ and if $\sigma &amp;lt; \infty$
       </p>
       $$
\begin{equation*}
\lim_{n\to \infty} P\left(\frac{\bar{X}_n - \mu}{\sigma/\sqrt{n}} &amp;lt; z \right) = \Phi(z)
\end{equation*}
$$
       <p>
        where $\Phi(z)$ denotes the standard normal cdf.
       </p>
       <p>
        It follows directly that
       </p>
       $$
\sqrt{n}(\bar{X}_n - \mu) \to^d N\left(0, \frac{\sigma^2}{n}\right)
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=isolated-yeast">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="A-brief-look-at-Ordinary-Least-Squares-(OLS)">
        A brief look at Ordinary Least Squares (OLS)
        <a class="anchor-link" href="#A-brief-look-at-Ordinary-Least-Squares-(OLS)">
         ¶
        </a>
       </h2>
       <p>
        We will write a linear regression model (using matrix notation) as
       </p>
       $$
\mathbf{y} = \mathbf{X}\boldsymbol{\beta} + \mathbf{e}
$$
       <p>
        where $\mathbf{y}$ is the $n \times 1$ vector of dependent variables, $\mathbf{X}$ is the $n \times k$ matrix of regressors (independent variables) and $\mathbf{e}$ is the $n \times 1$ error vector.
       </p>
       <p>
        As the name implies, the OLS estimator minimizes the sum of squared residuals
       </p>
       $$
Q_n (\boldsymbol{\beta}) = \sum_{i=1}^n (y_i - \mathbf{x}_i^\top \boldsymbol{\beta} )^2 = (\mathbf{y} - \mathbf{X}\boldsymbol{\beta})^\top (\mathbf{y} - \mathbf{X}\boldsymbol{\beta}) = \mathbf{e}^\top \mathbf{e}
$$
       <p>
        Taking the derivative wrt. $\boldsymbol{\beta}$ and setting equal to zero yields the estimator
       </p>
       $$
\hat{\boldsymbol{\beta}}_{OLS} = (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{y}
$$
       <h3 id="Properties-of-OLS">
        Properties of OLS
        <a class="anchor-link" href="#Properties-of-OLS">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Note
        </strong>
        : It is not expected that you know all the finer details in deriving the asymptotic properties of e.g. the OLS estimator, but only how to implement derived formulas in Python.
       </p>
       <p>
        <strong>
         Consistency
        </strong>
       </p>
       $$
\begin{align}
\hat{\boldsymbol{\beta}}_{OLS} &amp;amp;= (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{y} \\
&amp;amp;= (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top (\mathbf{X}\boldsymbol{\beta} + \mathbf{e}) \\
&amp;amp;= (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{X}\boldsymbol{\beta} + (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{e} \\
&amp;amp;= \boldsymbol{\beta} + (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{e} \\
&amp;amp;= \boldsymbol{\beta} + \left(\frac{1}{n}\mathbf{X}^\top \mathbf{X}\right)^{-1} \frac{1}{n}\mathbf{X}^\top \mathbf{e} 
\end{align}
$$
       <p>
        Basically, for consistency we need (without going into details)
       </p>
       $$
\text{plim} \frac{1}{n}\mathbf{X}^\top \mathbf{X} = \lim \frac{1}{n} \text{E} \left[ \mathbf{X}^\top\mathbf{X} \right]  =  \mathbf{M_{xx}}
$$
       <p>
        where $\mathbf{M_{xx}}$ is a non-singular matrix (invertible), and
       </p>
       $$
\text{plim} \frac{1}{n}\mathbf{X}^\top \mathbf{e} =  \lim \frac{1}{n} \text{E} \left[ \mathbf{X}^\top\mathbf{e} \right] =\mathbf{0}
$$
       <p>
        requiring the regressors and error term to be uncorrelated.
       </p>
       <p>
        <strong>
         Asymptotic normality
        </strong>
       </p>
       <p>
        Rewritting the above expression yields
       </p>
       $$
\sqrt{n}(\hat{\boldsymbol{\beta}}_{OLS} - \boldsymbol{\beta}) = \left(\frac{1}{n}\mathbf{X}^\top \mathbf{X}\right)^{-1} \frac{1}{\sqrt{n}}\mathbf{X}^\top \mathbf{e} 
$$
       <p>
        If we can apply a CLT to $\frac{1}{\sqrt{n}}\mathbf{X}^\top \mathbf{e}$ such that it converges to multivariate normal distribution with finite, non-singular covariance matrix, we will have asymptotic normality.
       </p>
       <p>
        Assuming that
       </p>
       $$
\frac{1}{\sqrt{n}}\mathbf{X}^\top \mathbf{e} \to^d N(\mathbf{0}, \mathbf{M_{x\Omega x}})
$$
       <p>
        with  (here $\boldsymbol{\Omega}=\text{E}[\mathbf{e} \mathbf{e}^\top \vert \mathbf{X}] = \text{Diag}[\sigma_i^2]$ is the covariance matrix of the errors)
       </p>
       $$
\text{plim} \frac{1}{n}\mathbf{X}^\top \mathbf{e} \mathbf{e}^\top\mathbf{X} = \text{plim} \frac{1}{n}\mathbf{X}^\top  \boldsymbol{\Omega} \mathbf{X}  = \mathbf{M_{x\Omega x}}
$$
       <p>
        then it will be possible to show that
       </p>
       $$
\sqrt{n}(\hat{\boldsymbol{\beta}}_{OLS} - \boldsymbol{\beta}) \to^d N\left(\mathbf{0}, \mathbf{M_{xx}}^{-1} \mathbf{M_{x\Omega x}}\mathbf{M_{xx}}^{-1}\right)
$$
       <p>
        <strong>
         Homoskedasticity vs. heteroskedasticity
        </strong>
       </p>
       <p>
        If $\boldsymbol{\Omega}=\text{E}[\mathbf{e}^\top \mathbf{e} \vert \mathbf{X}] = \text{Diag}[\sigma^2] = \sigma^2 \mathbf{I}$ then the error term is said to be homoskedastic and
       </p>
       $$
\sqrt{n}(\hat{\boldsymbol{\beta}}_{OLS} - \boldsymbol{\beta}) \to^d N\left(\mathbf{0}, \sigma^2 \mathbf{M_{xx}}^{-1} \mathbf{M_{xx}}\mathbf{M_{xx}}^{-1}\right) = N\left(\mathbf{0}, \sigma^2 \mathbf{M_{xx}}^{-1} \right) 
$$
       <p>
        where we will estimate $\hat{\mathbf{M}}_{\mathbf{xx}} = \frac{1}{n} \mathbf{X}^\top\mathbf{X}$ and $\sigma^2$ using the sample variance.
       </p>
       $$
S^2 = \frac{1}{n - k} \hat{\mathbf{e}}^\top \hat{\mathbf{e}}
$$
       <p>
        This leads to the variance estimator of the OLS estimator
       </p>
       $$
\hat{\text{Var}}[\hat{\boldsymbol{\beta}}_{OLS}] = S^2 \left( \mathbf{X}^\top\mathbf{X} \right)^{-1}
$$
       <p>
        If the error term is heteroskedastic then $\sigma_i^2$ differs between observations.
        <a href="https://en.wikipedia.org/wiki/Heteroscedasticity-consistent_standard_errors">
         Heteroscedastic robust standard errors
        </a>
        can be obtained using (under some regularity conditions)
       </p>
       $$
\hat{\text{Var}}[\hat{\boldsymbol{\beta}}_{OLS}] = \left( \mathbf{X}^\top\mathbf{X} \right)^{-1} \mathbf{X}^\top \hat{\boldsymbol{\Omega}}\mathbf{X} \left( \mathbf{X}^\top\mathbf{X} \right)^{-1}
$$
       <p>
        where $\hat{\boldsymbol{\Omega}} = \text{Diag}[\hat{e}_i^2]$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3cf9a6bb">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Distribution of  OLS estimator
        </strong>
       </p>
       <p>
        Consider the regression model
       </p>
       $$
y_i = \alpha + \beta_1 x_{1, i} + \beta_{2, i} x_{2, i} + \varepsilon_i =  \mathbf{x}_i^\top \boldsymbol{\beta} + \varepsilon_i
$$
       <p>
        where $\alpha=1$, $\beta_1 = 1$, and $\beta_2 = 1$. Furthermore, assume that $x_{1, i} \sim \log N(0, 1)$, $x_{2, i} \sim \log N(0, 1)$ and $\varepsilon_{i} + e^{\frac{0.1^2}{2}} \sim \log N(0, 0.1^2)$ (we added the mean to make the error term have a mean of zero).
       </p>
       <p>
        Simulate and estimate the model with OLS 10,000 times for different sample sizes. Plot the kernel density of the estimates. What do you observe, when the sample size increases?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a5e709d8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Settings</span>
<span class="sd">"""</span>

<span class="c1"># number of simulations</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># sample size </span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># true parameter values: constant, beta1, beta2</span>
<span class="n">beta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

<span class="sd">"""</span>
<span class="sd">Simulations</span>
<span class="sd">"""</span>

<span class="n">all_beta_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta0</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span> 
    
    <span class="c1"># generate independent variables</span>
    <span class="n">x1_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span> 
    <span class="n">x2_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="n">x_mat_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span> <span class="n">x1_sim</span><span class="p">,</span> <span class="n">x2_sim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># simulate error term</span>
    <span class="n">eps_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=-</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">0.1</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="mf">0.5</span><span class="p">),</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span> <span class="c1"># s: sigma, scale: exp(mu), loc: exp(mu + sigma^2 / 2)</span>

    <span class="c1"># simulate dependent variable</span>
    <span class="n">y_sim</span> <span class="o">=</span> <span class="n">x_mat_sim</span> <span class="o">@</span> <span class="n">beta0</span> <span class="o">+</span> <span class="n">eps_sim</span>
    
    <span class="c1"># estimate parameters</span>
    <span class="n">beta_est</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">x_mat_sim</span><span class="p">,</span> <span class="n">y_sim</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">all_beta_est</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">beta_est</span>

<span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>
    
<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 0: constant, 1: beta1, 2: beta2</span>
<span class="n">param_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">alpha$'</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_1$'</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_2$'</span><span class="p">}</span>
<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_beta_est</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta0</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated distribution"</span><span class="p">)</span>

<span class="n">norm_params</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

<span class="n">vals_to_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vals_to_eval</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">norm_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">vals_to_eval</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">"Fitted normal distribution"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of OLS estimator for "</span> <span class="o">+</span> <span class="n">param_name_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">", sample size: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_size</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=01a325b6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: OLS with flexible probabilities
        </strong>
       </p>
       <p>
        We have previously introduced the idea to assign different probabilities to observations. It will also be possible to obtain the ordinary least squares estimates with "flexible" probabilities. One possible way of estimating OLS with flexible probabilites is given by
       </p>
       $$
\hat{\boldsymbol{\beta}}_{OLS,FL} = \left( \sum_{t=1}^T p_t \mathbf{x}_t  \mathbf{x}_t^\top \right)^{-1} \left( \sum_{t=1}^T p_t \mathbf{x}_t y_t  \right)
$$
       <p>
        where $p_t$ is the probability related to observation $t$. Note that we use "$t$" instead of "$i$" since we typically will apply flexible probabilites in a time series context.
       </p>
       <p>
        Use the Fama-French three-factor model to estimate factor loadings for industry portfolios with equally weighted probabilities and the case where we only assign probabilites to observations with a negative market excess return.
       </p>
       <p>
        In addition, calculate the standard deviation risk contributions when using the Fama-French factors.
       </p>
       <p>
        <strong>
         Note:
        </strong>
        If we can write e.g. the return $\boldsymbol{Y}$ as a linear function of a set of risk drives $\boldsymbol{Z}$
       </p>
       $$
\mathbf{y} =  \mathbf{z}^\top \boldsymbol{\beta}
$$
       <p>
        Then, we can use the Euler principle to allocate the marginal risk contribution to the different factors. We are assuming that a possible idiosyncratic error (residual in our regression model) is included in the factors.
       </p>
       <p>
        If the risk measure is homogenous of degree one, we could write
       </p>
       $$
RC_i = \beta_i \frac{\partial \rho (\mathbf{z}^\top \boldsymbol{\beta})}{\partial \beta_i}
$$
       <p>
        where $\rho()$ is the risk measure.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2fdc3daa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Obtain Fama-French data</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=19d70d10">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ff_data</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s1">'F-F_Research_Data_Factors'</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s2">"1990-01-01"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">ff_data</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e7a00627">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ff_monthly_returns</span> <span class="o">=</span> <span class="n">ff_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">ff_monthly_returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=addfbb65">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">industry_data</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s1">'17_Industry_Portfolios'</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s2">"1990-01-01"</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">industry_data</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=52f46cc9">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">industry_monthly_return</span> <span class="o">=</span> <span class="n">industry_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">industry_monthly_return</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">industry_monthly_return</span><span class="o">.</span><span class="n">columns</span><span class="p">]</span>
<span class="n">industry_monthly_return</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=703b3d9d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define inputs</span>
<span class="sd">"""</span>

<span class="n">asset_id</span> <span class="o">=</span> <span class="s1">'FabPr'</span>

<span class="n">excess_returns</span> <span class="o">=</span> <span class="n">industry_monthly_return</span><span class="p">[</span><span class="n">asset_id</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="n">ff_monthly_returns</span><span class="p">[</span><span class="s1">'RF'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">factors</span> <span class="o">=</span> <span class="n">ff_monthly_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s1">'Mkt-RF'</span><span class="p">,</span> <span class="s1">'SMB'</span><span class="p">,</span> <span class="s1">'HML'</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3afca4c2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Estimate beta coefficents using equally weighted proabilities</span>
<span class="sd">"""</span>

<span class="c1"># equal weighted probabilities</span>
<span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">excess_returns</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">excess_returns</span><span class="p">))</span> 

<span class="c1"># estimate betas</span>
<span class="n">est_xx</span> <span class="o">=</span> <span class="n">calculate_outer_product</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">factors</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
<span class="n">est_xy</span> <span class="o">=</span> <span class="n">calculate_outer_product</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">excess_returns</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>

<span class="n">beta_eq_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">est_xx</span><span class="p">)</span> <span class="o">@</span> <span class="n">est_xy</span>
<span class="n">beta_eq_w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0b1671b2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Only assign probabilities to negative market excess return</span>
<span class="sd">"""</span>

<span class="n">probs_neg</span> <span class="o">=</span> <span class="n">hp</span><span class="o">.</span><span class="n">crisp_conditioning_probs</span><span class="p">(</span><span class="n">factors</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ff_monthly_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(),</span> <span class="n">ff_monthly_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">'Mkt-RF'</span><span class="p">]);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Mkt-RF'</span><span class="p">);</span>

<span class="n">ax_new</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

<span class="n">ax_new</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">ff_monthly_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(),</span> <span class="n">probs_neg</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">ax_new</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Assigned probability"</span><span class="p">)</span>
<span class="n">ax_new</span><span class="o">.</span><span class="n">grid</span><span class="p">(</span><span class="kc">None</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Assigned probabilities"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a2941e05">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># estimate betas</span>
<span class="n">est_xx</span> <span class="o">=</span> <span class="n">calculate_outer_product</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">factors</span><span class="p">,</span> <span class="n">probs_neg</span><span class="p">)</span>
<span class="n">est_xy</span> <span class="o">=</span> <span class="n">calculate_outer_product</span><span class="p">(</span><span class="n">factors</span><span class="p">,</span> <span class="n">excess_returns</span><span class="p">,</span> <span class="n">probs_neg</span><span class="p">)</span>

<span class="n">beta_fl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">est_xx</span><span class="p">)</span> <span class="o">@</span> <span class="n">est_xy</span>
<span class="n">beta_fl</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3f15023c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Factor exposure - risk attribution</span>
<span class="sd">"""</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3f22da27">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate residual</span>
<span class="n">residual</span> <span class="o">=</span> <span class="n">excess_returns</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">-</span>  <span class="n">factors</span> <span class="o">@</span> <span class="n">beta_fl</span>

<span class="c1"># exted factors with residual</span>
<span class="n">extended_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">([</span><span class="n">factors</span><span class="p">,</span> <span class="n">residual</span><span class="p">])</span>

<span class="c1"># calculate covariance matrix of factors - with probabilites!</span>
<span class="n">cov_ext_factors</span> <span class="o">=</span> <span class="n">calculate_cov_mat</span><span class="p">(</span><span class="n">extended_factors</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs_neg</span><span class="p">)</span>

<span class="c1"># calculate extended beta vector - the exposure to the residual is 1! </span>
<span class="n">beta_fl_ext</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">beta_fl</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=84b93165">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate risk contributions</span>
<span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">beta_fl_ext</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">cov_ext_factors</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3e3a3b90">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">waterfall_chart</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">risk_contrib</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">"Market"</span><span class="p">,</span> <span class="s2">"SMB"</span><span class="p">,</span> <span class="s1">'HML'</span><span class="p">,</span> <span class="s1">'Idiosyncratic'</span><span class="p">],</span>
                <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span>
                <span class="n">total_label</span><span class="o">=</span><span class="s2">"Total risk"</span><span class="p">,</span>
                <span class="n">title</span><span class="o">=</span><span class="s2">"Risk decompostion, standard devation (monthly)"</span><span class="p">);</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=characteristic-evaluation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Maximum-likelihood-estimation-(MLE)">
        Maximum likelihood estimation (MLE)
        <a class="anchor-link" href="#Maximum-likelihood-estimation-(MLE)">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://en.wikipedia.org/wiki/Maximum_likelihood_estimation">
         Maximum likelihood estimation
        </a>
        is one of the most widely used estimation methods with a number of diserable properties, e.g. it will be the most efficient estimator among consistent asymptotically normal estimators.
       </p>
       <p>
        The MLE of $\theta_0$ basically seeks to select the $\theta$ that maximizes the likelihood of observing the actual sample. The joint density of the random sample $f(\mathbf{y}, \mathbf{X}; \theta)$, which will define as the likelihood function, can under an independence assumption be written as the product of the marginal densities
       </p>
       $$
L_n (\theta \vert \mathbf{y}, \mathbf{X}) = f(\mathbf{y}, \mathbf{X}; \theta) = \prod_{i=1}^n f_{y, \mathbf{x}_i} (y_i, \mathbf{x}_i; \theta)
$$
       <p>
        Since $\ln$ is a positive monotone transformation, we can equivalently maximize the log-likelihood function
       </p>
       $$
\mathcal{L}_n (\theta \vert \mathbf{y}, \mathbf{X}) = \ln L_n (\theta \vert \mathbf{y}, \mathbf{X}) = \sum_{i=1}^n \ln f_{y, \mathbf{x}_i} (y_i, \mathbf{x}_i; \theta)
$$
       <h3 id="Conditional-likelihood">
        Conditional likelihood
        <a class="anchor-link" href="#Conditional-likelihood">
         ¶
        </a>
       </h3>
       <p>
        We can factorize a density as the product between the conditional and marginal density
       </p>
       $$
L_n (\theta \vert \mathbf{y}, \mathbf{X}) = f(\mathbf{y}, \mathbf{X}; \theta) = f(\mathbf{y} \vert \mathbf{X}; \theta) f(\mathbf{X}; \theta)  
$$
       <p>
        Typically, we will only focus on the conditional density $f(\mathbf{y} \vert \mathbf{X}; \theta)$ since we are interested in $\mathbf{y}$ given $\mathbf{X}$ (we will do this below). It will not be an issue if $\mathbf{y}$ and $\mathbf{X}$ depends on different sets of parameters, which often will be a reasonable assumption (but not always).
       </p>
       <p>
        In
        <em>
         time series modelling
        </em>
        , we also often use the notion of a conditional likelihood function since we cannot always apply an independence assumption.  Assume e.g. that $y_t$ depends on $y_{t-1}$ (and no regressors) then we could factorize (using T to indicate time series context)
       </p>
       $$
\begin{align}
L_T (\theta \vert \mathbf{y}) &amp;amp;= f_{y_0, \dots, y_T}(y_0, \dots, y_T; \theta) \\
&amp;amp;= f_y(y_0; \theta) f_{y_1, \dots, y_T}(y_1, \dots, y_T; \theta) \\
&amp;amp;= f_y(y_0; \theta) \prod_{t=1}^T f_{y_t \vert y_{t-1}}(y_t \vert y_{t-1}; \theta)
\end{align}
$$
       <p>
        dropping $f_y(y_0; \theta)$ will result in the conditional likelihood function that is conditional on the starting value.
       </p>
       <p>
        <strong>
         Remember:
        </strong>
        Most optimizers seek to minimize a function so we may need to multiply with minus one and then minimize.
       </p>
       <p>
        <strong>
         Example: Bernoulli
        </strong>
       </p>
       <p>
        Assume that we observe a realization of the random sample $Y_1, ...., Y_{n}$ where $Y_i\sim \text{Bernoulli}(p), i=1,...,n$
       </p>
       <p>
        We can write the likelihood function as
       </p>
       $$
\begin{equation*}
L(p) = \prod_{i=1}^n f_Y(y_i;p) = \prod_{i=1}^n p^{y_i}(1-p) ^{1-y_i} = p^{\sum_{i=1}^n y_i}(1-p)^{\sum_{i=1}^n (1-y_i)}
\end{equation*}
$$
       <p>
        We want to maximize with respect to $p$, but we first take the natural logarithm
       </p>
       $$
\begin{equation*}
\ln L(p) = \ln (p) \sum_{i=1}^n y_i + \ln(1-p) \sum_{i=1}^n (1-y_i)
\end{equation*}
$$
       <p>
        The first order condition is (take derivative wrt. $p$)
       </p>
       $$
\begin{equation*}
\frac{1}{p} \sum_{i=1}^n y_i - \frac{1}{1-p} \left[n - \sum_{i=1}^n y_i \right] = 0
\end{equation*}
$$
       <p>
        such that we obtain the maximum-likelihood estimate
       </p>
       $$
p_e = \frac{1}{n}\sum_{i=1}^n y_i
$$
       <p>
        Below, we see a simple implementation in Python
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=local-trainer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define log-likelihood function</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">log_likelihood_function</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    
    <span class="n">log_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">log_like</span>

<span class="sd">"""</span>
<span class="sd">Generate data</span>
<span class="sd">"""</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">bernoulli_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Minimize negative of log-likelihood</span>
<span class="sd">"""</span>
<span class="n">neg_log_lik</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">log_likelihood_function</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bernoulli_data</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">neg_log_lik</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">{(</span><span class="mf">0.00001</span><span class="p">,</span><span class="mf">0.99999</span><span class="p">)})</span>
<span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=christian-person">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Information-matrix-equality">
        Information matrix equality
        <a class="anchor-link" href="#Information-matrix-equality">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Fisher_information">
         information matrix
        </a>
        can equivalently be written as
       </p>
       $$
I(\theta) = -\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] = \text{E} \left[ \left. \frac{\partial \mathcal{L}_n (\theta)}{\partial \theta } \frac{\partial \mathcal{L}_n (\theta)}{\partial \theta^\top } \right \vert_{\theta = \theta_0}\right]
$$
       <h3 id="Asymptotic-distribution">
        Asymptotic distribution
        <a class="anchor-link" href="#Asymptotic-distribution">
         ¶
        </a>
       </h3>
       <p>
        The asymptotic distribution of the MLE is given by
       </p>
       $$
\hat{\theta}_{MLE} \sim ^a N\left(\theta_0, -\left(\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1}\right)
$$
       <p>
        Note that
       </p>
       $$
V(\hat{\theta}_{MLE} ) = -\left(\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1}
$$
       <p>
        corresponds to Cramér-Rao's lower bound such that the MLE is the most efficient estimator among consistent and asympotically normal estimators.
       </p>
       <p>
        <strong>
         Note:
        </strong>
        To avoid confusion we may note that
       </p>
       $$
-\left(\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1} = -\left(\text{E} \left[ \left. \sum_{i=1}^n \frac{\partial^2 \ln f_y(y_i; \theta) }{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1} = - \left(n\text{E} \left[ \left.  \frac{\partial^2 \ln f_y(y_i; \theta) }{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1}  
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=level-howard">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Bernoulli (cont'd)
        </strong>
       </p>
       <p>
        For a Bernoulli distribution, we have that
       </p>
       \begin{equation*}
\ln f_y(y_i;p) = \ln(p) y_i + \ln(1-p) (1-y_i)
\end{equation*}
       <p>
        such that
       </p>
       $$
\frac{\partial \ln f_y(y_i;p)}{\partial p} = \frac{1}{p}y_i - \frac{1}{1 - p} (1 - y_i)
$$
       <p>
        and
       </p>
       $$
\frac{\partial \ln f_y(y_i;p)^2}{\partial p^2} = -\frac{1}{p^2}y_i - \frac{1}{(1 - p)^2} (1 - y_i)
$$
       <p>
        Since $\text{E}[y_i] = p$, we obtain
       </p>
       $$
\text{E}\left[\frac{\partial \ln f_y(y_i;p)^2}{\partial p^2} \right] = -\frac{1}{p^2}p - \frac{1}{(1 - p)^2} (1 - p) = -\frac{1}{p} - \frac{1}{1-p} = -\frac{1}{(1-p)p}
$$
       <p>
        Thus, the asymptotic variance is given by
       </p>
       $$
V(\hat{p}) =  - \left(- n\frac{1}{(1-p)p}\right)^{-1} = \frac{(1-p)p}{n} 
$$
       <p>
        So, when $n$ is large then we have that the distribution of $\hat{p}$ is given by
       </p>
       $$
\hat{p} \sim^a N\left(p, \frac{(1-p)p}{n}  \right)
$$
       <p>
        Let us check it out!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sudden-massachusetts">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">bernoulli_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">))</span>

<span class="n">p_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax_</span> <span class="o">=</span> <span class="n">ax_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]):</span> 

    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># asymptotic variance</span>
    <span class="n">asymp_est_var</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    
    
    <span class="c1"># get section of generated data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bernoulli_data</span><span class="p">[:</span><span class="n">N</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="c1"># calculate sample means</span>
    <span class="n">sample_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># plot histogram </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sample_means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_vals</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">p_vals</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">asymp_est_var</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Histogram of $\hat</span><span class="si">{p}</span><span class="s2">$ for N = "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axisbelow</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=innovative-porcelain">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Non-linear-Least-Squares-(NLS)">
        Non-linear Least Squares (NLS)
        <a class="anchor-link" href="#Non-linear-Least-Squares-(NLS)">
         ¶
        </a>
       </h2>
       <p>
        A non-linear regression model specifies the conditional mean as
       </p>
       $$
\text{E}[y_i \vert \mathbf{x}_i] = g(\mathbf{x}_i; \theta)
$$
       <p>
        or equivalently written as (assuming that $\text{E}[\mathbf{e} \vert \mathbf{x}] = 0$)
       </p>
       $$
y_i = g(\mathbf{x}_i; \theta) + e_i
$$
       <p>
        Clearly, linear regression is the special case $g(\mathbf{x}_i; \beta) = \mathbf{x}_i^\top \beta$.
       </p>
       <p>
        The NLS estimator will minimize the sum of squared residuals or minimize (we can scale with $1/2$ without loss of generality)
       </p>
       $$
Q_n(\theta) = - \frac{1}{2n} \sum_{i=1}^n (y_i - g(\mathbf{x}_i; \theta))^2
$$
       <p>
        The FOC gives us
       </p>
       $$
\frac{\partial Q_n(\theta)}{\partial \theta} = \frac{1}{n} \sum_{i=1}^n \frac{\partial g(\mathbf{x}_i; \theta)}{\partial \theta} (y_i - g(\mathbf{x}_i; \theta)) = \mathbf{0}
$$
       <p>
        or more compactly using matrix notation
       </p>
       $$
\frac{\partial Q_n(\theta)}{\partial \theta} = \frac{1}{n}\frac{\partial \mathbf{g}^\top}{\partial \theta} (\mathbf{y}- \mathbf{g})
$$
       <p>
        For consistency of the NLS estimator, it is crucial that the mean is specified correctly.
       </p>
       <p>
        Assuming a covariance matrix for the errors $\text{E}[\mathbf{e} \mathbf{e}^\top \vert \mathbf{X}] = \boldsymbol{\Omega}_0$
and under regularity conditions, it will be the case that
       </p>
       $$
\sqrt{n} (\hat{\theta}_{NLS} - \theta_0) \to^d N(0, \mathbf{A}_0^{-1} \mathbf{B}_0 \mathbf{A}_0^{-1})
$$
       <p>
        with
       </p>
       $$
\begin{align}
\mathbf{A}_0 &amp;amp;= \text{plim} \left. \frac{1}{n} \frac{\partial \mathbf{g}^\top}{\partial \theta} \frac{\partial \mathbf{g}}{\partial \theta^\top}  \right \vert_{\theta = \theta_0}\\
\mathbf{B}_0 &amp;amp;= \text{plim} \left. \frac{1}{n} \frac{\partial \mathbf{g}^\top}{\partial \theta} \boldsymbol{\Omega}_0 \frac{\partial \mathbf{g}}{\partial \theta^\top} \right \vert_{\theta = \theta_0}
\end{align}
$$
       <p>
        A reasonable estimator for $\mathbf{A}_0$ is
       </p>
       $$
\hat{\mathbf{A}} = \left. \frac{1}{n} \frac{\partial \mathbf{g}^\top}{\partial \theta} \frac{\partial \mathbf{g}}{\partial \theta^\top}\right \vert_{\theta = \hat{\theta}_{NLS}}
$$
       <p>
        For $\mathbf{B}_0$ it depends (just as in the OLS case) on the assumption we can make about $\boldsymbol{\Omega}_0$. Assuming independence implies that $\boldsymbol{\Omega}_0$ must be a diagonal matrix. If homoskedasticity of the error term can be assumed then
       </p>
       $$
\sqrt{n} (\hat{\theta}_{NLS} - \theta_0) \to^d N(0, \sigma^2 \mathbf{A}_0^{-1})
$$
       <p>
        and we just need to estimate $\sigma^2$ using the sample variance. If we allow for heteroskedasticity, we can estimate
       </p>
       $$
\hat{\mathbf{B}} = \left. \frac{1}{n} \frac{\partial \mathbf{g}^\top}{\partial \theta} \hat{\boldsymbol{\Omega}}\frac{\partial \mathbf{g}}{\partial \theta^\top}\right \vert_{\theta = \hat{\theta}_{NLS}}
$$
       <p>
        where $\hat{\boldsymbol{\Omega}} = \text{Diag}[\hat{e}_i^2]$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=turkish-vulnerability">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Application:-Exponential-distribution">
        Application: Exponential distribution
        <a class="anchor-link" href="#Application:-Exponential-distribution">
         ¶
        </a>
       </h2>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Exponential_distribution">
         exponential density
        </a>
        is given by
       </p>
       $$
f_Y(y) = \lambda e^{-\lambda y}, \; y &amp;gt; 0, \; \lambda &amp;gt; 0
$$
       <p>
        The mean and variance is respectively $1/\lambda$ and $1/\lambda^2$. The exponential distribution can be used to describe the time for a continuous process to change state or for an event to occur, e.g. time between roadkills on a given road.
       </p>
       <p>
        Below we plot the density of a exponential density (with the above parameterization) assuming $\lambda = 12$. On average, we will wait $1/12$ time periods for one event to occur (one month if $y$ is measured in years).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=suffering-affair">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">lam</span> <span class="o">=</span> <span class="mf">12.0</span>
<span class="n">y_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">expon</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">y_values</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">lam</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$y$'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$f_Y(y)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=threatened-transaction">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We may introduce explanatory variables by specifying
       </p>
       $$
\lambda = e^{\mathbf{x}^\top \beta} 
$$
       <p>
        ensuring $\lambda &amp;gt; 0$ and specifying the conditional mean as
       </p>
       $$
\text{E}[y \vert \mathbf{x}] = e^{-\mathbf{x}^\top \beta}
$$
       <p>
        Assume that we observe a realization of a iid random sample $y_i, \mathbf{x}_i$, $i = 1, ... n$.
       </p>
       <h3 id="The-MLE">
        The MLE
        <a class="anchor-link" href="#The-MLE">
         ¶
        </a>
       </h3>
       <p>
        The (conditional) log-likehood function can be written (take the natural logarithm and plug in the definition of $\lambda$)
       </p>
       $$
\mathcal{L}_n (\beta) =  \sum_{i=1}^n  \left[ \mathbf{x}_i^\top \beta - e^{\mathbf{x}_i^\top \beta} y_i\right]
$$
       <h3 id="The-NLS-estimator">
        The NLS estimator
        <a class="anchor-link" href="#The-NLS-estimator">
         ¶
        </a>
       </h3>
       <p>
        A non-linear least squares estimator can be implemented by estimating
       </p>
       $$
y_i = e^{-\mathbf{x}_i^\top \beta} + e_i
$$
       <p>
        We also note that the error term is heteroskedastic since $\text{Var}[y_i] = 1 / [e^{\mathbf{x}_i^\top \beta}]^2$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=lasting-interview">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Simulating-data-and-implementing-estimators">
        Simulating data and implementing estimators
        <a class="anchor-link" href="#Simulating-data-and-implementing-estimators">
         ¶
        </a>
       </h3>
       <p>
        We consider 10,000 iid draws from the data generating process
       </p>
       $$
y \sim \text{Exp}(\beta_1 + \beta_2 x)
$$
       <p>
        with $x \sim N(1, 1)$ and $(\beta_1, \beta_2) = (2, -1)$.
       </p>
       <h4 id="MLE">
        MLE
        <a class="anchor-link" href="#MLE">
         ¶
        </a>
       </h4>
       <p>
        Below we implement the (negative) log-likelhood function and minimize it.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=promotional-azerbaijan">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate data</span>
<span class="sd">"""</span>
<span class="n">n_sim</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">beta1</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">beta2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">])</span>

<span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sim</span><span class="p">)</span>
<span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_sim</span><span class="p">),</span> <span class="n">x_data</span><span class="p">]</span>
<span class="n">y_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">beta</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sim</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sunset-drill">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define log-likelihood function (negative)</span>
<span class="sd">"""</span>


<span class="k">def</span> <span class="nf">log_likelihood_function</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="n">log_like</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span> 
        <span class="k">return</span> <span class="o">-</span><span class="n">log_like</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Minimize negative log-likelihood </span>
<span class="sd">"""</span>
<span class="n">res_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">log_likelihood_function</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">))</span>
<span class="n">params_mle</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
<span class="n">params_mle</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ca683f2d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        It is possible to show that (in this particular case)
       </p>
       $$
\text{Var}[\hat{\beta}] = - \left[-n \text{E}\left[\mathbf{x}_i \mathbf{x}_i^\top \right]\right]^{-1}
$$
       <p>
        For futher details see the notebook
        <strong>
         m_estimators [optional]
        </strong>
        .
       </p>
       <p>
        A common approach is to use numerical derivatives or other tools to estimate the asymptotic variance
       </p>
       $$
\widehat{V}(\hat{\theta}_{MLE} ) = -\left(\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1}
$$
       <p>
        Below we use the
        <code>
         statsmodels.tools.numdiff
        </code>
        package.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=champion-impossible">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">approx_fprime</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">log_likelihood_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
<span class="n">B_approx</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">scores</span> 

<span class="n">A_approx</span> <span class="o">=</span> <span class="o">-</span><span class="n">approx_hess</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">log_likelihood_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">))</span>

<span class="c1"># using the Hessian </span>
<span class="n">param_mle_cov_A_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">A_approx</span><span class="p">)</span>

<span class="c1"># using the outer product of the scores</span>
<span class="n">param_mle_cov_B_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">B_approx</span><span class="p">)</span>

<span class="c1"># Using the sandwich estimator - more robust to misspecification of distribution</span>
<span class="n">param_mle_cov_sandwich_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A_approx</span><span class="p">)</span> <span class="o">@</span> <span class="n">B_approx</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A_approx</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=worst-amber">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A</span>
<span class="n">param_mle_cov_A_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sexual-breakdown">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on B</span>
<span class="n">param_mle_cov_B_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=temporal-bolivia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A^{-1}BA^{-1} "Sandwich formula"</span>
<span class="n">param_mle_cov_sandwich_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=enhanced-frame">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We have specified the model correctly and have lots of data, so it is no surprice that maximum likelihood performs well. Due to the information matrix equality, then using different variance estimators gives us very similar results.
       </p>
       <h4 id="NLS">
        NLS
        <a class="anchor-link" href="#NLS">
         ¶
        </a>
       </h4>
       <p>
        Next, we define the NLS objective and minimze it.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=suitable-subdivision">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">objective_nls</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    
    <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">))</span> 
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">loss</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">foc_nls</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> 
    
    <span class="n">der</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span> <span class="o">@</span> <span class="n">x</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">der</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=powerful-proof">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective_nls</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<span class="n">params_nls</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
<span class="n">params_nls</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=present-setup">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=trained-military">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Clearly the error term is heteroskedastic...</span>
<span class="sd">"""</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>  <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">params_nls</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"fitted"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'y'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=entire-extra">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Next step is to calculate the variance of the NLS estimator. Again, we can either use the exact analytical expressions or use numerical derivatives. We consider the analytical derivatives.
       </p>
       <p>
        We implement
       </p>
       $$
\begin{align}
\frac{1}{n} \sum_{i=1}^n \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta } \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta^\top }  &amp;amp;= \frac{1}{n} \sum_{i=1}^n e^{2\mathbf{x}_i^\top \beta}\mathbf{x}_i \mathbf{x}_i^\top \\
\frac{1}{n} \sum_{i=1}^n \sigma_i^2 \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta } \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta^\top }  &amp;amp;=  \frac{1}{n} \sum_{i=1}^n e^{-2\mathbf{x}_i^\top \beta} e^{2\mathbf{x}_i^\top \beta}\mathbf{x}_i \mathbf{x}_i^\top = \frac{1}{n} \sum_{i=1}^n \mathbf{x}_i \mathbf{x}_i^\top
\end{align}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=certain-brass">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_scores_g</span><span class="p">(</span><span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the score</span>
<span class="sd">    """</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=married-mercury">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">scores_g</span> <span class="o">=</span> <span class="n">calculate_scores_g</span><span class="p">(</span><span class="n">params_nls</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=tight-chicken">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">scores_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">scores_g</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">scores_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">params_nls</span><span class="p">))</span> <span class="o">@</span> <span class="n">scores_g</span>
<span class="n">B_alt</span> <span class="o">=</span> <span class="n">scores_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="n">y_data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">params_nls</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">scores_g</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=weird-christmas">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">param_nls_cov_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="c1">#&amp;lt;-- understates variance</span>

<span class="n">param_nls_cov_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="c1">#&amp;lt;-- understates variance</span>

<span class="n">param_nls_cov_sandwich</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="c1">#&amp;lt;-- valid estimator due to heteroskedasticity</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dadfac74">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">param_nls_cov_B</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0230dd8b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">param_nls_cov_sandwich</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=aggregate-nitrogen">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Estimation-using-SciPy">
        Estimation using SciPy
        <a class="anchor-link" href="#Estimation-using-SciPy">
         ¶
        </a>
       </h2>
       <p>
        <code>
         scipy
        </code>
        provides MLE methods for implemented distributions (see e.g.
        <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.rv_continuous.fit.html">
         here
        </a>
        ). For instance, we can fit the parameters of a normal distribution.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=center-bouquet">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate Normal data and estimate parameters</span>
<span class="sd">"""</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mi">5</span>


<span class="n">norm_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="c1"># Known MLE </span>
<span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">norm_data</span><span class="p">)</span>
<span class="n">variance_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">norm_data</span><span class="p">)</span>
<span class="n">sigma_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance_est</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"MLE mu: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mu_est</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"MLE std: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma_est</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># fit using SciPy</span>
<span class="n">mu_scipy_est</span><span class="p">,</span> <span class="n">sigma_scipy_est</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">norm_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"SciPy mu: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mu_scipy_est</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"SciPy std: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma_scipy_est</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=regulation-bosnia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Estimation-using-Statsmodels">
        Estimation using Statsmodels
        <a class="anchor-link" href="#Estimation-using-Statsmodels">
         ¶
        </a>
       </h2>
       <p>
        <code>
         scipy
        </code>
        provides a quick MLE implementation for different distributions, but may not be applicable for more complicated problem.
       </p>
       <p>
        <code>
         statsmodels
        </code>
        provides a framework for implementing generic MLE estimators (see
        <a href="https://www.statsmodels.org/dev/examples/notebooks/generated/generic_mle.html">
         docs
        </a>
        ). Let us try to implement our exponential model using
        <code>
         statsmodels
        </code>
        !
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=healthy-scholarship">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.base.model</span> <span class="kn">import</span> <span class="n">GenericLikelihoodModel</span>

<span class="c1"># overwrite loglikelihood function in Generic Likelihood Class</span>
<span class="k">class</span> <span class="nc">Exponential</span><span class="p">(</span><span class="n">GenericLikelihoodModel</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">loglike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>
        <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">exog</span> <span class="o">@</span> <span class="n">params</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exog</span> <span class="o">@</span> <span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="n">endog</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># fit models</span>
<span class="n">exponential_fit</span> <span class="o">=</span> <span class="n">Exponential</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># print results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">exponential_fit</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=respiratory-drill">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Our previous estimates</span>
<span class="sd">"""</span>

<span class="n">params_mle</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.cambridge.org/highereducation/books/microeconometrics/982158DE989697607C858068ED05C7B1#overview">
         Microeconometrics: Methods and Applications, Cameron and Trivedi (2005)
        </a>
       </p>
       <p>
        <a href="https://www.amazon.com/Econometric-Analysis-7th-William-Greene/dp/0131395386">
         Econometric Analysis 7th edition, William H. Greene (2012)
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">import</span> <span class="nn">datetime</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">block_diag</span>

<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span> 

<span class="kn">from</span> <span class="nn">pandas_datareader.data</span> <span class="kn">import</span> <span class="n">DataReader</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>
<span class="kn">import</span> <span class="nn">codelib.portfolio_optimization.risk_metrics</span> <span class="k">as</span> <span class="nn">rm</span> 
<span class="kn">import</span> <span class="nn">codelib.portfolio_optimization.diversification</span> <span class="k">as</span> <span class="nn">dm</span>

<span class="kn">from</span> <span class="nn">codelib.statistics.moments</span> <span class="kn">import</span> <span class="n">corr_to_cov_matrix</span><span class="p">,</span> <span class="n">cov_to_corr_matrix</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">correlation_plot</span><span class="p">,</span> <span class="n">fan_chart</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span><span class="p">,</span> <span class="n">default_colors</span>
<span class="n">DefaultStyle</span><span class="p">();</span>

<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.mean_variance</span> <span class="kn">import</span> <span class="n">portfolio_variance</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-10">
        Exercises - Week 10
        <a class="anchor-link" href="#Exercises---Week-10">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=da664997">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1:-Variable-transaction-costs">
        Problem 1: Variable transaction costs
        <a class="anchor-link" href="#Problem-1:-Variable-transaction-costs">
         ¶
        </a>
       </h2>
       <p>
        Consider the asset universe defined by the correlation matrix
       </p>
       $$
C = \begin{pmatrix} 1.0 &amp;amp; 0.85 &amp;amp; 0.5 &amp;amp; 0.45 \\
0.85 &amp;amp; 1.0 &amp;amp; 0.5 &amp;amp; 0.45 \\
0.5 &amp;amp; 0.5 &amp;amp; 1.0 &amp;amp; 0.9 \\
0.45 &amp;amp; 0.45 &amp;amp; 0.9 &amp;amp; 1.0 \end{pmatrix}
$$
       <p>
        the expected returns $\mu = (3.2, 3.12, 8.0, 8.2)^\top$, and the volatilities $(5.0, 5.0, 22.0, 22.0)^\top$
       </p>
       <p>
        Assume that the investor initially holds an equally weighted portfolio $w_i^0 = 1/4$, for $i=1,...,4$.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        We can define the mean-variance problem in terms of changes to the initial weights
       </p>
       \begin{align*}
    \min_{\mathbf{x}}  \quad &amp;amp; (\mathbf{w}^0 + \mathbf{x})^\top \boldsymbol{\Sigma} (\mathbf{w}^0 + \mathbf{x})\\
    \textrm{s.t.} \quad &amp;amp; \mathbf{x}^\top \mathbf{1} = 0 \\
      &amp;amp; (\mathbf{w}^0 + \mathbf{x})^\top \boldsymbol{\mu} \geq \delta \\
\end{align*}
       <p>
        Find the optimal $\mathbf{x}$ using
        <code>
         CVXPY
        </code>
        with $\delta = 0.045$
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Assume that it is not cost free to trade such that
       </p>
       \begin{align*}
    \min_{\mathbf{x}}  \quad &amp;amp; (\mathbf{w}^0 + \mathbf{x})^\top \boldsymbol{\Sigma} (\mathbf{w}^0 + \mathbf{x})\\
    \textrm{s.t.} \quad &amp;amp; \mathbf{x}^\top \mathbf{1} + \phi(\mathbf{x})= 0 \\
     &amp;amp; (\mathbf{w}^0 + \mathbf{x})^\top \boldsymbol{\mu} \geq \delta \\
\end{align*}
       <p>
        where $\phi(\mathbf{x}) = \sum_{i=1}^N \phi_i(x_i)$ with
       </p>
       $$
\phi_i(x_i) = \left\{ \begin{array}{cr} \alpha^{+} x_i, &amp;amp; x_i \geq 0 \\ -\alpha^- x_i, &amp;amp; x_i \leq 0 \end{array}\right.
$$
       <p>
        is the variable transaction costs.  Note that we can write
       </p>
       $$
\phi_i = \alpha^{+} x_i^+ +  \alpha^- x_i^{-}
$$
       <p>
        where $x_i = x_i^{+} - x_i^{-}$ with $x_i^{+}, x_i^{-} \geq 0$.
       </p>
       <p>
        Implement the optimization with variable transaction costs when assuming $\alpha^+, \alpha^- = 0.01$. What is the consequence?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=6abaed38">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define inputs </span>
<span class="sd">"""</span>

<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">])</span>  <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.12</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">8.2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c7fd62c0">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define and solve problem </span>
<span class="sd">"""</span>

<span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_assets</span>
<span class="n">delta</span> <span class="o">=</span> <span class="mf">0.045</span>

<span class="c1"># define optimization variable </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

<span class="c1"># define constraints </span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">,</span> <span class="p">(</span><span class="n">w0</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">&amp;gt;=</span> <span class="n">delta</span><span class="p">]</span>

<span class="c1"># define problem </span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w0</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)),</span>
                  <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

<span class="c1"># solve problem </span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># show x.value</span>
<span class="n">x</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5a6a93c6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># show x.value</span>
<span class="n">w0</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ff529d75">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0a3792aa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="n">w0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_assets</span>
<span class="n">delta</span> <span class="o">=</span> <span class="mf">0.045</span>

<span class="c1"># transaction costs </span>
<span class="n">alpha_pos</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">alpha_neg</span> <span class="o">=</span> <span class="mf">0.01</span>

<span class="c1"># define optimization variable </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">x_pos</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">x_neg</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

<span class="c1"># define constraints </span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">x_pos</span> <span class="o">&amp;gt;=</span> <span class="mf">0.0</span><span class="p">,</span>
               <span class="n">x_neg</span> <span class="o">&amp;gt;=</span> <span class="mf">0.0</span><span class="p">,</span>
               <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">alpha_pos</span><span class="o">*</span><span class="n">x_pos</span> <span class="o">+</span> <span class="n">alpha_neg</span> <span class="o">*</span> <span class="n">x_neg</span><span class="p">)</span>   <span class="o">&amp;lt;=</span> <span class="mf">0.0</span><span class="p">,</span>
               <span class="n">x</span> <span class="o">==</span> <span class="n">x_pos</span> <span class="o">-</span> <span class="n">x_neg</span><span class="p">,</span> 
               <span class="p">(</span><span class="n">w0</span> <span class="o">+</span> <span class="n">x</span><span class="p">)</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">&amp;gt;=</span> <span class="n">delta</span><span class="p">]</span>

<span class="c1"># define problem </span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">w0</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)),</span>
                  <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

<span class="c1"># solve problem </span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># show x.value</span>
<span class="n">x</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dcbe2dd9">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># show allocation</span>
<span class="n">w0</span> <span class="o">+</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=94a98273">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We trade less!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7c3564d7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:-Constraints-on-the-number-of-uncorrelated-bets">
        Problem 2: Constraints on the number of uncorrelated bets
        <a class="anchor-link" href="#Problem-2:-Constraints-on-the-number-of-uncorrelated-bets">
         ¶
        </a>
       </h2>
       <p>
        Consider the asset univers: Government bonds, Investment-grade bonds, High-yield bonds, Emerging markets gov. bonds, Equities (developed markets), Equities (Emerging markets), Private equity, Infrastructure, Real Estate, and Hedgefunds.
       </p>
       $$
\mathbf{R} \sim N(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        with correlation matrix
       </p>
       \begin{equation*}
\mathbf{C} =   \begin{bmatrix}
1.0 &amp;amp;  0.6 &amp;amp;  0.1 &amp;amp;  0.3 &amp;amp; -0.1 &amp;amp; -0.1 &amp;amp; -0.2 &amp;amp; -0.1 &amp;amp; -0.1 &amp;amp; -0.1 \\
0.6 &amp;amp;  1.0 &amp;amp;  0.6 &amp;amp;  0.6 &amp;amp;  0.2 &amp;amp;  0.2 &amp;amp;  0.2 &amp;amp;  0.1 &amp;amp;  0.1 &amp;amp;  0.3 \\ 
0.1 &amp;amp;  0.6 &amp;amp;  1.0 &amp;amp;  0.7 &amp;amp;  0.7 &amp;amp;  0.6 &amp;amp;  0.6 &amp;amp;  0.4 &amp;amp;  0.3 &amp;amp;  0.7 \\
0.3 &amp;amp;  0.6 &amp;amp;  0.7 &amp;amp;  1.0 &amp;amp;  0.5 &amp;amp;  0.6 &amp;amp;  0.4 &amp;amp;  0.2 &amp;amp;  0.2 &amp;amp;  0.5 \\
-0.1 &amp;amp;  0.2 &amp;amp;  0.7 &amp;amp;  0.5 &amp;amp;  1.0 &amp;amp;  0.7 &amp;amp;  0.8 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.8 \\
-0.1 &amp;amp;  0.2 &amp;amp;  0.6 &amp;amp;  0.6 &amp;amp;  0.7 &amp;amp;  1.0 &amp;amp;  0.7 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.7 \\
-0.2 &amp;amp;  0.2 &amp;amp;  0.6 &amp;amp;  0.4 &amp;amp;  0.8 &amp;amp;  0.7 &amp;amp;  1.0 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.7 \\
-0.1 &amp;amp;  0.1 &amp;amp;  0.4 &amp;amp;  0.2 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  1.0 &amp;amp;  0.3 &amp;amp;  0.4 \\
-0.1 &amp;amp;  0.1 &amp;amp;  0.3 &amp;amp;  0.2 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.3 &amp;amp;  1.0 &amp;amp;  0.4 \\
-0.1 &amp;amp;  0.3 &amp;amp;  0.7 &amp;amp;  0.5 &amp;amp;  0.8 &amp;amp;  0.7 &amp;amp;  0.7 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  1.0
\end{bmatrix},
\end{equation*}
       <p>
        vector of volatilities
       </p>
       \begin{equation*}
\mathbf{v} =   \begin{bmatrix}
0.037, 0.055, 0.119, 0.107, 0.153, 0.217, 0.204, 0.14, 0.108, 0.094
\end{bmatrix}^\top,
\end{equation*}
       <p>
        and expected return
\begin{equation*}
\boldsymbol{\mu} =   \begin{bmatrix}
0.019, 0.022, 0.049, 0.043, 0.061, 0.083, 0.102, 0.056, 0.041, 0.038
\end{bmatrix}^\top 
\end{equation*}
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Find the minimum-variance portfolio with the budget constraint $\mathbf{w}^\top \mathbf{1} = 1$ and the long-only constraint $\mathbf{w} \geq 0$.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        A simplistic or naive view of portfolio diversification is to look at the number of constituents in the portfolios or the portfolio weights. One possibility is to use the norm of the portfolio weight vector, $\mathbf{w}$, to determine the Effective Number of Constituents (ENC)  (valid for any $\alpha &amp;gt; 0$ if weights are all positive)
       </p>
       \begin{equation*}
\text{ENC}_{\alpha} (\mathbf{w}) = \Vert \mathbf{w} \Vert_{\alpha}^{\frac{\alpha}{1 - \alpha}} = \left(\sum_{i=1}^N w_i^\alpha \right)^{\frac{1}{1-\alpha}}, \; \; \alpha &amp;gt; 0, \; \alpha \neq 1
\end{equation*}
       <p>
        where $N$ denote the number of assets. If $\alpha = 2$, the diversification measure is equal to the inverse of the
        <a href="https://en.wikipedia.org/wiki/Herfindahl%E2%80%93Hirschman_index">
         Herfindahl index
        </a>
       </p>
       \begin{equation*}
\text{ENC}_{2} (\mathbf{w}) = \frac{1}{\sum_{i=1}^N w_i^2}
\end{equation*}
       <p>
        In the limiting case when $\alpha \to 1$, we obtain the exponential of the entropy of the distribution of the portfolio weight vector
       </p>
       \begin{equation*}
\text{ENC}_{1} = \exp \left( - \sum_{i=1}^N w_i \ln w_i\right)
\end{equation*}
       <p>
        Calculate the effective number of constituents with $\alpha=1$ and $\alpha=2$. Note the function
        <code>
         codelib.portfolio_optimization.diversification.cal
        </code>
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1358533">
         Meucci (2009), "Managing Diversification"
        </a>
        defines the
        <em>
         effective  number of uncorrelated bets
        </em>
        .
       </p>
       <p>
        The method relies on the choice of $N$ uncorrelated factors whose returns can be expressed as
       </p>
       \begin{equation}
    \mathbf{R}_F = \mathbf{A}^{-1} \mathbf{R}
\end{equation}
       <p>
        where $R$ is the vector of constituents returns and $\mathbf{A}$ is the "transition matrix" that maps
from the constituents returns to factor returns (square matrix of size $N$). $\mathbf{A}$ is assumed
invertible. Given the assumption of uncorrelated factors and invertible matrix, we can write the portfolio variance
as
       </p>
       \begin{align}
    \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w} &amp;amp;= \mathbf{w}^\top (\mathbf{A}^\top)^{-1}
    \boldsymbol{\Sigma}_F (\mathbf{A})^{-1} \mathbf{w} \\
    &amp;amp;= \mathbf{w}^\top_F \boldsymbol{\Sigma} \mathbf{w}_F \\
    &amp;amp;= \sum_{i=1}^N (\sigma_{F_i} w_{F_i})^2
\end{align}
       <p>
        We can then define the i'th factors contribution to portfolio variance
       </p>
       \begin{equation}
    p_i =\frac{(\sigma_{F_i} w_{F_i})^2}{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}
\end{equation}
       <p>
        which is positive and sum to one. The idea is then to calculate the effective number of uncorrelated bets using the
norm of the factor constributions to the total variance (basically calculating Effective Number of Constituents
using $p_i, i=1, ..., N$).
       </p>
       <p>
        Using principal components as the uncorrelated factors, we obtain the matrix of eigenvector $\mathbf{V}$ as the "transition matrix" since
       </p>
       $$
\mathbf{R}_{PCA} = \mathbf{V}^{-1} \mathbf{R}
$$
       <p>
        and the factor variances are known to be equal to the eigenvalues.
       </p>
       <p>
        Calculate the effective number of uncorrelated bets for the obtained minimum-variance portfolio and the equally weigthed  portfolio when using principal components as uncorrelated factors.
       </p>
       <p>
        Note that the function
        <code>
         codelib.portfolio_optimization.diversification.calculate_enb
        </code>
        is available.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        <a href="https://www-pm-research-com.esc-web.lib.cbs.dk/content/iijpormgmt/early/2022/02/08/jpm20221340">
         Deguest, Martellini, Meucci, "Risk Parity and Beyond—From Asset Allocation to Risk Allocation Decisions"
        </a>
        suggest a minimum variance portfolio where the number of uncorrelated bets are constrained to exceed a specific number. Implement the minimum-variance portfolio with a constraint on the number of uncorrelated bets. Ensure that the $ENB(\alpha=2)$ is larger than 8.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=19e0f97b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define inputs </span>
<span class="sd">"""</span>

<span class="n">asset_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Government bonds"</span><span class="p">,</span> <span class="s2">"Investment-grade bonds"</span><span class="p">,</span> <span class="s2">"High-yield bonds"</span><span class="p">,</span>
               <span class="s2">"Emerging markets gov. bonds"</span><span class="p">,</span> <span class="s2">"Equities (developed markets)"</span><span class="p">,</span>
               <span class="s2">"Equities (Emerging markets)"</span><span class="p">,</span> <span class="s2">"Private equity"</span><span class="p">,</span> <span class="s2">"Infrastructure"</span><span class="p">,</span>
               <span class="s2">"Real Estate"</span><span class="p">,</span> <span class="s2">"Hedgefunds"</span><span class="p">]</span>

<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.60</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">]])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.7</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">11.9</span><span class="p">,</span> <span class="mf">10.7</span><span class="p">,</span> <span class="mf">15.3</span><span class="p">,</span> <span class="mf">21.7</span><span class="p">,</span> <span class="mf">20.4</span><span class="p">,</span> <span class="mf">14.0</span><span class="p">,</span> <span class="mf">10.8</span><span class="p">,</span> <span class="mf">9.4</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="o">=</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="o">=</span><span class="n">vols</span><span class="p">)</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.9</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">,</span> <span class="mf">4.3</span><span class="p">,</span> <span class="mf">6.1</span><span class="p">,</span> <span class="mf">8.3</span><span class="p">,</span> <span class="mf">10.2</span><span class="p">,</span> <span class="mf">5.6</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">,</span> <span class="mf">3.8</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span>

<span class="c1"># number of assets </span>
<span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5e7b231f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Find minimum-variance portfolio </span>
<span class="sd">"""</span>

<span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> 
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                 <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="n">port_var_der</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span>


<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,),</span>
                        <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                        <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">no_short_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>

<span class="n">w_min_var</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c1a6ec53">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># We almost only allocate to government bonds!</span>
<span class="n">w_min_var</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=931f4539">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">w_min_var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=caeebdd3">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=04498c52">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">calculate_enc</span><span class="p">(</span><span class="n">w_min_var</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=426b388d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">calculate_enc</span><span class="p">(</span><span class="n">w_min_var</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3533a96c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=550e2b4e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">eq_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_assets</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=1a6e6749">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate eigenvalues and eigenvectors</span>
<span class="n">eigvals</span><span class="p">,</span> <span class="n">eigvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>

<span class="c1"># sort </span>
<span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argsort</span><span class="p">(</span><span class="o">-</span><span class="n">eigvals</span><span class="p">)</span>
<span class="n">pca_mat</span> <span class="o">=</span> <span class="n">eigvec</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span>
<span class="n">factor_variances</span> <span class="o">=</span> <span class="n">eigvals</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=19b0396f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Minimum-variance </span>
<span class="sd">"""</span>

<span class="n">dm</span><span class="o">.</span><span class="n">calculate_enb</span><span class="p">(</span><span class="n">w_min_var</span><span class="p">,</span> <span class="n">transition_matrix</span><span class="o">=</span><span class="n">pca_mat</span><span class="p">,</span>
                 <span class="n">factor_variances</span><span class="o">=</span><span class="n">factor_variances</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=16e26788">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Equal weights</span>
<span class="sd">"""</span>

<span class="n">dm</span><span class="o">.</span><span class="n">calculate_enb</span><span class="p">(</span><span class="n">eq_weights</span><span class="p">,</span> <span class="n">transition_matrix</span><span class="o">=</span><span class="n">pca_mat</span><span class="p">,</span>
                 <span class="n">factor_variances</span><span class="o">=</span><span class="n">factor_variances</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cbccbfe5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">),</span> <span class="n">pca_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">w_min_var</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum-variance"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">),</span> <span class="n">pca_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">eq_weights</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equally weighted"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Factor weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=28306ee7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">calculate_enb</span><span class="p">(</span><span class="n">w_min_var</span><span class="p">,</span> <span class="n">transition_matrix</span><span class="o">=</span><span class="n">pca_mat</span><span class="p">,</span>
                                           <span class="n">factor_variances</span><span class="o">=</span><span class="n">factor_variances</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum-variance"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">),</span> <span class="n">dm</span><span class="o">.</span><span class="n">calculate_enb</span><span class="p">(</span><span class="n">eq_weights</span><span class="p">,</span> <span class="n">transition_matrix</span><span class="o">=</span><span class="n">pca_mat</span><span class="p">,</span>
                                           <span class="n">factor_variances</span><span class="o">=</span><span class="n">factor_variances</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">1</span><span class="p">],</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equally weighted"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Factor risk contribution"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ee0d1217">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=99f1789e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Find minimum-variance portfolio </span>
<span class="sd">"""</span>

<span class="n">enb_target</span> <span class="o">=</span> <span class="mf">8.0</span>

<span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="n">number_of_bets</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">dm</span><span class="o">.</span><span class="n">calculate_enb</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">pca_mat</span><span class="p">,</span> <span class="n">factor_variances</span><span class="o">=</span><span class="n">factor_variances</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">enb_target</span><span class="p">}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>


<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,),</span>
                        <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">number_of_bets</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-10</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">}</span> <span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

<span class="n">w_min_var_enb</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d0180f36">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">w_min_var_enb</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c151cde0">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">w_min_var</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=bd27606c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">dm</span><span class="o">.</span><span class="n">calculate_enb</span><span class="p">(</span><span class="n">w_min_var_enb</span><span class="p">,</span> <span class="n">transition_matrix</span><span class="o">=</span><span class="n">pca_mat</span><span class="p">,</span> <span class="n">factor_variances</span><span class="o">=</span><span class="n">factor_variances</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=limiting-disposal">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1358533">
         Meucci (2009), "Managing Diversification"
        </a>
       </p>
       <p>
        <a href="https://www-pm-research-com.esc-web.lib.cbs.dk/content/iijpormgmt/early/2022/02/08/jpm20221340">
         Deguest, Martellini, Meucci, "Risk Parity and Beyond—From Asset Allocation to Risk Allocation Decisions"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=functional-market">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># numpy for working with vectors and matrices, etc. </span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># pandas for working with dataframes</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># plotting functionality </span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># package for working with time, dates, etc. </span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># pandas datareader for downloading data via different APIs</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.data</span> <span class="kn">import</span> <span class="n">DataReader</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="c1"># function for obtain yield curve data from FRED </span>
<span class="kn">from</span> <span class="nn">codelib.dal.fred_yield_data</span> <span class="kn">import</span> <span class="n">get_nominal_yield_data</span>

<span class="c1"># Setting default plotting style </span>
<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=01163592-1409-495f-a727-5fb9f2d5dd8f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-2">
        Exercises - Week 2
        <a class="anchor-link" href="#Exercises---Week-2">
         ¶
        </a>
       </h1>
       <p>
        In this week we will look at a few exercises that show us how to work with the data sets presented in the lectures.
       </p>
       <p>
        In this exercies set, we primarily be using
        <code>
         pandas
        </code>
        ,
        <code>
         numpy
        </code>
        ,
        <code>
         matplotlib.pyplot
        </code>
        and
        <code>
         pandas-datareader
        </code>
        .
       </p>
       <h2 id="Problem-1:-Projection-of-risk-drivers-/-invariants">
        Problem 1: Projection of risk drivers / invariants
        <a class="anchor-link" href="#Problem-1:-Projection-of-risk-drivers-/-invariants">
         ¶
        </a>
       </h2>
       <p>
        Assume that the log-return of a stock (the risk driver / invariant) is normally distributed (iid)
       </p>
       $$
\mathbf{X}_{t + \Delta t, \Delta t} = \ln P_{t + \Delta t} - \ln P_{t} \sim N(\mu, \sigma^2)
$$
       <p>
        with $\Delta t = 1 / 12$ (one month), $\mu = 0.06 \Delta t$ and $\sigma^2 = 0.15^2 \Delta t$.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Simulate 10 000 draws from the distribution of 1-month log-returns and net returns using e.g.
        <code>
         numpy.random.normal
        </code>
        and plot the kernel density or histogram (e.g. use
        <code>
         seaborn.kdeplot
        </code>
        ).
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Calculate the mean and standard devation of both the simulated log and net returns. Are the vaues close to $\mu$ and $\sigma$?
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        We seek to compare the difference between the one year log and net return. How would you simulate the one year log and net return distribution? Note that
       </p>
       $$
\ln P_{t + 1} - \ln P_{t}  = \mathbf{X}_{t + 1, 1} = \sum_{i=1}^{12} \mathbf{X}_{t + \Delta t \cdot i, \Delta t}  = \sum_{i=1}^{12} [\ln P_{t + \Delta t \cdot i} - \ln P_{t + \Delta t \cdot (i - 1)}]
$$
       <p>
        Simulate 10000 draws from the distribution of 1-year log returns and net returns and plot the kernel density.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Calculate the mean and standard devation of both the simulated log and net returns. Are the values close to $\mu \cdot 12 $ and $\sigma \cdot \sqrt{12}$?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=d667f8e2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculations</span>
<span class="sd">"""</span>

<span class="c1"># define inputs</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">12.0</span> 
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.15</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">dt</span><span class="p">)</span> 
<span class="n">mu</span> <span class="o">=</span> <span class="mf">0.06</span> <span class="o">*</span> <span class="n">dt</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">100_000</span>

<span class="c1"># simulate normal log returns</span>
<span class="n">log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>
<span class="c1"># transform log returns to net return </span>
<span class="n">net_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ret</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fb84c1d5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">log_ret</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Log. returns"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">net_ret</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'navy'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Net returns"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=10df9760">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e054cd1f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mean_log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">log_ret</span><span class="p">)</span>
<span class="n">std_log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">log_ret</span><span class="p">)</span>

<span class="n">mean_net_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">net_ret</span><span class="p">)</span>
<span class="n">std_net_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">net_ret</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Mean log. return : </span><span class="si">{:.4f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Std. log. return: </span><span class="si">{:.4f}</span><span class="s2"> </span><span class="se">\n\n</span><span class="s2">Mean net return : </span><span class="si">{:.4f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Std. net return: </span><span class="si">{:.4f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">mean_log_ret</span><span class="p">,</span> <span class="n">std_log_ret</span><span class="p">,</span> <span class="n">mean_net_ret</span><span class="p">,</span> <span class="n">std_net_ret</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ed420b06">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sigma</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1123267c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=97e13d6c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The simulated values are close (but with some Monte Carlo uncertainty) to the parameter values for the log returns, but also reasonably close for the net returns.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b4be574b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Since the log-return is iid normally distributed, we have that
       </p>
       $$
\ln P_{t + 1} - \ln P_{t} \sim N(12 \mu, 12 \sigma^2)
$$
       <p>
        Note that the horizon is $\tau = 1$ and $\Delta t = 1/12$ such that $\frac{\tau}{\Delta t} = 12$ (see lecture notes).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=4abd2ed8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># simulate random normal</span>
<span class="n">log_ret_1y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="c1"># transform log returns to net returns</span>
<span class="n">net_ret_1y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_ret_1y</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f86346ed">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">log_ret_1y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Log. returns"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">net_ret_1y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'navy'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Net returns"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5dd9bd47">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        There is obviously a large difference between the density for log and net return!
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=80d114d9">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mean_log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">log_ret_1y</span><span class="p">)</span>
<span class="n">std_log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">log_ret_1y</span><span class="p">)</span>

<span class="n">mean_net_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">net_ret_1y</span><span class="p">)</span>
<span class="n">std_net_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">net_ret_1y</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Mean log. return : </span><span class="si">{:.4f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Std. log. return: </span><span class="si">{:.4f}</span><span class="s2"> </span><span class="se">\n\n</span><span class="s2">Mean net return : </span><span class="si">{:.4f}</span><span class="s2"> </span><span class="se">\n</span><span class="s2">Std. net return: </span><span class="si">{:.4f}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
    <span class="n">mean_log_ret</span><span class="p">,</span> <span class="n">std_log_ret</span><span class="p">,</span> <span class="n">mean_net_ret</span><span class="p">,</span> <span class="n">std_net_ret</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3722d139">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sigma</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4f7f8724">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="mi">12</span> <span class="o">*</span> <span class="n">mu</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7931ae3f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The mean and standard devation of the 1-year log returns are close to these values as expected, but it is not the case of net returns. Net returns are shifted log normal such that we would expect a mean of
       </p>
       $$
e^{\mu \cdot 12 + \frac{1}{2}\sigma^2 \cdot 12} - 1
$$
       <p>
        and a standard devation of
       </p>
       $$
\sqrt{[e^{12 \sigma^2}  - 1] e^{24\mu + \sigma^2 12 }}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=56823bf5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="o">*</span><span class="mi">12</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="mi">12</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=96fedbfe">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">12</span> <span class="o">*</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">24</span><span class="o">*</span><span class="n">mu</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mi">12</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=renewable-blend">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:-Asset-allocation---what-not-to-do!">
        Problem 2: Asset allocation - what not to do!
        <a class="anchor-link" href="#Problem-2:-Asset-allocation---what-not-to-do!">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Note
        </strong>
        : Problem is partially based on
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1586656">
         Attilio Meucci (2010), "Quant Nugget 2: Linear vs. Compounded Returns – Common Pitfalls in Portfolio Management"
        </a>
       </p>
       <p>
        We have learned that we (at least approximately) can treat the log returns on instruments such as equities as invariants. In this problem we explore one potential pitfall when an investor specifies the asset allocation problem.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Obtain the equally weighted monthly return data for the five Fama-French industry portfolios ("5_Industry_Portfolios") using
        <code>
         pandas-datareader
        </code>
        since 1990-01-01.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Transform the equally weighted monthly return data into log returns.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Estimate the expected log return vector and the covariance matrix, e.g. using
        <code>
         np.mean
        </code>
        and
        <code>
         np.cov
        </code>
        .
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Project the expected return vector and covariance matrix to a 1-year and a 5-year investment horizon (assuming that log returns are invariants).
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        Assume that an investor casts his/her asset allocation problem as
       </p>
       $$
\underset{\mathbf{w}}{\text{argmax}} \; \mathbf{w}^\top \boldsymbol{\mu} - \frac{\lambda}{2} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to
       </p>
       $$
\mathbf{1}^\top \mathbf{w} = 1
$$
       <p>
        where $\mathbf{w}$ is the portfolio weights, $\boldsymbol{\mu}$ is a vector of expected log returns, and $\boldsymbol{\Sigma}$ denotes the covariance matrix of log returns.
       </p>
       <p>
        The solution to this optimization problem is given by (see e.g.
        <a href="https://www.amazon.com/Portfolio-Management-under-Stress-Bayesian-Net/dp/1107048117">
         Rebonato and Denev, "Portfolio Management under stress"
        </a>
        )
       </p>
       $$
\mathbf{w}^* = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu} - \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \mathbf{A}^\top \mathbf{C}^{-1} \left(\mathbf{A}\boldsymbol{\Sigma}^{-1}\boldsymbol{\mu}  - \lambda \mathbf{b} \right)
$$
       <p>
        with $\mathbf{A} = \mathbf{1}^\top$, $\mathbf{b} = 1$, and $\mathbf{C} = \mathbf{A} \boldsymbol{\Sigma}^{-1}\mathbf{A}^\top$. Note that this solution is valid for more general constraints of the form $\mathbf{A}^\top \mathbf{w} = \mathbf{b}$.
       </p>
       <p>
        Solve the problem for the one and five year horizon. Assume $\lambda = 10$.
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        What is problematic with the above approach?
       </p>
       <p>
        <strong>
         Question 7
        </strong>
       </p>
       <p>
        After advice from the student assistant following this course, the investor recasts his/her asset allocation problem as
       </p>
       $$
\underset{\mathbf{w}}{\text{argmax}} \; \mathbf{w}^\top \boldsymbol{\mu}^L - \frac{\lambda}{2} \mathbf{w}^\top \boldsymbol{\Sigma}^L \mathbf{w}
$$
       <p>
        subject to
       </p>
       $$
\mathbf{1}^\top \mathbf{w} = 1
$$
       <p>
        where $\mathbf{w}$ is the portfolio weights, $\boldsymbol{\mu}^L$ is a vector of expected linear returns, and $\boldsymbol{\Sigma}^L$ denotes the covariance matrix of linear returns.
       </p>
       <p>
        To make everything easy, we assume that log returns follow a multivariate normal distribution
       </p>
       $$
\mathbf{r}_{t+ \tau, \tau} = \log \frac{\mathbf{P}_{t+\tau}}{\mathbf{P}_t} \sim N(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        We can write
       </p>
       $$
\mathbf{R}_{t + \tau, \tau} = e^{\mathbf{r}_{t+ \tau, \tau}} - 1
$$
       <p>
        Since $e^{\mathbf{r}_{t+ \tau, t}}$ follows a multivariate log-normal distribution (see
        <a href="https://www.casact.org/sites/default/files/database/forum_15spforum_halliwell.pdf">
         here
        </a>
        )
       </p>
       $$
\text{E}[e^{\mathbf{r}_{t+ \tau, \tau}}] = e^{\mu  + \frac{1}{2}\text{diag}(\boldsymbol{\Sigma})}
$$
       <p>
        and
       </p>
       $$
\text{Cov}[e^{\mathbf{r}_{t+ \tau, \tau}}] =  \text{E}[e^{\mathbf{r}_{t+ \tau, \tau}}] \text{E}[e^{\mathbf{r}_{t+ \tau, \tau}}]^\top \odot \left(e^{\boldsymbol{\Sigma}} - \mathbf{1} \right)
$$
       <p>
        Thus, $\boldsymbol{\mu}^L = \text{E}[\mathbf{R}_{t+ \tau, \tau}] = \text{E}[e^{\mathbf{r}_{t+ \tau, \tau}}] - 1$ and $\boldsymbol{\Sigma}^L = \text{Cov}[\mathbf{R}_{t+ \tau, \tau}] = \text{Cov}[e^{\mathbf{r}_{t+ \tau, \tau}}]$.
       </p>
       <p>
        Perform the optimization for a one and five year horizon.
       </p>
       <p>
        <strong>
         Question 8
        </strong>
       </p>
       <p>
        Check if the formulas for expected value and covariance of the linear returns are correct for the five year horizon. Use simulations, e.g.
        <code>
         np.random.multivariate_normal
        </code>
        .
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=legislative-replication">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># import pandas_datareader as pdr</span>
<span class="c1"># from pandas_datareader.famafrench import FamaFrenchReader, get_available_datasets</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s2">"5_Industry_Portfolios"</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">industry_port_daily</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># print description</span>
<span class="n">industry_port_daily</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=located-gather">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get equally weighted</span>
<span class="n">ind_eq_weighted</span> <span class="o">=</span> <span class="n">industry_port_daily</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># get market cap weighted </span>
<span class="n">ind_mc_weighted</span> <span class="o">=</span> <span class="n">industry_port_daily</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=separate-psychology">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ind_eq_weighted</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hairy-flower">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Note that
       </p>
       $$
\log \frac{P_t}{P_{t-\Delta t}} = \log \left( 1 + \frac{P_t - P_{t-\Delta t}}{P_{t-\Delta t}}\right)
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=handed-october">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">eq_log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">ind_eq_weighted</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=christian-latitude">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">eq_log_returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ignored-queensland">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=coordinated-seeking">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eq_log_returns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">eq_log_returns</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="c1"># volatilites</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>

<span class="c1"># correlation matrix </span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">cov_mat</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=optimum-round">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=suitable-regard">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        We remember that if the investment horizon is $\tau$ years and estimation interval is $\Delta t$, then
       </p>
       $$
\text{E}[\mathbf{X}_{t+ \tau, \tau}] = \frac{\tau}{\Delta t}\text{E}[\mathbf{X}_{t, \Delta t}]
$$
       <p>
        The covariance matrix (the variance for a univariate invariant) is
       </p>
       $$
\text{Cov}[\mathbf{X}_{t+ \tau, \tau}] = \frac{\tau}{\Delta t}\text{Cov}[\mathbf{X}_{t, \Delta t}]
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=analyzed-philosophy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">12.0</span> 

<span class="c1"># one year</span>
<span class="n">mu_1y</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">mu</span> 
<span class="n">cov_mat_1y</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">cov_mat</span>

<span class="c1"># five year </span>
<span class="n">mu_5y</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">mu</span> 
<span class="n">cov_mat_5y</span> <span class="o">=</span> <span class="mf">5.0</span> <span class="o">/</span> <span class="n">dt</span> <span class="o">*</span> <span class="n">cov_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=substantial-generation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        We define function that solves the optimization problem.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=nonprofit-teens">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                              <span class="n">risk_aversion</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates optimal port. weights</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu: </span>
<span class="sd">        Expected returns</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    risk_aversion: </span>
<span class="sd">        Risk aversion parameter</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Optimal portfolio weights</span>
<span class="sd">    """</span>
    <span class="n">sigma_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">A</span>
    <span class="n">C_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">C</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
    
    <span class="n">first_part</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">mu</span> 
    <span class="n">second_part</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">A</span> <span class="o">*</span> <span class="n">C_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">-</span>  <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="n">opt_weights</span> <span class="o">=</span> <span class="n">first_part</span> <span class="o">-</span> <span class="n">second_part</span>
    
    <span class="k">return</span> <span class="n">opt_weights</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fifth-vanilla">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_aversion</span> <span class="o">=</span> <span class="mi">10</span>

<span class="sd">"""</span>
<span class="sd">One year</span>
<span class="sd">"""</span>
<span class="n">opt_weights_1y</span> <span class="o">=</span> <span class="n">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu_1y</span><span class="p">,</span> <span class="n">cov_mat_1y</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">)</span>
<span class="n">opt_weights_1y</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fatty-protocol">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Five year</span>
<span class="sd">"""</span>
<span class="n">opt_weights_5y</span> <span class="o">=</span> <span class="n">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu_5y</span><span class="p">,</span> <span class="n">cov_mat_5y</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">)</span>
<span class="n">opt_weights_5y</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=guilty-warren">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        $\mathbf{w}^\top \boldsymbol{\mu}$ is not the expected log return of the portfolio and $\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}$ is not the variance! Log returns
        <em>
         aggregrates across time
        </em>
        , but not across securities.
       </p>
       <p>
        We also note from the previous question that the optimal portfolio does not depend on the time horizon!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=controlled-russia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 7
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=verified-assets">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_mu_l</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">covariance</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates the expected value of the linear return vector, </span>
<span class="sd">    when log-returns are normally distributed</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu: </span>
<span class="sd">        Vector of expected log returns</span>
<span class="sd">    covariance: </span>
<span class="sd">        Covariance matrix of log returns</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Expected value of linear return vector </span>
<span class="sd">    """</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span> <span class="o">+</span> <span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">covariance</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

<span class="k">def</span> <span class="nf">calculate_sigma_l</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">covariance</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates the covariance matrix of the linear return vector, </span>
<span class="sd">    when log-returns are normally distributed</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu: </span>
<span class="sd">        Vector of expected log returns</span>
<span class="sd">    covariance: </span>
<span class="sd">        Covariance matrix of log returns</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Covariance matrix of linear return vector </span>
<span class="sd">    """</span>
    
    <span class="n">mu_l</span> <span class="o">=</span> <span class="n">calculate_mu_l</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">covariance</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">mu_l</span><span class="p">,</span> <span class="n">mu_l</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">covariance</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=compound-statistics">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">One year</span>
<span class="sd">"""</span>

<span class="n">mu_l_1y</span> <span class="o">=</span> <span class="n">calculate_mu_l</span><span class="p">(</span><span class="n">mu_1y</span><span class="p">,</span> <span class="n">cov_mat_1y</span><span class="p">)</span>
<span class="n">cov_mat_l_1y</span> <span class="o">=</span> <span class="n">calculate_sigma_l</span><span class="p">(</span><span class="n">mu_1y</span><span class="p">,</span> <span class="n">cov_mat_1y</span><span class="p">)</span>

<span class="n">opt_weights_l_1y</span> <span class="o">=</span> <span class="n">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu_l_1y</span><span class="p">,</span> <span class="n">cov_mat_l_1y</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">)</span>
<span class="n">opt_weights_l_1y</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=smoking-induction">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Five year</span>
<span class="sd">"""</span>

<span class="n">mu_l_5y</span> <span class="o">=</span> <span class="n">calculate_mu_l</span><span class="p">(</span><span class="n">mu_5y</span><span class="p">,</span> <span class="n">cov_mat_5y</span><span class="p">)</span>
<span class="n">cov_mat_l_5y</span> <span class="o">=</span> <span class="n">calculate_sigma_l</span><span class="p">(</span><span class="n">mu_5y</span><span class="p">,</span> <span class="n">cov_mat_5y</span><span class="p">)</span>

<span class="n">opt_weights_l_5y</span> <span class="o">=</span> <span class="n">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu_l_5y</span><span class="p">,</span> <span class="n">cov_mat_l_5y</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">)</span>
<span class="n">opt_weights_l_5y</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=pregnant-stockholm">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 8
        </strong>
       </p>
       <p>
        It seems to work!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=prescription-sponsorship">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">num_sim</span> <span class="o">=</span> <span class="mi">49999999</span>
<span class="n">random_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu_5y</span><span class="p">,</span> <span class="n">cov_mat_5y</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=excited-milan">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulated mean</span>
<span class="sd">"""</span>

<span class="n">random_draws</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=mineral-occupation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulated covariance matrix</span>
<span class="sd">"""</span>

<span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">random_draws</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=linear-villa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Analytical mean</span>
<span class="sd">"""</span>

<span class="n">mu_l_5y</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=postal-oklahoma">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Analytical covariance</span>
<span class="sd">"""</span>

<span class="n">cov_mat_l_5y</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=postal-sound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3:-On-the-square-root-rule">
        Problem 3: On the square-root rule
        <a class="anchor-link" href="#Problem-3:-On-the-square-root-rule">
         ¶
        </a>
       </h2>
       <p>
        If log returns are invariants, i.e. independent and identically distributed, then we can propagate the estimation interval variance to any horizon
       </p>
       $$
\text{Var}(r_{t + \tau, \tau}) = \text{Var}(r_{t + \Delta t, \Delta t})  +  \dots + \text{Var}(r_{t + \tau, \Delta t})  = \frac{\tau}{\Delta t} \sigma^2_{\Delta t}
$$
       <p>
        However, if log returns are dependent due to e.g. time varying risk premia this will no longer hold!
       </p>
       <p>
        <strong>
         Quesition 1
        </strong>
       </p>
       <p>
        Consider
       </p>
       $$
\log P_{t + \Delta t} - \log P_{t} = \mu + \varepsilon_{t + \Delta t}
$$
       <p>
        with $\varepsilon_{t + \Delta t} \sim N(0, \sigma_{\Delta t}^2)$. Assume monthly time steps and $\mu = 0.5\%, \sigma_{\Delta t}= 5\%$.
       </p>
       <p>
        Simulate 10,000 paths of monthly log returns for 10 years. Plot the cummulative log return together with the 5% and 95% percentiles.
       </p>
       <p>
        Does the square-root rule hold?
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Now consider the process
       </p>
       $$
\log P_{t + \Delta t} - \log P_{t} = \mu + \alpha \left(\theta_t - \log P_{t}\right) + \varepsilon_{t + \Delta t}
$$
       <p>
        where $\theta_t = \log ( P_0 e^{\mu t} ) $ and $\varepsilon_{t + \Delta t} \sim N(0, \sigma_{\Delta t}^2)$. If $\alpha &amp;gt; 0$, then if the asset is below its long term mean then it will have a higher expected return. Assume that we are working with monthly time steps and that $\mu = 0.5\%, \alpha = 0.01, \sigma_{\Delta t}= 5\%$.
       </p>
       <p>
        Simulate 10,000 paths of monthly log returns for 10 years. Plot the cummulative log return together with the 5% and 95% percentiles.
       </p>
       <p>
        Does the square-root rule hold?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=english-shepherd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define input parameters</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">months</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">12.0</span>
<span class="n">all_years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">months</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">dt</span>

<span class="c1"># simulate log-returns</span>
<span class="n">log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">months</span><span class="p">))</span>

<span class="c1"># calculate the cumulative log-returns</span>
<span class="n">cum_log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># calculate the 5th and 95th percentile </span>
<span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">cum_log_returns</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=formed-queue">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_years</span><span class="p">,</span> <span class="n">cum_log_returns</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_years</span><span class="p">,</span> <span class="n">percentiles</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Years'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">log P_{t + </span><span class="se">\\</span><span class="s2">tau} - </span><span class="se">\\</span><span class="s2">log P_</span><span class="si">{t}</span><span class="s2">$"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=mobile-bulgaria">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The square-root rule holds (increase the number of simulation to get a even better match)
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=identified-dealing">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cum_log_returns</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=roman-dominant">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=alike-slovak">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=distinct-healing">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">simulate</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">months</span><span class="p">:</span> <span class="nb">int</span><span class="p">):</span>

    <span class="c1"># simulate random shocks</span>
    <span class="n">eps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">months</span><span class="p">))</span>
    <span class="c1"># define long-term mean-reversion level</span>
    <span class="n">long_term</span> <span class="o">=</span> <span class="mi">0</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">months</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="c1"># define matrix to store log-returns</span>
    <span class="n">log_p</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">months</span><span class="p">))</span>

    <span class="c1"># recurssion to calculate log-returns</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">months</span><span class="p">):</span>
        <span class="n">log_p</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_p</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">+</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">long_term</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_p</span><span class="p">[:,</span> <span class="n">i</span><span class="p">])</span> <span class="o">+</span> <span class="n">eps</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">log_p</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">log_p</span><span class="p">[:,</span> <span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=geographic-donor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define inputs</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">0.005</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">months</span> <span class="o">=</span> <span class="mi">120</span>

<span class="c1"># simulate log-returns</span>
<span class="n">log_returns_mean_reversion</span> <span class="o">=</span> <span class="n">simulate</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">,</span> <span class="n">months</span><span class="p">)</span>
<span class="c1"># calculate cumulative log-retuns</span>
<span class="n">cum_log_returns_mean_reversion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_returns_mean_reversion</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="c1"># calculate 5th and 95th percentile</span>
<span class="n">percentiles_mean_reversion</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">cum_log_returns_mean_reversion</span><span class="p">,</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">95</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=handled-mouse">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_years</span><span class="p">,</span> <span class="n">cum_log_returns_mean_reversion</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_years</span><span class="p">,</span> <span class="n">percentiles_mean_reversion</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Years'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">log P_{t + </span><span class="se">\\</span><span class="s2">tau} - </span><span class="se">\\</span><span class="s2">log P_</span><span class="si">{t}</span><span class="s2">$"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=latest-inflation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The square-root rule does not hold! Mean-reversion results in a lower volatility that eventually stops increasing.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=complimentary-anchor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">cum_log_returns_mean_reversion</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=responsible-roulette">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">months</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=advisory-cursor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4:-Nominal-yields-data">
        Problem 4: Nominal yields data
        <a class="anchor-link" href="#Problem-4:-Nominal-yields-data">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Quesition 1
        </strong>
       </p>
       <p>
        Load the function
        <code>
         get_nominal_yield_data
        </code>
        from
        <code>
         codelib.dal.fred_yield_data
        </code>
        and check out the docstring.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Store the zero coupon yields in the data frame
        <code>
         zero_yields
        </code>
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Plot the 1-year, 5-year and 10-year yield over time.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Use
        <code>
         pandas-datareader
        </code>
        to obtain NBER recession indicators (FRED database, 'USREC'). Add recession indicators to the previous plot.
       </p>
       <p>
        <strong>
         Quesition 5
        </strong>
       </p>
       <p>
        Plot a 3D plot of the zero coupon yield curves over time from 1986 (drop all dates with NaN).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=absent-vanilla">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=falling-gather">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">%</span><span class="k">pdoc</span> get_nominal_yield_data
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=animated-portfolio">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">help</span><span class="p">(</span><span class="n">get_nominal_yield_data</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=instructional-cancer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=alive-gravity">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">zero_yields</span> <span class="o">=</span> <span class="n">get_nominal_yield_data</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s1">'zero_yields'</span><span class="p">)</span>
<span class="n">zero_yields</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=broadband-bandwidth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">zero_yields</span><span class="o">.</span><span class="n">columns</span>  <span class="o">=</span> <span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">_</span><span class="p">)</span><span class="o">+</span><span class="s1">'Y'</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">)]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=immediate-drinking">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=continued-gambling">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">zero_yields</span><span class="p">[[</span><span class="s1">'1Y'</span><span class="p">,</span> <span class="s1">'5Y'</span><span class="p">,</span> <span class="s1">'10Y'</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zero yield (in %)'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=southeast-vinyl">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=individual-participation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">nber_recessions</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">(</span><span class="s1">'USREC'</span><span class="p">,</span> <span class="s1">'fred'</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1960</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>

<span class="c1"># get start and end dates of recessions</span>
<span class="n">change_nber</span> <span class="o">=</span> <span class="n">nber_recessions</span> <span class="o">-</span> <span class="n">nber_recessions</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">start_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">==</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">end_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">==-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=vanilla-mitchell">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [48]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ax</span> <span class="o">=</span> <span class="n">zero_yields</span><span class="p">[[</span><span class="s1">'1Y'</span><span class="p">,</span> <span class="s1">'5Y'</span><span class="p">,</span> <span class="s1">'10Y'</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zero yield (in %)'</span><span class="p">);</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_dates</span><span class="p">,</span> <span class="n">end_dates</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=restricted-final">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=understanding-cloud">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [49]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">mpl_toolkits.mplot3d</span> <span class="kn">import</span> <span class="n">Axes3D</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">dates</span><span class="p">,</span> <span class="n">ticker</span>


<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">)</span>

<span class="c1"># Dropping NaN values</span>
<span class="n">zero_yields</span> <span class="o">=</span> <span class="n">zero_yields</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># Converting dates to numerical format for plotting</span>
<span class="n">dates_for_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">dates</span><span class="o">.</span><span class="n">date2num</span><span class="p">(</span><span class="n">zero_yields</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()))</span>
<span class="n">tenors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># Creating a meshgrid for plotting</span>
<span class="n">d</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">dates_for_plot</span><span class="p">,</span> <span class="n">tenors</span><span class="p">)</span>

<span class="c1"># Plotting the surface</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">zero_yields</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'YlGnBu_r'</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># Setting axis labels</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">''</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">'Yield (in %)'</span><span class="p">);</span>

<span class="c1"># Formatting the x-axis to display dates in 'Year' format</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">FuncFormatter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">p</span><span class="p">:</span> <span class="n">dates</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">x</span><span class="p">)</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s1">'%Y'</span><span class="p">)))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># making function library available</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>
<span class="c1"># numpy for vector and matrices</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># pandas for working with dataframes</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mtick</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># for working with dates, etc. </span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># scipy for working with random variables, etc. </span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># Data </span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>

<span class="c1"># typehints</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">codelib.dal.fred_yield_data</span> <span class="kn">import</span> <span class="n">get_nominal_yield_data</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-3">
        Exercises - Week 3
        <a class="anchor-link" href="#Exercises---Week-3">
         ¶
        </a>
       </h1>
       <p>
        In this week we will look at a few exercises involving univariate and multivariate statistics.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=chief-destination">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1:-The-Student's-t-distribution">
        Problem 1: The Student's t distribution
        <a class="anchor-link" href="#Problem-1:-The-Student's-t-distribution">
         ¶
        </a>
       </h2>
       <p>
        We assume that the random variable $T$ follows a
        <a href="https://en.wikipedia.org/wiki/Student%27s_t-distribution">
         Student's t-distribution
        </a>
        :
       </p>
       $$
T = \frac{Z}{\sqrt{\frac{V}{\nu}}} \sim t(\nu)
$$
       <p>
        where $Z\sim N(0,1)$ and $ V \sim \chi^2(\nu)$ are independent, and $\nu$ is the degrees of freedom. The distribution can be represented by the density (pdf)
       </p>
       $$
f_T(t) = \textstyle\frac{\Gamma \left(\frac{\nu+1}{2} \right)} {\sqrt{\nu\pi}\,\Gamma \left(\frac{\nu}{2} \right)} \left(1+\frac{t^2}{\nu} \right)^{-\frac{\nu+1}{2}}\!
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Plot the pdfs for the cases $\nu = 2, 10, 50$. Plot the pdf of a standard normal for comparison.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        The t-distribution is used for small sample hypothesis testing when it is reasonable to assume that the random sample $X_1, ..., X_n$ is iid from the distribution $N(\mu, \sigma^2)$.
       </p>
       <p>
        Define the sample mean
       </p>
       $$
\bar{X} = \frac{1}{n}\sum_{i=1}^n X_i
$$
       <p>
        and the sample variance
       </p>
       $$
S^2 = \frac{1}{n-1} \sum_{i=1}^n (X_i - \bar{X})^2
$$
       <p>
        The "Z-score" (under the normallity assumption)
       </p>
       $$
\frac{\bar{X} - \mu}{\sqrt{\frac{S^2}{n}}} \sim t(n-1)
$$
       <p>
        such that we can construct confidence intervals for $\mu$, the only unknown parameter.
       </p>
       <p>
        Simulate 10,000 samples of size $n=10$ when $X_i \sim N(5, 4)$. For each sample, calculate the sample mean, variance and the "Z-score". Plot a histogram of the Z-scores and compare with the pdf of the true distribution. Plot the pdf of a standard normal distribution for comparison.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Repeat question 2 with $n = 25$.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        We want to calculate the expected value of
       </p>
       $$
g(T) = e^{5 + 10\cdot T}
$$
       <p>
        where $T \sim t(5)$. Calculate this expectation using
        <code>
         scipy.t.expect
        </code>
        .
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        We want to calculate the expected value of
       </p>
       $$
h(T) = 5 \cdot x^2
$$
       <p>
        where $T \sim t(5)$. Calculate this expectation using
        <code>
         scipy.t.expect
        </code>
        .
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        When $\nu \to \infty$ then the t-distribution converges to a standard normal distribution. For small $\nu$ the distribution is more leptokurtic (fatter tails).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=comprehensive-engineer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">t_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pdf_nu2_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">pdf_nu10_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="mi">10</span><span class="p">)</span>
<span class="n">pdf_nu50_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>
<span class="n">pdf_norm_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_values</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">pdf_nu2_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">nu =2$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">pdf_nu10_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">nu =10$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">pdf_nu50_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">nu =50$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">pdf_norm_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$N(0,1)$"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$t$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=polish-speaking">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        It seems that the simulated distribution matches the true! Simulations may help get a understanding of the distributional properties of estimators and test statistics.
       </p>
       <p>
        There is an evident difference between the simulated distribution (and the true t-distribution) and the standard normal distribution indicating that we cannot use the CLT to perform hypothesis testing.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fitting-therapy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># set values</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># simulate data</span>
<span class="n">random_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">))</span>
<span class="n">sample_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">random_draws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sample_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">random_draws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sample_z_scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_means</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sample_var</span><span class="o">/</span><span class="n">sample_size</span><span class="p">)</span>

<span class="n">t_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="c1"># t-dist</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">sample_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># normal </span>
<span class="n">pdf_normal_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_values</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sample_z_scores</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">pdf_normal_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Standard Normal"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$t$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=intelligent-trick">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Now the distribution of the test statistics is much closer to the standard normal, which can be used as the asymptotic distribution of the test statistics (even for non-normal data).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=prerequisite-morris">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># set values</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">2</span>

<span class="c1"># simulate data</span>
<span class="n">random_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">))</span>
<span class="n">sample_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">random_draws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sample_var</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">random_draws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sample_z_scores</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_means</span> <span class="o">-</span> <span class="n">mu</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sample_var</span><span class="o">/</span><span class="n">sample_size</span><span class="p">)</span>

<span class="n">t_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="c1"># t-dist</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">sample_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="c1"># normal </span>
<span class="n">pdf_normal_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">t_values</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sample_z_scores</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">t_values</span><span class="p">,</span> <span class="n">pdf_normal_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Standard Normal"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$t$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=bulgarian-assumption">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        The expecation is not defined, so
        <code>
         inf
        </code>
        is returned.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=prospective-status">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define the function g(t)</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">g</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">5.0</span> <span class="o">+</span> <span class="mf">10.0</span> <span class="o">*</span> <span class="n">t</span><span class="p">)</span>



<span class="sd">"""</span>
<span class="sd">Use stats.t.expect</span>
<span class="sd">"""</span>

<span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=faced-influence">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        The expected value is defined and we can use the function to calculate the expected value.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=frequent-treaty">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define the function h(t)</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">h</span><span class="p">(</span><span class="n">t</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="mi">5</span> <span class="o">*</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span>

<span class="sd">"""</span>
<span class="sd">Use stats.t.expect</span>
<span class="sd">"""</span>

<span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">5</span><span class="p">,))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=corresponding-meditation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:-The-empirical-distribution-function">
        Problem 2: The empirical distribution function
        <a class="anchor-link" href="#Problem-2:-The-empirical-distribution-function">
         ¶
        </a>
       </h2>
       <p>
        In this exercise, we will have a look at the
        <a href="https://en.wikipedia.org/wiki/Empirical_distribution_function">
         empirical distribution function
        </a>
        . Remember that if we let $X_1, ..., X_n$ be a sequence iid random variables with cdf $F_X(x)$, then the empirical distribtion function is defined as
       </p>
       $$
F_n(x) = \frac{1}{n}\sum_{i=1}^n I(X_i \leq x)
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Simulate a random sample from a
        <a href="https://en.wikipedia.org/wiki/Cauchy_distribution">
         Cauchy distribution
        </a>
        with $n=25$, $n=100$, $n=1000$, and $n=5000$. Assume $x_0=0$ and $\gamma=1$ in the wikipedia formulation, i.e. simply use the default in
        <code>
         SciPy
        </code>
        . Plot the Empirical distribution function for each case. Add the true CDF to the plot.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Dvoretzky%E2%80%93Kiefer%E2%80%93Wolfowitz_inequality">
         Dvoretzky–Kiefer–Wolfowitz inequality
        </a>
        states that the interval that contains the true CDF, $F(x)$, with probability $1-\alpha$ is specified as
       </p>
       $$
F_n(x) - \epsilon \leq F(x) \leq F_n(x) + \epsilon
$$
       <p>
        with
       </p>
       $$
\epsilon = \sqrt{\frac{\ln \frac{2}{\alpha}}{2n}}
$$
       <p>
        Implement this confidence interval for $\alpha=0.05$ and add them to the plots.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=waiting-wisconsin">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># generate random variates from the cauchy distribution </span>
<span class="n">random_data</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="mi">5000</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ultimate-negotiation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define simple function calculating the EDF</span>

<span class="sd">Note: It would be possible to use "statsmodels.distributions.empirical_distribution.ECDF"</span>

<span class="sd">See https://www.statsmodels.org/dev/generated/statsmodels.distributions.empirical_distribution.ECDF.html </span>
<span class="sd">"""</span>


<span class="k">def</span> <span class="nf">calculate_edf</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the empirical distribution function </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x: </span>
<span class="sd">        Values at which to evaluate the EDF</span>
<span class="sd">    data: </span>
<span class="sd">        Data used to calculate the EDF</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">sorted_data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">sorted_data</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">searchsorted</span><span class="p">(</span><span class="n">sorted_data</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">side</span><span class="o">=</span><span class="s1">'right'</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">probs</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=adverse-spirit">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sample_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    
    <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    
    <span class="n">temp_data</span> <span class="o">=</span> <span class="n">random_data</span><span class="p">[:</span><span class="n">sample_size</span><span class="p">]</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">calculate_edf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temp_data</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Cumulative Probability'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Empirical CDF for $n=</span><span class="si">{}</span><span class="s1">$ (Cauchy dist.)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_size</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=american-rouge">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=matched-genre">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">edf_confidence</span><span class="p">(</span><span class="n">edf</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">n</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the confidence interval for the empirical CDF</span>
<span class="sd">    </span>
<span class="sd">    Parameter</span>
<span class="sd">    ---------</span>
<span class="sd">    edf: </span>
<span class="sd">        Values of the EDF for which to find the confidence interval</span>
<span class="sd">    n: </span>
<span class="sd">        Number for observations </span>
<span class="sd">    alpha: </span>
<span class="sd">        Confidence level. </span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        Lower and upper limit of confidence interval </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="c1"># epsilon</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">/</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">n</span><span class="p">))</span>
    
    <span class="c1"># lower and upper bounds </span>
    <span class="n">lower</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">edf</span> <span class="o">-</span> <span class="n">epsilon</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">edf</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=injured-documentation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sample_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">5000</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">10.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">):</span>
    
    <span class="n">sample_size</span> <span class="o">=</span> <span class="n">sample_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>    
    <span class="n">temp_data</span> <span class="o">=</span> <span class="n">random_data</span><span class="p">[:</span><span class="n">sample_size</span><span class="p">]</span>
    
    <span class="n">edf</span> <span class="o">=</span> <span class="n">calculate_edf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">temp_data</span><span class="p">)</span>
    <span class="n">low</span><span class="p">,</span> <span class="n">up</span> <span class="o">=</span> <span class="n">edf_confidence</span><span class="p">(</span><span class="n">edf</span><span class="p">,</span> <span class="n">sample_size</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">edf</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">cauchy</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">low</span><span class="p">,</span> <span class="n">up</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Cumulative Probability'</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Empirical CDF for $n=</span><span class="si">{}</span><span class="s1">$ (Cauchy dist.)'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_size</span><span class="p">))</span>

<span class="n">fig</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=optimum-benchmark">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3:-Moments-with-scenario-probabilities">
        Problem 3: Moments with scenario probabilities
        <a class="anchor-link" href="#Problem-3:-Moments-with-scenario-probabilities">
         ¶
        </a>
       </h2>
       <p>
        In this problem, we will look at how we can calculate different moments when we are using scenario probabilities.
       </p>
       <p>
        Consider the scenarios and related probabilites:
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=tracked-protein">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.38874223</span><span class="p">,</span> <span class="mf">9.64297756</span><span class="p">,</span> <span class="mf">1.27555492</span><span class="p">,</span> <span class="mf">3.12537902</span><span class="p">,</span> <span class="mf">2.4580506</span><span class="p">,</span>
              <span class="mf">0.8053753</span> <span class="p">,</span> <span class="mf">6.13998831</span><span class="p">,</span> <span class="mf">7.55690088</span><span class="p">,</span> <span class="mf">3.97384118</span><span class="p">,</span> <span class="mf">7.86858951</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=organized-velvet">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">probs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.04650611</span><span class="p">,</span> <span class="mf">0.06914496</span><span class="p">,</span> <span class="mf">0.21835384</span><span class="p">,</span> <span class="mf">0.09998765</span><span class="p">,</span> <span class="mf">0.02251887</span><span class="p">,</span>
                  <span class="mf">0.00831124</span><span class="p">,</span> <span class="mf">0.14610489</span><span class="p">,</span> <span class="mf">0.10819035</span><span class="p">,</span> <span class="mf">0.07328199</span><span class="p">,</span> <span class="mf">0.20760009</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=judicial-attraction">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Problem 1
        </strong>
       </p>
       <p>
        Use the
        <code>
         numpy.average
        </code>
        function to calculate the mean of the scenarios. Please note that the function has an
        <code>
         weights
        </code>
        argument that can be used to provide scenario specific probabilities.
       </p>
       <p>
        <strong>
         Problem 2
        </strong>
       </p>
       <p>
        Define a function which can calculate the variance with scenario probabilities. Calculate the variance.
       </p>
       <p>
        Also define a function which calculates the standard devation. Calculate the standard devation.
       </p>
       <p>
        <strong>
         Problem 3
        </strong>
       </p>
       <p>
        Consider a second set of scenarios
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=operating-shakespeare">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">10.21360159</span><span class="p">,</span> <span class="mf">13.08162811</span><span class="p">,</span>  <span class="mf">9.33243406</span><span class="p">,</span>  <span class="mf">1.90613543</span><span class="p">,</span> <span class="mf">17.15583533</span><span class="p">,</span>
              <span class="mf">17.87137586</span><span class="p">,</span>  <span class="mf">1.84765146</span><span class="p">,</span>  <span class="mf">1.8249457</span> <span class="p">,</span>  <span class="mf">7.36965481</span><span class="p">,</span>  <span class="mf">0.20770526</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=violent-volume">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Define a function which can calculate the covariance between the two variables. Calculate the covariance.
       </p>
       <p>
        <strong>
         Problem 4
        </strong>
       </p>
       <p>
        Define a function which can calculate the correlation between the two variables. Calculate the correlation.
       </p>
       <p>
        <strong>
         Problem 5
        </strong>
       </p>
       <p>
        Define a function which can calculate the skewness. Calculate the skewness (for $X$).
       </p>
       <p>
        <strong>
         Problem 6
        </strong>
       </p>
       <p>
        Define a function which can calculate the kurtosis (excess). Calculate the kurtosis (for $X$).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=subjective-orange">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Problem 1
        </strong>
       </p>
       <p>
        We can calculate the mean as
       </p>
       $$
\text{E}[X] =  \sum_{i=1}^n p_i x_i = \boldsymbol{p}^\top \boldsymbol{x}
$$
       <p>
        This can be done directly using
        <code>
         numpy.average
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=technical-vitamin">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=greater-norman">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Problem 2
        </strong>
       </p>
       <p>
        In order to define a function calculating the variance, we note that we can write
       </p>
       $$
\text{Var}[X] = \text{E}[X^2] - \text{E}[X]^2 = \text{E}[(X - \text{E}[X])^2] 
$$
       <p>
        One way of calculating the variance would be
       </p>
       $$
\text{Var}[X] =  \sum_{i=1}^n p_i (x_i - \text{E}[X])^2
$$
       <p>
        Hence, we can directly apply
        <code>
         numpy.average
        </code>
        inside our function.
       </p>
       <p>
        To obtain the standard devation, we simple take the square root.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=thrown-murray">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_variance</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates variance.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x:</span>
<span class="sd">        Data to calculate variance for.</span>
<span class="sd">    probs:</span>
<span class="sd">        Probabilities.</span>
<span class="sd">    axis:</span>
<span class="sd">        Axis over which to calculate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        Variance.</span>

<span class="sd">    """</span>

    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">m</span><span class="p">),</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=vulnerable-replication">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_std</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">probs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates standard deviation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x:</span>
<span class="sd">        Data to calculate standard deviation for.</span>
<span class="sd">    probs:</span>
<span class="sd">        Probabilities.</span>
<span class="sd">    axis:</span>
<span class="sd">        Axis over which to calculate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        Standard devation.</span>

<span class="sd">    """</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">calculate_variance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=supposed-pastor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">calculate_variance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=nervous-disney">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">calculate_std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=foster-salmon">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Problem 3
        </strong>
       </p>
       <p>
        We can calculate the covariance using
       </p>
       $$
\begin{equation*}
\text{Cov}[X,Y]= \text{E}[(X- \text{E}[X])(Y- \text{E}[Y])] = \text{E}[XY] - \text{E}[X]\text{E}[Y]
\end{equation*}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=possible-titanium">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_covariance</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">probs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates covariance between two variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x:</span>
<span class="sd">        First variable.</span>
<span class="sd">    y:</span>
<span class="sd">        Second variable.</span>
<span class="sd">    probs:</span>
<span class="sd">        Probabilities.</span>
<span class="sd">    axis:</span>
<span class="sd">        Axis over which to calculate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        Covariance.</span>

<span class="sd">    """</span>

    <span class="n">m_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">m_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="n">m_xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">y</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">m_xy</span> <span class="o">-</span> <span class="n">m_x</span> <span class="o">*</span> <span class="n">m_y</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=weird-johns">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">calculate_covariance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=blocked-interview">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Problem 4
        </strong>
       </p>
       <p>
        The correlation coefficient is defined as
       </p>
       $$
\rho_{X,Y} = \text{Corr}[X,Y] = \frac{\text{Cov}[X,Y] }{\sqrt{\text{Var}[X]\text{Var}[Y]}}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=center-bracket">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_correlation</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">probs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates correlation between two variables.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x:</span>
<span class="sd">        First variable.</span>
<span class="sd">    y:</span>
<span class="sd">        Second variable.</span>
<span class="sd">    probs:</span>
<span class="sd">        Probabilities.</span>
<span class="sd">    axis:</span>
<span class="sd">        Axis over which to calculate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        Correlation.</span>

<span class="sd">    """</span>

    <span class="n">c</span> <span class="o">=</span> <span class="n">calculate_covariance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">std_x</span> <span class="o">=</span> <span class="n">calculate_std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>
    <span class="n">std_y</span> <span class="o">=</span> <span class="n">calculate_std</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">c</span> <span class="o">/</span> <span class="p">(</span><span class="n">std_x</span> <span class="o">*</span> <span class="n">std_y</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=pointed-softball">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">calculate_correlation</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=protective-gilbert">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Problem 5
        </strong>
       </p>
       <p>
        The skewness coefficient
       </p>
       $$
\begin{equation*}
\text{Skew}[X] = \frac{\text{E}[(X-\mu)^3]}{\sigma^3}
\end{equation*}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=decreased-latvia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_skewness</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">probs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates skewness.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x:</span>
<span class="sd">        Data to calculate skewness for.</span>
<span class="sd">    probs:</span>
<span class="sd">        Probabilities.</span>
<span class="sd">    axis:</span>
<span class="sd">        Axis over which to calculate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        skewness.</span>

<span class="sd">    """</span>

    <span class="n">m_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">m_x_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">std</span> <span class="o">=</span> <span class="n">calculate_std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">m_x_3</span> <span class="o">-</span> <span class="mi">3</span> <span class="o">*</span> <span class="n">m_x</span> <span class="o">*</span> <span class="n">std</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">m_x</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">**</span> <span class="mi">3</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=egyptian-consumption">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">calculate_skewness</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=injured-surprise">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Problem 6
        </strong>
       </p>
       $$
\begin{equation*}
 \text{Kurt}[X] = \frac{\text{E}[(X-\mu)^4]}{\sigma^4} - 3
\end{equation*}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=intimate-words">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_kurtosis</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">probs</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">excess</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates kurtosis.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x:</span>
<span class="sd">        Data to calculate kurtosis for.</span>
<span class="sd">    probs:</span>
<span class="sd">        Probabilities.</span>
<span class="sd">    excess:</span>
<span class="sd">        Boolean indicating wether to calculate excess kurtosis. Default is True.</span>
<span class="sd">    axis:</span>
<span class="sd">        Axis over which to calculate.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        Kurtosis.</span>

<span class="sd">    """</span>

    <span class="n">x_d</span> <span class="o">=</span> <span class="n">x</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>
    <span class="n">m_x_d_4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">x_d</span> <span class="o">**</span> <span class="mi">4</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="n">std</span> <span class="o">=</span> <span class="n">calculate_std</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">excess</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m_x_d_4</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span> <span class="o">-</span> <span class="mf">3.0</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">m_x_d_4</span> <span class="o">/</span> <span class="p">(</span><span class="n">std</span> <span class="o">**</span> <span class="mi">4</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=romance-opposition">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">calculate_kurtosis</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">probs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=material-leader">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4:-Exponential-decay-probabilities">
        Problem 4: Exponential decay probabilities
        <a class="anchor-link" href="#Problem-4:-Exponential-decay-probabilities">
         ¶
        </a>
       </h2>
       <p>
        In this problem, we will see how to implement exponential decay probabilities.
       </p>
       <p>
        A typical use case for exponential smoothing is for estimating parameters in a parametric Monte Carlo simulation. One will use an exponential filter to estimate the expected values, $\boldsymbol{\mu}^{\lambda}$,  and covariance matrix, $\boldsymbol{\Sigma}^{\lambda}$, of the risk drivers and assume $\mathbf{X} \sim N(\boldsymbol{\mu}^{\lambda}, \boldsymbol{\Sigma}^{\lambda})$. More specifically,
       </p>
       $$
\boldsymbol{\mu}^{\lambda} = \gamma \sum_{t=1}^T e^{-\lambda (T-t)} \mathbf{x}_t
$$
       <p>
        and
       </p>
       $$
\boldsymbol{\Sigma}^{\lambda} = \gamma \sum_{t=1}^T e^{-\lambda (T-t)} \mathbf{x}_t \mathbf{x}_t^\top  - \boldsymbol{\mu}^{\lambda} (\boldsymbol{\mu}^{\lambda})^\top
$$
       <p>
        where $\gamma = 1 /  \sum_{t=1}^T e^{-\lambda (T-t)}$ to make the weights sum to one. $\lambda$ controls the decay of the exponential filter. A $\lambda=0.0055$ will represent a half-life of approximately six months with daily data.
       </p>
       <p>
        However, we will be able to specify the distribution without applying Monte Carlo simulations with a particular distributional assumption. We can simply set $p_t$ equal to the exponential decay factor (we need to account for a scaling factor).
       </p>
       $$
p_t \propto e^{-\lambda (T-t)}
$$
       <p>
        such that more recent scenarios are more likely (we use $t$ and $T$ instead of $i$ and $n$ because we typically work with exponential smoothing in a time-series context).
       </p>
       <p>
        <strong>
         Note: Half-life
        </strong>
       </p>
       <p>
        The half-life, $\kappa$, is equal to
       </p>
       $$
\kappa = \frac{\ln 2}{\lambda}
$$
       <p>
        To see this, consider the value af time $t$, $N_t$, given the value at time $0$, $N_0$ and exponential decay:
       </p>
       $$
N_t = N_0 e^{-\lambda t}
$$
       <p>
        To see when the value is halved we replace $N_t$ with $N_0 / 2$ and insert $\kappa$ inplace of $t$
       </p>
       $$
\frac{N_0}{2} = N_0 e^{-\lambda \kappa}
$$
       <p>
        Taking the natural logarithm on both sides gives us
       </p>
       $$
\ln N_0 - \ln 2 = \ln N_0 - \lambda \kappa
$$
       <p>
        Solving for $\kappa$ yields
       </p>
       $$
\kappa = \frac{\ln 2}{\lambda}
$$
       <p>
        This also means that we can write
       </p>
       $$
p_t \propto e^{-\frac{\ln 2}{\kappa} (T-t)}
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Implement a function that can calculate exponential decay probabilities for a given time point in a sample, say
        <code>
         target_time_point
        </code>
        , an array of time-points, say
        <code>
         time_points
        </code>
        , and a half-life parameter, say
        <code>
         half_life
        </code>
        .
       </p>
       <p>
        Call the function with
       </p>
       <pre><code>target_time_point = 1000
time_points = np.linspace(0, 1000, 1001)
half_life = 100
</code></pre>
       <p>
        Plot the resulting probabilities.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Obtain log-returns from the S&amp;amp;P 500 since 2010-01-01 (hint: use
        <code>
         yfinance
        </code>
        , ticker: '^GSPC').
       </p>
       <p>
        Calculate exponential decay probabilites with a half-life of 50, 100 and 500 business days (assuming equally spaced observations).
       </p>
       <p>
        Plot the probabilities.
       </p>
       <p>
        Calculate the standard deviation for the three sets of scenario probabilities.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=informative-dublin">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_exponential_decay_probabilities</span><span class="p">(</span><span class="n">target_time_point</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">int</span><span class="p">,</span> <span class="nb">float</span><span class="p">],</span>
                                              <span class="n">time_points</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                              <span class="n">half_life</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">int</span><span class="p">])</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates exponential decay probabilities for an array of time points based on a target timepoint and a half life.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    target_time_point:</span>
<span class="sd">        The target time point.</span>
<span class="sd">    time points:</span>
<span class="sd">        The array of time points to calculate probabilities for.</span>
<span class="sd">    half_life:</span>
<span class="sd">        The half life of the exponential decay.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Exponential decay probabilities.</span>

<span class="sd">    """</span>

    <span class="n">numerator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">half_life</span> <span class="o">*</span> 
                       <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">target_time_point</span> <span class="o">-</span> <span class="n">time_points</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">numerator</span><span class="p">)</span>

    <span class="n">p_t</span> <span class="o">=</span> <span class="n">numerator</span> <span class="o">/</span> <span class="n">denominator</span>

    <span class="k">return</span> <span class="n">p_t</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=assisted-personality">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">target_time_point</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">,</span> <span class="mi">1001</span><span class="p">)</span>
<span class="n">half_life</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">probs</span> <span class="o">=</span> <span class="n">calculate_exponential_decay_probabilities</span><span class="p">(</span><span class="n">target_time_point</span><span class="o">=</span><span class="n">target_time_point</span><span class="p">,</span>
                                                  <span class="n">time_points</span><span class="o">=</span><span class="n">time_points</span><span class="p">,</span> <span class="n">half_life</span><span class="o">=</span><span class="n">half_life</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=continent-ceramic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span> <span class="n">probs</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Time'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Probabilities, $p_t$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Exponential decay probabilities'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=respected-philosophy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sunset-newton">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Get data</span>
<span class="sd">"""</span>
<span class="n">df_index</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'^GSPC'</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2010</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="s1">'Adj Close'</span><span class="p">]</span>

<span class="n">df_log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">df_index</span> <span class="o">/</span> <span class="n">df_index</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=limited-deadline">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate probabilities</span>
<span class="sd">"""</span>

<span class="n">log_returns</span> <span class="o">=</span> <span class="n">df_log_returns</span><span class="o">.</span><span class="n">values</span>
<span class="n">last_time_point</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_returns</span><span class="p">)</span>
<span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">last_time_point</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">probs_50</span> <span class="o">=</span> <span class="n">calculate_exponential_decay_probabilities</span><span class="p">(</span><span class="n">target_time_point</span><span class="o">=</span><span class="n">last_time_point</span><span class="p">,</span> <span class="n">time_points</span><span class="o">=</span><span class="n">time_points</span><span class="p">,</span> <span class="n">half_life</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">probs_100</span> <span class="o">=</span> <span class="n">calculate_exponential_decay_probabilities</span><span class="p">(</span><span class="n">target_time_point</span><span class="o">=</span><span class="n">last_time_point</span><span class="p">,</span> <span class="n">time_points</span><span class="o">=</span><span class="n">time_points</span><span class="p">,</span> <span class="n">half_life</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">probs_500</span> <span class="o">=</span> <span class="n">calculate_exponential_decay_probabilities</span><span class="p">(</span><span class="n">target_time_point</span><span class="o">=</span><span class="n">last_time_point</span><span class="p">,</span> <span class="n">time_points</span><span class="o">=</span><span class="n">time_points</span><span class="p">,</span> <span class="n">half_life</span><span class="o">=</span><span class="mi">500</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=allied-convenience">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot probabilities</span>
<span class="sd">"""</span>

<span class="n">idx_vals</span> <span class="o">=</span> <span class="n">df_log_returns</span><span class="o">.</span><span class="n">index</span> 

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">idx_vals</span><span class="p">,</span> <span class="n">probs_50</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">kappa = 50$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">idx_vals</span><span class="p">,</span> <span class="n">probs_100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">kappa = 100$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">idx_vals</span><span class="p">,</span> <span class="n">probs_500</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">kappa = 500$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Time'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Probabilities, $p_t$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Exponential decay probabilities'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=simple-brand">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Ann. volatility in %, half-life of 50 days</span>
<span class="sd">"""</span>

<span class="n">calculate_std</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">probs_50</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=imperial-mumbai">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Ann. volatility in %, half-life of 100 days</span>
<span class="sd">"""</span>

<span class="n">calculate_std</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">probs_100</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=prostate-presence">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Ann. volatility in %, half-life of 500 days</span>
<span class="sd">"""</span>

<span class="n">calculate_std</span><span class="p">(</span><span class="n">log_returns</span><span class="p">,</span> <span class="n">probs_500</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">250</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=valid-socket">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1696802">
         Attilio Meucci (2010), Historical Scenarios with Fully Flexible Probabilities
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># numpy for vector and matrices</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="c1"># pandas for dataframes</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="c1"># plotting libraries</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mtick</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="c1"># working with dates</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="c1"># scipy for statistics and optimization</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="c1"># data apis</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span> 

<span class="kn">from</span> <span class="nn">pandas_datareader</span> <span class="kn">import</span> <span class="n">data</span> <span class="k">as</span> <span class="n">wb</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>
<span class="c1"># typehints </span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.statistics</span> <span class="kn">import</span> <span class="n">calculate_cornish_fisher_percentile</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.risk_budget</span> <span class="kn">import</span> <span class="n">calculate_marginal_risks_std</span><span class="p">,</span> <span class="n">calculate_risk_contributions_std</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.risk_metrics</span> <span class="kn">import</span> <span class="n">calculate_normal_cond_value_at_risk</span><span class="p">,</span> <span class="n">calculate_normal_value_at_risk</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.risk_metrics</span> <span class="kn">import</span> <span class="n">calculate_normal_port_cond_value_at_risk</span><span class="p">,</span> <span class="n">calculate_normal_port_value_at_risk</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.risk_metrics</span> <span class="kn">import</span> <span class="n">calculate_conditional_value_at_risk</span><span class="p">,</span> <span class="n">calculate_value_at_risk</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.risk_budget</span> <span class="kn">import</span> <span class="n">calculate_marginal_risks_cvar</span><span class="p">,</span> <span class="n">calculate_risk_contributions_cvar</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-4">
        Exercises - Week 4
        <a class="anchor-link" href="#Exercises---Week-4">
         ¶
        </a>
       </h1>
       <p>
        In this week we will look at a few exercises involving  risk mesures and allocating diversification benefits.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=demanding-florist">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1:-VaR-and-CVaR-using-historical-simulation">
        Problem 1: VaR and CVaR using historical simulation
        <a class="anchor-link" href="#Problem-1:-VaR-and-CVaR-using-historical-simulation">
         ¶
        </a>
       </h2>
       <p>
        A common approach to estimate $\text{VaR}$ and $\text{CVaR}$ is simply to use or simulate from the empirical distribution function. Some are strong proponents of this method since it does not require distributional assumptions about returns, but one need to be carefull since one will often make an independence assumption and sometimes a particular model assumption may give more robust results. Blindly using the empirical distribution may limit the attention to tail events.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Obtain the value weighted monthly return data for the five Fama-French industry portfolios ("5_Industry_Portfolios") using
        <code>
         pandas-datareader
        </code>
        since 1990-01-01  and transform the value weighted monthly return data into log returns.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Resample 10,000 vectors of returns from the monthly log returns calculated above. Use e.g.
        <code>
         np.random.randint
        </code>
        or
        <code>
         np.random.choice
        </code>
        (with
        <code>
         replace=True
        </code>
        ). Plot the histogram of an equally weighted portfolio (linear returns). Calculate the 5% $\text{VaR}$ and $\text{CVaR}$ of an equally weighted portfolio (linear returns) using the resampled / simulated data.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Resample 10,000 x 12 vectors of returns from the monthly log returns calculate above such to you are able to calculate the yearly portfolio return. Use e.g.
        <code>
         np.random.randint
        </code>
        . Plot the histogram of an equally weighted portfolio (yearly, linear returns). Calculate the 5% $\text{VaR}$ and $\text{CVaR}$ of an equally weighted portfolio (linear returns) using the resampled / simulated data.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Based on the portfolio returns found in question 3, use the Cornish-Fisher approximation to calculate the 5% $\text{VaR}$ of the yearly portfolio return. Note the function
        <code>
         calculate_cornish_fisher_percentile
        </code>
        in
        <code>
         codelib.statistics
        </code>
        .
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=promising-clause">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># import pandas_datareader as pdr</span>
<span class="c1"># from pandas_datareader.famafrench import FamaFrenchReader, get_available_datasets</span>

<span class="n">reader</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s2">"5_Industry_Portfolios"</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">industry_port_daily</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># print description</span>
<span class="n">industry_port_daily</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>

<span class="c1"># get value weighted</span>
<span class="n">ind_eq_weighted</span> <span class="o">=</span> <span class="n">industry_port_daily</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># get log returns</span>
<span class="n">eq_log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log1p</span><span class="p">(</span><span class="n">ind_eq_weighted</span> <span class="o">/</span> <span class="mf">100.0</span><span class="p">)</span>
<span class="n">eq_log_returns</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=marine-nepal">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">eq_log_returns</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hispanic-kitty">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=educated-joseph">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define resampling function </span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">resample</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">num_per</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Resample input data</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data: </span>
<span class="sd">        Data matrix, time x assets</span>
<span class="sd">    num_sim: </span>
<span class="sd">        Number of simulations. </span>
<span class="sd">    num_per: </span>
<span class="sd">        Number of periods. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Ressampled data, (num_sim, num_per, number of assets)</span>

<span class="sd">    """</span>
    <span class="c1"># number of assets</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="c1"># get index for selecting data</span>
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_per</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="p">:]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=accurate-classification">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate one month log-returns and transform to port. returns</span>
<span class="sd">"""</span>
<span class="n">port_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">num_per</span> <span class="o">=</span> <span class="mi">1</span>

<span class="c1"># resample historical log-returns</span>
<span class="n">sim_log_returns</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">eq_log_returns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                           <span class="n">num_sim</span><span class="o">=</span><span class="n">num_sim</span><span class="p">,</span>
                           <span class="n">num_per</span><span class="o">=</span><span class="n">num_per</span><span class="p">)</span>

<span class="c1"># convert log-returns to linear returns</span>
<span class="n">sim_lin_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sim_log_returns</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>

<span class="c1"># simulate portfolio linear returns</span>
<span class="n">sim_port_returns</span> <span class="o">=</span> <span class="n">sim_lin_returns</span> <span class="o">@</span> <span class="n">port_w</span>

<span class="c1"># note that for the one period case, you will obtain the same results by using </span>
<span class="c1"># sim_port_returns = resample(ind_eq_weighted / 100.0, num_sim=num_sim, num_per=num_per)</span>

<span class="sd">"""</span>
<span class="sd">Calculate VaR and CVaR</span>
<span class="sd">"""</span>

<span class="c1"># calculate (neg.) Value-at-Risk</span>
<span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>  <span class="c1"># &amp;lt;- note that the value-at-risk (and cond. value-at-risk) will depend on the method used for finding the percentile</span>
<span class="c1"># calculate the (neg.) conditional Value-at-Risk</span>
<span class="n">cond_value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">[</span><span class="n">sim_port_returns</span>
                                              <span class="o">&amp;lt;=</span> <span class="n">value_at_risk</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=oriented-anatomy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot histogram </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">value_at_risk</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cond_value_at_risk</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Value-at-Risk and Cond. Value-at-Risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$v_{t + </span><span class="se">\\</span><span class="s1">tau}$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density, $f_{V_{t + </span><span class="se">\\</span><span class="s1">tau}}(v_{t + </span><span class="se">\\</span><span class="s1">tau})$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>

<span class="c1"># add text</span>
<span class="n">text_to_add</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{VaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">value_at_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">value_at_risk</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">text_to_add</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">);</span>

<span class="n">text_to_add_2</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{CVaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">cond_value_at_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cond_value_at_risk</span> <span class="o">-</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">text_to_add_2</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">);</span>

<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=stable-fifty">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=solved-coach">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate 12 month log-returns and transform to port. returns</span>
<span class="sd">"""</span>
<span class="n">port_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">num_per</span> <span class="o">=</span> <span class="mi">12</span>

<span class="c1"># resample historical log-returns</span>
<span class="n">sim_log_returns</span> <span class="o">=</span> <span class="n">resample</span><span class="p">(</span><span class="n">eq_log_returns</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">num_sim</span><span class="o">=</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_per</span><span class="o">=</span><span class="n">num_per</span><span class="p">)</span>

<span class="c1"># convert log-returns to linear returns</span>
<span class="n">sim_lin_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sim_log_returns</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">-</span> <span class="mf">1.0</span>

<span class="c1">#simulate portfolio linear returns</span>
<span class="n">sim_port_returns</span> <span class="o">=</span> <span class="n">sim_lin_returns</span> <span class="o">@</span> <span class="n">port_w</span>

<span class="sd">"""</span>
<span class="sd">Calculate VaR and CVaR</span>
<span class="sd">"""</span>

<span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">cond_value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">[</span><span class="n">sim_port_returns</span> <span class="o">&amp;lt;=</span> <span class="n">value_at_risk</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2c67e82c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sim_log_returns</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=useful-incident">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot histogram </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">value_at_risk</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cond_value_at_risk</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Value-at-Risk and Cond. Value-at-Risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$v_{t + </span><span class="se">\\</span><span class="s1">tau}$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density, $f_{V_{t + </span><span class="se">\\</span><span class="s1">tau}}(v_{t + </span><span class="se">\\</span><span class="s1">tau})$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>

<span class="c1"># add text</span>
<span class="n">text_to_add</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{VaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">value_at_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">value_at_risk</span> <span class="o">+</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">text_to_add</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">);</span>

<span class="n">text_to_add_2</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{CVaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">cond_value_at_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">cond_value_at_risk</span> <span class="o">-</span> <span class="mf">0.055</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="n">text_to_add_2</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">);</span>

<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=under-badge">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=encouraging-invasion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">est_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">)</span>
<span class="n">est_sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">)</span>
<span class="n">est_skew</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skew</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">)</span>
<span class="n">est_kurt</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">kurtosis</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">)</span>

<span class="n">cf_var</span> <span class="o">=</span> <span class="n">calculate_cornish_fisher_percentile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">est_mean</span><span class="p">,</span> <span class="n">est_sigma</span><span class="p">,</span> <span class="n">est_skew</span><span class="p">,</span> <span class="n">est_kurt</span><span class="p">)</span>
<span class="n">cf_var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=alleged-cemetery">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:-Maximum-drawdown">
        Problem 2: Maximum drawdown
        <a class="anchor-link" href="#Problem-2:-Maximum-drawdown">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://en.wikipedia.org/wiki/Drawdown_(economics)">
         Drawdown
        </a>
        is a measure of the decline from a historical peak. The drawdown at time $T$ from the starting time $0$ can be defined as (we are using linear returns, but it could also be the loss itself)
       </p>
       $$
DD(T) = \min \left[ \frac{P_T - \max_{t \in (0, T)} P_t}{\max_{t \in (0, T)} P_t}, 0\right]
$$
       <p>
        The maximum drawdown (the most negative return) is
       </p>
       $$
MDD(T) = \min_{t \in (0, T)} \left[ \frac{P_T - \max_{t \in (0, T)} P_t}{\max_{t \in (0, T)} P_t}, 0\right]
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Implement two functions that calculate respectively the drawdown and maximum drawdown. Let the drawdown function return the drawdown at each point in time.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Plot the drawdown of SP500 since 1990-01-01 (hint: use
        <code>
         yfinance
        </code>
        , ticker: '^GSPC'). What is the maximum draw down?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=solid-ontario">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">drawdown</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the running draw down </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    index: </span>
<span class="sd">        Values of e.g. at equity index</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple(np.ndarray, np.ndarray)</span>
<span class="sd">        Drawdown, index of running maximum</span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="n">indexmax</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">cummax</span><span class="p">()</span>
    <span class="n">drawdowns</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">-</span> <span class="n">indexmax</span><span class="p">)</span> <span class="o">/</span> <span class="n">indexmax</span>
    
    <span class="k">return</span> <span class="n">drawdowns</span><span class="p">,</span> <span class="n">indexmax</span>
    
<span class="k">def</span> <span class="nf">maxdrawdown</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates maximum draw down </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    index: </span>
<span class="sd">        Values of e.g. at equity index</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Maximum drawdown</span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="k">return</span> <span class="n">drawdown</span><span class="p">(</span><span class="n">index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=intensive-norman">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=thousand-apache">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sp500_adjclose</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'^GSPC'</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1990</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))[</span><span class="s1">'Adj Close'</span><span class="p">]</span>
<span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">sp500_adjclose</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">),</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">"Index level"</span><span class="p">);</span> <span class="c1">#&amp;lt;- log value!</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=welcome-means">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plotting drawdown plot</span>
<span class="sd">"""</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">drawdown</span><span class="p">(</span><span class="n">sp500_adjclose</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Investing in the stock market may be dangerous!'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Drawdown'</span><span class="p">)</span>

<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dietary-celebration">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">maxdrawdown</span><span class="p">(</span><span class="n">sp500_adjclose</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=pointed-strand">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3:-Portfolio-diversification">
        Problem 3: Portfolio diversification
        <a class="anchor-link" href="#Problem-3:-Portfolio-diversification">
         ¶
        </a>
       </h2>
       <p>
        Assume that an investor has a quadratic utility function
       </p>
       $$
U(\mathbf{w}) = \mathbf{w}^\top \boldsymbol{\mu} - \frac{\lambda}{2} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        where $\mathbf{w}$ is the portfolio weights, $\boldsymbol{\mu}$ is a vector of expected returns, and $\boldsymbol{\Sigma}$ denotes the covariance matrix.
       </p>
       <p>
        The investor seeks to maximize the utility given the constraint that the portfolio weights sum to one
       </p>
       $$
\mathbf{1}^\top \mathbf{w} = 1
$$
       <p>
        The solution to this optimization problem is given by (see e.g.
        <a href="https://www.amazon.com/Portfolio-Management-under-Stress-Bayesian-Net/dp/1107048117">
         Rebonato and Denev, "Portfolio Management under stress"
        </a>
        )
       </p>
       $$
\mathbf{w}^* = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu} - \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \mathbf{A}^\top \mathbf{C}^{-1} \left(\mathbf{A}\boldsymbol{\Sigma}^{-1}\boldsymbol{\mu}  - \lambda \mathbf{b} \right)
$$
       <p>
        with $\mathbf{A} = \mathbf{1}^\top$, $\mathbf{b} = 1$, and $\mathbf{C} = \mathbf{A} \boldsymbol{\Sigma}^{-1}\mathbf{A}^\top$. Note that this solution is valid for more general constraints of the form $\mathbf{A}^\top \mathbf{w} = \mathbf{b}$.
       </p>
       <p>
        We assume that
       </p>
       $$
\boldsymbol{\mu}  = \begin{bmatrix} 0.02 \\ 0.04 \\ 0.08 \end{bmatrix}, \; \mathbf{v} = \begin{bmatrix} 0.075 \\ 0.15 \\ 0.3 \end{bmatrix}, \; \textbf{Corr} = \begin{bmatrix} 1.0 &amp;amp; 0.2 &amp;amp; 0.1 \\
                     0.2 &amp;amp; 1.0 &amp;amp; 0.4 \\
                     0.1 &amp;amp; 0.4 &amp;amp; 1.0 \end{bmatrix}
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Calculate the covariance matrix. One possibility is to use the trick
       </p>
       $$
\boldsymbol{\Sigma} = \mathbf{v} \mathbf{v}^\top \odot \textbf{Corr}
$$
       <p>
        where $\mathbf{v} \mathbf{v}^\top$ is the outer product and $\odot$ denotes the element-by-element product (Hadamard product).
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Define a function that calculates the optimal weights. The function should take three inputs: expected value, covariance matrix and risk aversion.
       </p>
       <p>
        Calculate the optimal weights when $\lambda = 5$.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Define a function that calculates the relative risk contributions. The function should take two inputs: portfolio weights and the covariance matrix. Calculate the relative risk contribution using the optimal weights from question 2.
       </p>
       <p>
        Note that we in the lectures defined the risk contribution as
       </p>
       $$
\text{RC}_i(\mathbf{w}) = w_i \frac{\partial \sigma_P(\mathbf{w}) }{\partial w_i} = w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
       <p>
        Dividing with the portfolio standard deviation gives us the relative risk contribution
       </p>
       $$
\text{RRC}_i(\mathbf{w}) =  w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} \frac{1}{\sqrt{ \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Calculate the optimal weights and the corresponding relative risk contribution for 100 values of the risk aversion parameter in the interval $\lambda \in [1.2, 20.0]$?
       </p>
       <p>
        Note that one could make a for loop that for each value of the risk aversion parameter in
        <code>
         risk_aversions
        </code>
        created using
        <code>
         np.linspace(1.2, 20.0, 100)
        </code>
        calculates the optimal weights and relative risk contribution and store them in
        <code>
         optimal_weights = np.zeros((3, len(risk_aversions)))
        </code>
        and
        <code>
         rel_risk_contribs = np.zeros((3, len(risk_aversions)))
        </code>
        .
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        Use a
        <a href="https://matplotlib.org/stable/gallery/lines_bars_and_markers/stackplot_demo.html">
         stackplot
        </a>
        to plot the optimal weights and the relative risk contributions for each value of $\lambda$ (two different plots). The code should look something like when plotting the optimal weights
       </p>
       <div class="highlight">
        <pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">risk_aversions</span><span class="p">,</span> <span class="n">optimal_weights</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'Asset 1'</span><span class="p">,</span> <span class="s1">'Asset 2'</span><span class="p">,</span> <span class="s1">'Asset 3'</span><span class="p">]);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">lambda$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$w$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Optimal weights'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper left'</span><span class="p">)</span>
</pre>
       </div>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=narrative-moses">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">])</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span> <span class="o">*</span> <span class="n">corr_mat</span>
<span class="n">cov_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fuzzy-campbell">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=alpha-budget">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define quadratic utility function </span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">quadratic_utility</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="nb">float</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that returns the quadratic utility of a given allocation</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: </span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    mu: </span>
<span class="sd">        Expected returns</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    risk_aversion: </span>
<span class="sd">        Risk aversion parameter</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Utility</span>
<span class="sd">    """</span>
    <span class="k">return</span> <span class="n">weights</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">weights</span> <span class="o">@</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span>

<span class="sd">"""</span>
<span class="sd">Define optimal weights function</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates optimal port. weights</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu: </span>
<span class="sd">        Expected returns</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    risk_aversion: </span>
<span class="sd">        Risk aversion parameter</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Optimal portfolio weights</span>
<span class="sd">    """</span>
    <span class="n">sigma_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">A</span> <span class="o">@</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">A</span>
    <span class="n">C_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">C</span>
    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>
    
    <span class="n">first_part</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">mu</span> 
    <span class="n">second_part</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">A</span> <span class="o">*</span> <span class="n">C_inv</span> <span class="o">*</span> <span class="p">(</span><span class="n">A</span> <span class="o">@</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">risk_aversion</span> <span class="o">*</span> <span class="n">b</span><span class="p">)</span>
    
    <span class="n">opt_weights</span> <span class="o">=</span> <span class="n">first_part</span> <span class="o">-</span> <span class="n">second_part</span>
    
    <span class="k">return</span> <span class="n">opt_weights</span>

<span class="k">def</span> <span class="nf">calculate_optimal_weights_alternative</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates optimal port. weights</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu: </span>
<span class="sd">        Expected returns</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    risk_aversion: </span>
<span class="sd">        Risk aversion parameter</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Optimal portfolio weights</span>
<span class="sd">    """</span>
    
    <span class="n">ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">sigma_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_matrix</span><span class="p">)</span>
    
    <span class="n">a</span> <span class="o">=</span> <span class="n">ones</span> <span class="o">@</span>  <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">mu</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">ones</span> <span class="o">@</span>  <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">ones</span>
    
    <span class="n">r_inv</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">risk_aversion</span>
    
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">a</span> <span class="o">/</span> <span class="n">b</span> <span class="o">-</span> <span class="n">risk_aversion</span> <span class="o">/</span> <span class="n">b</span> 
    
    <span class="n">opt_weights</span> <span class="o">=</span> <span class="n">r_inv</span> <span class="o">*</span> <span class="n">sigma_inv</span> <span class="nd">@mu</span> <span class="o">-</span> <span class="n">r_inv</span> <span class="o">*</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">sigma_inv</span> <span class="o">@</span> <span class="n">ones</span>
    
    <span class="k">return</span> <span class="n">opt_weights</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=central-market">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_aversion</span> <span class="o">=</span> <span class="mi">5</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"optimal weights: "</span><span class="p">)</span>
<span class="n">w_opt</span> <span class="o">=</span> <span class="n">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">)</span>
<span class="n">w_opt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=interesting-jungle">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ready-inflation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_marginal_risks_std</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates marginal risk</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: </span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>
    
    <span class="n">total_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span> <span class="o">@</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span>
    <span class="n">inner_derivative</span> <span class="o">=</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span>
    
    <span class="k">return</span> <span class="n">inner_derivative</span> <span class="o">/</span> <span class="n">total_risk</span>

<span class="k">def</span> <span class="nf">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">scale</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates risk contributions</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights: </span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>
    
    <span class="n">mr</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_std</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">scale</span><span class="p">:</span> 
        <span class="n">mr</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">weights</span> <span class="o">@</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">weights</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">mr</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=worth-jacket">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">"relative risk contribution: "</span><span class="p">)</span>
<span class="n">rel_risk_contrib</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">w_opt</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">rel_risk_contrib</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=latin-frederick">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sunset-brazil">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_aversions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.2</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">optimal_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">risk_aversions</span><span class="p">)))</span>
<span class="n">rel_risk_contribs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">risk_aversions</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">risk_aversion</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">risk_aversions</span><span class="p">):</span>
    <span class="n">optimal_weights</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_optimal_weights</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">risk_aversion</span><span class="p">)</span>
    <span class="n">rel_risk_contribs</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">optimal_weights</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=former-paint">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=amino-costs">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Optimal weights</span>
<span class="sd">"""</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">risk_aversions</span><span class="p">,</span> <span class="n">optimal_weights</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'Asset 1'</span><span class="p">,</span> <span class="s1">'Asset 2'</span><span class="p">,</span> <span class="s1">'Asset 3'</span><span class="p">]);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">lambda$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$w$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Optimal weights'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper left'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=viral-fence">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 6
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=encouraging-going">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Optimal weights</span>
<span class="sd">"""</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">risk_aversions</span><span class="p">,</span> <span class="n">rel_risk_contribs</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'Asset 1'</span><span class="p">,</span> <span class="s1">'Asset 2'</span><span class="p">,</span> <span class="s1">'Asset 3'</span><span class="p">]);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">lambda$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$RRC_i$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Relative risk contribution'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper left'</span><span class="p">);</span>
 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=cubic-cologne">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The analysis shows us that looking only at portfolio weights may be misleading when trying to understand the risk drivers of the portfolio.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=virgin-western">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Check-formula">
        Check formula
        <a class="anchor-link" href="#Check-formula">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fifteen-young">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">objective</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="o">-</span><span class="n">quadratic_utility</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>

<span class="n">sum_to_on_constraint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span> <span class="s1">'fun'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="o">/</span><span class="mf">3.0</span><span class="p">],</span> <span class="n">constraints</span><span class="o">=</span><span class="n">sum_to_on_constraint</span><span class="p">)</span>
<span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=impressed-fancy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4:-Allocating-diversification-benefits-for-VaR-and-CVaR">
        Problem 4: Allocating diversification benefits for VaR and CVaR
        <a class="anchor-link" href="#Problem-4:-Allocating-diversification-benefits-for-VaR-and-CVaR">
         ¶
        </a>
       </h2>
       <p>
        In this problem, we will learn how to perform risk decompostion if we for simplicity assume that the linear returns follow a normal distribution.
       </p>
       <p>
        As in problem 3, assume that
       </p>
       $$
\boldsymbol{\mu}  = \begin{bmatrix} 0.02 \\ 0.04 \\ 0.08 \end{bmatrix}, \; \mathbf{v} = \begin{bmatrix} 0.075 \\ 0.15 \\ 0.3 \end{bmatrix}, \; \textbf{Corr} = \begin{bmatrix} 1.0 &amp;amp; 0.2 &amp;amp; 0.1 \\
                     0.2 &amp;amp; 1.0 &amp;amp; 0.4 \\
                     0.1 &amp;amp; 0.4 &amp;amp; 1.0 \end{bmatrix}
$$
       <p>
        and add the assumption that the returns follow a multivariate normal distribution
       </p>
       $$
\mathbf{R} \sim \text{MVN}(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        where $\boldsymbol{\Sigma}$ is the covariance matrix. We know that we can write the portfolio mean as ($\mathbf{w}$ is the portfolio weights)
       </p>
       $$
\mu_P(\mathbf{w}) = \mathbf{w}^\top \boldsymbol{\mu}
$$
       <p>
        and the standard deviation as
       </p>
       $$
\sigma_P(\mathbf{w}) = \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}
$$
       <p>
        such that the portfolio return follows a normal distribution
       </p>
       $$
R_P = \mathbf{w}^\top \mathbf{R} \sim N(\mu_P(\mathbf{w}), \sigma_P^2(\mathbf{w}))
$$
       <p>
        Furthermore, consider an equally weighted portfolio.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Given our understanding of the normal distribution, we can calculate the VaR as
       </p>
       $$
\text{VaR}_{\alpha} (\mathbf{w}) = - \mu_P(\mathbf{w}) + \sigma_P(\mathbf{w}) \Phi^{-1}(1 - \alpha)
$$
       <p>
        where $\phi()$ and $\Phi^{-1}()$ denote the standard normal pdf and quantile function respectively.
       </p>
       <p>
        The CVaR is given by
       </p>
       $$
\text{CVaR}_{\alpha} = -\mu_P + \sigma_P \frac{\phi\left(\Phi^{-1}(\alpha) \right)}{\alpha}
$$
       <p>
        Calculate VaR(5%) and CVaR(5%) of an equally weighted portfolio using the normal assumption.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We can decompose the VaR using
       </p>
       $$
\text{VaR}_{\alpha}(\mathbf{w}) = \sum_{i=1}^N w_i \frac{\partial \text{VaR}_{\alpha}(\mathbf{w})}{\partial w_i}
$$
       <p>
        Find the marginal risk (use e.g. the chain-rule)
       </p>
       $$
\frac{\partial \text{VaR}_{\alpha}(\mathbf{w})}{\partial w_i},
$$
       <p>
        implement a function calculating the marginal risk and risk contribution, and calculate the values for an equally weighted portfolio.
       </p>
       <p>
        Is the VaR equal to the sum of the risk contributions?
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        We can decompose the CVaR using
       </p>
       $$
\text{CVaR}_{\alpha}(\mathbf{w}) = \sum_{i=1}^N w_i \frac{\partial \text{CVaR}_{\alpha}(\mathbf{w})}{\partial w_i}
$$
       <p>
        Find the marginal risk
       </p>
       $$
\frac{\partial \text{CVaR}_{\alpha}(\mathbf{w})}{\partial w_i},
$$
       <p>
        implement a function calculating the marginal risk and risk contribution, and calculate the values for an equally weighted portfolio.
       </p>
       <p>
        Is the CVaR equal to the sum of the risk contributions?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        We simply define functions that implement the above definitions. See
        <code>
         codelib.portfolio_optimization.risk_metrices
        </code>
        for the definition of the functions.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=strange-acceptance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">])</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span> <span class="o">*</span> <span class="n">corr_mat</span>
<span class="n">cov_mat</span>

<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=champion-trail">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">-</span><span class="n">calculate_normal_port_value_at_risk</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=listed-court">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">-</span><span class="n">calculate_normal_port_cond_value_at_risk</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=finnish-summit">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        First, we need to find
       </p>
       $$
\frac{\partial \text{VaR}_{\alpha}(\mathbf{w})}{\partial w_i} 
$$
       <p>
        We can simply use the chain-rule and that (what we have seen at the lectures)
       </p>
       $$
\nabla \sigma_P(\mathbf{w}) = \frac{d \sigma_P(\mathbf{w}) }{d \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}\frac{\partial \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}{\partial \mathbf{w}} = \frac{1}{2\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} 2 \boldsymbol{\Sigma} \mathbf{w} = \frac{\boldsymbol{\Sigma} \mathbf{w} }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
       <p>
        We find
       </p>
       $$
\nabla \text{VaR}_{\alpha} = -\boldsymbol{\mu} +  \Phi^{-1}(1 - \alpha) \nabla \sigma_P(\mathbf{w}) = -\boldsymbol{\mu} +  \Phi^{-1}(1 - \alpha)  \frac{\boldsymbol{\Sigma} \mathbf{w} }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
       <p>
        Thus,
       </p>
       $$
\frac{\partial \text{VaR}_{\alpha}(\mathbf{w})}{\partial w_i} = -\mu_i +  \Phi^{-1}(1 - \alpha)  \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=introductory-waste">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_marginal_risks_normal_var</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates marginal risk using Value-at-Risk as risk measure.</span>
<span class="sd">    It is assumed that returns follow a normal distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights:</span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    mu:</span>
<span class="sd">        Vector of expected returns</span>
<span class="sd">    cov_mat:</span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    alpha:</span>
<span class="sd">        Confidence level</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>

    <span class="n">mr_std</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_std</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="n">mr_var</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu</span> <span class="o">+</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">mr_std</span>
    
    <span class="k">return</span> <span class="n">mr_var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=earned-therapy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_risk_contributions_normal_var</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates marginal risk using Value-at-Risk as risk measure.</span>
<span class="sd">    It is assumed that returns follow a normal distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights:</span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    mu:</span>
<span class="sd">        Vector of expected returns</span>
<span class="sd">    cov_mat:</span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    alpha:</span>
<span class="sd">        Confidence level</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>

    <span class="n">mr</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_normal_var</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">mr</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=prescribed-canvas">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mr_var</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_normal_var</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">mr_var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=incorporate-detection">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mrc_var</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_normal_var</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">mrc_var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=apart-longer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mrc_var</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=colonial-baseline">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We see that the sum of marginal risk contributions are equal to VaR.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=professional-affect">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        We need to find
       </p>
       $$
\frac{\partial \text{CVaR}_{\alpha}(\mathbf{w})}{\partial w_i} 
$$
       <p>
        We follow the same approach as before
       </p>
       $$
\nabla \text{CVaR}_{\alpha} = -\boldsymbol{\mu} +  \frac{\phi\left(\Phi^{-1}(\alpha) \right)}{\alpha} \nabla \sigma_P(\mathbf{w}) = -\boldsymbol{\mu} +  \frac{\phi\left(\Phi^{-1}(\alpha) \right)}{\alpha} \frac{\boldsymbol{\Sigma} \mathbf{w} }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
       <p>
        Thus,
       </p>
       $$
\frac{\partial \text{CVaR}_{\alpha}(\mathbf{w})}{\partial w_i} = -\mu_i +  \frac{\phi\left(\Phi^{-1}(\alpha) \right)}{\alpha} \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=changed-librarian">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_marginal_risks_normal_cvar</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates marginal risk using Cond. Value-at-Risk as risk measure.</span>
<span class="sd">    It is assumed that returns follow a normal distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights:</span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    mu:</span>
<span class="sd">        Vector of expected returns</span>
<span class="sd">    cov_mat:</span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    alpha:</span>
<span class="sd">        Confidence level</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>

    <span class="n">mr_std</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_std</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="n">qnorm</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    
    <span class="n">mr_cvar</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu</span> <span class="o">+</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">qnorm</span><span class="p">)</span> <span class="o">/</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">mr_std</span>
    
    <span class="k">return</span> <span class="n">mr_cvar</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=surgical-assistant">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_risk_contributions_normal_cvar</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates marginal risk using Cond. Value-at-Risk as risk measure.</span>
<span class="sd">    It is assumed that returns follow a normal distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights:</span>
<span class="sd">        Portfolio weights</span>
<span class="sd">    mu:</span>
<span class="sd">        Vector of expected returns</span>
<span class="sd">    cov_mat:</span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    alpha:</span>
<span class="sd">        Confidence level</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>

    <span class="n">mr</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_normal_cvar</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">weights</span> <span class="o">*</span> <span class="n">mr</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=large-default">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mr_cvar</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_normal_cvar</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">mr_cvar</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=compatible-bundle">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mrc_cvar</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_normal_cvar</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">mrc_cvar</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=korean-balance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mrc_cvar</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=logical-secondary">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We see that the sum of marginal risk contributions are equal to CVaR.
       </p>
       <p>
        It is important to note that given the Gaussian assumption, the relative risk contribution is determined primarily by the risk contribution obtained using standard devation as a risk measure (assuming $\boldsymbol{\mu}$ close to zero). Thus, one would expect to obtain similar results using either risk measure.
       </p>
       <p>
        Another important fact is that even if we can scale the standard deviation with square root of time, this will not be the case for the VaR and CVaR.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=chief-destination">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-5:-Scenario-based-risk-measures">
        Problem 5: Scenario based risk measures
        <a class="anchor-link" href="#Problem-5:-Scenario-based-risk-measures">
         ¶
        </a>
       </h2>
       <p>
        In many applications, we use scenarios either historical or Monte Carlo to calculate risk measures of a portfolio. In this exercise, we will see how we can allocate risk when a simulation based approach is taken.
       </p>
       <p>
        Again, we consider
       </p>
       $$
\boldsymbol{\mu}  = \begin{bmatrix} 0.02 \\ 0.04 \\ 0.08 \end{bmatrix}, \; \mathbf{v} = \begin{bmatrix} 0.075 \\ 0.15 \\ 0.3 \end{bmatrix}, \; \textbf{Corr} = \begin{bmatrix} 1.0 &amp;amp; 0.2 &amp;amp; 0.1 \\
                     0.2 &amp;amp; 1.0 &amp;amp; 0.4 \\
                     0.1 &amp;amp; 0.4 &amp;amp; 1.0 \end{bmatrix}
$$
       <p>
        and add the assumption that the returns follow a multivariate normal distribution
       </p>
       $$
\mathbf{R} \sim \text{MVN}(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Simulate 1000 observations for each asset. Calculate the portfolio return of an equally weighted portfolio and thereafter calculate the VaR and CVaR.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Repeat the above VaR and CVaR calculation 1000 times. Calculate the 95% confidence interval for CVaR and VaR based on the simulations.
       </p>
       <p>
        Also plot the histogram for all the estimated VaR and CVaR numbers.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Following e.g.
        <a href="https://pubsonline.informs.org/doi/abs/10.1287/educ.1080.0052">
         Sarykalin, Serraino, Uryasev (2014)
        </a>
        ,
we can decompose the Cond. Value at Risk of a portfolio $\mathbf{w}^\top \boldsymbol{X}$ as
       </p>
       $$
\text{CVaR}_{\boldsymbol{X}} = \sum_{i=1}^N \frac{\partial \text{CVaR}_{\boldsymbol{X}}}{\partial w_i} w_i
                                = \sum_{i=1}^N \text{E}[X_i \vert X \leq \text{VaR}_{\boldsymbol{X}}] w_i
$$
       <p>
        where $K$ is the number of assets in the portfolio.
       </p>
       <p>
        The marginal risk and marginal risk contribution are therefore for asset $i$ respectively given by
       </p>
       $$
\text{E}[X_i \vert X \leq \text{VaR}_{\boldsymbol{X}}]
$$
       <p>
        and
       </p>
       $$
\text{E}[X_i \vert X \leq \text{VaR}_{\boldsymbol{X}}] w_i
$$
       <p>
        Define functions which implement the formula for marginal risk and marginal risk contribution.
       </p>
       <p>
        Again, simulate 10000 observations for each asset (or reuse an old simulation). Perform a risk decomposition of an equally weighted portfolio with CVaR as risk measure based on the simulated sample.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        I have applied the functions
        <code>
         calculate_value_at_risk
        </code>
        and
        <code>
         calculate_conditional_value_at_risk
        </code>
        from
        <code>
         codelib.portfolio_optimization.risk_metrics
        </code>
        which will give slightly different results than when using
        <code>
         np.percentile
        </code>
        directly to calculate VaR due to the interpolation method used.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=colonial-apparatus">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">])</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.075</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">])</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span> <span class="o">*</span> <span class="n">corr_mat</span>
<span class="n">cov_mat</span>

<span class="c1"># port. weights</span>
<span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>

<span class="c1"># number of simulations </span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">1000</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=legitimate-batch">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># simulate asset returns</span>
<span class="n">sim_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="c1"># calculate portfolio returns for each simulation</span>
<span class="n">sim_port_returns</span> <span class="o">=</span> <span class="n">sim_returns</span> <span class="o">@</span> <span class="n">weights</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=adaptive-creation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate VaR and CVaR</span>
<span class="n">sim_var</span> <span class="o">=</span> <span class="n">calculate_value_at_risk</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">sim_cvar</span> <span class="o">=</span> <span class="n">calculate_conditional_value_at_risk</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=thick-shelter">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot histogram </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">);</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">sim_var</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">sim_cvar</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Value-at-Risk and Cond. Value-at-Risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$R_P$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density, $f_</span><span class="si">{R_P}</span><span class="s1">$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>

<span class="c1"># add text</span>
<span class="n">text_to_add</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{VaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">sim_var</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.202</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">text_to_add</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">);</span>

<span class="n">text_to_add_2</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{CVaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">sim_cvar</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.254</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">text_to_add_2</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">);</span>

<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=radical-hopkins">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=tropical-capture">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">num_iter</span> <span class="o">=</span> <span class="mi">10_000</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">1000</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=running-shelf">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># simulate asset returns</span>
<span class="n">sim_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_iter</span><span class="p">))</span>

<span class="c1"># calculate portfolio returns for each simulation</span>
<span class="n">sim_port_returns</span> <span class="o">=</span> <span class="n">sim_returns</span> <span class="o">@</span> <span class="n">weights</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=aggressive-folks">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># Calculate VaR for all num_iter samples of num_sim observations</span>
<span class="n">sim_var_all</span> <span class="o">=</span> <span class="n">calculate_value_at_risk</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># Calculate CVaR for all num_iter samples of num_sim observations</span>
<span class="n">sim_cvar_all</span> <span class="o">=</span> <span class="n">calculate_conditional_value_at_risk</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=empty-syndicate">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># shape of numpy array with all VaR estimates</span>
<span class="n">sim_var_all</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=future-eugene">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot histogram </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="o">-</span><span class="n">sim_var_all</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Value-at-Risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'VaR(5%)'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>


<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=driven-drain">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate the percentiles</span>
<span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="o">-</span><span class="n">sim_var_all</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=rubber-advocacy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot histogram </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="o">-</span><span class="n">sim_cvar_all</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Cond. Value-at-Risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'CVaR(5%)'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>


<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=looking-instrument">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [48]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate the percentiles</span>
<span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="o">-</span><span class="n">sim_cvar_all</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=dying-spread">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        The functions
        <code>
         calculate_marginal_risks_cvar
        </code>
        and
        <code>
         calculate_risk_contributions_cvar
        </code>
        from
        <code>
         codelib.portfolio_optimization.risk_budget
        </code>
        implement the formulas.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=automated-paris">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [49]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># simulate asset returns</span>
<span class="n">sim_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="c1"># calculate portfolio returns for each simulation</span>
<span class="n">sim_port_returns</span> <span class="o">=</span> <span class="n">sim_returns</span> <span class="o">@</span> <span class="n">weights</span> 

<span class="c1"># cvar</span>
<span class="n">cvar</span> <span class="o">=</span> <span class="n">calculate_conditional_value_at_risk</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="o">-</span><span class="n">cvar</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=involved-punishment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [50]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># marginal risks</span>
<span class="n">mr</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_cvar</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">sim_returns</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="o">-</span><span class="n">mr</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=visible-sellers">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [51]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># marginal risk contributions</span>
<span class="n">mrc</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_cvar</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">sim_returns</span><span class="p">,</span> <span class="n">p</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
<span class="o">-</span><span class="n">mrc</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cellular-minimum">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [52]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># equal to cvar!</span>
<span class="o">-</span><span class="n">mrc</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=general-outdoors">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://pubsonline.informs.org/doi/abs/10.1287/educ.1080.0052">
         Sarykalin, Serraino, Uryasev (2014)
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.com/Portfolio-Management-under-Stress-Bayesian-Net/dp/1107048117">
         Riccardo Rebonato and Alexander Denev, "Portfolio Management under stress"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># plotting </span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mtick</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span><span class="p">,</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># working with time </span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>

<span class="c1"># pandas data reader for downloading data</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.data</span> <span class="kn">import</span> <span class="n">DataReader</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>

<span class="c1"># for typehints </span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="c1"># function for downloading yield data from FRED </span>
<span class="kn">from</span> <span class="nn">codelib.dal.fred_yield_data</span> <span class="kn">import</span> <span class="n">get_nominal_yield_data</span>

<span class="c1"># some tailormade plots </span>
<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">correlation_plot</span>

<span class="c1"># Default plotting layout</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-5">
        Exercises - Week 5
        <a class="anchor-link" href="#Exercises---Week-5">
         ¶
        </a>
       </h1>
       <p>
        In this week we will look at a few exercises involving minimization and maximization.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=powerful-picture">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1:-Second-order-conditions">
        Problem 1: Second order conditions
        <a class="anchor-link" href="#Problem-1:-Second-order-conditions">
         ¶
        </a>
       </h2>
       <p>
        In this problem, we will look at the
        <a href="https://en.wikipedia.org/wiki/Second_partial_derivative_test">
         second derivative test
        </a>
        for determining whether a critical point is a local minimum or maximum.
       </p>
       <p>
        Consider the function
       </p>
       $$
f(x,y,z) = -x^2 - y^2 - z^2
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        What are the first order partial derivatives? Find the stationary/critical point. Also maximize the function using
        <code>
         scipy.optimize.minimize
        </code>
        .
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        What are the second order partial derivatives? Write up the Hessian.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        The properties of the Hessian matrix are important for determining whether the critical point / stationary point is a maximum, minimum or neither of the two.
       </p>
       <ul>
        <li>
         If the Hessian is negative definite, then the stationary point is a local maximum
        </li>
        <li>
         If the Hessian is positive definite, then the stationary point is a local minimum
        </li>
        <li>
         If the Hessian is indefinite, then the stationary point is a a saddle point
        </li>
       </ul>
       <p>
        Otherwise, the test is inconclusive.
       </p>
       <p>
        We need to remember that a
        <a href="https://en.wikipedia.org/wiki/Definite_matrix">
         definite matrix
        </a>
        can be defined in the following way. A  symmetric matrix, $\mathbf{A}$, is said to be positive definite if for every vector $\mathbf{v} \neq \mathbf{0}$
       </p>
       $$
\mathbf{v}^\top  \mathbf{A} \mathbf{v} &amp;gt; 0
$$
       <p>
        and negative definite if
       </p>
       $$
\mathbf{v}^\top  \mathbf{A} \mathbf{v} &amp;lt; 0
$$
       <p>
        For semi-definiteness replace $&amp;gt;$ and $&amp;lt;$ with respectively $\geq$ and $\leq$.
       </p>
       <p>
        Is the matrix negative definite?
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        For a symmetric, positive definite matrix then the above definition will be equivalnt to all the eigenvalues being positive. For a negative definite matrix then all the eigenvalues will be negative.
       </p>
       <p>
        Find the eigenvalues (use e.g.
        <code>
         numpy.linalg.eigvals
        </code>
        ).
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        Will the stationary point be a minimum or maximum?
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        Assume now that $f(x,y,z) = -x^2 + y^2 - z^2$. Will this function also have a maximum at $(x,y,z) = (0, 0, 0)$?
       </p>
       <p>
        <strong>
         Question 7
        </strong>
       </p>
       <p>
        Define a function that checks if a symmetric matrix is negative definite.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        The first order partial derivatives are given by
       </p>
       \begin{eqnarray}
f_x^\prime(x,y,z) &amp;amp;=&amp;amp; -2x \nonumber \\
f_y^\prime(x,y,z) &amp;amp;=&amp;amp; -2y \nonumber  \\
f_z^\prime(x,y,z) &amp;amp;=&amp;amp; -2z \nonumber  
\end{eqnarray}
       <p>
        The only solution to the three equations obtained by setting the partial derivatives equal to zero is $(x, y, z) = (0,0,0)$
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=hazardous-variety">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">func_prob1</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

<span class="c1"># remember that we want to maximize</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">func_prob1</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=constitutional-tongue">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        The second order partial derivatives are given by
       </p>
       \begin{eqnarray}
f_{xx}^{\prime\prime}(x,y,z) &amp;amp;=&amp;amp; -2 \nonumber \\
f_{yy}^{\prime\prime}(x,y,z) &amp;amp;=&amp;amp; -2 \nonumber  \\
f_{zz}^{\prime\prime}(x,y,z) &amp;amp;=&amp;amp; -2 \nonumber \\
f_{xy}^{\prime\prime}(x,y,z) &amp;amp;=&amp;amp; 0 \nonumber \\
f_{xz}^{\prime\prime}(x,y,z) &amp;amp;=&amp;amp; 0 \nonumber \\
f_{yz}^{\prime\prime}(x,y,z) &amp;amp;=&amp;amp; 0 \nonumber \\
\end{eqnarray}
       <p>
        The Hessian is therefore
$$
H(x,y,z) = \begin{bmatrix}
-2 &amp;amp; 0 &amp;amp; 0 \\
0 &amp;amp; -2 &amp;amp; 0 \\
0 &amp;amp; 0 &amp;amp; -2
\end{bmatrix}
$$
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        If the Hessian matrix is negative definite, then the quadratic form
       </p>
       $$
\mathbf{v}^\top \mathbf{H} \mathbf{v} = -2v_1^2 - 2v_2^2 -2 v_3^2
$$
       <p>
        should be negative for all $\mathbf{v} \neq \mathbf{0}$. Since $v_1^2, v_2^2, v_3^2$ always will be positive, then the quadratic form will always be negative.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        The eigenvalues will solve
       </p>
       $$
\det \left(\mathbf{H} - \lambda \mathbf{I} \right) = \det \begin{bmatrix}
-2 - \lambda &amp;amp; 0 &amp;amp; 0 \\
0 &amp;amp; -2  - \lambda &amp;amp; 0 \\
0 &amp;amp; 0 &amp;amp; -2 - \lambda
\end{bmatrix} = (-2 - \lambda)(-2 - \lambda)(-2 - \lambda) = 0
$$
       <p>
        Thus, all eigenvalues must be equal to $\lambda = -2$.
       </p>
       <p>
        This is in agreement with the results from the previous problem. Having all negative eigenvalues corresponds to the matrix under consideration being negative definite.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=loved-angel">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">hess_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span> <span class="o">*</span> <span class="o">-</span><span class="mi">2</span><span class="p">)</span>

<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">hess_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=golden-birmingham">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        The stationary point will be a (global) maximum since the Hessian is negative definite
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        Again, we will have
       </p>
       $$
\begin{eqnarray}
f_x^\prime(x,y,z) &amp;amp;=&amp;amp; -2x \nonumber \\
f_y^\prime(x,y,z) &amp;amp;=&amp;amp; 2y \nonumber  \\
f_z^\prime(x,y,z) &amp;amp;=&amp;amp; -2z  
\end{eqnarray}
$$
       <p>
        with a stationary point at $(x,y,z) = (0, 0, 0)$.
       </p>
       <p>
        The Hessian is 
$$
H(x,y,z) = \begin{bmatrix}
-2 &amp;amp; 0 &amp;amp; 0 \\
0 &amp;amp; 2 &amp;amp; 0 \\
0 &amp;amp; 0 &amp;amp; -2
\end{bmatrix}
$$
       </p>
       <p>
        which will have two eigenvalues equal to $-2$ and one eigenvalue equal to $2$. The Hessian will therefore be indefinite and the stationary point will be a saddle point.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=photographic-delta">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">hess_new_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">2</span><span class="p">])</span>

<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">hess_new_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=accredited-germany">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 7
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=weighted-samba">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">is_neg_def</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="nb">bool</span><span class="p">:</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span> <span class="o">&amp;lt;</span> <span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dense-acquisition">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">is_neg_def</span><span class="p">(</span><span class="n">hess_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=serious-affect">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">is_neg_def</span><span class="p">(</span><span class="n">hess_new_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=careful-monitor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:-Minimizing-distance">
        Problem 2: Minimizing distance
        <a class="anchor-link" href="#Problem-2:-Minimizing-distance">
         ¶
        </a>
       </h2>
       <p>
        Assume that Luke Skywalker is currently located at the point $A=(x,y,z)=(5, 5, 5)$ in his X-Wing Starfighter. He needs to gather critical information on the planet Endor before joining the rebel forces at the point $B=(x,y,z) = (6, 6, 6)$. The planet Endor is defined by the 3D ball
       </p>
       $$
x^2 + y^2 + z^2 = 1
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        What is the formula for the distance between the point $A$ and a arbitrary point on the surface of the planet $C$ and back to the point $B$? (
        <a href="https://en.wikipedia.org/wiki/Euclidean_distance">
         euclidian distance
        </a>
        or
        <a href="https://en.wikipedia.org/wiki/Norm_(mathematics))">
         euclidian norm
        </a>
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        What is the total distance when $C = (1, 0, 0)$?
       </p>
       <p>
        <strong>
         Quesiton 3
        </strong>
       </p>
       <p>
        We want to help Luke Skywalker to find the optimal place on Endor to retrieve the information. Set up the constrained minimization problem that Luke Skywalker is facing.
       </p>
       <p>
        <strong>
         Quesiton 4
        </strong>
       </p>
       <p>
        Solve the constrained minimization problem numerically.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Define $C=(x,y,z)$ to be an abitrary point on the planet. Then, we calcuclate the distance between $A$ and $C$ as
       </p>
       $$
\vert \vert C-A \vert \vert = \sqrt{(x-5)^2 + (y-5)^2 + (z-5)^2}
$$
       <p>
        and the distance between $C$ and $B$ as
       </p>
       $$
\vert \vert B-C \vert \vert = \sqrt{(6-x)^2 + (6-y)^2 + (6-z)^2}
$$
       <p>
        Thus, the total distance will be
       </p>
       $$
\vert \vert C-A \vert \vert + \vert \vert B-C \vert \vert  = \sqrt{(x-5)^2 + (y-5)^2 + (z-5)^2} + \sqrt{(6-x)^2 + (6-y)^2 + (6-z)^2}
$$
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=talented-youth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">distance_function</span><span class="p">(</span><span class="n">C</span><span class="p">):</span>
    
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">])</span>
    <span class="n">B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">6</span><span class="p">])</span>
    <span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">C</span><span class="p">)</span> 
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">C</span><span class="o">-</span><span class="n">A</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">B</span><span class="o">-</span><span class="n">C</span><span class="p">)</span>

<span class="n">distance_function</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=parallel-friendship">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       $$
\arg \min f(x,y,z) \; \text{ s.t. } x^2 + y^2 + z^2 = 1
$$
       <p>
        where
       </p>
       $$
f(x,y,z) = \vert \vert C-A \vert \vert + \vert \vert B-C \vert \vert 
$$
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=orange-necklace">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">constraint_ball</span><span class="p">(</span><span class="n">P</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">P</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">P</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">P</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">1.0</span>

<span class="n">constraint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span><span class="s1">'eq'</span><span class="p">,</span> <span class="s1">'fun'</span><span class="p">:</span> <span class="n">constraint_ball</span><span class="p">}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">distance_function</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraint</span><span class="p">)</span>
<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cathedral-iceland">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">distance_function</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=alternate-sellers">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">10</span><span class="p">),</span> <span class="n">dpi</span><span class="o">=</span><span class="mi">300</span><span class="p">)</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">)</span>

<span class="n">u</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>
<span class="n">v</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="mi">250</span><span class="p">)</span>

<span class="n">x</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="n">y</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">u</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>
<span class="n">z</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">size</span><span class="p">(</span><span class="n">u</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">v</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span>  <span class="n">rstride</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">cstride</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'b'</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">5</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mi">6</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="p">[</span><span class="mi">6</span><span class="p">,</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">)],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span><span class="mi">5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span><span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">25</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span><span class="mi">6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"green"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=demanding-florist">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3:-Calibration-of-the-Nelson-Siegel-Svensson-curve">
        Problem 3: Calibration of the Nelson-Siegel-Svensson curve
        <a class="anchor-link" href="#Problem-3:-Calibration-of-the-Nelson-Siegel-Svensson-curve">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Note
        </strong>
        : Exercise inspired somewhat by
        <a href="https://comisef.eu/files/wps031.pdf">
         M. Gilli, Stefan Große, E. Schumann (2010), "Calibrating the
Nelson–Siegel–Svensson model
"
        </a>
       </p>
       <p>
        <a href="https://www.federalreserve.gov/data/nominal-yield-curve.htm">
         FRED
        </a>
        provides nominal yield curve data interpolated using the Nelson-Siegel-Svensson specificiation. It is assumed that the instantaneous forward rates are given by
       </p>
       $$
f_t^T = \beta_0 + \beta_1 \exp \left(\frac{-(T-t)}{\tau_1}\right) + \beta_2 \frac{T-t}{\tau_1}\exp \left(\frac{-(T-t)}{\tau_1}\right) +  \beta_3 \frac{T-t}{\tau_2}\exp \left(\frac{-(T-t)}{\tau_2}\right)
$$
       <p>
        where $T-t$ is the time to maturity or tenor. The zero-coupon yield is then given by
       </p>
       $$
y_t^T = \frac{1}{T-t} \intop_t^T f_t^u du =  \beta_0 + \beta_1 \frac{1 - \exp\left(-\frac{T-t}{\tau_1} \right)}{\frac{T-t}{\tau_1}} + \beta_2 \left[ \frac{1 - \exp\left(-\frac{T-t}{\tau_1} \right)}{\frac{T-t}{\tau_1}}  - \exp\left(-\frac{T-t}{\tau_1} \right)\right] + \beta_3 \left[ \frac{1 - \exp\left(-\frac{T-t}{\tau_2} \right)}{\frac{T-t}{\tau_2}}  - \exp\left(-\frac{T-t}{\tau_2} \right)\right]
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Define two Python functions
        <code>
         calculate_slope
        </code>
        and
        <code>
         calculate_curve
        </code>
        as respectively
       </p>
       $$
\begin{align}
f_{slope}(T-t, \tau) &amp;amp;= \frac{1 - \exp\left(-\frac{T-t}{\tau} \right)}{\frac{T-t}{\tau}} \\
f_{curvature}(T-t, \tau) &amp;amp;= \left[ \frac{1 - \exp\left(-\frac{T-t}{\tau} \right)}{\frac{T-t}{\tau}}  - \exp\left(-\frac{T-t}{\tau} \right)\right]
\end{align}
$$
       <p>
        For $\tau = \tau_1$ from the FRED data set (use the date '2021-03-01') plot the level factor (just return one), the slope factor and the curvature factor for $T-t \in [0.001, 20.0]$.
       </p>
       <p>
        We should be able to see that the short rate is only governed by the first two factors (multiplied with the relevant $\beta$ coefficient). Other zero yields will be effected by the level factor and to some extent by the slope and the (two) curvature factors.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Define a function returning the zero yield for a given tenor. Plot the zero yields obtained using the function and the parameters for the date '2021-03-01' and the corresponding zero yields from the FRED data set.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        We assume for a moment that we only observe the zero coupon yields for the FRED data set (or we have forgotten the specific parameter values).  We therefore want to calibrate the parameters. A natural approach would be to use
        <a href="https://en.wikipedia.org/wiki/Non-linear_least_squares">
         non-linear least squares
        </a>
        . To that end we define the quadratic objective function which we want to minimize
       </p>
       $$
g(\mathbf{y}; \theta) = \sum_{i=1}^n (y_i^{obs} - y_i^{model}(\theta))^2
$$
       <p>
        where $\theta = (\beta_0, \beta_1, \beta_2, \beta_3, \tau_1, \tau_2)^\top$.
       </p>
       <p>
        Define the quadratic objective function in Python and try to optimize it multiple times (e.g. 500) using
        <code>
         scipy.optimize.minimize
        </code>
        . Starting values can be selected randomly from the intervals $\beta_0 \in [0.0, 15.0]$, $\beta_1 \in [-15.0, 30.0]$, $\beta_2\in [-30.0, 30.0]$, $\beta_3\in [-30.0, 30.0]$, $\tau_1 \in (0.0, 30.0]$ and $\tau_2 \in (0.0, 30.0]$. Plot a histogram of the obtained estimates.
       </p>
       <p>
        It should be obvious that we will not converge to the true solution for all starting values!
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        The problems with the optimization above is related to the objective function not being convex and exhibiting several local minima and the so-called
        <a href="https://en.wikipedia.org/wiki/Multicollinearity">
         collinearity
        </a>
        problem.
       </p>
       <p>
        For given values of $\tau_1$ and $\tau_2$, then the minimization problem reduces to a ordinary least squares problem. Thus, defining the regressor matrix
       </p>
       $$
\mathbf{X} = \begin{bmatrix} 1 &amp;amp; \frac{1 - \exp\left(-\frac{T_1-t}{\tau_1} \right)}{\frac{T_1-t}{\tau_1}} &amp;amp; \left[ \frac{1 - \exp\left(-\frac{T_1-t}{\tau_1} \right)}{\frac{T_1-t}{\tau_1}}  - \exp\left(-\frac{T_1-t}{\tau_1} \right)\right] &amp;amp; \left[ \frac{1 - \exp\left(-\frac{T_1-t}{\tau_2} \right)}{\frac{T_1-t}{\tau_2}}  - \exp\left(-\frac{T_1-t}{\tau_2} \right)\right] \\
\vdots &amp;amp; \vdots &amp;amp; \vdots &amp;amp; \vdots  \\
1 &amp;amp; \frac{1 - \exp\left(-\frac{T_n-t}{\tau_1} \right)}{\frac{T_n-t}{\tau_1}} &amp;amp; \left[ \frac{1 - \exp\left(-\frac{T_n-t}{\tau_1} \right)}{\frac{T_n-t}{\tau_1}}  - \exp\left(-\frac{T_n-t}{\tau_1} \right)\right] &amp;amp; \left[ \frac{1 - \exp\left(-\frac{T_n-t}{\tau_2} \right)}{\frac{T_1-t}{\tau_2}}  - \exp\left(-\frac{T_n-t}{\tau_2} \right)\right] 
\end{bmatrix}
$$
       <p>
        leads to the OLS estimates
       </p>
       $$
 (\hat{\beta}_0, \hat{\beta}_1, \hat{\beta}_2, \hat{\beta}_3)^\top = (\mathbf{X}^\top\mathbf{X})^{-1}\mathbf{X}^\top\mathbf{y}
$$
       <p>
        As we have seen in previous exercises, in the case of highly correlated regressors $ (\mathbf{X}^\top\mathbf{X})^{-1}$ may or may not have an inverse. If it has, it will likely be "ill-conditioned" such
        <em>
         "that a given computer algorithm may or may not be able to compute an approximate inverse, and if it does so the resulting computed inverse may be highly sensitive to slight variations in the data (due to magnified effects of either rounding error or slight variations in the sampled data points) and so may be very inaccurate or very sample-dependent"
        </em>
        (
        <a href="https://en.wikipedia.org/wiki/Multicollinearity">
         Wikipedia
        </a>
        ).
       </p>
       <p>
        This will also lead to failure of many optimizers. One obvious case that cannot work is $\tau_1 = \tau_2$ since we will have two perfectly correlated regressors.
       </p>
       <ol>
        <li>
         <p>
          For $\tau_1=2.0$ and $\tau_2 \in [2.0, 30.0]$ plot the correlation between the first and second curvature factor.
         </p>
        </li>
        <li>
         <p>
          For the true values of $\tau_1$ and $\tau_2$ estimate the other parameters using OLS.
         </p>
        </li>
       </ol>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        The insight from question 4, have lead many to grid seach over $\tau_1$ and $\tau_2$ and estimate the other parameters using OLS. The final estimate is then the values that gives the lowest value of the objective function.
       </p>
       <p>
        Use
        <code>
         scipy.optimize.brute
        </code>
        to implement the grid search.
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        As an alternative, one could also try to directly use a global optimizer. Try to use e.g.
        <code>
         scipy.optimize.sgho
        </code>
        to solve the optimization problem directly on NLS objective function.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=inclusive-french">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get data frame with Nelson-Siegel-Svensson parameters</span>
<span class="n">all_nss_parameters</span> <span class="o">=</span> <span class="n">get_nominal_yield_data</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s1">'parameters'</span><span class="p">)</span>
<span class="n">nss_parameters</span> <span class="o">=</span> <span class="n">all_nss_parameters</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'2021-03-01'</span><span class="p">]</span>

<span class="c1"># define functions </span>
<span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span> 
    
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">tau</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">tau</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span> 
    
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">tau</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">tau</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">tau</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=enabling-whale">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">time_to_maturities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">tau1</span> <span class="o">=</span> <span class="n">nss_parameters</span><span class="p">[</span><span class="s1">'TAU1'</span><span class="p">]</span>
<span class="n">tau2</span> <span class="o">=</span> <span class="n">nss_parameters</span><span class="p">[</span><span class="s1">'TAU2'</span><span class="p">]</span>

<span class="n">level_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">)</span>
<span class="n">slope_factors</span> <span class="o">=</span> <span class="n">calculate_slope</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">tau1</span><span class="p">)</span>
<span class="n">curvature_factors</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">tau1</span><span class="p">)</span>
<span class="n">second_curvature_factors</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">tau2</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">level_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Level factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">slope_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Slope factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">curvature_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Curvature factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">second_curvature_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"2nd curvature factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=numerous-equivalent">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=posted-methodology">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_nss_zero_yields</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">params</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">List</span><span class="p">])</span> <span class="o">-&amp;gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span> 
    
    <span class="n">beta0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">beta1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">beta2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">beta3</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">tau1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    <span class="n">tau2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
    
    <span class="n">s</span> <span class="o">=</span> <span class="n">calculate_slope</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">,</span> <span class="n">tau1</span><span class="p">)</span>
    <span class="n">c1</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">,</span> <span class="n">tau1</span><span class="p">)</span>
    <span class="n">c2</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">,</span> <span class="n">tau2</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">beta0</span> <span class="o">+</span> <span class="n">beta1</span> <span class="o">*</span> <span class="n">s</span> <span class="o">+</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">c1</span> <span class="o">+</span> <span class="n">beta3</span> <span class="o">*</span> <span class="n">c2</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=upset-moses">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get data frame with Nelson-Siegel-Svensson parameters</span>
<span class="n">all_nss_yields</span> <span class="o">=</span> <span class="n">get_nominal_yield_data</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s1">'zero_yields'</span><span class="p">)</span>
<span class="n">nss_yields</span> <span class="o">=</span> <span class="n">all_nss_yields</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'2021-03-01'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">nss_tenors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># calculate yields</span>
<span class="n">nss_yields_calc</span> <span class="o">=</span> <span class="n">calculate_nss_zero_yields</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=plain-vampire">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plotting </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"FRED"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">3</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields_calc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Calculated"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zero yield (in %)'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=improving-virginia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=available-exchange">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># quadratic objective function </span>
<span class="k">def</span> <span class="nf">quad_objective</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tenors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">observed_yields</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> 
    
    <span class="n">model_yields</span> <span class="o">=</span> <span class="n">calculate_nss_zero_yields</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">observed_yields</span> <span class="o">-</span> <span class="n">model_yields</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=extra-invention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># evaluated at True parameters</span>
<span class="n">quad_objective</span><span class="p">(</span><span class="n">nss_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sublime-senate">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># true parameter values</span>
<span class="n">nss_parameters</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=desirable-external">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">bounds</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
          <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span>
          <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">))</span>

<span class="c1"># guessing on starting values - try som different</span>
<span class="n">num_random</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">beta0_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_random</span><span class="p">)</span>
<span class="n">beta1_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mf">15.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_random</span><span class="p">)</span>
<span class="n">beta2_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_random</span><span class="p">)</span>
<span class="n">beta3_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_random</span><span class="p">)</span>
<span class="n">tau1_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_random</span><span class="p">)</span>
<span class="n">tau2_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">30.0</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_random</span><span class="p">)</span>

<span class="n">random_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">beta0_vals</span><span class="p">,</span> <span class="n">beta1_vals</span><span class="p">,</span> <span class="n">beta2_vals</span><span class="p">,</span> <span class="n">beta3_vals</span><span class="p">,</span> <span class="n">tau1_vals</span><span class="p">,</span> <span class="n">tau2_vals</span><span class="p">))</span>

<span class="n">est_params</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_random</span><span class="p">):</span> 
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">quad_objective</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">),</span> <span class="n">x0</span><span class="o">=</span><span class="n">random_params</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    
    <span class="n">est_params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">est_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">est_params</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=mechanical-configuration">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">plot_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_0$'</span><span class="p">,</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_1$'</span><span class="p">,</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_2$'</span><span class="p">,</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_3$'</span><span class="p">,</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">tau_1$'</span><span class="p">,</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">tau_2$'</span><span class="p">]</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">6</span><span class="p">):</span> 
    
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">est_params</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">plot_names</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">nss_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=broke-valve">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=violent-termination">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">tau2_to_use</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">first_curvature_factor</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)</span>

<span class="n">correlations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">first_curvature_factor</span><span class="p">,</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">t</span><span class="p">))[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                         <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tau2_to_use</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=legendary-clause">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tau2_to_use</span><span class="p">,</span> <span class="n">correlations</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">tau_2$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">rho$ (correlation)'</span><span class="p">);</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=immune-sheep">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">nss_parameters</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=aging-meditation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">OLS estimation </span>
<span class="sd">"""</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">),</span>
          <span class="n">calculate_slope</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_parameters</span><span class="p">[</span><span class="s1">'TAU1'</span><span class="p">]),</span> 
          <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_parameters</span><span class="p">[</span><span class="s1">'TAU1'</span><span class="p">]),</span>
          <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_parameters</span><span class="p">[</span><span class="s1">'TAU2'</span><span class="p">])]</span>

<span class="n">est_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">est_params</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=marked-richmond">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">OLS with slightly different taus -&amp;gt; somewhat different estimates, very sensitive</span>
<span class="sd">"""</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">),</span>
          <span class="n">calculate_slope</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_parameters</span><span class="p">[</span><span class="s1">'TAU1'</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">),</span> 
          <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_parameters</span><span class="p">[</span><span class="s1">'TAU1'</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">),</span>
          <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_parameters</span><span class="p">[</span><span class="s1">'TAU2'</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.1</span><span class="p">)]</span>

<span class="n">est_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">est_params</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=double-expression">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=driving-annual">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">ols_nss</span><span class="p">(</span><span class="n">taus</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="n">tenors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">observed_yields</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>   
    
    <span class="n">tau1</span> <span class="o">=</span> <span class="n">taus</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tau2</span> <span class="o">=</span> <span class="n">taus</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">tenors</span><span class="p">),</span>
              <span class="n">calculate_slope</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="n">tau1</span><span class="p">),</span> 
              <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="n">tau1</span><span class="p">),</span>
              <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="n">tau2</span><span class="p">)]</span>

    <span class="n">est_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">observed_yields</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">est_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


<span class="k">def</span> <span class="nf">ols_quad_objective</span><span class="p">(</span><span class="n">taus</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>  <span class="n">tenors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">observed_yields</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> 

    <span class="n">est_params</span> <span class="o">=</span> <span class="n">ols_nss</span><span class="p">(</span><span class="n">taus</span><span class="p">,</span>  <span class="n">tenors</span><span class="p">,</span> <span class="n">observed_yields</span><span class="p">)</span>
    
    <span class="n">new_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">est_params</span><span class="p">,</span> <span class="n">taus</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">quad_objective</span><span class="p">(</span><span class="n">new_params</span><span class="p">,</span> <span class="n">tenors</span><span class="p">,</span> <span class="n">observed_yields</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=given-finland">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brute</span><span class="p">(</span><span class="n">ols_quad_objective</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">)),</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">),</span> <span class="n">Ns</span><span class="o">=</span><span class="mi">99999</span><span class="p">)</span>
<span class="n">est_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">ols_nss</span><span class="p">(</span><span class="n">res</span><span class="p">,</span>  <span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">),</span> <span class="n">res</span><span class="p">]</span>
<span class="n">est_params</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=pharmaceutical-paradise">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">quad_objective</span><span class="p">(</span><span class="n">est_params</span><span class="p">,</span> <span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=historical-caution">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 6
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=celtic-subscription">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">bounds</span> <span class="o">=</span> <span class="p">((</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span>
          <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">))</span>
<span class="n">optimize</span><span class="o">.</span><span class="n">dual_annealing</span><span class="p">(</span><span class="n">quad_objective</span><span class="p">,</span>  <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">),</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">999</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=plastic-miracle">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">optimize</span><span class="o">.</span><span class="n">shgo</span><span class="p">(</span><span class="n">quad_objective</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">),</span>
              <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
              <span class="n">n</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span>
              <span class="n">sampling_method</span><span class="o">=</span><span class="s1">'sobol'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=overhead-jamaica">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Some-extra-stuff">
        Some extra stuff
        <a class="anchor-link" href="#Some-extra-stuff">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=prescription-crash">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot countour plot beta0 vs tau2</span>
<span class="sd">"""</span>
<span class="n">test_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.05</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.82</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.03</span><span class="p">,</span> <span class="mf">8.25</span><span class="p">,</span> <span class="mf">0.87</span><span class="p">,</span> <span class="mf">14.38</span><span class="p">])</span>
<span class="n">plot_quad_obj_beta0_tau2</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span> <span class="p">:</span> <span class="n">quad_objective</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">nss_parameters</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span>
                                                     <span class="n">nss_tenors</span><span class="p">,</span> <span class="n">nss_yields</span><span class="p">)</span>

<span class="n">beta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span>
<span class="n">tau2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">999</span><span class="p">)</span>
<span class="n">beta0grid</span><span class="p">,</span> <span class="n">tau2grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">beta0</span><span class="p">,</span> <span class="n">tau2</span><span class="p">)</span>
<span class="n">inputs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">beta0grid</span><span class="p">,</span> <span class="n">tau2grid</span><span class="p">])</span>
<span class="n">quad_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">plot_quad_obj_beta0_tau2</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">inputs</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sexual-fiber">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># Initialize figure </span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span> <span class="o">=</span> <span class="s1">'3d'</span><span class="p">)</span>

<span class="c1"># Plot the surface</span>
<span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">beta0grid</span><span class="p">,</span> <span class="n">tau2grid</span><span class="p">,</span> <span class="n">quad_values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_0$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">tau_2$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">'$g(\mathbf</span><span class="si">{y}</span><span class="s1">; </span><span class="se">\\</span><span class="s1">theta)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sharp-obligation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">beta0grid</span><span class="p">,</span> <span class="n">tau2grid</span><span class="p">,</span> <span class="n">quad_values</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mi">30</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_0$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">tau_2$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=iraqi-artwork">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Problem-4:-Portfolio-optimization-with-constraints">
        Problem 4: Portfolio optimization with constraints
        <a class="anchor-link" href="#Problem-4:-Portfolio-optimization-with-constraints">
         ¶
        </a>
       </h3>
       <p>
        One way to cast the investor's one period portfolio optimization problem (in a Markowitz framework) is to minimize the portfolio variance $\text{Var}[R_p]$
       </p>
       $$
\underset{\mathbf{w}}{\text{arg min}} \text{Var}[R_p] = \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to meeting the target return $p$
       </p>
       $$
\mathbf{w}^\top \boldsymbol{\mu} = p
$$
       <p>
        We also want the portfolio weights to sum to one and not allow for short-selling
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
w_i &amp;amp;\geq 0, \; i=1,2, ..., N
\end{align}
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Obtain the value weighted monthly return data for the Fama-French industry portfolios ("12_Industry_Portfolios") using
        <code>
         pandas-datareader
        </code>
        since 1999-01-01. Calculate the expected monthly mean return and covariance matrix.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Solve the previously defined optimization problem using the estimates from question 1. Consider different relevant target values for $p$ (expected monthly return).
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Plot the optimal allocation and the efficient frontier in two seperat figures.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Repeat the calculations in the two previous questions when allocation to a particular index is restricted to be no more than 30%.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=enormous-exposure">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1">#get_available_datasets()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=opposed-trade">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s2">"12_Industry_Portfolios"</span><span class="p">,</span>
                          <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">industry_port</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># print description</span>
<span class="n">industry_port</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personalized-manchester">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get equally weighted</span>
<span class="n">ind_eq_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

<span class="c1"># get market cap weighted </span>
<span class="n">ind_mc_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

<span class="c1"># asset list</span>
<span class="n">asset_list</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=controversial-ecology">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu_est</span>  <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">cor_mat_est</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">vol_est</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">cov_mat_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vol_est</span><span class="p">,</span> <span class="n">vol_est</span><span class="p">)</span> <span class="o">*</span> <span class="n">cor_mat_est</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=capital-samba">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">correlation_plot</span><span class="p">(</span><span class="n">cor_mat_est</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">asset_list</span><span class="p">,</span> <span class="n">include_values</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=standard-plastic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=1c35c5f8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">max_exp_ret</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="n">min_exp_ret</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=attempted-generator">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define objective function </span>
<span class="k">def</span> <span class="nf">portfolio_variance</span><span class="p">(</span><span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> 
    <span class="k">return</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span> <span class="o">@</span> <span class="n">w</span>

<span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> 
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                 <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>

<span class="c1"># define constraint </span>
<span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
               <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est</span> <span class="o">-</span> <span class="n">max_exp_ret</span><span class="p">,</span>
               <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_est</span><span class="p">}</span>

<span class="n">port_var_der</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span>


<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,),</span>
                        <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                        <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span>
                                     <span class="n">no_short_cons</span><span class="p">,</span> 
                                     <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>

<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=cross-wilson">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Loop over different target expected return </span>
<span class="sd">"""</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="n">port_weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">mu_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_exp_ret</span><span class="p">,</span> <span class="n">max_exp_ret</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mu_targets</span><span class="p">:</span>
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span>
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_est</span><span class="p">}</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                            <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">target_cons</span><span class="p">],</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span><span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    
    <span class="n">port_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">port_weights</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=refined-wrapping">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1">#port_weights</span>
<span class="c1">#mu_targets</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=intelligent-segment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=military-hypothesis">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">,</span> <span class="n">port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">asset_list</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">mu_</span><span class="si">{target}</span><span class="s1">$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$w$ (portfolio weight, in %)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Optimal portfolio weights'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.175</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=13dee418">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">port_weights</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=exact-format">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                           <span class="n">port_weights</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">cov_mat_est</span><span class="p">))</span>
<span class="n">all_mu</span> <span class="o">=</span> <span class="n">port_weights</span> <span class="o">@</span> <span class="n">mu_est</span> <span class="o">/</span> <span class="mf">100.0</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_port_std</span><span class="p">,</span> <span class="n">all_mu</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Efficient frontier'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vol_est</span><span class="p">,</span> <span class="n">mu_est</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Individual assets"</span><span class="p">);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Efficient frontier'</span><span class="p">);</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">sigma$ (monthly standard deviation)'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">mu$ (monthly expected return)'</span><span class="p">);</span> 

<span class="c1"># add asset names</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vol_est</span><span class="p">,</span> <span class="n">mu_est</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">asset_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xy</span><span class="p">)</span>
    
<span class="c1"># fix axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=6a8b3869">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [ ]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sorted-wallpaper">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question  4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=exclusive-shame">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span> <span class="c1"># implement constraint</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="n">port_weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">mu_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_exp_ret</span> <span class="o">+</span> <span class="mf">0.003</span><span class="p">,</span> <span class="n">max_exp_ret</span> <span class="o">-</span> <span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mu_targets</span><span class="p">:</span>
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
               <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est</span> <span class="o">-</span> <span class="n">p</span><span class="p">,</span>
               <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_est</span><span class="p">}</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                            <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">target_cons</span><span class="p">],</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    
    <span class="n">port_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">port_weights</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=satisfied-pharmacology">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [48]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">,</span> <span class="n">port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">asset_list</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">mu_</span><span class="si">{target}</span><span class="s1">$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$w$ (portfolio weight, in %)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Optimal portfolio weights'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.175</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=differential-seeking">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [49]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">port_weights</span> <span class="o">/</span> <span class="mi">100</span><span class="p">,</span> <span class="n">cov_mat_est</span><span class="p">))</span>
<span class="n">all_mu</span> <span class="o">=</span> <span class="n">port_weights</span> <span class="o">@</span> <span class="n">mu_est</span> <span class="o">/</span> <span class="mf">100.0</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_port_std</span><span class="p">,</span> <span class="n">all_mu</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Efficient frontier'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vol_est</span><span class="p">,</span> <span class="n">mu_est</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Individual assets"</span><span class="p">);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Efficient frontier'</span><span class="p">);</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">sigma$ (monthly standard deviation)'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">mu$ (monthly expected return)'</span><span class="p">);</span> 


<span class="c1"># add asset names</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">xy</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">vol_est</span><span class="p">,</span> <span class="n">mu_est</span><span class="p">)):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">asset_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">xy</span><span class="p">)</span>
    
<span class="c1"># fix axes</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_xlim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.001</span><span class="p">,</span> <span class="n">ax</span><span class="o">.</span><span class="n">get_ylim</span><span class="p">()[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=molecular-rover">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-5:--Minimizing-CVaR-(and-VaR)">
        Problem 5:  Minimizing CVaR (and VaR)
        <a class="anchor-link" href="#Problem-5:--Minimizing-CVaR-(and-VaR)">
         ¶
        </a>
       </h2>
       <p>
        We now assume that an investor's one period portfolio optimization problem is to minimize the portfolio $\text{CVaR}_\beta[R_p]$
       </p>
       $$
\underset{\mathbf{w}}{\text{arg min }}  \text{CVaR}_\beta[R_p]
$$
       <p>
        subject to meeting the target return $p$
       </p>
       $$
\mathbf{w}^\top \boldsymbol{\mu} = p
$$
       <p>
        We also want the portfolio weights to sum to one and not allow for short-selling
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
w_i &amp;amp;\geq 0, \; i=1,2, ..., N
\end{align}
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Implement the Mean-CVaR optimization problem using the same data set as in the previous problem for some target return. Let $\beta = 0.95$ (95% CVaR).
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Consider different relevant target values for $p$ (expected monthly return).
       </p>
       <p>
        Plot the optimal allocations and the efficient frontier.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=humanitarian-speed">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [50]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s2">"12_Industry_Portfolios"</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">industry_port</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># print description</span>
<span class="n">industry_port</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>

<span class="c1"># get equally weighted</span>
<span class="n">ind_eq_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

<span class="c1"># get market cap weighted </span>
<span class="n">ind_mc_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

<span class="c1"># asset list</span>
<span class="n">asset_list</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=biological-natural">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [51]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu_est</span>  <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">cor_mat_est</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">vol_est</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">std</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
<span class="n">cov_mat_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vol_est</span><span class="p">,</span> <span class="n">vol_est</span><span class="p">)</span><span class="o">*</span><span class="n">cor_mat_est</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sweet-bargain">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [52]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_cvar</span><span class="p">(</span><span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">returns</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.95</span><span class="p">):</span> 
    
    <span class="c1"># portfolio returns</span>
    <span class="n">port_returns</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">@</span> <span class="n">w</span> 
    
    <span class="c1"># percentile</span>
    <span class="n">perc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">port_returns</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
    
    <span class="c1"># average in tail</span>
    <span class="n">avg_tail</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">port_returns</span><span class="p">[</span><span class="n">port_returns</span> <span class="o">&amp;lt;=</span> <span class="n">perc</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="o">-</span><span class="n">avg_tail</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=amateur-school">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [53]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>

<span class="c1"># define constraint </span>
<span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
               <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est</span> <span class="o">-</span> <span class="mf">0.009</span><span class="p">}</span>


<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="n">res1</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">calculate_cvar</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                        <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span> 
                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

<span class="n">res1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sweet-panic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sized-albania">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [54]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">max_exp_ret</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="n">min_exp_ret</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)]</span>
<span class="n">port_weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">mu_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">min_exp_ret</span> <span class="o">+</span> <span class="mf">0.003</span><span class="p">,</span> <span class="n">max_exp_ret</span> <span class="o">-</span> <span class="mf">0.0005</span><span class="p">,</span> <span class="mf">0.0001</span><span class="p">)</span>
<span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">mu_targets</span><span class="p">:</span>
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est</span> <span class="o">-</span> <span class="n">p</span><span class="p">}</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">calculate_cvar</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                        <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span> 
                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'maxiter'</span><span class="p">:</span> <span class="mi">1000</span><span class="p">,</span> <span class="s1">'eps'</span><span class="p">:</span> <span class="mf">1e-12</span><span class="p">},</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    
    <span class="n">port_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    
<span class="n">port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">port_weights</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=bulgarian-courtesy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [55]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">,</span> <span class="n">port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">asset_list</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">mu_</span><span class="si">{target}</span><span class="s1">$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$w$ (portfolio weight, in %)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Optimal portfolio weights'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.175</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 


<span class="n">all_port_cvar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">calculate_cvar</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">port_weights</span> <span class="p">,</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)</span>
<span class="n">all_mu</span> <span class="o">=</span> <span class="n">port_weights</span> <span class="o">@</span> <span class="n">mu_est</span> 

<span class="n">ax_new</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>
<span class="n">ax_new</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_mu</span><span class="p">,</span> <span class="n">all_port_cvar</span><span class="p">,</span>  <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>

<span class="n">ax_new</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 
<span class="n">ax_new</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span> 
<span class="n">ax_new</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'CVaR(95%)'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.nber.org/papers/w4871">
         Svensson (1994)
        </a>
       </p>
       <p>
        <a href="https://www.ise.ufl.edu/uryasev/files/2011/11/CVaR1_JOR.pdf">
         Rockafeller and Uryasev (2000)
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3653d9f6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [ ]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># numpy for working with vector, matrices, etc. </span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># plotting libraries</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mtick</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span><span class="p">,</span> <span class="n">cm</span>

<span class="c1"># for working with time and dates</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># scipy for stat and optimization </span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>

<span class="c1"># Loading data using pandas datareader</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.data</span> <span class="kn">import</span> <span class="n">DataReader</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>

<span class="c1"># numerical derivatives using statsmodels</span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.numdiff</span> <span class="kn">import</span> <span class="n">approx_fprime</span><span class="p">,</span> <span class="n">approx_hess</span>

<span class="c1"># typehints</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="c1"># cvxopt and cvxpy for optimization </span>
<span class="kn">import</span> <span class="nn">cvxopt</span> 
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span> 


<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="c1"># nominal yield curve data</span>
<span class="kn">from</span> <span class="nn">codelib.dal.fred_yield_data</span> <span class="kn">import</span> <span class="n">get_nominal_yield_data</span>

<span class="c1"># moments: kurtosis with probs, etc. </span>
<span class="kn">from</span> <span class="nn">codelib.statistics</span> <span class="kn">import</span> <span class="n">moments</span> <span class="k">as</span> <span class="n">mom</span>

<span class="c1"># functions for calculating risk budget and portfolio risk metrics </span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization</span> <span class="kn">import</span> <span class="n">risk_budget</span> <span class="k">as</span> <span class="n">rb</span> 
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization</span> <span class="kn">import</span> <span class="n">risk_metrics</span> <span class="k">as</span> <span class="n">rm</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">correlation_plot</span><span class="p">,</span> <span class="n">risk_waterfall_chart</span><span class="p">,</span> <span class="n">waterfall_chart</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-6">
        Exercises - Week 6
        <a class="anchor-link" href="#Exercises---Week-6">
         ¶
        </a>
       </h1>
       <p>
        In this week we will look at a few exercises involving convex optimization and estimation.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7fff199d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1:-Classical-Mean-Variance-optimization-with-constraints">
        Problem 1: Classical Mean-Variance optimization with constraints
        <a class="anchor-link" href="#Problem-1:-Classical-Mean-Variance-optimization-with-constraints">
         ¶
        </a>
       </h2>
       <p>
        An investor can invest in 10 different assets: Government bonds, Investment-grade bonds, High-yield bonds, Emerging markets gov. bonds, Equities (developed markets), Equities (Emerging markets), Private equity, Infrastructure, Real Estate, and Hedgefunds.  The continuously compounded / log-returns are assumed to be i.i.d. multivariate normally distributed
       </p>
       \begin{equation*}
    \mathbf{r}_{t + 1, 1} \sim MVN(\boldsymbol{\mu},\boldsymbol{\Sigma})
\end{equation*}
       <p>
        with correlation matrix
       </p>
       \begin{equation*}
    \mathbf{C} =   \begin{bmatrix}
    	1.0 &amp;amp;  0.6 &amp;amp;  0.1 &amp;amp;  0.3 &amp;amp; -0.1 &amp;amp; -0.1 &amp;amp; -0.2 &amp;amp; -0.1 &amp;amp; -0.1 &amp;amp; -0.1 \\
    	0.6 &amp;amp;  1.0 &amp;amp;  0.6 &amp;amp;  0.6 &amp;amp;  0.2 &amp;amp;  0.2 &amp;amp;  0.2 &amp;amp;  0.1 &amp;amp;  0.1 &amp;amp;  0.3 \\ 
    	0.1 &amp;amp;  0.6 &amp;amp;  1.0 &amp;amp;  0.7 &amp;amp;  0.7 &amp;amp;  0.6 &amp;amp;  0.6 &amp;amp;  0.4 &amp;amp;  0.3 &amp;amp;  0.7 \\
    	0.3 &amp;amp;  0.6 &amp;amp;  0.7 &amp;amp;  1.0 &amp;amp;  0.5 &amp;amp;  0.6 &amp;amp;  0.4 &amp;amp;  0.2 &amp;amp;  0.2 &amp;amp;  0.5 \\
    	-0.1 &amp;amp;  0.2 &amp;amp;  0.7 &amp;amp;  0.5 &amp;amp;  1.0 &amp;amp;  0.7 &amp;amp;  0.8 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.8 \\
    	-0.1 &amp;amp;  0.2 &amp;amp;  0.6 &amp;amp;  0.6 &amp;amp;  0.7 &amp;amp;  1.0 &amp;amp;  0.7 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.7 \\
    	-0.2 &amp;amp;  0.2 &amp;amp;  0.6 &amp;amp;  0.4 &amp;amp;  0.8 &amp;amp;  0.7 &amp;amp;  1.0 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.7 \\
    	-0.1 &amp;amp;  0.1 &amp;amp;  0.4 &amp;amp;  0.2 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  1.0 &amp;amp;  0.3 &amp;amp;  0.4 \\
    	-0.1 &amp;amp;  0.1 &amp;amp;  0.3 &amp;amp;  0.2 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  0.3 &amp;amp;  1.0 &amp;amp;  0.4 \\
    	-0.1 &amp;amp;  0.3 &amp;amp;  0.7 &amp;amp;  0.5 &amp;amp;  0.8 &amp;amp;  0.7 &amp;amp;  0.7 &amp;amp;  0.4 &amp;amp;  0.4 &amp;amp;  1.0
    \end{bmatrix},
\end{equation*}
       <p>
        vector of volatilities
       </p>
       \begin{equation*}
    \mathbf{v} =   \begin{bmatrix}
    	0.037, 0.055, 0.119, 0.107, 0.153, 0.217, 0.204, 0.14, 0.108, 0.094
    \end{bmatrix}^\top,
\end{equation*}
       <p>
        and expected log return
       </p>
       \begin{equation*}
    \boldsymbol{\mu} =   \begin{bmatrix}
    	0.019, 0.022, 0.049, 0.043, 0.061, 0.083, 0.102, 0.056, 0.041, 0.038
    \end{bmatrix}^\top - \frac{1}{2} \text{Diag}(\boldsymbol{\Sigma}),
\end{equation*}
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Assume that $\mathbf{P}_0 = 1$. What is the distribution of the net portfolio return $\mathbf{w}^\top \mathbf{R}_1 = \mathbf{w}^\top \frac{\mathbf{P}_1}{\mathbf{P}_0} - 1$?  What is the expected portfolio return and standard deviation?
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Calculate the expected value and standard devation of an equally weighted portfolio. Calculate and visualize the risk contribution based on standard deviation as risk measure.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Define and solve the minimization problem using
        <code>
         cvxopt
        </code>
        or
        <code>
         cvxpy
        </code>
       </p>
       $$
\begin{align*}
    \min_{\mathbf{x}}  \quad &amp;amp; \mathbf{w}^\top  \text{Cov}[\mathbf{R}_1]  \mathbf{w} \\
    \textrm{s.t.} \quad 
     &amp;amp; \mathbf{1}^\top \mathbf{w} = 1\\
     &amp;amp; \text{E}[\mathbf{R}_1]^\top \mathbf{w} = \bar{\mu}\\
     &amp;amp; \mathbf{w} \geq \mathbf{0}
\end{align*}
$$
       <p>
        Thus, minimize the portfolio variance subject to a given target return $\bar{\mu}$. Consider 50 different return targets from the lowest to the highest possible.
       </p>
       <p>
        Plot the optimal portfolio weights using a
        <code>
         matplotlib.pyplot.stackplot
        </code>
        for the return targets.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Using the optimal portfolios from above, plot the efficient frontier (plot the standard deviations against the expected return). Add the assets to the plot.
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        The optimal portfolios are dominated by a few assets. We want to impose a maximum allocation of $0.25$. Furthermore, we want to impose a maximum allocation of $0.4$ to alternatives: Private equity, Infrastructure, Real Estate, Hedgefunds.
       </p>
       <p>
        Repeat the last two questions, when imposing these constraints.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        We have assumed that the log-returns follow a multivariate normal distribution
       </p>
       $$
\mathbf{r}_{t+ 1, 1} = \log \frac{\mathbf{P}_{t+1}}{\mathbf{P}_t} \sim MVN(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        Thus, the vector of asset prices at year one follows a multivariate log-normal distribution
       </p>
       $$
\log \mathbf{P}_1 \sim MVN(\boldsymbol{\mu}, \boldsymbol{\Sigma}) \Leftrightarrow \mathbf{P}_1 \sim \log MVN(\boldsymbol{\mu}, \boldsymbol{\Sigma}) 
$$
       <p>
        The value of the portfolio in one year $\mathbf{w}^\top \mathbf{P}_1$ does not follow a log-normal since the weighted sum of log-normals does not follow a log-normal distribution! However, it is possible to derive the expected value and the variance
       </p>
       <p>
        We need to find the expected value and covariance of the linear returns. We have
       </p>
       $$
\text{E}[e^{\mathbf{r}_{1, 1}}] = \text{E}[\mathbf{P}_{1}] = e^{\boldsymbol{\mu}   + \frac{1}{2}\text{diag}(\boldsymbol{\Sigma})}
$$
       <p>
        and
       </p>
       $$
\text{Cov}[e^{\mathbf{r}_{1, 1}}] =  \text{Cov}[\mathbf{P}_{1}] =  \text{E}[e^{\mathbf{r}_{1, 1}}] \text{E}[e^{\mathbf{r}_{1,1}}]^\top \odot \left(e^{\boldsymbol{\Sigma}} - \mathbf{1} \right)
$$
       <p>
        The expected value and covariance of the linear returns are therefore
       </p>
       $$
\text{E}[\mathbf{R}_{1}] = \text{E}[\mathbf{P}_{1} - 1 ] = e^{\boldsymbol{\mu}  + \frac{1}{2}\text{diag}(\boldsymbol{\Sigma})} - 1
$$
       <p>
        and
       </p>
       $$
\text{Cov}[\mathbf{R}_{1}] =  \text{Cov}[\mathbf{P}_{1}] =  \text{E}[e^{\mathbf{r}_{1, 1}}] \text{E}[e^{\mathbf{r}_{1,1}}]^\top \odot \left(e^{\boldsymbol{\Sigma}} - \mathbf{1} \right)
$$
       <p>
        The portfolio return
       </p>
       $$
R_w = \mathbf{w}^\top \mathbf{R}_1
$$
       <p>
        has the expected value
       </p>
       $$
\text{E}[R_w] =  \mathbf{w}^\top \text{E}[\mathbf{R}_{1}]
$$
       <p>
        and variance
       </p>
       $$
\text{Var}[R_w] = \mathbf{w}^\top \text{Cov}[\mathbf{R}_{1}] \mathbf{w}
$$
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a4dc0784">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define inputs </span>
<span class="sd">"""</span>

<span class="n">asset_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"Government bonds"</span><span class="p">,</span> <span class="s2">"Investment-grade bonds"</span><span class="p">,</span> <span class="s2">"High-yield bonds"</span><span class="p">,</span>
               <span class="s2">"Emerging markets gov. bonds"</span><span class="p">,</span> <span class="s2">"Equities (developed markets)"</span><span class="p">,</span>
               <span class="s2">"Equities (Emerging markets)"</span><span class="p">,</span> <span class="s2">"Private equity"</span><span class="p">,</span> <span class="s2">"Infrastructure"</span><span class="p">,</span>
               <span class="s2">"Real Estate"</span><span class="p">,</span> <span class="s2">"Hedgefunds"</span><span class="p">]</span>

<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.10</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.60</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.60</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.10</span><span class="p">,</span> <span class="mf">0.30</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.50</span><span class="p">,</span> <span class="mf">0.80</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.70</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">0.40</span><span class="p">,</span> <span class="mf">1.00</span><span class="p">]])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.7</span><span class="p">,</span> <span class="mf">5.5</span><span class="p">,</span> <span class="mf">11.9</span><span class="p">,</span> <span class="mf">10.7</span><span class="p">,</span> <span class="mf">15.3</span><span class="p">,</span> <span class="mf">21.7</span><span class="p">,</span> <span class="mf">20.4</span><span class="p">,</span> <span class="mf">14.0</span><span class="p">,</span> <span class="mf">10.8</span><span class="p">,</span> <span class="mf">9.4</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="o">=</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="o">=</span><span class="n">vols</span><span class="p">)</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.9</span><span class="p">,</span> <span class="mf">2.2</span><span class="p">,</span> <span class="mf">4.9</span><span class="p">,</span> <span class="mf">4.3</span><span class="p">,</span> <span class="mf">6.1</span><span class="p">,</span> <span class="mf">8.3</span><span class="p">,</span> <span class="mf">10.2</span><span class="p">,</span> <span class="mf">5.6</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">,</span> <span class="mf">3.8</span><span class="p">])</span> <span class="o">/</span> <span class="mi">100</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">vols</span><span class="o">**</span><span class="mi">2</span> 

<span class="c1"># number of assets </span>
<span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="c1"># equal portfolio weights </span>
<span class="n">eq_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">num_assets</span><span class="p">,</span> <span class="n">num_assets</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=9a005f7f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Convert to mean and variance for linear returns</span>
<span class="sd">"""</span>

<span class="n">mu_l</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">calculate_log_norm_mean</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
<span class="n">sigma_l</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">calculate_log_norm_cov_mat</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0345a6ec">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"Eq. weighted"</span><span class="p">],</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
<span class="n">df_res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'$\mu_p$'</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_mean</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">eq_w</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu_l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>
<span class="n">df_res</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'$\sigma_p$'</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">eq_w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="o">=</span><span class="n">sigma_l</span><span class="p">)</span> <span class="o">*</span> <span class="mf">100.0</span>

<span class="n">df_res</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6c8b3268">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate risk contributions </span>
<span class="sd">"""</span>

<span class="n">std_contrib</span> <span class="o">=</span> <span class="n">rb</span><span class="o">.</span><span class="n">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">eq_w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="o">=</span><span class="n">sigma_l</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot waterfall chart</span>
<span class="sd">"""</span>

<span class="n">waterfall_chart</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="n">asset_names</span><span class="p">,</span> <span class="n">values</span><span class="o">=</span><span class="n">std_contrib</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mf">18.5</span><span class="p">,</span> <span class="mf">10.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Risk decomposition portfolio - Standard deviation'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Risk contribution (in %)'</span><span class="p">);</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=72dfb7ec">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=4abe850e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define problem </span>
<span class="sd">"""</span>

<span class="c1"># return targets to consider </span>
<span class="n">return_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mu_l</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mu_l</span><span class="p">),</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># define cvxpy parameter </span>
<span class="n">mu_target</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Parameter</span><span class="p">()</span>

<span class="c1"># optimization variable </span>
<span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

<span class="c1"># define constraints </span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">mu_l</span> <span class="o">==</span> <span class="n">mu_target</span><span class="p">)</span>

<span class="c1"># define problem </span>
<span class="n">variance</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">sigma_l</span><span class="p">,</span> <span class="n">assume_PSD</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span>  <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">variance</span><span class="p">),</span> <span class="n">constraints</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=5a57793a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Iterate over all possible return targets</span>
<span class="sd">"""</span>

<span class="c1"># define list for storing optimal portfolios </span>
<span class="n">optimal_portfolios</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">return_targets</span><span class="p">:</span> 
    
    <span class="c1"># set expected return target</span>
    <span class="n">mu_target</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">mu</span>
    
    <span class="c1"># solve problem </span>
    <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># store optimal weights </span>
    <span class="n">optimal_portfolios</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
<span class="c1"># transform to numpy array </span>
<span class="n">optimal_portfolios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">optimal_portfolios</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7ef92927">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot portfolio along the efficient frontier</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">return_targets</span><span class="p">,</span> <span class="n">optimal_portfolios</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">asset_names</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights, mean-variance at 1Y horizon"</span><span class="p">)</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d1523824">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=630a55c5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate port. expected return along efficient frontier</span>
<span class="sd">"""</span>

<span class="n">eff_port_exp_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_mean</span><span class="p">,</span>
                                          <span class="mi">1</span><span class="p">,</span> <span class="n">optimal_portfolios</span><span class="p">,</span> <span class="n">mu_l</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Calculate port. std</span>
<span class="sd">"""</span>

<span class="n">eff_port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">,</span>
                                   <span class="mi">1</span><span class="p">,</span> <span class="n">optimal_portfolios</span><span class="p">,</span> <span class="n">sigma_l</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c31804c2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># plot efficient frontier </span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eff_port_std</span><span class="p">,</span> <span class="n">eff_port_exp_return</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Efficient frontier"</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">)</span>

<span class="c1"># add the different assets </span>
<span class="n">assets_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma_l</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">assets_std</span><span class="p">,</span> <span class="n">mu_l</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Assets"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">asset_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">assets_std</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mu_l</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1"># set correct tick labels, etc. </span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Standard deviation"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">"Expected return"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper left"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a7d1b4cc">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=db33e29d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define problem </span>
<span class="sd">"""</span>

<span class="c1"># return targets to consider </span>
<span class="n">return_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mu_l</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.015</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mu_l</span><span class="p">)</span> <span class="o">-</span> <span class="mf">0.03</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="c1"># define cvxpy parameter </span>
<span class="n">mu_target</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Parameter</span><span class="p">()</span>

<span class="c1"># optimization variable </span>
<span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

<span class="c1"># define constraints </span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">mu_l</span> <span class="o">==</span> <span class="n">mu_target</span><span class="p">)</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="o">&amp;lt;=</span><span class="mf">0.25</span><span class="p">)</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">@</span> <span class="n">w</span> <span class="o">&amp;lt;=</span> <span class="mf">0.4</span><span class="p">)</span>

<span class="c1"># define problem </span>
<span class="n">variance</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">sigma_l</span><span class="p">,</span> <span class="n">assume_PSD</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span>  <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">variance</span><span class="p">),</span> <span class="n">constraints</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4d8e3662">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Iterate over all possible return targets</span>
<span class="sd">"""</span>

<span class="c1"># define list for storing optimal portfolios </span>
<span class="n">optimal_portfolios_w_max_alloc</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">mu</span> <span class="ow">in</span> <span class="n">return_targets</span><span class="p">:</span> 
    
    <span class="c1"># set expected return target</span>
    <span class="n">mu_target</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="n">mu</span>
    
    <span class="c1"># solve problem </span>
    <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="c1"># store optimal weights </span>
    <span class="n">optimal_portfolios_w_max_alloc</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
    
<span class="c1"># transform to numpy array </span>
<span class="n">optimal_portfolios_w_max_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">optimal_portfolios_w_max_alloc</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=88b239f2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot portfolio along the efficient frontier</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">return_targets</span><span class="p">,</span> <span class="n">optimal_portfolios_w_max_alloc</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
             <span class="n">labels</span><span class="o">=</span><span class="n">asset_names</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights, mean-variance at 1Y horizon"</span><span class="p">)</span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=430f328f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate port. expected return along efficient frontier</span>
<span class="sd">"""</span>

<span class="n">eff_port_exp_return_w_max_alloc</span><span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_mean</span><span class="p">,</span>
                                          <span class="mi">1</span><span class="p">,</span> <span class="n">optimal_portfolios_w_max_alloc</span><span class="p">,</span> <span class="n">mu_l</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Calculate port. std</span>
<span class="sd">"""</span>

<span class="n">eff_port_std_w_max_alloc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">,</span>
                                   <span class="mi">1</span><span class="p">,</span> <span class="n">optimal_portfolios_w_max_alloc</span><span class="p">,</span> <span class="n">sigma_l</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3e4c56dd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="c1"># plot efficient frontier </span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eff_port_std</span><span class="p">,</span> <span class="n">eff_port_exp_return</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Efficient frontier"</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">eff_port_std_w_max_alloc</span><span class="p">,</span> <span class="n">eff_port_exp_return_w_max_alloc</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">"Efficient frontier w. max allocation constraint"</span><span class="p">,</span>
        <span class="n">color</span><span class="o">=</span><span class="s2">"green"</span><span class="p">)</span>

<span class="c1"># add the different assets </span>
<span class="n">assets_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sigma_l</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">assets_std</span><span class="p">,</span> <span class="n">mu_l</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Assets"</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_assets</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">annotate</span><span class="p">(</span><span class="n">asset_names</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="p">(</span><span class="n">assets_std</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">mu_l</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>

<span class="c1"># set correct tick labels, etc. </span>
<span class="n">ticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticks</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Standard deviation"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">"Expected return"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.35</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper left"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=6ea2f959">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:-Hedging-a-cash-flow">
        Problem 2: Hedging a cash flow
        <a class="anchor-link" href="#Problem-2:-Hedging-a-cash-flow">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Download the US Treasury nominal zero coupon yields using e.g.
        <code>
         dal.fred_yield_data.get_nominal_yield_data
        </code>
        .
       </p>
       <p>
        Visualize the data using a scatter plot for 1st September 2023.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        For simplicity, assume that we have 8 bullet bonds available with respectively 1, 3, 5, 7, 10, 13, 15, 20 years to maturity. All have bonds have a coupon of 4% with annual payments and face value of 100 (e.g the 3 year bond has a payment of 4 one and two year from now, and a payment of 104 three years from now).
       </p>
       <p>
        Calculate the present value (price) of the bonds cash flow.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Create a cash flow matrix (number of bonds x number of cash flow time points) using all the bonds such that the rows contains the cash flows for each bond.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Asssume a liability cash flow of
       </p>
       <table>
        <thead>
         <tr>
          <th style="text-align:right">
           Time
          </th>
          <th style="text-align:right">
           Cash flow
          </th>
         </tr>
        </thead>
        <tbody>
         <tr>
          <td style="text-align:right">
           1
          </td>
          <td style="text-align:right">
           1000000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           2
          </td>
          <td style="text-align:right">
           1100000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           3
          </td>
          <td style="text-align:right">
           1200000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           4
          </td>
          <td style="text-align:right">
           1300000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           5
          </td>
          <td style="text-align:right">
           1400000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           6
          </td>
          <td style="text-align:right">
           1500000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           7
          </td>
          <td style="text-align:right">
           1400000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           8
          </td>
          <td style="text-align:right">
           1300000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           9
          </td>
          <td style="text-align:right">
           1200000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           10
          </td>
          <td style="text-align:right">
           1100000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           11
          </td>
          <td style="text-align:right">
           1000000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           12
          </td>
          <td style="text-align:right">
           900000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           13
          </td>
          <td style="text-align:right">
           800000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           14
          </td>
          <td style="text-align:right">
           700000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           15
          </td>
          <td style="text-align:right">
           600000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           16
          </td>
          <td style="text-align:right">
           500000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           17
          </td>
          <td style="text-align:right">
           400000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           18
          </td>
          <td style="text-align:right">
           300000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           19
          </td>
          <td style="text-align:right">
           200000
          </td>
         </tr>
         <tr>
          <td style="text-align:right">
           20
          </td>
          <td style="text-align:right">
           100000
          </td>
         </tr>
        </tbody>
       </table>
       <p>
        Plot the liability cash flow with a bar plot.
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        It is possible to solve the simple cash flow matching problem using linear programming
        <a href="https://en.wikipedia.org/wiki/Cashflow_matching">
         [W]
        </a>
        . Suppose that we have a choice of $j=1,...,n $ bonds with which to receive cash flows over $t=1,...,T$ time periods in order to cover liabilities $L_{1},...,L_{T}$ for each time period.  The $j$th bond in time period $t$ is assumed to have known cash flows $C_{jt}$ and initial price $p_{j}$. It possible to buy $x_{j}$ bonds and to run a surplus $s_{t}$ in a given time period, both of which must be non-negative, and leads to the set of constraints
       </p>
       $$\begin{align}
\sum_{j=1}^{n}C_{j1}x_{j} - s_{1} &amp;amp;= L_{1} \\
\sum_{j=1}^{n}C_{jt}x_{j} + s_{t-1} - s_{t} &amp;amp;= L_{t}, \quad t = 2,...,T
\end{align}
$$
       <p>
        Our goal is to minimize the initial cost of purchasing bonds to meet the liabilities in each time period, given by $\mathbf{p}^{\top} \mathbf{x}$. Together, these requirements give rise to the associated linear programming problem
       </p>
       $$
\min \mathbf{p}^\top \mathbf{x}
$$
       <p>
        subject to the constraints
       </p>
       $$
\mathbf{C}^\top \mathbf{x} + \mathbf{R} \mathbf{s} \geq \mathbf{L}
$$
       <p>
        and
       </p>
       $$
\mathbf{x}, \mathbf{s} \geq 0
$$
       <p>
        where $\mathbf{C}$ is the $n \times T$ matrix and $\mathbf{R}$ is a $T \times T$ matrix with $R_{t,t}=-1$ and $R_{t+1, t}=1$
       </p>
       <p>
        Define and solve the cash flow matching problem using either
        <code>
         cvxopt
        </code>
        or
        <code>
         cvxpy
        </code>
        .
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        Compare the cummulative liability cash flow with the cummulative hedge cash flow using a bar plot.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c8ccdd1c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># Get zero yields</span>
<span class="n">df_zero_yields</span> <span class="o">=</span> <span class="n">get_nominal_yield_data</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s2">"zero_yields"</span><span class="p">)</span>
<span class="n">zero_yields</span> <span class="o">=</span> <span class="n">df_zero_yields</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'2023-09-01'</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span>

<span class="c1"># define tenors / time to maturity</span>
<span class="n">tenors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">float</span><span class="p">(</span><span class="n">text</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">:])</span>  <span class="k">for</span> <span class="n">text</span> <span class="ow">in</span> <span class="n">df_zero_yields</span><span class="o">.</span><span class="n">columns</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b274bd45">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="n">zero_yields</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"-"</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"o"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Tenor"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">"Zero yields (in %)"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"US Treasury ZC Yields"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7628cf6d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e965e968">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">scipy.interpolate</span> <span class="kn">import</span> <span class="n">splev</span><span class="p">,</span> <span class="n">splrep</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="c1"># define zero coupon curve - divid by 100 to get yields to decimal number</span>
<span class="n">zero_curve_spline</span> <span class="o">=</span> <span class="n">splrep</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="n">zero_yields</span> <span class="o">/</span> <span class="mi">100</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=01d743f6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">One possibility would also just be to type the cash flow matrix manually...</span>
<span class="sd">"""</span>

<span class="n">coupon</span> <span class="o">=</span> <span class="mf">0.04</span>

<span class="c1"># define maturities</span>
<span class="n">maturities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">13</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="mi">20</span><span class="p">])</span>

<span class="c1"># prices </span>
<span class="n">prices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="c1"># cash flow time points</span>
<span class="n">term_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="c1"># cash flows </span>
<span class="n">flow_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="c1"># loop over all maturities </span>
<span class="k">for</span> <span class="n">maturity</span> <span class="ow">in</span> <span class="n">maturities</span><span class="p">:</span> 
    
    <span class="c1"># create cash flow time points</span>
    <span class="n">terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">maturity</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="c1"># create cash flow</span>
    <span class="n">flows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="mf">0.04</span> 
    <span class="n">flows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span>
    
    <span class="c1"># store info</span>
    <span class="n">term_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
    <span class="n">flow_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flows</span><span class="p">)</span>
    
    <span class="c1"># calculate price</span>
    <span class="n">prices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">flows</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">terms</span> <span class="o">*</span> <span class="n">splev</span><span class="p">(</span><span class="n">terms</span><span class="p">,</span> <span class="n">zero_curve_spline</span><span class="p">))))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=60e13941">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_res</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">maturities</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">prices</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">"Price"</span><span class="p">])</span>
<span class="n">df_res</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">name</span><span class="o">=</span><span class="s2">"Maturity"</span>
<span class="n">df_res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=4b2974cf">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=dfbda107">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># Get union of all cash flow time points </span>
<span class="n">all_terms</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span> <span class="n">term_info</span><span class="p">)</span>

<span class="c1"># define the shape of the cash flow matrix </span>
<span class="n">cash_flow_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">maturities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">all_terms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="c1"># create the cash flow matrix </span>
<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">terms</span><span class="p">,</span> <span class="n">flows</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">term_info</span><span class="p">,</span> <span class="n">flow_info</span><span class="p">):</span>
    
    <span class="n">indicator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">all_terms</span><span class="p">,</span> <span class="n">terms</span><span class="p">)</span>
    <span class="n">cash_flow_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">flows</span>
    
    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=788ccf11">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">maturities</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">cash_flow_matrix</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="n">all_terms</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ba7f4743">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=1300a933">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">liab_time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">21.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">liab_cash_flows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span>
                            <span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.3</span><span class="p">,</span> <span class="mf">1.2</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span>
                            <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> 
                            <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e6</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b887640d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">liab_time_points</span><span class="p">,</span> <span class="n">liab_cash_flows</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkgreen"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Liability cash flow"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Years in the future"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Mio. USD"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ae74e36a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=355275c3">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">num_time_points</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">liab_time_points</span><span class="p">)</span>
<span class="n">num_bonds</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">maturities</span><span class="p">)</span>

<span class="n">r_mat</span>  <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_time_points</span><span class="p">)</span>
<span class="n">r_mat</span><span class="p">[</span><span class="nb">range</span><span class="p">(</span><span class="n">num_time_points</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_time_points</span><span class="p">)]</span> <span class="o">=</span>  <span class="mi">1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=df0f57c1">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_bonds</span><span class="p">)</span>
<span class="n">s</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_time_points</span><span class="p">)</span>

<span class="n">c_mat</span> <span class="o">=</span> <span class="n">cash_flow_matrix</span>
<span class="n">b_vec</span> <span class="o">=</span> <span class="n">liab_cash_flows</span>
<span class="n">p_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">prices</span><span class="p">)</span>

<span class="n">problem</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">p_vec</span> <span class="o">@</span> <span class="n">x</span><span class="p">),</span>
                     <span class="p">[</span><span class="n">c_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">x</span> <span class="o">+</span> <span class="n">r_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">s</span> <span class="o">&amp;gt;=</span> <span class="n">b_vec</span><span class="p">,</span> <span class="n">x</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">s</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">])</span>

<span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="n">x</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=70c3ffea">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">liab_time_points</span><span class="p">,</span> <span class="n">liab_cash_flows</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkgreen"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">liab_time_points</span><span class="p">,</span> <span class="p">(</span><span class="n">c_mat</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">value</span><span class="p">)</span><span class="o">.</span><span class="n">cumsum</span><span class="p">()</span> <span class="o">/</span> <span class="mf">1e6</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">);</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Cummulative liability cash flow vs. hedge cash flow"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Years in the future"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Mio. USD"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7e5651b6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3:-OLS-vs.-MLE">
        Problem 3: OLS vs. MLE
        <a class="anchor-link" href="#Problem-3:-OLS-vs.-MLE">
         ¶
        </a>
       </h2>
       <p>
        Consider the regression model
       </p>
       $$
y_i = \alpha + \beta_1 x_{1, i} + \beta_{2, i} x_{2, i} + \varepsilon_i =  \mathbf{x}_i^\top \boldsymbol{\beta} + \varepsilon_i
$$
       <p>
        where $\alpha=1$, $\beta_1 = 1$, and $\beta_2 = 1$. Furthermore, assume that $x_{1, i} \sim  \log N(0, 1)$, $x_{2, i} \sim \log N(0, 1)$ and $\varepsilon_{i} + \xi + \omega \frac{\alpha}{\sqrt{1 + \alpha^2}} \sqrt{2 / \pi} \sim skew normal(\xi, \omega, \alpha)$ with $\xi=0$, $\omega=2$, $\alpha=2$ (we add the mean to make the error term have a mean of zero). The
        <a href="https://en.wikipedia.org/wiki/Skew_normal_distribution">
         skew normal
        </a>
        is defined by the density
       </p>
       $$
f(\varepsilon) = \frac{2}{\omega} \phi(\frac{\varepsilon - \xi}{\omega})\Phi(\alpha\frac{\varepsilon - \xi}{\omega})
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Simulate and estimate the model with OLS 10,000 times for different sample sizes. Plot the kernel density of the estimates. What do you observe, when the sample size increases?
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Simulate and estimate the model with MLE 10,000 times for different sample sizes. Restrict $\xi=0$. Plot the kernel density of the estimates. What do you observe, when the sample size increases?
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Compare the density of the OLS and MLE estimates. Also calculate the standard devation of the OLS estimates. What do you observe? Is this inline with your expectation.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5a33d5d3">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [54]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Settings</span>
<span class="sd">"""</span>

<span class="c1"># number of simulations</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">4999</span>

<span class="c1"># sample size </span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># true parameter values: constant, beta1, beta2</span>
<span class="n">beta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

<span class="n">alpha</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">omega</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">xi</span> <span class="o">=</span> <span class="mf">0.0</span>

<span class="sd">"""</span>
<span class="sd">Simulations</span>
<span class="sd">"""</span>

<span class="n">all_beta_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta0</span><span class="p">)))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span> 
    
    <span class="c1"># generate independent variables</span>
    <span class="n">x1_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span> 
    <span class="n">x2_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="n">x_mat_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span> <span class="n">x1_sim</span><span class="p">,</span> <span class="n">x2_sim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># simulate error term</span>
    <span class="n">eps_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skewnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">loc</span><span class="o">=-</span><span class="n">omega</span><span class="o">*</span><span class="n">alpha</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                                 <span class="n">scale</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>

    <span class="c1"># simulate dependent variable</span>
    <span class="n">y_sim</span> <span class="o">=</span> <span class="n">x_mat_sim</span> <span class="o">@</span> <span class="n">beta0</span> <span class="o">+</span> <span class="n">eps_sim</span>
    
    <span class="c1"># estimate parameters</span>
    <span class="n">beta_est</span><span class="p">,</span> <span class="n">res</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">x_mat_sim</span><span class="p">,</span> <span class="n">y_sim</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=-</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="n">all_beta_est</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">beta_est</span>

<span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>
    
<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 0: constant, 1: beta1, 2: beta2</span>
<span class="n">param_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">alpha$'</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_1$'</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_2$'</span><span class="p">}</span>
<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_beta_est</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta0</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated distribution"</span><span class="p">)</span>

<span class="n">norm_params</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

<span class="n">vals_to_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vals_to_eval</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">norm_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">vals_to_eval</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">"Fitted normal distribution"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of OLS estimator for "</span> <span class="o">+</span> <span class="n">param_name_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">", sample size: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_size</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1dba4190-03b2-4c71-9f95-c55121673b60">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [55]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">stats</span><span class="o">.</span><span class="n">skewnorm</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">loc</span><span class="o">=-</span><span class="n">omega</span><span class="o">*</span><span class="n">alpha</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                                 <span class="n">scale</span><span class="o">=</span><span class="n">omega</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b7b37a35">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=308c27a8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [56]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define log-likelihood function</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">log_like_lin_reg</span><span class="p">(</span><span class="n">params</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="n">beta</span> <span class="o">=</span> <span class="n">params</span><span class="p">[:</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">omega</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
    
    <span class="n">loc</span> <span class="o">=</span> <span class="o">-</span><span class="n">omega</span> <span class="o">*</span> <span class="n">alpha</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
    
    <span class="n">eps</span> <span class="o">=</span> <span class="n">y</span> <span class="o">-</span> <span class="n">x</span> <span class="o">@</span> <span class="n">beta</span>
    
    <span class="n">log_like</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skewnorm</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">eps</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">loc</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span> 
        <span class="k">return</span> <span class="o">-</span><span class="n">log_like</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ce1cde61">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [61]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Settings</span>
<span class="sd">"""</span>

<span class="c1"># number of simulations</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">4999</span>

<span class="c1"># sample size </span>
<span class="n">sample_size</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># true parameter values: constant, beta1, beta2</span>
<span class="n">beta0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

<span class="sd">"""</span>
<span class="sd">Simulations</span>
<span class="sd">"""</span>

<span class="n">all_beta_est_mle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">beta0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span> 
    
    <span class="c1"># generate independent variables</span>
    <span class="n">x1_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span> 
    <span class="n">x2_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>
    <span class="n">x_mat_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">sample_size</span><span class="p">),</span> <span class="n">x1_sim</span><span class="p">,</span> <span class="n">x2_sim</span><span class="p">])</span><span class="o">.</span><span class="n">T</span>

    <span class="c1"># simulate error term</span>
    <span class="n">eps_sim</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">skewnorm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">loc</span><span class="o">=-</span><span class="n">omega</span><span class="o">*</span><span class="n">alpha</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">alpha</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">),</span>
                                 <span class="n">scale</span><span class="o">=</span><span class="n">omega</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">sample_size</span><span class="p">)</span>

    <span class="c1"># simulate dependent variable</span>
    <span class="n">y_sim</span> <span class="o">=</span> <span class="n">x_mat_sim</span> <span class="o">@</span> <span class="n">beta0</span> <span class="o">+</span> <span class="n">eps_sim</span>
    
    <span class="c1"># estimate parameters</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">log_like_lin_reg</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">],</span>
                            <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_sim</span><span class="p">,</span> <span class="n">x_mat_sim</span><span class="p">),</span>
                            <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span>
                                    <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">)))</span> <span class="c1"># add some reasonable constraints</span>
    
    <span class="c1"># store parameter estimates</span>
    <span class="n">all_beta_est_mle</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

<span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>
    
<span class="n">idx</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># 0: constant, 1: beta1, 2: beta2</span>
<span class="n">param_name_dict</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">alpha$'</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_1$'</span><span class="p">,</span> <span class="mi">2</span><span class="p">:</span> <span class="s1">'$</span><span class="se">\\</span><span class="s1">beta_2$'</span><span class="p">}</span>
<span class="n">diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_beta_est_mle</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta0</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">diff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated distribution"</span><span class="p">)</span>

<span class="n">norm_params</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">diff</span><span class="p">)</span>

<span class="n">vals_to_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="nb">min</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="nb">max</span><span class="p">(</span><span class="n">diff</span><span class="p">),</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">vals_to_eval</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">norm_params</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">norm_params</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">vals_to_eval</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span>
        <span class="n">label</span><span class="o">=</span><span class="s2">"Fitted normal distribution"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of MLE estimator for "</span> <span class="o">+</span> <span class="n">param_name_dict</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">+</span> <span class="s2">", sample size: </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_size</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=9ff7c98a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=46da7ef6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [62]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">diff_ols</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_beta_est</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta0</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">diff_ols</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated distribution [OLS]"</span><span class="p">)</span>

<span class="n">diff_mle</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_beta_est_mle</span><span class="p">[:,</span> <span class="n">idx</span><span class="p">]</span> <span class="o">-</span> <span class="n">beta0</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">sample_size</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">diff_mle</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated distribution [MLE]"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7c00896f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [63]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">diff_mle</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a557c313">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [64]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">diff_ols</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8963cb7c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The MLE should be more efficient than the OLS - so this is inline with our expectation!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=tender-forestry">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4:-Recession-forecasting-%5Boptional%5D">
        Problem 4: Recession forecasting [optional]
        <a class="anchor-link" href="#Problem-4:-Recession-forecasting-%5Boptional%5D">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Note:
        </strong>
        We follow the exposition of
        <a href="https://onlinelibrary-wiley-com.esc-web.lib.cbs.dk:8443/doi/abs/10.1002/for.1161">
         Nyberg (2010)
        </a>
       </p>
       <p>
        In this exercise, we will explore a simple model for forecasting US recessions. Among other things, we will look at the evidence for the yield spread being a predictor of recessions as often mentioned in financial news (and the academic literature).
       </p>
       <p>
        We are interested in prediciting the recession indicator $y_t, \; t=1,..., T$ which is a binary dependent variable that is defined by
       </p>
       $$
y_t = \left\{ \begin{matrix}
                1, &amp;amp; \text{if the economy is in a recessionary state at time } t \\ 
                0, &amp;amp; \text{if the economy is in a expansionary state at time } t
              \end{matrix}  \right.
$$
       <p>
        The probability of the dependent variable taking the value $1$ is given by $p_t$ specified as
       </p>
       $$
p_t = \text{Prob}_{t-1}[y_t = 1] = \Phi(\pi_{t})
$$
       <p>
        where $\Phi()$ is the cdf of a standard normal. $\pi_{t}$ is included in the information set at time $t-1$. This model is known as a
        <a href="https://en.wikipedia.org/wiki/Probit_model">
         Probit model
        </a>
        .
       </p>
       <p>
        A model not taking the dynamic structure into account is given by the static formulation ($k \leq 1$ must be larger than the forecast horizon)
       </p>
       $$
\pi_{t} = \mathbf{x}_{t-k}^\top \beta
$$
       <p>
        A dynamic structure can be implemented as ($l \leq 1$)
       </p>
       $$
\pi_{t} = \mathbf{x}_{t-k}^\top \beta + \delta y_{t-l}
$$
       <p>
        A dynamic autoregressive model can be implemented as
       </p>
       $$
\pi_{t} = \mathbf{x}_{t-k}^\top \beta + \delta y_{t-l} + \alpha \pi_{t-1}
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Get recession indicators ('USREC') and yield spread ('T10YFF') from the FRED database from the beginning of 1983. Plot the yield spread together with the recession indicators.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        First, we will consider a model where we solely use the yield spread (and a constant) to predict recessions. To that end, we need to define the likelihood function.
       </p>
       <p>
        The conditional probability function is given by
       </p>
       $$
f_{Y_t}(y_t \vert \mathbf{x}_t, \mathbf{x}_{t-1},..., y_{t-1},...; \theta)   = p_t^{y_t} (1 - p_t)^{1 - y_t} = \Phi(\pi_{t})^{y_t} (1 - \Phi(\pi_{t}))^{1 - y_t}
$$
       <p>
        We can therefore write the (conditional) likelihood function as
       </p>
       $$
L_T(\theta) = \prod_{t=1}^T \Phi(\pi_{t})^{y_t} (1 - \Phi(\pi_{t}))^{1 - y_t}
$$
       <p>
        and the log-likelihood function as
       </p>
       $$
\mathcal{L}_{T}(\theta) = \sum_{t=1}^T q_t(y_t, \mathbf{x}_t; \theta) = \sum_{t=1}^T \left[y_t \ln \Phi(\pi_{t}) + (1-y_t) \ln (1 - \Phi(\pi_{t}))  \right]
$$
       <p>
        Assume that $\pi_{t} = \mathbf{x}_{t-k}^\top \beta$ with $\mathbf{x}_{t-k} = [1, ys_{t-k}]^\top$ where $ys_{t}$ is the yield-spread at time $t$. Consider $k=6$. Estimate the model using maximum-likelihood.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Derive the expressions for
       </p>
       $$
\begin{align}
\frac{1}{n} \sum_{i=1}^n  \frac{\partial^2 q_t(y_t, \mathbf{x}_t; \theta)}{\partial \theta \partial \theta^\top}  \\
\frac{1}{n} \sum_{i=1}^n \frac{\partial q_t(y_t, \mathbf{x}_t; \theta)}{\partial \theta } \frac{\partial q_t(y_t, \mathbf{x}_t; \theta)}{\partial \theta^\top }  
\end{align}
$$
       <p>
        when considering the static model. It may be usefull to remember that
       </p>
       $$
\frac{\partial \Phi(\pi_t)}{\partial \theta} = \phi(\pi_t) \frac{\partial \pi_t}{\partial \theta}  = \phi(\pi_t) \mathbf{x}_{t-k}
$$
       <p>
        where $\phi(\pi_t)$ is the density of a standard normal and
       </p>
       $$
\frac{\partial \phi(\pi_t)}{\partial \theta} = -\phi(\pi_t) \pi_t \frac{\partial \pi_t}{\partial \theta}
$$
       <p>
        Implement functions that calculate these quantities.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Calculate the standard errors analytically and numerically.
       </p>
       <p>
        <strong>
         Quesiton 5
        </strong>
       </p>
       <p>
        Check the results using
        <code>
         statsmodels
        </code>
        . Are the parameters significant at a 5% significance level?
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        Implement and estimate the dynamic model.
       </p>
       $$
\pi_{t} = \mathbf{x}_{t-k}^\top \beta + \delta y_{t-l}
$$
       <p>
        <strong>
         Question 7
        </strong>
       </p>
       <p>
        Implement and estimate the autoregressive model.
       </p>
       $$
\pi_{t} = \mathbf{x}_{t-k}^\top \beta  + \alpha \pi_{t-1}
$$
       <p>
        <strong>
         Note:
        </strong>
        We have only considered in-sample results which may not work out-of-sample.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=interim-signal">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_data</span> <span class="o">=</span> <span class="n">DataReader</span><span class="p">([</span><span class="s1">'USREC'</span><span class="p">,</span> <span class="s1">'T10YFF'</span><span class="p">,</span> <span class="s1">'T10Y3M'</span><span class="p">],</span> <span class="s1">'fred'</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">1983</span><span class="p">,</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=suitable-mexico">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_data</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=approximate-checklist">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_data_monthly</span> <span class="o">=</span> <span class="n">df_data</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">'M'</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">df_data_monthly</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">index</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=identical-spyware">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">nber_recessions</span> <span class="o">=</span> <span class="n">df_data_monthly</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># get start and end dates of recessions</span>
<span class="n">change_nber</span> <span class="o">=</span> <span class="n">nber_recessions</span> <span class="o">-</span> <span class="n">nber_recessions</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">start_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="o">==</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">end_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="o">==-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">df_data_monthly</span><span class="p">[</span><span class="s1">'T10YFF'</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">));</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Term spread (in %)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_dates</span><span class="p">,</span> <span class="n">end_dates</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=applicable-evening">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        First, we implement the log-likelihood function
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=foster-dimension">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Log-likelihood function </span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">log_like_probit</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    
    <span class="n">pi</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="n">beta</span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    
    <span class="n">log_like</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span> 
        <span class="k">return</span> <span class="o">-</span><span class="n">log_like</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=alpha-groove">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Next, we select the data which we want to use
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=wicked-database">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">k</span> <span class="o">=</span> <span class="mi">6</span>
<span class="n">y_data</span> <span class="o">=</span> <span class="n">df_data_monthly</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span>
<span class="n">x_data</span> <span class="o">=</span> <span class="n">df_data_monthly</span><span class="p">[</span><span class="s1">'T10YFF'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="n">k</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x_data</span><span class="p">),</span> <span class="n">x_data</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=addressed-cookbook">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Minimize negative log-likelihood </span>
<span class="sd">"""</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">log_like_probit</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.13</span><span class="p">,</span><span class="mf">0.0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">))</span>
<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=chemical-leisure">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_data_monthly</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>

<span class="c1"># get start and end dates of recessions</span>
<span class="n">change_nber</span> <span class="o">=</span> <span class="n">nber_recessions</span> <span class="o">-</span> <span class="n">nber_recessions</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">start_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="o">==</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">end_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="o">==-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Recession probability (in %)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_dates</span><span class="p">,</span> <span class="n">end_dates</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=indian-capture">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        We note that
       </p>
       $$
q_t(y_t, \mathbf{x}_t; \theta) = y_t \ln \Phi(\pi_{t}) + (1-y_t) \ln (1 - \Phi(\pi_{t}))
$$
       <p>
        First, we find the gradient (using the chain-rule, derivative of natural logarithm, fundamental theorem of calculus, etc.)
       </p>
       $$
\begin{align}
\frac{\partial q_t(y_t, \mathbf{x}_t; \theta)}{\partial \theta} &amp;amp;= \left[y_t \frac{1}{\Phi(\pi_{t})} - (1-y_t) \frac{1}{1 -\Phi(\pi_{t})} \right] \frac{\partial \Phi(\pi_{t})}{\partial \theta}\\
&amp;amp;= \left[y_t \frac{1}{\Phi(\pi_{t})} - (1-y_t) \frac{1}{1 -\Phi(\pi_{t})} \right] \phi(\pi_{t})\frac{\partial \pi_{t}}{\partial \theta} \\
&amp;amp;= \left[y_t \frac{1}{\Phi(\pi_{t})} - (1-y_t) \frac{1}{1 -\Phi(\pi_{t})} \right] \phi(\pi_{t})\mathbf{x}_t
\end{align}
$$
       <p>
        Implying that
       </p>
       $$
\begin{align}
\frac{1}{n} \sum_{i=1}^n \frac{\partial q_t(y_t, \mathbf{x}_t; \theta)}{\partial \theta } \frac{\partial q_t(y_t, \mathbf{x}_t; \theta)}{\partial \theta^\top }  = \frac{1}{n} \sum_{i=1}^n \left[y_t \frac{1}{\Phi(\pi_{t})} - (1-y_t) \frac{1}{1 -\Phi(\pi_{t})} \right]^2 \phi(\pi_{t})^2\mathbf{x}_t\mathbf{x}_t^\top
\end{align}
$$
       <p>
        The Hessian is given by
       </p>
       $$
\begin{align}
\frac{\partial^2 q_t(y_t, \mathbf{x}_t; \theta)}{\partial \theta \partial \theta^\top} &amp;amp;= \frac{\partial}{\partial \theta}\left[y_t \frac{1}{\Phi(\pi_{t})} - (1-y_t) \frac{1}{1 -\Phi(\pi_{t})} \right] \phi(\pi_{t})\mathbf{x}_t^\top \\
&amp;amp;= \left[\frac{\partial}{\partial \theta}\left[y_t \frac{1}{\Phi(\pi_{t})} - (1-y_t) \frac{1}{1 -\Phi(\pi_{t})} \right] \phi(\pi_{t})\mathbf{x}_t^\top \right] + \left[y_t \frac{1}{\Phi(\pi_{t})} - (1-y_t) \frac{1}{1 -\Phi(\pi_{t})} \right] \frac{\partial}{\partial \theta}\phi(\pi_{t})\mathbf{x}_t^\top \\
&amp;amp;=\left[-y_t \frac{1}{\Phi(\pi_{t})^2} - (1-y_t) \frac{1}{(1 -\Phi(\pi_{t}))^2} \right] \phi(\pi_{t})\mathbf{x}_t\phi(\pi_{t})\mathbf{x}_t^\top - \left[y_t \frac{1}{\Phi(\pi_{t})} - (1-y_t) \frac{1}{1 -\Phi(\pi_{t})} \right]  \phi(\pi_{t}) \mathbf{x}_t^\top \beta \mathbf{x}_t \mathbf{x}_t^\top \\
&amp;amp;=-\left[y_t \frac{\phi(\pi_{t}) + \mathbf{x}_t^\top \beta \Phi(\pi_{t})}{\Phi(\pi_{t})^2} + (1-y_t) \frac{\phi(\pi_{t}) - (1 -\Phi(\pi_{t}))\mathbf{x}_t^\top \beta}{(1 -\Phi(\pi_{t}))^2} \right] \phi(\pi_{t})\mathbf{x}_t\mathbf{x}_t^\top 
\end{align}
$$
       <p>
        Below, we implement the expressions.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=deluxe-dietary">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Gradient (outer product of the scores)</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">outer_gradient</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> 
    
    <span class="n">pi</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="n">theta</span> 
    <span class="n">pdf_vals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">cdf_vals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    
    <span class="n">first_part</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">cdf_vals</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">cdf_vals</span><span class="p">)))</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">pdf_vals</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">first_part</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,jk-&amp;gt;jik'</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="w">    </span>

<span class="sd">"""</span>
<span class="sd">Hessian </span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">hessian</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> 
    
    <span class="n">pi</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="n">theta</span> 
    <span class="n">pdf_vals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="n">cdf_vals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    
    <span class="n">first_part</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">y</span> <span class="o">*</span> <span class="p">(</span><span class="n">pdf_vals</span> <span class="o">+</span> <span class="n">pi</span> <span class="o">*</span> <span class="n">cdf_vals</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">cdf_vals</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span> 
                   <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">pdf_vals</span> <span class="o">-</span> <span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">cdf_vals</span><span class="p">))</span> <span class="o">/</span> <span class="p">((</span><span class="mi">1</span><span class="o">-</span><span class="n">cdf_vals</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">pdf_vals</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">first_part</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,jk-&amp;gt;jik'</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sealed-plaza">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=mighty-cisco">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">params_mle</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">hessian</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">outer_gradient</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>

<span class="n">param_mle_cov_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">A</span><span class="p">)</span>

<span class="n">param_mle_cov_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>

<span class="n">param_mle_cov_sandwich</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=advance-customs">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A</span>
<span class="n">param_mle_cov_A</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=premium-aquarium">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on B</span>
<span class="n">param_mle_cov_B</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=multiple-border">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A^{-1}BA^{-1} "Sandwich formula"</span>
<span class="n">param_mle_cov_sandwich</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=adjusted-producer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># sandwich standard errors </span>
<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">param_mle_cov_sandwich</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=banned-income">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [48]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Numerical scores</span>
<span class="sd">"""</span>

<span class="n">scores</span> <span class="o">=</span> <span class="n">approx_fprime</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">log_like_probit</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
<span class="n">B_approx</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">scores</span> 

<span class="n">A_approx</span> <span class="o">=</span> <span class="o">-</span><span class="n">approx_hess</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">log_like_probit</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">))</span>

<span class="n">param_mle_cov_A_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">A_approx</span><span class="p">)</span>

<span class="n">param_mle_cov_B_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">B_approx</span><span class="p">)</span>

<span class="n">param_mle_cov_sandwich_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A_approx</span><span class="p">)</span> <span class="o">@</span> <span class="n">B_approx</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A_approx</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=established-ready">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [49]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A</span>
<span class="n">param_mle_cov_A_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=hired-venture">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [50]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on B</span>
<span class="n">param_mle_cov_B_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=stretch-contribution">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [51]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A^{-1}BA^{-1} "Sandwich formula"</span>
<span class="n">param_mle_cov_sandwich_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=competitive-commonwealth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [52]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># sandwich standard errors </span>
<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">param_mle_cov_sandwich_num</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=round-advertising">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        Yes, both the constant and the term spread is highly signficant.
       </p>
       <p>
        Luckily, we get the same results as
        <code>
         statsmodels
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=centered-constitutional">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [53]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="n">stat_est</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">Probit</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s1">'HC0'</span><span class="p">)</span>
<span class="n">stat_est</span><span class="o">.</span><span class="n">summary</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=developed-operations">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 6
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=indirect-holder">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [54]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_dynamic_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">x_data</span><span class="p">,</span> <span class="n">df_data_monthly</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">k</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=solid-cooperative">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [55]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res_dynamic</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">log_like_probit</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_dynamic_data</span><span class="p">))</span>
<span class="n">res_dynamic</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=continued-number">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [56]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_data_monthly</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x_dynamic_data</span> <span class="o">@</span> <span class="n">res_dynamic</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>

<span class="c1"># get start and end dates of recessions</span>
<span class="n">change_nber</span> <span class="o">=</span> <span class="n">nber_recessions</span> <span class="o">-</span> <span class="n">nber_recessions</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">start_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="o">==</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">end_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="o">==-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Recession probability (in %)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_dates</span><span class="p">,</span> <span class="n">end_dates</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
    
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=champion-interview">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 7
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=individual-founder">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [57]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Log-likelihood function </span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">calculate_recession_probs</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> 
    
    <span class="n">beta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">pi</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="n">beta</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">+=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        
    <span class="n">prob</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">pi</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">prob</span>

<span class="k">def</span> <span class="nf">log_like_autoregressiv_probit</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
        
    <span class="n">prob</span> <span class="o">=</span> <span class="n">calculate_recession_probs</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
    
    <span class="n">log_like</span> <span class="o">=</span> <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">prob</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">y</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">prob</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span> 
        <span class="k">return</span> <span class="o">-</span><span class="n">log_like</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>
    
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=departmental-aaron">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [58]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">theta_init</span> <span class="o">=</span> <span class="p">[</span> <span class="o">-</span><span class="mf">1.03667616</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.831408</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">]</span>
<span class="n">res_auto</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">log_like_autoregressiv_probit</span><span class="p">,</span> <span class="n">theta_init</span><span class="p">,</span>
                             <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">),</span>
                             <span class="n">method</span><span class="o">=</span><span class="s1">'L-BFGS-B'</span><span class="p">,</span>
                             <span class="c1">#approx_grad=True,</span>
                             <span class="c1">#options={'eps': 1e-06,</span>
                             <span class="c1">#        'maxls':10},</span>
                             <span class="n">options</span><span class="o">=</span> <span class="p">{</span><span class="s2">"gtol"</span><span class="p">:</span> <span class="mf">1e-6</span><span class="p">,</span> <span class="s2">"ftol"</span><span class="p">:</span> <span class="mf">1e-16</span><span class="p">,</span> <span class="s2">"maxfun"</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s2">"maxiter"</span><span class="p">:</span> <span class="mi">30000</span><span class="p">,</span> <span class="s2">"maxls"</span><span class="p">:</span> <span class="mi">40</span><span class="p">},</span>
                             <span class="n">bounds</span> <span class="o">=</span> <span class="p">((</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">),(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">)))</span>
<span class="n">res_auto</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=perfect-money">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [59]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_data_monthly</span><span class="p">[</span><span class="s1">'USREC'</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">k</span><span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">calculate_recession_probs</span><span class="p">(</span><span class="n">res_auto</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">x_data</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>

<span class="c1"># get start and end dates of recessions</span>
<span class="n">change_nber</span> <span class="o">=</span> <span class="n">nber_recessions</span> <span class="o">-</span> <span class="n">nber_recessions</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
<span class="n">start_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="o">==</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>
<span class="n">end_dates</span> <span class="o">=</span> <span class="n">change_nber</span><span class="p">[</span><span class="n">change_nber</span><span class="o">==-</span><span class="mf">1.0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_list</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Recession probability (in %)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">''</span><span class="p">);</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">e</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">start_dates</span><span class="p">,</span> <span class="n">end_dates</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvspan</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">e</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"grey"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=martial-hybrid">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-5:-MLE-and-hypothesis-testing-%5Boptional%5D">
        Problem 5: MLE and hypothesis testing [optional]
        <a class="anchor-link" href="#Problem-5:-MLE-and-hypothesis-testing-%5Boptional%5D">
         ¶
        </a>
       </h2>
       <p>
        Consider the
        <a href="https://en.wikipedia.org/wiki/Gamma_distribution">
         Gamma distribution
        </a>
       </p>
       $$
f_{y}(y; \theta) = \frac{\beta^\rho}{\Gamma(\rho)} y^{\rho -1} e^{-y \beta}
$$
       <p>
        where $\theta = (\beta, \rho)^\top$, $\Gamma(\rho)$ is the
        <a href="https://en.wikipedia.org/wiki/Gamma_function">
         gamma function
        </a>
        .
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Simulate 1,000 observations assuming $\beta = 1$ and $\rho=1$ from a gamma distribution. Plot the histogram together with the true density.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Define the log-likelihood function and estimate the parameters. Note that the functions
        <code>
         scipy.special.gamma
        </code>
        ,
        <code>
         scipy.special.gammaln
        </code>
        , and
        <code>
         scipy.special.digamma
        </code>
        (
        <a href="https://en.wikipedia.org/wiki/Digamma_function">
         digamma function
        </a>
        ) may be relevant.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        The gradiant is given by
       </p>
       $$
\frac{\partial q_i(y_i ;\theta)}{\partial \theta } = \begin{bmatrix} \rho \frac{1}{\beta} - y_i \\ \ln \beta - \frac{\partial \ln \Gamma (\rho)}{\partial \rho} + \ln y_i\end{bmatrix}\\
$$
       <p>
        and therefore
       </p>
       $$
\frac{\partial q_i(y_i ;\theta)}{\partial \theta } \frac{\partial q_i(y_i ;\theta)}{\partial \theta^\top } = \begin{bmatrix} \rho \frac{1}{\beta} - y_i \\ \ln \beta - \frac{\partial \ln \Gamma (\rho)}{\partial \rho} + \ln y_i\end{bmatrix}\begin{bmatrix} \rho \frac{1}{\beta} - y_i \\ \ln \beta - \frac{\partial \ln \Gamma (\rho)}{\partial \rho} + \ln y_i\end{bmatrix}^\top = \begin{bmatrix} (\rho \frac{1}{\beta} - y_i)^2 &amp;amp; (\rho \frac{1}{\beta} - y_i) (\ln \beta - \frac{\partial \ln \Gamma (\rho)}{\partial \rho} + \ln y_i) \\
(\rho \frac{1}{\beta} - y_i) (\ln \beta - \frac{d \ln \Gamma (\rho)}{d \rho} + \ln y_i) &amp;amp; (\ln \beta - \frac{\partial \ln \Gamma (\rho)}{\partial \rho} + \ln y_i)^2 \end{bmatrix}
$$
       <p>
        and the Hessian is given by
       </p>
       $$
\frac{\partial^2 q_i(y_i ;\theta)}{\partial \theta \partial \theta^\top } = \begin{bmatrix} \frac{-\rho}{\beta^2}  &amp;amp; \frac{1}{\beta} \\
\frac{1}{\beta} &amp;amp; - \frac{d^2 \ln \Gamma (\rho)}{d \rho^2} \end{bmatrix}
$$
       <p>
        Define a function that returns
       </p>
       $$
\sum_{i=1}^n\frac{\partial^2 q_i(y_i ;\theta)}{\partial \theta \partial \theta^\top} = \sum_{i=1}^n \text{E} \left[ \frac{\partial^2 q_i(y_i ;\theta)}{\partial \theta \partial \theta^\top} \right] = \sum_{i=1}^n \begin{bmatrix} \frac{-\rho}{\beta^2}  &amp;amp; \frac{1}{\beta} \\
\frac{1}{\beta} &amp;amp; - \frac{d^2 \ln \Gamma (\rho)}{d \rho^2} \end{bmatrix}
$$
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        We remember that
       </p>
       $$
\hat{\theta}_{MLE} \sim^a N\left(\theta_0, -\left[ \sum_{i=1}^n \text{E} \left[ \left. \frac{\partial^2 q_i(y_i ;\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right]^{-1}\right)
$$
       <p>
        Since $\theta_0$ (in real life) is unkown, then we replace it with the obtained estimate. Calculate the standard errors of the estimator.
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        The MLE follows a multivariate normal distribution in the limit (for simplicity let $\mathbf{V}$ denote the asymptotic variance)
       </p>
       $$
\hat{\theta} \sim^a N(\theta_0, \mathbf{V})
$$
       <p>
        If we let $\mathbf{R}$ be a $(q \times k)$ matrix and $\mathbf{r}$ be a $q \times 1$ vector where $q$ is the number of restrictions and $k$ is the number of parameters (so 2 in the model we are considering here).
       </p>
       <p>
        Assuming the null hypothesis
       </p>
       $$
\text{H}_0 : \mathbf{R} \theta - \mathbf{r} = \mathbf{0}
$$
       <p>
        we will have (under the null hypothesis)
       </p>
       $$
\mathbf{R} \hat{\theta} - \mathbf{r} \sim^a N(\mathbf{0}, \mathbf{R}\mathbf{V}\mathbf{R}^\top)
$$
       <p>
        When testing a single hypothesis ($q=1$), we will have
       </p>
       $$
\frac{\mathbf{R} \hat{\theta} - \mathbf{r}}{\sqrt{\mathbf{R}\mathbf{V}\mathbf{R}^\top}} \sim^a N(0, 1)
$$
       <p>
        If we want to test the hypothesis $\text{H}_0: \beta=1$ vs. the alternative $\text{H}_A: \beta \neq 1$ in the model considered here, we simple choose $\mathbf{R} = [0, 1]$ and $\mathbf{r} = 1$ such that
       </p>
       $$
Z = \frac{\mathbf{R} \hat{\theta} - \mathbf{r}}{\sqrt{\mathbf{R}\mathbf{V}\mathbf{R}^\top}} = \frac{\hat{\beta} -  1}{\sqrt{V_{11}}} = \frac{\hat{\beta} -  1}{\sqrt{\text{Var}(\hat{\beta})}}  \sim^a N(0, 1)
$$
       <p>
        which is the well-known test statistic. We obtain the (two-side) $p$-value as $2 (1 - \Phi(\vert z \vert))$.
       </p>
       <p>
        Test the hypotheses that (one at the time) that $\beta=1$ and $\rho=1$.
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        We now want to test the joint hypothesis $\text{H}_0: \beta=1, \rho=1$ vs. the alternative $\text{H}_A: \beta \neq 1, \rho \neq 1$.
       </p>
       <p>
        To test this hypothesis, we have different possibilities:
       </p>
       <ul>
        <li>
         The likelihood ratio test
        </li>
        <li>
         The Wald test
        </li>
        <li>
         The Lagrange multiplier test
        </li>
       </ul>
       <p>
        <strong>
         The likelihood ratio test
        </strong>
       </p>
       <p>
        The basic idea is that we have some valid restrictions, say $\mathbf{c}(\theta) = \mathbf{r}$, then imposing it should not lead to a large reduction in the log-likelihood function. It is possible to show that the Likehood Ratio (LR) test statistic
       </p>
       $$
LR = - 2 (\ln L_n^R - \ln L_n^U) \sim \chi^2 (q)
$$
       <p>
        follows a chi-squared distribution with degrees of freedom equal to the number of restrictions, $q$. $L_n^R$ is the restricted likelihood function and $L_n^U$ is the unrestricted likelihood function.
       </p>
       <p>
        <strong>
         The Wald test
        </strong>
       </p>
       <p>
        If the restrictions are valid, then $\mathbf{c}(\hat{\theta}) - \mathbf{r}$ should be close to zero since the MLE is consistent. The wald test is based on $\mathbf{c}(\hat{\theta}) - \mathbf{r}$ and we will reject the hypothesis if this value is significantly different from zero. The wald test statistc can be written as
       </p>
       $$
W = [\mathbf{c}\left(\hat{\theta}\right) - \mathbf{r}]^\top \left(\mathbf{C} \mathbf{V} \mathbf{C}^\top \right)^{-1} [\mathbf{c}\left(\hat{\theta}\right) - \mathbf{r}] \sim \chi^2 (q)
$$
       <p>
        where $\mathbf{C} = \left. \frac{\partial \mathbf{c}(\theta)}{\partial \theta^\top} \right \vert_{\theta=\hat{\theta}}$.  For linear restrictions $\mathbf{R} \theta - \mathbf{r}$, we will have
       </p>
       $$
W = [\mathbf{R} \hat{\theta} - \mathbf{r}]^\top \left(\mathbf{R} \mathbf{V} \mathbf{R}^\top \right)^{-1} [\mathbf{R} \hat{\theta} - \mathbf{r}] \sim \chi^2 (q)
$$
       <p>
        <strong>
         The Lagrange multiplier test
        </strong>
       </p>
       <p>
        As the name entails, the test is related to the Lagrangian of the constrained problem
       </p>
       $$
\mathcal{L}^*_n(\theta) = \mathcal{L}_n (\theta) + \lambda^\top (\mathbf{c}(\theta) - \mathbf{r}) 
$$
       <p>
        The solution to this constrained problem satisfies the the first order conditions
       </p>
       $$
\begin{align}
\frac{\partial \mathcal{L}_n^* (\theta)}{\partial \theta}&amp;amp;=\frac{\partial \mathcal{L}_n (\theta)}{\partial \theta} + \mathbf{C}^\top \lambda = \mathbf{0}\\
\frac{\partial \mathcal{L}_n^* (\theta)}{\partial \lambda}&amp;amp;= \mathbf{c}(\theta) - \mathbf{r} = \mathbf{0}
\end{align}
$$
       <p>
        The restrictions not being binding corresponds to $\lambda = \mathbf{0}$ why we may define the null hypothesis as $\text{H}_0: \lambda= \mathbf{0}$ (i.e. the lagrange multiplier being equal to zero). A more common approach is obtained by noting that evaluated at the restricted estimate, then the score should be close to zero
       </p>
       $$
\hat{\mathbf{g}}_R = \left. \frac{\partial \mathcal{L}_n (\theta)}{\partial \theta} \right \vert_{\theta = \hat{\theta}_R} = \hat{\mathbf{C}}^\top \lambda = \mathbf{0}
$$
       <p>
        Under the nulll hypothesis the Lagrange Multiplier test statistic
       </p>
       $$
\left[\left. \frac{\partial \mathcal{L}_n (\theta)}{\partial \theta} \right \vert_{\theta = \hat{\theta}_R}  \right]^\top    \mathbf{V}_R \left[ \left. \frac{\partial \mathcal{L}_n (\theta)}{\partial \theta} \right \vert_{\theta = \hat{\theta}_R} \right] \sim \chi^2 (q)
$$
       <p>
        where $\mathbf{V}_R $ is the asymptotic variance of the restricted model. One advantage of the LM test is that we only need to estimate the model under the null hypothesis!
       </p>
       <p>
        Implement all the three above tests.
       </p>
       <p>
        <strong>
         Question 7
        </strong>
       </p>
       <p>
        <a href="https://en.wikipedia.org/wiki/Size_(statistics)">
         <em>
          Size
         </em>
        </a>
        and
        <a href="https://en.wikipedia.org/wiki/Power_of_a_test">
         <em>
          power
         </em>
        </a>
        are two key properties of a test.  Size is the probability of commiting a type I error, i.e. rejecting a true null hypothesis and power is the probability of rejecting a false null hypothesis.
       </p>
       <p>
        The distributions used above for testing hypotheses about the parameters rely on asymptotic theory, but this may be a bad approximation in small samples.
       </p>
       <p>
        For different sample sizes, e.g. 100, 250, 500, 1000, using at least 10,000 simulated samples check how well the LR test statistic from a above follows a $\chi^2(q)$ distribution.
       </p>
       <p>
        <strong>
         Question 8
        </strong>
       </p>
       <p>
        How often does the LR-statistic exceed the 5% critical value for each of the sample sizes?
       </p>
       <p>
        <strong>
         Question 9
        </strong>
       </p>
       <p>
        We want to examine the power of the LR test. To calculate the probability of rejecting the null hypothesis (we keep the one from above) given that it is false, then we need to assume some true alternative. We will assume that $\beta=1.25$. Redo the simulation and calculate how many times LR-statistic exceed the 5% critical value for each of the sample sizes.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=wrong-occasion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [60]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">beta_true</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">rho_true</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">y_data</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">rho_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">beta_true</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=biological-facility">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [61]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># density</span>
<span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pdf_vals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">a</span><span class="o">=</span><span class="n">rho_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">beta_true</span><span class="p">)</span>

<span class="c1"># plotting </span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">30</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Simulated data"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_vals</span><span class="p">,</span> <span class="n">pdf_vals</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True pdf"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"y"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Density"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=pregnant-promotion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        The likelihood function can be written as
       </p>
       $$
L_n(\theta) = \prod_{i=1}^n \frac{\beta^\rho}{\Gamma(\rho)} y_i^{\rho -1} e^{-y_i \beta}
$$
       <p>
        Taking the natural logarithm yields
       </p>
       $$
\mathcal{L}_{n}(\theta) = \sum_{i=1}^n q_i(y_i; \theta) = \sum_{i=1}^n \left[\rho \ln \beta - \ln \Gamma (\rho) + (\rho - 1) \ln y_i - y_i \beta \right] = n \left[\rho \ln \beta - \ln \Gamma (\rho) \right] + \sum_{i=1}^n \left[(\rho - 1) \ln y_i - y_i \beta \right]
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=compliant-bibliography">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [62]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">scipy.special</span> <span class="kn">import</span> <span class="n">gamma</span><span class="p">,</span> <span class="n">gammaln</span><span class="p">,</span> <span class="n">psi</span><span class="p">,</span> <span class="n">polygamma</span>

<span class="sd">"""</span>
<span class="sd">Define log-likelihood </span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">log_like_gamma</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>  <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="n">beta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="n">log_like</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span> <span class="o">-</span> <span class="n">gammaln</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">rho</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">-</span> <span class="n">y</span> <span class="o">*</span> <span class="n">beta</span>
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span> 
        <span class="k">return</span> <span class="o">-</span><span class="n">log_like</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>
<span class="w">    </span>

<span class="sd">"""</span>
<span class="sd">Minimize negative log-like </span>
<span class="sd">"""</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">log_like_gamma</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="p">))</span>
<span class="n">params_mle</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=massive-option">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=average-portable">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [63]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">gamma_log_like_hessian</span><span class="p">(</span><span class="n">theta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the Hessian of the log-likelihood function </span>
<span class="sd">    """</span>
    
    <span class="n">beta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="n">hess</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="n">rho</span> <span class="o">/</span> <span class="p">(</span><span class="n">beta</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">beta</span><span class="p">],</span> <span class="p">[</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">beta</span><span class="p">,</span> <span class="o">-</span> <span class="n">polygamma</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rho</span><span class="p">)]])</span>
    
    <span class="k">return</span> <span class="n">n</span> <span class="o">*</span> <span class="n">hess</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=loving-shelf">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=surprising-edward">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [64]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">gamma_log_like_hessian</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>
<span class="n">V</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=worse-cocktail">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=loved-parish">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [65]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Testing beta=1</span>
<span class="sd">"""</span>

<span class="n">z_beta</span> <span class="o">=</span> <span class="p">(</span><span class="n">params_mle</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>

<span class="n">p_value_beta</span> <span class="o">=</span>  <span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z_beta</span><span class="p">)))</span>
<span class="n">p_value_beta</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=alert-conditions">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [66]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Testing rho=1</span>
<span class="sd">"""</span>

<span class="n">z_rho</span> <span class="o">=</span> <span class="p">(</span><span class="n">params_mle</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">V</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">p_value_rho</span> <span class="o">=</span>  <span class="mf">2.0</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">z_rho</span><span class="p">)))</span>
<span class="n">p_value_rho</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=outside-gabriel">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 6
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=classical-cycling">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [67]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">LR test</span>
<span class="sd">"""</span>

<span class="n">like_ratio</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">log_like_gamma</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">y_data</span><span class="p">)</span> <span class="o">-</span> 
                  <span class="n">log_like_gamma</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">y_data</span><span class="p">))</span>

<span class="n">p_val_lr</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">like_ratio</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"LR: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">like_ratio</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"p-value: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_val_lr</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=tamil-lotus">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [68]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Wald test</span>
<span class="sd">"""</span>
<span class="n">R</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">constraint</span> <span class="o">=</span> <span class="p">(</span><span class="n">R</span> <span class="o">@</span> <span class="n">params_mle</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span>
<span class="n">cov_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">R</span> <span class="o">@</span> <span class="n">V</span> <span class="o">@</span> <span class="n">R</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

<span class="n">wald</span> <span class="o">=</span> <span class="n">constraint</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">cov_inv</span> <span class="o">@</span> <span class="n">constraint</span>
<span class="n">p_val_wald</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">wald</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"Wald: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">wald</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"p-value: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_val_wald</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=restricted-programmer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [69]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Lagrange Multiplier test</span>
<span class="sd">"""</span>

<span class="c1"># get covariance matrix of restricted model</span>
<span class="n">A_res</span> <span class="o">=</span> <span class="n">gamma_log_like_hessian</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">y_data</span><span class="p">)</span>
<span class="n">V_res</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A_res</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">V</span><span class="p">))</span>

<span class="c1"># define a function calculating the score (we could also do this numerically)</span>
<span class="k">def</span> <span class="nf">gamma_log_like_score</span><span class="p">(</span><span class="n">theta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the score of the log-likelihood function </span>
<span class="sd">    """</span>
    
    <span class="n">beta</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">rho</span> <span class="o">=</span> <span class="n">theta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="n">score_beta</span> <span class="o">=</span> <span class="n">rho</span> <span class="o">/</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">y</span>
    <span class="n">score_rho</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">rho</span><span class="p">)</span> <span class="o">-</span>  <span class="n">polygamma</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rho</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    <span class="n">score</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">column_stack</span><span class="p">((</span><span class="n">score_beta</span><span class="p">,</span> <span class="n">score_rho</span><span class="p">))</span>
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span>
        
        <span class="k">return</span> <span class="n">score</span>
    
    <span class="k">else</span><span class="p">:</span> 
    
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">score</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
<span class="c1"># calculate score</span>
<span class="n">score_restricted</span> <span class="o">=</span> <span class="n">gamma_log_like_score</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="c1"># LM stat</span>
<span class="n">lm</span> <span class="o">=</span> <span class="n">score_restricted</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">V_res</span> <span class="o">@</span> <span class="n">score_restricted</span>

<span class="n">p_val_lm</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">lm</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"LM: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">lm</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"p-value: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">p_val_lm</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=arranged-jersey">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [70]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">gamma_log_like_score</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=trying-prison">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [71]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># the numerical derivative will have a different sign since we have defined the negative log-likelihood</span>
<span class="n">approx_fprime</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">log_like_gamma</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=partial-section">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 7
        </strong>
       </p>
       <p>
        First, we simulate all the data that we need to use.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=expected-communist">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [72]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">beta_true</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">rho_true</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">y_data_all</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">rho_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">beta_true</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=retained-factory">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [73]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sample_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
<span class="n">output_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span>
        
        <span class="c1"># select data</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="n">y_data_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">sample_size</span><span class="p">]</span>

        <span class="c1"># estimate </span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">log_like_gamma</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,),</span>
                                <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mf">0.001</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
        <span class="c1"># calculate LR statistics </span>
        <span class="n">output_lr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">log_like_gamma</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">y_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_like_gamma</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y_data</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=presidential-northern">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [74]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Histogram and chi^2(2)</span>
<span class="sd">"""</span>
<span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">chi_pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">)):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">output_lr</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"n=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]),</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">1.0</span><span class="p">);</span> 
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">chi_pdf_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Asymptotic distribution"</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=strategic-visit">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 8
        </strong>
       </p>
       <p>
        The test seems to be well sized in the sense that the proportion of rejection the null hypothesis is close to the significance level.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=variable-wright">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [75]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">output_lr</span><span class="o">&amp;gt;</span><span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_sim</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=smaller-windows">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Questio 9
        </strong>
       </p>
       <p>
        Naturally, the power is increasing with the sample size!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=enclosed-monday">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [76]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">beta_true</span> <span class="o">=</span> <span class="mf">1.25</span>
<span class="n">rho_true</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">y_data_all</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">rho_true</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="n">beta_true</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=animal-david">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [77]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sample_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>
<span class="n">output_power_lr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">)))</span>

<span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">sample_size</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">sample_sizes</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span>
        
        <span class="c1"># select data</span>
        <span class="n">y_data</span> <span class="o">=</span> <span class="n">y_data_all</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:</span><span class="n">sample_size</span><span class="p">]</span>

        <span class="c1"># estimate </span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">log_like_gamma</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,),</span>
                                <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mf">0.001</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="kc">None</span><span class="p">)))</span>
        <span class="c1"># calculate LR statistics </span>
        <span class="n">output_power_lr</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">log_like_gamma</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">],</span> <span class="n">y_data</span><span class="p">)</span> <span class="o">-</span> <span class="n">log_like_gamma</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">y_data</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=regional-custody">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [78]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">output_power_lr</span><span class="o">&amp;gt;</span><span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.95</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_sim</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=alike-interest">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Statsmodels-implementation">
        Statsmodels implementation
        <a class="anchor-link" href="#Statsmodels-implementation">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=exempt-suspect">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [79]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.base.model</span> <span class="kn">import</span> <span class="n">GenericLikelihoodModel</span>

<span class="k">class</span> <span class="nc">GammaLogLModel</span><span class="p">(</span><span class="n">GenericLikelihoodModel</span><span class="p">):</span>
    
    <span class="n">nparams</span> <span class="o">=</span> <span class="mi">2</span>
    
    <span class="k">def</span> <span class="nf">loglike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        
        <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span>
        
        <span class="n">beta</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rho</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">stats</span><span class="o">.</span><span class="n">gamma</span><span class="o">.</span><span class="n">logpdf</span><span class="p">(</span><span class="n">endog</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">beta</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>


<span class="n">res</span> <span class="o">=</span> <span class="n">GammaLogLModel</span><span class="p">(</span><span class="n">y_data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">start_params</span><span class="o">=</span><span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>

<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=organizational-offense">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=meaning-arrow">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [80]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">t_test</span><span class="p">(</span><span class="s1">'par0=1'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=responsible-county">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [81]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">t_test</span><span class="p">(</span><span class="s1">'par1=1'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fallen-perry">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-6:-Shrinkage-estimators">
        Problem 6: Shrinkage estimators
        <a class="anchor-link" href="#Problem-6:-Shrinkage-estimators">
         ¶
        </a>
       </h2>
       <p>
        Assume that $\mathbf{X} \sim N(\boldsymbol{\mu}, \boldsymbol{\Sigma})$ is multivariate normal.
       </p>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Mean_squared_error">
         Mean-Squared-Error (MSE)
        </a>
        of the sample mean can be written as
       </p>
       $$
\text{MSE} \equiv \text{E}[\| \bar{\mathbf{X}} - \boldsymbol{\mu} \|^2] = \text{E}\left[\| \bar{\mathbf{X}} - \text{E}[\bar{\mathbf{X}}] \|^2 \right] + \left \|\text{E}[\bar{\mathbf{X}}] - \boldsymbol{\mu}\right \|^2 = \text{Var}[\bar{\mathbf{X}}] + \text{Bias}[\bar{\mathbf{X}}, \boldsymbol{\mu}]^2
$$
       <p>
        where $\| \cdot \|$ denotes the
        <a href="https://en.wikipedia.org/wiki/Norm_(mathematics)">
         norm
        </a>
        . Basically, this tells us that we can look at an estimator in relation to its bias and inefficiency (variance).
       </p>
       <p>
        In this exercise, we will see if we can find another estimator that performs better than the sample mean (in mean-square sense)
       </p>
       $$
\bar{\mathbf{X}} = \frac{1}{n} \sum_{i=1}^n \mathbf{X}_i
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Assume that
       </p>
       $$
\boldsymbol{\mu} = \begin{bmatrix} 0.0 \\ 0.0 \\ 0.1 \\ -0.1 \\ 0.2 \end{bmatrix}
$$
       <p>
        and for $\theta \in (0, 1)$
       </p>
       $$
\boldsymbol{\Sigma} = \begin{bmatrix}
1 &amp;amp; \theta &amp;amp; \dots &amp;amp; \theta \\
\theta &amp;amp; 1 &amp;amp; \ddots &amp;amp; \vdots \\
\theta &amp;amp; \theta &amp;amp; \ddots &amp;amp; \theta \\
\theta &amp;amp; \theta &amp;amp; \dots &amp;amp; 1 \\
\end{bmatrix}
$$
       <p>
        We can think of $\theta$ as representing the overall correlation among the random variables.
       </p>
       <p>
        For $\theta \in [0.0, 0.1, 0.2, ... , 0.9, 0.99]$ simulate 100 observations 10,000 times. Calculate the simulated value of the MSE for each different value of $\theta$ (remember that we know the true value of $\boldsymbol{\mu}$). Plot a stacked bar plot with MSE divided into variance and bias.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        <a href="https://www.amazon.com/Risk-Asset-Allocation-Springer-Finance/dp/3642009646">
         Attilio Meucci, "Risk and Asset Allocation"
        </a>
        presents the
        <a href="https://en.wikipedia.org/wiki/James%E2%80%93Stein_estimator">
         <em>
          James-Stein shrinkage estimator
         </em>
        </a>
        of the expected value
       </p>
       $$
\hat{\boldsymbol{\mu}} = (1-\alpha) \bar{\mathbf{X}} + \alpha \mathbf{b}
$$
       <p>
        where $\mathbf{b}$ is a constant vector. The optimal $\alpha$ is given by
       </p>
       $$
\alpha = \frac{1}{n} \frac{m \bar{\lambda} - 2 \lambda_1}{(\bar{\mathbf{X}} -  \mathbf{b})^\top (\bar{\mathbf{X}} -  \mathbf{b})}
$$
       <p>
        where  $m$ is the number of variables,  $\bar{\lambda}$ and $\lambda_1$ are respectively the average value and largest value of the eigenvalues of $\boldsymbol{\Sigma}$.
       </p>
       <p>
        We choose to shrink towards the "grand-mean"
       </p>
       $$
\frac{\mathbf{1}^\top \bar{X}}{m} \mathbf{1}
$$
       <p>
        where $\mathbf{1}$ is a m-dimensional vector of ones.
       </p>
       <p>
        Implement the estimator and perform the same calculations as in the previous question. Can the shrinkage estimator perform better than the sample mean?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=digital-magnitude">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [82]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">num_var</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">num_obs</span> <span class="o">=</span> <span class="mi">100</span>

<span class="n">theta_values</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.8</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]</span>
<span class="n">mu_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="c1"># standard normal random variables</span>
<span class="n">random_draws</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">))</span>

<span class="n">all_mse</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">all_bias</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> 
<span class="n">all_var</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">theta_values</span><span class="p">:</span> 
    
    <span class="c1"># construct corr / covariance matrix</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_var</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="c1"># Use cholesky decomposition to normal random variables</span>
    <span class="n">transformed_random_draws</span> <span class="o">=</span> <span class="n">mu_values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ij,jlk-&amp;gt;ilk'</span><span class="p">,</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">corr</span><span class="p">),</span> <span class="n">random_draws</span><span class="p">)</span>
    
    <span class="c1"># calculate average of all sample means</span>
    <span class="n">expected_sample_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">transformed_random_draws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># calculate the variance</span>
    <span class="n">var</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">transformed_random_draws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> 
                          <span class="n">expected_sample_mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># calculate the bias squared</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">expected_sample_mean</span> <span class="o">-</span> <span class="n">mu_values</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="c1"># calculate the total MSE (should be equal to var + bias)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">transformed_random_draws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu_values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># or just use np.trace(corr) / num_obs &amp;lt;- theoretical correct value</span>
    
    <span class="n">all_mse</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
    <span class="n">all_bias</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">all_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    
    
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=italian-walker">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [83]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">all_var</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Variance"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">all_bias</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">all_var</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Bias^2"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'MSE'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">theta$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Bias^2 and variance for the sample mean"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.175</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=failing-hurricane">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The sample mean is an unbiased estimator so the only problem is coming from the variance.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We see that with limited correlation between the variables, then the shrinkage estimator lowers the total MSE.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=japanese-interface">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [84]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_mse_shrink</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">all_bias_shrink</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span> 
<span class="n">all_var_shrink</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">theta</span> <span class="ow">in</span> <span class="n">theta_values</span><span class="p">:</span> 
    
    <span class="c1"># construct corr / covariance matrix</span>
    <span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span> <span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_var</span><span class="p">))</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="c1"># Use cholesky decomposition to normal random variables</span>
    <span class="n">transformed_random_draws</span> <span class="o">=</span> <span class="n">mu_values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ij,jlk-&amp;gt;ilk'</span><span class="p">,</span>
                                                                    <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">corr</span><span class="p">),</span> <span class="n">random_draws</span><span class="p">)</span>
    
    <span class="c1"># average and maximum eigenvalue</span>
    <span class="n">eig_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
    <span class="n">max_eig</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">)</span>
    <span class="n">avg_eig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">)</span>

    <span class="c1"># get grand mean</span>
    <span class="n">x_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">transformed_random_draws</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_bar</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># calculate optimal alpha</span>
    <span class="n">diff</span> <span class="o">=</span> <span class="n">x_bar</span> <span class="o">-</span> <span class="n">b</span>
    <span class="n">denominator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ij,ij-&amp;gt;j'</span><span class="p">,</span> <span class="n">diff</span><span class="p">,</span> <span class="n">diff</span><span class="p">)</span>

    <span class="n">alpha</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">num_obs</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">num_var</span> <span class="o">*</span> <span class="n">avg_eig</span> <span class="o">-</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">max_eig</span><span class="p">)</span>  <span class="o">/</span> <span class="n">denominator</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
    
    <span class="c1"># shrinkage estimator</span>
    <span class="n">mu_est</span> <span class="o">=</span> <span class="n">x_bar</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">alpha</span>

    <span class="c1"># calculate average of all mean estimates</span>
    <span class="n">expected_sample_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">mu_est</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># calculate the variance</span>
    <span class="n">var</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mu_est</span> <span class="o">-</span> <span class="n">expected_sample_mean</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="c1"># calculate bias squared</span>
    <span class="n">bias</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">expected_sample_mean</span> <span class="o">-</span> <span class="n">mu_values</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="c1"># calculate the total MSE (should be equal to var + bias)</span>
    <span class="n">mse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">mu_est</span> <span class="o">-</span> <span class="n">mu_values</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">all_mse_shrink</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mse</span><span class="p">)</span>
    <span class="n">all_bias_shrink</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bias</span><span class="p">)</span>
    <span class="n">all_var_shrink</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=hawaiian-potential">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [85]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>


<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">all_var</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Variance"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">all_bias</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">all_var</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Bias^2"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'MSE'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">theta$'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Bias^2 and variance for the sample mean"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.175</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">all_var_shrink</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Variance"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">all_bias_shrink</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">bottom</span><span class="o">=</span><span class="n">all_var_shrink</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Bias^2"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'MSE'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$</span><span class="se">\\</span><span class="s1">theta$'</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Bias^2 and variance for the Shrinkage estimator"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.175</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">2</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.com/Risk-Asset-Allocation-Springer-Finance/dp/3642009646">
         Attilio Meucci, "Risk and Asset Allocation"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># numpy for working with matrices</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># pandas</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># plotting libraries</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="c1"># working with dates</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># scipy of statistics and optimization</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>

<span class="c1"># typehints</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">codelib.dal.fred_yield_data</span> <span class="kn">import</span> <span class="n">get_nominal_yield_data</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">correlation_plot</span><span class="p">,</span> <span class="n">fan_chart</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span><span class="p">,</span> <span class="n">default_colors</span>
<span class="n">DefaultStyle</span><span class="p">();</span>

<span class="kn">from</span> <span class="nn">codelib.fixed_income.curves.vasicek_curve</span> <span class="kn">import</span> <span class="n">VasicekCurve</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-7">
        Exercises - Week 7
        <a class="anchor-link" href="#Exercises---Week-7">
         ¶
        </a>
       </h1>
       <p>
        In this week we will look at
       </p>
       <ul>
        <li>
         The Vasicek model
        </li>
        <li>
         Dynamic Nelson-Siegel model
        </li>
        <li>
         Principal components
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sapphire-talent">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1:-The-Vasicek-model">
        Problem 1: The Vasicek model
        <a class="anchor-link" href="#Problem-1:-The-Vasicek-model">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Note:
        </strong>
        The notation follows
        <a href="https://www.amazon.co.uk/Fixed-Income-Modelling-Claus-Munk/dp/0198716443">
         Claus Munk (2013), "Fixed income modelling"
        </a>
       </p>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Vasicek_model">
         Vasicek model
        </a>
        of
        <a href="https://www.sciencedirect.com/science/article/abs/pii/0304405X77900162?via%3Dihub">
         Vasicek (1977)
        </a>
        specifies the full yield curve in terms of a single state variable namely the short rate. It is assumed that the short rate, $r_t$ follows an Ornstein-Uhlenbeck process
       </p>
       $$
dr_t = \kappa [\theta - r_t] dt + \beta dz_t^\mathbb{P}
$$
       <p>
        where $^\mathbb{P}$ indicates that the dynamics are specified under the real-world probability measure. $\kappa, \theta$ and $\beta$ are positive constants. We can think of $\theta$ as the long-run level for the short rate. The short rate will be mean-reverting to $\theta$ such that if $r_t &amp;gt; \theta$ the drift term will be negative. $\kappa$ is the speed of adjustment.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        It is possible to show that the future short rate is normally distributed with expectation and variance given by
       </p>
       $$
\text{E}_t [r_s] = \theta + (r_t - \theta) e^{- \kappa (s-t)}
$$
       <p>
        and
       </p>
       $$
\text{Var}_t [r_s] = \frac{\beta^2}{2 \kappa} \left(1 - e^{- 2 \kappa (s-t)} \right)
$$
       <p>
        We note that when $s \to \infty$ then $\text{E}_t [r_s]  \to \theta$ and $\text{Var}_t [r_s] \to \frac{\beta^2}{2 \kappa}$.
       </p>
       <p>
        This information is usefull when simulating the short rate into the future. Define a function that can simulate future paths of the short rate. The function should take as input:
        <code>
         initial_short_rate
        </code>
        ,
        <code>
         kappa
        </code>
        ,
        <code>
         theta
        </code>
        ,
        <code>
         beta
        </code>
        ,
        <code>
         horizon
        </code>
        (in years),
        <code>
         dt
        </code>
        (step size in years, eg. 1/12 for monthly) and
        <code>
         num_sim
        </code>
        (number of simulations).
       </p>
       <p>
        Assume a initial short rate of $r_t=0.01$ and $\kappa=0.36$, $\theta =0.08$ and $\beta = 0.0265$. Simulate 10,000 paths of the short rate for the next 20 years with monthly time steps.
       </p>
       <p>
        Plot a fan chart with the 2.5, 5, 10, 50, 90, 95, and 97.5 percentile (use e.g
        <code>
         codelib.visualization.base.fan_chart
        </code>
        ).
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        For risk-neutral pricing, we need the dynamics under $\mathbb{Q}$ (the risk-neutral probability measure). Under the risk-neutral probability measure we have
       </p>
       $$
\begin{align}
dr_t &amp;amp;= \kappa [\theta - r_t] dt + \beta \left(dz_t^\mathbb{Q} - \lambda dt \right) \\
    &amp;amp;= \kappa [\hat{\theta} - r_t] dt + \beta dz_t^\mathbb{Q}
\end{align}
$$
       <p>
        where $\hat{\theta} = \theta - \frac{\lambda \beta}{\kappa}$. We see that the parameterization is identical under the risk-neutral probability measure - then only difference is in the magnitude of $\theta$.
       </p>
       <p>
        Plot the future paths of the short rate under the risk neutral measure. Assume $\lambda=-0.15$.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        The Vasicek model is a so-called affine term structure model which implies that the price of a zero-coupon bond can be written as
       </p>
       $$
B_t^T = e^{-a(T-t) - b(T-t) r_t} 
$$
       <p>
        It is possible to show that for the Vasicek model (let $\tau = T -t$)
       </p>
       $$
\begin{align}
a(\tau) &amp;amp;= y_\infty [\tau - b(\tau)] + \frac{\beta^2}{4 \kappa} b(\tau)^2\\
b(\tau) &amp;amp;= \frac{1}{\kappa} \left(1 - e^{-\kappa \tau} \right)
\end{align}
$$
       <p>
        with
       </p>
       $$
y_\infty = \hat{\theta} - \frac{\beta^2}{2 \kappa^2} = \theta - \frac{\lambda \beta}{\kappa}- \frac{\beta^2}{2 \kappa^2}
$$
       <p>
        Define a function that returns the price of a zero coupon bond.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Plot the 5-year zero coupon bond price for $\kappa \in [0.01, 3.0]$. Assume that $\theta = 0.05, \beta  = 0.03$ and $\lambda = -0.15$. Consider four different values of the initial short rate $r_t \in \{0.02, 0.04, 0.06, 0.08\}$
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        Plot the 5-year zero coupon bond price for $\theta \in [0.0, 0.2]$. Assume that $\kappa = 0.3, \beta  = 0.03$ and $\lambda = -0.15$. Consider four different values of the initial short rate $r_t \in \{0.02, 0.04, 0.06, 0.08\}$
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        Plot 1-year, 5-year and 10-year zero coupon bond price for $\beta \in [0.01, 0.2]$. Assume that $\kappa = 0.3, \theta  = 0.05$ and $\lambda = -0.15$. Assume $r_t =0.03$.
       </p>
       <p>
        <strong>
         Question 7
        </strong>
       </p>
       <p>
        Plot 1-year, 5-year and 10-year zero coupon bond price for $\lambda \in [-0.5, 0.5]$. Assume that $\kappa = 0.3, \theta  = 0.05$. Assume $r_t =0.03$.
       </p>
       <p>
        <strong>
         Question 8
        </strong>
       </p>
       <p>
        It follows directly from
       </p>
       $$
B_t^T = e^{-a(T-t) - b(T-t) r_t} 
$$
       <p>
        that the zero-coupon yield at time $t$ for maturity $T$ is given by
       </p>
       $$
y_t^T = \frac{a(T-t)}{T-t}  + \frac{b(T-t)}{T-t}r_t = y_\infty + \frac{b(T-t)}{T-t} \left(\frac{\beta^2}{4 \kappa} b(T-t) + r - y_\infty \right)
$$
       <p>
        Define a
        <code>
         VasicekCurve
        </code>
        that inherits from
        <code>
         IRateCurve
        </code>
        (see
        <code>
         codelib.fixed_income.curves
        </code>
        ). Plot the yield curve for  $\kappa = 0.3, \theta  = 0.05, \beta=0.03$ and $\lambda = -0.15$. Assume $r_t =0.03$.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=numerical-trading">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">simulate_vasicek</span><span class="p">(</span><span class="n">initial_short_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                     <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> 
                     <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mi">12</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">:</span> <span class="nb">int</span><span class="o">=</span><span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    simulates short rate processes in a vasicek setting until a given horizon </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    initial_short_rate:</span>
<span class="sd">        initial short rate</span>
<span class="sd">    kappa: </span>
<span class="sd">        speed of mean reversion.</span>
<span class="sd">    theta: </span>
<span class="sd">        long term mean of the short rate.</span>
<span class="sd">    dt:</span>
<span class="sd">        increments in time</span>
<span class="sd">    horizon:</span>
<span class="sd">        time until maturity/expiry (horizon).</span>
<span class="sd">    num_sim:</span>
<span class="sd">        number of simulations.</span>
<span class="sd">    """</span>
    <span class="n">std_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)))</span>
    
    <span class="n">num_periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizon</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">short_rates</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_periods</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">short_rates</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_short_rate</span>
    
    <span class="n">error_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">std_rates</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_periods</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_periods</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> 
        
        <span class="n">short_rates</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">+</span> <span class="p">(</span><span class="n">short_rates</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">theta</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">dt</span><span class="p">)</span> <span class="o">+</span> <span class="n">error_terms</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">short_rates</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=light-position">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">short_rates</span> <span class="o">=</span> <span class="n">simulate_vasicek</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="mf">0.36</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="mf">0.08</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.0265</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">num_sim</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">20.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">)</span>

<span class="c1"># calculate percentiles</span>
<span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">short_rates</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot fan chart</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span>
          <span class="n">percentiles</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'cyan'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Short rate, $r_s$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Short rate process"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=compact-satellite">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We see that the $\hat{\theta} &amp;gt; \theta$ implying that the probability under $\mathbb{Q}$ is shifted upwards. Note that this is intuitive if there should be a term premium for holding longer maturity bonds.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=random-encoding">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.36</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.0265</span>
<span class="n">risk_premium</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.08</span> <span class="o">-</span> <span class="n">risk_premium</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="n">kappa</span>


<span class="n">short_rates_q</span> <span class="o">=</span> <span class="n">simulate_vasicek</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">horizon</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">dt</span><span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">num_sim</span><span class="o">=</span><span class="mi">10000</span><span class="p">)</span>
<span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">20.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">)</span>

<span class="c1"># calculate percentiles</span>
<span class="n">percentiles_q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">short_rates_q</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot fan chart</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span>
          <span class="n">percentiles</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'cyan'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Short rate, $r_s$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Short rate process under $</span><span class="se">\\</span><span class="s2">mathbb</span><span class="si">{P}</span><span class="s2">$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">);</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span>
          <span class="n">percentiles_q</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'red'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Short rate process under $</span><span class="se">\\</span><span class="s2">mathbb</span><span class="si">{Q}</span><span class="s2">$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=interested-wesley">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=abroad-tablet">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_zero_coupon_price</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                                <span class="n">initial_short_rate</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">kappa</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">beta</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span>
                                <span class="n">risk_premium</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span>
    
    <span class="n">y_infty</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">-</span> <span class="n">risk_premium</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="n">kappa</span> <span class="o">-</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">kappa</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">kappa</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">kappa</span> <span class="o">*</span> <span class="n">time_to_maturity</span><span class="p">))</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">y_infty</span> <span class="o">*</span> <span class="p">(</span><span class="n">time_to_maturity</span>  <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">kappa</span><span class="p">)</span> <span class="o">*</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="n">a</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">initial_short_rate</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=talented-junction">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        $\kappa$ governs the speed of mean-reversion. When the speed of mean-reversion is high, then the price of the zero-coupon bond is less dependent on the initial level of the short rate.
       </p>
       <p>
        The price of a zero-coupon bond can be written as
       </p>
       $$
E_{r,t}^\mathbb{Q} \left[ \exp \left(-\intop_t^T r_u du \right) \right]
$$
       <p>
        If the current short rate is lower than the long-term level, a high $\kappa$ will imply that $\intop_t^T r_u du$ is expected to be larger than for low values of $\kappa$. This is why the zero-coupon price is descreasing in $\kappa$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=extraordinary-society">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">kappa_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">risk_premium</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>

<span class="n">init_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">init_rates</span><span class="p">:</span> 
    
    <span class="n">bond_prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_zero_coupon_price</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">risk_premium</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kappa_values</span><span class="p">]</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">kappa_values</span><span class="p">,</span> <span class="n">bond_prices</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$r_t = </span><span class="si">{}</span><span class="s2">$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"5Y zero-coupon bond price"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Kappa, $\kappa$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=italic-elements">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        The zero-coupon bond price is decreasing in $\theta$. $\intop_t^T r_u du$ is expected to increase when $\theta$ increases why the value of the zero-coupon decreases.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=tribal-digit">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">theta_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">risk_premium</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>

<span class="n">init_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">init_rates</span><span class="p">:</span> 
    
    <span class="n">bond_prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_zero_coupon_price</span><span class="p">(</span><span class="mf">5.0</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">risk_premium</span><span class="p">)</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">theta_values</span><span class="p">]</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">theta_values</span><span class="p">,</span> <span class="n">bond_prices</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$r_t = </span><span class="si">{}</span><span class="s2">$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">r</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"5Y zero-coupon bond price"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Theta, $</span><span class="se">\\</span><span class="s2">theta$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=optimum-black">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        The price is not a monotonic function of the interest rate volatility $\beta$. Long term bonds are more sensitive to $\beta$ than short bonds.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=excess-positive">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">beta_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">risk_premium</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>

<span class="n">init_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span> 
    
    <span class="n">bond_prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_zero_coupon_price</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">risk_premium</span><span class="p">)</span> <span class="k">for</span> <span class="n">b</span> <span class="ow">in</span> <span class="n">beta_values</span><span class="p">]</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">beta_values</span><span class="p">,</span> <span class="n">bond_prices</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$T-t = </span><span class="si">{}</span><span class="s2">Y$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Zero-coupon bond price"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Beta, $</span><span class="se">\\</span><span class="s2">beta$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=congressional-tennis">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 7
        </strong>
       </p>
       <p>
        It is possible to write the dynamics of a zero-coupon bond as (when the short rate follows a Vasicek model)
       </p>
       $$
dB_t^T = B_t^T \left[\left(r_t - \lambda b(T-t) \beta \right)dt + b(T-t) \beta dz_t \right]
$$
       <p>
        The more negative $\lambda$ is, the higher is the excess expected return on the bond. Thus, the current price must be lower today. The effect is much larger for long-term bonds!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=welsh-columbus">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">r</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">risk_premium_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">init_rates</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.02</span><span class="p">,</span> <span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">]</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">years</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">]</span>
<span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="n">years</span><span class="p">:</span> 
    
    <span class="n">bond_prices</span> <span class="o">=</span> <span class="p">[</span><span class="n">calculate_zero_coupon_price</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="n">kappa</span><span class="p">,</span> <span class="n">theta</span><span class="p">,</span> <span class="n">beta</span><span class="p">,</span> <span class="n">rp</span><span class="p">)</span> <span class="k">for</span> <span class="n">rp</span> <span class="ow">in</span> <span class="n">risk_premium_values</span><span class="p">]</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">risk_premium_values</span><span class="p">,</span> <span class="n">bond_prices</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$T-t = </span><span class="si">{}</span><span class="s2">Y$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">y</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Zero-coupon bond price"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Lambda, $</span><span class="se">\\</span><span class="s2">lambda$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">4</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=controlled-birth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 8
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=incomplete-theme">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">theta</span> <span class="o">=</span> <span class="mf">0.05</span>
<span class="n">kappa</span> <span class="o">=</span> <span class="mf">0.3</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">0.03</span>
<span class="n">rp</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.15</span>

<span class="n">theta_hat</span> <span class="o">=</span> <span class="n">theta</span> <span class="o">-</span> <span class="p">(</span><span class="n">rp</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta</span> <span class="o">/</span> <span class="n">kappa</span>
<span class="n">vasicek_curve</span> <span class="o">=</span> <span class="n">VasicekCurve</span><span class="p">(</span><span class="n">short_rate</span><span class="o">=</span><span class="mf">0.03</span><span class="p">,</span> <span class="n">theta</span><span class="o">=</span><span class="n">theta_hat</span><span class="p">,</span>
                             <span class="n">kappa</span><span class="o">=</span><span class="n">kappa</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="n">beta</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dated-retail">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">plot_tenors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">20.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">plot_tenors</span><span class="p">,</span> <span class="n">vasicek_curve</span><span class="o">.</span><span class="n">zero_rate_vector</span><span class="p">(</span><span class="n">plot_tenors</span><span class="p">),</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zero yields (cont.)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"The Vasicek yield curve"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=trained-tamil">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:-A-dynamic-Nelson-Siegel-model">
        Problem 2: A dynamic Nelson-Siegel model
        <a class="anchor-link" href="#Problem-2:-A-dynamic-Nelson-Siegel-model">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.sas.upenn.edu/~fdiebold/papers/paper49/Diebold-Li.pdf">
         Diebold and Li (2006)
        </a>
        consider a time-varying version of the Nelson-Siegel yield curve allowing for yield curve forecasting.
       </p>
       <p>
        The yield curve at time $t$ is specified as
       </p>
       $$
y_t(\tau) = \beta_{1t} + \beta_{2t} \left( \frac{1 - e^{-\lambda_t \tau}}{\lambda_t \tau } \right) + \beta_{3t} \left( \frac{1 - e^{-\lambda_t \tau}}{\lambda_t \tau } - e^{-\lambda_t \tau}\right)
$$
       <p>
        The innovation is to interpret $\beta_{1t}, \beta_{2t}$ and $\beta_{3t}$ as three latent dynamic factors. The loading on $\beta_{1t}$ is 1 (long term factor). The loading on $\beta_{2t}$ is $ \frac{1 - e^{-\lambda_t \tau}}{\lambda_t \tau }$ which starts at 1 and montonically converges to zero (short term factor). The loading on $\beta_{3t}$ starts at zero, increases and then decays to zero (medium term factor).
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        <a href="https://www.federalreserve.gov/data/nominal-yield-curve.htm">
         FRED
        </a>
        provides nominal yield curve data interpolated using the Nelson-Siegel-Svensson specification. These are not the data used by
        <a href="https://www.sas.upenn.edu/~fdiebold/papers/paper49/Diebold-Li.pdf">
         Diebold and Li (2006)
        </a>
        , but we will use it to show the idea behind their method.
       </p>
       <p>
        Obtain the zero-coupon yields from the date where all tenors are available.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        As we previously have seen, it would be possible to estimate the parameters $\theta_t = \{\beta_{1t}, \beta_{2t}, \beta_{3t}, \lambda_t\}$ each period by non-linear least squares. However, as we also have seen, we can replace the complicated numerical optimization problem with linear regression if we fix $\lambda_t$.
        <a href="https://www.sas.upenn.edu/~fdiebold/papers/paper49/Diebold-Li.pdf">
         Diebold and Li (2006)
        </a>
        follow the same approach and fix $\lambda_t = 0.0609$ (they use tenor in months). This particular value of $\lambda_t$ ensures that the the medium term factor attains it maximum at the 30 month tenor.
       </p>
       <p>
        Find the value of $\lambda_t$ that maximize the loading of the curvature at the 30 month tenor.
       </p>
       <p>
        Estimate $\beta_{1t}, \beta_{2t}$ and $\beta_{3t}$ for each date when fixing $\lambda_t$ at the determined value.
       </p>
       <p>
        <strong>
         Quesiton 3
        </strong>
       </p>
       <p>
        We want to plot the estimated "latent" factors against the ones observed in the market.
       </p>
       <ul>
        <li>
         Plot the 10-year zero yield (level) in the same plot as $\beta_{1t}$
        </li>
        <li>
         Plot the 1-year minus the 10-year zero yield (slope)  in the same plot as $\beta_{2t}$
        </li>
        <li>
         Plot twice the 2-year yield minus the sum of the 1-year and 10-year yield in the same plot as $\beta_{3t}$
        </li>
       </ul>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        We have so far just estimated Nelson-Siegel curves for each time period. To create a forecasting model for future yield curves, we need to specify a dynamic structure for the factors.
       </p>
       <p>
        <a href="https://www.sas.upenn.edu/~fdiebold/papers/paper49/Diebold-Li.pdf">
         Diebold and Li (2006)
        </a>
        simply specify the dynamics as univariate AR(1) models:
       </p>
       $$
\beta_{i,t+1} = a + b \beta_{i,t} + \varepsilon_{i,t}, \; \; i = 1, 2, 3
$$
       <p>
        We estimate the AR(1) process for each factor on monthly data. This can be done by regressing $\beta_{i,t+1}$ on a constant and $\beta_{i,t}$. Estimate the models.
       </p>
       <p>
        <strong>
         Note:
        </strong>
        It would also be possible to use e.g. a Vector AutoRegression (VAR) model
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        Simulate the latent factors for the next 10 years (consider 10,000 simulations) when assuming the error term to be normally distributed. Plot the distribution of yield curves after 1 years.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=primary-interest">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_zero_yields</span> <span class="o">=</span> <span class="n">get_nominal_yield_data</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s1">'zero_yields'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=bridal-joint">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_zero_yields</span> <span class="o">=</span> <span class="n">all_zero_yields</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="o">/</span>  <span class="mf">100.0</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=coordinate-purse">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_zero_yields</span><span class="o">.</span><span class="n">head</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sunset-religion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=small-metabolism">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define functions </span>
<span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">l</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_to_maturity</span> <span class="o">*</span> <span class="n">l</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">*</span> <span class="n">l</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">l</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_to_maturity</span> <span class="o">*</span> <span class="n">l</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">*</span> <span class="n">l</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">*</span> <span class="n">l</span> <span class="p">))</span>


<span class="k">def</span> <span class="nf">ols_ns</span><span class="p">(</span><span class="n">observed_yields</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">tenors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">l</span><span class="p">):</span>   
    
    <span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">tenors</span><span class="p">),</span>
              <span class="n">calculate_slope</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="n">l</span><span class="p">),</span> 
              <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="n">l</span><span class="p">)]</span>

    <span class="n">est_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">observed_yields</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">est_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=acoustic-network">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Find value of lambda (l) to use</span>
<span class="sd">"""</span>

<span class="n">obj_func</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">calculate_curvature</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mf">12.0</span> <span class="o">*</span> <span class="mf">30.0</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
<span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">obj_func</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=former-parade">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">tenors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">beta_estimates</span> <span class="o">=</span> <span class="n">all_zero_yields</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">ols_ns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">tenors</span><span class="p">,</span> <span class="mf">0.71731277</span><span class="p">),</span> <span class="n">result_type</span><span class="o">=</span><span class="s2">"expand"</span><span class="p">)</span>
<span class="n">beta_estimates</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'beta1'</span><span class="p">,</span> <span class="s1">'beta2'</span><span class="p">,</span> <span class="s1">'beta3'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=geological-heavy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">beta_estimates</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=excellent-dressing">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Qeustion 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=female-literacy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">16</span><span class="p">))</span>

<span class="sd">"""</span>
<span class="sd">Level</span>
<span class="sd">"""</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">beta_estimates</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">beta_estimates</span><span class="o">.</span><span class="n">beta1</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">beta_1$"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_zero_yields</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">all_zero_yields</span><span class="p">[</span><span class="s1">'SVENY10'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Level"</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>

<span class="sd">"""</span>
<span class="sd">Slope</span>
<span class="sd">"""</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">beta_estimates</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">beta_estimates</span><span class="o">.</span><span class="n">beta2</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">beta_2$"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_zero_yields</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="o">-</span><span class="n">all_zero_yields</span><span class="p">[</span><span class="s1">'SVENY10'</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_zero_yields</span><span class="p">[</span><span class="s1">'SVENY01'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Slope"</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>


<span class="sd">"""</span>
<span class="sd">Curvature</span>
<span class="sd">"""</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">beta_estimates</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">beta_estimates</span><span class="o">.</span><span class="n">beta3</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">beta_3$"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_zero_yields</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">all_zero_yields</span><span class="p">[</span><span class="s1">'SVENY02'</span><span class="p">]</span> <span class="o">-</span> 
           <span class="n">all_zero_yields</span><span class="p">[</span><span class="s1">'SVENY01'</span><span class="p">]</span> <span class="o">-</span> <span class="n">all_zero_yields</span><span class="p">[</span><span class="s1">'SVENY10'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Curvature"</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=employed-hampton">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=certified-hardwood">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Resample Monthly Data</span>
<span class="sd">"""</span>

<span class="n">beta_estimates_monthly</span> <span class="o">=</span> <span class="n">beta_estimates</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">"ME"</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>

<span class="n">periods</span> <span class="o">=</span> <span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="sd">"""</span>
<span class="sd">Estimate parameters using OLS</span>
<span class="sd">"""</span>
<span class="c1"># beta1</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
          <span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]</span>

<span class="n">est_params_beta1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># beta2</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
          <span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]]</span>

<span class="n">est_params_beta2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="c1"># beta3</span>
<span class="n">X</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">periods</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span>
          <span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]]</span>

<span class="n">est_params_beta3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Simulate AR</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">simulate_first_order_ar</span><span class="p">(</span><span class="n">initial_beta</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">horizon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span><span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">10000</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    simulates short rate processes in a vasicek setting until a given horizon </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    initial_short_rate:</span>
<span class="sd">        initial short rate</span>
<span class="sd">    kappa: </span>
<span class="sd">        speed of mean reversion.</span>
<span class="sd">    theta: </span>
<span class="sd">        long term mean of the short rate.</span>
<span class="sd">    dt:</span>
<span class="sd">        increments in time</span>
<span class="sd">    horizon:</span>
<span class="sd">        time until maturity/expiry (horizon).</span>
<span class="sd">    num_sim:</span>
<span class="sd">        number of simulations.</span>
<span class="sd">    """</span>    
    
    <span class="n">num_periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizon</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    <span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_periods</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">betas</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">initial_beta</span>
    
    <span class="n">error_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_periods</span><span class="p">))</span>
    
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">num_periods</span> <span class="o">+</span> <span class="mi">1</span><span class="p">):</span> 
        
        <span class="n">betas</span><span class="p">[:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">a</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="n">betas</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">error_terms</span><span class="p">[:,</span> <span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span>
        
    <span class="k">return</span> <span class="n">betas</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=charitable-christmas">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=typical-radio">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">beta1_sim</span> <span class="o">=</span> <span class="n">simulate_first_order_ar</span><span class="p">(</span><span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                   <span class="n">a</span><span class="o">=</span><span class="n">est_params_beta1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">b</span><span class="o">=</span><span class="n">est_params_beta1</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> 
                                   <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">est_params_beta1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> 
                                                   <span class="p">(</span><span class="n">periods</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span> 
                                   <span class="c1"># note that the second output from np.linalg.lstsq is the sum of squared residuals</span>
                                   <span class="n">horizon</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                                   <span class="n">num_sim</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="n">beta2_sim</span> <span class="o">=</span> <span class="n">simulate_first_order_ar</span><span class="p">(</span><span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span>
                                   <span class="n">a</span><span class="o">=</span><span class="n">est_params_beta2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">b</span><span class="o">=</span><span class="n">est_params_beta2</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> 
                                   <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">est_params_beta2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">periods</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span> 
                                   <span class="n">horizon</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                                   <span class="n">num_sim</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="n">beta3_sim</span> <span class="o">=</span> <span class="n">simulate_first_order_ar</span><span class="p">(</span><span class="n">beta_estimates_monthly</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span>
                                   <span class="n">a</span><span class="o">=</span><span class="n">est_params_beta3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                                   <span class="n">b</span><span class="o">=</span><span class="n">est_params_beta3</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span> 
                                   <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">est_params_beta3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="n">periods</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)),</span> 
                                   <span class="n">horizon</span><span class="o">=</span><span class="mf">10.0</span><span class="p">,</span>
                                   <span class="n">num_sim</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=political-front">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">)</span>

<span class="c1"># calculate percentiles</span>
<span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">beta1_sim</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot fan chart</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span>
          <span class="n">percentiles</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'cyan'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">beta_</span><span class="si">{1t}</span><span class="s2">$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Forecasted development of $</span><span class="se">\\</span><span class="s2">beta_</span><span class="si">{1t}</span><span class="s2">$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=timely-apparel">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">)</span>

<span class="c1"># calculate percentiles</span>
<span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">beta2_sim</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot fan chart</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span>
          <span class="n">percentiles</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'cyan'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">beta_</span><span class="si">{2t}</span><span class="s2">$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Forecasted development of $</span><span class="se">\\</span><span class="s2">beta_</span><span class="si">{2t}</span><span class="s2">$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=happy-edmonton">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10.01</span><span class="p">,</span> <span class="mf">1.0</span><span class="o">/</span><span class="mf">12.0</span><span class="p">)</span>

<span class="c1"># calculate percentiles</span>
<span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">beta3_sim</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot fan chart</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span>
          <span class="n">percentiles</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'cyan'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">beta_</span><span class="si">{3t}</span><span class="s2">$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Forecasted development of $</span><span class="se">\\</span><span class="s2">beta_</span><span class="si">{3t}</span><span class="s2">$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sweet-baseball">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">tenors_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">curves</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">empty</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="mi">100</span><span class="p">))</span>

<span class="n">period_to_select</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">*</span> <span class="mi">12</span>  <span class="o">+</span> <span class="mi">1</span>

<span class="n">slope_loading</span> <span class="o">=</span> <span class="n">calculate_slope</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="mf">0.71731277</span><span class="p">)</span>
<span class="n">curvature_loading</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="mf">0.71731277</span><span class="p">)</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span>
    
    <span class="n">beta1</span> <span class="o">=</span> <span class="n">beta1_sim</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">period_to_select</span><span class="p">]</span>
    <span class="n">beta2</span> <span class="o">=</span> <span class="n">beta2_sim</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">period_to_select</span><span class="p">]</span>
    <span class="n">beta3</span> <span class="o">=</span> <span class="n">beta3_sim</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">period_to_select</span><span class="p">]</span>
    
    <span class="n">zero_yields</span> <span class="o">=</span> <span class="n">beta1</span> <span class="o">+</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">slope_loading</span> <span class="o">+</span> <span class="n">beta3</span> <span class="o">*</span> <span class="n">curvature_loading</span>    
    
    <span class="n">curves</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">zero_yields</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=russian-heading">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate percentiles</span>
<span class="n">percentiles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">curves</span><span class="p">,</span> <span class="p">[</span><span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot fan chart</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span>
          <span class="n">percentiles</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'cyan'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Zero yields"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Forecasted yield curve after 1 years"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=extra-chart">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3:-Principal-component-analysis-of-yield-data">
        Problem 3: Principal component analysis of yield data
        <a class="anchor-link" href="#Problem-3:-Principal-component-analysis-of-yield-data">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Note:
        </strong>
        This problem is somewhat inspired by chapter 6 and 7 in
        <a href="https://www.amazon.com/Bond-Pricing-Yield-Curve-Modeling/dp/1107165857">
         Riccardo Rebonato (2018), "Bond Pricing and Yield-Curve Modelling - A Structural Approach"
        </a>
       </p>
       <p>
        After this problem it should be clear that we may model yields and yields changes with a limited number of factors.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Get nominal yield data and consider only observations where all data is available. Demean the yields and yield changes and calculate the covariance and correlation matrix.
       </p>
       <p>
        Plot a heatmap of the correlation matrix for the yields and yield changes.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        The above analysis will indicate that the different parts of the yield curve are highly correlated, e.g. the yields representing the short end of the yield curve are highly correlated but less so with the long end.
       </p>
       <p>
        Find the eigenvectors and eigenvalues of the covariance matrix for the yields and yield changes.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        According to
        <a href="https://en.wikipedia.org/wiki/Principal_component_analysis">
         wikipedia
        </a>
        principle component analysis is defined as an orthogonal linear transformation that transforms the data to a new coordinate system such that the greatest variance by some scalar projection of the data comes to lie on the first coordinate (called the first principal component), the second greatest variance on the second coordinate, and so on.
       </p>
       <p>
        If we let $\mathbf{X}$ ($n \times p$ where $n$ is the number of observations and $p$ is the number of variables) denote the demeaned data matrix, then we can find the principal components using
       </p>
       $$
\mathbf{T} =  \mathbf{X} \mathbf{V}
$$
       <p>
        where $\mathbf{V}$ is a $p \times p$ matrix where the columns are the eigenvectors of the covariance matrix (simply $\mathbf{X}^\top \mathbf{X}$ since we have demeand the columns).
       </p>
       <p>
        Find the principal components and plot the three first over time.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        The eigenvalues, $\lambda_i, \; i=1,..., p$,  are equal to the variance of the principal components. The proportion of the variance explained by the $i$'th principal component can be written as
       </p>
       $$
\frac{\lambda_i}{\sum_{j=1}^p \lambda_j}
$$
       <p>
        Find the proportion of the variance explained for the different PCAs.
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        It follows directly that
       </p>
       $$
\mathbf{T} \mathbf{V}^\top = \mathbf{X}
$$
       <p>
        we can think of $\mathbf{V}^\top $ as a matrix of factor loadings. Plot the factor loadings for the first three principal components.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=quick-milton">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_zero_yields</span> <span class="o">=</span> <span class="n">get_nominal_yield_data</span><span class="p">(</span><span class="n">output_type</span><span class="o">=</span><span class="s1">'zero_yields'</span><span class="p">)</span>
<span class="c1">#all_zero_yields = all_zero_yields.resample("M").last()</span>
<span class="n">all_zero_yields</span> <span class="o">=</span> <span class="n">all_zero_yields</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="o">/</span>  <span class="mf">100.0</span> 
<span class="n">all_zero_yields</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>

<span class="n">yield_changes</span> <span class="o">=</span> <span class="p">(</span><span class="n">all_zero_yields</span> <span class="o">-</span> <span class="n">all_zero_yields</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
<span class="n">yield_changes</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=clean-plumbing">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">yield_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'</span><span class="si">{}</span><span class="s1">Y'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">31</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>

<span class="sd">"""</span>
<span class="sd">Find covariance matrix</span>
<span class="sd">"""</span>

<span class="n">yield_matrix</span> <span class="o">=</span> <span class="n">all_zero_yields</span><span class="o">.</span><span class="n">values</span>
<span class="n">yield_matrix_demean</span> <span class="o">=</span> <span class="n">yield_matrix</span> <span class="o">-</span> <span class="n">yield_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">yield_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">yield_matrix_demean</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">yield_corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">yield_matrix_demean</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="n">yield_change_matrix</span> <span class="o">=</span> <span class="n">yield_changes</span><span class="o">.</span><span class="n">values</span>
<span class="n">yield_change_matrix_demean</span> <span class="o">=</span> <span class="n">yield_change_matrix</span> <span class="o">-</span> <span class="n">yield_change_matrix</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">yield_change_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">yield_change_matrix_demean</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">yield_change_corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">yield_change_matrix_demean</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot the correlation matrix</span>
<span class="sd">"""</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">yield_change_corr_mat</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">yield_names</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">yield_names</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=urban-station">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">yield_corr_mat</span><span class="p">,</span> <span class="n">xticklabels</span><span class="o">=</span><span class="n">yield_names</span><span class="p">,</span> <span class="n">yticklabels</span><span class="o">=</span><span class="n">yield_names</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=encouraging-quest">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=incorporate-aaron">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">eigvals_level</span><span class="p">,</span> <span class="n">eigvectors_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">yield_cov_mat</span><span class="p">)</span>
<span class="n">eigvals_change</span><span class="p">,</span> <span class="n">eigvectors_change</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">yield_change_cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=eleven-jamaica">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1">#eigvectors_level = -eigvectors_level</span>
<span class="c1">#eigvectors_change = -eigvectors_change</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=shaped-detail">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=primary-inclusion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">pca_level</span> <span class="o">=</span> <span class="n">yield_matrix_demean</span> <span class="o">@</span> <span class="n">eigvectors_level</span>
<span class="n">pca_change</span> <span class="o">=</span> <span class="n">yield_change_matrix_demean</span> <span class="o">@</span> <span class="n">eigvectors_change</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=congressional-giving">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_zero_yields</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pca_level</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"PCA 1"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_zero_yields</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pca_level</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"PCA 2"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">all_zero_yields</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pca_level</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"PCA 3"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PCA on yields"</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yield_changes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pca_change</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"PCA 1"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yield_changes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pca_change</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"PCA 2"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">yield_changes</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">pca_change</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"PCA 3"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PCA on yield changes"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=manual-twenty">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=challenging-integral">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">explained_level</span> <span class="o">=</span> <span class="n">eigvals_level</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eigvals_level</span><span class="p">)</span>
<span class="n">explained_change</span> <span class="o">=</span> <span class="n">eigvals_change</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eigvals_change</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=closed-delivery">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">explained_level</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PCA on yields: Proportion of the variance explained"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"PCA"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Proportion of variance explained"</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">bar</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">explained_change</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PCA on yield changes: Proportion of the variance explained"</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"PCA"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Proportion of variance explained"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=amber-uncle">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=filled-celebrity">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">factor_loading_level</span> <span class="o">=</span> <span class="n">eigvectors_level</span>
<span class="n">factor_loading_change</span> <span class="o">=</span> <span class="n">eigvectors_change</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=abstract-payment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">factor_loading_level</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"PCA 1 (level?)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">factor_loading_level</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"PCA 2 (slope?)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">factor_loading_level</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"PCA 3 (curvature?)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PCA on yields: Factor loadings"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Tenor"</span><span class="p">)</span>
<span class="c1">#ax[0].set_ylabel("Proportion of variance explained")</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">factor_loading_change</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"PCA 1 (level?)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">factor_loading_change</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"PCA 2 (slope?)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">31.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">factor_loading_change</span><span class="p">[:,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"PCA 3 (curvature?)"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Tenor"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"PCA on yield changes: Factor loadings"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.sciencedirect.com/science/article/abs/pii/0304405X77900162?via%3Dihub">
         Vasicek (1977), An equilibrium characterization of the term structure
        </a>
       </p>
       <p>
        <a href="https://www.sas.upenn.edu/~fdiebold/papers/paper49/Diebold-Li.pdf">
         Diebold and Li (2006), Forecasting the term structure of government bond yields
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.co.uk/Fixed-Income-Modelling-Claus-Munk/dp/0198716443">
         Claus Munk (2013), "Fixed income modelling"
        </a>
       </p>
       <p>
        <a href="https://www.amazon.com/Bond-Pricing-Yield-Curve-Modeling/dp/1107165857">
         Riccardo Rebonato (2018), "Bond Pricing and Yield-Curve Modelling - A Structural Approach"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>

<span class="c1"># plotting libraries</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># working with time and dates</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># scipy for statistics and optimization</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">block_diag</span>

<span class="c1"># pandas data-reader for getting data</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.data</span> <span class="kn">import</span> <span class="n">DataReader</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>

<span class="c1"># typehints </span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">correlation_plot</span><span class="p">,</span> <span class="n">fan_chart</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span><span class="p">,</span> <span class="n">default_colors</span>
<span class="n">DefaultStyle</span><span class="p">();</span>

<span class="kn">from</span> <span class="nn">codelib.statistics.moments</span> <span class="kn">import</span> <span class="n">corr_to_cov_matrix</span><span class="p">,</span> <span class="n">cov_to_corr_matrix</span>
<span class="kn">from</span> <span class="nn">codelib.statistics.robust_covariance</span> <span class="kn">import</span> <span class="n">fitting_error</span><span class="p">,</span> <span class="n">crem_denoised_corr_mat</span>
<span class="kn">from</span> <span class="nn">codelib.statistics.robust_covariance</span> <span class="kn">import</span> <span class="n">marchencko_pastur_bounds</span><span class="p">,</span> <span class="n">marchencko_pastur_density</span>


<span class="kn">import</span> <span class="nn">codelib.portfolio_optimization.risk_metrics</span> <span class="k">as</span> <span class="nn">rm</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-8">
        Exercises - Week 8
        <a class="anchor-link" href="#Exercises---Week-8">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=european-waste">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1:--Sensitivity-of-risk-based-portfolios-to-variance-and-correlation-misspecification">
        Problem 1:  Sensitivity of risk based portfolios to variance and correlation misspecification
        <a class="anchor-link" href="#Problem-1:--Sensitivity-of-risk-based-portfolios-to-variance-and-correlation-misspecification">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Note
        </strong>
        : This problem is inspired by the article
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2650644">
         Ardia, Bolliger, Boudt, Fleury (2017)
        </a>
        - "The Impact of Covariance Misspecification in Risk-Based Portfolios"
       </p>
       <p>
        Consider the correlation matrix
       </p>
       $$
\mathbf{C} = \begin{bmatrix} 1 &amp;amp; \rho_{1,2} &amp;amp; \rho_{1, 3} \\
                             \rho_{1, 2} &amp;amp; 1 &amp;amp; \rho_{2,3} \\
                             \rho_{1,3} &amp;amp; \rho_{2,3} &amp;amp; 1\end{bmatrix}
$$
       <p>
        and the volatilities $\mathbf{v} = [\sigma_1, \sigma_2, \sigma_3]^\top$. Assume that the true values are given by $(\sigma_1, \sigma_2, \sigma_3, \rho_{1,2}, \rho_{1,3}, \rho_{2, 3}) = (0.1, 0.1, 0.2, -0.1, -0.2, 0.7)$.
       </p>
       <p>
        We want to see how we can intuitively visualize the effect of parameter misspecification.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Consider the inverse volatility portfolio (for the $N$ assets case)
       </p>
       $$
\mathbf{w}_{\text{IV}} = \left[\frac{1 / \sigma_1}{\sum_{i=1}^N 1 / \sigma_i}, ..., \frac{1 / \sigma_N}{\sum_{i=1}^N 1 / \sigma_i} \right]
$$
       <p>
        Find the inverse volatility portfolio for the three asset case described above.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Given a long-only constraint, the global minimum variance portfolio is the solution to the optimization problem
       </p>
       $$
\mathbf{w}_{\text{GMV}} = \underset{\mathbf{w}}{\text{arg min }} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to the budget constraint and positivity constriants
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
w_i &amp;amp;\geq 0, \; i=1,..., N
\end{align}
$$
       <p>
        Find the minimum variance portfolio for the three asset case described above.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        We want to examine the effect of misspecifying the volatility. Let the volatility of asset three vary between 10% and 30%, e.g. 50 different values. For each value calculate  the $L_1$ distance / norm
       </p>
       $$
\Vert \mathbf{w}_{\text{True}} - \hat{\mathbf{w}} \Vert_1 \equiv \sum_{i=1}^N \vert w_{\text{True}, i} - \hat{w}_i \vert
$$
       <p>
        for both the inverse-volatility and minimum-variance portfolio. Here $\hat{\mathbf{w}}$ indicates the new portfolio weights with the new volatility of assets 3.
       </p>
       <p>
        Plot the $L_1$ distance as a function of the volatility of asset three.
       </p>
       <p>
        <strong>
         Quesiton 4
        </strong>
       </p>
       <p>
        Now, let the correlation $\rho_{2, 3}$ vary between 0.4 and 1.0. Again, for each value calculate the $L_1$ distance. Plot the $L_1$ distance as a function of $\rho_{2, 3}$
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=human-postcard">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define inputs</span>
<span class="sd">"""</span>

<span class="c1"># correlations</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
<span class="c1"># volatilities</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="c1"># calculate covariance matrix </span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=american-caribbean">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=electric-discussion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_inverse_volatilty</span><span class="p">(</span><span class="n">vols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculate the inverse volatility weights </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vols: </span>
<span class="sd">        Volatilites. </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Portfolio weights. </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="n">inv_vols</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">vols</span>
    <span class="n">sum_inv_vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inv_vols</span><span class="p">)</span>
    
    <span class="n">w_iv</span> <span class="o">=</span> <span class="n">inv_vols</span> <span class="o">/</span> <span class="n">sum_inv_vols</span>
    
    <span class="k">return</span> <span class="n">w_iv</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=quantitative-northern">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate inverse volatility weights</span>
<span class="n">w_iv</span> <span class="o">=</span> <span class="n">calculate_inverse_volatilty</span><span class="p">(</span><span class="n">vols</span><span class="p">)</span>
<span class="n">w_iv</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=clear-scheme">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># portfolio std</span>
<span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">(</span><span class="n">w_iv</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=dirty-samba">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=small-herald">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_min_var_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">init_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculate minimum-variance portfolio </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cov_mat: </span>
<span class="sd">        Covariance matrix. </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Portfolio weights.</span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="c1"># define intial values</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">init_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">init_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    
    <span class="c1"># define sum to one constraint</span>
    <span class="n">eq_constraint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span> <span class="s1">'fun'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span>
    
    <span class="c1"># perform optimization</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_variance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                            <span class="n">init_weights</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">eq_constraint</span><span class="p">,],</span>
                            <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=amino-advance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate the minimum variance portfolio</span>
<span class="n">w_gmv</span> <span class="o">=</span> <span class="n">calculate_min_var_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
<span class="n">w_gmv</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=manufactured-notice">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># portfolio std</span>
<span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">(</span><span class="n">w_gmv</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=growing-finance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=young-infection">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">std_deviations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">norm_iv_vol</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">norm_gmv_vol</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">std_deviations</span><span class="p">:</span> 
    
    <span class="n">vols_new</span> <span class="o">=</span> <span class="n">vols</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">vols_new</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span>
    <span class="n">cov_mat_new</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols_new</span><span class="p">)</span>
    
    <span class="n">norm_iv_vol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">calculate_inverse_volatilty</span><span class="p">(</span><span class="n">vols_new</span><span class="p">)</span> <span class="o">-</span> <span class="n">w_iv</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">norm_gmv_vol</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">calculate_min_var_portfolio</span><span class="p">(</span><span class="n">cov_mat_new</span><span class="p">)</span> <span class="o">-</span> <span class="n">w_gmv</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=enabling-chance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_deviations</span><span class="p">,</span> <span class="n">norm_iv_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Inv-vol"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_deviations</span><span class="p">,</span> <span class="n">norm_gmv_vol</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"min-var"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">sigma_3$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$L_1 = </span><span class="se">\\</span><span class="s2">Vert </span><span class="se">\\</span><span class="s2">mathbf</span><span class="si">{w}</span><span class="s2">_</span><span class="si">{True}</span><span class="s2"> - </span><span class="se">\\</span><span class="s2">hat{</span><span class="se">\\</span><span class="s2">mathbf</span><span class="si">{w}</span><span class="s2">} </span><span class="se">\\</span><span class="s2">Vert_1$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=bacterial-press">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Minimum variance does not seem affected by overestimation of $\sigma_3$, but is heavily affected by underestimation (ceteris paribus).
       </p>
       <p>
        The inverse volatility portfolio is both affected by over and underestimation.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=informative-empty">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=applicable-karaoke">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">rhos</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">norm_iv_rho</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">norm_gmv_rho</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rhos</span><span class="p">:</span> 
    
    <span class="n">corr_mat_new</span> <span class="o">=</span> <span class="n">corr_mat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">corr_mat_new</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">corr_mat_new</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">r</span>
    <span class="n">cov_mat_new</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat_new</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
    
    <span class="n">norm_iv_rho</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">calculate_inverse_volatilty</span><span class="p">(</span><span class="n">vols</span><span class="p">)</span> <span class="o">-</span> <span class="n">w_iv</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">norm_gmv_rho</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">calculate_min_var_portfolio</span><span class="p">(</span><span class="n">cov_mat_new</span><span class="p">)</span> <span class="o">-</span> <span class="n">w_gmv</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ordered-sessions">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhos</span><span class="p">,</span> <span class="n">norm_iv_rho</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Inv-vol"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">rhos</span><span class="p">,</span> <span class="n">norm_gmv_rho</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"min-var"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">rho_{2, 3}$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$L_1 = </span><span class="se">\\</span><span class="s2">Vert </span><span class="se">\\</span><span class="s2">mathbf</span><span class="si">{w}</span><span class="s2">_</span><span class="si">{True}</span><span class="s2"> - </span><span class="se">\\</span><span class="s2">hat{</span><span class="se">\\</span><span class="s2">mathbf</span><span class="si">{w}</span><span class="s2">} </span><span class="se">\\</span><span class="s2">Vert_1$"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.16</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fabulous-nepal">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Minimum variance does not seem affected by overestimation of $\rho_{2, 3}$, but is heavily affected by underestimation (ceteris paribus).
       </p>
       <p>
        The inverse volatility portfolio is naturally not affected at all!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=subtle-distributor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:--Ledoit-and-Wolf-(2003)-%5BOptional%5D">
        Problem 2:  Ledoit and Wolf (2003) [Optional]
        <a class="anchor-link" href="#Problem-2:--Ledoit-and-Wolf-(2003)-%5BOptional%5D">
         ¶
        </a>
       </h2>
       <p>
        In the lectures, we talked about one shrinkage estimator, namely the one suggested by
        <a href="https://www.sciencedirect.com/science/article/pii/S0047259X03000964">
         Ledoit and Wolf (2004), "A well-conditioned estimator for large-dimensional covariance matrices"
        </a>
        .
       </p>
       <p>
        In this problem, we will examine an alternative shrinkage estimator suggested by
        <a href="https://www.sciencedirect.com/science/article/abs/pii/S0927539803000070">
         Ledoit and Wolf (2003), Improved estimation of the covariance matrix
of stock returns with an application to
portfolio selection
        </a>
        .
       </p>
       <p>
        Following the notation in the paper, the sample mean and sample covariance are given by
       </p>
       $$
\mathbf{m}_T = \frac{1}{T}\mathbf{X}\mathbf{1}
$$
       <p>
        and
       </p>
       $$
\mathbf{S}_T = \frac{1}{T}\mathbf{X} \left(\mathbf{I} - \frac{1}{T} \mathbf{1} \mathbf{1}^\top\right) \mathbf{X}^\top
$$
       <p>
        Ledoit and Wolf (2003) notes that since $\mathbf{rank}(\mathbf{AB}) \leq \mathbf{rank}(\mathbf{A})$ then $\mathbf{rank}(\mathbf{S}) \leq \mathbf{rank}\left(\mathbf{I} - \frac{1}{T} \mathbf{1} \mathbf{1}^\top\right) =  T-1$  why we need $N &amp;gt; T-1$ for a non rank-deficient covariance matrix.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sunrise-cache">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Check </span>
<span class="sd">"""</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span> <span class="o">/</span> <span class="mi">5</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=unnecessary-graduation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Ledoit and Wolf (2003) assume that stock returns follow a
        <a href="https://en.wikipedia.org/wiki/Single-index_model">
         single-index model
        </a>
       </p>
       $$
x_{it} = \alpha_i + \beta_i x_{mt} + \varepsilon_{it}
$$
       <p>
        with $\text{Var}[\varepsilon_{it}] = \delta_{ii}$. The error terms are assumed uncorrelated.
       </p>
       <p>
        The covariance matrix is then given by
       </p>
       $$
\mathbf{\Phi} = \sigma_m^2 \beta \beta^\top + \mathbf{\Delta}
$$
       <p>
        where $\mathbf{\Delta} = \text{diag}(\delta_{11}, ..., \delta_{NN})$. By estimating $\beta_i, i=1,...,N$ by running regressions and obtaining the OLS slope estimate $b_i$ and the residual variance $d_{ii}$, we can estimate the covariance matrix
       </p>
       $$
\mathbf{F} = s_m^2 \mathbf{b} \mathbf{b}^\top + \mathbf{D}
$$
       <p>
        where $\mathbf{D} = \text{diag}(d_{11}, ..., d_{NN})$ and $s_m^2$ is the sample variance of market returns.
       </p>
       <p>
        Our problem is that $\mathbf{S}_T$ is unbiased (consistent), but not efficient while $\mathbf{F}$ is not unbiased/consistent, but has smaller variance.  The shrinkage estimator is assumed to take the form
       </p>
       $$
\mathbf{S}^*  = \alpha \mathbf{F} + (1 - \alpha) \mathbf{S}_T
$$
       <p>
        Thus, the shrinkage intensity will take the form  $\alpha = \kappa / T$ where $\kappa$ is a constant. We notice that the shrinkage vanish asymptotically. The optimal shrinkage constant is found by minimizing the frobenius norm
       </p>
       $$
\Vert \alpha \mathbf{F} + (1 - \alpha) \mathbf{S}_T - \boldsymbol{\Sigma} \Vert
$$
       <p>
        Ledoit and Wolf (2003) show that the optimal shrinkage constant is given by
       </p>
       $$
\kappa = \frac{\pi - \rho}{\gamma} = \frac{\sum_{i=1}^N\sum_{j=1}^N \pi_{ij} - \sum_{i=1}^N\sum_{j=1}^N \rho_{ij}}{\sum_{i=1}^N\sum_{j=1}^N \gamma_{ij}}
$$
       <p>
        where $\pi_{ij} = \text{AsyVar}[\sqrt{T}s_{ij}]$, $\rho_{ij} = \text{AsyCov}[\sqrt{T} f_{ij}, \sqrt{T} s_{ij}]$  and $\gamma_{ij} = (\phi_{ij} - \sigma_{ij})^2$.
       </p>
       <p>
        However, these quantities depend on the true, unknown covariance matrix. Ledoit and Wolf (2003) show that a consistent estimator of $\pi_{ij}$  is given by
       </p>
       $$
p_{ij} = \frac{1}{T} \sum \left[(x_{it} - m_i)(x_{jt} - m_j) - s_{ij} \right]^2
$$
       <p>
        A consistent estimator of $\rho_{ij}$ is given by $p_{ij}$ for $i=j$ and for $i \neq j$ then we have $r_{ij} = 1/T \sum_{t=1}^T r_{ijt}$ with
       </p>
       $$
r_{ijt} = \frac{s_{j,m} s_m (x_{it} - m_i) + s_{i, m} s_m (x_{jt} - m_j) - s_{j,m} s_{i, m} (x_{mt} - m_{mkt})}{s_m^2} (x_{mt} - m_{mkt})(x_{it} - m_i)(x_{jt} - m_j) - f_{ij}s_{ij}
$$
       <p>
        A consistent estimator of $\gamma_{ij}$ is given by $c_{ij} = (f_{ij} - s_{ij})^2$.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Define a function implementing the presented shrinkage estimator.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We want to simulate data from the model
       </p>
       $$
r_{it} = \beta_i x_{mt} + \varepsilon_{it}
$$
       <p>
        when assuming $\beta_i \sim \mathcal{U}(-1, 1.5)$ (the $\beta$s follow a uniform distribution), $x_{mt} \sim N(0.05, 0.2^2)$ and $\varepsilon_{it} \sim N(0, 0.05^2)$.
       </p>
       <p>
        Simulate data when $T=50, N=100$ and when $T=5000, N=5$. How does the shrinkage estimates compare to the sample covariance matrix in the two cases?
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        We define the
        <em>
         percentage relative improvement in average loss
        </em>
        of $\mathbf{S}^*$ as (we omit $_T$ for simplicity)
       </p>
       $$
\text{PRIAL}(\mathbf{S}^*) = \frac{\text{E}[\Vert \mathbf{S} - \boldsymbol{\Sigma} \Vert]^2 - \text{E}[\Vert \mathbf{S}^* - \boldsymbol{\Sigma} \Vert]^2}{\text{E}[\Vert \mathbf{S} - \boldsymbol{\Sigma} \Vert]^2}
$$
       <p>
        If PRIAL is positive, then the shrinkage estimator performs better than the sample covariance.
       </p>
       <p>
        Create a simulation study that compares the PRIAL between the suggested shrinkage estimator and the sample covariance. Consider $T \in \{5, 10, 25, 50, 100, 500\}$ and maintain the assumptions from the previous question.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=collaborative-macedonia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">ledoit_wolf_single_index</span><span class="p">(</span><span class="n">returns</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">market_return</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">demean</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Computes the Ledoit and Wolf (2003) shrinkage covariance estimator</span>

<span class="sd">    See https://www.sciencedirect.com/science/article/abs/pii/S0927539803000070</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    returns:</span>
<span class="sd">        Num. observations x Num. variables</span>
<span class="sd">    market_return:</span>
<span class="sd">        Market return, 1-D array</span>
<span class="sd">    demean:</span>
<span class="sd">        Boolean indicating whether to demean data.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Covariance matrix</span>

<span class="sd">    """</span>

    <span class="c1"># get dimensions</span>
    <span class="n">T</span><span class="p">,</span> <span class="n">N</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">shape</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>

    <span class="c1"># demean returns if necessary</span>
    <span class="k">if</span> <span class="n">demean</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">returns</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
        <span class="n">x_mkt</span> <span class="o">=</span> <span class="n">market_return</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">market_return</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">returns</span>
        <span class="n">x_mkt</span> <span class="o">=</span> <span class="n">market_return</span>

    <span class="c1"># sample covariance matrix</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">x</span> <span class="o">/</span> <span class="n">T</span>

    <span class="c1"># shrinkage target</span>
    <span class="n">var_mkt</span> <span class="o">=</span> <span class="n">x_mkt</span> <span class="o">@</span> <span class="n">x_mkt</span> <span class="o">/</span> <span class="n">T</span>
    <span class="n">cov_mkt</span> <span class="o">=</span> <span class="n">x_mkt</span> <span class="o">@</span> <span class="n">x</span> <span class="o">/</span> <span class="n">T</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="n">cov_mkt</span> <span class="o">/</span> <span class="n">var_mkt</span>
    <span class="n">F</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">var_mkt</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">F</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="p">))</span>

    <span class="c1"># shrinkage intensity</span>
    <span class="c1"># estimate of pi</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">p</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x2</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">x2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">S</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># estimate rho</span>
    <span class="c1"># diagonal elements</span>
    <span class="n">r_diag</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">T</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x2</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">-</span> <span class="nb">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>

    <span class="c1"># off diagonal elements</span>
    <span class="n">z</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x_mkt</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">x2</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">z</span> <span class="o">/</span> <span class="n">T</span>
    <span class="n">r_off_diag_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v1</span> <span class="o">*</span> <span class="n">cov_mkt</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span> <span class="o">/</span> <span class="n">var_mkt</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cov_mkt</span><span class="p">)</span> <span class="o">/</span> <span class="n">var_mkt</span>

    <span class="n">v2</span> <span class="o">=</span> <span class="n">z</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">z</span> <span class="o">/</span> <span class="n">T</span>
    <span class="n">r_off_diag_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">v2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">cov_mkt</span><span class="p">,</span>  <span class="n">cov_mkt</span><span class="p">))</span> <span class="o">/</span> <span class="n">var_mkt</span><span class="o">**</span><span class="mi">2</span> \
                   <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cov_mkt</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">var_mkt</span><span class="o">**</span><span class="mi">2</span>

    <span class="n">r_off_diag_3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">F</span><span class="o">*</span><span class="n">S</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">F</span><span class="o">*</span><span class="n">S</span><span class="p">))</span>

    <span class="n">r_off_diag</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">r_off_diag_1</span> <span class="o">-</span> <span class="n">r_off_diag_2</span> <span class="o">-</span> <span class="n">r_off_diag_3</span>

    <span class="n">r</span> <span class="o">=</span> <span class="n">r_diag</span> <span class="o">+</span> <span class="n">r_off_diag</span>

    <span class="c1"># estimate gamma</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">F</span><span class="p">,</span> <span class="s2">"fro"</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="c1"># compute shrinkage constant</span>
    <span class="n">k</span> <span class="o">=</span> <span class="p">(</span><span class="n">p</span> <span class="o">-</span> <span class="n">r</span><span class="p">)</span> <span class="o">/</span> <span class="n">c</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">k</span> <span class="o">/</span> <span class="n">T</span><span class="p">))</span>

    <span class="c1"># return shrinkage estimator1</span>
    <span class="k">return</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">F</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span><span class="p">,</span> <span class="n">alpha</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=interstate-booth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=incorporate-cutting">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">mkt_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">mkt_return</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">betas</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=spiritual-blame">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=acceptable-receipt">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ledoit_wolf_single_index</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">mkt_return</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=mysterious-looking">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">N</span> <span class="o">=</span> <span class="mi">5</span>

<span class="n">mkt_return</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">returns</span> <span class="o">=</span> <span class="n">mkt_return</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">betas</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=intimate-field">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">returns</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cosmetic-visibility">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=abandoned-foundation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ledoit_wolf_single_index</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">mkt_return</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=clear-quest">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ready-making">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">55</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="c1"># set random seed </span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># true covariance matrix </span>
<span class="n">sigma_i</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">sigma_m</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">betas</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">low</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mf">1.5</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">N</span><span class="p">)</span>
<span class="n">cov_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">betas</span><span class="p">,</span> <span class="n">betas</span><span class="p">)</span><span class="o">*</span><span class="n">sigma_m</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_i</span><span class="o">**</span><span class="mi">2</span>

<span class="n">sample_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">25</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">]</span>

<span class="n">prial</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="n">sample_sizes</span><span class="p">:</span>
    <span class="n">loss_sample</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">loss_shrinkage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span> 
        
        <span class="n">mkt_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma_m</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>
        <span class="n">returns</span> <span class="o">=</span> <span class="n">mkt_returns</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">betas</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                                                                           <span class="n">scale</span><span class="o">=</span><span class="n">sigma_i</span><span class="p">,</span>
                                                                           <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span>
        
        <span class="n">mkt_return_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">sample_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">shrink_cov_mat</span> <span class="o">=</span> <span class="n">ledoit_wolf_single_index</span><span class="p">(</span><span class="n">returns</span><span class="p">,</span> <span class="n">mkt_return_test</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">loss_sample</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sample_cov_mat</span> <span class="o">-</span> <span class="n">cov_true</span><span class="p">))</span> 
        <span class="n">loss_shrinkage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">shrink_cov_mat</span> <span class="o">-</span> <span class="n">cov_true</span><span class="p">))</span>
    
    <span class="n">prial_temp</span> <span class="o">=</span>  <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_sample</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_shrinkage</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">N</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_sample</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">prial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prial_temp</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">"T=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"PRIAL: </span><span class="si">{:.2f}</span><span class="s2">%"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prial_temp</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=current-alabama">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3:-Simulating-the-gains-of-denoising-the-correlation-/-covariance-matrix">
        Problem 3: Simulating the gains of denoising the correlation / covariance matrix
        <a class="anchor-link" href="#Problem-3:-Simulating-the-gains-of-denoising-the-correlation-/-covariance-matrix">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Note:
        </strong>
        This problem is heavily inspired
        <a href="https://www.amazon.com/Machine-Learning-Managers-Elements-Quantitative/dp/1108792898">
         Marcos M. Lopéz de Prado (2020), "Machine Learning for Asset Managers"
        </a>
       </p>
       <p>
        At the lectures, we discussed how we can use random matrix theory to denoise the correlation matrix. In this problem, we will see the potential benefits  of this approach.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        In order to perform a relevant simulation study, we need to define a method for defining the true correlation structure that we will use to simulate e.g. returns.
       </p>
       <p>
        The following code can generate a random true covariance matrix and mean vector.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=allied-papua">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">form_block_corr_matrix</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_corr</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Create a block correlation matrix with a number of equal size blocks.</span>
<span class="sd">    Each block have the same inter block correlation.</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_blocks: </span>
<span class="sd">        Number of blocks</span>
<span class="sd">    block_size: </span>
<span class="sd">        Block size. </span>
<span class="sd">    block_corr</span>
<span class="sd">        Inter block correlation. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Correlation matrix.</span>

<span class="sd">    """</span>
    
    <span class="n">block</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">block_size</span><span class="p">,</span> <span class="n">block_size</span><span class="p">))</span> <span class="o">*</span> <span class="n">block_corr</span>
    <span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">block</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    
    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">block_diag</span><span class="p">(</span><span class="o">*</span><span class="p">([</span><span class="n">block</span><span class="p">]</span> <span class="o">*</span> <span class="n">num_blocks</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">corr_mat</span> 

<span class="k">def</span> <span class="nf">form_true_cov_and_mean</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_size</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">block_corr</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Creates a covariance matrix and mean vector</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    num_blocks:</span>
<span class="sd">        Number of blocks</span>
<span class="sd">    block_size:</span>
<span class="sd">        Block size.</span>
<span class="sd">    block_corr</span>
<span class="sd">        Inter block correlation.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[np.ndarray, np.ndarray]</span>
<span class="sd">        Covariance matrix, mean vector</span>
<span class="sd">    """</span>
    
    <span class="c1"># generate corr mat</span>
    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">form_block_corr_matrix</span><span class="p">(</span><span class="n">num_blocks</span><span class="p">,</span> <span class="n">block_size</span><span class="p">,</span> <span class="n">block_corr</span><span class="p">)</span>
    <span class="n">num_assets</span> <span class="o">=</span> <span class="n">corr_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
    <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">shuffle</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
    <span class="n">idx_selector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">idx</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">num_assets</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">num_assets</span><span class="p">)</span>
    
    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">corr_mat</span><span class="p">[</span><span class="n">idx_selector</span><span class="p">,</span> <span class="n">idx_selector</span><span class="o">.</span><span class="n">T</span><span class="p">]</span>
    
    <span class="c1"># generate vols</span>
    <span class="n">vols</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="n">num_assets</span><span class="p">)</span>
    
    <span class="c1"># generate cov mat</span>
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
    
    <span class="c1"># generate means (all assets have same sharpe ratio)</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_assets</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fantastic-wrist">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Simulate a the true covariance matrix when we have two blocks with five assets. Assume that the block correlation is 0.5. Plot the correlation matrix.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Simulate 50 observations from the data generating process specified above (draw 50 observation from a multivariate normal with mean vector and covariance matrix equal to the ones "simulated" above).
       </p>
       <p>
        Calculate the sample covariance and correlation matrix.
       </p>
       <p>
        Plot the empirical correlation matrix.
       </p>
       <p>
        <strong>
         Quesition 3
        </strong>
       </p>
       <p>
        We have at the lectures looked at how we can denoise the correlation matrix. We seek to specificy a method to denoise the covariance matrix. Below, we have defined a function to denoise the covariance matrix.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=rural-marble">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">denoise_cov_mat</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span><span class="nb">float</span><span class="p">,</span> <span class="n">bandwidth</span><span class="p">:</span><span class="nb">float</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">x_eval</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">-&amp;gt;</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Denoises covariance matrix</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    cov_mat: </span>
<span class="sd">        Covariance matrix. </span>
<span class="sd">    ratio: </span>
<span class="sd">        Ratio between num. variables and num. obs. </span>
<span class="sd">    bandwidth: </span>
<span class="sd">        Bandwidth for kernel density. </span>
<span class="sd">    x_eval: </span>
<span class="sd">        Values for which to evaluate the pdf. </span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Denoised covariance matrix. </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="k">if</span> <span class="n">x_eval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
    
    <span class="c1"># get corr mat</span>
    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="c1"># get eig vals and eig vectors </span>
    <span class="n">eig_vals</span><span class="p">,</span> <span class="n">eig_vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">)</span>
    
    <span class="c1"># estimate largest random eigenvalue </span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">fitting_error</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">x_eval</span><span class="p">,</span> <span class="n">eig_vals</span><span class="p">),</span>
                            <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">),))</span>
    
    <span class="n">var</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">lambda_max</span> <span class="o">=</span> <span class="n">marchencko_pastur_bounds</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="c1"># number of recovered true factors</span>
    <span class="n">num_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eig_vals</span> <span class="o">&amp;gt;</span> <span class="n">lambda_max</span><span class="p">)</span>
    
    <span class="c1"># make sure that eigenvalues and eigenvectors are sorted</span>
    <span class="n">indices</span> <span class="o">=</span> <span class="n">eig_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">eig_vals_sorted</span> <span class="o">=</span> <span class="n">eig_vals</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
    <span class="n">eig_vectors_sorted</span> <span class="o">=</span> <span class="n">eig_vectors</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span>
    
    <span class="c1"># get denoised corr mat </span>
    <span class="n">denoised_corr</span> <span class="o">=</span> <span class="n">crem_denoised_corr_mat</span><span class="p">(</span><span class="n">eig_vals_sorted</span><span class="p">,</span> <span class="n">eig_vectors_sorted</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">)</span>
    
    <span class="c1"># new cov mat                                       </span>
    <span class="n">new_cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">denoised_corr</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">new_cov_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=accompanied-virgin">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Denoise the previously estimated covariance matrix. Plot the denoised correlation matrix.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Define a function returning the minimum variance or the maximum Sharpe ratio portfolio given the covariance matrix and in the latter case also the mean vector.
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        We are now ready to perform a simulation study:
       </p>
       <ol>
        <li>
         Generate a covariance matrix and mean vector when we assume that we have 10 blocks of size 50 with correlation 0.5.
        </li>
        <li>
         Generate 1000 observations from this model 1000 times. Estimate for each iteration the optimal weights (just minimum variance).
        </li>
        <li>
         Compare the RMSE when using respectively the sample covariance and the denoised covariance (compare with the true minimum variance weights).
        </li>
       </ol>
       <p>
        Note that the
        <a href="https://en.wikipedia.org/wiki/Root-mean-square_deviation">
         Root Mean Squared Error (RMSE)
        </a>
        is given by
       </p>
       $$
\text{RMSE} = \sqrt{\text{E}[(\hat{\theta}- \theta])^2}
$$
       <p>
        What approach yields the smallest RMSE?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=danish-designation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        We see what we expected. We have constructed a correlation matrix where each asset is correlated with four other assets.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=informational-spotlight">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu_true</span><span class="p">,</span> <span class="n">cov_mat_true</span> <span class="o">=</span> <span class="n">form_true_cov_and_mean</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">corr_mat_true</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_mat_true</span><span class="p">)</span>

<span class="n">correlation_plot</span><span class="p">(</span><span class="n">corr_mat_true</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=proved-klein">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We see the same structure, but also some randomness!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=quantitative-concentrate">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu_true</span><span class="p">,</span> <span class="n">cov_mat_true</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">cov_mat_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">corr_mat_est</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">)</span>

<span class="n">correlation_plot</span><span class="p">(</span><span class="n">corr_mat_est</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=instant-sugar">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=written-bacon">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cov_mat_denoised</span> <span class="o">=</span> <span class="n">denoise_cov_mat</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,</span> <span class="mi">10</span> <span class="o">/</span> <span class="mi">50</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=rubber-ownership">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cov_mat_denoised</span>
<span class="n">corr_mat_denoised</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_mat_denoised</span><span class="p">)</span>

<span class="n">correlation_plot</span><span class="p">(</span><span class="n">corr_mat_est</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=chicken-coalition">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        The minimum-variance portfolio is given by
       </p>
       $$
\begin{align}
\mathbf{w}_{\text{Min-Var}} = \frac{\boldsymbol{\Sigma}^{-1} \mathbf{1}}{\mathbf{1}^\top \boldsymbol{\Sigma}^{-1} \mathbf{1}}
\end{align}
$$
       <p>
        and the tangency portfolio (max Sharpe) is given by
       </p>
       $$
\mathbf{w}_{\text{Max-Sharpe}} = \frac{\boldsymbol{\Sigma}^{-1}(\boldsymbol{\mu} - r_f \mathbf{1})}{\mathbf{1}^\top \boldsymbol{\Sigma}^{-1}(\boldsymbol{\mu} - r_f \mathbf{1})}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=modular-general">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">optimal_portfolio_weights</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates either the minimum-variance or tangency portfolio. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cov_mat: </span>
<span class="sd">        Covariance matrix of returns</span>
<span class="sd">    mu: </span>
<span class="sd">        Expected excess returns. </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Optimal portfolio weights. </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="n">inv_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="n">one_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="k">if</span> <span class="n">mu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">one_vec</span>
        
    <span class="n">opt_w</span> <span class="o">=</span> <span class="n">inv_cov_mat</span> <span class="o">@</span> <span class="n">mu</span>
    <span class="n">opt_w</span> <span class="o">/=</span> <span class="n">one_vec</span> <span class="o">@</span> <span class="n">opt_w</span>
    
    <span class="k">return</span> <span class="n">opt_w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=assumed-tumor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=private-establishment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu_true</span><span class="p">,</span> <span class="n">cov_mat_true</span> <span class="o">=</span> <span class="n">form_true_cov_and_mean</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">)</span>
<span class="n">corr_mat_true</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_mat_true</span><span class="p">)</span>

<span class="n">true_min_var_weights</span> <span class="o">=</span> <span class="n">optimal_portfolio_weights</span><span class="p">(</span><span class="n">cov_mat_true</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">num_obs</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">opt_weights_s</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">opt_weights_d</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu_true</span><span class="p">,</span> <span class="n">cov_mat_true</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_obs</span><span class="p">)</span>
    <span class="n">cov_mat_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">corr_mat_est</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">)</span>
    <span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="n">cov_mat_denoised</span> <span class="o">=</span> <span class="n">denoise_cov_mat</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,</span> <span class="n">ratio</span> <span class="o">=</span> <span class="n">cov_mat_est</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="n">num_obs</span><span class="p">)</span>
    
    <span class="n">opt_weights_d</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimal_portfolio_weights</span><span class="p">(</span><span class="n">cov_mat_denoised</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    <span class="n">opt_weights_s</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimal_portfolio_weights</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="kc">None</span><span class="p">))</span>
    
<span class="n">opt_weights_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_weights_d</span><span class="p">)</span>
<span class="n">opt_weights_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_weights_s</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fallen-radiation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">RMSE</span>
<span class="sd">"""</span>

<span class="n">rmse_s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">opt_weights_s</span> <span class="o">-</span> <span class="n">true_min_var_weights</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rmse_s</span><span class="p">)</span>

<span class="n">rmse_d</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">opt_weights_d</span> <span class="o">-</span> <span class="n">true_min_var_weights</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">rmse_d</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=dependent-commons">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Clearly, the denoised covariance matrix results in the lowest RMSE!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=moderate-consistency">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4:-The-distribution-of-the-covariance-matrix-with-normally-distributed-variables">
        Problem 4: The distribution of the covariance matrix with normally distributed variables
        <a class="anchor-link" href="#Problem-4:-The-distribution-of-the-covariance-matrix-with-normally-distributed-variables">
         ¶
        </a>
       </h2>
       <p>
        Assume that $X_i \sim N(\mu, \sigma^2)$  and consider a random sample of size $T$. Define the sample mean
       </p>
       $$
\bar{X} = \frac{1}{T} \sum_{i=1}^T X_i
$$
       <p>
        and the sample variance
       </p>
       $$
S^2 = \frac{1}{T-1} \sum_{i=1}^T (X_i - \bar{X})^2
$$
       <p>
        We know that
       </p>
       $$
\bar{X} \sim N(\mu, \sigma^2 / T)
$$
       <p>
        It is possible to show that using the known $\mu$
       </p>
       $$
\frac{\sum_{i=1}^T (X_i - \mu)^2}{\sigma^2} \sim \chi^2 (T)
$$
       <p>
        and when losing one degree of freedom from estimating the mean
       </p>
       $$
\frac{\sum_{i=1}^T (X_i - \bar{X})^2}{\sigma^2} = \frac{(T-1)S^2}{\sigma^2}  \sim \chi^2 (T - 1)
$$
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Assume $\sigma = 0.2$, $\mu = 0$ and $T=10$. Perform a simulation study to check if the distributional assumptions are correct.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We could rewrite the above expression such that
       </p>
       $$
S^2 \sim \frac{\sigma^2}{T-1} C
$$
       <p>
        where $C \sim \chi^2 (T - 1)$. It follows directly that
       </p>
       $$
\text{E}[S^2] = \frac{\sigma^2}{T-1} (T-1) = \sigma^2
$$
       <p>
        and
       </p>
       $$
\text{Var}[S^2] = \frac{\sigma^4}{(T-1)^2} 2 (T-1) = \frac{2 \sigma^4}{(T-1)}
$$
       <p>
        What happens when we increase $T$?
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        The above can be generalized to the multivariate normal case. If we assume that $\mathbf{X}_i \sim N(\boldsymbol{\mu}, \boldsymbol{\Sigma})$ follows a multivariate normal then
       </p>
       $$
T \mathbf{S}_T = \mathbf{Y}^\top \mathbf{Y} \sim W(\boldsymbol{\Sigma}, T)
$$
       <p>
        where $\mathbf{Y}$ is a matrix with demeaned data using the true $\boldsymbol{\mu}$ and $W(\boldsymbol{\Sigma}, T)$ denotes a
        <a href="https://en.wikipedia.org/wiki/Wishart_distribution">
         Wishart distribution
        </a>
        with $T$ degrees of freedom. If we use the sample mean to demean, we would have
       </p>
       $$
T \mathbf{S}_T = \mathbf{Y}^\top \mathbf{Y} \sim W(\boldsymbol{\Sigma}, T-1)
$$
       <p>
        Assume
       </p>
       $$
\mathbf{X}_i \sim N(\mathbf{0}, \boldsymbol{\Sigma})
$$
       <p>
        with $T = 25$ and
       </p>
       $$
\boldsymbol{\Sigma} =
\begin{bmatrix} 
1.0 &amp;amp; 0.9 &amp;amp;  0.7 \\
0.9 &amp;amp; 1.0 &amp;amp; 0.4 \\
0.7 &amp;amp; 0.4 &amp;amp; 1.0 \end{bmatrix}
$$
       <p>
        Simulate 10000 realizations of sample the covariance matrix and plot the histogram of $\rho_{1,2}$ (sample correlation between the first and second variable).
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Consider the same covariance matrix as in problem 1. Simulate the distribution of the minimum-variance weights.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=adaptive-perth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.2</span>
<span class="n">num_obs</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">x_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=embedded-marker">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">x_sim</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">x_demean_true</span> <span class="o">=</span> <span class="n">x_sim</span> <span class="o">-</span> <span class="n">mu</span>
<span class="n">x_demean_sample</span> <span class="o">=</span> <span class="n">x_sim</span> <span class="o">-</span> <span class="n">mu_est</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>

<span class="n">test_stat_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x_demean_true</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">test_stat_sample</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x_demean_sample</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=placed-viking">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">True mu </span>
<span class="sd">"""</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True density, dof=10"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">test_stat_true</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Density"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Distribution of test statistic when using known $\mu$"</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">sample mean</span>
<span class="sd">"""</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mi">40</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">num_obs</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True density, dof=9"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">test_stat_sample</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>  <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Density"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Distribution of test statistic when using estimated $\mu$"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=latter-petite">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We see that the distribution collapses around the true value.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=crude-politics">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="n">pdf_values_10</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">10</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="mi">10</span><span class="p">))</span>
<span class="n">pdf_values_25</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">25</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="mi">25</span><span class="p">))</span>
<span class="n">pdf_values_50</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">50</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="mi">50</span><span class="p">))</span>
<span class="n">pdf_values_100</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">100</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="mi">100</span><span class="p">))</span>
<span class="n">pdf_values_1000</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">chi2</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="mi">1000</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span><span class="mi">1000</span><span class="p">))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">pdf_values_10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True density, dof=9 (T=10)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">pdf_values_25</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True density, dof=24 (T=25)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">pdf_values_50</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True density, dof=49 (T=50)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">pdf_values_100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True density, dof=99 (T=100)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">pdf_values_1000</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True density, dof=9999 (T=1000)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True variance"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Distribution of $S^2$  for different T"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=labeled-trustee">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=surprised-authorization">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">T</span> <span class="o">=</span> <span class="mi">25</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
              <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
              <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">90000</span>

<span class="n">sim_cov_mat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">wishart</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">C</span> <span class="o">/</span> <span class="n">T</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span> 
<span class="n">sim_corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">sim_cov_mat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">)])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fallen-antigua">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_corr_mat</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">rho_{1, 2}$"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Density"</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_corr_mat</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">],</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">rho_{2, 3}$"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Density"</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=annoying-david">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=outer-earth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># sample lenght</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">25</span>

<span class="c1"># correlations</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.2</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                     <span class="p">[</span><span class="o">-</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
<span class="c1"># volatilities</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="c1"># calculate covariance matrix </span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>

<span class="c1"># sim covariances</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">90000</span>
<span class="n">sim_cov_mat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">wishart</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">cov_mat</span> <span class="o">/</span> <span class="n">T</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=blessed-texas">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sim_opt_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">optimal_portfolio_weights</span><span class="p">(</span><span class="n">sim_cov_mat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">)])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=appointed-implementation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">w_opt</span> <span class="o">=</span> <span class="n">optimal_portfolio_weights</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=romantic-husband">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">w_opt</span><span class="p">)):</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_opt_weights</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Sim. distribution"</span><span class="p">);</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"$w_</span><span class="si">{}</span><span class="s2">$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">w_opt</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True, optimal weight"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Density"</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Sim. distribution of minimum-variance weights for asset </span><span class="si">{}</span><span class="s1">'</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=adjacent-department">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-5:-Time-varying-correlation">
        Problem 5: Time-varying correlation
        <a class="anchor-link" href="#Problem-5:-Time-varying-correlation">
         ¶
        </a>
       </h2>
       <p>
        We have so far assumed that data was identically and independent distributed when estimating covariance matrices and defining shrinkage estimators. However, in financial markets returns may be uncorrelated but we often find dependence in higher order moments. E.g. financial returns often exhibit volatility clustering.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Get adjusted stock prices for Facebook (META), Amazon (AMZN), Apple (AAPL), Netflix (NFLX), and Alphabet (GOOG) from 2014. Calculate daily log returns.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We want to specify an exponential filter to estimate the covariance matrix. To that end, we define ($\mathbf{x}_t$ is the return vector at time $t$)
       </p>
       $$
\boldsymbol{\mu}^{\lambda}_{T+1} = \gamma \sum_{t=1}^T e^{-\lambda (T-t)} \mathbf{x}_t
$$
       <p>
        and
       </p>
       $$
\boldsymbol{\Sigma}^{\lambda}_{T+1} = \gamma \sum_{t=1}^T e^{-\lambda (T-t)} \mathbf{x}_t \mathbf{x}_t^\top  - \boldsymbol{\mu}^{\lambda}_{T+1} (\boldsymbol{\mu}^{\lambda}_{T+1})^\top
$$
       <p>
        where $\gamma = 1 /  \sum_{t=1}^T e^{-\lambda (T-t)}$ to make the weights sum to one. $\lambda$ controls the decay of the exponential filter. A $\lambda=0.0055$ will represent a half-life of approximately six months with daily data.
       </p>
       <p>
        Implement the exponential filter and apply it with $\lambda=0.0055$ on the downloaded data set.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Plot the variance of Facebook.
       </p>
       <p>
        Plot the correlation between Facebook and all the other stocks over the time period.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Quesition 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=medieval-airplane">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span> <span class="c1"># yfiance can also directly be used to get data</span>

<span class="sd">"""</span>
<span class="sd">Get adjusted stock prices for Facebook (META), Amazon (AMZN), Apple (AAPL), </span>
<span class="sd">Netflix (NFLX), and Alphabet (GOOG).</span>
<span class="sd">"""</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"META"</span><span class="p">,</span> <span class="s2">"AMZN"</span><span class="p">,</span> <span class="s2">"AAPL"</span><span class="p">,</span> <span class="s2">"NFLX"</span><span class="p">,</span> <span class="s2">"GOOG"</span><span class="p">]</span>
<span class="n">faang</span> <span class="o">=</span><span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">date</span><span class="p">(</span><span class="mi">2014</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>

<span class="sd">"""</span>
<span class="sd">Get adjusted close and normalize</span>
<span class="sd">"""</span>
<span class="n">faang_adj_close</span> <span class="o">=</span> <span class="n">faang</span><span class="p">[</span><span class="s1">'Adj Close'</span><span class="p">]</span>
<span class="n">faang_adj_close</span> <span class="o">=</span> <span class="n">faang_adj_close</span> <span class="o">/</span> <span class="n">faang_adj_close</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mi">100</span>

<span class="sd">"""</span>
<span class="sd">Plot stock prices</span>
<span class="sd">"""</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">faang_adj_close</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">));</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.35</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Index value'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=romance-disability">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">faang_adj_log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">faang_adj_close</span> <span class="o">/</span> <span class="n">faang_adj_close</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=genuine-spyware">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">faang_adj_log_ret</span><span class="o">.</span><span class="n">tail</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=complex-running">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=invalid-negotiation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">data</span> <span class="o">=</span> <span class="n">faang_adj_log_ret</span><span class="o">.</span><span class="n">values</span>

<span class="k">def</span> <span class="nf">covariance_exponential_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">0.0055</span><span class="p">,</span> <span class="n">zero_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    
    <span class="n">data_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,jk-&amp;gt;jik'</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span>
    <span class="n">T</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">cov_matrices</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    
    <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">T</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>

        <span class="n">tp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>
        <span class="n">weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">decay</span> <span class="o">*</span> <span class="n">tp</span><span class="p">))</span>
        <span class="n">sum_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="o">~</span><span class="n">zero_mean</span><span class="p">:</span>
            <span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data</span><span class="p">[:</span><span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">sum_weights</span>
        
        <span class="n">cov_est</span> <span class="o">=</span>   <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">data_out</span><span class="p">[:</span><span class="n">t</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">/</span> <span class="n">sum_weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">mu_est</span><span class="p">,</span> <span class="n">mu_est</span><span class="p">)</span>
    
        <span class="n">cov_matrices</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cov_est</span><span class="p">)</span>
        
    <span class="n">cov_matrices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">cov_matrices</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">cov_matrices</span>


<span class="n">cov_matrices</span> <span class="o">=</span> <span class="n">covariance_exponential_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">0.0055</span><span class="p">,</span> <span class="n">zero_mean</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">corr_matrices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_matrices</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov_matrices</span><span class="p">))])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=optical-weapon">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">faang_adj_log_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">cov_matrices</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">250</span><span class="p">));</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Facebook's volatility seems to be time varying"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Volatility (annualized)"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=checked-dietary">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">faang_adj_log_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">2</span><span class="p">:,</span> <span class="p">],</span> <span class="n">corr_matrices</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">i</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">tickers</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Facebook's correlation with other FAANG stocks"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Volatility (annualized)"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">]);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.sciencedirect.com/science/article/abs/pii/S0927539803000070">
         Ledoit and Wolf (2003), Improved estimation of the covariance matrix
of stock returns with an application to
portfolio selection
        </a>
       </p>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2650644">
         Ardia, Bolliger, Boudt, Fleury (2017), The Impact of Covariance Misspecification in Risk-Based Portfolios
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.com/Machine-Learning-Managers-Elements-Quantitative/dp/1108792898">
         Marcos M. Lopéz de Prado (2020), "Machine Learning for Asset Managers"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.linalg</span> <span class="kn">import</span> <span class="n">block_diag</span>

<span class="kn">from</span> <span class="nn">pandas_datareader.data</span> <span class="kn">import</span> <span class="n">DataReader</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.risk_metrics</span> <span class="kn">import</span> <span class="n">drawdown</span><span class="p">,</span> <span class="n">maxdrawdown</span><span class="p">,</span> <span class="n">calculate_conditional_value_at_risk</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">correlation_plot</span><span class="p">,</span> <span class="n">fan_chart</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span><span class="p">,</span> <span class="n">default_colors</span>
<span class="n">DefaultStyle</span><span class="p">();</span>

<span class="kn">from</span> <span class="nn">codelib.statistics.moments</span> <span class="kn">import</span> <span class="n">corr_to_cov_matrix</span><span class="p">,</span> <span class="n">cov_to_corr_matrix</span>
<span class="kn">from</span> <span class="nn">codelib.statistics.robust_covariance</span> <span class="kn">import</span> <span class="n">marchencko_pastur_bounds</span><span class="p">,</span> <span class="n">marchencko_pastur_density</span><span class="p">,</span> <span class="n">fitting_error</span><span class="p">,</span> <span class="n">crem_denoised_corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=streaming-vertex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Exercises---Week-9">
        Exercises - Week 9
        <a class="anchor-link" href="#Exercises---Week-9">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=finite-blond">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1:--Portfolio-characteristics">
        Problem 1:  Portfolio characteristics
        <a class="anchor-link" href="#Problem-1:--Portfolio-characteristics">
         ¶
        </a>
       </h2>
       <p>
        In this exercise, we will compare a value weighted versus an equally weighted strategy on the sector level.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Obtain the Fama-French "12 industry portfolios" since 1999. Calculate a equally weighted return index and a value weighted return index.
       </p>
       <p>
        Plot the time series of the index development.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Plot a drawdown plot for the two indices.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Calculate the arithmetic and geometric return.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Calculate the ann. volatility. Also calculate the skewness and kurtosis.
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        Which strategy would you prefer?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=norman-monitor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s2">"12_Industry_Portfolios"</span><span class="p">,</span>
                          <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">industry_port</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># print description</span>
<span class="n">industry_port</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sudden-crossing">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get equally weighted</span>
<span class="n">ind_eq_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">ind_eq_weighted</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ind_eq_weighted</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="c1">#ind_eq_weighted.index = pd.to_datetime(ind_eq_weighted.index, format="%Y-%m")</span>

<span class="c1"># get market cap weighted </span>
<span class="n">ind_mc_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="c1">#ind_mc_weighted.index = pd.to_datetime(ind_mc_weighted.index, format="%Y%m")</span>

<span class="c1"># get number of companies in each sector</span>
<span class="n">num_companies</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
<span class="n">num_companies</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">num_companies</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="c1">#num_companies.index = pd.to_datetime(num_companies.index, format="%Y%m")</span>

<span class="c1"># get average firm size </span>
<span class="n">avg_firm_size</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>
<span class="n">avg_firm_size</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">avg_firm_size</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
<span class="c1">#avg_firm_size.index = pd.to_datetime(avg_firm_size.index, format="%Y%m")</span>

<span class="c1"># get sector market cap </span>
<span class="n">sector_mkt_cap</span>  <span class="o">=</span> <span class="n">num_companies</span> <span class="o">*</span> <span class="n">avg_firm_size</span>
<span class="n">total_mkt_cap</span> <span class="o">=</span> <span class="n">sector_mkt_cap</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># get relative market cap</span>
<span class="n">sector_mkt_cap_relative</span> <span class="o">=</span> <span class="n">sector_mkt_cap</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">total_mkt_cap</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="s2">"rows"</span><span class="p">)</span>

<span class="c1"># calculate market return </span>
<span class="n">market_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">sector_mkt_cap_relative</span> <span class="o">*</span> <span class="n">ind_mc_weighted</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>

<span class="c1"># calculate equal weighted return </span>
<span class="n">equal_weighted_return</span> <span class="o">=</span> <span class="p">(</span><span class="n">ind_mc_weighted</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s2">"columns"</span><span class="p">)</span>

<span class="c1"># asset list</span>
<span class="n">asset_list</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=collective-bracelet">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mkt_index</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">market_return</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
<span class="n">eq_index</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">equal_weighted_return</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=royal-control">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">mkt_index</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Value weighted"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
<span class="n">eq_index</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equally weighted"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Index value"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=operating-rings">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=deadly-reflection">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">dd_mkt</span> <span class="o">=</span> <span class="n">drawdown</span><span class="p">(</span><span class="n">mkt_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">dd_eq</span> <span class="o">=</span> <span class="n">drawdown</span><span class="p">(</span><span class="n">eq_index</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=southeast-assumption">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">dd_mkt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Value weighted"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
<span class="n">dd_eq</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equally weighted"</span><span class="p">,</span> <span class="n">xlabel</span><span class="o">=</span><span class="s2">""</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Drawdown"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=mobile-harvey">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3 and 4
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=behavioral-vaccine">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">portfolio_descriptive</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'Value weighted'</span><span class="p">,</span> <span class="s1">'Equally weighted'</span><span class="p">])</span>

<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Arithmetic Avg. return (ann.)'</span><span class="p">,</span> <span class="s1">'Value weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">market_return</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span>
<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Arithmetic Avg. return (ann.)'</span><span class="p">,</span> <span class="s1">'Equally weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">average</span><span class="p">(</span><span class="n">equal_weighted_return</span><span class="p">)</span> <span class="o">*</span> <span class="mi">12</span>

<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Geometric return (ann.)'</span><span class="p">,</span> <span class="s1">'Value weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">mkt_index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mi">12</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mkt_index</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Geometric return (ann.)'</span><span class="p">,</span> <span class="s1">'Equally weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">eq_index</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="p">(</span><span class="mi">12</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">eq_index</span><span class="p">))</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Volatility (ann.)'</span><span class="p">,</span> <span class="s1">'Value weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_return</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>
<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Volatility (ann.)'</span><span class="p">,</span> <span class="s1">'Equally weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">equal_weighted_return</span><span class="o">.</span><span class="n">std</span><span class="p">()</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span>

<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Kurtosis'</span><span class="p">,</span> <span class="s1">'Value weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_return</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>
<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Kurtosis'</span><span class="p">,</span> <span class="s1">'Equally weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">equal_weighted_return</span><span class="o">.</span><span class="n">kurt</span><span class="p">()</span>

<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Skewness'</span><span class="p">,</span> <span class="s1">'Value weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">market_return</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
<span class="n">portfolio_descriptive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="s1">'Skewness'</span><span class="p">,</span> <span class="s1">'Equally weighted'</span><span class="p">]</span> <span class="o">=</span> <span class="n">equal_weighted_return</span><span class="o">.</span><span class="n">skew</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=brazilian-point">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">portfolio_descriptive</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=funded-graduation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        ?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=2bfb2c8c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2:-Satisfaction-and-portfolio-optimization">
        Problem 2: Satisfaction and portfolio optimization
        <a class="anchor-link" href="#Problem-2:-Satisfaction-and-portfolio-optimization">
         ¶
        </a>
       </h2>
       <p>
        For simplicity, we consider the case where the linear returns follow a multivariate normal distribution
       </p>
       $$
\mathbf{R} \sim MVN(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        Furthermore, assume that the investor's utility is given as a function of the wealth one year in the future $\Psi_1$ (exponential utility)
       </p>
       $$
U(\Psi_1) = -e^{-\frac{1}{\gamma} \Psi_1}, \; \gamma&amp;gt;0,
$$
       <p>
        the initial wealth is $\psi_0 = 1$, and that all assets has an initial price of one.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        Derive the distribution of wealth $\Psi_1$ when assuming the allocation $\boldsymbol{\alpha}$ such that the wealth after one year is given by
       </p>
       $$
\Psi_1 = \boldsymbol{\alpha}^\top (1  + \mathbf{R})
$$
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Since the wealth $\Psi_1$ will be normally distributed, then it is possible to show that
       </p>
       $$
E[-e^{-\frac{1}{\gamma} \Psi_1}] = -e^{-\frac{1}{\gamma} E[\Psi_1] + \frac{1}{2 \gamma^2}Var[\Psi_1]}
$$
       <p>
        The Certainty-Equivalent (CE) is given by (should look familiar)
       </p>
       $$
\text{CE}(\boldsymbol{\alpha}) = U^{-1}(E[-e^{-\frac{1}{\gamma} \Psi_1}]) = - \gamma \ln (-E[-e^{-\frac{1}{\gamma} \Psi_1}]) =  E[\Psi_1] - \frac{1}{2 \gamma}Var[\Psi_1]
$$
       <p>
        Assume $\gamma = 1$. Plot level curves, the combinations of $E[\Psi_1]$ and $Var[\Psi_1]$ that give the same utility, when the asset universe consists of 10 assets with $\boldsymbol{\mu} = (0.01, 0.02, ...,  0.10)^\top$ and $\boldsymbol{\Sigma} = Diag((0.05^2, 0.06^2, ..., 0.14^2))$. At least plot the level curve on which the equally weighted portfolio is (note that the equally weighted portfolio is defined by $\alpha_i = \psi_0 / 10$ for $i=1, ..., 10$).
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Find the optimal allocation
       </p>
       $$
\boldsymbol{\alpha}^* = \arg \max_{\boldsymbol{\alpha}} \boldsymbol{\alpha}^\top (1 + \boldsymbol{\mu}) - \frac{1}{2 \gamma} \boldsymbol{\alpha}^\top \boldsymbol{\Sigma} \boldsymbol{\alpha}
$$
       <p>
        subject to $\boldsymbol{\alpha}^\top \boldsymbol{1} = \psi_0$.
       </p>
       <p>
        Define a function calculating the optimal allocation and calculate thereafter the optimal allocation.
       </p>
       <p>
        Add the level curve on which we find the optimal portfolio to the plot.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Add the mean-variance efficient frontier to the plot. What to you observe?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       $$
\Psi_1 \sim N(\boldsymbol{\alpha}^\top (1  + \boldsymbol{\mu}), \boldsymbol{\alpha}^\top \Sigma \boldsymbol{\alpha})
$$
       <p>
        <strong>
         Question 2
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=519be18a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">num_assets</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.101</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.141</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">)</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vols</span><span class="p">)</span>
<span class="n">gamma</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">initial_wealth</span> <span class="o">=</span> <span class="mi">1</span> <span class="c1"># _000_000</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=56490466">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_port_variance</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="n">alpha</span> <span class="o">@</span> <span class="n">cov_mat</span> <span class="o">@</span> <span class="n">alpha</span> 

<span class="k">def</span> <span class="nf">calculate_port_expected_value</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="n">alpha</span> <span class="o">@</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">mu</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_certainty_equivalent</span><span class="p">(</span><span class="n">alpha</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                   <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                   <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                   <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">):</span> 
    
    <span class="n">exp_wealth</span> <span class="o">=</span> <span class="n">calculate_port_expected_value</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
    <span class="n">var_wealth</span> <span class="o">=</span> <span class="n">calculate_port_variance</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">exp_wealth</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">var_wealth</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=bb7c8d13">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">w_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_assets</span>
<span class="n">alpha_eq</span> <span class="o">=</span> <span class="n">w_eq</span> <span class="o">*</span> <span class="n">initial_wealth</span>
<span class="n">eq_expected_wealth</span> <span class="o">=</span> <span class="n">calculate_port_expected_value</span><span class="p">(</span><span class="n">alpha_eq</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">eq_var</span> <span class="o">=</span> <span class="n">calculate_port_variance</span><span class="p">(</span><span class="n">alpha_eq</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">eq_ce</span> <span class="o">=</span> <span class="n">calculate_certainty_equivalent</span><span class="p">(</span><span class="n">alpha_eq</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=67d987aa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">eq_ce</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=f3e7f234">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Solving for $E[\Psi_1]$ in $\text{CE}(\boldsymbol{\alpha}) = E[\Psi_1] - \frac{1}{2 \gamma}Var[\Psi_1]$ yields
       </p>
       $$
E[\Psi_1] = \text{CE}(\boldsymbol{\alpha}) +  \frac{1}{2 \gamma}Var[\Psi_1]
$$
       <p>
        which we can use to plot level curves
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=eddc47b5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ce_levels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.25</span> <span class="o">+</span> <span class="n">eq_ce</span><span class="p">,</span> <span class="n">eq_ce</span><span class="p">,</span> <span class="n">eq_ce</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">]</span>
<span class="n">std_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Standard deviation of portfolio value"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">"Expected portfolio value"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b9999e34">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        From the problem
       </p>
       $$
\boldsymbol{\alpha}^* = \arg \max_{\boldsymbol{\alpha}} \boldsymbol{\alpha}^\top (1 + \boldsymbol{\mu}) - \frac{1}{2 \gamma} \boldsymbol{\alpha}^\top \boldsymbol{\Sigma} \boldsymbol{\alpha}
$$
       <p>
        subject to $\boldsymbol{\alpha}^\top \boldsymbol{1} = \psi_0$, we can write the Lagrangian ($\lambda$ is here the Lagrange multiplier)
       </p>
       $$
\mathcal{L}(\boldsymbol{\alpha}, \lambda) = \boldsymbol{\alpha}^\top (1 + \boldsymbol{\mu}) - \frac{1}{2 \gamma} \boldsymbol{\alpha}^\top \boldsymbol{\Sigma} \boldsymbol{\alpha} + \lambda \left(\boldsymbol{\alpha}^\top \mathbf{1} - \psi_0 \right)
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3100ff7b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The first order conditions read
       </p>
       $$
\begin{align}
\frac{\partial \mathcal{L}(\boldsymbol{\alpha}, \lambda)}{\partial \boldsymbol{\alpha}} &amp;amp;=  (1 + \boldsymbol{\mu}) - \frac{1}{\gamma} \boldsymbol{\Sigma} \boldsymbol{\alpha}  + \lambda \mathbf{1} = \mathbf{0} \\
\frac{\partial \mathcal{L}(\boldsymbol{\alpha}, \lambda)}{\partial \lambda} &amp;amp;= \boldsymbol{\alpha}^\top \mathbf{1} - \psi_0 = 0
\end{align}
$$
       <p>
        From the first condition, we obtain
       </p>
       $$
\boldsymbol{\alpha}^* =  \gamma \boldsymbol{\Sigma}^{-1}(1 + \boldsymbol{\mu})  + \gamma \boldsymbol{\Sigma}^{-1} \lambda \mathbf{1}
$$
       <p>
        Then, we obtain
       </p>
       $$
\mathbf{1}^\top \boldsymbol{\alpha}^* = \gamma  \mathbf{1}^\top \boldsymbol{\Sigma}^{-1}(1 + \boldsymbol{\mu})  + \gamma \mathbf{1}^\top \boldsymbol{\Sigma}^{-1}  \mathbf{1} \lambda = \psi_0
$$
       <p>
        Thus,
       </p>
       $$
\lambda^* = \frac{\psi_0 -  \gamma  \mathbf{1}^\top \boldsymbol{\Sigma}^{-1}(1 + \boldsymbol{\mu})}{\gamma \mathbf{1}^\top \boldsymbol{\Sigma}^{-1}  \mathbf{1}}
$$
       <p>
        Inserting into the optimality condition for $\boldsymbol{\alpha}$
       </p>
       $$
\boldsymbol{\alpha}^* =  \gamma \boldsymbol{\Sigma}^{-1}(1 + \boldsymbol{\mu})  + \gamma \boldsymbol{\Sigma}^{-1} \lambda \mathbf{1} = \gamma \boldsymbol{\Sigma}^{-1}(1 + \boldsymbol{\mu})  + \frac{\psi_0 -  \gamma  \mathbf{1}^\top \boldsymbol{\Sigma}^{-1}(1 + \boldsymbol{\mu})}{ \mathbf{1}^\top \boldsymbol{\Sigma}^{-1}  \mathbf{1}} \boldsymbol{\Sigma}^{-1}  \mathbf{1}
$$
       <p>
        <strong>
         Note: Alternatively, one could just find the numerical solution
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3e23894d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_optimal_alpha</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">initial_wealth</span><span class="p">,</span> <span class="n">gamma</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">5.0</span><span class="p">):</span> 
    
    <span class="n">cov_mat_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="n">one_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    
    <span class="n">part1</span> <span class="o">=</span> <span class="n">gamma</span><span class="o">*</span><span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">mu</span><span class="p">)</span>
    
    <span class="n">part2</span> <span class="o">=</span> <span class="p">(</span><span class="n">initial_wealth</span> <span class="o">-</span> <span class="n">one_vec</span> <span class="o">@</span> <span class="n">part1</span><span class="p">)</span>  <span class="o">*</span> <span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="n">one_vec</span>  <span class="o">/</span> <span class="p">(</span><span class="n">one_vec</span> <span class="o">@</span> <span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="n">one_vec</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">part1</span> <span class="o">+</span> <span class="n">part2</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=d03c95b0">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">alpha_opt</span> <span class="o">=</span> <span class="n">calculate_optimal_alpha</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">initial_wealth</span><span class="p">,</span> <span class="n">gamma</span><span class="p">)</span>
<span class="n">opt_expected_wealth</span> <span class="o">=</span> <span class="n">calculate_port_expected_value</span><span class="p">(</span><span class="n">alpha_opt</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">opt_var</span> <span class="o">=</span> <span class="n">calculate_port_variance</span><span class="p">(</span><span class="n">alpha_opt</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">opt_ce</span> <span class="o">=</span> <span class="n">calculate_certainty_equivalent</span><span class="p">(</span><span class="n">alpha_opt</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8503a6d9">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">alpha_opt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=80d566ef">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ce_levels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.25</span> <span class="o">+</span> <span class="n">eq_ce</span><span class="p">,</span> <span class="n">eq_ce</span><span class="p">,</span> <span class="n">eq_ce</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">]</span>
<span class="n">std_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eq_var</span><span class="p">),</span> <span class="n">eq_expected_wealth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"EQ-weighted Portfolio"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">opt_var</span><span class="p">),</span> <span class="n">opt_expected_wealth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Optimal Portfolio"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">opt_ce</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Standard deviation of portfolio value"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">"Expected portfolio value"</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=f9c4fd87">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Apply the formula for mean-variance optimal portfolio from the lectures.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=802ca66a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_mvo_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">initial_wealth</span><span class="p">):</span>
    
    <span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span> <span class="n">target</span><span class="p">,</span> <span class="n">initial_wealth</span><span class="p">]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="mi">2</span><span class="o">*</span><span class="n">cov_mat</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">mu</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)],</span> 
                  <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">mu</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]))</span>
    
    <span class="n">alpha_opt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">@</span> <span class="n">b</span>
    
    <span class="k">return</span> <span class="n">alpha_opt</span><span class="p">[:</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a937fe86">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">initial_wealth</span><span class="p">,</span> <span class="n">initial_wealth</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="mf">0.2</span><span class="p">),</span> <span class="mi">50</span><span class="p">)</span>

<span class="n">mean_var_eff_alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">calculate_mvo_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">initial_wealth</span><span class="p">)</span>  <span class="k">for</span>  <span class="n">t</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=4649346f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">std_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">calculate_port_variance</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mean_var_eff_alpha</span><span class="p">,</span> <span class="p">(</span><span class="n">cov_mat</span><span class="p">)))</span>
<span class="n">expectation_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">calculate_port_expected_value</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mean_var_eff_alpha</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f140f17a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ce_levels</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.25</span> <span class="o">+</span> <span class="n">eq_ce</span><span class="p">,</span> <span class="n">eq_ce</span><span class="p">,</span> <span class="n">eq_ce</span> <span class="o">+</span> <span class="mf">0.25</span><span class="p">]</span>
<span class="n">std_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">eq_var</span><span class="p">),</span> <span class="n">eq_expected_wealth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"EQ-weighted Portfolio"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">ce_levels</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.25</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">opt_var</span><span class="p">),</span> <span class="n">opt_expected_wealth</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Optimal Portfolio"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_values</span><span class="p">,</span> <span class="n">opt_ce</span> <span class="o">+</span> <span class="mf">0.5</span> <span class="o">/</span> <span class="n">gamma</span> <span class="o">*</span> <span class="n">std_values</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_eff</span><span class="p">,</span> <span class="n">expectation_eff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"MVO frontier"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Standard deviation of portfolio value"</span><span class="p">,</span> <span class="n">ylabel</span><span class="o">=</span><span class="s2">"Expected portfolio value"</span><span class="p">);</span>

<span class="c1">#ax.set_ylim([0.75, 1.25])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=prescription-young">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3:--Long-term-risk-and-portfolio-optimization">
        Problem 3:  Long-term risk and portfolio optimization
        <a class="anchor-link" href="#Problem-3:--Long-term-risk-and-portfolio-optimization">
         ¶
        </a>
       </h2>
       <p>
        Again, consider the Fama-French "12 industry portfolios" since 1999.
       </p>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        We may assume that log-returns follows a multivariate normal distribution.
       </p>
       $$
\log \mathbf{P}_{t+1} - \log \mathbf{P}_t \sim N(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        Estimate the expected log-return and the covariance matrix of log-returns.
       </p>
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        Based on the above estimates, simulate the asset prices 5-years into the future. Consider 10,000 paths and yearly time steps.
       </p>
       <p>
        Calculate the return of an equally weighted constant mix portfolio. Plot a fan chart of the development of the index value of the constant mix. Compare with a buy and hold portfolio.
       </p>
       <p>
        <strong>
         Question 3
        </strong>
       </p>
       <p>
        Calculate the mean, variance and CVaR at the 5-year horizon.
       </p>
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        Select the constant mix portfolio that minimizes the 5Y CVaR(5%) for a return target of e.g. $50\%$.
       </p>
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        Suggest and apply a resampling approach.
       </p>
       <p>
        <strong>
         Question 6
        </strong>
       </p>
       <p>
        Do we obtain similar results with a buy and hold strategy?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Question 1
        </strong>
       </p>
       <p>
        As previously seen, we can simply use
        <code>
         pandas-datareader
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=therapeutic-carnival">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">reader</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s2">"12_Industry_Portfolios"</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">industry_port</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># print description</span>
<span class="n">industry_port</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=optional-tuner">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get equally weighted</span>
<span class="n">ind_eq_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">ind_eq_weighted</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ind_eq_weighted</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>


<span class="c1"># get market cap weighted </span>
<span class="n">ind_mc_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>
<span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

<span class="n">asset_list</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=specified-essex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate log returns</span>
<span class="sd">"""</span>

<span class="n">log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ind_mc_weighted</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=immediate-windows">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mean_log_returns</span> <span class="o">=</span> <span class="n">log_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="n">mean_log_returns</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=willing-pocket">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cov_mat_log_returns</span> <span class="o">=</span> <span class="n">log_returns</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">cov_mat_log_returns</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=technical-export">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">corr_mat_log_returns</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_mat_log_returns</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=choice-fraud">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">correlation_plot</span><span class="p">(</span><span class="n">corr_mat_log_returns</span><span class="p">,</span> <span class="n">names</span><span class="o">=</span><span class="n">asset_list</span><span class="p">,</span> <span class="n">include_values</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=exempt-auditor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 2
        </strong>
       </p>
       <p>
        We can simulate log-returns using a multivariate normal distribution and aggregate across time.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=educated-cartoon">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">simulate_asset_prices</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">horizon</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">dt</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">transform_input</span><span class="p">:</span> <span class="nb">bool</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Simulates asset prices</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    mu: </span>
<span class="sd">        Expected log-returns. </span>
<span class="sd">    cov_mat: </span>
<span class="sd">        Covariance matrix of log-returns. </span>
<span class="sd">    horizon: </span>
<span class="sd">        Simulation horizon in years. </span>
<span class="sd">    dt: </span>
<span class="sd">        Time step. </span>
<span class="sd">    num_sim: </span>
<span class="sd">        Number of simulations. </span>
<span class="sd">    transform_input: </span>
<span class="sd">        Boolean indicating whether to transform mu and cov_mat to time_step. </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Simulated asset prices  [num sim x num time steps x num_assets]. </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="k">if</span> <span class="n">transform_input</span><span class="p">:</span>
        <span class="n">mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">*</span> <span class="n">dt</span>
        <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">cov_mat</span> <span class="o">*</span> <span class="n">dt</span>
        
    <span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    
    <span class="n">num_periods</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">horizon</span> <span class="o">/</span> <span class="n">dt</span><span class="p">)</span>
    
    <span class="c1"># allocate memory</span>
    <span class="n">asset_prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">num_periods</span><span class="p">,</span> <span class="n">num_assets</span><span class="p">))</span>
    
    <span class="c1"># simulate returns</span>
    <span class="n">log_ret</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span>
                                            <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_periods</span><span class="p">))</span>
    
    <span class="c1"># transform returns to asset prices</span>
    <span class="n">asset_prices</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">log_ret</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">asset_prices</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=impressed-interface">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate asset prices</span>
<span class="sd">"""</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">dt</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="c1"># 1.0/12.0</span>
<span class="n">horizon</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">mean_log_returns</span><span class="o">.</span><span class="n">values</span> <span class="o">*</span> <span class="mf">12.0</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">cov_mat_log_returns</span> <span class="o">*</span> <span class="mf">12.0</span>

<span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">horizon</span> <span class="o">+</span> <span class="mf">0.01</span><span class="p">,</span> <span class="n">dt</span><span class="p">)</span>
<span class="n">asset_prices</span>  <span class="o">=</span> <span class="n">simulate_asset_prices</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">horizon</span><span class="p">,</span> <span class="n">dt</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=appropriate-flush">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The value of a buy and hold strategy is simply given by (assuming the initial value of the assets and portfolios are equal to 1)
       </p>
       $$
V_T = \mathbf{w}^\top \mathbf{P}_T
$$
       <p>
        where $V_T$ denotes the portfolio value, $\mathbf{P}_T$ denotes the vector of asset prices and $\mathbf{w}$ denote the initial portfolio weights.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=recorded-fitness">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Buy and hold strategy </span>
<span class="sd">"""</span>

<span class="n">port_w</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="n">buy_and_hold_index</span> <span class="o">=</span> <span class="n">asset_prices</span> <span class="o">@</span> <span class="n">port_w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=confident-phenomenon">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">asset_prices</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=applicable-basic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">buy_and_hold_index</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=smoking-metabolism">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The value of the constant mix strategy
       </p>
       $$
V_T = \prod_{t = 1}^T (1 + \mathbf{w}^\top \mathbf{R}_t)
$$
       <p>
        where $\mathbf{R}_t$ is the period return of the assets.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=heard-april">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Constant mix porfolio (monthly rebalancing)</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">calculate_period_returns</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates period returns</span>
<span class="sd">    </span>
<span class="sd">    Paramters</span>
<span class="sd">    ---------</span>
<span class="sd">    index: </span>
<span class="sd">        Index values [num sim x num time steps x num_assets]. </span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Period returns. </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="c1"># get size of matrix</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get matrix not lagged</span>
    <span class="n">new_mat</span> <span class="o">=</span> <span class="n">index</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:</span><span class="n">n</span><span class="p">]</span>
    <span class="c1"># get matrix lagged</span>
    <span class="n">old_mat</span> <span class="o">=</span> <span class="n">index</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">:</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="c1"># get 1 + return</span>
    <span class="n">periodtr</span> <span class="o">=</span> <span class="n">new_mat</span> <span class="o">/</span> <span class="n">old_mat</span>
    
    <span class="k">return</span> <span class="n">periodtr</span> <span class="o">-</span> <span class="mi">1</span>
    

<span class="k">def</span> <span class="nf">calculate_constant_mix_index</span><span class="p">(</span><span class="n">index</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates cum. return index of a constant mix strategy. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    index: </span>
<span class="sd">        Index values  [num sim x num time steps x num_assets]. </span>
<span class="sd">    weights: </span>
<span class="sd">        Portfolio weights. </span>
<span class="sd">        </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Cum. return index [num sim x num time steps]. </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="n">port_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="n">index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">index</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span>
    
    <span class="c1"># calculate period returns on assets</span>
    <span class="n">per_ret</span> <span class="o">=</span> <span class="n">calculate_period_returns</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
    
    <span class="c1"># calculate port. period return</span>
    <span class="n">port_per_ret</span> <span class="o">=</span> <span class="n">per_ret</span> <span class="o">@</span> <span class="n">weights</span>
    
    <span class="c1"># calculate port. index</span>
    <span class="n">port_index</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">port_per_ret</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">port_index</span>
    

<span class="n">constant_mix_index</span> <span class="o">=</span> <span class="n">calculate_constant_mix_index</span><span class="p">(</span><span class="n">asset_prices</span><span class="p">,</span> <span class="n">port_w</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=adapted-thompson">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate percentiles</span>
<span class="n">percentiles_buy_and_hold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">buy_and_hold_index</span><span class="p">,</span>
                                         <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="mf">99.0</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">],</span>
                                         <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">percentiles_constant_mix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">constant_mix_index</span><span class="p">,</span> 
                                         <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">95</span><span class="p">,</span> <span class="mf">97.5</span><span class="p">,</span> <span class="mf">99.0</span><span class="p">,</span> <span class="mf">99.5</span><span class="p">],</span>
                                         <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot fan chart</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span>
          <span class="n">percentiles_buy_and_hold</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'cyan'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'99% CI'</span><span class="p">,</span> <span class="s1">'98% CI'</span><span class="p">,</span> <span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Index value"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Buy and Hold"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">);</span>

<span class="n">fan_chart</span><span class="p">(</span><span class="n">time_points</span><span class="p">,</span>
          <span class="n">percentiles_constant_mix</span><span class="p">,</span>
          <span class="n">color</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'red'</span><span class="p">],</span>
          <span class="n">color_median</span><span class="o">=</span><span class="n">default_colors</span><span class="p">[</span><span class="s1">'dark_blue'</span><span class="p">],</span>
          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s1">'99% CI'</span><span class="p">,</span> <span class="s1">'98% CI'</span><span class="p">,</span> <span class="s1">'95% CI'</span><span class="p">,</span> <span class="s1">'90% CI'</span><span class="p">,</span> <span class="s1">'80% CI'</span><span class="p">,</span> <span class="s1">'Median'</span><span class="p">],</span>
          <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Year"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Constant Mix"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">])</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'upper center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.15</span><span class="p">),</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=promotional-denver">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 3
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sustainable-benchmark">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">buy_and_hold_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=stock-arbor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">constant_mix_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=impaired-minneapolis">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">buy_and_hold_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=found-substitute">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">constant_mix_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sealed-plant">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">buy_and_hold_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=heavy-driver">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">buy_and_hold_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">cond_value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">buy_and_hold_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">buy_and_hold_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;lt;=</span> <span class="n">value_at_risk</span><span class="p">])</span>
<span class="n">cond_value_at_risk</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=streaming-spirit">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">constant_mix_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
<span class="n">cond_value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">constant_mix_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">constant_mix_index</span><span class="p">[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;lt;=</span> <span class="n">value_at_risk</span><span class="p">])</span>
<span class="n">cond_value_at_risk</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=attractive-excerpt">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">calculate_constant_mix_index</span><span class="p">(</span><span class="n">asset_prices</span><span class="p">,</span> <span class="n">port_w</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=vanilla-sussex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 4
        </strong>
       </p>
       <p>
        We can apply the techniques from the exercises in week 5.
       </p>
       <p>
        We need to take into account the difference between how the cum. return index of the buy and hold and constant mix portfolio is calculated.
       </p>
       <p>
        <em>
         Note: See
         <a href="https://www.ise.ufl.edu/uryasev/files/2011/11/CVaR1_JOR.pdf">
          Rockafeller and Uryasev (2000)
         </a>
         for a more efficient approach using convex optimization in the buy-and-hold case
        </em>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=opponent-bradford">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">objective_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>

    <span class="n">constant_mix_index</span> <span class="o">=</span> <span class="n">calculate_constant_mix_index</span><span class="p">(</span><span class="n">index</span><span class="p">,</span> <span class="n">x</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">calculate_conditional_value_at_risk</span><span class="p">(</span><span class="n">constant_mix_index</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span>

<span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="mi">12</span> <span class="c1">#+ [(None, None)]</span>


<span class="k">def</span> <span class="nf">target_return_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">asset_prices</span><span class="p">):</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">calculate_constant_mix_index</span><span class="p">(</span><span class="n">asset_prices</span><span class="p">,</span> <span class="n">x</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">target</span>

<span class="n">port_weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.45</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.55</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.65</span><span class="p">,</span> <span class="mf">1.7</span><span class="p">]</span>
<span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="n">target</span><span class="p">)</span>
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">target_return_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">asset_prices</span><span class="p">)}</span>


    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">]</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objective_function</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">asset_prices</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span> 
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

    <span class="n">port_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span> <span class="c1">#[:-1])</span>
    
    
<span class="n">port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">port_weights</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=tested-indonesia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">asset_list</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return (5-year)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=closed-amber">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)):</span>
    
    <span class="n">index_vals</span> <span class="o">=</span> <span class="n">calculate_constant_mix_index</span><span class="p">(</span><span class="n">asset_prices</span><span class="p">,</span> <span class="n">port_weights</span><span class="p">[</span><span class="n">i</span><span class="p">])[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">index_vals</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">cond_value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">index_vals</span><span class="p">[</span><span class="n">index_vals</span> <span class="o">&amp;lt;=</span> <span class="n">value_at_risk</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"CVaR(5%) for target = </span><span class="si">{}</span><span class="s2">: "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cond_value_at_risk</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=alpha-house">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [48]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>    

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)):</span>
    <span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">calculate_constant_mix_index</span><span class="p">(</span><span class="n">asset_prices</span><span class="p">,</span> <span class="n">port_weights</span><span class="p">[</span><span class="n">i</span><span class="p">])[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span>
                <span class="n">label</span><span class="o">=</span><span class="s2">"Target = </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=dressed-spread">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 5
        </strong>
       </p>
       <p>
        We simply resample a number of paths from the simulated asset prices and perform the portfolio optimization again. Repeat this a large number of times. The average is the optimal allocations.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=european-wright">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [49]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.45</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.55</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.65</span><span class="p">]</span>

<span class="n">num_resamples</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">size_resample</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">optimal_port_resampled_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">),</span> <span class="mi">12</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_resamples</span><span class="p">):</span> 
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">asset_prices_sim</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">,</span>
                                                      <span class="n">size</span><span class="o">=</span><span class="n">size_resample</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span>
    
    <span class="n">opt_port_w_sim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>

        <span class="c1">#print(target)</span>

        <span class="c1"># define constraint </span>
        <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                       <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">target_return_constraint</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">asset_prices_sim</span><span class="p">)}</span>


        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objective_function</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">asset_prices_sim</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                                <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                                <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span> 
                                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

        <span class="n">opt_port_w_sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>


    <span class="n">optimal_port_resampled_weights</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_port_w_sim</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_resamples</span>
    
<span class="n">optimal_port_resampled_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">optimal_port_resampled_weights</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=extraordinary-chair">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [50]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">optimal_port_resampled_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">asset_list</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return (5-year)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=welcome-reset">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [51]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">)):</span>
    
    <span class="n">index_vals</span> <span class="o">=</span> <span class="n">calculate_constant_mix_index</span><span class="p">(</span><span class="n">asset_prices</span><span class="p">,</span> <span class="n">optimal_port_resampled_weights</span><span class="p">[</span><span class="n">i</span><span class="p">])[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">index_vals</span><span class="p">,</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">cond_value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">index_vals</span><span class="p">[</span><span class="n">index_vals</span> <span class="o">&amp;lt;=</span> <span class="n">value_at_risk</span><span class="p">])</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"CVaR(5%) for target = </span><span class="si">{}</span><span class="s2">: "</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">targets</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">cond_value_at_risk</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=biblical-parcel">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Question 6
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=intimate-frost">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [52]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">objective_function_buy_and_hold</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">beta</span><span class="p">):</span>

    <span class="n">buy_and_hold_index</span> <span class="o">=</span> <span class="p">(</span><span class="n">index</span> <span class="o">@</span> <span class="n">w</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">calculate_conditional_value_at_risk</span><span class="p">(</span><span class="n">buy_and_hold_index</span><span class="p">,</span> <span class="n">p</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">-</span> <span class="n">beta</span><span class="p">)</span>

<span class="n">port_weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">targets</span> <span class="o">=</span> <span class="p">[</span><span class="mf">1.4</span><span class="p">,</span> <span class="mf">1.45</span><span class="p">,</span> <span class="mf">1.5</span><span class="p">,</span> <span class="mf">1.55</span><span class="p">,</span> <span class="mf">1.6</span><span class="p">,</span> <span class="mf">1.65</span><span class="p">]</span>

<span class="n">num_resamples</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">size_resample</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">optimal_port_resampled_weights_buy_and_hold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">targets</span><span class="p">),</span> <span class="mi">12</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_resamples</span><span class="p">):</span> 
    <span class="nb">print</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
    <span class="n">asset_prices_sim</span> <span class="o">=</span> <span class="n">asset_prices</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size_resample</span><span class="p">),</span> <span class="p">:,</span> <span class="p">:]</span>
    
    <span class="n">opt_port_w_sim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">targets</span><span class="p">:</span>

        <span class="c1">#print(target)</span>

        <span class="c1"># define constraint </span>
        <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                       <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">((</span><span class="n">asset_prices_sim</span> <span class="o">@</span> <span class="n">x</span><span class="p">)[:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">-</span> <span class="n">target</span><span class="p">}</span>


        <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mf">12.0</span><span class="p">]</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objective_function_buy_and_hold</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">asset_prices_sim</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">),</span>
                                <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                                <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span> 
                                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">},</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

        <span class="n">opt_port_w_sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>


    <span class="n">optimal_port_resampled_weights_buy_and_hold</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_port_w_sim</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_resamples</span>
    
<span class="n">optimal_port_resampled_weights_buy_and_hold</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">optimal_port_resampled_weights_buy_and_hold</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=secret-survival">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [53]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">targets</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">optimal_port_resampled_weights_buy_and_hold</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">asset_list</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s1">'center'</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.3</span><span class="p">),</span>
          <span class="n">fancybox</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shadow</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncol</span><span class="o">=</span><span class="mi">6</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return (5-year)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="c1"># animations, etc. requires below magic command</span>
<span class="c1"># %matplotlib notebook</span>


<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># numpy for working with matrices</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># plotting libraries</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># scipy for statistics and optimization </span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="c1"># import reduce from functools. Used for applying a function multiple times on a iterable. </span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="c1"># typehints </span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=introductory-lawrence">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Introduction-to-fixed-income-modelling">
        Introduction to fixed income modelling
        <a class="anchor-link" href="#Introduction-to-fixed-income-modelling">
         ¶
        </a>
       </h1>
       <p>
        <strong>
         Note
        </strong>
        : For further details the reader is referred to
        <a href="https://www.amazon.co.uk/Fixed-Income-Modelling-Claus-Munk/dp/0198716443">
         Claus Munk (2013), "Fixed income modelling"
        </a>
       </p>
       <p>
        The term
        <a href="https://www.investopedia.com/terms/f/fixedincome.asp">
         <em>
          fixed income
         </em>
        </a>
        refers to assets and securities that pay out a set level of cash flows to investors, typically in the form of fixed interest or dividends. The simplest fixed income instruments are bonds that we can think of as a tradable loan agreement.
       </p>
       <p>
        We will in this lecture note introduce some terminology and see how we can extract yield curves from observed bond prices. The yield curve captures the infomation we need to price the fixed income instruments.
       </p>
       <h2 id="Some-terminology">
        Some terminology
        <a class="anchor-link" href="#Some-terminology">
         ¶
        </a>
       </h2>
       <h3 id="Bond-types">
        Bond types
        <a class="anchor-link" href="#Bond-types">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Zero-coupon bond - the fundamental building-block
        </strong>
       </p>
       <p>
        A zero coupon bond is the simplest type of bond. A zero coupon bond at time $t$ promises a single payment (we assume 1 if not otherwise stated) at time $T \geq t$ and has the price $B_t^T$. Note that $B_t^t = 1$. The zero coupon bond represents the market discount factor for a sure time $T$ payment.
       </p>
       <p>
        <strong>
         Coupon bonds
        </strong>
       </p>
       <p>
        A
        <em>
         coupon bond
        </em>
        has multiple payments $Y_i, \; i = 1, ...,n$ for different payments dates $T_i = T_1, ..., T_n$. We can think of a coupon bond as a portfolio of zero coupon bonds. Thus, if we can obtain the zero coupon term structure, we can price any coupon bond (or fixed cash flow). The price of a bond can be written as
       </p>
       $$
B_t = \sum_{T_i &amp;gt; t} Y_i B_t^{T_i}
$$
       <p>
        Typically, coupon bonds have fixed payment intervals, e.g. $\delta \in  [0.25, 0.5, 1.0]$ corresponding to quarterly, semi-annually, and yearly. The size of payments is determined by the face value, coupon rate and amortization principle.  The coupon rate $R$ is typically qouted annually such that the periodic coupon rate is $\delta R$.
       </p>
       <p>
        Three examples of coupon bonds are
       </p>
       <ul>
        <li>
         Bullet bonds
        </li>
        <li>
         Annuity bonds
        </li>
        <li>
         Serial bonds
        </li>
       </ul>
       <p>
        <em>
         Bullet bonds
        </em>
        pays the periodic coupon rate times the face value for all payment dates expect for the last payment where the face value also is repaid. E.g a 5-year bullet bond with coupon rate $R$ and face value of $1$:
       </p>
       $$
Y_i = \left \{ \begin{array}{ll} R, &amp;amp; i = 1, ..., 4\\ 1 + R, &amp;amp; i=5 \end{array} \right. 
$$
       <p>
        <em>
         Annuity bonds
        </em>
        have equal payments for all payments dates. Each payment is composed of an interest payment and a principle repayment. A $n$-year annuity with annual payments will have the payments
       </p>
       $$
Y_i = Y = \frac{R}{1 - (1+R)^{-n}}
$$
       <p>
        <em>
         Serial bonds
        </em>
        pays the face value back in equal installments. A $n$ year bond with annual payments
       </p>
       $$
Y_i = \frac{1}{n} + R
\left[1 - \frac{i-1}{n}\right]
$$
       <h3 id="Yields-and-zero-coupon-rates">
        Yields and zero-coupon rates
        <a class="anchor-link" href="#Yields-and-zero-coupon-rates">
         ¶
        </a>
       </h3>
       <p>
        The
        <em>
         yield
        </em>
        of a bond, $\hat{y}_t^B$ (annually compounded) or $y_t^B$ (continuous compounding),  is the discount rate for which the present value of the future payments discounted at that rate is equal to the current price of the bond. The annually compounded yield
       </p>
       $$
B_t = \sum_{T_i &amp;gt; t} Y_i \left(1 +  \hat{y}_t^B\right)^{-(T_i - t)}
$$
       <p>
        and the continuous compounded yield
       </p>
       $$
B_t = \sum_{T_i &amp;gt; t} Y_i e^{-y_t^B (T_i - t)}
$$
       <p>
        We will often be interested in the zero-coupon yields that convey the same information as the discount factor and thereby usefull for pricing other fixed income sercurites. Again, the
        <em>
         annually compounded
        </em>
        zero-coupon yield is 
$$
B_t^T =  \left(1 +  \hat{y}_t^T\right)^{-(T - t)}
$$
Solving for the yield gives us
       </p>
       $$
\hat{y}_t^T = \left(B_t^T \right)^{- \frac{1}{T-t}} - 1
$$
       <p>
        For the case with
        <em>
         continuous compounding
        </em>
        we have 
$$
B_t^T = e^{-y_t^T (T - t)}
$$
and the corresponding zero-coupon yield 
$$
y_t^T = - \frac{1}{T-t}\ln B_t^T
$$
       </p>
       <p>
        Our goal will be to find a zero-coupon yield curve such that we can price a range of fixed income instruments.
       </p>
       <h3 id="Forward-rates">
        Forward rates
        <a class="anchor-link" href="#Forward-rates">
         ¶
        </a>
       </h3>
       <p>
        The
        <em>
         forward rate
        </em>
        reflects the price on a loan between two future dates. The
        <em>
         annually compounded
        </em>
        forward rate between time $T$ and $S$ is given by
       </p>
       $$
\hat{f}_t^{T,S} = \left(\frac{B_t^T}{B_t^S} \right)^{1/(S-T)} - 1
$$
       <p>
        such that
       </p>
       $$
\left(1 +  \hat{y}_t^S\right)^{-(S-t)} = \left(1 + \hat{y}_t^T \right)^{-(T-t)} \left(1 + \hat{f}_t^{T,S}  \right)^{-(S-T)}
$$
       <p>
        Similarly, with
        <em>
         continuous compounding
        </em>
        we have
       </p>
       $$
f_t^{T,S} = - \frac{\ln B_t^S - \ln B_t^T}{S-T}
$$
       <p>
        such that
       </p>
       $$
B_t^S = B_t^T e^{-f_t^{T,S}(S-T)}
$$
       <p>
        We obtain the instantaneous forward rate as the limit when $S \to T$
       </p>
       $$
f_t^T = \frac{\partial \ln B_t^T}{\partial T} = - \frac{\partial B_t^T}{\partial T} \frac{1}{B_t^T}
$$
       <p>
        The zero-coupon yield is related to the instantaneous forward rates as follows
       </p>
       $$
y_t^T = \frac{1}{T-t}\intop_t^T f_t^u du
$$
       <p>
        such that
       </p>
       $$
B_t^T = e^{-\intop_t^T f_t^u du}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b82e3d61">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="A-comment-on-fixed-income-risk-drivers">
        A comment on fixed income risk drivers
        <a class="anchor-link" href="#A-comment-on-fixed-income-risk-drivers">
         ¶
        </a>
       </h2>
       <p>
        As discussed, the zero coupon yield curve contains all relevant information for pricing (risk free) fixed income instruments such as bonds. Thus, modelling changes in bond prices requires us to be able to model changes in the zero coupon yield curve.
       </p>
       <p>
        The financial modeller will typically not be able to model the continuum of zero coupon yield, but have to resort to more parsimonious representation. One possibilty is to summarize the yield curve using a grid of zero coupon yields and then interpolate between them to obtain all possible yields on the yield curve. Then time series analysis only need to be applied on a finit number of yield changes in order to model the future distribtion of yields and thereby also e.g. bonds prices.
       </p>
       <p>
        Another alternative would be to approximate the yield curve using parameterization such as the Nelson-Siegel model where the yield curve is a function of the level, slope and curvature parameters. Then, we have to model these parameters and their dynamics in order to explain the whole yield curve and its evolution.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=distinct-youth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Extracting-yield-curves-from-bond-prices">
        Extracting yield curves from bond prices
        <a class="anchor-link" href="#Extracting-yield-curves-from-bond-prices">
         ¶
        </a>
       </h2>
       <h3 id="Bootstrapping">
        Bootstrapping
        <a class="anchor-link" href="#Bootstrapping">
         ¶
        </a>
       </h3>
       <p>
        Boostrapping is the simplest way of obtaining zero-coupon yields. If we observe coupon bonds then we will be able to back-out the implicit zero-coupon yields consistent with the observed market prices. Assume that we have the two bonds and we are standing at time $t=0$
       </p>
       <table>
        <thead>
         <tr>
          <th>
          </th>
          <th>
           Cash Flow, $t=1$
          </th>
          <th>
           Cash Flow, $t=2$
          </th>
          <th>
           Price
          </th>
         </tr>
        </thead>
        <tbody>
         <tr>
          <td>
           Bond 1
          </td>
          <td>
           110
          </td>
          <td>
          </td>
          <td>
           100.0
          </td>
         </tr>
         <tr>
          <td>
           Bond 2
          </td>
          <td>
           5
          </td>
          <td>
           105
          </td>
          <td>
           90.0
          </td>
         </tr>
        </tbody>
       </table>
       <p>
        Then clearly, the discount factor (the price of a zero-coupon bond) maturing at time $t=1$ is
       </p>
       $$
100 = 110 B_0^1 \Rightarrow B_0^1 = \frac{1}{110} 100 
$$
       <p>
        and
       </p>
       $$
90 = 5 B_0^1 + 105 B_0^2 = 5 \frac{1}{110} 100 + 105 B_0^2  \Rightarrow B_0^2 = \frac{1}{105} 90 +  \frac{5}{105}  \frac{1}{110} 100
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=protecting-france">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># cash flow matrix</span>
<span class="n">cf_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">110.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                      <span class="p">[</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">105.0</span><span class="p">]])</span>

<span class="c1"># bond prices</span>
<span class="n">price_vector</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">100.0</span><span class="p">,</span> <span class="mf">90.0</span><span class="p">])</span>

<span class="c1"># discount factors</span>
<span class="n">discount_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cf_matrix</span><span class="p">)</span> <span class="o">@</span> <span class="n">price_vector</span>
<span class="n">discount_factors</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=4a23a065">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We obtain the one and two year (cont.) zero coupon yields using
       </p>
       $$
y_0^1 = - \frac{1}{1}\ln B_0^1 
$$
       <p>
        and
       </p>
       $$
y_0^2 = - \frac{1}{2}\ln B_0^2 
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=stuck-partition">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># zero coupon yields</span>
<span class="n">zero_yields</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">discount_factors</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">])</span>
<span class="n">zero_yields</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=found-milton">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The example above shows us that we basically need to solve a system of equations
       </p>
       $$
\mathbf{B}_t = \begin{bmatrix} B_{1,t} \\ B_{2, t} \\  \vdots \\ B_{M, t} \end{bmatrix}  = 
\begin{bmatrix} Y_{1,1} &amp;amp; Y_{1,2} &amp;amp; \dots &amp;amp; Y_{1, N} \\ 
Y_{2, 1} &amp;amp; Y_{2,2} &amp;amp; \dots &amp;amp; Y_{2, N}\\  
\vdots &amp;amp; \vdots &amp;amp; \ddots &amp;amp; \vdots \\
Y_{M, 1} &amp;amp; Y_{M, 2} &amp;amp; \dots &amp;amp; Y_{M, N}  \end{bmatrix} 
\begin{bmatrix} B_{t}^{T_1} \\ B_t^{T_2} \\  \vdots \\ B_t^{T_N} \end{bmatrix} = \mathbf{C}_t  \mathbf{Z}_t
$$
       <p>
        where we have $M$ different bonds with $N$ different payment dates - note that some payments may be zero. Given the cash flows and observed bond prices, we can solve for an unique discount vector $\mathbf{Z}_t$
       </p>
       $$
Z_t = \mathbf{C}_t^{-1} \mathbf{B}_t
$$
       <p>
        if the cash flow matrix $\mathbf{C}_t$ is invertible (non-singular). If $M&amp;gt;N$ the system of equations may not have any solutions and if $M&amp;lt;N$ then we may have multiple solutions.
       </p>
       <p>
        <strong>
         Example
        </strong>
       </p>
       <p>
        <strong>
         Note
        </strong>
        : Example is adapted from
        <em>
         Exercise 2.2
        </em>
        in
        <a href="https://www.amazon.co.uk/Fixed-Income-Modelling-Claus-Munk/dp/0198716443">
         Claus Munk (2013), "Fixed income modelling"
        </a>
       </p>
       <p>
        Consider a bond market in which 10 bullet bonds are traded. They all have face value of 100, a coupon rate of 5%, annual payments and exactly one year to the next payment. The bonds mature in 1, 2, ...,  10 years:
       </p>
       <table>
        <thead>
         <tr>
          <th style="text-align:left">
           Maturity
          </th>
          <th>
           Price
          </th>
         </tr>
        </thead>
        <tbody>
         <tr>
          <td style="text-align:left">
           1
          </td>
          <td>
           101.942
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           2
          </td>
          <td>
           103.290
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           3
          </td>
          <td>
           104.118
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           4
          </td>
          <td>
           104.460
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           5
          </td>
          <td>
           104.355
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           6
          </td>
          <td>
           104.256
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           7
          </td>
          <td>
           104.552
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           8
          </td>
          <td>
           105.210
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           9
          </td>
          <td>
           105.482
          </td>
         </tr>
         <tr>
          <td style="text-align:left">
           10
          </td>
          <td>
           105.399
          </td>
         </tr>
        </tbody>
       </table>
       <p>
        Perform the following calculations:
       </p>
       <ul>
        <li>
         Find the discount factors
        </li>
        <li>
         Find the corresponding zero coupon yields (qouted annually)
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=prompt-valuation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define price vector </span>
<span class="sd">"""</span>

<span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">101.942</span><span class="p">,</span> <span class="mf">103.290</span><span class="p">,</span> <span class="mf">104.118</span><span class="p">,</span> <span class="mf">104.460</span><span class="p">,</span> <span class="mf">104.355</span><span class="p">,</span>
                   <span class="mf">104.256</span><span class="p">,</span> <span class="mf">104.552</span><span class="p">,</span> <span class="mf">105.210</span><span class="p">,</span> <span class="mf">105.482</span><span class="p">,</span> <span class="mf">105.399</span><span class="p">])</span>

<span class="sd">"""</span>
<span class="sd">Create relevant cash flow matrix</span>
<span class="sd">"""</span>

<span class="n">maturities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="n">term_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">flow_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">maturity</span> <span class="ow">in</span> <span class="n">maturities</span><span class="p">:</span> 
    
    <span class="n">terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">maturity</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">flows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> 
    <span class="n">flows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span>
    
    <span class="n">term_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
    <span class="n">flow_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flows</span><span class="p">)</span>

<span class="n">all_terms</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span> <span class="n">term_info</span><span class="p">)</span>

<span class="n">cash_flow_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">maturities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">all_terms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">terms</span><span class="p">,</span> <span class="n">flows</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">term_info</span><span class="p">,</span> <span class="n">flow_info</span><span class="p">):</span>
    
    <span class="n">indicator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">all_terms</span><span class="p">,</span> <span class="n">terms</span><span class="p">)</span>

    <span class="n">cash_flow_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">flows</span>
    
    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
<span class="w">    </span>
<span class="sd">"""</span>
<span class="sd">Simple way of creating cash flow matrix</span>

<span class="sd">The above method is somewhat more general</span>

<span class="sd">"""</span>

<span class="c1"># cash_flow_matrix = np.tri(10) * 5 + np.eye(10) * 100</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=numerical-sending">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cash_flow_matrix</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=bacterial-dutch">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate discount factors </span>
<span class="sd">"""</span>

<span class="n">discount_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cash_flow_matrix</span><span class="p">)</span> <span class="o">@</span> <span class="n">prices</span>
<span class="n">discount_factors</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=green-command">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cash_flow_matrix</span> <span class="o">@</span> <span class="n">discount_factors</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=african-remainder">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate zero yields</span>
<span class="sd">"""</span>

<span class="n">zero_yields_boot</span> <span class="o">=</span> <span class="n">discount_factors</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">maturities</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">maturities</span><span class="p">,</span> <span class="n">zero_yields_boot</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">);</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Zero coupon yields'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=burning-logic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Assume now that we drop the bond with maturity in 5 years. Will it still be possible to use the above procedure?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=later-wealth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define price vector </span>
<span class="sd">"""</span>

<span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">101.942</span><span class="p">,</span> <span class="mf">103.290</span><span class="p">,</span> <span class="mf">104.118</span><span class="p">,</span> <span class="mf">104.460</span><span class="p">,</span>
                   <span class="mf">104.256</span><span class="p">,</span> <span class="mf">104.552</span><span class="p">,</span> <span class="mf">105.210</span><span class="p">,</span> <span class="mf">105.482</span><span class="p">,</span> <span class="mf">105.399</span><span class="p">])</span>

<span class="sd">"""</span>
<span class="sd">Create relevant cash flow matrix</span>
<span class="sd">"""</span>

<span class="n">maturities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">6.0</span><span class="p">,</span> <span class="mf">11.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)))</span>

<span class="n">term_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="n">flow_info</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">maturity</span> <span class="ow">in</span> <span class="n">maturities</span><span class="p">:</span> 
    
    <span class="n">terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">maturity</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">flows</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> 
    <span class="n">flows</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">100</span>
    
    <span class="n">term_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">terms</span><span class="p">)</span>
    <span class="n">flow_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">flows</span><span class="p">)</span>

<span class="n">all_terms</span> <span class="o">=</span> <span class="n">reduce</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">union1d</span><span class="p">,</span> <span class="n">term_info</span><span class="p">)</span>

<span class="n">cash_flow_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">maturities</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">,</span> <span class="n">all_terms</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

<span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
<span class="k">for</span> <span class="n">terms</span><span class="p">,</span> <span class="n">flows</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">term_info</span><span class="p">,</span> <span class="n">flow_info</span><span class="p">):</span>
    
    <span class="n">indicator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">all_terms</span><span class="p">,</span> <span class="n">terms</span><span class="p">)</span>

    <span class="n">cash_flow_matrix</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">indicator</span><span class="p">]</span> <span class="o">=</span> <span class="n">flows</span>
    
    <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=opposed-assembly">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cash_flow_matrix</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=second-criminal">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cash_flow_matrix</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=tender-pharmacy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1">#  the rank cannot be larger than the num. of cols or rows</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">matrix_rank</span><span class="p">(</span><span class="n">cash_flow_matrix</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=controversial-prison">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        NO, the cash flow matrix is no longer invertible and we cannot apply the above methodology! We will get an error if we try to evaluate the code
        <code>
         np.linalg.inv(cash_flow_matrix)
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=expanded-stopping">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Alternatives-to-bootstrapping:-Splines">
        Alternatives to bootstrapping: Splines
        <a class="anchor-link" href="#Alternatives-to-bootstrapping:-Splines">
         ¶
        </a>
       </h3>
       <p>
        Bootstrapping can only give us the discount factors for the payment dates, but it may be valuable to know the discount factors for any given day in the future. There is a large literature on how to estimate the entire term structure of interest rates, think of it as a function $T \to B_t^T$, up to some large $T$. To simplify notation we will define
       </p>
       $$
B(\tau) = B_t^{t + \tau}, \; \; \tau \in [0, \infty)
$$
       <p>
        representing the time $t$ discount function. The objective is to specify some functional form for $B(\tau)$ such that we get as close as possible to observed bond prices.
       </p>
       <p>
        The first example we will look at involves representing the discount function using splines.
        <a href="https://www.amazon.co.uk/Fixed-Income-Modelling-Claus-Munk/dp/0198716443">
         Claus Munk (2013), "Fixed income modelling"
        </a>
        presents a method inspired by
        <a href="https://www.jstor.org/stable/2326860">
         McCulloch (1975)
        </a>
        , among others.
       </p>
       <p>
        The basic idea is to divide the time to maturity into $k$ subintervals $0 = \tau_0 &amp;lt; \tau_1 &amp;lt; \dots &amp;lt; \tau_k$ and define the discount function as
       </p>
       $$
B(\tau) = \sum_{j=1}^{k-1} G_j(\tau)I_j(\tau)
$$
       <p>
        where $G_j(\cdot)$ are the basis functions and $I_j(\cdot)$ is a step function
       </p>
       $$
I_j(\tau) = \left \{ \begin{array}{ll} 1, &amp;amp; \tau \geq \tau_j \\ 0, &amp;amp; \text{otherwise.}\end{array} \right.
$$
       <p>
        To ensure nice properties of the discount function, we will require the basis functions being continuous and differentiable. One example is the cubic spline where the basis functions are specified as third degree polynomials
       </p>
       $$
G_j(\tau) = \alpha_j + \beta_j (\tau - \tau_j) + \gamma_j (\tau - \tau_j)^2 + \delta_j (\tau - \tau_j)^3
$$
       <p>
        where $\alpha_j , \beta_j , \gamma_j , \delta_j$ are constants.
       </p>
       <p>
        To obtain a reasonable discount function, we need to impose a number of constraints on the cubic splines, e.g. for $\tau &amp;lt; \tau_1$ we have
       </p>
       $$
B(\tau) = \alpha_0 + \beta_0 \tau + \gamma_0\tau^2 + \delta_0 \tau^3
$$
       <p>
        ensuring $B(0) =1$ requires $\alpha_0 = 1$. After imposing all constraints, we will have
       </p>
       $$
B(\tau) = 1 + \beta_0 \tau + \gamma_0\tau^2 + \delta_0 \tau^3 + \sum_{j=1}^{k-1} \delta_j (\tau - \tau_j)^3 I_j(\tau)
$$
       <p>
        Given this specification of the discount function, we need to choose the parameters such discounting known bond cash flows gets as close as possible to their observed market prices. If we let $t_n$ denote the time distance from today (time $t$) to the $n$'th payment date we would obtain
       </p>
       $$
B_i = \sum_{n=1}^N Y_{in} B(t_n) + \varepsilon_i
$$
       <p>
        where $\varepsilon_i$ is the pricing error for bond $i$. Since we have specified the functional form for $B(\tau)$, we can write
       </p>
       $$
B_i = \sum_{n=1}^N Y_{in} \left[1 + \beta_0 t_n + \gamma_0 t_n^2 + \delta_0 t_n^3 + \sum_{j=1}^{k-1} \delta_j (t_n - \tau_j)^3 I_j(\tau)\right] + \varepsilon_i
$$
       <p>
        which also implies
       </p>
       $$
B_i  - \sum_{n=1}^N Y_{in} = \beta_0 \sum_{n=1}^N Y_{in}  t_n + \gamma_0 \sum_{n=1}^N Y_{in}  t_n^2 + \delta_0 \sum_{n=1}^N Y_{in}  t_n^3 + \sum_{j=1}^{k-1} \sum_{n=1}^N Y_{in}  \delta_j (t_n - \tau_j)^3 I_j(\tau) + \varepsilon_i
$$
       <p>
        Given $M$ bonds, we can simply estimate the model using OLS. Before estimating the discount function, we need to choose the number of subintervals $k$ (number of knot points).  McCulloch (1975) suggests to set $k$ equal to the nearest integer to $\sqrt{M}$  and define
       </p>
       $$
\tau_j = T_{h_j} + \theta_j (T_{h_j} - T_{h_j})
$$
       <p>
        where $h_j = \lfloor j \cdot M / k\rfloor $ (the integer part) and $\theta_j = j \cdot M / k - h_j$. Alternativly one can choose reasonable values that span the curve.
       </p>
       <p>
        There are some problems with the cubic spline methodology:
       </p>
       <ul>
        <li>
         May violate the no-arbitrage principle
        </li>
        <li>
         The resulting curve may not have an economically credible form (positive forward rates)
        </li>
        <li>
         May be very sensitive to the location of the knot points
        </li>
        <li>
         Small changes in input bond prices may have a large effect on the results
        </li>
       </ul>
       <p>
        <strong>
         Example:
        </strong>
       </p>
       <p>
        Below we will implement the cubic spline methodology to the same example used above.
       </p>
       <p>
        First, we define the relevant functions to perform the calculation.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sought-morris">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">cubic_spline_discount_factor</span><span class="p">(</span><span class="n">tenor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                                 <span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                 <span class="n">tau_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the discount factors for the Cubic Spline methodology</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    tenor:</span>
<span class="sd">        Tenor for which to get the discount factor.</span>
<span class="sd">    params: </span>
<span class="sd">        Parameters for the cubic spline.</span>
<span class="sd">    tau_values: </span>
<span class="sd">        The knot points of the cubic spline. </span>
<span class="sd">        </span>
<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        The discount factor. </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="c1"># ensure that the tenor is at least 1-d </span>
    <span class="n">tenor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">tenor</span><span class="p">)</span>
    
    <span class="c1"># create the "tau matrix" consisting of tenor - tau_j </span>
    <span class="n">tau_matrix</span> <span class="o">=</span> <span class="n">tenor</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="o">-</span> <span class="n">tau_values</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="c1"># apply the discount factor formula</span>
    <span class="n">zcb</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">tenor</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">tenor</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
           <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">tenor</span><span class="o">**</span><span class="mi">3</span> <span class="o">+</span>
           <span class="p">(</span><span class="n">tau_matrix</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau_matrix</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">))</span> <span class="o">@</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">:])</span>

    <span class="k">return</span> <span class="n">zcb</span>

<span class="k">def</span> <span class="nf">cubic_spline_zero_yield</span><span class="p">(</span><span class="n">tenor</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">tau_values</span><span class="p">,</span> <span class="n">discrete</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the zero yield for the Cubic Spline methodology</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    tenor:</span>
<span class="sd">        Tenor for which to get the zero yield factor.</span>
<span class="sd">    params: </span>
<span class="sd">        Parameters for the cubic spline.</span>
<span class="sd">    tau_values: </span>
<span class="sd">        The knot points of the cubic spline. </span>
<span class="sd">        </span>
<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        The zero yield. </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    <span class="c1"># calculate discount factors</span>
    <span class="n">zcb</span> <span class="o">=</span> <span class="n">cubic_spline_discount_factor</span><span class="p">(</span><span class="n">tenor</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">tau_values</span><span class="p">)</span>
    <span class="c1"># apply the relationship between discount factor and zero yield</span>
    <span class="k">if</span> <span class="n">discrete</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">zcb</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tenor</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">y</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">zcb</span><span class="p">)</span> <span class="o">/</span> <span class="n">tenor</span>
        
    <span class="k">return</span> <span class="n">y</span>


<span class="k">def</span> <span class="nf">estimate_cubic_spline</span><span class="p">(</span><span class="n">payment_dates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">cash_flow_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">market_prices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> 
                          <span class="n">tau_values</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Estimate parameters for the cubic spline curve. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    payment_dates:</span>
<span class="sd">        All cash flow payment dates.</span>
<span class="sd">    cash_flow_matrix: </span>
<span class="sd">        Cash flow matrix [number bonds x number payment dates].</span>
<span class="sd">    market_prices:</span>
<span class="sd">        Bond market prices. </span>
<span class="sd">    tau_values: </span>
<span class="sd">        The knot points of the cubic spline. </span>
<span class="sd">        </span>
<span class="sd">    Return</span>
<span class="sd">    ------</span>
<span class="sd">    Union[float, np.ndarray]</span>
<span class="sd">        The zero yield. </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="c1"># step 1: create independent variables</span>
    <span class="n">tau_matrix</span> <span class="o">=</span> <span class="n">payment_dates</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span>  <span class="o">-</span> <span class="n">tau_values</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    <span class="n">tau_matrix</span> <span class="o">=</span> <span class="n">tau_matrix</span><span class="o">**</span><span class="mi">3</span> <span class="o">*</span> <span class="p">(</span><span class="n">tau_matrix</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">)</span>
    
    <span class="n">x_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[(</span><span class="n">cash_flow_matrix</span> <span class="o">@</span> <span class="n">payment_dates</span><span class="p">,</span>
                   <span class="n">cash_flow_matrix</span> <span class="o">@</span> <span class="n">payment_dates</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                   <span class="n">cash_flow_matrix</span> <span class="o">@</span> <span class="n">payment_dates</span><span class="o">**</span><span class="mi">3</span><span class="p">,</span>
                   <span class="n">cash_flow_matrix</span> <span class="o">@</span> <span class="n">tau_matrix</span><span class="p">)]</span>
    
    <span class="c1"># step 2: create dependent variable</span>
    <span class="n">y_vec</span> <span class="o">=</span> <span class="n">market_prices</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cash_flow_matrix</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># step 3: performe OLS regression </span>
    <span class="n">params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">lstsq</span><span class="p">(</span><span class="n">x_mat</span><span class="p">,</span> <span class="n">y_vec</span><span class="p">,</span> <span class="n">rcond</span><span class="o">=</span><span class="kc">False</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">params</span>  
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=d10d5772">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1">#test_tenor = np.array([1.0, 10.0])</span>
<span class="c1">#test_tau_values = np.array([1.0, 5.0, 7.0])</span>
<span class="c1">#test_params = np.array([-3.32962635e-02,  7.70595423e-03, -3.78081712e-03,  4.15205336e-03, 2.68586344e-05, -1.35004589e-03])</span>

<span class="c1">#test_tenor[:, None]  - test_tau_values[None, :]</span>
<span class="c1">#(test_tenor[:, None]  - test_tau_values[None, :]) @ test_params[3:]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=geological-forwarding">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Just redefine price vector and cash flow matrix from first example</span>
<span class="sd">"""</span>


<span class="sd">"""</span>
<span class="sd">Define price vector </span>
<span class="sd">"""</span>

<span class="n">prices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">101.942</span><span class="p">,</span> <span class="mf">103.290</span><span class="p">,</span> <span class="mf">104.118</span><span class="p">,</span> <span class="mf">104.460</span><span class="p">,</span> <span class="mf">104.355</span><span class="p">,</span>
                   <span class="mf">104.256</span><span class="p">,</span> <span class="mf">104.552</span><span class="p">,</span> <span class="mf">105.210</span><span class="p">,</span> <span class="mf">105.482</span><span class="p">,</span> <span class="mf">105.399</span><span class="p">])</span>

<span class="sd">"""</span>
<span class="sd">Create relevant cash flow matrix</span>
<span class="sd">"""</span>

<span class="n">maturities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">all_terms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
<span class="n">cash_flow_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tri</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">5</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=north-metropolitan">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># estimate parametes</span>
<span class="n">params</span> <span class="o">=</span> <span class="n">estimate_cubic_spline</span><span class="p">(</span><span class="n">all_terms</span><span class="p">,</span> <span class="n">cash_flow_matrix</span><span class="p">,</span> <span class="n">prices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=dynamic-dragon">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">tenors_to_plot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mi">50</span><span class="p">)</span>

<span class="c1"># calculate discount factors and zero yields</span>
<span class="n">discount_factors_cubic</span> <span class="o">=</span> <span class="n">cubic_spline_discount_factor</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]))</span>
<span class="n">zero_yields_cubic</span> <span class="o">=</span> <span class="n">cubic_spline_zero_yield</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">7.0</span><span class="p">]))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=attractive-wesley">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">maturities</span><span class="p">,</span> <span class="n">zero_yields_boot</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Boostrapped"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="n">zero_yields_cubic</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Cubic spline"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zero yields (annual)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=scheduled-australia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Alternatives-to-bootstrapping:-Nelson-Siegel">
        Alternatives to bootstrapping: Nelson-Siegel
        <a class="anchor-link" href="#Alternatives-to-bootstrapping:-Nelson-Siegel">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Note:
        </strong>
        The notation differ somewhat from the exercises in week 5.
       </p>
       <p>
        <a href="https://www.jstor.org/stable/2352957">
         Nelson and Siegel (1987)
        </a>
        proposed a often used parameterization of the term structure of interest. They specified the following parameterization of the instantaneous forward rate
       </p>
       $$
f(\tau) = \beta_0 + \beta_1 e^{-\tau / \theta} + \beta_2 \frac{\tau}{\theta} e^{-\tau / \theta} 
$$
       <p>
        From newly gained knowledge, we know that the continuous zero coupon yield can be written as
       </p>
       $$
y(\tau) = \frac{1}{\tau} \intop_{0}^\tau f(u)  du = \beta_0 + \beta_1 \frac{1 - e^{-\tau / \theta}}{\tau / \theta} + \beta_2 \left(\frac{1 - e^{-\tau / \theta}}{\tau / \theta} - e^{-\tau / \theta} \right)
$$
       <p>
        The interpretation of the different terms in the above expression for the zero yields is intuitive. We can think of the parametes $\beta_0$, $\beta_1$ and $\beta_2$ as the relative weight of three factors. The first factor is the level factor (just equal to one) which affects all tenors (maturities) in the same way. The second factor is the slope factor mostly affecting short maturites. The third factor is the curvature factor primarily affecting intermediate tenors.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=functioning-while">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define  slope and curveture factor loadings</span>
<span class="k">def</span> <span class="nf">calculate_slope</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">theta</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">theta</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturity</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">theta</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">theta</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">theta</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">time_to_maturity</span> <span class="o">/</span> <span class="n">theta</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=descending-southeast">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">time_to_maturities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">level_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">)</span>
<span class="n">slope_factors</span> <span class="o">=</span> <span class="n">calculate_slope</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
<span class="n">curvature_factors</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">level_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Level factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">slope_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Slope factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">curvature_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Curvature factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=understood-heaven">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We can write the discount function as
       </p>
       $$
B(\tau) = e^{ - \tau \cdot y(\tau)} = \exp \left[ - \tau\beta_0 - \beta_1 \frac{1 - e^{-\tau / \theta}}{1 / \theta} -  \beta_2 \left(\frac{1 - e^{-\tau / \theta}}{1 / \theta} - \tau e^{-\tau / \theta} \right) \right]
$$
       <p>
        Again, we can write
       </p>
       $$
B_i = \sum_{n=1}^N Y_i \exp  \left[ - \tau\beta_0 - \beta_1 \theta (1 - e^{-\tau / \theta}) -  \beta_2 \left(\theta (1 - e^{-\tau / \theta}) - \tau e^{-\tau / \theta} \right) \right] + \varepsilon_i
$$
       <p>
        since this is a non-linear expression, we need to use non-linear least squares when estimating the parameters.
       </p>
       <p>
        <strong>
         Example
        </strong>
       </p>
       <p>
        Estimate the parameters of a Nelson-Siegel curve using the same data as in the previous examples.
       </p>
       <p>
        First, we define relevant functions.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=official-premium">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">nelson_siegel_discount_factor</span><span class="p">(</span><span class="n">tenor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span>
                                  <span class="n">params</span><span class="p">):</span>
    
    <span class="n">beta0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">beta1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">beta2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">tenor</span><span class="p">)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">calculate_slope</span><span class="p">(</span><span class="n">tenor</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="n">curvature</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">tenor</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">tenor</span> <span class="o">*</span> <span class="p">(</span><span class="n">beta0</span> <span class="o">*</span> <span class="n">level</span> <span class="o">+</span> <span class="n">beta1</span> <span class="o">*</span> <span class="n">slope</span> <span class="o">+</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">curvature</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">nelson_siegel_zero_yield</span><span class="p">(</span><span class="n">tenor</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">],</span> <span class="n">params</span><span class="p">):</span>
    
    <span class="n">beta0</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">beta1</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">beta2</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">theta</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    
    <span class="n">level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">tenor</span><span class="p">)</span>
    <span class="n">slope</span> <span class="o">=</span> <span class="n">calculate_slope</span><span class="p">(</span><span class="n">tenor</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    <span class="n">curvature</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">tenor</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">beta0</span> <span class="o">*</span> <span class="n">level</span> <span class="o">+</span> <span class="n">beta1</span> <span class="o">*</span> <span class="n">slope</span> <span class="o">+</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">curvature</span>


<span class="k">def</span> <span class="nf">nelson_siegel_objective</span><span class="p">(</span><span class="n">params</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">payment_dates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">cash_flow_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                            <span class="n">market_prices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">market_prices</span> <span class="o">-</span> 
                            <span class="n">cash_flow_matrix</span> <span class="o">@</span> <span class="n">nelson_siegel_discount_factor</span><span class="p">(</span><span class="n">payment_dates</span><span class="p">,</span> <span class="n">params</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">nelson_siegel_brute_objective</span><span class="p">(</span><span class="n">theta</span><span class="p">,</span>
                                  <span class="n">payment_dates</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                  <span class="n">cash_flow_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                                  <span class="n">market_prices</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>
    
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">theta</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>
    
    <span class="n">constraint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                  <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">theta</span><span class="p">}</span>
    
    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">15.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">15.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">30.0</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">)]</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">nelson_siegel_objective</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">payment_dates</span><span class="p">,</span> <span class="n">cash_flow_matrix</span><span class="p">,</span> <span class="n">market_prices</span><span class="p">),</span>
                   <span class="n">constraints</span><span class="o">=</span><span class="n">constraint</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">nelson_siegel_objective</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">payment_dates</span><span class="p">,</span> <span class="n">cash_flow_matrix</span><span class="p">,</span> <span class="n">market_prices</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=noticed-essex">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brute</span><span class="p">(</span><span class="n">nelson_siegel_brute_objective</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">),),</span>
                     <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">all_terms</span><span class="p">,</span> <span class="n">cash_flow_matrix</span><span class="p">,</span> <span class="n">prices</span><span class="p">),</span> <span class="n">Ns</span><span class="o">=</span><span class="mi">99999</span><span class="p">)</span>

<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=infectious-birth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">nelson_siegel_objective</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">4.8</span><span class="p">],</span>
               <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">all_terms</span><span class="p">,</span> <span class="n">cash_flow_matrix</span><span class="p">,</span> <span class="n">prices</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=adolescent-premiere">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cooked-integral">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate discount factors and zero yields</span>
<span class="n">discount_factors_ns</span> <span class="o">=</span> <span class="n">nelson_siegel_discount_factor</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
<span class="n">zero_yields_ns</span> <span class="o">=</span> <span class="n">nelson_siegel_zero_yield</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">maturities</span><span class="p">,</span> <span class="n">zero_yields_boot</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'o'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Boostrapped"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="n">zero_yields_cubic</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">'+'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Cubic spline"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">tenors_to_plot</span><span class="p">,</span> <span class="n">discount_factors_ns</span> <span class="o">**</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="o">/</span> <span class="n">tenors_to_plot</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span>
        <span class="n">marker</span><span class="o">=</span><span class="s1">'*'</span><span class="p">,</span> <span class="n">markersize</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Nelson Siegel"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Zero yields (annual)'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=minute-permit">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">time_to_maturities</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0001</span><span class="p">,</span> <span class="mf">30.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">theta</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="n">level_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">)</span>
<span class="n">slope_factors</span> <span class="o">=</span> <span class="n">calculate_slope</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>
<span class="n">curvature_factors</span> <span class="o">=</span> <span class="n">calculate_curvature</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">theta</span><span class="p">)</span>


<span class="sd">"""</span>
<span class="sd">Plotting </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">level_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Level factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">slope_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Slope factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">time_to_maturities</span><span class="p">,</span> <span class="n">curvature_factors</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Curvature factor"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Tenor'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.05</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.jstor.org/stable/2326860">
         McCulloch (1975)
        </a>
       </p>
       <p>
        <a href="https://www.nber.org/papers/w4871">
         Svensson (1994)
        </a>
       </p>
       <p>
        <a href="https://www.jstor.org/stable/2352957">
         Nelson and Siegel (1987)
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.co.uk/Fixed-Income-Modelling-Claus-Munk/dp/0198716443">
         Claus Munk (2013), "Fixed income modelling"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># working with arrays</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># plotting functionality</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">mtick</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="c1"># typehints</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">risk_waterfall_chart</span>

<span class="kn">from</span> <span class="nn">codelib.statistics.cornish_fisher</span> <span class="kn">import</span> <span class="n">calculate_cornish_fisher_percentile</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=blind-trauma">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Introduction-to-risk-measures">
        Introduction to risk measures
        <a class="anchor-link" href="#Introduction-to-risk-measures">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=senior-house">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Risk-measures">
        Risk measures
        <a class="anchor-link" href="#Risk-measures">
         ¶
        </a>
       </h2>
       <p>
        We can think of a risk measure as a dissatisfaction index that quantifies financial risk. More formally, a risk measure is a function, $\varrho(\mathbf{X})$, that maps a set of random variables, $\mathbf{X}$,  (e.g. future value of assets or portfolio returns) to the real numbers, $\varrho: \mathcal{L} \to \mathbb{R} \cup \{+ \infty\}$. The function $\varrho(\mathbf{X})$ needs to satisfy certain properties (for further reference, see
        <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1467-9965.00068">
         Artzner et al (1999), "Coherent Measures of Risks"
        </a>
        ).
       </p>
       <p>
        <strong>
         Normalization
        </strong>
       </p>
       <p>
        The risk associated with holding no assets is zero
       </p>
       $$
\varrho(0) = 0
$$
       <p>
        <strong>
         Monotonicity
        </strong>
       </p>
       <p>
        If $\mathbf{X}_1, \mathbf{X}_2 \in \mathcal{L}$ and $\mathbf{X}_1 \leq \mathbf{X}_2$ almost surely (with probability 1), then
       </p>
       $$
\varrho(\mathbf{X}_1) \geq \varrho(\mathbf{X}_2)
$$
       <p>
        <strong>
         Translation invariance
        </strong>
       </p>
       <p>
        If $\mathbf{A}$ is a deterministic portfolio with guaranteed return $a$ and $Z \in \mathcal{L}$ then
       </p>
       $$
\varrho (Z+A)=\varrho (Z)-a
$$
       <p>
        The portfolio $\mathbf{A}$ is just adding cash $a$ to your portfolio $Z$. In particular, if $a=\varrho(Z)$ then $\varrho(Z+A)=0$. In financial risk management, translation invariance implies that the addition of a sure amount of capital reduces the risk by the same amount.
       </p>
       <h3 id="Coherent-risk-measures">
        Coherent risk measures
        <a class="anchor-link" href="#Coherent-risk-measures">
         ¶
        </a>
       </h3>
       <p>
        A
        <a href="https://en.wikipedia.org/wiki/Coherent_risk_measure">
         coherent risk measure
        </a>
        additionally satisfies the properties of
        <em>
         monotonicity
        </em>
        ,
        <em>
         sub-additivity
        </em>
        ,
        <em>
         homogeneity
        </em>
        , and
        <em>
         translational invariance
        </em>
        . One example of a popular coherent risk measure is
        <a href="https://en.wikipedia.org/wiki/Expected_shortfall">
         Conditional-Value-at-Risk (CVaR) / Expected shortfall
        </a>
        , while the risk measure
        <a href="https://en.wikipedia.org/wiki/Value_at_risk">
         Value-at-Risk
        </a>
        is not coherent (in the case of a non-elliptical distribution).
       </p>
       <p>
        <strong>
         Sub-additivity
        </strong>
       </p>
       <p>
        Sub-additivity implies that diversification is beneficial meaning that the risk of two portfolios together is less than adding their individual risk
       </p>
       $$
\mathrm{If}\; Z_1,Z_2 \in \mathcal{L} ,\; \mathrm{then}\; \varrho(Z_1 + Z_2) \leq \varrho(Z_1) + \varrho(Z_2)
$$
       <p>
        <strong>
         Positive Homogeneity
        </strong>
       </p>
       <p>
        In financial risk management, positive homogeneity implies the risk of a position is proportional to its size.
       </p>
       <p>
        A risk measure is said to be
        <a href="https://en.wikipedia.org/wiki/Homogeneous_function">
         homogeneous
        </a>
        of degree one if
       </p>
       $$
\mathrm{If}\; \alpha \ge 0 \; \mathrm{and} \; Z \in \mathcal{L} ,\; \mathrm{then} \; \varrho(\alpha Z) = \alpha \varrho(Z)
$$
       <h3 id="Convex-risk-measures">
        Convex risk measures
        <a class="anchor-link" href="#Convex-risk-measures">
         ¶
        </a>
       </h3>
       <p>
        The notion of coherence has been subsequently relaxed. Indeed, the notions of sub-additivity and positive homogeneity can be replaced by the notion of convexity:
       </p>
       $$
Z_1,Z_2 \in \mathcal{L}\text{ and }\lambda \in [0,1] \text{ then }\varrho(\lambda Z_1 + (1-\lambda) Z_2) \leq \lambda \varrho(Z_1) + (1-\lambda) \varrho(Z_2)
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=satellite-responsibility">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Example:-Is-portfolio-standard-devation-a-(coherent)-risk-measure?">
        Example: Is portfolio standard devation a (coherent) risk measure?
        <a class="anchor-link" href="#Example:-Is-portfolio-standard-devation-a-(coherent)-risk-measure?">
         ¶
        </a>
       </h3>
       <p>
        Standard deviation is one of the most used measure of risk in finance, but it is not a coherent risk measure. In fact, it is not even a risk measure based on the above definition!
       </p>
       <p>
        Let $\mathbf{w}$ denote a vector of portfolio weights and $\boldsymbol{\Sigma}$ denote the covariance matrix of the return vector, $\mathbf{R}$, of the $N$ individual assets. The portfolio standard deviation, $\sigma_P$, is given by
       </p>
       $$
\varrho_{\sigma_P}(\mathbf{w}^\top \mathbf{R}) = \sqrt{\text{Var}\left[\mathbf{w}^\top \mathbf{R} \right] } = \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}
$$
       <p>
        <strong>
         Normalization
        </strong>
       </p>
       <p>
        A portfolio with zero allocation to all assets has zero risk
       </p>
       $$
\varrho_{\sigma_P}(\mathbf{0}^\top \mathbf{R}) = \sqrt{\mathbf{0}^\top \boldsymbol{\Sigma} \mathbf{0}} = 0
$$
       <p>
        <strong>
         Monotonicity
        </strong>
       </p>
       <p>
        Standard deviation does not satisfy the monotonicity requirement.
       </p>
       <p>
        We can easily show this by a counter example. Let $Z_1 = k \times U$ be a portfolio where $U$ is a discrete uniform random variable on the values $-1$ and $1$, $U \sim \mathcal{U}(-1, 1)$ and $k&amp;gt;0$ (somekind of digital option). Thus, the return on the portfolio is either $+k$ og $-k$. Next, let another portfolio be defined by $Z_2 = 2Z_1 + 2k$ (2 digitial options and a cash position).
       </p>
       <p>
        Clearly, $Z_2$ dominates $Z_1$ since
       </p>
       $$
\begin{align}
Z_1 = k \; \mathrm{and} \; Z_2 = 4k &amp;amp; \;\mathrm{if} \; U = 1 \\
Z_1 = -k \; \mathrm{and} \; Z_2 = 0 &amp;amp; \; \mathrm{if} \; U = -1
\end{align}
$$
       <p>
        However, $\text{Var}\left[Z_2 \right] &amp;gt; \text{Var}\left[Z_1 \right]$
       </p>
       $$
\begin{align}
\text{Var}\left[Z_1 \right] &amp;amp;= k^2 \frac{3}{12} \\
\text{Var}\left[Z_2 \right] &amp;amp;= 4 \text{Var}\left[Z_1 \right] + 0 = k^2
\end{align}
$$
       <p>
        where we have used the rule $\text{Var}\left[a X + b \right] = a^2\text{Var}\left[X \right] + 0$ and the variance formula for a
        <a href="https://en.wikipedia.org/wiki/Discrete_uniform_distribution">
         uniform random variable
        </a>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=virtual-vinyl">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Translation invariance
        </strong>
       </p>
       <p>
        If $A$ is a deterministic portfolio with guaranteed return $a$, then
       </p>
       $$
\varrho_{\sigma_P}(\mathbf{w}^\top \mathbf{R} + A) = \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}} + 0 = \varrho_{\sigma_P}(\mathbf{w}^\top \mathbf{R})
$$
       <p>
        Portfolio standard deviation does not satisfy the requirement of translation invariance!
       </p>
       <p>
        <strong>
         Positive Homogeneity
        </strong>
       </p>
       <p>
        Standard deviation clearly satisfies positive homogeneity
       </p>
       $$
\varrho_{\sigma_P}(\alpha\mathbf{w}^\top \mathbf{R}) = \sqrt{\text{Var}\left[\alpha\mathbf{w}^\top \mathbf{R} \right] } = \sqrt{\alpha^2\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}} = \alpha\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}} = \alpha \cdot \varrho_{\sigma_P}(\mathbf{w}^\top \mathbf{R})
$$
       <p>
        <strong>
         Sub-additivity
        </strong>
       </p>
       <p>
        Consider the two portfolios $Z_1$ and $Z_2$. We know that
       </p>
       $$
\text{Var}\left[Z_1 + Z_2 \right] = \text{Var}\left[Z_1 \right] + \text{Var}\left[Z_2 \right] + 2\rho_{Z_1, Z_2}\sigma_{Z_1} \sigma_{Z_2}
$$
       <p>
        where the correlation coefficient can take values $\rho_{Z_1, Z_2} \in [-1, 1]$. The last term in the above equation takes its largest value when $\rho_{Z_1, Z_2}=1$ (perfect positive correlation). Thus,
       </p>
       $$
\text{Var}\left[Z_1 + Z_2 \right] = \text{Var}\left[Z_1 \right] + \text{Var}\left[Z_2 \right] + 2\rho_{Z_1, Z_2}\sigma_{Z_1} \sigma_{Z_2} \leq  \text{Var}\left[Z_1 \right] + \text{Var}\left[Z_2 \right] + 2\sigma_{Z_1} \sigma_{Z_2}
$$
       <p>
        Rewriting in terms of standard deviation, we obtain
       </p>
       $$
\sigma_{Z_1 + Z_2}^2  \leq  \sigma_{Z_1 }^2 + \sigma_{Z_2}^2 + 2\sigma_{Z_1} \sigma_{Z_2} = (\sigma_{Z_1 } + \sigma_{Z_2 })^2
$$
       <p>
        Taking the square root yields
       </p>
       $$
\begin{align}
\sqrt{\sigma_{Z_1 + Z_2}^2}  &amp;amp;\leq  \sqrt{(\sigma_{Z_1 } + \sigma_{Z_2 })^2} \\
\sigma_{Z_1 + Z_2}  &amp;amp;\leq  \sigma_{Z_1 } + \sigma_{Z_2 }
\end{align}
$$
       <p>
        Thus, the standard deviation is sub-additive and promotes diversification.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=exact-temperature">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="More-on-risk-measures-and-the-objectives-of-the-investor">
        More on risk measures and the objectives of the investor
        <a class="anchor-link" href="#More-on-risk-measures-and-the-objectives-of-the-investor">
         ¶
        </a>
       </h1>
       <p>
        We have talked about random variables and distributions, so we are ready to talk about how we can calculate these risk measures for a e.g. a portfolio of assets. A risk measure helps us to quantify the dissatisfaction with a given portfolio or investment strategy and is simply a function that maps the random portfolio to the real numbers. The function $\varrho$, as previously discussed, has to satisfy certain properties.
       </p>
       <ul>
        <li>
         Normalization
        </li>
        <li>
         Monotonicity
        </li>
        <li>
         Translation invariance
        </li>
       </ul>
       <p>
        and we will also like it to satisfy
       </p>
       <ul>
        <li>
         Sub-additivity
        </li>
        <li>
         Homogeneity
        </li>
       </ul>
       <h2 id="Goal-of-the-investor">
        Goal of the investor
        <a class="anchor-link" href="#Goal-of-the-investor">
         ¶
        </a>
       </h2>
       <p>
        We will generally assume that an investor holds a portfolio of assets with portfolio weights $\mathbf{w}$ ($n \times 1$ vector) such that the value at time $t$ is given by
       </p>
       $$
\mathbf{V}_t = \mathbf{w}^\top \mathbf{P}_t
$$
       <p>
        The investor may care about (we will use $\mathbf{V}_{t + \tau}$ to denote one of these objectives):
       </p>
       <p>
        <strong>
         Total value (absolute wealth)
        </strong>
        at the end of the investment horizon
       </p>
       $$
\mathbf{V}_{t + \tau} = \mathbf{w}^\top \mathbf{P}_{t + \tau}
$$
       <p>
        <strong>
         Value relative to some benchmark
        </strong>
        at the end of the investment horizon
       </p>
       $$
\mathbf{V}_{t + \tau} = \mathbf{w}^\top \mathbf{P}_{t + \tau} - \nu(\mathbf{w}, \mathbf{w}_b)\mathbf{w}_b^\top \mathbf{P}_{t + \tau} 
$$
       <p>
        where
       </p>
       $$
\nu(\mathbf{w}, \mathbf{w}_b) = \frac{\mathbf{w}^\top \mathbf{P}_{t}}{\mathbf{w}_b^\top \mathbf{P}_{t}}
$$
       <p>
        ensures that portfolios has the same value at time $t$.
       </p>
       <p>
        <strong>
         Net profits
        </strong>
        at the end of the investment horizon
       </p>
       $$
\mathbf{V}_{t + \tau} = \mathbf{w}^\top \left(\mathbf{P}_{t + \tau} - \mathbf{P}_t \right)
$$
       <p>
        <strong>
         Relative net profits
        </strong>
        at the end of the investment horizon
       </p>
       $$
\mathbf{V}_{t + \tau} = \mathbf{w}^\top \frac{\mathbf{P}_{t + \tau} - \mathbf{P}_t}{\mathbf{P}_t} = \mathbf{w}^\top \left( \frac{\mathbf{P}_{t + \tau}}{\mathbf{P}_t} - 1\right)
$$
       <p>
        We note that all "objectives" are affine transformations of $\mathbf{P}_{t+\tau}$. This will make it easy to derive the distribution of $\mathbf{V}_{t + \tau}$ if it is e.g. multivariate normal, but it will generally be a hard task!
       </p>
       <h2 id="Value-at-Risk">
        Value-at-Risk
        <a class="anchor-link" href="#Value-at-Risk">
         ¶
        </a>
       </h2>
       <p>
        Typically, an investor worries about the potential loss over a given horizon, say $\tau$. We can define a measure of dissatisfaction based on the quantiles of the loss distribution (think of a loss as negative net profit). Therefore, we define the $\text{VaR}_\alpha(\mathbf{V}_{t + \tau})$ for $\alpha \in [0, 1]$ as the smallest number such that the probability of $-\mathbf{V}_{t + \tau}$ not exceeding this number is at least $1-\alpha$.
       </p>
       <p>
        Therefore, $\text{VaR}_\alpha(\mathbf{V}_{t + \tau})$ is equal to the $\alpha$ quantile of $\mathbf{V}_{t + \tau}$ (multiplied with -1) or the $1-\alpha$ quantile of $-\mathbf{V}_{t + \tau}$:
       </p>
       $$
\text{VaR}_\alpha(\mathbf{V}_{t + \tau}) = -Q_{\mathbf{V}_{t + \tau}}(\alpha)
$$
       <p>
        If we assume that the linear return of an asset is distributed (1 year horizon) as $\mathbf{V}_{t + 1} = \frac{P_{t+1}}{P_t} - 1   \sim  N(0, 0.2^2)$, then we can use the quantile function of a normal distribution
       </p>
       $$
Q_{\mathbf{V}_{t + \tau}}(\alpha) = \mu +\sigma {\sqrt {2}}\text {erf} ^{-1}(2 \alpha-1)
$$
       <p>
        Below we use
        <code>
         scipy.stats.norm
        </code>
        to calculate the 5% VaR and illustrate it.
       </p>
       <p>
        Please note that the normal assumption is probably bad for the linear return over longer periods, but it is very often used by practioners.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=hungry-constitutional">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="c1"># calculate 5% VaR</span>
<span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

<span class="c1"># values for plotting the pdf</span>
<span class="n">v_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">v_values</span><span class="o">&amp;lt;</span><span class="n">value_at_risk</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Value-at-Risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$v_{t + </span><span class="se">\\</span><span class="s1">tau}$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density, $f_{V_{t + </span><span class="se">\\</span><span class="s1">tau}}(v_{t + </span><span class="se">\\</span><span class="s1">tau})$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>

<span class="c1"># add text</span>
<span class="n">text_to_add</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{VaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">value_at_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.3</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="n">text_to_add</span><span class="p">);</span>

<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=identical-dakota">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        If we consider a portfolio of assets
       </p>
       $$
\mathbf{P}_{t + \tau} \sim N(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        Then the net profits of a portfolio $\mathbf{V}_{t + \tau} = \mathbf{w}^\top \left(\mathbf{P}_{t + \tau} - \mathbf{P}_t \right)$ will be distributed as (note that $\mathbf{P}_t$ is known at time $t$)
       </p>
       $$
\mathbf{V}_{t + \tau} \sim N\left(\mathbf{w}^\top\left(\boldsymbol{\mu} -\mathbf{P}_t \right), \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w} \right)
$$
       <p>
        Thus, we could easily use a univariate normal distribution to calculate the $\text{VaR}$. But this is not generally the case! E.g. if we assume (which often is a better approximation)
       </p>
       $$
\mathbf{P}_{t + \tau} \sim \log N(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        Then, we do not have an easy closed-form expression for the distribution of $\mathbf{V}_{t + \tau}$. Therefore, we often must resort to simulations or approximations to calculate the Value at Risk for a portfolio.
       </p>
       <h3 id="Cornish-Fisher-approximation">
        Cornish-Fisher approximation
        <a class="anchor-link" href="#Cornish-Fisher-approximation">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Note:
        </strong>
        I do not expect you to know all the details, but simply that you can apply the approximation.
       </p>
       <p>
        One often used approximation is the Cornish-Fisher approximation (based on a Cornish-Fisher expansion).
        <a href="https://digital.library.adelaide.edu.au/dspace/bitstream/2440/15229/1/148.pdf">
         Cornish and Fisher (1937)
        </a>
        used an asymptotic expansion to approximate the quantiles of a probability distribution based on its
        <a href="https://en.wikipedia.org/wiki/Cumulant">
         cumulants
        </a>
        .
       </p>
       <p>
        We note that the $n$'th cumulant of a random variable $X$ can be found using the cumulant genrating function
       </p>
       $$
 K(t)=\log \text {E} \left[e^{tX}\right] = \sum _{n=1}^{\infty }\kappa _{n}{\frac {t^{n}}{n!}}=\mu t+\sigma ^{2}{\frac {t^{2}}{2}}+\cdots 
$$
       <p>
        by differentiating $n$ times and evaluating at $t=0$. If we denote the mean by $\mu$ and the central moments by $\mu_k = \text{E}[(X-\mu)^k]$ one can show that the first four cumulants are
       </p>
       $$
\begin{align}
\kappa_1 &amp;amp;= \mu \\
\kappa_2 &amp;amp;= \mu_2 = \sigma^2 \\
\kappa_3 &amp;amp;= \frac{\mu_3}{\kappa_2^{3/2}} = \frac{\mu_3}{\sigma^3} = \text{Skew}(X) \\
\kappa_4 &amp;amp;= \frac{\mu_4}{\kappa_2^{2}}  - 3= \frac{\mu_4}{\sigma^4} = \text{Kurt}(X)
\end{align}
$$
       <p>
        The Cornish-Fisher approximation using the first four cumulants of a random variable $X$ with mean $\mu$ and variance $\sigma^2$ is given by (
        <a href="https://en.wikipedia.org/wiki/Cornish%E2%80%93Fisher_expansion">
         see here
        </a>
        )
       </p>
       $$
Q_X(p) = \mu + \sigma \left[z_p +  \text{Skew}(X) \frac{He_2(z_p)}{6} +  \text{Kurt}(X) \frac{He_3(z_p)}{24} - \text{Skew}(X)^2 \frac{2He_3(z_p) + He_1(z_p)}{36}  \right]
$$
       <p>
        where $He_n$ is the n'th order
        <a href="https://en.wikipedia.org/wiki/Hermite_polynomials">
         "probabilist's" Hermite polynomial
        </a>
        and $z_p$ is the $p$ percentile of the standard normal distribution.
       </p>
       <p>
        <strong>
         Example: Approximation to log-normal
        </strong>
       </p>
       <p>
        Assume that $X \sim \log N(0, 0.2)$. Calculate the $5\%$ percentile of $X$. Define a funtion that calculates the Cornish-Fisher approximation. Use this to calculate the $5\%$ percentile of $X$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sitting-trading">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">s</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=paperback-bradley">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_cornish_fisher_percentile</span><span class="p">(</span><span class="n">alpha</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurt</span><span class="p">):</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the percentile, alpha, based on the Cornish-Fisher approximation </span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    alpha: float</span>
<span class="sd">    mu: float</span>
<span class="sd">    sigma: float</span>
<span class="sd">    skew: float</span>
<span class="sd">    kurt: float</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Percentile</span>

<span class="sd">    """</span>

    <span class="n">z</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    <span class="n">he2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">hermite_e</span><span class="o">.</span><span class="n">hermeval</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">he3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">hermite_e</span><span class="o">.</span><span class="n">hermeval</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">he13</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polynomial</span><span class="o">.</span><span class="n">hermite_e</span><span class="o">.</span><span class="n">hermeval</span><span class="p">(</span><span class="n">z</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">])</span>
    
    <span class="n">w</span> <span class="o">=</span> <span class="p">(</span><span class="n">z</span> <span class="o">+</span>
         <span class="n">he2</span><span class="o">*</span><span class="n">skew</span><span class="o">/</span><span class="mi">6</span> <span class="o">+</span>
         <span class="n">he3</span><span class="o">*</span><span class="n">kurt</span><span class="o">/</span><span class="mi">24</span> <span class="o">+</span>
         <span class="n">he13</span><span class="o">*</span><span class="p">(</span><span class="n">skew</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="mi">36</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">mu</span> <span class="o">+</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=magnetic-express">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu_new</span><span class="p">,</span> <span class="n">var</span><span class="p">,</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurt</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">s</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">mu</span><span class="p">),</span>  <span class="n">moments</span><span class="o">=</span><span class="s1">'mvsk'</span><span class="p">)</span>

<span class="n">calculate_cornish_fisher_percentile</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">mu_new</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">),</span> <span class="n">skew</span><span class="p">,</span> <span class="n">kurt</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=resident-claim">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Simulation">
        Simulation
        <a class="anchor-link" href="#Simulation">
         ¶
        </a>
       </h3>
       <p>
        Another often used approach is to calculate $\text{VaR}$ using simulations. Let us revist a simple example where we assume that log returns (the market invariants) follow a multivariate normal distribution
       </p>
       $$
\mathbf{r}_{t+ \tau, \tau} = \log \frac{\mathbf{P}_{t+\tau}}{\mathbf{P}_t} \sim N(\boldsymbol{\mu}, \boldsymbol{\Sigma})
$$
       <p>
        We also remember that we can write
       </p>
       $$
\mathbf{R}_{t + \tau, \tau} = e^{\mathbf{r}_{t+ \tau, \tau}} - 1
$$
       <p>
        The investor is interested in the $\text{VaR}$ of $\mathbf{V}_{t + \tau} = \mathbf{w}^\top\mathbf{R}_{t + \tau, \tau}$. By simulating enough times, we can "estimate" the  $\text{VaR}$.
       </p>
       <p>
        <strong>
         Example: Calculating VaR using simulations
        </strong>
       </p>
       <p>
        Consider a two asset example with stocks (S) and bonds (B) and assume that log returns are bivariate normally distributed. Stocks are defined by $\mu_S = 0.04, \sigma_S = 0.15$ and bonds are defined by $\mu_B = 0.01, \sigma_B = 0.06$. The correlation between stocks and bonds is $\rho _{S,B} = 0.2$.
       </p>
       <p>
        Calculate the 5% $\text{VaR}$ of an equally weighted porfolio (of linear returns).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=silver-finnish">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define relevant information </span>
<span class="sd">"""</span>

<span class="n">w_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

<span class="n">mu_s</span> <span class="o">=</span> <span class="mf">0.06</span>
<span class="n">mu_b</span> <span class="o">=</span> <span class="mf">0.01</span>
<span class="n">sigma_s</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">sigma_b</span> <span class="o">=</span> <span class="mf">0.075</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="n">mus</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">mu_s</span><span class="p">,</span> <span class="n">mu_b</span><span class="p">])</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sigma_s</span><span class="p">,</span> <span class="n">sigma_b</span><span class="p">])</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rho</span><span class="p">],</span> <span class="p">[</span><span class="n">rho</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span> <span class="o">*</span> <span class="n">corr_mat</span>

<span class="sd">"""</span>
<span class="sd">Simulate </span>
<span class="sd">"""</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">99999</span>
<span class="n">sim_log_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mus</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>
<span class="n">sim_lin_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">sim_log_returns</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span>
<span class="n">sim_port_returns</span> <span class="o">=</span> <span class="n">sim_lin_returns</span> <span class="o">@</span> <span class="n">w_eq</span>

<span class="c1"># use numpys percentile to calculate the fifth percentile (note the use of 5 and not 0.05)</span>
<span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">q</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=closing-activation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_port_returns</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">value_at_risk</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">4.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Value-at-Risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$v_{t + </span><span class="se">\\</span><span class="s1">tau}$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density, $f_{V_{t + </span><span class="se">\\</span><span class="s1">tau}}(v_{t + </span><span class="se">\\</span><span class="s1">tau})$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>

<span class="c1"># add text</span>
<span class="n">text_to_add</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{VaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">value_at_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.275</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">text_to_add</span><span class="p">);</span>

<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=complex-wales">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Conditional-Value-at-Risk--(Expected-shortfall)">
        Conditional Value-at-Risk  (Expected shortfall)
        <a class="anchor-link" href="#Conditional-Value-at-Risk--(Expected-shortfall)">
         ¶
        </a>
       </h2>
       <p>
        We have previously noted that $\text{VaR}$ is not a coherent risk measure since it does not satisfy the requirement of sub-additivity:
       </p>
       $$
\mathrm{If}\; Z_1, Z_2 \in \mathcal{L} ,\; \mathrm{then}\; \text{VaR}(Z_1 + Z_2) \nleq \text{VaR}(Z_1) + \text{VaR}(Z_2)
$$
       <p>
        This means that $\text{VaR}$ (sometimes) will not promote diversification - this is quit problematic when diversification is key in asset allocation!
       </p>
       <p>
        The Conditional Value-at-Risk (or Expected shortfall), $\text{CVaR}$,  is a coherent risk measure that is sub-additive. The $\text{CVaR}$ is defined as the average $\text{VaR}$
       </p>
       $$
\text{CVaR}_{\alpha}(X) = \frac{1}{\alpha} \intop_{0}^{\alpha} \text{VaR}_{s} (X) ds 
$$
       <p>
        If we assume that the linear return of an asset is distributed (1 year horizon) as $\mathbf{V}_{t + 1} = \frac{P_{t+1}}{P_t} - 1   \sim  N(0, 0.2)$, then we can use the quantile function of a normal distribution
       </p>
       $$
\text{CVaR}_{\alpha} = -\mu + \sigma \frac{\phi\left(\Phi^{-1}(\alpha) \right)}{\alpha}
$$
       <p>
        where $\phi()$ and $\Phi^{-1}$ denote the standard normal pdf and quantile function respectively.
       </p>
       <p>
        Below we use
        <code>
         scipy.stats.norm
        </code>
        to calculate the 5% CVaR and illustrate it.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=faced-crisis">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.2</span>

<span class="c1"># calculate 5% VaR and CVaR</span>
<span class="n">value_at_risk</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">cond_value_at_risk</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span>  <span class="n">sigma</span><span class="o">*</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.05</span><span class="p">))</span> <span class="o">/</span> <span class="mf">0.05</span>

<span class="c1"># values for plotting the pdf</span>
<span class="n">v_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">)</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">v_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">v_values</span><span class="o">&amp;lt;</span><span class="n">value_at_risk</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">cond_value_at_risk</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="mf">4.1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Value-at-Risk and Cond. Value-at-Risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$v_{t + </span><span class="se">\\</span><span class="s1">tau}$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density, $f_{V_{t + </span><span class="se">\\</span><span class="s1">tau}}(v_{t + </span><span class="se">\\</span><span class="s1">tau})$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">);</span>

<span class="c1"># add text</span>
<span class="n">text_to_add</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{VaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">value_at_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">text_to_add_2</span> <span class="o">=</span>  <span class="s2">"$\mathbf</span><span class="si">{CVaR}</span><span class="s2">_</span><span class="si">{0.05}</span><span class="s2">"</span> <span class="o">+</span> <span class="s2">" = </span><span class="si">{:,.1f}</span><span class="s2">\%$"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="o">-</span><span class="n">cond_value_at_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.35</span><span class="p">,</span> <span class="mf">0.20</span><span class="p">,</span> <span class="n">text_to_add</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="o">-</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="n">text_to_add_2</span><span class="p">,</span><span class="n">rotation</span><span class="o">=</span><span class="mi">90</span><span class="p">);</span>

<span class="c1"># x-axis a percent</span>
<span class="n">xticks</span> <span class="o">=</span> <span class="n">mtick</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">xticks</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8ef7e483">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://onlinelibrary.wiley.com/doi/abs/10.1111/1467-9965.00068">
         Artzner et al (1999), "Coherent Measures of Risks"
        </a>
       </p>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2009778">
         Bruder and Roncalli (2012), "Managing Risk Exposures using
the Risk Budgeting Approach"
        </a>
       </p>
       <p>
        <a href="https://digital.library.adelaide.edu.au/dspace/bitstream/2440/15229/1/148.pdf">
         Cornish and Fisher (1937)
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.com/Risk-Asset-Allocation-Springer-Finance/dp/3642009646">
         Attilio Meucci, "Risk and Asset Allocation"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-1:-Head-on-with-Python">
        Week 1: Head-on with Python
        <a class="anchor-link" href="#Week-1:-Head-on-with-Python">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=executive-queue">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Getting-started">
        Getting started
        <a class="anchor-link" href="#Getting-started">
         ¶
        </a>
       </h2>
       <p>
        Check out this
        <a href="https://staxmetrics.github.io/python_for_the_financial_economist/">
         getting started guide
        </a>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        will
       </p>
       <ul>
        <li>
         Introduce different ways of working with Python
        </li>
        <li>
         A recap of some matrix operations and an introduction to the
         <code>
          numpy
         </code>
         package
        </li>
       </ul>
       <p>
        There will be no
        <strong>
         exercises
        </strong>
        this week. However, the students are expected work on the assigned track
        <a href="https://learn.datacamp.com/skill-tracks/python-fundamentals">
         Python Fundamentals
        </a>
        at
        <a href="https://learn.datacamp.com">
         DataCamp
        </a>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=domestic-split">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Introduction-to-Python">
        Introduction to Python
        <a class="anchor-link" href="#Introduction-to-Python">
         ¶
        </a>
       </h2>
       <p>
        DataCamp will be used throughout the course to introduce relevent Python concepts. All students attending the course should be able to sign up, free-of-charge, to
        <a href="https://learn.datacamp.com">
         DataCamp
        </a>
        .
       </p>
       <p>
        During the first week, I have assigned the track
        <a href="https://learn.datacamp.com/skill-tracks/python-fundamentals">
         Python Fundamentals
        </a>
        which will introduce data types, functions, packages, etc.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=guided-theorem">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Jupyter-notebooks">
        Jupyter notebooks
        <a class="anchor-link" href="#Jupyter-notebooks">
         ¶
        </a>
       </h2>
       <p>
        Much of the course materiale will be presented using Jupyter notebooks.
       </p>
       <p>
        Jupyter notebooks are one of many ways to interact with Python and its scientific libraries (packages). One of the main strenghs is that Jupyter notebooks allow us excute python commands in an interactive fashion including visualizations and combine it with text and mathematical expressions.
       </p>
       <p>
        Ideal for learning Python, exploring idea and interacting with data. However, if the goal is to build your own  code library then it is not the way to go.
       </p>
       <p>
        To work with in Jupyter notebook, we need to excute the following command in the command prompt (after navigating to the desired starting folder)
       </p>
       <div class="highlight">
        <pre><span></span><span class="go">jupyter notebook</span>
</pre>
       </div>
       <h3 id="Magic-commands">
        Magic commands
        <a class="anchor-link" href="#Magic-commands">
         ¶
        </a>
       </h3>
       <p>
        Magic commands are special commands that can help you with running and analyzing data in your notebook. They add a special functionality that is not straight forward to achieve with python code or jupyter notebook interface. Magic commands are easy to spot within the code.
       </p>
       <p>
        We may want to time exectution time of a function call
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=spread-rover">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">%</span><span class="k">timeit</span> 3**2
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=continuous-yahoo">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We may want the docstring of a function
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=metallic-archive">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="o">%</span><span class="k">pdoc</span> np.square
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=minimal-religion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        List of magic commands
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=other-martial">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">%</span><span class="k">lsmagic</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=consecutive-appointment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Packages">
        Packages
        <a class="anchor-link" href="#Packages">
         ¶
        </a>
       </h2>
       <p>
        During the course, we will use a number of packages of scientific computing including
       </p>
       <ul>
        <li>
         <code>
          numpy
         </code>
         : Numerical programing including working with arrays
        </li>
        <li>
         <code>
          scipy
         </code>
         : Builds on Numpy as provides tools for scientific programming such as optimization, linear algebra, distributions, etc.
        </li>
        <li>
         <code>
          matplotlib
         </code>
         : Plotting library
        </li>
       </ul>
       <p>
        If we load the
        <code>
         numpy
        </code>
        packages and name it
        <code>
         np
        </code>
        , we will be able to access the functionality of
        <code>
         numpy
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=human-zimbabwe">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># import numpy as np </span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># define two arrays </span>
<span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">])</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">])</span>

<span class="c1"># find outer-product</span>
<span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">a</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-10:-Portfolio-heuristics-and-risk-based-strategies">
        Week 10: Portfolio heuristics and risk based strategies
        <a class="anchor-link" href="#Week-10:-Portfolio-heuristics-and-risk-based-strategies">
         ¶
        </a>
       </h1>
       <p>
        In this week, we will look at some heuristic approaches to portfolio optimization.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        cover
       </p>
       <ul>
        <li>
         Risk based strategies
        </li>
        <li>
         Portfolio heuristics
        </li>
       </ul>
       <p>
        The
        <strong>
         exercises
        </strong>
        cover
       </p>
       <ul>
        <li>
         Implementation of variable transaction costs
        </li>
        <li>
         Effective number of uncorrelated bets
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-2:-Financial-data">
        Week 2: Financial data
        <a class="anchor-link" href="#Week-2:-Financial-data">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=domestic-split">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        For the second week, I have assigned the course
        <a href="https://learn.datacamp.com/courses/introduction-to-data-visualization-with-matplotlib">
         Introduction to Data Visualization with Matplotlib
        </a>
        which will introduce plotting functionality in Python.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        will cover
       </p>
       <ul>
        <li>
         Downloading data directly into Python using different APIs
        </li>
        <li>
         Discussing how to model financial markets
        </li>
       </ul>
       <p>
        The
        <strong>
         exercises
        </strong>
        will cover
       </p>
       <ul>
        <li>
         Consequence of misspecifying the asset allocation problem
        </li>
        <li>
         Consequence of mean-reversion for the square-root rule
        </li>
        <li>
         Importing and plotting nominal yield data
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-3:-Something-about-distributions">
        Week 3: Something about distributions
        <a class="anchor-link" href="#Week-3:-Something-about-distributions">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=domestic-split">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="DataCamp">
        DataCamp
        <a class="anchor-link" href="#DataCamp">
         ¶
        </a>
       </h2>
       <p>
        During the third week, I have assigned the course
        <a href="https://learn.datacamp.com/courses/introduction-to-data-visualization-with-seaborn">
         Introduction to Data Visualization with Seaborn
        </a>
        which will introduce the seaborn package.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        will introduce (recap) concepts related to
       </p>
       <ul>
        <li>
         Univariate statistics
        </li>
        <li>
         Multivariate statistics
        </li>
       </ul>
       <p>
        The
        <strong>
         exercises
        </strong>
        will cover
       </p>
       <ul>
        <li>
         The Student's t distribution
        </li>
        <li>
         The empirical distribution function
        </li>
        <li>
         Moments with scenario probabilities
        </li>
        <li>
         Exponential decay probabilities
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-4:-Risk-measures-and-risk-contribution">
        Week 4: Risk measures and risk contribution
        <a class="anchor-link" href="#Week-4:-Risk-measures-and-risk-contribution">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        will introduce concepts related to
       </p>
       <ul>
        <li>
         Risk measures
        </li>
        <li>
         Allocating diversification benefits
        </li>
       </ul>
       <p>
        The
        <strong>
         exercises
        </strong>
        will cover
       </p>
       <ul>
        <li>
         VaR and CVaR using historical simulation
        </li>
        <li>
         Maximum drawdown
        </li>
        <li>
         Portfolio diversification
        </li>
        <li>
         Allocating diversification benefits for VaR and CVaR
        </li>
        <li>
         Scenario based risk measures
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-5:-Optimization">
        Week 5: Optimization
        <a class="anchor-link" href="#Week-5:-Optimization">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        will introduce concepts related numerical optimization and show how to use the optimizers in
        <code>
         scipy.optimize
        </code>
        .
       </p>
       <p>
        The
        <strong>
         exercises
        </strong>
        will ask the students to solve different optimization problems:
       </p>
       <ul>
        <li>
         Second order conditions
        </li>
        <li>
         Minimizing distance
        </li>
        <li>
         Calibration of the Nelson-Siegel-Svensson curve
        </li>
        <li>
         Portfolio optimization with constraints
        </li>
        <li>
         Minimizing CVaR (and VaR)
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-6:-Optimization-and-estimation">
        Week 6: Optimization and estimation
        <a class="anchor-link" href="#Week-6:-Optimization-and-estimation">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        will introduce concepts related to optimization and estimation.
       </p>
       <p>
        The
        <strong>
         exercises
        </strong>
        will  will look at
       </p>
       <ul>
        <li>
         Convex optimization
         <ul>
          <li>
           Classical Mean-Variance optimization with constraints
          </li>
          <li>
           Cash flow hedging
          </li>
         </ul>
        </li>
        <li>
         Estimation
         <ul>
          <li>
           OLS vs. MLE
          </li>
          <li>
           Shrinkage estimator
          </li>
         </ul>
        </li>
        <li>
         Some optional exercises
         <ul>
          <li>
           Recession forecasting
          </li>
          <li>
           Hypothesis testing
          </li>
         </ul>
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-7:-Fixed-income-modelling">
        Week 7: Fixed income modelling
        <a class="anchor-link" href="#Week-7:-Fixed-income-modelling">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=domestic-split">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Introduction-to-object-oriented-programming">
        Introduction to object oriented programming
        <a class="anchor-link" href="#Introduction-to-object-oriented-programming">
         ¶
        </a>
       </h2>
       <p>
        Please take the DataCamp course
        <a href="https://app.datacamp.com/learn/courses/object-oriented-programming-in-python">
         Object Oriented Programming in Python
        </a>
        . Alternativly you can take
        <a href="https://app.datacamp.com/learn/courses/introduction-to-object-oriented-programming-in-python">
         Introduction to Object Oriented Programming in Python
        </a>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        will introduce concepts related to fixed income
       </p>
       <ul>
        <li>
         Yield curve extraction
        </li>
        <li>
         Curve and cash flow objects
        </li>
       </ul>
       <p>
        The
        <strong>
         exercises
        </strong>
        will cover
       </p>
       <ul>
        <li>
         The Vasicek model
        </li>
        <li>
         Dynamic Nelson-Siegel model
        </li>
        <li>
         Principal components
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-8:-The-covariance-matrix">
        Week 8: The covariance matrix
        <a class="anchor-link" href="#Week-8:-The-covariance-matrix">
         ¶
        </a>
       </h1>
       <p>
        In this week, we will have a closer look at the covariance and correlation matrix.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        cover
       </p>
       <ul>
        <li>
         Shrinkage estimation of the covariance matrix
        </li>
        <li>
         Denoising the correlation matrix using knowledge from random matrix theory
        </li>
       </ul>
       <p>
        The
        <strong>
         exercises
        </strong>
        cover
       </p>
       <ul>
        <li>
         Implemention of single index shrinkage model [optional]
        </li>
        <li>
         Implemention of simulation study to see the effect of denoising the covariance matrix
        </li>
        <li>
         Distribution of the covariance matrix when data follows a multivariate normal distribution
        </li>
        <li>
         Implemention of exponential filter to estimate the covariance matrix
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=sustainable-funds">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Week-9:-Introduction-to-modern-portfolio-theory">
        Week 9: Introduction to modern portfolio theory
        <a class="anchor-link" href="#Week-9:-Introduction-to-modern-portfolio-theory">
         ¶
        </a>
       </h1>
       <p>
        In this week, we will look at the Markowitz approach to portfolio optimization.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ahead-rebound">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Lectures-and-exercises">
        Lectures and exercises
        <a class="anchor-link" href="#Lectures-and-exercises">
         ¶
        </a>
       </h2>
       <p>
        The
        <strong>
         lectures
        </strong>
        cover
       </p>
       <ul>
        <li>
         Classic Mean-Variance optimization
        </li>
        <li>
         A discussion of the instability problem
        </li>
        <li>
         Some solutions to the instability problem
        </li>
       </ul>
       <p>
        The
        <strong>
         exercises
        </strong>
        cover
       </p>
       <ul>
        <li>
         Comparing the equally weighted and the value weighted portfolio
        </li>
        <li>
         Satisfaction from portfolio optimization
        </li>
        <li>
         Multi-year portfolio optimization
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># numpy for working with matrices</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># plotting libraries</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>

<span class="c1"># for working with time and dates</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># scipy for statistics and optimization</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="c1"># cvxpy </span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>

<span class="c1"># typehints</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.statistics.moments</span> <span class="kn">import</span> <span class="n">corr_to_cov_matrix</span>

<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.mean_variance</span> <span class="kn">import</span> <span class="n">portfolio_mean</span><span class="p">,</span> <span class="n">portfolio_std</span><span class="p">,</span> <span class="n">portfolio_variance</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.risk_budget</span> <span class="kn">import</span> <span class="n">calculate_marginal_risks_std</span><span class="p">,</span> <span class="n">calculate_risk_contributions_std</span><span class="p">,</span> <span class="n">calculate_marginal_sharpe</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span><span class="p">,</span> <span class="n">default_colors</span>
<span class="n">DefaultStyle</span><span class="p">();</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">risk_waterfall_chart</span><span class="p">,</span> <span class="n">waterfall_chart</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=incoming-mirror">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Modern-Portfolio-Theory">
        Modern Portfolio Theory
        <a class="anchor-link" href="#Modern-Portfolio-Theory">
         ¶
        </a>
       </h1>
       <p>
        <a href="https://en.wikipedia.org/wiki/Modern_portfolio_theory">
         Modern portfolio theory or mean-variance optimization
        </a>
        dates back to Harry Markowitz in the 1950s and revolutionized investors approach to investing and diversification. Markowitz's approach made it clear that diversification is key when evaluating a given investment given the universe of investable assets. Furthermore, it is not only the number of assets that determine the level of diversification but also the dependence between assets. The particular method suggested by Markowitz has it flaws but stands as the foundation for all the innovations we have seen during the last 50 years.
       </p>
       <h2 id="Introduction">
        Introduction
        <a class="anchor-link" href="#Introduction">
         ¶
        </a>
       </h2>
       <h3 id="The-basic-problem">
        The basic problem
        <a class="anchor-link" href="#The-basic-problem">
         ¶
        </a>
       </h3>
       <p>
        One way to look at the mean-variance framework is to maximize the expected quadratic utility (we could also minimize variance for a given return target)
       </p>
       $$
U(\mathbf{w}) = \mathbf{w}^\top \boldsymbol{\mu} - \frac{\lambda}{2} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        where $\mathbf{w}$ denotes the portfolio weights ($N \times 1$ vector), $\boldsymbol{\mu}$ expected return vector ($N \times 1$ vector) and $\boldsymbol{\Sigma}$ the covariance matrix ($N \times N$ matrix). $\lambda$ is linked to the risk aversion.
       </p>
       <p>
        The FOCs (setting the derivative wrt. to $\mathbf{w}$ equal to zero) are given by
       </p>
       $$
\left. \frac{\partial U(\mathbf{w})}{\partial \mathbf{w}} \right \vert_{\mathbf{w}= \mathbf{w}^*} = \boldsymbol{\mu} - \lambda \boldsymbol{\Sigma} \mathbf{w}^* = \mathbf{0}
$$
       <p>
        resulting in the solution
       </p>
       $$
\mathbf{w}^* = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu} 
$$
       <p>
        The above case is of course unrealistic in practice since an investor probably would like to impose different constraints. Adding linear constraints covers many relevant constraints.
       </p>
       <h3 id="Adding-linear-constraints">
        Adding linear constraints
        <a class="anchor-link" href="#Adding-linear-constraints">
         ¶
        </a>
       </h3>
       <p>
        The mean-variance optimization with linear constraints can be written  as
       </p>
       $$
\mathbf{w}^* = \underset{\mathbf{w}}{\text{arg max }} U(\mathbf{w}) = \underset{\mathbf{w}}{\text{arg max }} \mathbf{w}^\top \boldsymbol{\mu} - \frac{\lambda}{2 } \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to the $M$ constraints
       </p>
       $$
\mathbf{A} \mathbf{w} = \mathbf{b}
$$
       <p>
        where $\mathbf{A}$ is a ($M \times N$ matrix) and $\mathbf{b}$ is a ($M \times 1$ vector).
       </p>
       <p>
        The Lagrangian for this problem can be written as
       </p>
       $$
\mathcal{L} = U(\mathbf{w}) - \boldsymbol{\gamma} (\mathbf{A} \mathbf{w} - \mathbf{b})
$$
       <p>
        The objective is then to maximize the Lagrangian. The solution to this maximization problem is given by (see e.g.
        <a href="https://www.amazon.com/Portfolio-Management-under-Stress-Bayesian-Net/dp/1107048117">
         Rebonato and Denev, "Portfolio Management under stress"
        </a>
        )
       </p>
       $$
\mathbf{w}^* = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu} - \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \mathbf{A}^\top \mathbf{C}^{-1} \left(\mathbf{A}\boldsymbol{\Sigma}^{-1}\boldsymbol{\mu}  - \lambda \mathbf{b} \right)
$$
       <p>
        with $\mathbf{C} = \mathbf{A} \boldsymbol{\Sigma}^{-1}\mathbf{A}^\top$.
       </p>
       <p>
        <strong>
         The budget constraint
        </strong>
       </p>
       <p>
        We will typically add a budget constraint stating that the amount invested should be equal to a certain amount (typically normalized to $1$ dollar such that we can interpret the portfolio weights as the proportion invested in the assets)
       </p>
       $$
\sum_{i=1}^N w_i = \mathbf{1}^\top \mathbf{w} = 1
$$
       <p>
        This particular constraint can be implemented using the above formula with $\mathbf{A} = \mathbf{1}^\top$ and $\mathbf{b} = 1$.
       </p>
       <p>
        <strong>
         Expected return target
        </strong>
       </p>
       <p>
        We may assume that the investor target a particular return
       </p>
       $$
\sum_{i=1}^N w_i \mu_i = \boldsymbol{\mu}^\top \mathbf{w} = \bar{\mu}_p
$$
       <p>
        Thus,  $\mathbf{A} = \boldsymbol{\mu}^\top$ and $\mathbf{b} = \bar{\mu}_p$.
       </p>
       <h2 id="Alternative-specifictions">
        Alternative specifictions
        <a class="anchor-link" href="#Alternative-specifictions">
         ¶
        </a>
       </h2>
       <p>
        An alternative way of looking the mean-variance problem is to minimize variance for a given return target:
       </p>
       $$
\mathbf{w}^* = \underset{\mathbf{w}}{\text{arg min }} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to the budget constraint and a return target
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
\mathbf{w}^\top \boldsymbol{\mu} &amp;amp;= \bar{\mu}_p
\end{align}
$$
       <p>
        Yet another approach is to maximize expected return given a risk target:
       </p>
       $$
\mathbf{w}^* = \underset{\mathbf{w}}{\text{arg max }} \mathbf{w}^\top \mu
$$
       <p>
        subject to the budget constraint and a variance target
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w} &amp;amp;= \bar{\sigma}_p^2
\end{align}
$$
       <h2 id="Some-important-portfolios">
        Some important portfolios
        <a class="anchor-link" href="#Some-important-portfolios">
         ¶
        </a>
       </h2>
       <h3 id="The-(global)-minimum-variance-portfolio">
        The (global) minimum variance portfolio
        <a class="anchor-link" href="#The-(global)-minimum-variance-portfolio">
         ¶
        </a>
       </h3>
       <p>
        The minimum variance portfolio is the solution to the below problem.
       </p>
       $$
\mathbf{w}^* = \underset{\mathbf{w}}{\text{arg min }} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to the budget constraint
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
\end{align}
$$
       <p>
        Note that we also could have maximize the quadratic utility assuming that $\lambda \to \infty$.
       </p>
       <p>
        The solution to the above problem can be found by defining the Lagrangian, finding the FOCs and solving the FOCs. One can show that the solution to this problem is given by
       </p>
       $$
\mathbf{w}^* = \frac{\boldsymbol{\Sigma}^{-1} \mathbf{1}}{\mathbf{1}^\top \boldsymbol{\Sigma}^{-1} \mathbf{1}}
$$
       <h3 id="Efficient-portfolios">
        Efficient portfolios
        <a class="anchor-link" href="#Efficient-portfolios">
         ¶
        </a>
       </h3>
       <p>
        We could specify the mean-variance problem as
       </p>
       $$
\mathbf{w}^* = \underset{\mathbf{w}}{\text{arg min }} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to the budget constraint and a return target
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
\mathbf{w}^\top \boldsymbol{\mu} &amp;amp;= \bar{\mu}_p
\end{align}
$$
       <p>
        The corresponding Lagrangian is given by
       </p>
       $$
\mathcal{L}(\mathbf{w}, \gamma_1, \gamma_2) = \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w} + \gamma_1 \left(\mathbf{w}^\top \boldsymbol{\mu} - \bar{\mu}_p\right) + \gamma_2 \left(\mathbf{w}^\top \mathbf{1} -1 \right)
$$
       <p>
        The first order conditions are given by
       </p>
       $$
\begin{align}
\frac{\partial \mathcal{L}(\mathbf{w}, \gamma_1, \gamma_2)}{\partial \mathbf{w}} &amp;amp;= 2  \boldsymbol{\Sigma} \mathbf{w} + \gamma_1 \boldsymbol{\mu} +   \gamma_2 \mathbf{1} = \mathbf{0} \\
\frac{\partial \mathcal{L}(\mathbf{w}, \gamma_1, \gamma_2)}{\partial \gamma_1} &amp;amp;= \mathbf{w}^\top \boldsymbol{\mu} - \bar{\mu}_p = 0 \\
\frac{\partial \mathcal{L}(\mathbf{w}, \gamma_1, \gamma_2)}{\partial \gamma_2} &amp;amp;= \mathbf{w}^\top \mathbf{1} -1 = 0
\end{align}
$$
       <p>
        We can alternatively write this as a system of linear equations
       </p>
       $$
\mathbf{A} \mathbf{x} = \mathbf{b}
$$
       <p>
        with
       </p>
       $$
\mathbf{A} = \begin{bmatrix}
2  \boldsymbol{\Sigma} &amp;amp; \boldsymbol{\mu} &amp;amp; \mathbf{1} \\
\boldsymbol{\mu}^\top &amp;amp; 0 &amp;amp; 0 \\
\mathbf{1}^\top &amp;amp; 0 &amp;amp; 0\end{bmatrix}
$$
       <p>
        and
       </p>
       $$
\mathbf{x} = \begin{bmatrix}
\mathbf{w} \\
\gamma_1 \\
\gamma_2 \end{bmatrix}
$$
       <p>
        and
       </p>
       $$
\mathbf{b} = \begin{bmatrix}
\mathbf{0} \\
 \bar{\mu}_p \\
1 \end{bmatrix}
$$
       <p>
        We can easily solve this system of equations
       </p>
       $$
\mathbf{x} = \mathbf{A}^{-1} \mathbf{b}
$$
       <p>
        We will call the solution (the first $N$ elements of the vector $\mathbf{x}$) an efficient portfolio if the expected return is equal to or larger than the return of the minimum variance portfolio.
       </p>
       <h3 id="The-efficient-frontier">
        The efficient frontier
        <a class="anchor-link" href="#The-efficient-frontier">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Mutual_fund_separation_theorem">
         seperation theorem
        </a>
        tells us that any efficient portfolio (minimum variance portfolio for a given target return) defined by the portfolio weights $\mathbf{w}_c$ can be obtained as a linear combination of two other efficient portfolios defined by the portfolio weights $\mathbf{w}_a$ and $\mathbf{w}_b$
       </p>
       $$
\mathbf{w}_c = \alpha \mathbf{w}_a + (1-\alpha) \mathbf{w}_b
$$
       <p>
        Thus, we only need to find two efficient portfolios to draw the entire efficient frontier!
       </p>
       <h3 id="The-tangency-portfolio">
        The tangency portfolio
        <a class="anchor-link" href="#The-tangency-portfolio">
         ¶
        </a>
       </h3>
       <p>
        The tangency portfolio is the portfolio of risky assets with highest Sharpe ratio. Assume the existence of a risk free asset with return $r_f$. The optimization problem then reads
       </p>
       $$
\mathbf{w}^* = \underset{\mathbf{w}}{\text{arg max }} \frac{\mathbf{w}^\top \boldsymbol{\mu} - r_f}{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = \frac{\mu_p - r_f}{\sigma_p}
$$
       <p>
        subject to the budget constraint $\mathbf{w}^\top \mathbf{1} = 1$. After setting up the Lagrangian and a lot of tedious calculations, then it is possible to show that the solution to the above problem is given by
       </p>
       $$
\mathbf{w}^* = \frac{\boldsymbol{\Sigma}^{-1}(\boldsymbol{\mu} - r_f \mathbf{1})}{\mathbf{1}^\top \boldsymbol{\Sigma}^{-1}(\boldsymbol{\mu} - r_f \mathbf{1})}
$$
       <h3 id="Example:-Three-risky-assets">
        Example: Three risky assets
        <a class="anchor-link" href="#Example:-Three-risky-assets">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=regular-peace">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define relevant quantities</span>
<span class="sd">"""</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>


<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="n">rf</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># assume that the risk free rate is zero </span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">vols</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="c1"># constant Sharpe ratio</span>

<span class="c1"># transform to covariance matrix using previously defined function (imported at the top of the notebook)</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sixth-identification">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define functions used to calculate portfolios</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">minimum_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the minimum-variance portfolio weights. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cov_mat:</span>
<span class="sd">        The covariance matrix. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Minimum variance portfolio weights. </span>

<span class="sd">    """</span>
    
    <span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="n">vec_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
    
    <span class="n">cov_mat_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="n">w_min_var</span> <span class="o">=</span> <span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="n">vec_ones</span> <span class="o">/</span> <span class="p">(</span><span class="n">vec_ones</span> <span class="o">@</span> <span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="n">vec_ones</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">w_min_var</span>


<span class="k">def</span> <span class="nf">tangency_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">rf</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the maximum sharpe ratio portfolio weights.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    cov_mat:</span>
<span class="sd">        The covariance matrix.</span>
<span class="sd">    mu: </span>
<span class="sd">        Expected return vector. </span>
<span class="sd">    rf: </span>
<span class="sd">        The risk free rate. </span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        maximum sharpe ratio portfolio weights.</span>

<span class="sd">    """</span>
    
    <span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="n">vec_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

    <span class="n">excess_mu</span> <span class="o">=</span> <span class="n">mu</span> <span class="o">-</span> <span class="n">vec_ones</span> <span class="o">*</span> <span class="n">rf</span>

    <span class="n">cov_mat_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="n">w_max_sr</span> <span class="o">=</span> <span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="n">excess_mu</span> <span class="o">/</span> <span class="p">(</span><span class="n">vec_ones</span> <span class="o">@</span> <span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="n">excess_mu</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">w_max_sr</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=complimentary-hayes">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># minimum variance portfolio </span>
<span class="n">w_mv</span> <span class="o">=</span> <span class="n">minimum_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">=</span><span class="n">cov_mat</span><span class="p">)</span>

<span class="n">mu_mv</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">w_mv</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_mv</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_mv</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="c1"># tangency portfolio </span>
<span class="n">w_max_sr</span> <span class="o">=</span> <span class="n">tangency_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">=</span><span class="n">cov_mat</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">rf</span><span class="p">)</span>

<span class="n">mu_max_sr</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_max_sr</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="c1"># efficient portfolios</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">w_eff</span> <span class="o">=</span> <span class="n">w_mv</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">w_max_sr</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>

<span class="n">std_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">portfolio_std</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w_eff</span><span class="p">,</span> <span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>
<span class="n">mu_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">portfolio_mean</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w_eff</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=wired-today">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot the efficient frontier</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_eff</span><span class="p">,</span> <span class="n">mu_eff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Efficient frontier"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std_max_sr</span><span class="p">],</span> <span class="p">[</span><span class="n">rf</span><span class="p">,</span> <span class="n">mu_max_sr</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">std_mv</span><span class="p">,</span> <span class="n">mu_mv</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum variance port. "</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">std_max_sr</span><span class="p">,</span> <span class="n">mu_max_sr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"green"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Maximum Sharpe port. "</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"cyan"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Risk free rate"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Assets"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Efficient Frontier"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"$\sigma_p$ (standard deviation)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$\mu_p$ (expected return)"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=64181a50-026b-4689-9ced-d6b833b12aa7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Equal-risk-contribution">
        Equal risk contribution
        <a class="anchor-link" href="#Equal-risk-contribution">
         ¶
        </a>
       </h3>
       <p>
        In the week 4, we talked about risk contribution. We showed that we could write the portfolio standard deviation as
       </p>
       $$
\sigma_p(\mathbf{w}) = \mathbf{w}^\top \frac{\boldsymbol{\Sigma} \mathbf{w} }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = \sum_{i=1}^N w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = \sum_{i=1}^N w_i \text{MR}_i = \sum_{i=1}^N \text{RC}_i
$$
       <p>
        where $\text{MR}_i = \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}$ is the marginal risk of asset $i$ and $\text{RC}_i$ is the risk contribution of asset $i$.
       </p>
       <p>
        There is a large literature on
        <em>
         risk parity investing
        </em>
        where the focus is on allocating risk instead of capital, e.g. we want an equal amount of risk coming from bonds and stocks. The problem that we want to solve is
       </p>
       $$
w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = b_i  \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}
$$
       <p>
        where $b_i$ is the risk coming from the $i$'th asset. In addition, we would likely impose positivity contraints $b_i \geq 0, w_i \geq 0$, weights summing to one $\sum_{i=1}^N w_i = 1$, and $\sum_{i=1}^N b_i = 1$.
       </p>
       <p>
        Generally, we need numerical methods for solving the problem when dealing with more than two assets. The most direct approach is to solve the minimization problem
       </p>
       $$
\mathbf{w}^* = \underset{\mathbf{w}}{\text{arg min }} \sum_{i=1}^N \left( w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}  - b_i \right)^2
$$
       <p>
        subject to the budget constraint and a no-shorting constraint
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
w_i &amp;amp;\geq 0 \text{ for } i \in \{1, ..., N\}
\end{align}
$$
       <p>
        which can easily be minimized using
        <code>
         scipy.minimize
        </code>
        . The equal risk contribution portfolio is obtained by setting $b_i  = 1 / N$ for all $i \in \{1, .., N\}$.
       </p>
       <p>
        It is possible to reformulate the problem such that it becomes a convex optimization problem.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ab0ce1d0-233d-40b4-a36c-40d771324a52">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Two-asset-risk-parity-portfolio">
        Two-asset risk parity portfolio
        <a class="anchor-link" href="#Two-asset-risk-parity-portfolio">
         ¶
        </a>
       </h3>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2009778">
         Bruder and Roncalli (2012), "Managing Risk Exposures using
the Risk Budgeting Approach"
        </a>
        present an exact solution for the two asset case
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sweet-farming">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">weights_risk_budget_two_assets</span><span class="p">(</span><span class="n">sigma1</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">rho</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">b</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates the portfolio weights that result in equal risk contribution. Two asset case.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma1:</span>
<span class="sd">        Std. of asset 1</span>
<span class="sd">    sigma2:</span>
<span class="sd">        Std. of asset 2</span>
<span class="sd">    rho:</span>
<span class="sd">        Correlation between asset 1 and asset 2</span>
<span class="sd">    b:</span>
<span class="sd">        Risk contribution from asset 1</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">       Optimal weights.</span>

<span class="sd">    """</span>

    <span class="n">num</span> <span class="o">=</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sigma1</span> <span class="o">*</span> <span class="n">sigma2</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">sigma2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">sigma1</span> <span class="o">*</span> <span class="n">sigma2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span>
        <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">b</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b</span><span class="p">))</span>
    <span class="n">den</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma1</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">-</span> <span class="n">b</span> <span class="o">*</span> <span class="n">sigma2</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="n">rho</span> <span class="o">*</span> <span class="n">sigma1</span> <span class="o">*</span> <span class="n">sigma2</span>

    <span class="n">w_opt</span> <span class="o">=</span> <span class="n">num</span> <span class="o">/</span> <span class="n">den</span>

    <span class="k">return</span> <span class="n">w_opt</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">w_opt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=lined-architecture">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Comparing-the-portfolios:-The-two-asset-case">
        Comparing the portfolios: The two asset case
        <a class="anchor-link" href="#Comparing-the-portfolios:-The-two-asset-case">
         ¶
        </a>
       </h3>
       <p>
        Consider a two asset example with stocks (S) and bonds (B). Stocks are defined by $\mu_S = 0.025, \sigma_S = 0.15$ and bonds are defined by $\mu_B = 0.01, \sigma_B = 0.075$. The correlation between stocks and bonds is $\rho _{S,B} = 0.2$.
       </p>
       <p>
        What is the diversification benefits with an equal allocation to stocks and bonds? What changes if we allocate towards an equal risk contribution?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=piano-divorce">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define the two asset universe</span>
<span class="sd">"""</span>
<span class="n">rf</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sigma1</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">sigma2</span> <span class="o">=</span> <span class="mf">0.075</span>
<span class="n">rho</span><span class="o">=</span><span class="mf">0.2</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">0.5</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">sigma1</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">])</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">rho</span><span class="p">],</span> <span class="p">[</span><span class="n">rho</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span><span class="o">*</span><span class="n">corr_mat</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.025</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>

<span class="sd">"""</span>
<span class="sd">Equal weigths vs. equal risk weights</span>
<span class="sd">"""</span>

<span class="c1"># equal weights</span>
<span class="n">eq_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

<span class="c1"># equal risk weigths </span>
<span class="n">eq_risk_weight</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">weights_risk_budget_two_assets</span><span class="p">(</span><span class="n">sigma1</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">rho</span><span class="p">,</span> <span class="n">b</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=separate-absence">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>

<span class="c1"># Pie chart, where the slices will be ordered and plotted counter-clockwise:</span>
<span class="n">labels</span> <span class="o">=</span> <span class="s1">'Stocks'</span><span class="p">,</span> <span class="s1">'Bonds'</span>
<span class="n">sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">]</span>

<span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">'</span><span class="si">%1.1f%%</span><span class="s1">'</span><span class="p">,</span>
        <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">textprops</span><span class="o">=</span><span class="p">{</span><span class="s1">'color'</span><span class="p">:</span> <span class="s1">'black'</span><span class="p">,</span> <span class="s1">'size'</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'equal'</span><span class="p">);</span>  <span class="c1"># Equal aspect ratio ensures that pie is drawn as a circle.</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Equally weighted portfolio"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=123d05b0">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">eq_weight</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">waterfall_chart</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">risk_contrib</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">"Stocks"</span><span class="p">,</span> <span class="s2">"Bonds"</span><span class="p">],</span>
                          <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span>
                          <span class="n">total_label</span><span class="o">=</span><span class="s2">"Total risk (std)"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Risk contribution (std)"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Risk contribution - Equal weights"</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=incredible-monitor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sizes</span> <span class="o">=</span> <span class="n">eq_risk_weight</span><span class="o">*</span><span class="mi">100</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">6</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">pie</span><span class="p">(</span><span class="n">sizes</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">autopct</span><span class="o">=</span><span class="s1">'</span><span class="si">%1.1f%%</span><span class="s1">'</span><span class="p">,</span>
        <span class="n">shadow</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">startangle</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">textprops</span><span class="o">=</span><span class="p">{</span><span class="s1">'color'</span><span class="p">:</span> <span class="s1">'black'</span><span class="p">,</span> <span class="s1">'size'</span><span class="p">:</span> <span class="mi">15</span><span class="p">})</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">'equal'</span><span class="p">)</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Equal risk contribution portfolio"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=00af37fb">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_contrib_eq_risk</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">waterfall_chart</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">risk_contrib_eq_risk</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">"Stocks"</span><span class="p">,</span> <span class="s2">"Bonds"</span><span class="p">],</span>
                          <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span>
                          <span class="n">total_label</span><span class="o">=</span><span class="s2">"Total risk (std)"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Risk contribution (std)"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Risk contribution - Equal risk weights"</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=artificial-construction">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># minimum variance portfolio </span>
<span class="n">w_mv</span> <span class="o">=</span> <span class="n">minimum_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">=</span><span class="n">cov_mat</span><span class="p">)</span>

<span class="n">mu_mv</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">w_mv</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_mv</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_mv</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">mr_mv</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_std</span><span class="p">(</span><span class="n">w_mv</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">m_sharpe_mv</span> <span class="o">=</span> <span class="n">calculate_marginal_sharpe</span><span class="p">(</span><span class="n">w_mv</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">rf</span><span class="p">)</span>

<span class="c1"># tangency portfolio </span>
<span class="n">w_max_sr</span> <span class="o">=</span> <span class="n">tangency_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">=</span><span class="n">cov_mat</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">rf</span><span class="p">)</span>

<span class="n">mu_max_sr</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_max_sr</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">mr_max_sr</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_std</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">m_sharpe_max_sr</span> <span class="o">=</span> <span class="n">calculate_marginal_sharpe</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">rf</span><span class="p">)</span>

<span class="c1"># equal weight port. </span>
<span class="n">mu_eq</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">eq_weight</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_eq</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">eq_weight</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">mr_eq</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_std</span><span class="p">(</span><span class="n">eq_weight</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">m_sharpe_eq</span> <span class="o">=</span> <span class="n">calculate_marginal_sharpe</span><span class="p">(</span><span class="n">eq_weight</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">rf</span><span class="p">)</span>


<span class="c1"># equal risk contrib. port</span>
<span class="n">mu_eq_risk</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_eq_risk</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">mr_eq_risk</span> <span class="o">=</span> <span class="n">calculate_marginal_risks_std</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">m_sharpe_eq_risk</span> <span class="o">=</span> <span class="n">calculate_marginal_sharpe</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">rf</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=increased-matrix">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">w_to_apply</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">w_to_apply</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">w_to_apply</span><span class="p">,</span> <span class="mi">1</span><span class="o">-</span><span class="n">w_to_apply</span><span class="p">]</span><span class="o">.</span><span class="n">T</span>

<span class="sd">"""</span>
<span class="sd">The minimum variance portfolio ensures equal marginal risk </span>
<span class="sd">"""</span>

<span class="n">mr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">calculate_marginal_risks_std</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w_to_apply</span><span class="p">,</span> <span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_to_apply</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mr</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Stocks"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_to_apply</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">mr</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Bonds"</span><span class="p">)</span>

<span class="c1"># minimum variance</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">w_mv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mr_mv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum variance portfolio"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"green"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># tangency portfolio</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mr_max_sr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Max. Sharpe portfolio (stocks)"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"black"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mr_max_sr</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Max. Sharpe portfolio (bonds)"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"gray"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># equal risk budget</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mr_eq_risk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equal risk portfolio (stocks)"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"red"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mr_eq_risk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equal risk portfolio (bonds)"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>


<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">'both'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">'major'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Marginal risk"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Allocation to stocks'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Marginal risk'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=indirect-consumption">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">The tangency portfolio ensures equal marginal Sharpe ratio</span>
<span class="sd">"""</span>

<span class="n">m_sharpe</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">calculate_marginal_sharpe</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w_to_apply</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">rf</span><span class="p">)</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_to_apply</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">m_sharpe</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Stocks"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">w_to_apply</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:],</span> <span class="n">m_sharpe</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Bonds"</span><span class="p">)</span>

<span class="c1"># minimum variance</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">w_mv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m_sharpe_mv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum variance portfolio (stocks)"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"green"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">w_mv</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m_sharpe_mv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum variance portfolio (bonds)"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"orange"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># tangency portfolio</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m_sharpe_max_sr</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Max. Sharpe portfolio"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"black"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># equal risk budget</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m_sharpe_eq_risk</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equal risk portfolio (stocks)"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"red"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">eq_risk_weight</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">m_sharpe_eq_risk</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equal risk portfolio (bonds)"</span><span class="p">,</span>
            <span class="n">color</span><span class="o">=</span> <span class="s2">"blue"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>


<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="s1">'both'</span><span class="p">,</span> <span class="n">which</span><span class="o">=</span><span class="s1">'major'</span><span class="p">,</span> <span class="n">labelsize</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Marginal Sharpe ratio"</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Allocation to stocks'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Marginal Sharpe ratio [$E[R - r_f]/mRisk$]'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">fontsize</span><span class="o">=</span><span class="mi">15</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=excess-legislation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Inequality-constraints">
        Inequality constraints
        <a class="anchor-link" href="#Inequality-constraints">
         ¶
        </a>
       </h3>
       <p>
        Above, we have only looked at problems with an analytical solution. In other cases, we do not have an analytical solution why we need apply numerical methods to solve the optimization problem.
       </p>
       <p>
        If we add a no short selling constraint, the mean-variance problem can be written as:
       </p>
       $$
\underset{\mathbf{w}}{\text{arg min }} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to the budget constraint, a return target and positivity constriants
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
\mathbf{w}^\top \boldsymbol{\mu} &amp;amp;= \bar{\mu}_p \\
w_i &amp;amp;\geq 0, \; i=1,..., N
\end{align}
$$
       <p>
        There is no analytical solution to this problem, but we can easily solve it using
        <code>
         scipy.optimize.minimize
        </code>
        (or
        <code>
         CVXPY
        </code>
        /
        <code>
         CVXOPT
        </code>
        ).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=explicit-yellow">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define relevant quantities</span>
<span class="sd">"""</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>


<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="n">rf</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># assume that the risk free rate is zero </span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">vols</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="c1"># constant Sharpe ratio</span>

<span class="c1"># transform to covariance matrix using previously defined function (imported at the top of the notebook)</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=biological-december">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> 
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                 <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="c1"># define constraint </span>
<span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
               <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">0.025</span><span class="p">,</span>
               <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu</span><span class="p">}</span>

<span class="n">port_var_der</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span>


<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,),</span>
                        <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                        <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">no_short_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>

<span class="n">w_opt</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=fundamental-material">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Repeat calculations</span>
<span class="sd">"""</span>

<span class="c1"># minimum variance portfolio </span>
<span class="n">w_mv</span> <span class="o">=</span> <span class="n">minimum_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">=</span><span class="n">cov_mat</span><span class="p">)</span>

<span class="n">mu_mv</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">w_mv</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_mv</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_mv</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="c1"># tangency portfolio </span>
<span class="n">w_max_sr</span> <span class="o">=</span> <span class="n">tangency_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="o">=</span><span class="n">cov_mat</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">rf</span><span class="p">)</span>

<span class="n">mu_max_sr</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_max_sr</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_max_sr</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="c1"># opt port with no shorting</span>
<span class="n">mu_no_short</span> <span class="o">=</span> <span class="n">portfolio_mean</span><span class="p">(</span><span class="n">w_opt</span><span class="p">,</span> <span class="n">mu</span><span class="p">)</span>
<span class="n">std_no_short</span> <span class="o">=</span> <span class="n">portfolio_std</span><span class="p">(</span><span class="n">w_opt</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="c1"># efficient portfolios</span>
<span class="n">alpha</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">w_eff</span> <span class="o">=</span> <span class="n">w_mv</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span> <span class="o">+</span> <span class="n">w_max_sr</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:])</span>

<span class="n">std_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">portfolio_std</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w_eff</span><span class="p">,</span> <span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>
<span class="n">mu_eff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">portfolio_mean</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">w_eff</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=expected-webmaster">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Plot the efficient frontier</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">std_eff</span><span class="p">,</span> <span class="n">mu_eff</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Efficient frontier"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">std_max_sr</span><span class="p">],</span> <span class="p">[</span><span class="n">rf</span><span class="p">,</span> <span class="n">mu_max_sr</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">std_mv</span><span class="p">,</span> <span class="n">mu_mv</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum variance port. "</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">std_max_sr</span><span class="p">,</span> <span class="n">mu_max_sr</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"green"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Maximum Sharpe port. "</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">std_no_short</span><span class="p">,</span> <span class="n">mu_no_short</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Optimal port. with no shorting"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">rf</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"cyan"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Risk free rate"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Assets"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Efficient Frontier"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"$\sigma_p$ (standard deviation)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"$\mu_p$ (expected return)"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=palestinian-forth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="The-instability-problem">
        The instability problem
        <a class="anchor-link" href="#The-instability-problem">
         ¶
        </a>
       </h2>
       <p>
        The optimal solution for the simplest case with no constraint is (see above)
       </p>
       $$
\mathbf{w}^* = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu} 
$$
       <p>
        The derivative of the optimal portfolio weights wrt. the expected return vector is given by
       </p>
       $$
\frac{\partial \mathbf{w}^*}{\partial \boldsymbol{\mu}} = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1}
$$
       <p>
        We see that the derivative is related to $\lambda$ (that will be related to the risk aversion) and it depends directly on the inverse of the covariance matrix $\boldsymbol{\Sigma}^{-1}$. Since the covariance matrix of returns are given by correlations multiplied with volatilities, the entries of the covariance matrix will be "small" numbers while the entries of the inverse will be "large" numbers. This implies that the sensitivity to changes in the expected returns will be large. Estimation error in the expected returns may be very problematic.
       </p>
       <p>
        However, estimation error in expected returns is not the only culprit. From
        <a href="https://www.amazon.com/Portfolio-Management-under-Stress-Bayesian-Net/dp/1107048117">
         Riccardo Rebonato and Alexander Denev, "Portfolio Management under stress"
        </a>
       </p>
       <ul>
        <li>
         The impact of the estimation errors of the covariance matrix can be of the same magnitude as the impact of the estimation error of the mean
        </li>
        <li>
         The precision of the optimal portfolio weights estimator computed with the true mean depends on the ratio of the variances and covariances of assets rather than the absolute values
        </li>
        <li>
         The stability of optimal portfolio weights computed with the estimated mean deteriorates with the decrease of the eigenvalues of the covariance matrix
        </li>
       </ul>
       <p>
        The last point echoes the discussion from last week. If the asset universe can be described by a limited number of factor, then a large number of the eigenvalues will be small increasing the instability problem of classical mean-variance optimization.
       </p>
       <h3 id="Example">
        Example
        <a class="anchor-link" href="#Example">
         ¶
        </a>
       </h3>
       <p>
        This example is adapted from
        <a href="https://link.springer.com/book/10.1007/978-3-319-32796-9">
         Ignazio Basile and Pierpaolo Ferrari (2016), "Asset Management and Institutional Investors"
        </a>
        .
       </p>
       <p>
        Below we see an example of how small changes in the expected return can change the asset allocation along the efficient frontier!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=agreed-profit">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">mu_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.12</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">8.2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">mu_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.22</span><span class="p">,</span> <span class="mf">8.4</span><span class="p">,</span> <span class="mf">8.2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=vocal-limitation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">minimum_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=center-harvest">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> 
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                 <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="n">port_var_der</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span>


<span class="n">target_returns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.035</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mi">25</span><span class="p">)</span>

<span class="n">optimal_port_weights_1</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">optimal_port_weights_2</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu_1</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_1</span><span class="p">)</span>

<span class="k">for</span> <span class="n">target_return</span> <span class="ow">in</span> <span class="n">target_returns</span><span class="p">:</span> 
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_1</span> <span class="o">-</span> <span class="n">target_return</span><span class="p">,</span>
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_1</span><span class="p">}</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                            <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">no_short_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>

    <span class="n">optimal_port_weights_1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_2</span> <span class="o">-</span> <span class="n">target_return</span><span class="p">,</span>
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_2</span><span class="p">}</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                            <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">no_short_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>

    <span class="n">optimal_port_weights_2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    

<span class="n">optimal_port_weights_1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">optimal_port_weights_1</span><span class="p">)</span>
<span class="n">optimal_port_weights_2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">optimal_port_weights_2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=boxed-clinic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">target_returns</span><span class="p">,</span> <span class="n">optimal_port_weights_1</span><span class="o">.</span><span class="n">T</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights for $\mu_1$"</span><span class="p">)</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">target_returns</span><span class="p">,</span> <span class="n">optimal_port_weights_2</span><span class="o">.</span><span class="n">T</span><span class="p">);</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return"</span><span class="p">)</span>
<span class="c1">#ax[1].set_ylabel("Portfolio weights")</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights for $\mu_2$"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=statutory-banks">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="A-primer-to-solving-the-instability-problem">
        A primer to solving the instability problem
        <a class="anchor-link" href="#A-primer-to-solving-the-instability-problem">
         ¶
        </a>
       </h2>
       <p>
        The above Markowitz approach does not take estimation error into account thereby treating the input parameters as the only truth. The sensitivity of the solutions to the above problems would not be a problem is we knew with 100% certainty the input parameters. However, as we have seen previously in the course, estimation errors exist and may be very large. This resulted in the Markowitz approach being labelled as an "error maximizer". We want to explore potential solutions to the instability issue.
       </p>
       <h3 id="Shrinkage-of-the-input-parameters">
        Shrinkage of the input parameters
        <a class="anchor-link" href="#Shrinkage-of-the-input-parameters">
         ¶
        </a>
       </h3>
       <p>
        As we have previously learned it will be possible to reduce the estimation error of the input parameters by applying different shrinkage estimators.
       </p>
       <h3 id="Shrinkage-of-the-portfolios-weights">
        Shrinkage of the portfolios weights
        <a class="anchor-link" href="#Shrinkage-of-the-portfolios-weights">
         ¶
        </a>
       </h3>
       <p>
        It is often found that the naive $1 / N$ rule outperforms the outperform the (naive) Markowitz approach in empirical analysis (in particular in pure equity universe). We can think set of fixed portfolio weights as an estimate of the optimal weights with zero variance but with bias (in mean-variance sence).  By shrinking mean-variance weights towards a set of fixed weights (the naive $1 / N$ rule) we may improve the empirical performance. This is the idea of the combination rule of
        <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304405X10001893">
         Tu and Zhou (2011), "Markowitz meets Talmud: A combination of sophisticated and naive diversification strategies"
        </a>
        .
       </p>
       <h3 id="Portfolio-constraints">
        Portfolio constraints
        <a class="anchor-link" href="#Portfolio-constraints">
         ¶
        </a>
       </h3>
       <p>
        <a href="https://www.jstor.org/stable/3648224">
         Jagannathan and Ma (2003)
        </a>
        provide evidence for shrinkage type effects of adding weight constraints.
       </p>
       <p>
        <strong>
         Example
        </strong>
       </p>
       <p>
        <em>
         Suggestion: Try to implement the below example using CVXOPT or CVXPY
        </em>
       </p>
       <p>
        Define the correlation, volatilties, expected returns as below. Assume for simplicity that returns are normally distributed.
       </p>
       <p>
        Assume that we have a return target of 5%. Find the true optimal weights.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=boring-narrative">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">True input parameters</span>
<span class="sd">"""</span>

<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.22</span><span class="p">,</span> <span class="mf">8.4</span><span class="p">,</span> <span class="mf">8.2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">rf</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">True optimal portfolio weights </span>
<span class="sd">"""</span>

<span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> 
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                 <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>

<span class="c1"># define constraint </span>
<span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
               <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">-</span> <span class="mf">0.05</span><span class="p">,</span>
               <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu</span><span class="p">}</span>

<span class="n">port_var_der</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span>


<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,),</span>
                        <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                        <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                        <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">no_short_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                        <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>

<span class="n">w_opt</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>

<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=acute-replication">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Simulate 100 observations from a multivariate normal distribution. Estimate the covariance matrix and mean vector. Calculate the optimal portfolio weights. Repeat this 1000 times. Plot box plot with the optimal portfolio weights.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=textile-supplier">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># %%time</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">num_obs</span> <span class="o">=</span> <span class="mi">100</span>
<span class="c1"># Note: We could have simulated the covariance matrix directly using the Wishart distribution given the normal assumption</span>
<span class="c1"># The below approach can be used for arbitrary distribution</span>
<span class="n">sim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">))</span> 

<span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># num_sim x 4 </span>

<span class="n">opt_port_weights</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span>
    
    <span class="n">cov_mat_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.05</span><span class="p">,</span>
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_est</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>

    <span class="n">port_var_der</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">cov_mat_est</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat_est</span>


    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                            <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">no_short_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>
    
    <span class="n">opt_port_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    
    
<span class="n">opt_port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_port_weights</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=quantitative-camping">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">opt_port_weights</span><span class="p">);</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">"Asset </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">w_opt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True weights"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Distribution of portfolio weights"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=automotive-application">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Repeat the calculations when weights are constrained between 0.15 and 0.45.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sustainable-pixel">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">opt_port_weights_constraints</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span>
    
    <span class="n">cov_mat_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.05</span><span class="p">,</span>
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_est</span><span class="p">[</span><span class="n">i</span><span class="p">]}</span>

    <span class="n">port_var_der</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">,</span> <span class="n">cov_mat_est</span><span class="p">:</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat_est</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                            <span class="n">jac</span><span class="o">=</span><span class="n">port_var_der</span><span class="p">,</span>
                            <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>
    
    <span class="n">opt_port_weights_constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    
    
<span class="n">opt_port_weights_constraints</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_port_weights_constraints</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=occupational-learning">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">opt_port_weights_constraints</span><span class="p">);</span> 

<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="s2">"Asset </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">)])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">w_opt</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"True weights"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Distribution of portfolio weights"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=indirect-contact">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Simulate new data. Apply the constrained and unconstrained portfolio weights. How do they perform "out-of-sample"?
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=upper-farming">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sim_data_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">))</span>

<span class="c1"># calculate portfolio returns</span>
<span class="n">return_unconstrained</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim_data_new</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">opt_port_weights</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">return_constrained</span> <span class="o">=</span> <span class="p">(</span><span class="n">sim_data_new</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">opt_port_weights_constraints</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:])</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=communist-milwaukee">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">return_unconstrained</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unconstrained"</span><span class="p">);</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">return_constrained</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Constrained"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">35</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Realized return"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=modern-tooth">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">return_unconstrained</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">return_unconstrained</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unconstrained"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">return_constrained</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">return_unconstrained</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Constrained"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Realized Sharpe ratio"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=packed-moses">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="The-resampling-approach">
        The resampling approach
        <a class="anchor-link" href="#The-resampling-approach">
         ¶
        </a>
       </h3>
       <p>
        <a href="https://www.jstor.org/stable/4479185">
         Michaud (1989)
        </a>
        introduced a common approach to "solving" the instability problem known as
        <em>
         resampling
        </em>
        .
       </p>
       <p>
        We present a brief describtion of the method (alternative implementations exist). Assume that we have estimated $\boldsymbol{\Sigma}$ and $\boldsymbol{\mu}$ using  $T$ historical return observations, say $\hat{\boldsymbol{\Sigma}}$ and $\hat{\boldsymbol{\mu}}$.
       </p>
       <ol>
        <li>
         <p>
          Calculate $M$ efficient portfolios for $M$ different return targets. The return targets span the interval from the return on the minimum-variance portfolio and the maximum return portfolio. Rank the portfolio $m=1, ..., M$.
         </p>
        </li>
        <li>
         <p>
          Resample (simulate) a new data set of lenght $L$ (generally equal to $T$) from a multivariate normal distribution with mean and covariance given by respectively $\hat{\boldsymbol{\mu}}$ and $\hat{\boldsymbol{\Sigma}}$.
         </p>
        </li>
        <li>
         <p>
          Re-estimate the mean and covariance, say $\hat{\boldsymbol{\Sigma}}_{1}$ and $\hat{\boldsymbol{\mu}}_{1}$.
         </p>
        </li>
        <li>
         <p>
          Use the new mean and covariance to determine $M$ efficient portfolios with the same $M$ returns targets as in step 1, label the weights $\mathbf{w}_m^1$
         </p>
        </li>
        <li>
         <p>
          Reiterate step 1 to 4 a large number of times, say $H$.
         </p>
        </li>
        <li>
         <p>
          Finally, we can average over the $H$ simulations to obtain the "resampled" weights
         </p>
        </li>
       </ol>
       $$
\mathbf{w}_{m} = \frac{1}{H} \sum_{h=1}^H \mathbf{w}_m^h
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a00be7dd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Industry portfolios
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=coastal-donna">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">pandas_datareader.data</span> <span class="kn">import</span> <span class="n">DataReader</span>
<span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>


<span class="n">reader</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s2">"12_Industry_Portfolios"</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="mi">1999</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">industry_port</span> <span class="o">=</span> <span class="n">reader</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="c1"># print description</span>
<span class="n">industry_port</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=guided-romance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get equally weighted</span>
<span class="n">ind_eq_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

<span class="c1"># get market cap weighted </span>
<span class="n">ind_mc_weighted</span> <span class="o">=</span> <span class="n">industry_port</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span>

<span class="c1"># asset list</span>
<span class="n">asset_list</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">columns</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=upper-narrow">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Last 10Y of data</span>
<span class="sd">"""</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">ind_mc_weighted</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="o">-</span><span class="mi">120</span><span class="p">:]</span>

<span class="sd">"""</span>
<span class="sd">Estimate mean and covariance</span>
<span class="sd">"""</span>

<span class="n">cov_mat_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Define mu targts</span>
<span class="sd">"""</span>

<span class="n">weight_mv</span> <span class="o">=</span> <span class="n">minimum_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">)</span>
<span class="n">mu_targets</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">weight_mv</span> <span class="o">@</span> <span class="n">mu_est</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mu_est</span><span class="p">),</span> <span class="mi">10</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=hidden-collective">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Estimate original efficient frontier </span>
<span class="sd">"""</span>

<span class="c1"># define common constraints </span>
<span class="n">sum_to_one_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">,</span> 
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">)}</span>

<span class="n">no_short_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
                 <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">,</span>
                 <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">))}</span>

<span class="c1"># alternatively use </span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="c1">#port_var_der = lambda w, cov_mat_est: 2 * w @ cov_mat_est</span>
<span class="n">optimal_port_weights</span> <span class="o">=</span> <span class="p">[]</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_est</span><span class="p">)</span>
<span class="k">for</span> <span class="n">target_return</span> <span class="ow">in</span> <span class="n">mu_targets</span><span class="p">:</span> 
    
    <span class="c1"># define constraint </span>
    <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                   <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est</span> <span class="o">-</span> <span class="n">target_return</span><span class="p">,</span>
                   <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_est</span><span class="p">}</span>
    
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat_est</span><span class="p">,),</span>
                            <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                            <span class="c1">#jac=port_var_der,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">no_short_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                            <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>
    
    <span class="n">optimal_port_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

<span class="n">optimal_port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">optimal_port_weights</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=offshore-macedonia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">,</span> <span class="n">optimal_port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return (monthly)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=heated-amazon">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">%%time</span>
<span class="n">optimal_port_resampled_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">),</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">500</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span>
    
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu_est</span><span class="p">,</span> <span class="n">cov_mat_est</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
    
    <span class="n">mu_est_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cov_mat_est_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">opt_port_w_sim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">target_return</span> <span class="ow">in</span> <span class="n">mu_targets</span><span class="p">:</span> 

        <span class="c1"># define constraint </span>
        <span class="n">target_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
                       <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">@</span> <span class="n">mu_est_sim</span> <span class="o">-</span> <span class="n">target_return</span><span class="p">,</span>
                       <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">mu_est_sim</span><span class="p">}</span>

        <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">x0</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat_est_sim</span><span class="p">,),</span>
                                <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span>
                                <span class="c1">#jac=port_var_der,</span>
                                <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">sum_to_one_cons</span><span class="p">,</span> <span class="n">no_short_cons</span><span class="p">,</span>  <span class="n">target_cons</span><span class="p">],</span>  <span class="c1"># no_short_cons,</span>
                                <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">False</span><span class="p">})</span> <span class="c1">#, bounds=bounds)</span>

        <span class="n">opt_port_w_sim</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>

    <span class="n">optimal_port_resampled_weights</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_port_w_sim</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_sim</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=southwest-entrance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">,</span> <span class="n">optimal_port_resampled_weights</span><span class="o">.</span><span class="n">T</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return (monthly)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights (Resampling)"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=specified-relationship">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The method definitely results in more diversified portfolios!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=05d0a7a5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Implementation using CVXPY
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=5efb6389">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_mvo_portfolio</span><span class="p">(</span><span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">target_mu</span><span class="p">:</span> <span class="nb">float</span><span class="p">):</span> 
        
    <span class="c1"># define target variable</span>
    <span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
    
    <span class="c1"># define constraints</span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">w</span><span class="o">&amp;gt;=</span><span class="mi">0</span><span class="p">,</span> <span class="n">w</span><span class="nd">@mu</span> <span class="o">==</span> <span class="n">target_mu</span><span class="p">]</span>
    
    <span class="c1"># define problem </span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)),</span> <span class="n">constraints</span><span class="p">)</span>
    
    <span class="c1"># solve</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">prob</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">'optimal'</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span>
    <span class="k">else</span><span class="p">:</span>    
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c0b53b15">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">%%time</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">500</span>
<span class="n">optimal_port_resampled_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">num_sim</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">),</span> <span class="mi">12</span><span class="p">))</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span>
    
    <span class="n">sim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu_est</span><span class="p">,</span> <span class="n">cov_mat_est</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">120</span><span class="p">)</span>
    
    <span class="n">mu_est_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">cov_mat_est_sim</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    
    <span class="n">opt_port_w_sim</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">j</span><span class="p">,</span> <span class="n">target_return</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">):</span> 
        <span class="n">w_opt</span> <span class="o">=</span> <span class="n">calculate_mvo_portfolio</span><span class="p">(</span><span class="n">mu_est_sim</span><span class="p">,</span> <span class="n">cov_mat_est_sim</span><span class="p">,</span> <span class="n">target_mu</span><span class="o">=</span><span class="n">target_return</span><span class="p">)</span>
        <span class="n">optimal_port_resampled_weights</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">w_opt</span>

<span class="n">avg_optimal_port_resampled_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">optimal_port_resampled_weights</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b17818a9">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">mu_targets</span><span class="p">,</span> <span class="n">avg_optimal_port_resampled_weights</span><span class="o">.</span><span class="n">T</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">xaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_major_formatter</span><span class="p">(</span><span class="n">ticker</span><span class="o">.</span><span class="n">PercentFormatter</span><span class="p">(</span><span class="n">xmax</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Target return (monthly)"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Portfolio weights"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Optimal weights (Resampling)"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.jstor.org/stable/4479185">
         Michaud (1989), "The Markowitz Optimization Enigma: Is 'Optimized' Optimal?"
        </a>
       </p>
       <p>
        <a href="https://www.sciencedirect.com/science/article/pii/S0047259X03000964">
         Ledoit and Wolf (2004), "A well-conditioned estimator for large-dimensional covariance matrices"
        </a>
       </p>
       <p>
        <a href="https://www.jstor.org/stable/3648224">
         Jagannathan and Ma (2003), "Risk Reduction in Large Portfolios: Why Imposing the Wrong Constraints Helps"
        </a>
       </p>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2009778">
         Bruder and Roncalli (2012), "Managing Risk Exposures using
the Risk Budgeting Approach"
        </a>
       </p>
       <p>
        <a href="https://www.sciencedirect.com/science/article/abs/pii/S0304405X10001893">
         Tu and Zhou (2011), "Markowitz meets Talmud: A combination of sophisticated and naive diversification strategies"
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.com/Portfolio-Management-under-Stress-Bayesian-Net/dp/1107048117">
         Riccardo Rebonato and Alexander Denev, "Portfolio Management under stress"
        </a>
       </p>
       <p>
        <a href="https://link.springer.com/book/10.1007/978-3-319-32796-9">
         Ignazio Basile and Pierpaolo Ferrari (2016), "Asset Management and Institutional Investors"
        </a>
       </p>
       <p>
        <a href="https://www.amazon.com/Machine-Learning-Managers-Elements-Quantitative/dp/1108792898">
         Marcos M. Lopéz de Prado (2020), "Machine Learning for Asset Managers"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>


<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=blind-trauma">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Multivariate-statistics">
        Multivariate statistics
        <a class="anchor-link" href="#Multivariate-statistics">
         ¶
        </a>
       </h1>
       <p>
        In this Jupyter notebook, we will look at multivariate statistics. In particular, we will look at how we can use (primarily) the
        <code>
         scipy.stats
        </code>
        package (see docs
        <a href="https://docs.scipy.org/doc/scipy/reference/stats.html">
         here
        </a>
        ) to work with random variables, distributions, moments, etc.
       </p>
       <h2 id="Random-variables">
        Random variables
        <a class="anchor-link" href="#Random-variables">
         ¶
        </a>
       </h2>
       <p>
        The concept of a random variable generalizes to the multivariate context. A multivariate random variable or a random vector, $\mathbf{X} = (X_1, ... , X_n)^\top$, is a vector of scalar random variables such that $\mathbf{X}: \Omega \mapsto \mathbb{R}^n$.
       </p>
       <p>
        Similar to the case of univariate or scaler random variables, we can characterize the distribution of the random vector in different ways.
       </p>
       <h3 id="Probability-density-function">
        Probability density function
        <a class="anchor-link" href="#Probability-density-function">
         ¶
        </a>
       </h3>
       <p>
        If $\mathbf{X}: \Omega \to \mathbb{R}^n$ is a continuous random variable, then $f_{\mathbf{X}}$ is a
        <a href="https://en.wikipedia.org/wiki/Probability_density_function">
         probability density function
        </a>
        if
       </p>
       $$
f_{\mathbf{X}}({\mathbf{x}}) \geq \mathbf{0}
$$
       <p>
        and
       </p>
       $$
\intop_{\mathbf{R}^n} f_{\mathbf{X}}({\mathbf{x}})d\mathbf{x} = \intop_{-\infty}^\infty \ldots \intop_{-\infty}^\infty f_{\mathbf{X}}(x_1, ... ,x_n)dx_1 \ldots dx_n = 1
$$
       <p>
        <strong>
         Example: Normal distribution
        </strong>
       </p>
       <p>
        The density of a
        <a href="https://en.wikipedia.org/wiki/Multivariate_normal_distribution">
         multivariate normal distribution
        </a>
        is given by
       </p>
       $$
\begin{equation}
f_{\mathbf {X} }(x_{1},\ldots ,x_{n})={\frac {\exp \left(-{\frac {1}{2}}({\mathbf {x} }-{\boldsymbol {\mu }})^{\top }{\boldsymbol {\Sigma }}^{-1}({\mathbf {x} }-{\boldsymbol {\mu }})\right)}{\sqrt {(2\pi )^{n}|{\boldsymbol {\Sigma }}|}}}
\end{equation}
$$
       <p>
        where $\boldsymbol {\mu }$ is a vector of expected values and $\boldsymbol {\Sigma }$ is the covariance matrix.
       </p>
       <p>
        We can use the
        <code>
         multivariate_normal
        </code>
        class in
        <code>
         scipy.stats
        </code>
        to work with the multivariate normal distribution (note that
        <code>
         scipy.stats
        </code>
        is imported as
        <code>
         stats
        </code>
        ). See documentation
        <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.multivariate_normal.html#scipy.stats.multivariate_normal">
         here
        </a>
        .
       </p>
       <p>
        We consider the two bivariate models defined by respectively
       </p>
       $$
\boldsymbol{\mu} =\begin{bmatrix} 0.0 \\ 0.0 \end{bmatrix}, \; \; \boldsymbol{\Sigma} =\begin{bmatrix} 1.0 &amp;amp; 0.0\\ 0.0 &amp;amp; 1.0 \end{bmatrix}
$$
       <p>
        and
       </p>
       $$
\boldsymbol{\mu} =\begin{bmatrix} 0.0 \\ 0.0 \end{bmatrix}, \; \; \boldsymbol{\Sigma} =\begin{bmatrix} 1.0 &amp;amp; 0.75\\ 0.75 &amp;amp; 1.0 \end{bmatrix}
$$
       <p>
        We want to compare the pdfs of these specifications.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=capable-anthropology">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define input variables</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">sigma1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">sigma1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma1</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
<span class="n">sigma2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
<span class="n">sigma2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">sigma2</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.75</span>

<span class="c1"># define x values to evaluate the pdf at </span>
<span class="n">x1_values</span> <span class="o">=</span> <span class="n">x2_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">x1_values</span><span class="p">,</span> <span class="n">x2_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x1_values</span><span class="p">,</span> <span class="n">x2_values</span><span class="p">)</span>
<span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dstack</span><span class="p">((</span><span class="n">x1_values</span><span class="p">,</span> <span class="n">x2_values</span><span class="p">))</span>

<span class="c1"># evaluate the pdf</span>
<span class="n">pdf_mod1_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">sigma1</span><span class="p">)</span>
<span class="n">pdf_mod2_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">sigma2</span><span class="p">)</span>

<span class="c1"># plot the pdf</span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">12</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">)</span>

<span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x1_values</span><span class="p">,</span> <span class="n">x2_values</span><span class="p">,</span> <span class="n">pdf_mod1_values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'YlGnBu_r'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Densitity function with uncorrelated Normal variables'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x_1$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$x_2$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">'$f_{x_1, x_2}(x_1, x_2)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=about-chapter">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># plot the pdf, level curves</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x1_values</span><span class="p">,</span> <span class="n">x2_values</span><span class="p">,</span> <span class="n">pdf_mod1_values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'YlGnBu_r'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Densitity function with uncorrelated Normal variables'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x_1$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$x_2$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=structured-tsunami">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">)</span>

<span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x1_values</span><span class="p">,</span> <span class="n">x2_values</span><span class="p">,</span> <span class="n">pdf_mod2_values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'YlGnBu_r'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Densitity function with correlated Normal variables'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x_1$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$x_2$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">'$f_{x_1, x_2}(x_1, x_2)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=passive-relay">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># plot the pdf, level curves</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">contourf</span><span class="p">(</span><span class="n">x1_values</span><span class="p">,</span> <span class="n">x2_values</span><span class="p">,</span> <span class="n">pdf_mod2_values</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="s1">'YlGnBu_r'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Densitity function with uncorrelated Normal variables'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x_1$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$x_2$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=norwegian-mexican">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Cumulative-distribution-function">
        Cumulative distribution function
        <a class="anchor-link" href="#Cumulative-distribution-function">
         ¶
        </a>
       </h3>
       <p>
        The multivariate version of the cumulative distribution function,  $F_\mathbf{X}: \mathbf{R}
^n \mapsto [0, 1]$, is defined by
       </p>
       $$
F_\mathbf{X}(\mathbf{x}) =  \intop_{-\infty}^{x_1} \ldots \intop_{-\infty}^{x_n} f_{\mathbf{X}}(u_1, ... ,u_n)du_1 \ldots du_n =  P(X_1 \leq x_1, \ldots, X_n \leq x_n) 
$$
       <p>
        <strong>
         Example: Multivariate Normal distribution
        </strong>
       </p>
       <p>
        Consider the previous example. Calculate the probability that $X_1 &amp;lt; -1$ and $X_2 &amp;lt; -1$ for the two cases.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=suspended-gathering">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_limits</span> <span class="o">=</span>  <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># evaluate the cdfs</span>
<span class="n">cdf_mod1</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x_limits</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">sigma1</span><span class="p">)</span>
<span class="n">cdf_mod2</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x_limits</span><span class="p">,</span> <span class="n">mean</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov</span><span class="o">=</span><span class="n">sigma2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sound-patrick">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cdf_mod1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=royal-consistency">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">The probability is much larger since the variables are positively correlated</span>
<span class="sd">"""</span>

<span class="n">cdf_mod2</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=scenic-mattress">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Characteristic-function">
        Characteristic function
        <a class="anchor-link" href="#Characteristic-function">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Characteristic_function_(probability_theory)">
         characteristic function
        </a>
        is defined by the expectation
       </p>
       $$
\varphi_\mathbf{X}(\mathbf{t}) \equiv \text{E}\left[ e^{i \mathbf{t}^\top \mathbf{X}} \right]
$$
       <p>
        where $i = \sqrt{-1}$ is the
        <a href="https://en.wikipedia.org/wiki/Imaginary_unit">
         imaginary unit
        </a>
        . It can takes complex values such that $\varphi_\mathbf{X}: \mathbb{R}^n \to \mathbb{C}$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=overall-columbus">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Marginal-distribution-and-dependence">
        Marginal distribution and dependence
        <a class="anchor-link" href="#Marginal-distribution-and-dependence">
         ¶
        </a>
       </h2>
       <p>
        We may only be interested in a subset of the  variables in the $n$-dimensional random vector $\mathbf{X}$. Let $\mathbf{X}_A$ be $k$-dimensional and $\mathbf{X}_B$ be $(n-k)$-dimensional.
       </p>
       $$
\mathbf{X} = \begin{bmatrix} \mathbf{X}_A \\ \mathbf{X}_B \end{bmatrix}
$$
       <h3 id="Marginal-distribution">
        Marginal distribution
        <a class="anchor-link" href="#Marginal-distribution">
         ¶
        </a>
       </h3>
       <p>
        The marginal distribution of $\mathbf{X}_B$ is the distribution obtained by "disregarding" $\mathbf{X}_A$. Since $\mathbf{X}_A$ can take any value, we can obtain the cdf as
       </p>
       $$
F_{\mathbf{X}_B}(\mathbf{x}_B) =  \intop_{-\infty}^{\infty} \ldots \intop_{-\infty}^{\infty} \intop_{-\infty}^{x_{k+1}} \ldots \intop_{-\infty}^{x_n} f_{\mathbf{X}}(u_1, ... ,u_n)du_1 \ldots du_n =  P(X_1 &amp;lt; \infty, \ldots, X_k &amp;lt; \infty, X_{k+1} \leq x_{k+1} \ldots, X_n \leq x_n) 
$$
       <p>
        and the pdf is obtained by "integrating out" $\mathbf{x}_A$
       </p>
       $$
f_{\mathbf{X}_B}(\mathbf{x}_B) \equiv \intop_{\mathbf{R}^K} f_{\mathbf{X}}(\mathbf{x}_A, \mathbf{x}_B) d\mathbf{x}_A
$$
       <h3 id="Dependence">
        Dependence
        <a class="anchor-link" href="#Dependence">
         ¶
        </a>
       </h3>
       <p>
        The conditional density of $\mathbf{X}_B$ given $\mathbf{X}_A$ is defined by
       </p>
       $$
f_{\mathbf{X}_B \vert \mathbf{x}_A }(\mathbf{x}_B ) = \frac{f_{\mathbf{X}}(\mathbf{x}_A, \mathbf{x}_B)}{f_{\mathbf{X}_A}(\mathbf{x}_A)}
$$
       <p>
        $\mathbf{X}_B$ and $\mathbf{X}_A$ are
        <strong>
         independent
        </strong>
        if and only if
       </p>
       $$f_{\mathbf{X}}(\mathbf{x}_A, \mathbf{x}_B) = f_{\mathbf{X}_A}(\mathbf{x}_A) f_{\mathbf{X}_B}(\mathbf{x}_B )$$
       <p>
        Equivalently, we have that the marginal distribution is equal to the conditional distribution $f_{\mathbf{X}_B \vert \mathbf{x}_A }(\mathbf{x}_B ) =f_{\mathbf{X}_B}(\mathbf{x}_B )$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=superb-ebony">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Expected-value,-variance-and-covariance">
        Expected value, variance and covariance
        <a class="anchor-link" href="#Expected-value,-variance-and-covariance">
         ¶
        </a>
       </h2>
       <h3 id="Expected-value">
        Expected value
        <a class="anchor-link" href="#Expected-value">
         ¶
        </a>
       </h3>
       <p>
        The expected value of of a random vector $\mathbf{X}$  which we will denote by $\text{E}[\mathbf{X}] = \boldsymbol{\mu}$ is equal to
       </p>
       $$
\text{E}[\mathbf{X}] = \begin{bmatrix} \text{E}[X_1] &amp;amp; \ldots &amp;amp; \text{E}[X_n] \end{bmatrix}^\top
$$
       <p>
        We have the property that when $\mathbf{A} + \mathbf{B} \mathbf{X}$ is defined then
       </p>
       $$
\text{E}[\mathbf{A} + \mathbf{B} \mathbf{X}] =\mathbf{A} +  \mathbf{B} \text{E}[ \mathbf{X}]
$$
       <p>
        This implies e.g. that
       </p>
       $$
\text{E}[a_1 X_1 + \ldots + a_n X_n] = a_1 \text{E}[X_1] + \ldots + a_n \text{E}[X_n]
$$
       <p>
        If $g(\mathbf{X})$ is a well-defined function
       </p>
       $$
\begin{equation*}
\text{E}[g(\mathbf{X})] = \int _{\mathbb{R}^n} g(\mathbf{X}) f_{\mathbf{X}}(\mathbf{x}) d\mathbf{x}
\end{equation*}
$$
       <h3 id="Variance-and-covariance">
        Variance and covariance
        <a class="anchor-link" href="#Variance-and-covariance">
         ¶
        </a>
       </h3>
       <p>
        Given any two random variables $X$ and $Y$ with finite variance, define the covariance of $X$ and $Y$  as
       </p>
       $$
\begin{equation*}
\text{Cov}[X,Y]= \text{E}[(X- \mu_x)(Y- \mu_y)] = \text{E}[XY] - \text{E}[X]\text{E}[Y]
\end{equation*}
$$
       <p>
        If $X$ and $Y$ are independent then $\text{Cov}[X,Y] = 0$, but a zero covariance does not necessarily imply independence!
       </p>
       <p>
        For a random vector, we define the
        <em>
         variance-covariance
        </em>
        matrix (we typically denote it $\boldsymbol{\Sigma}$)
       </p>
       $$
\boldsymbol{\Sigma} = \text{Var}[\mathbf{X}] = \text{E}[(\mathbf{X} - \text{E}[X])(\mathbf{X} - \text{E}[X])^\top] = \text{E}[\mathbf{X}\mathbf{X}^\top] - \text{E}[\mathbf{X}]\text{E}[\mathbf{X}]^\top
$$
       <p>
        where the $(i, j)$'th element is equal to the covariance between $X_i$ and $X_j$.
       </p>
       <p>
        The variance-covariance matrix is
       </p>
       <ul>
        <li>
         <a href="https://en.wikipedia.org/wiki/Symmetric_matrix">
          Symmetric
         </a>
        </li>
       </ul>
       $$
\boldsymbol{\Sigma} = \boldsymbol{\Sigma}^\top
$$
       <ul>
        <li>
         <a href="https://en.wikipedia.org/wiki/Definite_matrix">
          Positive semidefinite
         </a>
        </li>
       </ul>
       $$
\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w} \geq 0 \; \text{for all} \; \mathbf{w} \in \mathbb{R}^n
$$
       <p>
        <strong>
         Variance of an affine transformation
        </strong>
       </p>
       <p>
        We have the rule that for a random vector
       </p>
       $$
\text{Var}[\mathbf{A} + \mathbf{B}\mathbf{X}] = \mathbf{B}\text{Var}[\mathbf{X}]\mathbf{B}^\top
$$
       <p>
        <strong>
         Cross-covariance
        </strong>
       </p>
       <p>
        We can define the covariance between two random vectors as
       </p>
       $$
\text{Cov}[\mathbf{X}, \mathbf{Y}] = \text{E}[(\mathbf{X} - \text{E}[X])(\mathbf{Y} - \text{E}[Y])^\top] = \text{E}[\mathbf{X}\mathbf{Y}^\top] - \text{E}[\mathbf{X}]\text{E}[\mathbf{Y}]^\top
$$
       <p>
        In this case, we have
       </p>
       $$
\text{Cov}[\mathbf{A}\mathbf{X}, \mathbf{B}\mathbf{Y}] = \mathbf{A} \text{Cov}[\mathbf{X}, \mathbf{Y}]\mathbf{B}^\top
$$
       <h3 id="Correlation">
        Correlation
        <a class="anchor-link" href="#Correlation">
         ¶
        </a>
       </h3>
       <p>
        The covariance is determined not only by the degree of linear dependency between $X$ and $Y$ but also the scale of $X$ and $Y$ which motivates the use of correlation.
       </p>
       <p>
        The correlation coefficient is defined as
       </p>
       $$
\rho_{X,Y} = \text{Corr}[X,Y] = \frac{\text{Cov}[X,Y] }{\sqrt{\text{Var}[X]\text{Var}[Y]}}
$$
       <p>
        which will be independent of the scale of $X$ and $Y$.
       </p>
       <p>
        The correlation coefficent will take values $\rho_{X,Y} \in [-1, 1]$, where $\rho_{X,Y} &amp;lt; 0$ and $\rho_{X,Y} &amp;gt; 0$ will correspond to respectively negatively and positively correlated random variables. If $\rho_{X,Y} = 0$ then the two random variables are uncorrelated.
       </p>
       <p>
        We will be able to define the correlation matrix $\mathbf{Corr}$
       </p>
       $$
\mathbf{Corr}(\mathbf{X}) =  \mathbf{D} \boldsymbol{\Sigma} \mathbf{D}
$$
       <p>
        where
$$
\mathbf{D} = \text{Dg}(\sigma_1^{-1}, ..., \sigma_n^{-1})
$$
is a diagonal matrix of the inverse of the standard deviations.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=arctic-omega">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-with-correlation-and-covariance">
        Problem with correlation and covariance
        <a class="anchor-link" href="#Problem-with-correlation-and-covariance">
         ¶
        </a>
       </h2>
       <p>
        The covariance and correlation measure only linear dependence, e.g. if $b$ is positive and two random variables $X$ and $Y$ are related by $X = a + b Y$ then the correlation is $1$.
       </p>
       <p>
        However, if there is a non-linear relationship between the two random variables, then there is no guarantee that we will have a positive or negative correlation. Below we plot a situation where correlation as a measure makes sense and another situation where it does not make sense. In the left figure, we plot simulated observation from a uncorrelated bivariate normal. Naturally, since the distribution only dependence on the mean and covariance matrix, a correlation of zero is equivalent to independence. In the right figure, $X$ and $Y$ are clearly related, but the correlation is also zero!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=activated-spectacular">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">data1</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">2</span><span class="p">),</span>
                                  <span class="n">cov</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]]),</span>
                                  <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="sd">"""</span>
<span class="sd">Bivariate normal</span>
<span class="sd">"""</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">data1</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">data1</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Bivariate standard normal </span><span class="se">\n</span><span class="s1"> $Corr[X,Y]=0$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$y$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Uniform </span>
<span class="sd">"""</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">uniform</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=-</span><span class="mi">5</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'$X\sim U(-5, 5)$ and $Y = X^2$ </span><span class="se">\n</span><span class="s1"> $Corr[X,Y]=0$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">);</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$y$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">13</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="c1"># animations, etc. requires below magic command</span>
<span class="c1"># %matplotlib notebook</span>


<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span><span class="p">,</span> <span class="n">cm</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="c1">#import autograd</span>
<span class="c1"># functions to approx derivative and hessian </span>
<span class="kn">from</span> <span class="nn">statsmodels.tools.numdiff</span> <span class="kn">import</span> <span class="n">approx_fprime</span><span class="p">,</span> <span class="n">approx_hess</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=4187201e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="A-brief-look-at-Ordinary-Least-Squares-(OLS)">
        A brief look at Ordinary Least Squares (OLS)
        <a class="anchor-link" href="#A-brief-look-at-Ordinary-Least-Squares-(OLS)">
         ¶
        </a>
       </h2>
       <p>
        We will write a linear regression model (using matrix notation) as
       </p>
       $$
\mathbf{y} = \mathbf{X}\boldsymbol{\beta} + \mathbf{e}
$$
       <p>
        where $\mathbf{y}$ is the $n \times 1$ vector of dependent variables, $\mathbf{X}$ is the $n \times k$ matrix of regressors (independent variables) and $\mathbf{e}$ is the $n \times 1$ error vector.
       </p>
       <p>
        As the name implies, the OLS estimator minimizes the sum of squared residuals
       </p>
       $$
Q_n (\boldsymbol{\beta}) = \sum_{i=1}^n (y_i - \mathbf{x}_i^\top \boldsymbol{\beta} )^2 = (\mathbf{y} - \mathbf{X}\boldsymbol{\beta})^\top (\mathbf{y} - \mathbf{X}\boldsymbol{\beta}) = \mathbf{e}^\top \mathbf{e}
$$
       <p>
        Taking the derivative wrt. $\boldsymbol{\beta}$ and setting equal to zero yields the estimator
       </p>
       $$
\hat{\boldsymbol{\beta}}_{OLS} = (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{y}
$$
       <h3 id="Properties-of-OLS">
        Properties of OLS
        <a class="anchor-link" href="#Properties-of-OLS">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Note
        </strong>
        : It is not expected that you know all the finer details in deriving the asymptotic properties of e.g. the OLS estimator, but only how to implement derived formulas in Python.
       </p>
       <p>
        <strong>
         Consistency
        </strong>
       </p>
       $$
\begin{align}
\hat{\boldsymbol{\beta}}_{OLS} &amp;amp;= (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{y} \\
&amp;amp;= (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top (\mathbf{X}\boldsymbol{\beta} + \mathbf{e}) \\
&amp;amp;= (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{X}\boldsymbol{\beta} + (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{e} \\
&amp;amp;= \boldsymbol{\beta} + (\mathbf{X}^\top \mathbf{X})^{-1} \mathbf{X}^\top \mathbf{e} \\
&amp;amp;= \boldsymbol{\beta} + \left(\frac{1}{n}\mathbf{X}^\top \mathbf{X}\right)^{-1} \frac{1}{n}\mathbf{X}^\top \mathbf{e} 
\end{align}
$$
       <p>
        Basically, for consistency we need (without going into details)
       </p>
       $$
\text{plim} \frac{1}{n}\mathbf{X}^\top \mathbf{X} = \lim \frac{1}{n} \text{E} \left[ \mathbf{X}^\top\mathbf{X} \right]  =  \mathbf{M_{xx}}
$$
       <p>
        where $\mathbf{M_{xx}}$ is a non-singular matrix (invertible), and
       </p>
       $$
\text{plim} \frac{1}{n}\mathbf{X}^\top \mathbf{e} =  \lim \frac{1}{n} \text{E} \left[ \mathbf{X}^\top\mathbf{e} \right] =\mathbf{0}
$$
       <p>
        requiring the regressors and error term to be uncorrelated.
       </p>
       <p>
        <strong>
         Asymptotic normality
        </strong>
       </p>
       <p>
        Rewritting the above expression yields
       </p>
       $$
\sqrt{n}(\hat{\boldsymbol{\beta}}_{OLS} - \boldsymbol{\beta}) = \left(\frac{1}{n}\mathbf{X}^\top \mathbf{X}\right)^{-1} \frac{1}{\sqrt{n}}\mathbf{X}^\top \mathbf{e} 
$$
       <p>
        If we can apply a CLT to $\frac{1}{\sqrt{n}}\mathbf{X}^\top \mathbf{e}$ such that it converges to multivariate normal distribution with finite, non-singular covariance matrix, we will have asymptotic normality.
       </p>
       <p>
        Assuming that
       </p>
       $$
\frac{1}{\sqrt{n}}\mathbf{X}^\top \mathbf{e} \to^d N(\mathbf{0}, \mathbf{M_{x\Omega x}})
$$
       <p>
        with  (here $\boldsymbol{\Omega}=\text{E}[\mathbf{e} \mathbf{e}^\top \vert \mathbf{X}] = \text{Diag}[\sigma_i^2]$ is the covariance matrix of the errors)
       </p>
       $$
\text{plim} \frac{1}{n}\mathbf{X}^\top \mathbf{e} \mathbf{e}^\top\mathbf{X} = \text{plim} \frac{1}{n}\mathbf{X}^\top  \boldsymbol{\Omega} \mathbf{X}  = \mathbf{M_{x\Omega x}}
$$
       <p>
        then it will be possible to show that
       </p>
       $$
\sqrt{n}(\hat{\boldsymbol{\beta}}_{OLS} - \boldsymbol{\beta}) \to^d N\left(\mathbf{0}, \mathbf{M_{xx}}^{-1} \mathbf{M_{x\Omega x}}\mathbf{M_{xx}}^{-1}\right)
$$
       <p>
        <strong>
         Homoskedasticity vs. heteroskedasticity
        </strong>
       </p>
       <p>
        If $\boldsymbol{\Omega}=\text{E}[\mathbf{e}^\top \mathbf{e} \vert \mathbf{X}] = \text{Diag}[\sigma^2] = \sigma^2 \mathbf{I}$ then the error term is said to be homoskedastic and
       </p>
       $$
\sqrt{n}(\hat{\boldsymbol{\beta}}_{OLS} - \boldsymbol{\beta}) \to^d N\left(\mathbf{0}, \sigma^2 \mathbf{M_{xx}}^{-1} \mathbf{M_{xx}}\mathbf{M_{xx}}^{-1}\right) = N\left(\mathbf{0}, \sigma^2 \mathbf{M_{xx}}^{-1} \right) 
$$
       <p>
        where we will estimate $\hat{\mathbf{M}}_{\mathbf{xx}} = \frac{1}{n} \mathbf{X}^\top\mathbf{X}$ and $\sigma^2$ using the sample variance.
       </p>
       $$
S^2 = \frac{1}{n - k} \hat{\mathbf{e}}^\top \hat{\mathbf{e}}
$$
       <p>
        This leads to the variance estimator of the OLS estimator
       </p>
       $$
\hat{\text{Var}}[\hat{\boldsymbol{\beta}}_{OLS}] = S^2 \left( \mathbf{X}^\top\mathbf{X} \right)^{-1}
$$
       <p>
        If the error term is heteroskedastic then $\sigma_i^2$ differs between observations.
        <a href="https://en.wikipedia.org/wiki/Heteroscedasticity-consistent_standard_errors">
         Heteroscedastic robust standard errors
        </a>
        can be obtained using (under some regularity conditions)
       </p>
       $$
\hat{\text{Var}}[\hat{\boldsymbol{\beta}}_{OLS}] = \left( \mathbf{X}^\top\mathbf{X} \right)^{-1} \mathbf{X}^\top \hat{\boldsymbol{\Omega}}\mathbf{X} \left( \mathbf{X}^\top\mathbf{X} \right)^{-1}
$$
       <p>
        where $\hat{\boldsymbol{\Omega}} = \text{Diag}[\hat{e}_i^2]$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=architectural-generic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="A-general-framework:-m-estimators">
        A general framework: m-estimators
        <a class="anchor-link" href="#A-general-framework:-m-estimators">
         ¶
        </a>
       </h2>
       <p>
        In financial economics we cannot solely rely on linear regressions, we also need to be able to estimate parameters of different densities or highly non-linear models.
       </p>
       <p>
        Some of the principles observed for OLS can be extended to more general type of estimators namely
        <a href="https://en.wikipedia.org/wiki/M-estimator">
         m-estimators
        </a>
        that includes
        <em>
         Non-linear Least Squares (NLS)
        </em>
        and
        <em>
         Maximum Likelihood Estimation (MLE)
        </em>
        .
       </p>
       <h3 id="Definition-of-m-estimator">
        Definition of m-estimator
        <a class="anchor-link" href="#Definition-of-m-estimator">
         ¶
        </a>
       </h3>
       <p>
        A m-estimator $\hat{\theta}$ of the $k \times 1$ parameter vector $\theta$ minimizes the objective function $Q_n(\theta)$ that can be written as a sample average
       </p>
       $$
Q_n(\theta) = \frac{1}{n} \sum_{i=1}^n q(y_i, \mathbf{x}_i; \theta)
$$
       <p>
        where $q(\cdot)$ is scalar function. We assume independence over $i$.
       </p>
       <p>
        Clearly, with $q(y_i, \mathbf{x}_i; \beta) = (y_i - \mathbf{x}_i^\top \beta)^2$ OLS is a m-estimator!  The m-estimator is computed as the solution to the FOC
       </p>
       $$
\left. \frac{\partial Q_n(\theta)}{\partial \theta} \right \vert _{\theta = \hat{\theta}} = \frac{1}{n} \sum_{i=1}^n \left. \frac{\partial q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta} \right \vert _{\theta = \hat{\theta}} = \mathbf{0}
$$
       <p>
        The $k$ equations with $k$ unknowns will sometimes have an explicit analytical solution, but often we need to use numerical methods to find a solution.
       </p>
       <h3 id="Some-comments-on-properties-of-m-estimators">
        Some comments on properties of m-estimators
        <a class="anchor-link" href="#Some-comments-on-properties-of-m-estimators">
         ¶
        </a>
       </h3>
       <p>
        Generally, it can be an audacious task to derive the properties of m-estimators such as NLS and MLE and it is not the objective of the course.
       </p>
       <p>
        <strong>
         Consistency
        </strong>
       </p>
       <p>
        We have to assume that there is a particular data generating process and a corresponding value of $\theta$, say $\theta_0$, which generates the data. We need to have that $\theta_0$ is unique in the sense that other values of $\theta$ would not correspond to the same data-generating proces (
        <a href="https://en.wikipedia.org/wiki/Identifiability">
         identification
        </a>
        ).
       </p>
       <p>
        In a linear regression model this holds when $\mathbf{X}$ has full rank since then
       </p>
       $$
\mathbf{x}^\top \beta_1 = \mathbf{x}^\top \beta_2
$$
       <p>
        if and only if $\beta_1=\beta_2$.
       </p>
       <p>
        <strong>
         Limit distribution
        </strong>
       </p>
       <p>
        As in the case for OLS, the m-estimators that we consider will typically converge asymptotically to a multivariate normal
       </p>
       $$
\sqrt{n} (\hat{\theta} - \theta_0) \to^d N(0, \mathbf{A}_0^{-1} \mathbf{B} \mathbf{A}_0^{-1})
$$
       <p>
        where
       </p>
       $$
\mathbf{A}_0 = \text{plim} \frac{1}{n} \sum_{i=1}^n \left. \frac{\partial^2 q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta \partial \theta^\top} \right \vert _{\theta = \theta_0} = \text{lim} \frac{1}{n} \sum_{i=1}^n \text{E} \left[\left. \frac{\partial^2 q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta \partial \theta^\top} \right \vert _{\theta = \theta_0} \right]
$$
       <p>
        and
       </p>
       $$
\mathbf{B}_0 = \text{plim} \frac{1}{n} \sum_{i=1}^n \left. \frac{\partial q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta } \frac{\partial q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta^\top } \right \vert _{\theta = \theta_0} = \text{lim} \frac{1}{n} \sum_{i=1}^n \text{E} \left[\left. \frac{\partial q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta } \frac{\partial q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta^\top } \right \vert _{\theta = \theta_0} \right]
$$
       <p>
        <strong>
         The OLS case
        </strong>
       </p>
       <p>
        We note that for OLS, we would have
       </p>
       $$
\begin{align}
\mathbf{A}_0 &amp;amp; =  \lim \frac{1}{n} \text{E} \left[ \mathbf{X}^\top\mathbf{X} \right]  =  \mathbf{M_{xx}} \\
\mathbf{B}_0 &amp;amp; = \lim \frac{1}{n} \text{E} \left[ \mathbf{X}^\top \mathbf{e} \mathbf{e}^\top\mathbf{X}   \right]  = \mathbf{M_{x\Omega x}}
\end{align}
$$
       <p>
        such that we obtain the asymptotic distribution presented above. To see this, remember that (the constant 2 will disappear when calculating the asymptotic variance)
       </p>
       $$
\frac{\partial}{\partial \beta }  (y_i - \mathbf{x}_i^\top \beta)^2 = 2 (y_i - \mathbf{x}_i^\top \beta) \mathbf{x}_i = 2e_i \mathbf{x}_i
$$
       <p>
        such that
       </p>
       $$
\frac{1}{n} \sum_{i=1}^n \frac{\partial}{\partial \beta }  (y_i - \mathbf{x}_i^\top \beta)^2 \frac{\partial}{\partial \beta^\top }  (y_i - \mathbf{x}_i^\top \beta)^2 = \frac{1}{n} \sum_{i=1}^n 4e_i^2 \mathbf{x}_i \mathbf{x}_i^\top = \frac{1}{n} 4 \mathbf{X}^\top \mathbf{e} \mathbf{e}^\top \mathbf{X}
$$
       <p>
        and
       </p>
       $$
\frac{1}{n} \sum_{i=1}^n \frac{\partial}{\partial \beta \partial \beta^\top}  (y_i - \mathbf{x}_i^\top \beta)^2 = \frac{1}{n} \sum_{i=1}^n 2 \mathbf{x}_i \mathbf{x}_i^\top = \frac{1}{n} 2 \mathbf{X}^\top\mathbf{X}
$$
       <p>
        <strong>
         Approximating the limit distribution
        </strong>
       </p>
       <p>
        We also note that we could use the below estimators when approximating the limit distribution
       </p>
       $$
\begin{align}
\hat{\mathbf{A}} &amp;amp; = \frac{1}{n} \sum_{i=1}^n \left. \frac{\partial^2 q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta \partial \theta^\top} \right \vert _{\theta = \hat{\theta}}  \\
\hat{\mathbf{B}} &amp;amp; = \frac{1}{n} \sum_{i=1}^n \left. \frac{\partial q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta } \frac{\partial q_i(y_i, \mathbf{x}_i ;\theta)}{\partial \theta^\top } \right \vert _{\theta = \hat{\theta}}
\end{align}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=characteristic-evaluation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Maximum-likelihood-estimation-(MLE)">
        Maximum likelihood estimation (MLE)
        <a class="anchor-link" href="#Maximum-likelihood-estimation-(MLE)">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://en.wikipedia.org/wiki/Maximum_likelihood_estimation">
         Maximum likelihood estimation
        </a>
        is one of the most widely used estimation methods with a number of diserable properties, e.g. it will be the most efficient estimator among consistent asymptotically normal estimators.
       </p>
       <p>
        The MLE of $\theta_0$ basically seeks to select the $\theta$ that maximizes the likelihood of observing the actual sample. The joint density of the random sample $f(\mathbf{y}, \mathbf{X}; \theta)$, which will define as the likelihood function, can under an independence assumption be written as the product of the marginal densities
       </p>
       $$
L_n (\theta \vert \mathbf{y}, \mathbf{X}) = f(\mathbf{y}, \mathbf{X}; \theta) = \prod_{i=1}^n f_{y, \mathbf{x}_i} (y_i, \mathbf{x}_i; \theta)
$$
       <p>
        Since $\ln$ is a positive monotone transformation, we can equivalently maximize the log-likelihood function
       </p>
       $$
\mathcal{L}_n (\theta \vert \mathbf{y}, \mathbf{X}) = \ln L_n (\theta \vert \mathbf{y}, \mathbf{X}) = \sum_{i=1}^n \ln f_{y, \mathbf{x}_i} (y_i, \mathbf{x}_i; \theta)
$$
       <h3 id="Conditional-likelihood">
        Conditional likelihood
        <a class="anchor-link" href="#Conditional-likelihood">
         ¶
        </a>
       </h3>
       <p>
        We can factorize a density as the product between the conditional and marginal density
       </p>
       $$
L_n (\theta \vert \mathbf{y}, \mathbf{X}) = f(\mathbf{y}, \mathbf{X}; \theta) = f(\mathbf{y} \vert \mathbf{X}; \theta) f(\mathbf{X}; \theta)  
$$
       <p>
        Typically, we will only focus on the conditional density $f(\mathbf{y} \vert \mathbf{X}; \theta)$ since we are interested in $\mathbf{y}$ given $\mathbf{X}$ (we will do this below). It will not be an issue if $\mathbf{y}$ and $\mathbf{X}$ depends on different sets of parameters, which often will be a reasonable assumption (but not always).
       </p>
       <p>
        In
        <em>
         time series modelling
        </em>
        , we also often use the notion of a conditional likelihood function since we cannot always apply an independence assumption.  Assume e.g. that $y_t$ depends on $y_{t-1}$ (and no regressors) then we could factorize (using T to indicate time series context)
       </p>
       $$
\begin{align}
L_T (\theta \vert \mathbf{y}) &amp;amp;= f_{y_0, \dots, y_T}(y_0, \dots, y_T; \theta) \\
&amp;amp;= f_y(y_0; \theta) f_{y_1, \dots, y_T}(y_1, \dots, y_T; \theta) \\
&amp;amp;= f_y(y_0; \theta) \prod_{t=1}^T f_{y_t \vert y_{t-1}}(y_t \vert y_{t-1}; \theta)
\end{align}
$$
       <p>
        dropping $f_y(y_0; \theta)$ will result in the conditional likelihood function that is conditional on the starting value.
       </p>
       <h3 id="M-estimator">
        M-estimator
        <a class="anchor-link" href="#M-estimator">
         ¶
        </a>
       </h3>
       <p>
        In order to be able to use the results for m-estimators, we just divide the log-likelihood function with $n$
       </p>
       $$
Q_n(\theta) = \frac{1}{n} \mathcal{L}_n (\theta) = \frac{1}{n} \sum_{i=1}^n \ln f_{y, \mathbf{x}_i} (y_i \vert \mathbf{x}_i; \theta)
$$
       <p>
        <strong>
         Remember:
        </strong>
        Most optimizers seek to minimize a function so we may need to multiply with minus one and then minimize.
       </p>
       <p>
        <strong>
         Example: Bernoulli
        </strong>
       </p>
       <p>
        Assume that we observe a realization of the random sample $Y_1, ...., Y_{n}$ where $Y_i\sim \text{Bernoulli}(p), i=1,...,n$
       </p>
       <p>
        We can write the likelihood function as
       </p>
       $$
\begin{equation*}
L(p) = \prod_{i=1}^n f_Y(y_i;p) = \prod_{i=1}^n p^{y_i}(1-p) ^{1-y_i} = p^{\sum_{i=1}^n y_i}(1-p)^{\sum_{i=1}^n (1-y_i)}
\end{equation*}
$$
       <p>
        We want to maximize with respect to $p$, but we first take the natural logarithm
       </p>
       $$
\begin{equation*}
\ln L(p) = \ln (p) \sum_{i=1}^n y_i + \ln(1-p) \sum_{i=1}^n (1-y_i)
\end{equation*}
$$
       <p>
        The first order condition is (take derivative wrt. $p$)
       </p>
       $$
\begin{equation*}
\frac{1}{p} \sum_{i=1}^n y_i - \frac{1}{1-p} \left[n - \sum_{i=1}^n y_i \right] = 0
\end{equation*}
$$
       <p>
        such that we obtain the maximum-likelihood estimate
       </p>
       $$
p_e = \frac{1}{n}\sum_{i=1}^n y_i
$$
       <p>
        Below, we see a simple implementation in Python
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=local-trainer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define log-likelihood function</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">log_likelihood_function</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    
    <span class="n">log_like</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">x</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">log_like</span>

<span class="sd">"""</span>
<span class="sd">Generate data</span>
<span class="sd">"""</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="n">bernoulli_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mf">0.5</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Minimize negative of log-likelihood</span>
<span class="sd">"""</span>
<span class="n">neg_log_lik</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="o">-</span><span class="n">log_likelihood_function</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">bernoulli_data</span><span class="p">)</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">neg_log_lik</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="p">{(</span><span class="mf">0.00001</span><span class="p">,</span><span class="mf">0.99999</span><span class="p">)})</span>
<span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=christian-person">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Information-matrix-equality">
        Information matrix equality
        <a class="anchor-link" href="#Information-matrix-equality">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Fisher_information">
         information matrix
        </a>
        can equivalently be written as
       </p>
       $$
I(\theta) = -\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] = \text{E} \left[ \left. \frac{\partial \mathcal{L}_n (\theta)}{\partial \theta } \frac{\partial \mathcal{L}_n (\theta)}{\partial \theta^\top } \right \vert_{\theta = \theta_0}\right]
$$
       <h3 id="Asymptotic-distribution">
        Asymptotic distribution
        <a class="anchor-link" href="#Asymptotic-distribution">
         ¶
        </a>
       </h3>
       <p>
        The Information matrix equality implies that $-\mathbf{A}_0 = \mathbf{B}_0$ such that $\mathbf{A}_0 ^{-1}\mathbf{B}_0 \mathbf{A}_0 ^{-1} =  \mathbf{B}_0 ^{-1}=  -\mathbf{A}_0^{-1}$.
       </p>
       <p>
        Using the results for m-estimators, we have
       </p>
       $$
\sqrt{n} (\hat{\theta}_{MLE} - \theta_0) \to^d N(0, -\mathbf{A}_0^{-1})
$$
       <p>
        or alternatively written as
       </p>
       $$
\hat{\theta}_{MLE} \sim ^a N\left(\theta_0, -\left(\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1}\right)
$$
       <p>
        Note that
       </p>
       $$
V(\hat{\theta}_{MLE} ) = -\left(\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1}
$$
       <p>
        corresponds to Cramér-Rao's lower bound such that the MLE is the most efficient estimator among consistent and asympotically normal estimators.
       </p>
       <p>
        <strong>
         Note:
        </strong>
        To avoid confusion we may note that
       </p>
       $$
-\left(\text{E} \left[ \left. \frac{\partial^2 \mathcal{L}_n (\theta)}{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1} = -\left(\text{E} \left[ \left. \sum_{i=1}^n \frac{\partial^2 \ln f_y(y_i; \theta) }{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1} = - \left(n\text{E} \left[ \left.  \frac{\partial^2 \ln f_y(y_i; \theta) }{\partial \theta \partial \theta^\top} \right \vert_{\theta = \theta_0}\right] \right)^{-1}  
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=level-howard">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Bernoulli (cont'd)
        </strong>
       </p>
       <p>
        For a Bernoulli distribution, we have that
       </p>
       \begin{equation*}
\ln f_y(y_i;p) = \ln(p) y_i + \ln(1-p) (1-y_i)
\end{equation*}
       <p>
        such that
       </p>
       $$
\frac{\partial \ln f_y(y_i;p)}{\partial p} = \frac{1}{p}y_i - \frac{1}{1 - p} (1 - y_i)
$$
       <p>
        and
       </p>
       $$
\frac{\partial \ln f_y(y_i;p)^2}{\partial p^2} = -\frac{1}{p^2}y_i - \frac{1}{(1 - p)^2} (1 - y_i)
$$
       <p>
        Since $\text{E}[y_i] = p$, we obtain
       </p>
       $$
\text{E}\left[\frac{\partial \ln f_y(y_i;p)^2}{\partial p^2} \right] = -\frac{1}{p^2}p - \frac{1}{(1 - p)^2} (1 - p) = -\frac{1}{p} - \frac{1}{1-p} = -\frac{1}{(1-p)p}
$$
       <p>
        Thus, the asymptotic variance is given by
       </p>
       $$
V(\hat{p}) =  - \left(- n\frac{1}{(1-p)p}\right)^{-1} = \frac{(1-p)p}{n} 
$$
       <p>
        So, when $n$ is large then we have that the distribution of $\hat{p}$ is given by
       </p>
       $$
\hat{p} \sim^a N\left(p, \frac{(1-p)p}{n}  \right)
$$
       <p>
        Let us check it out!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sudden-massachusetts">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">p</span> <span class="o">=</span> <span class="mf">0.25</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">bernoulli_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">p</span><span class="p">,</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="mi">1000</span><span class="p">,</span> <span class="n">num_sim</span><span class="p">))</span>

<span class="n">p_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax_</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">ax_</span> <span class="o">=</span> <span class="n">ax_</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">N</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="mi">10</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]):</span> 

    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
    
    <span class="c1"># asymptotic variance</span>
    <span class="n">asymp_est_var</span> <span class="o">=</span> <span class="n">p</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">p</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    
    
    <span class="c1"># get section of generated data</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">bernoulli_data</span><span class="p">[:</span><span class="n">N</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="c1"># calculate sample means</span>
    <span class="n">sample_means</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    
    <span class="c1"># plot histogram </span>
    <span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sample_means</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">p_vals</span><span class="p">,</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">p_vals</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">p</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">asymp_est_var</span><span class="p">)),</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
    
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Histogram of $\hat</span><span class="si">{p}</span><span class="s2">$ for N = "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_axisbelow</span><span class="p">(</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=innovative-porcelain">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Non-linear-Least-Squares-(NLS)">
        Non-linear Least Squares (NLS)
        <a class="anchor-link" href="#Non-linear-Least-Squares-(NLS)">
         ¶
        </a>
       </h2>
       <p>
        A non-linear regression model specifies the conditional mean as
       </p>
       $$
\text{E}[y_i \vert \mathbf{x}_i] = g(\mathbf{x}_i; \theta)
$$
       <p>
        or equivalently written as (assuming that $\text{E}[\mathbf{e} \vert \mathbf{x}] = 0$)
       </p>
       $$
y_i = g(\mathbf{x}_i; \theta) + e_i
$$
       <p>
        Clearly, linear regression is the special case $g(\mathbf{x}_i; \beta) = \mathbf{x}_i^\top \beta$.
       </p>
       <p>
        The NLS estimator will minimize the sum of squared residuals or minimize (we can scale with $1/2$ without loss of generality)
       </p>
       $$
Q_n(\theta) = - \frac{1}{2n} \sum_{i=1}^n (y_i - g(\mathbf{x}_i; \theta))^2
$$
       <p>
        The FOC gives us
       </p>
       $$
\frac{\partial Q_n(\theta)}{\partial \theta} = \frac{1}{n} \sum_{i=1}^n \frac{\partial g(\mathbf{x}_i; \theta)}{\partial \theta} (y_i - g(\mathbf{x}_i; \theta)) = \mathbf{0}
$$
       <p>
        or more compactly using matrix notation
       </p>
       $$
\frac{\partial Q_n(\theta)}{\partial \theta} = \frac{1}{n}\frac{\partial \mathbf{g}^\top}{\partial \theta} (\mathbf{y}- \mathbf{g})
$$
       <p>
        For consistency of the NLS estimator, it is crucial that the mean is specified correctly.
       </p>
       <p>
        Assuming a covariance matrix for the errors $\text{E}[\mathbf{e} \mathbf{e}^\top \vert \mathbf{X}] = \boldsymbol{\Omega}_0$
and under regularity conditions, it will be the case that
       </p>
       $$
\sqrt{n} (\hat{\theta}_{NLS} - \theta_0) \to^d N(0, \mathbf{A}_0^{-1} \mathbf{B}_0 \mathbf{A}_0^{-1})
$$
       <p>
        with
       </p>
       $$
\begin{align}
\mathbf{A}_0 &amp;amp;= \text{plim} \left. \frac{1}{n} \frac{\partial \mathbf{g}^\top}{\partial \theta} \frac{\partial \mathbf{g}}{\partial \theta^\top}  \right \vert_{\theta = \theta_0}\\
\mathbf{B}_0 &amp;amp;= \text{plim} \left. \frac{1}{n} \frac{\partial \mathbf{g}^\top}{\partial \theta} \boldsymbol{\Omega}_0 \frac{\partial \mathbf{g}}{\partial \theta^\top} \right \vert_{\theta = \theta_0}
\end{align}
$$
       <p>
        A reasonable estimator for $\mathbf{A}_0$ is
       </p>
       $$
\hat{\mathbf{A}} = \left. \frac{1}{n} \frac{\partial \mathbf{g}^\top}{\partial \theta} \frac{\partial \mathbf{g}}{\partial \theta^\top}\right \vert_{\theta = \hat{\theta}_{NLS}}
$$
       <p>
        For $\mathbf{B}_0$ it depends (just as in the OLS case) on the assumption we can make about $\boldsymbol{\Omega}_0$. Assuming independence implies that $\boldsymbol{\Omega}_0$ must be a diagonal matrix. If homoskedasticity of the error term can be assumed then
       </p>
       $$
\sqrt{n} (\hat{\theta}_{NLS} - \theta_0) \to^d N(0, \sigma^2 \mathbf{A}_0^{-1})
$$
       <p>
        and we just need to estimate $\sigma^2$ using the sample variance. If we allow for heteroskedasticity, we can estimate
       </p>
       $$
\hat{\mathbf{B}} = \left. \frac{1}{n} \frac{\partial \mathbf{g}^\top}{\partial \theta} \hat{\boldsymbol{\Omega}}\frac{\partial \mathbf{g}}{\partial \theta^\top}\right \vert_{\theta = \hat{\theta}_{NLS}}
$$
       <p>
        where $\hat{\boldsymbol{\Omega}} = \text{Diag}[\hat{e}_i^2]$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=turkish-vulnerability">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Application:-Exponential-distribution">
        Application: Exponential distribution
        <a class="anchor-link" href="#Application:-Exponential-distribution">
         ¶
        </a>
       </h2>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Exponential_distribution">
         exponential density
        </a>
        is given by
       </p>
       $$
f_Y(y) = \lambda e^{-\lambda y}, \; y &amp;gt; 0, \; \lambda &amp;gt; 0
$$
       <p>
        The mean and variance is respectively $1/\lambda$ and $1/\lambda^2$. The exponential distribution can be used to describe the time for a continuous process to change state or for an event to occur, e.g. time between roadkills on a given road.
       </p>
       <p>
        Below we plot the density of a exponential density (with the above parameterization) assuming $\lambda = 12$. On average, we will wait $1/12$ time periods for one event to occur (one month if $y$ is measured in years).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=suffering-affair">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">lam</span> <span class="o">=</span> <span class="mf">12.0</span>
<span class="n">y_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.001</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">expon</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">y_values</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">lam</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">y_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$y$'</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$f_Y(y)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=threatened-transaction">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We may introduce explanatory variables by specifying
       </p>
       $$
\lambda = e^{\mathbf{x}^\top \beta} 
$$
       <p>
        ensuring $\lambda &amp;gt; 0$ and specifying the conditional mean as
       </p>
       $$
\text{E}[y \vert \mathbf{x}] = e^{-\mathbf{x}^\top \beta}
$$
       <p>
        Assume that we observe a realization of a iid random sample $y_i, \mathbf{x}_i$, $i = 1, ... n$.
       </p>
       <h3 id="The-MLE">
        The MLE
        <a class="anchor-link" href="#The-MLE">
         ¶
        </a>
       </h3>
       <p>
        The (conditional) log-likehood function can be written
       </p>
       $$
\mathcal{L}_n (\beta) =  \sum_{i=1}^n  \left[ \mathbf{x}_i^\top \beta - e^{\mathbf{x}_i^\top \beta} y_i\right]
$$
       <p>
        with the FOC
       </p>
       $$
\frac{\partial \mathcal{L}_n (\beta)}{\partial \beta} =  \sum_{i=1}^n  \left[ \mathbf{x}_i  - \mathbf{x}_i e^{\mathbf{x}_i^\top \beta} y_i\right] = \sum_{i=1}^n  \mathbf{x}_i\left[ 1  - e^{\mathbf{x}_i^\top \beta} y_i\right] = \mathbf{0}
$$
       <p>
        To obtain the variance of the MLE estimator, it will be useful to note that (using the more general notation of m-estimators)
       </p>
       $$
\begin{align}
\frac{1}{n} \sum_{i=1}^n  \frac{\partial^2 q_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta \partial \beta^\top} &amp;amp;=  \frac{1}{n} \sum_{i=1}^n -\mathbf{x}_i \mathbf{x}_i^\top e^{\mathbf{x}_i^\top \beta} y_i\\
\frac{1}{n} \sum_{i=1}^n \frac{\partial q_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta } \frac{\partial q_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta^\top }  &amp;amp;=      \frac{1}{n} \sum_{i=1}^n \mathbf{x}_i \mathbf{x}_i^\top \left[1 - e^{\mathbf{x}_i^\top \beta} y_i \right]^2
\end{align}
$$
       <h3 id="The-NLS-estimator">
        The NLS estimator
        <a class="anchor-link" href="#The-NLS-estimator">
         ¶
        </a>
       </h3>
       <p>
        A non-linear least squares estimator can be implemented by estimating
       </p>
       $$
y_i = e^{-\mathbf{x}_i^\top \beta} + e_i
$$
       <p>
        We also note that the error term is heteroskedastic since $\text{Var}[y_i] = 1 / [e^{\mathbf{x}_i^\top \beta}]^2$. Our FOC reads
       </p>
       $$
\frac{1}{n} \sum_{i=1}^n (y_i - e^{-\mathbf{x}_i^\top \beta})e^{-\mathbf{x}_i^\top \beta}\mathbf{x}_i = \mathbf{0}
$$
       <p>
        For calculating variance, we note that (using the notation for NLS above)
       </p>
       $$
\begin{align}
\frac{1}{n} \sum_{i=1}^n \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta } \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta^\top }  &amp;amp;= \frac{1}{n} \sum_{i=1}^n e^{2\mathbf{x}_i^\top \beta}\mathbf{x}_i \mathbf{x}_i^\top \\
\frac{1}{n} \sum_{i=1}^n \sigma_i^2 \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta } \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta^\top }  &amp;amp;=  \frac{1}{n} \sum_{i=1}^n e^{-2\mathbf{x}_i^\top \beta} e^{2\mathbf{x}_i^\top \beta}\mathbf{x}_i \mathbf{x}_i^\top = \frac{1}{n} \sum_{i=1}^n \mathbf{x}_i \mathbf{x}_i^\top
\end{align}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=lasting-interview">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Simulating-data-and-implementing-estimators">
        Simulating data and implementing estimators
        <a class="anchor-link" href="#Simulating-data-and-implementing-estimators">
         ¶
        </a>
       </h3>
       <p>
        We consider 10,000 iid draws from the data generating process
       </p>
       $$
y \sim \text{Exp}(\beta_1 + \beta_2 x)
$$
       <p>
        with $x \sim N(1, 1)$ and $(\beta_1, \beta_2) = (2, -1)$.
       </p>
       <h4 id="MLE">
        MLE
        <a class="anchor-link" href="#MLE">
         ¶
        </a>
       </h4>
       <p>
        Below we implement the (negative) log-likelhood function and minimize it.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=promotional-azerbaijan">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate data</span>
<span class="sd">"""</span>
<span class="n">n_sim</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">beta1</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">beta2</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">beta1</span><span class="p">,</span> <span class="n">beta2</span><span class="p">])</span>

<span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sim</span><span class="p">)</span>
<span class="n">x_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">c_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">n_sim</span><span class="p">),</span> <span class="n">x_data</span><span class="p">]</span>
<span class="n">y_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">exponential</span><span class="p">(</span><span class="n">scale</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">beta</span><span class="p">),</span> <span class="n">size</span><span class="o">=</span><span class="n">n_sim</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sunset-drill">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define log-likelihood function (negative)</span>
<span class="sd">"""</span>


<span class="k">def</span> <span class="nf">log_likelihood_function</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="n">log_like</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="n">beta</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span>
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span> 
        <span class="k">return</span> <span class="o">-</span><span class="n">log_like</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">log_like</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Minimize negative log-likelihood </span>
<span class="sd">"""</span>
<span class="n">res_dict</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">log_likelihood_function</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">))</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'beta1'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'beta2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">params_mle</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
<span class="n">params_mle</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=classified-savage">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We have several different options when calculating the variance of the estimator. In this particular model, we know that
       </p>
       $$
\begin{align}
\text{E}\left[\frac{1}{n} \sum_{i=1}^n \mathbf{x}_i \mathbf{x}_i^\top \left[1 - e^{\mathbf{x}_i^\top \beta} y_i \right]^2 \right] &amp;amp;= \frac{1}{n}\sum_{i=1}^n \text{E}\left[\mathbf{x}_i \mathbf{x}_i^\top \left[1 - e^{\mathbf{x}_i^\top \beta} y_i \right]^2 \right] \\
        &amp;amp; = \frac{1}{n}\sum_{i=1}^n \text{E}\left[\mathbf{x}_i \mathbf{x}_i^\top \right]\\
\text{E}\left[ \frac{1}{n} \sum_{i=1}^n -\mathbf{x}_i \mathbf{x}_i^\top e^{\mathbf{x}_i^\top \beta} y_i \right] &amp;amp;= -\frac{1}{n}\sum_{i=1}^n \text{E}\left[\mathbf{x}_i \mathbf{x}_i^\top \right]
\end{align}
$$
       <p>
        Given our assumptions about $x$, we know that
       </p>
       $$
\text{E}\left[\mathbf{x}_i \mathbf{x}_i^\top \right] = \text{E}\left[\begin{bmatrix} 1 \\ x_i \end{bmatrix} \begin{bmatrix} 1 &amp;amp; x_i \end{bmatrix} \right] = \text{E}\left[\begin{bmatrix} 1 &amp;amp; x_i \\ x_i &amp;amp; x_i^2 \end{bmatrix} \right] = \begin{bmatrix} 1 &amp;amp; 1 \\ 1 &amp;amp; 2 \end{bmatrix} 
$$
       <p>
        such that the variance is given by
       </p>
       $$
\text{Var}[\hat{\beta}] = - \left[-n \text{E}\left[\mathbf{x}_i \mathbf{x}_i^\top \right]\right]^{-1}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=relevant-coalition">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">exp_xx_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">]])</span>
<span class="n">param_mle_cov_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">n_sim</span> <span class="o">*</span> <span class="n">exp_xx_true</span><span class="p">)</span>

<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std1_true'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_true</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std2_true'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_true</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="c1"># print covariance matrix of parameter estimator </span>
<span class="n">param_mle_cov_true</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=republican-yorkshire">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Generally, we observe real data, i.e. we do not know the true data generating process, such that we need to estimate the variance of the estimator. We need to evaluate the below expression at the MLE estimate.
       </p>
       $$
\begin{align}
\frac{1}{n} \sum_{i=1}^n  \frac{\partial^2 q_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta \partial \beta^\top} &amp;amp;= \frac{1}{n} \sum_{i=1}^n -\mathbf{x}_i \mathbf{x}_i^\top e^{\mathbf{x}_i^\top \beta} y_i \\
\frac{1}{n} \sum_{i=1}^n \frac{\partial q_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta } \frac{\partial q_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta^\top }  &amp;amp;=     \frac{1}{n} \sum_{i=1}^n \mathbf{x}_i \mathbf{x}_i^\top \left[1 - e^{\mathbf{x}_i^\top \beta} y_i \right]^2
\end{align}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=precise-france">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        To calculate the above expressions, we need to calculate $\mathbf{x}_i \mathbf{x}_i^\top$ for each $i$. A quick way is to use the
        <code>
         numpy.einsum
        </code>
        function.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=correct-spencer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_data</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=wooden-clearance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,jk-&amp;gt;jik'</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=independent-flood">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,jk-&amp;gt;jik'</span><span class="p">,</span><span class="n">x_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_sim</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=opposite-onion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,jk-&amp;gt;ik'</span><span class="p">,</span><span class="n">x_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_sim</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=noticed-representative">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,kj-&amp;gt;jik'</span><span class="p">,</span><span class="n">x_data</span><span class="p">,</span> <span class="n">x_data</span><span class="o">.</span><span class="n">T</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_sim</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=activated-currency">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,kj-&amp;gt;ik'</span><span class="p">,</span><span class="n">x_data</span><span class="p">,</span> <span class="n">x_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">/</span> <span class="n">n_sim</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=anticipated-burton">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_data</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">x_data</span> <span class="o">/</span> <span class="n">n_sim</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=civic-movie">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Gradient </span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">outer_gradient</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(((</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,jk-&amp;gt;jik'</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">outer_gradient_alternative</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> 
    
    <span class="n">x_new</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
    
    <span class="k">return</span> <span class="n">x_new</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">x_new</span>

<span class="sd">"""</span>
<span class="sd">Hessian </span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">hessian</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span> 
    
    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">y</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> 
                   <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">'ji,jk-&amp;gt;jik'</span><span class="p">,</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 
    
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=institutional-constitution">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">outer_gradient</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=metallic-drunk">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">outer_gradient_alternative</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=executed-clinic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">hessian</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">outer_gradient</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="n">y_data</span><span class="p">)</span>

<span class="n">param_mle_cov_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">A</span><span class="p">)</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std1_A'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std2_A'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">param_mle_cov_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">B</span><span class="p">)</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std1_B'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std2_B'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_B</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">param_mle_cov_sandwich</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std1_SW'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_sandwich</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std2_SW'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_sandwich</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=floppy-amino">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A</span>
<span class="n">param_mle_cov_A</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=nasty-thousand">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on B</span>
<span class="n">param_mle_cov_B</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=concerned-algebra">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A^{-1}BA^{-1} "Sandwich formula"</span>
<span class="n">param_mle_cov_sandwich</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=quiet-alabama">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The above calculations assume that we have derived the formula for "A" and "B" such that we "just" need to evaluate at the MLE estimate.
       </p>
       <p>
        However, it may be a tedious task. A common approach is to use numerical derivatives or other tools to calculate "A" and "B". Below we use the
        <code>
         statsmodels.tools.numdiff
        </code>
        package.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=champion-impossible">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">scores</span> <span class="o">=</span> <span class="n">approx_fprime</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">log_likelihood_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="kc">True</span><span class="p">))</span>
<span class="n">B_approx</span> <span class="o">=</span> <span class="n">scores</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">scores</span>  <span class="c1">#np.sum(np.einsum('ji,jk-&amp;gt;jik', scores, scores), axis=0)</span>

<span class="n">A_approx</span> <span class="o">=</span> <span class="o">-</span><span class="n">approx_hess</span><span class="p">(</span><span class="n">params_mle</span><span class="p">,</span> <span class="n">log_likelihood_function</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">))</span>

<span class="n">param_mle_cov_A_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="o">-</span><span class="n">A_approx</span><span class="p">)</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std1_A_num'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_A_num</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std2_A_num'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_A_num</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">param_mle_cov_B_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">B_approx</span><span class="p">)</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std1_B_num'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_B_num</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std2_B_num'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_B_num</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">param_mle_cov_sandwich_num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A_approx</span><span class="p">)</span> <span class="o">@</span> <span class="n">B_approx</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A_approx</span><span class="p">)</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std1_SW_num'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_sandwich_num</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'MLE'</span><span class="p">][</span><span class="s1">'std2_SW_num'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_mle_cov_sandwich_num</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=worst-amber">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A</span>
<span class="n">param_mle_cov_A_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=sexual-breakdown">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on B</span>
<span class="n">param_mle_cov_B_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=temporal-bolivia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># covariance matrix based on A^{-1}BA^{-1} "Sandwich formula"</span>
<span class="n">param_mle_cov_sandwich_num</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=engaging-naples">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res_dict</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=enhanced-frame">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We have specified the model correctly and have lots of data, so it is no surprice that maximum likelihood performs well. Due to the information matrix equality, then using different variance estimators gives us very similar results.
       </p>
       <h4 id="NLS">
        NLS
        <a class="anchor-link" href="#NLS">
         ¶
        </a>
       </h4>
       <p>
        Next, we define the NLS objective and minimze it.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=suitable-subdivision">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">objective_nls</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">individual</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span> 
    
    <span class="n">loss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">))</span> 
    
    <span class="k">if</span> <span class="n">individual</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">loss</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">loss</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
<span class="k">def</span> <span class="nf">foc_nls</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span> 
    
    <span class="n">der</span> <span class="o">=</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span> <span class="o">@</span> <span class="n">x</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">der</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=powerful-proof">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">objective_nls</span><span class="p">,</span> <span class="p">[</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">],</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">,</span> <span class="kc">False</span><span class="p">))</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">][</span><span class="s1">'beta1'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">][</span><span class="s1">'beta2'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">params_nls</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
<span class="n">params_nls</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=present-setup">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=trained-military">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Clearly the error term is heteroskedastic...</span>
<span class="sd">"""</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"data"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">x_data</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span>  <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">params_nls</span><span class="p">),</span> <span class="n">label</span><span class="o">=</span><span class="s2">"fitted"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'x'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'y'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=entire-extra">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Next step is to calculate the variance of the NLS estimator. Again, we can either use the exact analytical expressions or use numerical derivatives. We consider the analytical derivatives.
       </p>
       <p>
        We implement
       </p>
       $$
\begin{align}
\frac{1}{n} \sum_{i=1}^n \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta } \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta^\top }  &amp;amp;= \frac{1}{n} \sum_{i=1}^n e^{2\mathbf{x}_i^\top \beta}\mathbf{x}_i \mathbf{x}_i^\top \\
\frac{1}{n} \sum_{i=1}^n \sigma_i^2 \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta } \frac{\partial g_i(y_i, \mathbf{x}_i ;\beta)}{\partial \beta^\top }  &amp;amp;=  \frac{1}{n} \sum_{i=1}^n e^{-2\mathbf{x}_i^\top \beta} e^{2\mathbf{x}_i^\top \beta}\mathbf{x}_i \mathbf{x}_i^\top = \frac{1}{n} \sum_{i=1}^n \mathbf{x}_i \mathbf{x}_i^\top
\end{align}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=certain-brass">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_scores_g</span><span class="p">(</span><span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the score</span>
<span class="sd">    """</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)[:,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=married-mercury">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">scores_g</span> <span class="o">=</span> <span class="n">calculate_scores_g</span><span class="p">(</span><span class="n">params_nls</span><span class="p">,</span> <span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=tight-chicken">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">A</span> <span class="o">=</span> <span class="n">scores_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">scores_g</span>
<span class="n">B</span> <span class="o">=</span> <span class="n">scores_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">params_nls</span><span class="p">))</span> <span class="o">@</span> <span class="n">scores_g</span>
<span class="n">B_alt</span> <span class="o">=</span> <span class="n">scores_g</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">((</span><span class="n">y_data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">x_data</span> <span class="o">@</span> <span class="n">params_nls</span><span class="p">)</span> <span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">@</span> <span class="n">scores_g</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=weird-christmas">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">param_nls_cov_A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="c1">#&amp;lt;-- understates variance</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">][</span><span class="s1">'std1_A'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_nls_cov_A</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">][</span><span class="s1">'std2_A'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_nls_cov_A</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">param_nls_cov_B</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">B</span><span class="p">)</span> <span class="c1">#&amp;lt;-- understates variance</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">][</span><span class="s1">'std1_B'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_nls_cov_B</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">][</span><span class="s1">'std2_B'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_nls_cov_B</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>

<span class="n">param_nls_cov_sandwich</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">@</span> <span class="n">B</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="c1">#&amp;lt;-- valid estimator due to heteroskedasticity</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">][</span><span class="s1">'std1_SW'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_nls_cov_sandwich</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span>
<span class="n">res_dict</span><span class="p">[</span><span class="s1">'NLS'</span><span class="p">][</span><span class="s1">'std2_SW'</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">param_nls_cov_sandwich</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=frank-cleveland">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">param_nls_cov_A</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=chronic-cable">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">param_nls_cov_B</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=appreciated-investment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">param_nls_cov_sandwich</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=powerful-pontiac">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res_dict</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=aggregate-nitrogen">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Estimation-using-SciPy">
        Estimation using SciPy
        <a class="anchor-link" href="#Estimation-using-SciPy">
         ¶
        </a>
       </h2>
       <p>
        <code>
         scipy
        </code>
        provides MLE methods for implemented distributions (see e.g.
        <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.rv_continuous.fit.html">
         here
        </a>
        ). For instance, we can fit the parameters of a normal distribution.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=center-bouquet">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate Normal data and estimate parameters</span>
<span class="sd">"""</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mi">1</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mi">5</span>


<span class="n">norm_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="c1"># Known MLE </span>
<span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">norm_data</span><span class="p">)</span>
<span class="n">variance_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">norm_data</span><span class="p">)</span>
<span class="n">sigma_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">variance_est</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"MLE mu: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mu_est</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"MLE std: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma_est</span><span class="p">)</span> <span class="o">+</span> <span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>

<span class="c1"># fit using SciPy</span>
<span class="n">mu_scipy_est</span><span class="p">,</span> <span class="n">sigma_scipy_est</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">norm_data</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">"SciPy mu: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mu_scipy_est</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"SciPy std: "</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">sigma_scipy_est</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=regulation-bosnia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Estimation-using-Statsmodels">
        Estimation using Statsmodels
        <a class="anchor-link" href="#Estimation-using-Statsmodels">
         ¶
        </a>
       </h2>
       <p>
        <code>
         scipy
        </code>
        provides a quick MLE implementation for different distributions, but may not be applicable for more complicated problem.
       </p>
       <p>
        <code>
         statsmodels
        </code>
        provides a framework for implementing generic MLE estimators (see
        <a href="https://www.statsmodels.org/dev/examples/notebooks/generated/generic_mle.html">
         docs
        </a>
        ). Let us try to implement our exponential model using
        <code>
         statsmodels
        </code>
        !
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=healthy-scholarship">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">statsmodels.base.model</span> <span class="kn">import</span> <span class="n">GenericLikelihoodModel</span>

<span class="c1"># overwrite loglikelihood function in Generic Likelihood Class</span>
<span class="k">class</span> <span class="nc">Exponential</span><span class="p">(</span><span class="n">GenericLikelihoodModel</span><span class="p">):</span>
    
    <span class="k">def</span> <span class="nf">loglike</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
        <span class="n">exog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">exog</span>
        <span class="n">endog</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">endog</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">exog</span> <span class="o">@</span> <span class="n">params</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">exog</span> <span class="o">@</span> <span class="n">params</span><span class="p">)</span> <span class="o">*</span> <span class="n">endog</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>

<span class="c1"># fit models</span>
<span class="n">exponential_fit</span> <span class="o">=</span> <span class="n">Exponential</span><span class="p">(</span><span class="n">y_data</span><span class="p">,</span> <span class="n">x_data</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

<span class="c1"># print results</span>
<span class="nb">print</span><span class="p">(</span><span class="n">exponential_fit</span><span class="o">.</span><span class="n">summary</span><span class="p">())</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=respiratory-drill">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Our previous estimates</span>
<span class="sd">"""</span>

<span class="n">params_mle</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.cambridge.org/highereducation/books/microeconometrics/982158DE989697607C858068ED05C7B1#overview">
         Microeconometrics: Methods and Applications, Cameron and Trivedi (2005)
        </a>
       </p>
       <p>
        <a href="https://www.amazon.com/Econometric-Analysis-7th-William-Greene/dp/0131395386">
         Econometric Analysis 7th edition, William H. Greene (2012)
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="c1"># animations, etc. requires below magic command</span>
<span class="o">%</span><span class="k">matplotlib</span> ipympl

<span class="c1">#%matplotlib inline</span>

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="c1"># numpy for working with matrices and vectors</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># packages for plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span><span class="p">,</span> <span class="n">cm</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span><span class="p">,</span> <span class="n">rosen</span><span class="p">,</span> <span class="n">rosen_hess</span><span class="p">,</span> <span class="n">rosen_der</span><span class="p">,</span> <span class="n">rosen_hess_prod</span>

<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">HTML</span>


<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=deluxe-bunch">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Introduction-to-optimization">
        Introduction to optimization
        <a class="anchor-link" href="#Introduction-to-optimization">
         ¶
        </a>
       </h1>
       <p>
        <strong>
         Note:
        </strong>
        This lecture is inspired by
        <a href="https://www.cambridge.org/highereducation/books/microeconometrics/982158DE989697607C858068ED05C7B1#overview">
         Microeconometrics: Methods and Applications, Cameron and Trivedi (2005)
        </a>
       </p>
       <p>
        In financial economics, we are often interested in maximizing or minimizing a particular objective function, e.g  estimating parameters or maximizing utility. Generally, when we want to maximize (or minimize) a function of $n$ variables $f(\mathbf{x})$ where $\mathbf{x} \in \mathbb{R}^n$ then the necessary first order conditions (FOCs) are given by
       </p>
       \begin{equation*}
\frac{\partial f(\mathbf{x})}{\partial \mathbf{x}} = \mathbf{0}
\end{equation*}
       <p>
        In non-linear applications, it may be hard or even impossible to find an explicit solution to the first order conditions! In this Jupyter notebook, we will see how we can use numerical methods to solve optimization problems using the
        <code>
         scipy.optimize
        </code>
        package (see docs
        <a href="https://docs.scipy.org/doc/scipy/reference/optimize.html">
         here
        </a>
        ).
       </p>
       <p>
        A nice tutorial for the
        <code>
         scipy.optimize
        </code>
        package can be found
        <a href="https://docs.scipy.org/doc/scipy/tutorial/optimize.html">
         here
        </a>
        .
       </p>
       <h2 id="Grid-search">
        Grid search
        <a class="anchor-link" href="#Grid-search">
         ¶
        </a>
       </h2>
       <p>
        The most simple way of trying to maximize a function is to simply evaluate the function over a grid and choose input values that result in the largest function value as the solution.
       </p>
       <p>
        <code>
         scipy.optimize
        </code>
        provides the function
        <code>
         brute
        </code>
        that allows us to perform a grid search. Note that
        <code>
         scipy.optimize
        </code>
        always minimizes a function. This is not a problem since we can always redefine a maximization problem as a minimization problem by multiplying the objective function by minus one.
       </p>
       <p>
        <strong>
         Example:
        </strong>
       </p>
       <p>
        Minimize the function $f(x) = x^2$. The FOC is
       </p>
       $$
\frac{d f(x)}{d x} = 2 x = 0 \Rightarrow x = 0
$$
       <p>
        Let us try to solve with
        <code>
         brute
        </code>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=eastern-overhead">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">x_squared</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span>

<span class="c1"># Ns: number of grid points</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brute</span><span class="p">(</span><span class="n">x_squared</span><span class="p">,</span> <span class="n">ranges</span><span class="o">=</span><span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),),</span> <span class="n">Ns</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># global minimum</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=enormous-boston">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Note:
        </strong>
        Python has the
        <code>
         sympy
        </code>
        package to help with e.g. analytical derivatives
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=narrow-sheriff">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">sympy</span> <span class="kn">import</span> <span class="n">Symbol</span><span class="p">,</span> <span class="n">diff</span>
<span class="kn">from</span> <span class="nn">sympy.solvers</span> <span class="kn">import</span> <span class="n">solve</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">Symbol</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="n">func</span>  <span class="o">=</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="n">foc</span> <span class="o">=</span> <span class="n">diff</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="n">foc</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=boring-renewal">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solve the first order condition</span>
<span class="sd">"""</span>
<span class="n">solve</span><span class="p">(</span><span class="n">foc</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=artificial-match">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example:
        </strong>
       </p>
       <p>
        Minimize the function $f(x_1, x_1) = x_1^2 + x_2^2$. The FOCs are
       </p>
       $$
\begin{align}
\frac{\partial f(x_1, x_2)}{\partial x} &amp;amp;= 2 x_1 = 0 \Rightarrow x_1 = 0 \\
\frac{\partial f(x_1, x_2)}{\partial y} &amp;amp;= 2 x_2 = 0 \Rightarrow x_2 = 0
\end{align}
$$
       <p>
        Again, we can solve it with
        <code>
         brute
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=light-tumor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">x_squared</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    
    <span class="k">return</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brute</span><span class="p">(</span><span class="n">x_squared</span><span class="p">,</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">10</span><span class="p">,</span> <span class="mi">10</span><span class="p">)),</span> <span class="n">Ns</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">res</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="c1"># global minimum</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=amazing-current">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Problem">
        Problem
        <a class="anchor-link" href="#Problem">
         ¶
        </a>
       </h3>
       <p>
        If a very fine grid can be selected, we would be able to solve all optimization problems this way. However, this will often be practically impossible. With 10 variables with only 10 grid points then we would have to check $10^{10}$ (10 billion) different points!
       </p>
       <p>
        Nonetheless, grid search may be an important tool if other methods do not work and can be used to getting starting values for other optimization methods.
       </p>
       <h2 id="Gradient-based-methods">
        Gradient based methods
        <a class="anchor-link" href="#Gradient-based-methods">
         ¶
        </a>
       </h2>
       <p>
        In optimization, a gradient method is simply an algorithm to solve our optimization problem, e.g.
       </p>
       $$
\underset{\mathbf{x} \in \mathbb{R}^n}{\text{min}} f(\mathbf{x})
$$
       <p>
        with the search direction is defined by the gradient (vector of first order derivatives) at the current value of the input parameters. Gradient methods will generally be defined by the updating formula
       </p>
       $$
\mathbf{x}_{k+1} = \mathbf{x}_{k} + \mathbf{A}_k \mathbf{g}_k
$$
       <p>
        where $\mathbf{g}_k = \nabla f(\mathbf{x}_k)$ is the gradient and $\mathbf{A}_k$ is a matrix that depends on $\mathbf{x}$. 
Optimally, the $\mathbf{A}_k$ matrix is always  positive (negative) definite for maximization (minimization) problems.  A first order Taylor expansion evaluated at $\mathbf{x}_{k+1}$ gives
       </p>
       $$
f(\mathbf{x}_{k+1}) = f(\mathbf{x}_{k}) + \mathbf{g}_k ^\top (\mathbf{x}_{k+1} - \mathbf{x}_{k}) + R = f(\mathbf{x}_{k}) + \mathbf{g}_k ^\top \mathbf{A}_k \mathbf{g}_k + R
$$
       <p>
        where $R$ is the remainder. Thus, if $\mathbf{A}_k$ is positive definite ($\mathbf{g}_k ^\top \mathbf{A}_k \mathbf{g}_k &amp;gt; 0, \; \mathbf{g}  \neq \mathbf{0}$) the function value will be increasing (if the remainder is sufficiently small).
       </p>
       <p>
        A range of different extensions try to improve on the above updating formula. One example is
        <em>
         step-size adjustment
        </em>
        to prevent over- or undershooting:
       </p>
       $$
\mathbf{x}_{k+1} = \mathbf{x}_{k} + \lambda_k \mathbf{A}_k \mathbf{g}_k
$$
       <p>
        where $\lambda_k$ is selected using a line search to minimize or maximize $f(\mathbf{x}_{k+1})$. This may be particular usefull, when calculation of $\mathbf{A}_k$ is computationally hard.
       </p>
       <p>
        Another problem arise if $\mathbf{A}_k = \mathbf{B}_k^{-1}$ and $\mathbf{B}_k$ is close to singular, then a potential fix is to replace $\mathbf{B}_k$ with $\mathbf{B}_k + \mathbf{C}$ where $\mathbf{C}$ is a matrix of constants.
       </p>
       <h3 id="Newton-Raphson">
        Newton-Raphson
        <a class="anchor-link" href="#Newton-Raphson">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Newton%27s_method_in_optimization">
         Newton-Raphson method
        </a>
        is an iterative algorithm derived from a second order Taylor expansion of the objective function and the FOCs. Consider the one-dimesional problem
       </p>
       $$
\underset{x \in \mathbb{R}}{\text{min}} f(x)
$$
       <p>
        Assuming the starting value $x_0 \in \mathbb{R}$, then we can approximate the objective function (assuming it is twice differentiable)
       </p>
       $$
f(x_1) \approx f(x_0) + f' (x_0) (x_1 - x_0) + \frac{1}{2} f''(x_0) (x_1 - x_0)^2
$$
       <p>
        The FOC is given by
       </p>
       $$
\frac{d}{d x_1}\left(f(x_0) + f' (x_0) (x_1 - x_0) + \frac{1}{2} f''(x_0) (x_1 - x_0)^2 \right) = f'(x_0) + f''(x_0) (x_1 - x_0) = 0 
$$
       <p>
        Solving for $x_1$ yields
       </p>
       $$
x_1 = x_0 - \frac{f'(x_0)}{f''(x_0)}
$$
       <p>
        Using this procedure repeatedly gives the sequence
       </p>
       $$
x_{k+1} = x_{k} - \frac{f'(x_k)}{f''(x_k)}, \; \; k = 0, ..., N
$$
       <p>
        which under regularity conditions will converge to a local optimimum.
       </p>
       <p>
        <strong>
         Example:
        </strong>
       </p>
       <p>
        Minimize the function $f(x) = x^2$ using the Newton-Raphson method.
       </p>
       <p>
        We note that
       </p>
       $$
\begin{align}
f'(x) &amp;amp;= 2x \\
f''(x) &amp;amp;= 2
\end{align}
$$
       <p>
        Below we implement Newton's method and apply it.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ranking-watson">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">newton_raphson_univariate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">first_der</span><span class="p">,</span> <span class="n">second_der</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> 

    <span class="n">sequence</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="n">x_opt</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span> 
        <span class="n">x_opt</span> <span class="o">=</span>  <span class="n">x_opt</span> <span class="o">-</span> <span class="n">first_der</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span> <span class="o">/</span> <span class="n">second_der</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span>
        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">sequence</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=serial-basement">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x0</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="n">x_opt</span><span class="p">,</span> <span class="n">sequence</span> <span class="o">=</span> <span class="n">newton_raphson_univariate</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">25</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=infectious-wilson">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We see that the Newton-Raphson method converges after one iteration! This will be the case no matter the starting value (for this particular function)
       </p>
       $$
x_1 = x_0 - \frac{2 x_0}{2} = 0
$$
       <p>
        This is intuitive since the method approximates the objective function with a second order polynomial. When the objective is a second order polynomial, the approximation is exact and we only need one iteration. This will generally not be the case.
       </p>
       <p>
        <strong>
         Higher dimensions
        </strong>
       </p>
       <p>
        The one-dimensional algorithm can be generalized to higher dimensions such that
       </p>
       $$
\mathbf{x}_{k+1} = \mathbf{x}_k - \mathbf{H}_k^{-1} \mathbf{g}_k
$$
       <p>
        where $\mathbf{g}_k = \nabla f(\mathbf{x}_k)$ is the gradient and $\mathbf{H}_k = \nabla^2 f(\mathbf{x}_k)$ is the Hessian matrix.
       </p>
       <p>
        From the multi-dimensional Taylor approximation
       </p>
       $$
f(\mathbf{x}) \approx f(\mathbf{x}_{k}) + \mathbf{g}_k ^\top (\mathbf{x} - \mathbf{x}_{k}) + \frac{1}{2} (\mathbf{x} - \mathbf{x}_{k})^\top \mathbf{H}_k (\mathbf{x} - \mathbf{x}_{k})
$$
       <p>
        we obtain by using the solution $\mathbf{x}_{k+1} = \mathbf{x}_k - \mathbf{H}_k^{-1} \mathbf{g}_k$ and some matrix algebra that
       </p>
       $$
f(\mathbf{x}_{k+1}) \approx f(\mathbf{x}_{k}) - \frac{1}{2} (\mathbf{x}_{k+1} - \mathbf{x}_{k})^\top \mathbf{H}_k (\mathbf{x}_{k+1} - \mathbf{x}_{k})
$$
       <p>
        This makes it clear that the properties of the Hessian matrix are very important for convergence. E.g. if the Hessian is positive definite the function value will be decreasing. If the objective function is convex, then the Hessian matrix is positive definite over the whole domain and the method will most likely converge fast to the global minimum. However, for non-convex (and non-concave) objective functions the Hessian is not guaranteed to have nice properties and may even be singular.
       </p>
       <p>
        <strong>
         Example:
        </strong>
       </p>
       <p>
        Consider the
        <a href="https://en.wikipedia.org/wiki/Himmelblau%27s_function">
         Himmelblau function
        </a>
       </p>
       $$
f(x, y) = (x^2 + y - 11)^2 + (x + y^2 - 7)^2
$$
       <p>
        that has one local maxima and four local minima.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=personalized-cleaner">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">himmelblau</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> 
    
    <span class="n">z</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    
    <span class="k">return</span> <span class="n">z</span> 


<span class="sd">"""</span>
<span class="sd">Values to plot</span>
<span class="sd">"""</span>

<span class="n">himmelblau_plotting</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">himmelblau</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

<span class="c1"># define x and y</span>
<span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># create meshgrid</span>
<span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">)</span>
<span class="n">z_vals</span> <span class="o">=</span> <span class="n">himmelblau_plotting</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">3D plot</span>
<span class="sd">"""</span>

<span class="c1"># Initialize figure </span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">)</span>

<span class="c1"># Plot the surface</span>
<span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">,</span> <span class="n">z_vals</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$y$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">'$f(x,y)$'</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=medium-decade">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Contour plot</span>
<span class="sd">"""</span>

<span class="c1"># Initialize figure </span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

<span class="c1"># Plot the surface</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">,</span> <span class="n">z_vals</span><span class="p">,</span>
                 <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">181.0</span><span class="p">,</span> <span class="mf">210.0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">]))</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$y$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Himmelblau's function - level curves"</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=accredited-marble">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We want to implement the Newton-Raphson method to find a local optimimum of the Himmelblau's function.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=identical-carpet">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">newton_raphson</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> 
    
    <span class="n">sequence</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="n">x_opt</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span> 
        <span class="n">x_opt</span> <span class="o">=</span>  <span class="n">x_opt</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">hess</span><span class="p">(</span><span class="n">x_opt</span><span class="p">))</span> <span class="o">@</span> <span class="n">grad</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span>
        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sized-duplicate">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">grad_himmelblau</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    
    <span class="n">grad_x</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">grad_y</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">grad_x</span><span class="p">,</span> <span class="n">grad_y</span><span class="p">])</span>

<span class="k">def</span> <span class="nf">hess_himmelblau</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
    
    <span class="n">hess_xx</span> <span class="o">=</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">11</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span>
    <span class="n">hess_yy</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">+</span> <span class="mi">12</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">7</span><span class="p">)</span>
    <span class="n">hess_xy</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">hess_xx</span><span class="p">,</span> <span class="n">hess_xy</span><span class="p">],</span>
                     <span class="p">[</span><span class="n">hess_xy</span><span class="p">,</span> <span class="n">hess_yy</span><span class="p">]])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=honey-mongolia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_opt1</span><span class="p">,</span> <span class="n">sequence1</span> <span class="o">=</span> <span class="n">newton_raphson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]),</span> <span class="n">grad_himmelblau</span><span class="p">,</span> <span class="n">hess_himmelblau</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_opt1</span><span class="p">)</span>

<span class="n">x_opt2</span><span class="p">,</span> <span class="n">sequence2</span> <span class="o">=</span> <span class="n">newton_raphson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">grad_himmelblau</span><span class="p">,</span> <span class="n">hess_himmelblau</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_opt2</span><span class="p">)</span>

<span class="n">x_opt3</span><span class="p">,</span> <span class="n">sequence3</span> <span class="o">=</span> <span class="n">newton_raphson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">]),</span> <span class="n">grad_himmelblau</span><span class="p">,</span> <span class="n">hess_himmelblau</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_opt3</span><span class="p">)</span>

<span class="n">x_opt4</span><span class="p">,</span> <span class="n">sequence4</span> <span class="o">=</span> <span class="n">newton_raphson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">]),</span> <span class="n">grad_himmelblau</span><span class="p">,</span> <span class="n">hess_himmelblau</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_opt4</span><span class="p">)</span>

<span class="n">x_opt5</span><span class="p">,</span> <span class="n">sequence5</span> <span class="o">=</span> <span class="n">newton_raphson</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">4.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">4.0</span><span class="p">]),</span> <span class="n">grad_himmelblau</span><span class="p">,</span> <span class="n">hess_himmelblau</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">x_opt5</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=considered-confusion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">maxiter_used</span> <span class="o">=</span> <span class="mi">100</span>

<span class="sd">"""</span>
<span class="sd">Animation </span>
<span class="sd">"""</span>

<span class="c1"># Initialize figure </span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">))</span>

<span class="c1"># contour plot</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">,</span> <span class="n">z_vals</span><span class="p">,</span>
                 <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">181.0</span><span class="p">,</span> <span class="mf">210.0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">]))</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$y$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Himmelblau's function - converging to optimum"</span><span class="p">);</span>


<span class="c1"># scatter plot with optimal value</span>
<span class="n">scatter1</span><span class="p">,</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">sequence1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sequence1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"o"</span><span class="p">)</span>

<span class="n">scatter2</span><span class="p">,</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sequence2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sequence2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"o"</span><span class="p">)</span>

<span class="n">scatter3</span><span class="p">,</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sequence3</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sequence3</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">"green"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"o"</span><span class="p">)</span>

<span class="n">scatter4</span><span class="p">,</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sequence2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sequence2</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"o"</span><span class="p">)</span>

<span class="n">scatter5</span><span class="p">,</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sequence3</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sequence3</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">"cyan"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"o"</span><span class="p">)</span>

<span class="c1"># animation </span>
<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>

    <span class="n">scatter1</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">sequence1</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sequence1</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">scatter2</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">sequence2</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sequence2</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">scatter3</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">sequence3</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sequence3</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="n">scatter4</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">sequence4</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sequence4</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>

    <span class="n">scatter5</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">sequence5</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sequence5</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>    
    
    <span class="k">return</span> <span class="n">scatter1</span><span class="p">,</span> <span class="n">scatter2</span><span class="p">,</span> <span class="n">scatter3</span><span class="p">,</span> <span class="n">scatter4</span><span class="p">,</span> <span class="n">scatter5</span>

<span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">maxiter_used</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=brilliant-virgin">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We clearly see that the local optimum reached by the method is highly dependent on the starting value!
       </p>
       <p>
        <strong>
         SciPy implementations
        </strong>
       </p>
       <p>
        <code>
         scipy.optimize.minimize
        </code>
        has several algorithms closely related to the above Newton-Raphson method but more robust, e.g.
       </p>
       <ul>
        <li>
         Newton-Conjugate-Gradient algorithm (
         <code>
          Newton-CG
         </code>
         )
        </li>
        <li>
         Trust-Region Newton-Conjugate-Gradient algorithm (
         <code>
          trust-ncg
         </code>
         )
        </li>
        <li>
         Trust-Region Truncated Generalized Lanczos / Conjugate Gradient algorithm (
         <code>
          trust-krylov
         </code>
         )
        </li>
       </ul>
       <p>
        Consider a 2-dimensional version of the
        <a href="https://en.wikipedia.org/wiki/Rosenbrock_function">
         Rosenbrock function
        </a>
       </p>
       $$
f(x,y)=(1-x)^{2}+100(y-x^{2})^{2}
$$
       <p>
        with a unique minimum at $(x, y) = (1,1)$. Below, we apply the Newton-Conjugate-Gradient algorithm.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dominant-insulation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1">#from scipy.optimize import minimize</span>

<span class="n">x0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.5</span><span class="p">,</span><span class="mf">0.5</span><span class="p">]</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">rosen</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'Newton-CG'</span><span class="p">,</span>
               <span class="n">jac</span><span class="o">=</span><span class="n">rosen_der</span><span class="p">,</span> <span class="n">hess</span><span class="o">=</span><span class="n">rosen_hess</span><span class="p">,</span>
               <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'xtol'</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span>  <span class="c1"># 'xtol' controls the convergence based on the change in the optimization variable, </span>
                                       <span class="c1"># see also 'ftol', 'gtol', 'maxiter'</span>
                        <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>

<span class="nb">print</span><span class="p">(</span><span class="s1">'Minimum at: '</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=equivalent-debate">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Gradient-descent-(or-ascent)">
        Gradient descent (or ascent)
        <a class="anchor-link" href="#Gradient-descent-(or-ascent)">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Gradient_descent">
         gradient descent (ascent) method
        </a>
        applies the simple choice of a scaled identity matrix in the gradient based method $\mathbf{A}_k = \lambda_k \mathbf{I}$ such that the updating formula becomes (we will have a negative $\lambda_k$ when minimizing)
       </p>
       $$
\mathbf{x}_{k+1} = \mathbf{x}_{k} + \lambda_k \mathbf{I} \mathbf{g}_k = \mathbf{x}_{k} + \lambda_k \mathbf{g}_k
$$
       <p>
        Inuitively, the method takes a step in the direction of fastest increase. The method does not require computation of the Hessian, however the optimal learning rate $\lambda_k$ can be shown to depend on the Hessian (based on a Taylor approximation)
       </p>
       $$
\lambda_k = -\frac{\mathbf{g}_k^\top \mathbf{g}_k}{\mathbf{g}_k^\top \mathbf{H}_k \mathbf{g}_k}
$$
       <p>
        Using this formula does not require the Hessian to be non-singular, but for e.g. minimization it needs to be positive definite. There exists other Hessian free methods to set the learning rate.
       </p>
       <p>
        Not utilizing the Hessian in determining the direction in the updating formula may lead to slow convergence since the information about curvature of the function is not taken into account.
       </p>
       <p>
        Again, we consider the Rosenbrock function and try to minimize it using the Newton-Raphson and gradient descent methods.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=moral-reception">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">gradient_descent</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">grad</span><span class="p">,</span> <span class="n">hess</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">):</span> 
    
    <span class="n">sequence</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
    
    <span class="n">x_opt</span> <span class="o">=</span> <span class="n">x0</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span> 
        
        <span class="n">g</span> <span class="o">=</span> <span class="n">grad</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span>
        <span class="n">h</span> <span class="o">=</span> <span class="n">hess</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span>
        
        <span class="c1"># optimal learning rate </span>
        <span class="n">opt_l</span> <span class="o">=</span> <span class="o">-</span><span class="n">g</span> <span class="o">@</span> <span class="n">g</span> <span class="o">/</span> <span class="p">(</span><span class="n">g</span> <span class="o">@</span> <span class="n">h</span> <span class="o">@</span> <span class="n">g</span><span class="p">)</span>
        
        <span class="n">x_opt</span> <span class="o">=</span>  <span class="n">x_opt</span> <span class="o">+</span> <span class="n">opt_l</span> <span class="o">*</span> <span class="n">g</span> 
        
        <span class="n">sequence</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x_opt</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">x_opt</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=rough-douglas">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">])</span>

<span class="n">x_gd_opt1</span><span class="p">,</span> <span class="n">sequence_dg_1</span> <span class="o">=</span> <span class="n">gradient_descent</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">rosen_der</span><span class="p">,</span> <span class="n">rosen_hess</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>

<span class="n">x_nr_opt1</span><span class="p">,</span> <span class="n">sequence_nr_1</span> <span class="o">=</span> <span class="n">newton_raphson</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">rosen_der</span><span class="p">,</span> <span class="n">rosen_hess</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=fdfea68c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_gd_opt1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=80aa3fae">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_nr_opt1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=vertical-riding">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Values to plot</span>
<span class="sd">"""</span>

<span class="n">rosen_bivariate</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">rosen</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

<span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">)</span>
<span class="n">z_vals</span> <span class="o">=</span> <span class="n">rosen_bivariate</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=korean-cleanup">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">3D plot</span>
<span class="sd">"""</span>

<span class="c1"># Initialize figure </span>
<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="n">projection</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">)</span>

<span class="c1"># Plot the surface</span>
<span class="n">surf</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">,</span> <span class="n">z_vals</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cm</span><span class="o">.</span><span class="n">jet</span><span class="p">,</span> <span class="n">linewidth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">antialiased</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                       <span class="n">vmin</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$y$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">'$f(x,y)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=unlimited-warren">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">maxiter_used</span> <span class="o">=</span> <span class="mi">201</span>

<span class="sd">"""</span>
<span class="sd">Animation </span>
<span class="sd">"""</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>

<span class="c1"># contour plot</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">,</span> <span class="n">z_vals</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">]))</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># scatter plot with optimal value</span>
<span class="n">scatter1</span><span class="p">,</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">sequence_dg_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sequence_dg_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Gradient Descent"</span><span class="p">)</span> <span class="c1">#, marker="o")</span>

<span class="n">scatter2</span><span class="p">,</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">sequence_nr_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">],</span> <span class="n">sequence_nr_1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Newton-Raphson"</span><span class="p">)</span> <span class="c1">#, marker="o")</span>

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>

<span class="c1"># animation </span>
<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>

    <span class="n">scatter1</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">sequence_dg_1</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sequence_dg_1</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    <span class="n">scatter2</span><span class="o">.</span><span class="n">set_data</span><span class="p">(</span><span class="n">sequence_nr_1</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">sequence_nr_1</span><span class="p">[:</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="n">scatter1</span><span class="p">,</span> <span class="n">scatter2</span>

<span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">maxiter_used</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=passing-caribbean">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Clearly, gradient descent method exhibits slow convergence. The Rosenbrock function has a narrow curved valley which contains the minimum. The bottom of the valley is very flat. Because of the curved flat valley the optimization is zigzagging slowly with small step sizes towards the minimum.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=aggressive-extraction">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Non-gradient-based-methods">
        Non-gradient based methods
        <a class="anchor-link" href="#Non-gradient-based-methods">
         ¶
        </a>
       </h2>
       <h3 id="The-Nelder-Mead-Simplex-Algorithm">
        The Nelder-Mead Simplex Algorithm
        <a class="anchor-link" href="#The-Nelder-Mead-Simplex-Algorithm">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Nelder%E2%80%93Mead_method">
         Nelder-Mead algorithm
        </a>
        is a derivative free numerical method for solving minimization and maximization problems that uses the concept of a simplex, e.g. a triangle in two dimensions (we have a function of two variables). The algorithm is purely based on function evaluations and different rules of how to contruct a new simplex
       </p>
       <ol>
        <li>
         Ordering of points in the simplex
        </li>
        <li>
         Calculation of centroid
        </li>
        <li>
         Reflection
        </li>
        <li>
         Contraction
        </li>
        <li>
         Shrinkage
        </li>
       </ol>
       <p>
        The figure below illustrate the concept (one of many iterations)
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=prescription-running">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">12</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="c1"># initial simplex </span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">p1</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">([(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)],</span><span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'b'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">p1</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Initial simplex"</span><span class="p">)</span>
<span class="c1">#ax.axis('equal')</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>

<span class="c1"># center of gravity</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'b'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Centroid"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"worst point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"best point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"centroid"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>


<span class="c1"># reflection </span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'gray'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'b'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">label</span> <span class="o">=</span> <span class="s2">"New simplex"</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Reflection"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"worst point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"centroid"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"green"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"reflection"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"best point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># contraction</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'gray'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'b'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="o">-</span><span class="mf">0.25</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.25</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'g'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">"New simplex"</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Contraction </span><span class="se">\n</span><span class="s2"> Reflection point increase function value"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"worst point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"centroid"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"best point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Expansion </span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'gray'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'b'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'g'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">label</span> <span class="o">=</span> <span class="s2">"New simplex"</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Expansion </span><span class="se">\n</span><span class="s2"> Reflection point descrease function value"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"worst point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"centroid"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"best point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="c1"># Shrinkage  </span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">axes</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span> <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'gray'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],[</span><span class="mf">0.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'b'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">Polygon</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">2</span> <span class="o">-</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,],</span>
                      <span class="p">[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]],</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'g'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">label</span> <span class="o">=</span> <span class="s2">"New simplex"</span><span class="p">))</span>


<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="o">-</span><span class="mf">1.1</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Shrinkage </span><span class="se">\n</span><span class="s2"> Contraction increase function value"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s2">"off"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"worst point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"centroid"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"yellow"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"best point"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=further-mongolia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Below, we implement the Nelder-Mead described using the algoirthm outlined on
        <a href="https://en.wikipedia.org/wiki/Nelder%E2%80%93Mead_method">
         Wikipedia
        </a>
        and apply it on the Rosenbrock function.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=buried-virus">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_initial_simplex</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">h</span><span class="p">):</span>
    
    <span class="n">x1</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">x0</span> <span class="o">+</span> <span class="n">h</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">nealder_mead</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">rho</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">initial_simplex</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">tol</span><span class="o">=</span><span class="mf">1e-16</span><span class="p">):</span> 
    
    <span class="n">all_simplex</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    
    <span class="k">if</span> <span class="n">initial_simplex</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">initial_simplex</span> <span class="o">=</span>  <span class="n">calculate_initial_simplex</span><span class="p">(</span><span class="n">x0</span><span class="p">,</span> <span class="n">h</span><span class="p">)</span>
        
    <span class="n">simplex</span> <span class="o">=</span> <span class="n">initial_simplex</span>
    <span class="n">all_simplex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simplex</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">maxiter</span><span class="p">):</span> 
        
        <span class="c1"># calculate function values and sort (we want to sort on the function value)</span>
        <span class="n">sorted_pointes</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">([(</span><span class="n">_</span><span class="p">,</span><span class="n">f</span><span class="p">(</span><span class="n">_</span><span class="p">))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">simplex</span><span class="p">],</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="n">best</span> <span class="o">=</span> <span class="n">sorted_pointes</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mid</span> <span class="o">=</span> <span class="n">sorted_pointes</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">worst</span> <span class="o">=</span> <span class="n">sorted_pointes</span><span class="p">[</span><span class="mi">2</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        
        <span class="c1"># termination </span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">([</span><span class="n">f</span><span class="p">(</span><span class="n">best</span><span class="p">),</span> <span class="n">f</span><span class="p">(</span><span class="n">mid</span><span class="p">),</span> <span class="n">f</span><span class="p">(</span><span class="n">worst</span><span class="p">)])</span> <span class="o">&amp;lt;</span> <span class="n">tol</span><span class="p">:</span>
            <span class="k">break</span> 
        
        <span class="c1"># calculate centroid</span>
        <span class="n">centroid</span> <span class="o">=</span> <span class="p">(</span><span class="n">best</span> <span class="o">+</span> <span class="n">mid</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
        
        <span class="c1"># reflection </span>
        <span class="n">reflect</span> <span class="o">=</span> <span class="n">centroid</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="p">(</span><span class="n">centroid</span> <span class="o">-</span> <span class="n">worst</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">best</span><span class="p">)</span> <span class="o">&amp;lt;=</span> <span class="n">f</span><span class="p">(</span><span class="n">reflect</span><span class="p">)</span> <span class="o">&amp;lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span> 
            <span class="n">worst</span> <span class="o">=</span> <span class="n">reflect</span>
            
        <span class="c1"># expansion </span>
        <span class="k">elif</span> <span class="n">f</span><span class="p">(</span><span class="n">reflect</span><span class="p">)</span> <span class="o">&amp;lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">best</span><span class="p">):</span> 
            <span class="n">expand</span> <span class="o">=</span> <span class="n">centroid</span> <span class="o">+</span> <span class="n">gamma</span> <span class="o">*</span> <span class="p">(</span><span class="n">reflect</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">expand</span><span class="p">)</span> <span class="o">&amp;lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">reflect</span><span class="p">):</span>
                <span class="n">worst</span> <span class="o">=</span> <span class="n">expand</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">worst</span> <span class="o">=</span> <span class="n">reflect</span>
        
        <span class="c1"># contract </span>
        <span class="k">elif</span> <span class="n">f</span><span class="p">(</span><span class="n">reflect</span><span class="p">)</span> <span class="o">&amp;gt;=</span> <span class="n">f</span><span class="p">(</span><span class="n">mid</span><span class="p">):</span> 
            <span class="n">contract</span> <span class="o">=</span> <span class="n">centroid</span> <span class="o">+</span> <span class="n">rho</span> <span class="o">*</span> <span class="p">(</span><span class="n">worst</span> <span class="o">-</span> <span class="n">centroid</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">contract</span><span class="p">)</span> <span class="o">&amp;lt;</span> <span class="n">f</span><span class="p">(</span><span class="n">worst</span><span class="p">):</span>
                <span class="n">worst</span> <span class="o">=</span> <span class="n">contract</span>
                
            <span class="c1"># shrink</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">mid</span> <span class="o">=</span> <span class="n">best</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">*</span><span class="p">(</span><span class="n">mid</span> <span class="o">-</span> <span class="n">best</span><span class="p">)</span>
                <span class="n">worst</span> <span class="o">=</span> <span class="n">best</span> <span class="o">+</span> <span class="n">sigma</span><span class="o">*</span><span class="p">(</span><span class="n">worst</span> <span class="o">-</span> <span class="n">best</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
            
        <span class="n">simplex</span> <span class="o">=</span> <span class="p">(</span><span class="n">best</span><span class="p">,</span> <span class="n">mid</span><span class="p">,</span> <span class="n">worst</span><span class="p">)</span>
        
        <span class="n">all_simplex</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">simplex</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="p">{</span><span class="s1">'opt'</span><span class="p">:</span> <span class="n">best</span><span class="p">,</span> <span class="s1">'all_simplex'</span><span class="p">:</span> <span class="n">all_simplex</span><span class="p">}</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=surface-stuart">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">res1</span> <span class="o">=</span> <span class="n">nealder_mead</span><span class="p">(</span><span class="n">rosen</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">]))</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res1</span><span class="p">[</span><span class="s1">'opt'</span><span class="p">])</span>

<span class="n">res2</span> <span class="o">=</span> <span class="n">nealder_mead</span><span class="p">(</span><span class="n">rosen</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">h</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res2</span><span class="p">[</span><span class="s1">'opt'</span><span class="p">])</span>

<span class="n">res3</span> <span class="o">=</span> <span class="n">nealder_mead</span><span class="p">(</span><span class="n">rosen</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">h</span><span class="o">=</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res3</span><span class="p">[</span><span class="s1">'opt'</span><span class="p">])</span>

<span class="n">res4</span> <span class="o">=</span> <span class="n">nealder_mead</span><span class="p">(</span><span class="n">rosen</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]),</span> <span class="n">h</span><span class="o">=</span><span class="mf">3.0</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">res4</span><span class="p">[</span><span class="s1">'opt'</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=proud-young">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Values to plot</span>
<span class="sd">"""</span>

<span class="n">rosen_bivariate</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">rosen</span><span class="p">([</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">])</span>

<span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">y_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">y_vals</span><span class="p">)</span>
<span class="n">z_vals</span> <span class="o">=</span> <span class="n">rosen_bivariate</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=optical-lightning">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">maxiter_used</span> <span class="o">=</span> <span class="mi">99</span>

<span class="sd">"""</span>
<span class="sd">Animation </span>
<span class="sd">"""</span>

<span class="c1"># results to be used </span>
<span class="n">results</span> <span class="o">=</span> <span class="n">res4</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">axes</span><span class="p">(</span><span class="n">xlim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">),</span> <span class="n">ylim</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">))</span>

<span class="c1"># contour plot</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x_mesh</span><span class="p">,</span> <span class="n">y_mesh</span><span class="p">,</span> <span class="n">z_vals</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">10.0</span><span class="p">,</span> <span class="mf">25.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">,</span> <span class="mf">100.0</span><span class="p">,</span> <span class="mf">250.0</span><span class="p">,</span> <span class="mf">500.0</span><span class="p">]))</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>

<span class="c1"># polygon </span>
<span class="n">start</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">'all_simplex'</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">Polygon</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">edgecolor</span> <span class="o">=</span> <span class="s1">'r'</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">patch</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">a</span><span class="p">)</span> 

<span class="c1"># scatter plot with optimal value</span>
<span class="n">scatter</span><span class="p">,</span>  <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'all_simplex'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">results</span><span class="p">[</span><span class="s1">'all_simplex'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                    <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s2">"o"</span><span class="p">)</span>

<span class="c1"># animation </span>
<span class="k">def</span> <span class="nf">animate</span><span class="p">(</span><span class="n">i</span><span class="p">):</span>
    <span class="n">patch</span><span class="o">.</span><span class="n">set_xy</span><span class="p">(</span><span class="n">results</span><span class="p">[</span><span class="s1">'all_simplex'</span><span class="p">][</span><span class="n">i</span><span class="p">])</span>
    <span class="n">scatter</span><span class="o">.</span><span class="n">set_data</span><span class="p">([</span><span class="n">results</span><span class="p">[</span><span class="s1">'all_simplex'</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="n">results</span><span class="p">[</span><span class="s1">'all_simplex'</span><span class="p">][</span><span class="n">i</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span>
    
    <span class="k">return</span> <span class="n">patch</span><span class="p">,</span> <span class="n">scatter</span>

<span class="n">anim</span> <span class="o">=</span> <span class="n">animation</span><span class="o">.</span><span class="n">FuncAnimation</span><span class="p">(</span><span class="n">fig</span><span class="p">,</span> <span class="n">animate</span><span class="p">,</span> <span class="n">frames</span><span class="o">=</span><span class="n">maxiter_used</span><span class="p">,</span> <span class="n">interval</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">blit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">repeat</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=reserved-offer">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Applying the method (probably a more robust version, than the one implemented above) from
        <code>
         scipy.optimize
        </code>
        , we would do the following
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=rising-millennium">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">rosen</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'nelder-mead'</span><span class="p">,</span>
               <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'xatol'</span><span class="p">:</span> <span class="mf">1e-8</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span> <span class="s1">'return_all'</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span>
<span class="c1"># </span>
<span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=infinite-concord">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Global-optimization-in-SciPy">
        Global optimization in SciPy
        <a class="anchor-link" href="#Global-optimization-in-SciPy">
         ¶
        </a>
       </h2>
       <p>
        We are interest in solving the unconstrained minimization problem
       </p>
       $$
\underset{\mathbf{x} \in \mathbb{R}^n}{\text{min}} f(\mathbf{x})
$$
       <p>
        So far, we have looked at algorithms that are able to find a local minimum, but we cannot be sure that the obtained solution in fact minimize the function on the whole domain if the function has many local minima.
       </p>
       <p>
        This motivates the use of
        <a href="https://en.wikipedia.org/wiki/Global_optimization">
         global optimization methods
        </a>
        that efficiently search the parameter space and that may use local minimizers under the hood.
       </p>
       <p>
        In the
        <code>
         Scipy
        </code>
        <a href="https://docs.scipy.org/doc/scipy/tutorial/optimize.html">
         tutorial
        </a>
        , the eggholder function, which is notourisly hard to optimize due to many local minima, is considered
       </p>
       $$
f(x,y) = -(y + 47) \sin \left(\sqrt{\left \vert y + x / 2 + 47 \right \vert} \right) - x \sin \left(\sqrt{\left \vert x - y - 47 \right \vert }  \right)
$$
       <p>
        The function has a global minima at $f(512, 404.2319) = -959.6407$ if we only define it for $x, y \in [-512, 512]$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=impressed-campbell">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">eggholder</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
     <span class="k">return</span> <span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="mi">47</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">+</span> <span class="mi">47</span><span class="p">))))</span>
             <span class="o">-</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>  <span class="o">+</span> <span class="mi">47</span><span class="p">)))))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=joint-separation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">512</span><span class="p">,</span> <span class="mi">513</span><span class="p">)</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="mi">512</span><span class="p">,</span> <span class="mi">513</span><span class="p">)</span>

<span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">xy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">stack</span><span class="p">([</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">])</span>

<span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="s1">'3d'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">view_init</span><span class="p">(</span><span class="mi">45</span><span class="p">,</span> <span class="o">-</span><span class="mi">45</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot_surface</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">eggholder</span><span class="p">(</span><span class="n">xy</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span> <span class="s1">'terrain'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'y'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_zlabel</span><span class="p">(</span><span class="s1">'eggholder(x, y)'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=necessary-cache">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">eggholder</span><span class="p">(</span><span class="n">xy</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">900</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'y'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=established-stomach">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <code>
         Scipy
        </code>
        contains the global optimizers
       </p>
       <ul>
        <li>
         <p>
          <code>
           basinhopping
          </code>
          (
          <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.basinhopping.html#scipy.optimize.basinhopping">
           <code>
            SciPy
           </code>
           docs
          </a>
          ,
          <a href="https://en.wikipedia.org/wiki/Basin-hopping">
           Wikipedia article
          </a>
          )
         </p>
        </li>
        <li>
         <p>
          <code>
           brute
          </code>
          (
          <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.brute.html#scipy.optimize.brute">
           <code>
            SciPy
           </code>
           docs
          </a>
          )
         </p>
        </li>
        <li>
         <p>
          <code>
           differential_evolution
          </code>
          (
          <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.differential_evolution.html#scipy.optimize.differential_evolution">
           <code>
            SciPy
           </code>
           docs
          </a>
          ,
          <a href="https://en.wikipedia.org/wiki/Differential_evolution">
           Wikipedia article
          </a>
          )
         </p>
        </li>
        <li>
         <p>
          <code>
           shgo
          </code>
          (simplicial homology global optimization) (
          <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.shgo.html#scipy.optimize.shgo">
           <code>
            SciPy
           </code>
           docs
          </a>
          )
         </p>
        </li>
        <li>
         <p>
          <code>
           dual_annealing
          </code>
          (
          <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.dual_annealing.html#scipy.optimize.dual_annealing">
           <code>
            SciPy
           </code>
           docs
          </a>
          ,
          <a href="https://en.wikipedia.org/wiki/Simulated_annealing">
           Wikipedia article
          </a>
          )
         </p>
        </li>
       </ul>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=human-holder">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Basinhopping</span>

<span class="sd">We make sure to only apply the optimizer on the relevant interval. </span>
<span class="sd">"""</span>

<span class="c1"># bounds that we will be using</span>
<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="o">-</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)]</span>
<span class="c1"># dict for storing results</span>
<span class="n">results</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>

<span class="n">results</span><span class="p">[</span><span class="s1">'basinhopping'</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">basinhopping</span><span class="p">(</span><span class="n">eggholder</span><span class="p">,</span>
                                                <span class="p">[</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">],</span>
                                                <span class="n">minimizer_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">"method"</span><span class="p">:</span><span class="s2">"L-BFGS-B"</span><span class="p">,</span> <span class="s2">"bounds"</span><span class="p">:</span><span class="n">bounds</span><span class="p">},</span>
                                                <span class="n">niter</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span>
                                                <span class="n">stepsize</span><span class="o">=</span><span class="mf">20.0</span><span class="p">,</span> 
                                                <span class="n">seed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">777</span><span class="p">))</span>
<span class="n">results</span><span class="p">[</span><span class="s1">'basinhopping'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=continued-trace">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Brute - takes some time ...</span>
<span class="sd">"""</span>

<span class="n">results</span><span class="p">[</span><span class="s1">'brute'</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">brute</span><span class="p">(</span><span class="n">eggholder</span><span class="p">,</span> <span class="p">[</span><span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="o">-</span><span class="mi">512</span><span class="p">,</span> <span class="mi">512</span><span class="p">)],</span> <span class="n">Ns</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">full_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">finish</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
<span class="n">results</span><span class="p">[</span><span class="s1">'brute'</span><span class="p">]</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=weird-authority">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Differential evolution </span>
<span class="sd">"""</span>

<span class="n">results</span><span class="p">[</span><span class="s1">'dif_evo'</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">differential_evolution</span><span class="p">(</span><span class="n">eggholder</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">maxiter</span><span class="o">=</span><span class="mi">10000</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="n">results</span><span class="p">[</span><span class="s1">'dif_evo'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=friendly-yahoo">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">shgo</span>
<span class="sd">"""</span>

<span class="n">results</span><span class="p">[</span><span class="s1">'shgo'</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">shgo</span><span class="p">(</span><span class="n">eggholder</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">64</span><span class="p">,</span> <span class="n">sampling_method</span><span class="o">=</span><span class="s1">'sobol'</span><span class="p">)</span>
<span class="n">results</span><span class="p">[</span><span class="s1">'shgo'</span><span class="p">]</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">results</span><span class="p">[</span><span class="s1">'shgo'</span><span class="p">]</span><span class="o">.</span><span class="n">fun</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=found-knowing">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">all_minima_found</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="s1">'shgo'</span><span class="p">]</span><span class="o">.</span><span class="n">xl</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
<span class="n">cs</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">xgrid</span><span class="p">,</span> <span class="n">ygrid</span><span class="p">,</span> <span class="n">eggholder</span><span class="p">(</span><span class="n">xy</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">900</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">all_minima_found</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">all_minima_found</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'y'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">clabel</span><span class="p">(</span><span class="n">cs</span><span class="p">,</span> <span class="n">inline</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">10</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=relative-concord">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">dual annealing</span>
<span class="sd">"""</span>

<span class="n">results</span><span class="p">[</span><span class="s1">'dual_an'</span><span class="p">]</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">dual_annealing</span><span class="p">(</span><span class="n">eggholder</span><span class="p">,</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>
<span class="n">results</span><span class="p">[</span><span class="s1">'dual_an'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fundamental-naples">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Bounded-and-constrained-optimization-in-SciPy">
        Bounded and constrained optimization in SciPy
        <a class="anchor-link" href="#Bounded-and-constrained-optimization-in-SciPy">
         ¶
        </a>
       </h2>
       <p>
        Above we have looked at some examples of numerical optimizers for unbounded and unconstrained problems.
        <code>
         scipy.optimize.minimize
        </code>
        implements a range of different unconstrained optimizers (see
        <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize">
         here
        </a>
        ). However, in many application we need to either bound the domain or implement contraints. Luckily,
        <code>
         scipy.optimize.minimize
        </code>
        also implements a range of methods for "bound-constrained" and "constrained" minimization (see
        <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.optimize.minimize.html#scipy.optimize.minimize">
         here
        </a>
        for a full list).
       </p>
       <p>
        <strong>
         Bounded optimization
        </strong>
       </p>
       <p>
        The default "bound-constrained" minimizer is
        <a href="https://docs.scipy.org/doc/scipy/reference/optimize.minimize-lbfgsb.html#optimize-minimize-lbfgsb">
         <code>
          L-BFGS-B
         </code>
        </a>
        (
        <a href="https://en.wikipedia.org/wiki/Broyden%E2%80%93Fletcher%E2%80%93Goldfarb%E2%80%93Shanno_algorithm">
         see also
        </a>
        ).
       </p>
       <p>
        <strong>
         Example:
        </strong>
       </p>
       <p>
        Again consider the Himmelblau function
       </p>
       $$
f(x, y) = (x^2 + y - 11)^2 + (x + y^2 - 7)^2
$$
       <p>
        We want to implement the minimization problem
       </p>
       $$
\underset{x,y}{\text{arg min}} f(x, y)
$$
       <p>
        subject to
       </p>
       $$
x \in (-\infty, 0] \\
y \in (-\infty, 0]
$$
       <p>
        A simple implementation with SciPy is
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=alien-aircraft">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">bounds</span> <span class="o">=</span> <span class="p">((</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">))</span>

<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">himmelblau</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.5</span><span class="p">],</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s1">'L-BFGS-B'</span><span class="p">)</span>
<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=lined-treasury">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Constrained optimization
        </strong>
       </p>
       <p>
        An example of a constrained minimization problem is
       </p>
       $$
\underset{x,y}{\text{arg min}} f(x,y)=(1-x)^{2}+100(y-x^{2})^{2} \\
$$
       <p>
        subject to
       </p>
       $$
\begin{align}
x + 2y &amp;amp;\leq 1 \\
x^2 + y &amp;amp;\leq 1 \\
x^2 - y &amp;amp;\leq 1 \\
2 x + y &amp;amp;= 1 \\
0 \leq x &amp;amp;\leq 1 \\
-0.5 \leq y &amp;amp;\leq 2.0
\end{align}
$$
       <p>
        One available algorithm for solving such a problem is the
        <a href="https://docs.scipy.org/doc/scipy/reference/optimize.minimize-slsqp.html#optimize-minimize-slsqp">
         <code>
          SLSQP
         </code>
        </a>
        algorithm that implements
        <a href="https://en.wikipedia.org/wiki/Sequential_quadratic_programming">
         sequential least squares programming
        </a>
        . Both linear and nonlinear constraints are defined as dictionaries with keys
        <code>
         type
        </code>
        ,
        <code>
         fun
        </code>
        and
        <code>
         jac
        </code>
        .
        <code>
         type
        </code>
        refers to whether we are dealing with a equality ('eq') or inequality constraint ('ineq'),
        <code>
         fun
        </code>
        is the function defining the constraint, and
        <code>
         jac
        </code>
        is a function defining the
        <a href="https://en.wikipedia.org/wiki/Jacobian_matrix_and_determinant">
         Jacobian matrix
        </a>
        . Note that e.g. the constraint $x + 2y \leq 1$ can be written as $1 - x - 2y \geq 0$ which is the format we need to provide to the optimizer.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=above-national">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define constraints</span>
<span class="n">ineq_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'ineq'</span><span class="p">,</span>
             <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>  <span class="c1"># expression larger than zero! </span>
                                         <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                                         <span class="mi">1</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]]),</span>
             <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="o">-</span><span class="mf">2.0</span><span class="p">],</span>
                                         <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">],</span>
                                         <span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mf">1.0</span><span class="p">]])}</span>
<span class="n">eq_cons</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span>
           <span class="s1">'fun'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">2</span><span class="o">*</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]),</span> <span class="c1"># expression equal to zero</span>
           <span class="s1">'jac'</span> <span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])}</span>

<span class="n">bounds</span> <span class="o">=</span> <span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="p">(</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">2.0</span><span class="p">)]</span>

<span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.5</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">minimize</span><span class="p">(</span><span class="n">rosen</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">'SLSQP'</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">rosen_der</span><span class="p">,</span>
               <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">eq_cons</span><span class="p">,</span> <span class="n">ineq_cons</span><span class="p">],</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">'ftol'</span><span class="p">:</span> <span class="mf">1e-9</span><span class="p">,</span> <span class="s1">'disp'</span><span class="p">:</span> <span class="kc">True</span><span class="p">},</span>
               <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">)</span>

<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=light-irish">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [ ]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.cambridge.org/highereducation/books/microeconometrics/982158DE989697607C858068ED05C7B1#overview">
         Microeconometrics: Methods and Applications, Cameron and Trivedi (2005)
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span> 

<span class="c1"># plotting libraries</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">matplotlib.ticker</span> <span class="k">as</span> <span class="nn">ticker</span>
<span class="kn">import</span> <span class="nn">datetime</span>

<span class="c1"># scipy for statistics and optimization</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>

<span class="c1"># cvxpy</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>

<span class="c1"># typehints</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.statistics.moments</span> <span class="kn">import</span> <span class="n">corr_to_cov_matrix</span>
<span class="kn">from</span> <span class="nn">codelib.statistics</span> <span class="kn">import</span> <span class="n">moments</span>

<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization</span> <span class="kn">import</span> <span class="n">risk_metrics</span> <span class="k">as</span> <span class="n">rm</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization</span> <span class="kn">import</span> <span class="n">risk_budget</span> <span class="k">as</span> <span class="n">rb</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization</span> <span class="kn">import</span> <span class="n">diversification</span> <span class="k">as</span> <span class="n">dm</span>

<span class="c1"># exponential probabilites</span>
<span class="kn">from</span> <span class="nn">codelib.statistics.historical_probabilities</span> <span class="kn">import</span> <span class="n">calculate_exponential_decay_probabilities</span>



<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span><span class="p">,</span> <span class="n">default_colors</span>
<span class="n">DefaultStyle</span><span class="p">();</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">risk_waterfall_chart</span><span class="p">,</span> <span class="n">waterfall_chart</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=22ad2cab">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Portfolio-Heuristics-and-Risk-based-Strategies">
        Portfolio Heuristics and Risk based Strategies
        <a class="anchor-link" href="#Portfolio-Heuristics-and-Risk-based-Strategies">
         ¶
        </a>
       </h1>
       <p>
        Last week, we discussed some of the issues with classical Mean-Variance optimization. The main problem is that estimation uncertainty may result in far from optimal portfolios which can lead to bad out-of-sample properties. This notebook discuss some of the pragmatic alternatives based on heuristics such as the naive portfolio ($1 / N$) and the most diversified portfolio.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=80a99760">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Risk-based-portfolios">
        Risk based portfolios
        <a class="anchor-link" href="#Risk-based-portfolios">
         ¶
        </a>
       </h2>
       <p>
        From last week, we know that an investor with quadratic utility
       </p>
       $$
U(\mathbf{w}) = \mathbf{w}^\top \boldsymbol{\mu} - \frac{\lambda}{2} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        the optimal portfolio for the simplest case with no constraint is given by
       </p>
       $$
\mathbf{w}^* = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1} \boldsymbol{\mu} 
$$
       <p>
        The derivative of the optimal portfolio weights wrt. the expected return vector is given by
       </p>
       $$
\frac{\partial \mathbf{w}^*}{\partial \boldsymbol{\mu}} = \frac{1}{\lambda} \boldsymbol{\Sigma}^{-1}
$$
       <p>
        This illustrates that the optimal portfolio is highly sensitive to the estimated expected returns which have led many academics and practioners to use purely risk based portfolios, relying on e.g. only the covariance matrix.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5433f7ea">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Minimum-variance-portfolios">
        Minimum variance portfolios
        <a class="anchor-link" href="#Minimum-variance-portfolios">
         ¶
        </a>
       </h3>
       <p>
        As discussed in previous, the minimum variance portfolio is the solution to the below problem.
       </p>
       $$
\mathbf{w}^* = \underset{\mathbf{w}}{\text{arg min }} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to relevant constraints, e.g. a budget constraint and a positivity constraints
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
w_i &amp;amp;\geq 0 \; \text{ for } i=1,\dots, N
\end{align}
$$
       <p>
        <strong>
         Example: Finding the minimum-variance portfolio using
         <code>
          CVXPY
         </code>
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=8cdc1535">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define relevant quantities</span>
<span class="sd">"""</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>


<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="n">rf</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># assume that the risk free rate is zero </span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">vols</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="c1"># constant Sharpe ratio</span>

<span class="c1"># transform to covariance matrix using previously defined function (imported at the top of the notebook)</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>

<span class="c1"># number of assets</span>
<span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4757fa87">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solve for the minimum-variance weights </span>
<span class="sd">"""</span>
<span class="c1"># optimization variable</span>
<span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

<span class="c1"># define constraints </span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">==</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">w</span><span class="o">&amp;gt;=</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># define problem </span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span> <span class="o">@</span> <span class="n">w</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

<span class="c1"># solve problem </span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># print weights </span>
<span class="n">df_port_w</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">w</span><span class="o">.</span><span class="n">value</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s1">'Asset 1'</span><span class="p">,</span> <span class="s1">'Asset 2'</span><span class="p">,</span> <span class="s1">'Asset 3'</span><span class="p">],</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">'$w_{min-var}$'</span><span class="p">],</span> <span class="p">)</span>
<span class="n">df_port_w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=dcaad2c8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Risk-budgetting-portfolios">
        Risk budgetting portfolios
        <a class="anchor-link" href="#Risk-budgetting-portfolios">
         ¶
        </a>
       </h3>
       <p>
        We know that we can write the portfolio standard deviation as
       </p>
       $$
\sigma_p(\mathbf{w}) = \mathbf{w}^\top \frac{\boldsymbol{\Sigma} \mathbf{w} }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = \sum_{i=1}^N w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = \sum_{i=1}^N w_i \text{MR}_i = \sum_{i=1}^N \text{RC}_i
$$
       <p>
        where $\text{MR}_i = \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}}$ is the marginal risk of asset $i$ and $\text{RC}_i$ is the risk contribution of asset $i$.
       </p>
       <p>
        There is a large literature on
        <em>
         risk parity investing
        </em>
        where the focus is on allocating risk instead of capital, e.g. we want an equal amount of risk coming from bonds and stocks. The problem that we want to solve is
       </p>
       $$
w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}} = b_i  \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}}
$$
       <p>
        where $b_i$ is the risk coming from the $i$'th asset. In addition, we would likely impose positivity contraints $b_i \geq 0, w_i \geq 0$, weights summing to one $\sum_{i=1}^N w_i = 1$, and $\sum_{i=1}^N b_i = 1$.
       </p>
       <p>
        We have previously seen how we can solve this problem in the two asset case - now we will look at the more general case!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a36ce363">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Solving-for-the-risk-budgetting-weights">
        Solving for the risk budgetting weights
        <a class="anchor-link" href="#Solving-for-the-risk-budgetting-weights">
         ¶
        </a>
       </h3>
       <p>
        Since we know that
       </p>
       $$
w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}} = b_i 
$$
       <p>
        We could find the risk budgetting portfolio as
       </p>
       $$
\mathbf{w}^* = \arg \min \sum_{i=1}^N \left(w_i \frac{(\boldsymbol{\Sigma} \mathbf{w})_i }{\mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}} - b_i \right)^2
$$
       <p>
        subject to
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
w_i &amp;amp;\geq 0 \; \text{ for } i=1,\dots, N
\end{align}
$$
       <p>
        <strong>
         Example: Find the risk budget portfolio
        </strong>
       </p>
       <p>
        We continue with the same assumptions as in the previous example. We seek to find the equal risk contribution weights.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=87e2a409">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">risk_budget_objective</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                          <span class="n">b</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span> 
    
    <span class="k">if</span> <span class="n">b</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
        <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">weights</span><span class="p">)</span>
    
    <span class="n">rc</span> <span class="o">=</span> <span class="n">rb</span><span class="o">.</span><span class="n">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">rc</span> <span class="o">-</span> <span class="n">b</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">100</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=8c9ba86e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">init_w</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span> <span class="o">/</span> <span class="n">num_assets</span>

<span class="n">budget_constraint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span> <span class="s1">'fun'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">w</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">}</span>

<span class="n">res_rb</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">risk_budget_objective</span><span class="p">,</span> <span class="n">x0</span><span class="o">=</span><span class="n">init_w</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,),</span>
                           <span class="n">constraints</span><span class="o">=</span><span class="p">(</span><span class="n">budget_constraint</span><span class="p">),</span>
                           <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)]</span> <span class="o">*</span> <span class="n">num_assets</span><span class="p">)</span>

<span class="n">df_port_w</span><span class="p">[</span><span class="s1">'$w_</span><span class="si">{rb}</span><span class="s1">$'</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_rb</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6eee527a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_port_w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f914a3e9">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">rb</span><span class="o">.</span><span class="n">calculate_risk_contributions_std</span><span class="p">(</span><span class="n">df_port_w</span><span class="p">[</span><span class="s1">'$w_</span><span class="si">{rb}</span><span class="s1">$'</span><span class="p">],</span> <span class="n">cov_mat</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">waterfall_chart</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">risk_contrib</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="n">df_port_w</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                          <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span>
                          <span class="n">total_label</span><span class="o">=</span><span class="s2">"Total risk (std)"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Risk contribution (std)"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Risk contribution - Equal risk contribution"</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=e31d1004">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Risk-budgetting-portfolios-as-a-convex-optimization-problem">
        Risk budgetting portfolios as a convex optimization problem
        <a class="anchor-link" href="#Risk-budgetting-portfolios-as-a-convex-optimization-problem">
         ¶
        </a>
       </h3>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2009778">
         Bruder and Roncalli (2012), "Managing Risk Exposures using
the Risk Budgeting Approach"
        </a>
        suggest an alternative optimization problem that also gives the risk budgetting portfolio
       </p>
       $$
\mathbf{x}^* = \arg \min \mathbf{x}^\top \boldsymbol{\Sigma} \mathbf{x}
$$
       <p>
        subjet to
       </p>
       $$
\begin{align}
\mathbf{b}^\top \ln \mathbf{x} &amp;amp;\geq c \\
\mathbf{x} &amp;amp;\geq \mathbf{0}
\end{align}
$$
       <p>
        Finally, define
       </p>
       $$
\mathbf{w}^* = \frac{\mathbf{x}^*}{\mathbf{1}^\top \mathbf{x}^*}
$$
       <p>
        such that the portfolio weights sum to one.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=eaffb36d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

<span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">num_assets</span>
<span class="n">c</span> <span class="o">=</span> <span class="mf">0.1</span>

<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">&amp;gt;=</span> <span class="mf">0.0001</span><span class="p">,</span>
               <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">&amp;gt;=</span> <span class="n">c</span><span class="p">]</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="n">w</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=cf57e4f9">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Naive-Risk-Parity">
        Naive Risk Parity
        <a class="anchor-link" href="#Naive-Risk-Parity">
         ¶
        </a>
       </h3>
       <p>
        In the naive risk parity portfolio the allocation to a specific asset is based on the inverse volatility portfolio
       </p>
       $$
\mathbf{w}_{\text{IV}} = \left[\frac{1 / \sigma_1}{\sum_{i=1}^N 1 / \sigma_i}, ..., \frac{1 / \sigma_N}{\sum_{i=1}^N 1 / \sigma_i} \right]^\top
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=121dc334">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_naive_risk_parity</span><span class="p">(</span><span class="n">vols</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculate the inverse volatility weights </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    vols: </span>
<span class="sd">        Volatilites. </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Portfolio weights. </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="n">inv_vols</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">vols</span>
    <span class="n">sum_inv_vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">inv_vols</span><span class="p">)</span>
    
    <span class="n">w_iv</span> <span class="o">=</span> <span class="n">inv_vols</span> <span class="o">/</span> <span class="n">sum_inv_vols</span>
    
    <span class="k">return</span> <span class="n">w_iv</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=718d769c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_port_w</span><span class="p">[</span><span class="s1">'$w_{inv-vol}$'</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_naive_risk_parity</span><span class="p">(</span><span class="n">vols</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5ce210cd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_port_w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=78483edb">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="A-simulation-study-comparing-the-risk-based-strategies">
        A simulation study comparing the risk-based strategies
        <a class="anchor-link" href="#A-simulation-study-comparing-the-risk-based-strategies">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ab539c9e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define functions to calculate optimal portfolios</span>
<span class="sd">"""</span>
    
    
<span class="k">def</span> <span class="nf">calculate_risk_parity</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>  
    
    <span class="n">num_assets</span> <span class="o">=</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

    <span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">num_assets</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mf">0.1</span>

    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">&amp;gt;=</span> <span class="mf">0.0001</span><span class="p">,</span>
                   <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">b</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="o">&amp;gt;=</span> <span class="n">c</span><span class="p">]</span>

    <span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

    <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span> <span class="o">/</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    
    
<span class="k">def</span> <span class="nf">calculate_minimum_variance</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
    
    <span class="n">num_assets</span> <span class="o">=</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># optimization variable</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

    <span class="c1"># define constraints </span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">==</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">w</span><span class="o">&amp;gt;=</span><span class="mi">0</span><span class="p">]</span>

    <span class="c1"># define problem </span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span> <span class="o">@</span> <span class="n">w</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>

    <span class="c1"># solve problem </span>
    <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">prob</span><span class="o">.</span><span class="n">status</span> <span class="o">==</span> <span class="s1">'optimal'</span><span class="p">:</span> 
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span>
    <span class="k">else</span><span class="p">:</span> 
        <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s2">"SCS"</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=2480fdc6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Generate data </span>
<span class="sd">"""</span>

<span class="n">T</span> <span class="o">=</span> <span class="mi">60</span>

<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">])</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.12</span><span class="p">,</span> <span class="mf">8.0</span><span class="p">,</span> <span class="mf">8.2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">12.0</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="c1">#mu_2 = np.array([3.2, 3.22, 8.4, 8.2]) / 100.0</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">sim_cov_mat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">wishart</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span> <span class="o">=</span> <span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span> <span class="o">=</span> <span class="n">cov_mat</span> <span class="o">/</span> <span class="n">T</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span> 
<span class="c1">#sim_corr_mat = np.array([cov_to_corr_matrix(sim_cov_mat[i]) for i in range(num_sim)])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ee17a447">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Find optimal portfolios </span>
<span class="sd">"""</span>

<span class="n">rp_ports</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">calculate_risk_parity</span><span class="p">(</span><span class="n">sim_cov_mat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                     <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">)])</span>
<span class="n">naive_rp_ports</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">calculate_naive_risk_parity</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">sim_cov_mat</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                           <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">)])</span>
<span class="n">min_var_ports</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">calculate_minimum_variance</span><span class="p">(</span><span class="n">sim_cov_mat</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
                          <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">)])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=10efef36">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">rp_ports</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Naive Risk Parity"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">naive_rp_ports</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Risk Parity"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">min_var_ports</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum Variance"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Allocation to asset 1"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=86517916">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Evaluate portfolio std.</span>
<span class="sd">"""</span>
<span class="n">rp_port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span>
                                  <span class="n">rp_ports</span><span class="p">,</span> <span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>
<span class="n">naive_rp_port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">naive_rp_ports</span><span class="p">,</span> <span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>
<span class="n">min_var_port_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">min_var_ports</span><span class="p">,</span> <span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">rp_port_std</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Naive Risk Parity"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">naive_rp_port_std</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Risk Parity"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">min_var_port_std</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum Variance"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Portfolio standard deviation"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=710cf5ee">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Evaluate portfolio mean</span>
<span class="sd">"""</span>
<span class="n">rp_port_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_mean</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rp_ports</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">))</span>
<span class="n">naive_rp_port_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_mean</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">naive_rp_ports</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">))</span>
<span class="n">min_var_port_mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">apply_along_axis</span><span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_mean</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">min_var_ports</span><span class="p">,</span> <span class="p">(</span><span class="n">mu</span><span class="p">))</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">rp_port_mu</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Naive Risk Parity"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">naive_rp_port_mu</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Risk Parity"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">min_var_port_mu</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum Variance"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Portfolio mean"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=dd243441">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Evaluate Sharp - zero risk free</span>
<span class="sd">"""</span>
<span class="n">rp_port_sr</span> <span class="o">=</span> <span class="n">rp_port_mu</span> <span class="o">/</span> <span class="n">rp_port_std</span>
<span class="n">naive_rp_port_sr</span> <span class="o">=</span> <span class="n">naive_rp_port_mu</span> <span class="o">/</span> <span class="n">naive_rp_port_std</span>
<span class="n">min_var_port_sr</span> <span class="o">=</span> <span class="n">min_var_port_mu</span> <span class="o">/</span> <span class="n">min_var_port_std</span>


<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">rp_port_sr</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Naive Risk Parity"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">naive_rp_port_sr</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Risk Parity"</span><span class="p">)</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">min_var_port_sr</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Minimum Variance"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Portfolio Sharpe Ratio"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=8e9f3cc6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Most-Diversified-Portfolio">
        Most Diversified Portfolio
        <a class="anchor-link" href="#Most-Diversified-Portfolio">
         ¶
        </a>
       </h2>
       <p>
        Another approach is to focus directly on diversification.
        <a href="https://www.tobam.fr/wp-content/uploads/2014/12/TOBAM-JoPM-Maximum-Div-2008.pdf">
         Choueifaty and Caignard (2008), "Toward Maximum Diversification"
        </a>
        defines the diversification ratio
       </p>
       $$
\text{CC}(\mathbf{w}, \boldsymbol{\Sigma}) = \frac{\mathbf{w}^\top \mathbf{v}}{ \sqrt{\mathbf{w}^\top \boldsymbol{\Sigma}\mathbf{w}}} = \frac{\sum_{i=1}^N w_i \sigma_i}{\sqrt{ \mathbf{w}^\top \boldsymbol{\Sigma}\mathbf{w}}}
$$
       <p>
        where $\boldsymbol{\Sigma}$ is the covariance matrix and $\mathbf{v}$ is the vector of volatilities. The maximum diversification portfolio can be obtained as
       </p>
       \begin{align*}
    \max_{\mathbf{w}}  \quad &amp;amp; \text{CC}(\mathbf{w}, \boldsymbol{\Sigma}) \\
    \textrm{s.t.} \quad &amp;amp; \mathbf{w}^\top \mathbf{1} = 1 \\
     &amp;amp; w_i \geq 0, \; i=1,...,N
\end{align*}
       <p>
        <strong>
         Example: Implementing the most diversified portfolio
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=716e120c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_cc_ratio</span><span class="p">(</span><span class="n">weights</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the diversification ratio of Chouefaty and Coignard (2008)</span>

<span class="sd">    .. math::</span>

<span class="sd">        \\begin{equation}</span>
<span class="sd">            \\text{GLR}(w, \\Sigma) = \\frac{\\sum_{i=1}^N w_i \\sigma_i}{\\sqrt{w^{\\top} \\Sigma w}}</span>
<span class="sd">        \\end{equation}</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    weights:</span>
<span class="sd">        Portfolio weights.</span>
<span class="sd">    cov_mat:</span>
<span class="sd">        Covariance matrix.</span>
<span class="sd">        </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    float</span>
<span class="sd">        Diversification ratio.</span>
<span class="sd">    """</span>

    <span class="n">port_std</span> <span class="o">=</span> <span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">(</span><span class="n">weights</span><span class="o">=</span><span class="n">weights</span><span class="p">,</span> <span class="n">cov_mat</span><span class="o">=</span><span class="n">cov_mat</span><span class="p">)</span>

    <span class="n">vol_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>
    <span class="n">avg_std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">inner</span><span class="p">(</span><span class="n">weights</span><span class="p">,</span> <span class="n">vol_vec</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">avg_std</span> <span class="o">/</span> <span class="n">port_std</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a97a9c89">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define relevant quantities</span>
<span class="sd">"""</span>
<span class="n">corr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                 <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>


<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">])</span>

<span class="n">rf</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="c1"># assume that the risk free rate is zero </span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">vols</span> <span class="o">*</span> <span class="mf">0.2</span> <span class="c1"># constant Sharpe ratio</span>

<span class="c1"># transform to covariance matrix using previously defined function (imported at the top of the notebook)</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>

<span class="c1"># number of assets</span>
<span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=bf097e1f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_most_diversified_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">init_weights</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
    
    <span class="c1"># define intial values</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">init_weights</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">init_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">n</span><span class="p">)</span>
    
    <span class="c1"># define sum to one constraint</span>
    <span class="n">eq_constraint</span> <span class="o">=</span> <span class="p">{</span><span class="s1">'type'</span><span class="p">:</span> <span class="s1">'eq'</span><span class="p">,</span> <span class="s1">'fun'</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">}</span>
    
    <span class="c1"># perform optimization</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="o">-</span><span class="n">calculate_cc_ratio</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span> <span class="o">*</span> <span class="mi">100</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span> <span class="n">init_weights</span><span class="p">,</span>
                            <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">eq_constraint</span><span class="p">,],</span> <span class="n">bounds</span><span class="o">=</span><span class="p">[(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span><span class="o">*</span><span class="n">n</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f0e83f90">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_port_w</span><span class="p">[</span><span class="s1">'$w_</span><span class="si">{cc}</span><span class="s1">$'</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_most_diversified_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
<span class="n">df_port_w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=2a424adf">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Correlation between assets and CC-portfolio</span>
<span class="sd">"""</span>

<span class="n">w_cc</span> <span class="o">=</span> <span class="n">df_port_w</span><span class="p">[</span><span class="s1">'$w_</span><span class="si">{cc}</span><span class="s1">$'</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
<span class="n">idx</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">pick_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">pick_vec</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>

<span class="n">w_cc</span> <span class="o">@</span> <span class="n">cov_mat</span> <span class="o">@</span> <span class="n">pick_vec</span> <span class="o">/</span> <span class="p">(</span><span class="n">rm</span><span class="o">.</span><span class="n">calculate_portfolio_std</span><span class="p">(</span><span class="n">w_cc</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span> <span class="o">*</span> <span class="n">vols</span><span class="p">[</span><span class="n">idx</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=6f64eb84">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Norm-and-diversification-constraints">
        Norm and diversification constraints
        <a class="anchor-link" href="#Norm-and-diversification-constraints">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.jstor.org/stable/40539189">
         Victor DeMiguel, Lorenzo Garlappi, Francisco J. Nogales and Raman Uppal (2009), "A Generalized Approach to Portfolio Optimization: Improving Performance by Constraining Portfolio Norms"
        </a>
        discuss different norm constraints in the context of the minimum-variance portfolio. One example is the use of a 2-norm constraint:
       </p>
       \begin{align*}
    \min_{\mathbf{w}}  \quad &amp;amp; \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}\\
    \textrm{s.t.} \quad &amp;amp; \mathbf{w}^\top \mathbf{1} = 1 \\
     &amp;amp; w_i \geq 0, \; i=1,...,N \\
     &amp;amp; \Vert \mathbf{w} \Vert_2 \leq \delta
\end{align*}
       <p>
        Note that
       </p>
       $$
\Vert \mathbf{w} \Vert_2 = \sum_{i=1}^N w_i^2 
$$
       <p>
        Thus, if $\delta = 1/N$ then we will end up with the naive, equally weighted portfolio. We can therefore think of this constraints as a restriction of how far we can deviate from the $1/N$ portfolio.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=b74c4916">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_minimum_variance_norm</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">delta</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span> 
    
    <span class="n">num_assets</span> <span class="o">=</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># optimization variable</span>
    <span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

    <span class="c1"># define constraints </span>
    <span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span><span class="o">==</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">w</span><span class="o">&amp;gt;=</span><span class="mi">0</span><span class="p">,</span>
                   <span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_assets</span><span class="p">))</span> <span class="o">&amp;lt;=</span> <span class="n">delta</span><span class="p">]</span>

    <span class="c1"># define problem </span>
    <span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">w</span> <span class="o">@</span> <span class="n">cov_mat</span> <span class="o">@</span> <span class="n">w</span><span class="p">),</span> <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
    
    <span class="c1"># solve problem </span>
    <span class="k">try</span><span class="p">:</span>  
        <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
    <span class="k">except</span><span class="p">:</span> 
        <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">solver</span><span class="o">=</span><span class="s2">"SCS"</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">w</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=95d742f7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_port_w</span><span class="p">[</span><span class="s1">'$w_{min-var, L2}$'</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_minimum_variance_norm</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.4</span><span class="p">)</span>
<span class="n">df_port_w</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=25a256d2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Application:-Industry-Portfolios">
        Application: Industry Portfolios
        <a class="anchor-link" href="#Application:-Industry-Portfolios">
         ¶
        </a>
       </h2>
       <p>
        We consider an asset allocation exercise on a industry portfolio data set.
       </p>
       <p>
        We seek to, for each time step,
       </p>
       <ul>
        <li>
         Calculate the covariance matrix
        </li>
        <li>
         Calculate optimal portfolios using some of the present "heuristic" methods
        </li>
       </ul>
       <p>
        Based on the obtained portfolios, we evaluate the performance for the strategies.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0449e233">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">pandas_datareader.famafrench</span> <span class="kn">import</span> <span class="n">FamaFrenchReader</span><span class="p">,</span> <span class="n">get_available_datasets</span>


<span class="sd">"""</span>
<span class="sd">Obtain Fama-French Industry portfolios since 1970</span>
<span class="sd">"""</span>

<span class="n">ff_dict</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s1">'49_Industry_Portfolios'</span><span class="p">,</span>
                           <span class="n">start</span><span class="o">=</span><span class="s1">'1970-01-01'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="n">ff_daily_dict</span> <span class="o">=</span> <span class="n">FamaFrenchReader</span><span class="p">(</span><span class="s1">'49_Industry_Portfolios_Daily'</span><span class="p">,</span>
                                 <span class="n">start</span><span class="o">=</span><span class="s1">'2000-01-01'</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>  <span class="c1"># , end='2020-01-01'</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e53d7963">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ff_dict</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=30092981">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ff_daily_dict</span><span class="p">[</span><span class="s1">'DESCR'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=278326ad">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Get Market Cap weights for each month</span>
<span class="sd">"""</span>

<span class="c1"># market capitialization for each sector </span>
<span class="n">df_mc</span> <span class="o">=</span> <span class="n">ff_dict</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">*</span> <span class="n">ff_dict</span><span class="p">[</span><span class="mi">5</span><span class="p">]</span>

<span class="c1"># total market cap. for each month</span>
<span class="n">total_mc</span> <span class="o">=</span>  <span class="n">df_mc</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="c1"># relative weights </span>
<span class="n">df_weights</span> <span class="o">=</span> <span class="n">df_mc</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">total_mc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span> 

<span class="c1"># show weights</span>
<span class="n">df_weights</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=5fafa729">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Set color map for better visualization </span>
<span class="sd">"""</span>
<span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">'jet'</span><span class="p">)</span>
<span class="n">ind_colors</span> <span class="o">=</span> <span class="n">cmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">49</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d16e3240">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Plotting-market-cap-weights-over-time">
        Plotting market cap weights over time
        <a class="anchor-link" href="#Plotting-market-cap-weights-over-time">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ee70c93c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Portfolio weights over time</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">df_weights</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">to_timestamp</span><span class="p">(),</span>
              <span class="n">df_weights</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
              <span class="n">edgecolor</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span>
              <span class="n">labels</span><span class="o">=</span><span class="n">df_weights</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
              <span class="n">colors</span><span class="o">=</span><span class="n">ind_colors</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Sector weight'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Sector weights </span><span class="se">\n</span><span class="s2"> Fama-French Industry Portfolios"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">));</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=0f51c6b4">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        A simplistic or naive view of portfolio diversification is to look at the number of constituents in the portfolios or the portfolio weights. One possibility is to use the norm of the portfolio weight vector, $\mathbf{w}$, to determine the Effective Number of Constituents (ENC)  (valid for any $\alpha &amp;gt; 0$ if weights are all positive)
       </p>
       \begin{equation*}
\text{ENC}_{\alpha} (\mathbf{w}) = \Vert \mathbf{w} \Vert_{\alpha}^{\frac{\alpha}{1 - \alpha}} = \left(\sum_{i=1}^N w_i^\alpha \right)^{\frac{1}{1-\alpha}}, \; \; \alpha &amp;gt; 0, \; \alpha \neq 1
\end{equation*}
       <p>
        where $N$ denote the number of assets. If $\alpha = 2$, the diversification measure is equal to the inverse of the \href{
        <a href="https://en.wikipedia.org/wiki/Herfindahl%E2%80%93Hirschman_index%7D%7BHerfindahl">
         https://en.wikipedia.org/wiki/Herfindahl%E2%80%93Hirschman_index%7D%7BHerfindahl
        </a>
        index}
       </p>
       \begin{equation*}
\text{ENC}_{2} (\mathbf{w}) = \frac{1}{\sum_{i=1}^N w_i^2}
\end{equation*}
       <p>
        In the limiting case when $\alpha \to 1$, we obtain the exponential of the entropy of the distribution of the portfolio weight vector
       </p>
       \begin{equation*}
\text{ENC}_{1} = \exp \left( - \sum_{i=1}^N w_i \ln w_i\right)
\end{equation*}
       <p>
        <strong>
         Note:
        </strong>
        The function to calculate ENC is defined in
        <code>
         codelib.portfolio_optimization.diversification
        </code>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=de5bbce2">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate Effective Number of Constituents (ENC) based on market capitialization</span>
<span class="sd">"""</span>

<span class="n">df_enc1</span> <span class="o">=</span> <span class="n">df_weights</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">calculate_enc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_enc2</span> <span class="o">=</span> <span class="n">df_weights</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">dm</span><span class="o">.</span><span class="n">calculate_enc</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,))</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">df_enc1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">alpha=1$"</span><span class="p">)</span>
<span class="n">df_enc2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"$</span><span class="se">\\</span><span class="s2">alpha=2$"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">49</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">'gray'</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">'--'</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Equal weighted portfolio"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">([</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">50.0</span><span class="p">])</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"ENC"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Effective Number of Constituents (ENC) </span><span class="se">\n</span><span class="s2"> Fama-French Industry Portfolios"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fa052d9d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Finding-%22optimal%22-portfolios">
        Finding "optimal" portfolios
        <a class="anchor-link" href="#Finding-%22optimal%22-portfolios">
         ¶
        </a>
       </h3>
       <p>
        We choose an estimation horizon of one week since it provides a good trade off between the number of independent observations and the homogeneity of the data.
       </p>
       <p>
        Furthermore, we choose to use Exponential Weighted Moving Average (EWMA) filter to estimate the covariance matrix. We apply a window of 5 years of weekly observations and a half-life of 104 weeks (2 years).
       </p>
       <p>
        I use the "Average Value weighted Returns", but you can also choose to use the "Average Equal Weighted Returns".
       </p>
       <p>
        To perform the analysis, we can use
        <code>
         calculate_exponential_decay_probabilities
        </code>
        to calculate exponential probabilities. Given the probabilities, we can use
        <code>
         calculate_cov_mat
        </code>
        to calculate the covariance matrix. To calculate the risk contributions, we can use
        <code>
         calculate_risk_contributions_std
        </code>
        . All functions are imported in the begining of the notebook.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=fc44e20a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate daily total return index</span>
<span class="sd">"""</span>

<span class="n">ff_daily_ret</span> <span class="o">=</span> <span class="n">ff_daily_dict</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mi">100</span> <span class="c1"># daily ret trans</span>
<span class="n">ff_daily_prices</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">ff_daily_ret</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span>

<span class="sd">"""</span>
<span class="sd">Calculate weekly prices and return index</span>
<span class="sd">"""</span>

<span class="n">ff_weekly_prices</span> <span class="o">=</span> <span class="n">ff_daily_prices</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">'W-WED'</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span>  <span class="c1"># W-WED</span>
<span class="n">ff_weekly_ret</span> <span class="o">=</span> <span class="n">ff_weekly_prices</span> <span class="o">/</span> <span class="n">ff_weekly_prices</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">ff_weekly_prices</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="mi">1</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=bc2331b4">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Initialize values</span>
<span class="sd">"""</span>

<span class="c1"># number of periods</span>
<span class="n">num_periods</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="p">)</span>

<span class="c1"># number of factors</span>
<span class="n">num_assets</span> <span class="o">=</span> <span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="c1"># window size </span>
<span class="n">window_size</span> <span class="o">=</span>  <span class="mi">52</span> <span class="o">*</span> <span class="mi">5</span> <span class="c1"># 5 years of weekly observations </span>

<span class="c1"># effective number of periods</span>
<span class="n">eff_num_periods</span> <span class="o">=</span> <span class="n">num_periods</span> <span class="o">-</span> <span class="n">window_size</span>

<span class="c1"># half-life</span>
<span class="n">half_life</span> <span class="o">=</span> <span class="mi">104</span>

<span class="c1"># time points</span>
<span class="n">time_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">window_size</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="c1"># exponential probabilities </span>
<span class="n">exp_probs</span> <span class="o">=</span> <span class="n">calculate_exponential_decay_probabilities</span><span class="p">(</span><span class="n">window_size</span><span class="p">,</span> <span class="n">time_points</span><span class="p">,</span> <span class="n">half_life</span><span class="p">)</span>

<span class="c1"># equally weighted portfolio</span>
<span class="n">eq_weigts</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">num_assets</span><span class="p">,</span> <span class="n">num_assets</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=64aa320a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate optimal portfolios</span>
<span class="sd">"""</span>

<span class="n">most_div_port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">eff_num_periods</span><span class="p">,</span> <span class="n">num_assets</span><span class="p">))</span>
<span class="n">min_var_port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">eff_num_periods</span><span class="p">,</span> <span class="n">num_assets</span><span class="p">))</span>
<span class="n">min_var_norm_port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">eff_num_periods</span><span class="p">,</span> <span class="n">num_assets</span><span class="p">))</span>
<span class="n">rp_port_weights</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">eff_num_periods</span><span class="p">,</span> <span class="n">num_assets</span><span class="p">))</span>

<span class="n">cc_ratios</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eff_num_periods</span><span class="p">)</span>
<span class="n">most_div_port_cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eff_num_periods</span><span class="p">)</span>
<span class="n">min_var_port_cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eff_num_periods</span><span class="p">)</span>
<span class="n">min_var_norm_port_cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eff_num_periods</span><span class="p">)</span>
<span class="n">rp_port_cc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">eff_num_periods</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Perform calculations</span>
<span class="sd">"""</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">eff_num_periods</span><span class="p">):</span>
    
    <span class="c1"># covariance matrix</span>
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">moments</span><span class="o">.</span><span class="n">calculate_cov_mat</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">t</span><span class="p">:</span> <span class="n">window_size</span> <span class="o">+</span> <span class="n">t</span><span class="p">,</span> <span class="p">:]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">probs</span><span class="o">=</span><span class="n">exp_probs</span><span class="p">)</span>
    
    <span class="c1"># equally weighted</span>
    <span class="n">cc_ratios</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_cc_ratio</span><span class="p">(</span><span class="n">eq_weigts</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="c1"># most diversified</span>
    <span class="n">most_div_port_weights</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calculate_most_diversified_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="n">most_div_port_cc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_cc_ratio</span><span class="p">(</span><span class="n">most_div_port_weights</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:],</span> <span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="c1"># mnimum variance</span>
    <span class="n">min_var_port_weights</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calculate_minimum_variance</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="n">min_var_port_cc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_cc_ratio</span><span class="p">(</span><span class="n">min_var_port_weights</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:],</span> <span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="c1"># mnimum variance norm-constrained</span>
    <span class="n">min_var_norm_port_weights</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calculate_minimum_variance_norm</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="mf">0.05</span><span class="p">)</span>
    <span class="n">min_var_norm_port_cc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_cc_ratio</span><span class="p">(</span><span class="n">min_var_norm_port_weights</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:],</span> <span class="n">cov_mat</span><span class="p">)</span>
    
    <span class="c1"># risk parity</span>
    <span class="n">rp_port_weights</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">calculate_risk_parity</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
    <span class="n">rp_port_cc</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_cc_ratio</span><span class="p">(</span><span class="n">rp_port_weights</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:],</span> <span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=58e74695">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Plotting-allocations">
        Plotting allocations
        <a class="anchor-link" href="#Plotting-allocations">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f519461e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span>
              <span class="n">most_div_port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
              <span class="n">edgecolor</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span>
              <span class="n">labels</span><span class="o">=</span><span class="n">df_weights</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
              <span class="n">colors</span><span class="o">=</span><span class="n">ind_colors</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Sector weights'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Most diversfied portfolios </span><span class="se">\n</span><span class="s2"> Fama-French Industry Portfolios"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">));</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3def5245">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span>
              <span class="n">min_var_port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
              <span class="n">edgecolor</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span>
              <span class="n">labels</span><span class="o">=</span><span class="n">df_weights</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
              <span class="n">colors</span><span class="o">=</span><span class="n">ind_colors</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Sector weights'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Minimum variance portfolios </span><span class="se">\n</span><span class="s2"> Fama-French Industry Portfolios"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">));</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6fc05294">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span>
              <span class="n">min_var_norm_port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
              <span class="n">edgecolor</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span>
              <span class="n">labels</span><span class="o">=</span><span class="n">df_weights</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
              <span class="n">colors</span><span class="o">=</span><span class="n">ind_colors</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Sector weights'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Minimum variance w. norm constraint portfolios </span><span class="se">\n</span><span class="s2"> Fama-French Industry Portfolios"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">));</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ad10bedf">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">stackplot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span>
              <span class="n">rp_port_weights</span><span class="o">.</span><span class="n">T</span><span class="p">,</span>
              <span class="n">edgecolor</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span>
              <span class="n">labels</span><span class="o">=</span><span class="n">df_weights</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span>
              <span class="n">colors</span><span class="o">=</span><span class="n">ind_colors</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Sector weights'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Risk parity portfolios </span><span class="se">\n</span><span class="s2"> Fama-French Industry Portfolios"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">ncol</span><span class="o">=</span><span class="mi">7</span><span class="p">,</span> <span class="n">bbox_to_anchor</span><span class="o">=</span><span class="p">(</span><span class="mf">1.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.05</span><span class="p">));</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fdaf55aa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Diversification-ratios">
        Diversification ratios
        <a class="anchor-link" href="#Diversification-ratios">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3d6dee4c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span> <span class="n">cc_ratios</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"CC ratio, eq. weighted"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span> <span class="n">most_div_port_cc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"CC ratio, most diversified"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span> <span class="n">min_var_port_cc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"CC ratio, minimum variance"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span> <span class="n">min_var_norm_port_cc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"CC ratio, norm constrained minimum variance"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:],</span> <span class="n">rp_port_cc</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"CC ratio, risk parity"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Diversification ratio"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Diversification ratio </span><span class="se">\n</span><span class="s2"> Fama-French Industry Portfolios"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5b57597d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Evaluating-strategies">
        Evaluating strategies
        <a class="anchor-link" href="#Evaluating-strategies">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=ad3ac500">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># store in data-frames</span>
<span class="n">df_most_div_port_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">most_div_port_weights</span><span class="p">,</span>
                                        <span class="n">index</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">df_min_var_port_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">min_var_port_weights</span><span class="p">,</span>
                                        <span class="n">index</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">df_min_var_norm_port_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">min_var_norm_port_weights</span><span class="p">,</span>
                                        <span class="n">index</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

<span class="n">df_rp_port_weights</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">rp_port_weights</span><span class="p">,</span>
                                        <span class="n">index</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span>
                                        <span class="n">columns</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=610d2136">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_port_ret</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span><span class="o">=</span><span class="n">ff_weekly_ret</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">window_size</span><span class="p">:])</span>

<span class="c1"># weekly return</span>
<span class="n">df_port_ret</span><span class="p">[</span><span class="s1">'min-var'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span> <span class="o">*</span> <span class="n">df_min_var_port_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_port_ret</span><span class="p">[</span><span class="s1">'most-div'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span> <span class="o">*</span> <span class="n">df_most_div_port_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_port_ret</span><span class="p">[</span><span class="s1">'min-var-norm'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span> <span class="o">*</span> <span class="n">df_min_var_norm_port_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_port_ret</span><span class="p">[</span><span class="s1">'rp'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span> <span class="o">*</span> <span class="n">df_rp_port_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">df_port_ret</span><span class="p">[</span><span class="s1">'eq-weight'</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:]</span> <span class="o">@</span> <span class="n">eq_weigts</span><span class="p">)</span>

<span class="c1"># total return index</span>
<span class="n">df_port_tri</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_port_ret</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8d7b5738">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_port_ret</span><span class="p">)</span><span class="o">.</span><span class="n">prod</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d89491de">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_port_tri</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">));</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1340553a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mean_return</span> <span class="o">=</span> <span class="n">df_port_ret</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">mean_return</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=bc8eefcb">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">std_return</span> <span class="o">=</span> <span class="n">df_port_ret</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">std_return</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c087de3f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The information ratio is given by
       </p>
       \begin{equation*}
\text{IR} = \frac{\text{E}[R_p]}{\sigma_P}
\end{equation*}
       <p>
        where $R_p$ is the portfolio return and $\sigma_P$ is the portfolio standard deviation (need to be replaced with estimates).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=09207aa4">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">ir_ratio</span> <span class="o">=</span> <span class="n">mean_return</span> <span class="o">/</span> <span class="n">std_return</span>
<span class="n">ir_ratio</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=d3d963fb">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We can define turn-over as
       </p>
       \begin{equation*}
\text{Turn-Over} = \frac{1}{T_{OOS} - 1}\sum_{t=1}^{T_{OOS} - 1} \sum_{i=1}^N \vert \tilde{w}_{i, t+1} - w_{i, t+1} \vert
\end{equation*}
       <p>
        where $T_{OOS} - 1$ is the number of re-balancing dates and
       </p>
       \begin{equation*}
\tilde{w}_{i, t+1} = \frac{w_{i, t}(1 + R_{i, t+1})}{1+R_{p, t+1}}
\end{equation*}
       <p>
        is the portfolio weight of asset $i$ immediately before re-balancing.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f3e683cd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [48]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_turn_over</span><span class="p">(</span><span class="n">df_port_weights</span><span class="p">,</span> <span class="n">df_asset_return</span><span class="p">):</span> 
    
    <span class="n">df_port_ret</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_asset_return</span> <span class="o">*</span> <span class="n">df_port_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">df_adj_weights</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_asset_return</span><span class="p">)</span> <span class="o">*</span> <span class="n">df_port_weights</span><span class="p">)</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">df_port_ret</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">df_w_diff</span> <span class="o">=</span> <span class="p">(</span><span class="n">df_adj_weights</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">-</span> <span class="n">df_adj_weights</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">df_w_diff</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span> <span class="o">*</span> <span class="mi">100</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c2e8daad">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [49]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">calculate_turn_over</span><span class="p">(</span><span class="n">df_min_var_port_weights</span><span class="p">,</span> <span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a1686aad">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [50]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_turn_over</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="p">[],</span> <span class="n">index</span><span class="o">=</span><span class="p">[</span><span class="s2">"Turn-over"</span><span class="p">])</span>
<span class="n">df_turn_over</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">'eq-weight'</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_turn_over</span><span class="p">(</span><span class="n">eq_weigts</span><span class="p">,</span> <span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:])</span>
<span class="n">df_turn_over</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">'min-var'</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_turn_over</span><span class="p">(</span><span class="n">df_min_var_port_weights</span><span class="p">,</span> <span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:])</span>
<span class="n">df_turn_over</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span><span class="s1">'most-div'</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_turn_over</span><span class="p">(</span><span class="n">df_most_div_port_weights</span><span class="p">,</span> <span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:])</span>
<span class="n">df_turn_over</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">'min-var-norm'</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_turn_over</span><span class="p">(</span><span class="n">df_min_var_norm_port_weights</span><span class="p">,</span> <span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:])</span>
<span class="n">df_turn_over</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s1">'rp'</span><span class="p">]</span> <span class="o">=</span> <span class="n">calculate_turn_over</span><span class="p">(</span><span class="n">df_rp_port_weights</span><span class="p">,</span> <span class="n">ff_weekly_ret</span><span class="p">[</span><span class="n">window_size</span><span class="p">:])</span>

<span class="n">df_turn_over</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=3efb2ef4">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Literature">
        Literature
        <a class="anchor-link" href="#Literature">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=2009778">
         Bruder and Roncalli (2012), "Managing Risk Exposures using
the Risk Budgeting Approach"
        </a>
       </p>
       <p>
        <a href="https://www.tobam.fr/wp-content/uploads/2014/12/TOBAM-JoPM-Maximum-Div-2008.pdf">
         Choueifaty and Caignard (2008), "Toward Maximum Diversification"
        </a>
       </p>
       <p>
        <a href="https://www.jstor.org/stable/40539189">
         Victor DeMiguel, Lorenzo Garlappi, Francisco J. Nogales and Raman Uppal (2009), "A Generalized Approach to Portfolio Optimization: Improving Performance by Constraining Portfolio Norms"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Analyzing-Economic-Indicators-with-the-FRED-API">
        Analyzing Economic Indicators with the FRED API
        <a class="anchor-link" href="#Analyzing-Economic-Indicators-with-the-FRED-API">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># import relevant packages </span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">fredapi</span> <span class="kn">import</span> <span class="n">Fred</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=02be4b61-e56d-4812-a881-9777be678cd5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        Ensure access to the FRED API. Apply your individual
        <code>
         API key
        </code>
        .
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a2f5ac4e-a161-4364-b8db-fb74444d222c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get API Key saved as an environment variable</span>
<span class="kn">import</span> <span class="nn">os</span> 
<span class="n">api_key</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getenv</span><span class="p">(</span><span class="s1">'fred_key'</span><span class="p">)</span>

<span class="n">fred</span> <span class="o">=</span> <span class="n">Fred</span><span class="p">(</span><span class="n">api_key</span><span class="o">=</span><span class="n">api_key</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=36c22e64-11f8-4c26-92aa-e536a2aeec25">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        Retrieve data for the three economic indicators starting from 2001-01-01:
       </p>
       <ul>
        <li>
         GDP (Gross Domestic Product): Series ID
         <code>
          GDP
         </code>
        </li>
        <li>
         Unemployment Rate: Series ID
         <code>
          UNRATE
         </code>
        </li>
        <li>
         Consumer Price Index (CPI) for All Urban Consumers: Series ID
         <code>
          CPIAUCSL
         </code>
        </li>
       </ul>
       <p>
        What do you note about the data-frequency?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f01efbb0-9358-4b3c-b42d-bf2f246ac633">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">series_ids</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'GDP'</span><span class="p">,</span> <span class="s1">'UNRATE'</span><span class="p">,</span> <span class="s1">'CPIAUCSL'</span><span class="p">]</span>
<span class="n">data</span> <span class="o">=</span> <span class="p">[</span><span class="n">fred</span><span class="o">.</span><span class="n">get_series</span><span class="p">(</span><span class="nb">id</span><span class="p">,</span> <span class="s1">'2000-01-01'</span><span class="p">)</span> <span class="k">for</span> <span class="nb">id</span> <span class="ow">in</span> <span class="n">series_ids</span><span class="p">]</span>

<span class="n">data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">data</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'GDP'</span><span class="p">,</span> <span class="s1">'Unemployment Rate'</span><span class="p">,</span> <span class="s1">'CPI'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cdcd5fb3-f2f2-47d6-8436-3668371fce3d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=df65b9f7-d8e9-4887-a0fe-3ea6deb66d26">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3">
        Problem 3
        <a class="anchor-link" href="#Problem-3">
         ¶
        </a>
       </h2>
       <p>
        Plot the three variables using line-plots.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c193db6f-771e-4581-8771-317b89dfa275">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span> 

    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">4</span><span class="p">))</span>

    <span class="n">data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">title</span><span class="o">=</span><span class="s2">"Historical development for </span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name</span><span class="p">),</span> <span class="n">ylabel</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=89128a6d-ea14-48fb-a593-095b4d9a83dd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4">
        Problem 4
        <a class="anchor-link" href="#Problem-4">
         ¶
        </a>
       </h2>
       <p>
        Calculate the quarterly growth rate for GDP and the annual inflation rate from the CPI data. Plot the growth rates using a line-plot.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b88f3d39">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">gdp_growth</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">'GDP'</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">pct_change</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>
<span class="n">cpi_inflation</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">'CPI'</span><span class="p">]</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="mi">12</span><span class="p">)</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span>

<span class="c1"># Plot GDP growth rate</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">gdp_growth</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'GDP Growth Rate'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'GDP Growth Rate Over Time'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Year'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Percentage'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>

<span class="c1"># Plot CPI-based inflation rate</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">cpi_inflation</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'CPI Inflation Rate'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">'Inflation Rate Over Time'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">'Year'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">'Percentage'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="MLE-of-logistic-regression-model">
        MLE of logistic regression model
        <a class="anchor-link" href="#MLE-of-logistic-regression-model">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="c1"># import relevant packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># packages for convex optimization</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>

<span class="c1"># for calculating evaluation metrics</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">accuracy_score</span><span class="p">,</span> <span class="n">confusion_matrix</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=61b1bfca-6cb1-4c35-aa37-b44e034852aa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The logistic regression model specifies the probability that a binary outcome variable $y$ equal 1 as
       </p>
       $$
P(y=1 \vert \mathbf{x}) = \frac{1}{1 + e^{-\mathbf{x}^\top \boldsymbol{\beta}}}
$$
       <p>
        where $\boldsymbol{\beta}$ is the vector of coefficients to be estimated.
       </p>
       <p>
        Below we simulate data from a logistic model with two explanatory variables.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=58ae953f-80df-4e04-bc96-d23e68dd5d5c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># set random seed</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">42</span><span class="p">)</span>

<span class="c1"># number of simulations</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">100</span>

<span class="c1"># coefficients</span>
<span class="n">beta0</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span>
<span class="n">beta1</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">beta2</span> <span class="o">=</span>  <span class="o">-</span><span class="mf">3.0</span>

<span class="c1"># generate explanatory variables</span>
<span class="n">x1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>
<span class="n">x2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="c1"># generate probabilties</span>
<span class="n">probs</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">beta0</span> <span class="o">+</span> <span class="n">beta1</span> <span class="o">*</span> <span class="n">x1</span> <span class="o">+</span> <span class="n">beta2</span> <span class="o">*</span> <span class="n">x2</span><span class="p">)))</span>

<span class="c1"># simulate y values</span>
<span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">binomial</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">probs</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=0e098073-5124-47f5-b332-5cfa2d07b0dd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        The log-likelihood function is given by
       </p>
       $$
\ell(\boldsymbol{\beta}) = \sum_{i=1}^N [y_i \log \frac{1}{1 + e^{-\mathbf{x}^\top \boldsymbol{\beta}}} + (1 - y_i) \log (1 - \frac{1}{1 + e^{-\mathbf{x}^\top \boldsymbol{\beta}}})]
$$
       <p>
        which is a convex function in $\boldsymbol{\beta}$.
       </p>
       <p>
        Use the
        <code>
         CVXPY
        </code>
        package to estimate the coefficients by maximizing the log-likelihood function.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5e9729d8-d3af-4837-9626-e01f8a15d719">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solving with CVXPY</span>
<span class="sd">"""</span>

<span class="n">x_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="n">x1</span><span class="p">,</span> <span class="n">x2</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>

<span class="c1"># define optimization variables</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">()</span>

<span class="c1"># define objective</span>
<span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x_mat</span> <span class="o">@</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">logistic</span><span class="p">(</span><span class="n">x_mat</span> <span class="o">@</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">))</span>
<span class="n">objective</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">)</span>

<span class="c1"># define problem </span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">objective</span><span class="p">)</span>

<span class="c1"># solve problem</span>
<span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># solution </span>
<span class="n">beta_est</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">value</span>
<span class="n">beta_est</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e862738e-958e-47b9-a004-039774fdd2db">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># intercept</span>
<span class="n">intercept_est</span> <span class="o">=</span> <span class="n">intercept</span><span class="o">.</span><span class="n">value</span>
<span class="n">intercept_est</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=20ca35b5-26f2-4ff0-ae68-f1cb059188f1">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        Calculate the predicted probabilities. Classify $y$ based on a  50% threshold. In addition calculate the accuracy score and the confusion matrix (use metrics.accuracy_score and metrics.confusion_matrix from
        <code>
         scikit-learn
        </code>
        ).
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a5a8bee9-b158-44f2-87bc-2d527cff9488">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">probs_pred</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">x_mat</span> <span class="o">@</span> <span class="n">beta_est</span> <span class="o">+</span> <span class="n">intercept_est</span><span class="p">)))</span>

<span class="c1"># Classify based on a threshold (e.g., 0.5)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">probs_pred</span> <span class="o">&amp;gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Evaluate the model</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Confusion Matrix:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=24dd140c-edd8-4daf-90c2-763f3486246c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        The accuracy score is the fraction of correct predictions.
       </p>
       <p>
        We interpret the confusion matrix as follows
       </p>
       <table>
        <tbody>
         <tr>
          <td>
           True Negative
          </td>
          <td>
           False Positive
          </td>
         </tr>
         <tr>
          <td>
           False Negative
          </td>
          <td>
           True Positive
          </td>
         </tr>
        </tbody>
       </table>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=0c6a4885-573e-421b-8c76-ce506c65def5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3">
        Problem 3
        <a class="anchor-link" href="#Problem-3">
         ¶
        </a>
       </h2>
       <p>
        To be able to perform variable selection, we can add an L1 penalty to the log-likelihood
       </p>
       $$
\ell_{reg}(\boldsymbol{\beta}) = \ell(\boldsymbol{\beta}) - \lambda \Vert \boldsymbol{\beta} \Vert_1 , \; \; \lambda &amp;gt; 0
$$
       <p>
        Again, estimate the parameters using
        <code>
         CVXPY
        </code>
        and evaluate the model.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a862435a-4821-4bf8-be4d-2e68da09edcf">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solving with CVXPY</span>
<span class="sd">"""</span>

<span class="n">lambda_reg</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">nonneg</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">lambda_reg</span><span class="o">.</span><span class="n">value</span> <span class="o">=</span> <span class="mi">3</span> <span class="c1"># you can change this parameter to change the regularization </span>

<span class="c1"># define optimization variables</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="n">intercept</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">()</span>

<span class="c1"># define objective</span>
<span class="n">log_likelihood</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">multiply</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x_mat</span> <span class="o">@</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">)</span> <span class="o">-</span> <span class="n">cp</span><span class="o">.</span><span class="n">logistic</span><span class="p">(</span><span class="n">x_mat</span> <span class="o">@</span> <span class="n">beta</span> <span class="o">+</span> <span class="n">intercept</span><span class="p">))</span> <span class="o">-</span> <span class="n">lambda_reg</span> <span class="o">*</span> <span class="n">cp</span><span class="o">.</span><span class="n">norm1</span><span class="p">(</span><span class="n">beta</span><span class="p">)</span>
<span class="n">objective</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Maximize</span><span class="p">(</span><span class="n">log_likelihood</span><span class="p">)</span>

<span class="c1"># define problem </span>
<span class="n">problem</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">objective</span><span class="p">)</span>

<span class="c1"># solve problem</span>
<span class="n">problem</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># solution </span>
<span class="n">beta_reg_est</span> <span class="o">=</span> <span class="n">beta</span><span class="o">.</span><span class="n">value</span> 
<span class="n">beta_reg_est</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5a3c6455-0021-4e41-8ffd-dacb8a6af74e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># intercept</span>
<span class="n">intercept_reg_est</span> <span class="o">=</span> <span class="n">intercept</span><span class="o">.</span><span class="n">value</span>
<span class="n">intercept_reg_est</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=edecf842-d4e0-4a67-af3c-255cc341a579">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">probs_pred</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">x_mat</span> <span class="o">@</span> <span class="n">beta_reg_est</span> <span class="o">+</span> <span class="n">intercept_reg_est</span><span class="p">)))</span>

<span class="c1"># Classify based on a threshold (e.g., 0.5)</span>
<span class="n">y_pred</span> <span class="o">=</span> <span class="p">(</span><span class="n">probs_pred</span> <span class="o">&amp;gt;=</span> <span class="mf">0.5</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

<span class="c1"># Evaluate the model</span>
<span class="n">accuracy</span> <span class="o">=</span> <span class="n">accuracy_score</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>
<span class="n">conf_matrix</span> <span class="o">=</span> <span class="n">confusion_matrix</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">"</span><span class="se">\n</span><span class="s2">Accuracy: </span><span class="si">{</span><span class="n">accuracy</span><span class="si">}</span><span class="s2">"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Confusion Matrix:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">conf_matrix</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=779288fe-5417-466a-b57e-7d3c02df40e5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Links">
        Links
        <a class="anchor-link" href="#Links">
         ¶
        </a>
       </h3>
       <p>
        Logistic regression model with maximum likelihood:
        <a href="https://www.statlect.com/fundamentals-of-statistics/logistic-model-maximum-likelihood">
         Statlect.com
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="The-USD-/-EUR-exchange-rate">
        The USD / EUR exchange rate
        <a class="anchor-link" href="#The-USD-/-EUR-exchange-rate">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># import relevant packages</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=02be4b61-e56d-4812-a881-9777be678cd5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        Download historical exchange rate data for the DKK/USD currency pair using Yahoo Finance. Use '2006-01-01' as start date.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a2f5ac4e-a161-4364-b8db-fb74444d222c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fx_data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="s1">'DKKUSD=X'</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="s1">'2006-01-01'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c8dd3997-179c-4c7c-af5e-98013d4e1272">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fx_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=6a19ca9e-e84a-4ad9-b1ea-03552f4a6f84">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        Define two
        <code>
         pd.Series
        </code>
        with the DKK / USD and USD / DKK exchange rate using the closing price.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=6d26ecc3-9be6-4b1d-bc3f-37bb292a20c7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define two pandas series with the FX cross</span>
<span class="n">dkkusd</span> <span class="o">=</span> <span class="n">fx_data</span><span class="p">[</span><span class="s1">'Close'</span><span class="p">]</span>
<span class="n">usddkk</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">dkkusd</span>

<span class="c1"># define the inverse cross</span>
<span class="n">log_dkkusd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">dkkusd</span><span class="p">)</span>
<span class="n">log_usddkk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">usddkk</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=36c22e64-11f8-4c26-92aa-e536a2aeec25">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3">
        Problem 3
        <a class="anchor-link" href="#Problem-3">
         ¶
        </a>
       </h2>
       <p>
        Plot the time series of the exchanges rates and the natural logarithm of the exhanges rates in two seperate figures.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=072d47a8-5bfe-4744-90ef-9568870bb583">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dkkusd</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">dkkusd</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'DKKUSD'</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">usddkk</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">usddkk</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'USDDKK'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e57d5ebc-b81a-40dd-812f-47a122496c21">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">dkkusd</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">log_dkkusd</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'log DKKUSD'</span><span class="p">)</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">usddkk</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">log_usddkk</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">""</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'log USDDKK'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=df65b9f7-d8e9-4887-a0fe-3ea6deb66d26">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4">
        Problem 4
        <a class="anchor-link" href="#Problem-4">
         ¶
        </a>
       </h2>
       <p>
        Plot the density of the weekly changes in the natural logarithm of DKK / USD for both the first and second half of the sample. Use either a histogram from the
        <code>
         matplotlib
        </code>
        package or
        <code>
         seaborn.kdeplot
        </code>
        .
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f6b7e663-953c-45ca-b70b-9dd3be2d0bd1">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">dkkusd</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">'W'</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=9bdc08a1-4aa2-4489-a78f-47d39748d84f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1">#weekly_chg_dkkusd = dkkusd.resample('W').last().pct_change().dropna()</span>

<span class="c1"># resample data weekly</span>
<span class="n">weekly_chg_log_dkkusd</span> <span class="o">=</span> <span class="n">log_dkkusd</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s1">'W'</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">diff</span><span class="p">()</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span>

<span class="c1"># calculate half-point</span>
<span class="n">half_point</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">weekly_chg_log_dkkusd</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cfc6624a-4498-425d-a97a-5f611d919da3">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">weekly_chg_log_dkkusd</span><span class="p">[:</span><span class="n">half_point</span><span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"First-half"</span><span class="p">);</span>
<span class="n">sns</span><span class="o">.</span><span class="n">kdeplot</span><span class="p">(</span><span class="n">weekly_chg_log_dkkusd</span><span class="p">[</span><span class="n">half_point</span><span class="p">:</span> <span class="p">],</span> <span class="n">fill</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Second-half"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=73af9b18-cc3e-400c-8391-828dc5d2c3aa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-5">
        Problem 5
        <a class="anchor-link" href="#Problem-5">
         ¶
        </a>
       </h2>
       <p>
        Plot a scatter plot between the weekly changes in the natural logarithm of DKK / USD and its lagged value.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=7f19b520-2dbd-475f-b687-c8852dd65aa1">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">pd</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">lag_plot</span><span class="p">(</span><span class="n">weekly_chg_log_dkkusd</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span> <span class="c1"># using pandas functionality</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$\Delta \log FX_{t-1}$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$\Delta \log FX$'</span><span class="p">);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a3c22310-91a3-4487-b765-f1af09f9c32a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-6">
        Problem 6
        <a class="anchor-link" href="#Problem-6">
         ¶
        </a>
       </h2>
       <p>
        Plot the autocorrelation function for the weekly changes in the natural logarithm of DKK / USD.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1db0f2a2-ba9e-4fe7-863c-15e306c3a402">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">No significant serial correlation!</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">plotting</span><span class="o">.</span><span class="n">autocorrelation_plot</span><span class="p">(</span><span class="n">weekly_chg_log_dkkusd</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlim</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">50</span><span class="p">]);</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Mean-Variance-Optimization-with-CVXOPT-and-CVXPY">
        Mean Variance Optimization with CVXOPT and CVXPY
        <a class="anchor-link" href="#Mean-Variance-Optimization-with-CVXOPT-and-CVXPY">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="c1"># import relevant packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span><span class="p">,</span> <span class="n">optimize</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># packages for convex optimization</span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>
<span class="kn">import</span> <span class="nn">cvxopt</span>

<span class="c1"># own functions from codelib</span>
<span class="kn">from</span> <span class="nn">codelib.statistics</span> <span class="kn">import</span> <span class="n">moments</span> <span class="k">as</span> <span class="n">mom</span>
<span class="kn">from</span> <span class="nn">codelib.portfolio_optimization.mean_variance</span> <span class="kn">import</span> <span class="n">portfolio_mean</span><span class="p">,</span> <span class="n">portfolio_std</span><span class="p">,</span> <span class="n">portfolio_variance</span><span class="p">,</span> <span class="n">minimum_variance_portfolio</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=61b1bfca-6cb1-4c35-aa37-b44e034852aa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Consider the portfolio optimization problem
       </p>
       <p>
        where the expected return vector is given by
       </p>
       $$
\boldsymbol{\mu} = \begin{pmatrix} 0.032 \\ 0.0322 \\ 0.084 \\ 0.082 \end{pmatrix},
$$
       <p>
        the vector of volatilites is given by
       </p>
       $$
\mathbf{v} = \begin{pmatrix} 0.05 \\ 0.05 \\ 0.22 \\ 0.22 \end{pmatrix},
$$
       <p>
        and the correlation matrix is given by
       </p>
       $$
\mathbf{C} = \begin{pmatrix} 1.0 &amp;amp; 0.85 &amp;amp; 0.5 &amp;amp; 0.45 \\
                      0.85 &amp;amp; 1.0 &amp;amp; 0.5 &amp;amp; 0.45 \\
                      0.5 &amp;amp; 0.5 &amp;amp; 1.0 &amp;amp; 0.9 \\
                      0.45 &amp;amp; 0.45 &amp;amp; 0.9 &amp;amp; 1.0 \end{pmatrix}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=af980dca-9292-4cf9-b27a-037b80b04f63">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.85</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.85</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.45</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">5.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">,</span> <span class="mf">22.0</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">3.2</span><span class="p">,</span> <span class="mf">3.22</span><span class="p">,</span> <span class="mf">8.4</span><span class="p">,</span> <span class="mf">8.2</span><span class="p">])</span> <span class="o">/</span> <span class="mf">100.0</span>

<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">mom</span><span class="o">.</span><span class="n">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=0e098073-5124-47f5-b332-5cfa2d07b0dd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        Set up the minimization problem that enable you to find the minimum variance portfolio using both
        <code>
         cvxopt
        </code>
        and
        <code>
         cvxpy
        </code>
        . Apply a budget constraint requiring the portfolio weights to sum to one. Compare with the analytical solution.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        We have the minimization problem
       </p>
       $$
\mathbf{w}^{Min-Var} = \arg \min \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w} \; \; \text{st. } \mathbf{1}^\top \mathbf{w} = 1
$$
       <p>
        The analytical solution is given by
       </p>
       $$
\mathbf{w}^{Min-Var} = \frac{\boldsymbol{\Sigma}^{-1} \mathbf{1}}{\mathbf{1}^\top \boldsymbol{\Sigma}^{-1} \mathbf{1}}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=7d412621-62e8-4b71-8718-29fa48a012a1">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># number of assets</span>
<span class="n">num_assets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">mu</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ed28ccca-221a-43d5-a73c-ba635e474eba">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solving with CVXOPT</span>
<span class="sd">"""</span>

<span class="n">P</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span> <span class="c1">#&amp;lt;- we need to minimize</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_assets</span><span class="p">))</span> 
<span class="n">A</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>

<span class="c1"># solve problem </span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">solvers</span><span class="o">.</span><span class="n">qp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">)</span>

<span class="c1"># solution </span>
<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span> <span class="c1"># &amp;lt;- gives the same solution as the analytical formula</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5e9729d8-d3af-4837-9626-e01f8a15d719">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solving with CVXPY</span>
<span class="sd">"""</span>

<span class="c1"># define variables</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">cov_mat</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>


<span class="c1"># define problem </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">)),</span>
                  <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">])</span> <span class="c1"># cp.sum(x) == 1 or  A @ x == b</span>

<span class="c1"># solve problem</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># solution </span>
<span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="c1"># &amp;lt;- gives the same solution as the analytical formula</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=8e3ff034-b11b-446c-b995-a6d6f70f162c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solving analytically</span>
<span class="sd">"""</span>

<span class="n">minimum_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=20ca35b5-26f2-4ff0-ae68-f1cb059188f1">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        Minimize the portfolio variance subject to the constraints that using the
        <code>
         CVXPY
        </code>
        or
        <code>
         CVXOPT
        </code>
        package.
       </p>
       <ul>
        <li>
         The expected return should be above 6%
        </li>
        <li>
         No shorting (all weights should be equal or greater than 0)
        </li>
        <li>
         The portfolio weights need to sum to one (budget constraint)
        </li>
       </ul>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a5a8bee9-b158-44f2-87bc-2d527cff9488">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solving with CVXOPT</span>
<span class="sd">"""</span>

<span class="c1"># objectiv function</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span> <span class="c1">#&amp;lt;- we need to minimize</span>
<span class="n">q</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_assets</span><span class="p">))</span> 
<span class="c1"># equality constraint</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span><span class="o">.</span><span class="n">T</span>
<span class="n">b</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">([</span><span class="mf">1.0</span><span class="p">])</span>
<span class="c1"># inequality constraints</span>
<span class="n">G</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">((</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_assets</span><span class="p">),</span>
                             <span class="o">-</span><span class="n">mu</span><span class="p">)))</span>
<span class="n">h</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">matrix</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">r_</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_assets</span><span class="p">),</span> <span class="o">-</span><span class="mf">0.06</span><span class="p">])</span>

<span class="c1"># solve problem </span>
<span class="n">sol</span> <span class="o">=</span> <span class="n">cvxopt</span><span class="o">.</span><span class="n">solvers</span><span class="o">.</span><span class="n">qp</span><span class="p">(</span><span class="n">P</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">A</span><span class="o">=</span><span class="n">A</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">b</span><span class="p">,</span> <span class="n">G</span><span class="o">=</span><span class="n">G</span><span class="p">,</span> <span class="n">h</span><span class="o">=</span><span class="n">h</span><span class="p">)</span>

<span class="c1"># solution </span>
<span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sol</span><span class="p">[</span><span class="s1">'x'</span><span class="p">])</span> <span class="c1"># &amp;lt;- gives the same solution as the analytical formula</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=edecf842-d4e0-4a67-af3c-255cc341a579">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Solving with CVXPY</span>
<span class="sd">"""</span>

<span class="c1"># define variables</span>
<span class="n">P</span> <span class="o">=</span> <span class="n">cov_mat</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">1.0</span>


<span class="c1"># define problem </span>
<span class="n">x</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">P</span><span class="p">)),</span>
                  <span class="n">constraints</span><span class="o">=</span><span class="p">[</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> 
                               <span class="n">x</span> <span class="o">@</span> <span class="n">mu</span> <span class="o">&amp;gt;=</span> <span class="mf">0.06</span><span class="p">,</span>
                               <span class="n">x</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">])</span>
<span class="c1"># solve problem</span>
<span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>

<span class="c1"># solution </span>
<span class="n">x</span><span class="o">.</span><span class="n">value</span> <span class="c1"># &amp;lt;- gives the same solution as the analytical formula</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Minimum-Variance-portofolio">
        Minimum-Variance portofolio
        <a class="anchor-link" href="#Minimum-Variance-portofolio">
         ¶
        </a>
       </h1>
       <p>
        Assume that an investor can create a portfolio by allocating to three assets
        <em>
         A
        </em>
        ,
        <em>
         B
        </em>
        and
        <em>
         C
        </em>
        with the following correlation matrix $\boldsymbol{C}$, vector of volatilities $\boldsymbol{v}$, and expected return vector $\boldsymbol{\mu}$
       </p>
       $$
\boldsymbol{C} = \begin{pmatrix} 1.0 &amp;amp; 0.2 &amp;amp; 0.15 \\
0.2 &amp;amp; 1.0 &amp;amp; 0.4 \\
0.15 &amp;amp; 0.4 &amp;amp; 1.0\end{pmatrix}
$$
       <p>
        and
       </p>
       $$
\boldsymbol{v} = \begin{pmatrix} 0.1 \\ 0.15 \\ 0.2 \end{pmatrix}
$$
       <p>
        and
       </p>
       $$
\boldsymbol{\mu} = \begin{pmatrix} 0.04 \\ 0.06 \\ 0.08 \end{pmatrix}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># we only need the numpy package</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=02be4b61-e56d-4812-a881-9777be678cd5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        Define the correlation matrix, covariance matrix and the vector of expected returns as
        <code>
         numpy
        </code>
        arrays
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a2f5ac4e-a161-4364-b8db-fb74444d222c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define the correlation matrix</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mf">0.2</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span> 
                     <span class="p">[</span><span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="c1"># define the vector of volatilities</span>
<span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">])</span>

<span class="c1"># calculate the covariance matrix</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vols</span><span class="p">)</span> <span class="o">@</span> <span class="n">corr_mat</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">vols</span><span class="p">)</span>

<span class="c1"># define the vector of expected returns </span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.06</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">])</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=36c22e64-11f8-4c26-92aa-e536a2aeec25">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        Check if the covariance matrix is postive definite.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        We could simply check if the eigenvalues of the covariance matrix are all positive.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=6da3fa16">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">eig_vals</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3df4c504">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># all eigenvalues are positive!</span>
<span class="n">eig_vals</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=df65b9f7-d8e9-4887-a0fe-3ea6deb66d26">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3">
        Problem 3
        <a class="anchor-link" href="#Problem-3">
         ¶
        </a>
       </h2>
       <p>
        Consider an equally weighted portfolio $w_A = w_B = w_C = 1/3$. What is the formula for the portfolio variance using matrix notation? Calculate the portfolio standard devation for the equally weighted portfolio. Also calculate the expected return for the portfolio.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        The portfolio variance is given by the formula
       </p>
       $$
\sigma_p^2 = \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c193db6f-771e-4581-8771-317b89dfa275">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define the equally weighted portfolio</span>
<span class="n">w_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">)</span>
<span class="n">w_eq</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a4252f1b-6975-44de-bc7a-d91bc5ee7902">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># portfolio standard devation</span>
<span class="n">std_eq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">w_eq</span> <span class="o">@</span> <span class="n">cov_mat</span> <span class="o">@</span> <span class="n">w_eq</span><span class="p">)</span>
<span class="n">std_eq</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1c45b6b5-5888-4a7e-8a1f-8a80903af692">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># expected return</span>
<span class="n">mu_eq</span> <span class="o">=</span> <span class="n">w_eq</span> <span class="o">@</span> <span class="n">mu</span>
<span class="n">mu_eq</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=89128a6d-ea14-48fb-a593-095b4d9a83dd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4">
        Problem 4
        <a class="anchor-link" href="#Problem-4">
         ¶
        </a>
       </h2>
       <p>
        The portfolio weights $\mathbf{w} = (w_A \; \; w_B \; \; w_C)^\top$ satisfies the budget constraint $\mathbf{w}^\top \mathbf{1} =  w_A + w_B + w_C = 1$. The investor seeks to minimize the variance subject to this condition
       </p>
       $$
\min \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w} \; \; \;  \text{s.t. } \mathbf{w}^\top \mathbf{1}  = 1
$$
       <p>
        The Lagrangian reads
       </p>
       $$
\mathcal{L} = \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w} - \lambda (\mathbf{w}^\top \mathbf{1}  - 1)
$$
       <p>
        Deriving the FOC and solving for the optimal weights yields
       </p>
       $$
\mathbf{w}^* = \frac{\boldsymbol{\Sigma}^{-1} \mathbf{1}}{\mathbf{1}^\top \boldsymbol{\Sigma}^{-1} \mathbf{1}}
$$
       <p>
        Define a function which calculates the minimum-variance portfolio weights given a covariance matrix. Calculate the minimum-variance portfolio weights.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=b88f3d39">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_min_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates the minimum-varance portfolio weights. </span>
<span class="sd">    """</span>
    
    <span class="n">num_assets</span> <span class="o">=</span> <span class="n">cov_mat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">vec_ones</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>
    
    <span class="n">cov_mat_inv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>

    <span class="n">w_min_var</span> <span class="o">=</span> <span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="n">vec_ones</span> <span class="o">/</span> <span class="p">(</span><span class="n">vec_ones</span> <span class="o">@</span> <span class="n">cov_mat_inv</span> <span class="o">@</span> <span class="n">vec_ones</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">w_min_var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a56f0089-99cf-4112-b3a8-66c6e03fc150">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [48]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">w_min_var</span> <span class="o">=</span> <span class="n">calculate_min_variance_portfolio</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
<span class="n">w_min_var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Multivariate-Student-T-distribution">
        Multivariate Student T distribution
        <a class="anchor-link" href="#Multivariate-Student-T-distribution">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># import relevant packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=cf0cf32e-6f11-492f-9f90-c8f4e084cc85">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        The multivariate Student T distribution $\mathbf{X} \sim t(\boldsymbol{\mu}, \boldsymbol{\Sigma}, \nu)$ can be simulated using
        <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.multivariate_t.html#scipy.stats.multivariate_t">
         <code>
          scipy.stats.multivariate_t
         </code>
        </a>
        and has the density
       </p>
       $$
f_{\mathbf{X}}({\mathbf{x}})  = \frac{\Gamma\left[(\nu+p)/2\right]}{\Gamma(\nu/2)\nu^{p/2}\pi^{p/2}\left|{\boldsymbol\Sigma}\right|^{1/2}}\left[1+\frac{1}{\nu}({\mathbf x}-{\boldsymbol\mu})^{\rm T}{\boldsymbol\Sigma}^{-1}({\mathbf x}-{\boldsymbol\mu})\right]^{-(\nu+p)/2}
$$
       <p>
        where $p$ is the length of the random vector, $\nu$ is the degree of freedoms, $\boldsymbol{\mu}$ is a $p \times 1$ vector and $\boldsymbol{\Sigma}$ is a $p \times p$ positive definite matrix.
       </p>
       <p>
        The expected value is given by (if $\nu &amp;gt; 1$)
       </p>
       $$
\text{E} [\mathbf{X}] = \boldsymbol{\mu}
$$
       <p>
        and the covariance matrix (if $\nu &amp;gt; 2$)
       </p>
       $$
\text{Cov} [\mathbf{X}] = \frac{\nu}{\nu - 2} \boldsymbol{\Sigma}
$$
       <p>
        Validate the formula for a bivariate multivariate t distribution with $\boldsymbol{\mu} = (0, 0)^\top$, $\boldsymbol{\Sigma} = \mathbb{I}_2$ and $\nu = 10$ using simulation. Use at least 999 999 simulations.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f5aca234-de71-40a6-a244-67cca6e38a44">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define inputs and calculate theoretical values</span>
<span class="sd">"""</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">2</span>
<span class="n">nu</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">sigma_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">/</span>  <span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=03e4f030-49e0-4d7a-9a6a-e3f758691dfb">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Validation using simulations</span>
<span class="sd">"""</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">9_999_999</span>

<span class="n">sim_data</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_t</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">sigma_mat</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>

<span class="n">mu_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">cov_mat_est</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=14331b50-ad06-495f-ba3b-8eaddfaef56e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu_est</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=840fb2ad-1dba-4f03-88f2-8f38ebe5be70">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cov_mat_est</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1f56987b-04de-40cf-ae80-95283a818e76">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cov_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=0bd6889e-d922-4e02-bd24-c343a1037e91">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        Consider the case with $p = 100$ with $\boldsymbol{\mu} = \mathbf{0}$ and $\boldsymbol{\Sigma} = \mathbb{I}_p$.
       </p>
       <p>
        Verify using simulations that $\sum_{i=1}^p X_i = \mathbf{1}^\top \mathbf{X} \sim t(0, p, \nu)$.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=833a4ca3-ca60-4091-9e96-630fc485a3ca">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define inputs</span>
<span class="sd">"""</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">nu</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">sigma_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">/</span>  <span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=575ce04c-dee2-4917-ba67-4768573bdb8d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate sum of uncorrelated t distributed variables</span>
<span class="sd">"""</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">9_999_999</span>

<span class="n">sim_data</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">multivariate_t</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="n">sigma_mat</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">num_sim</span><span class="p">)</span>
<span class="n">sim_sum</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=a7f2ed51-16cc-4c3e-bfe2-912182c96623">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define pdf values</span>
<span class="sd">"""</span>

<span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pdf_vals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot results</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_sum</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"simulated data"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">pdf_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Theoretical density'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=7da85546-fa0d-4ad0-8840-4c0f5627c1a8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3">
        Problem 3
        <a class="anchor-link" href="#Problem-3">
         ¶
        </a>
       </h2>
       <p>
        For the above cases the marginal distribution will be $X_i \sim t(0, 1, \nu)$. Verify that uncorrelated Student t distributed variables cannot be independent by simulating $\sum_{i=1}^p Y_i$ with $Y_i \sim t(0, 1, \nu)$ and comparing the histogram with the theoretical distribution derived above. Additionally, try to add the pdf of a $N(0, p \frac{\nu}{\nu - 2})$ random variable.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=caba7ce7-1123-45e8-a923-346aba74e518">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Simulate sum of independent t distributed variables</span>
<span class="sd">"""</span>

<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">9_999_999</span>

<span class="n">sim_data_independent</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">)</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">p</span><span class="p">))</span>
<span class="n">sim_sum_independent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sim_data_independent</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0267333f-d71f-4962-b914-46453f8aa57d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define pdf values</span>
<span class="sd">"""</span>

<span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pdf_vals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span><span class="p">),</span> <span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">)</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>
<span class="n">pdf_norm_vals</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">p</span> <span class="o">*</span> <span class="n">nu</span> <span class="o">/</span> <span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)))</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_vals</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot results</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_sum_independent</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"simulated data"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">pdf_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Theoretical density'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">pdf_norm_vals</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Normal approximation of i.i.d. sum'</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Risk-attribution-with-Student-t-distributed-risk-drivers">
        Risk attribution with Student t distributed risk drivers
        <a class="anchor-link" href="#Risk-attribution-with-Student-t-distributed-risk-drivers">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="c1"># import relevant packages</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># from codelib</span>
<span class="kn">from</span> <span class="nn">codelib.visualization.base</span> <span class="kn">import</span> <span class="n">risk_waterfall_chart</span><span class="p">,</span> <span class="n">waterfall_chart</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=61b1bfca-6cb1-4c35-aa37-b44e034852aa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Assume that we can specify the return of an asset using the following decomposition
       </p>
       $$
\mathbf{R} = \alpha + \beta_1 \mathbf{Z}_1 + \beta_2 \mathbf{Z}_2 + \varepsilon = \boldsymbol{\beta}^\top \mathbf{Z}
$$
       <p>
        where $\boldsymbol{\beta} = (\beta_1, \beta_2, 1)^\top = (0.5, 0.75, 1)^\top$ and
       </p>
       $$
\mathbf{Z} = \begin{pmatrix} \mathbf{Z}_1 \\ \mathbf{Z}_2 \\ \alpha + \varepsilon  \end{pmatrix} \sim t(\boldsymbol{\mu}, \boldsymbol{\Sigma}, \nu)
$$
       <p>
        Assume that $\nu = 10$ and
       </p>
       $$
\boldsymbol{\mu} = \begin{pmatrix} 0.04 \\ 0.08 \\ 0.0\end{pmatrix}
$$
       <p>
        and
       </p>
       $$
\boldsymbol{\Sigma} = \begin{pmatrix} 0.1^2 &amp;amp; 0 &amp;amp; 0 \\ 0 &amp;amp; 0.15^2 &amp;amp; 0 \\ 0 &amp;amp; 0 &amp;amp; 0.05^2 \end{pmatrix}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=0e098073-5124-47f5-b332-5cfa2d07b0dd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        The variance of $\mathbf{R}$ is given by
       </p>
       $$
\text{Var}[\mathbf{R}] = \boldsymbol{\beta}^\top \text{Cov}[\mathbf{Z}]  \boldsymbol{\beta}
$$
       <p>
        What is the variance of $\mathbf{R}$? What is the standard deviation?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        We note that (from week 3)
       </p>
       $$
\text{Cov}[\mathbf{Z}] = \frac{\nu}{\nu - 2} \boldsymbol{\Sigma}
$$
       <p>
        Thus, we just plug into the formula
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=30f07161-4d38-457c-a5fb-a653249d0f8e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define relevant inputs</span>
<span class="sd">"""</span>

<span class="n">p</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">nu</span> <span class="o">=</span> <span class="mi">10</span>
<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mf">0.04</span><span class="p">,</span> <span class="mf">0.08</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">])</span>
<span class="n">sigma_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">([</span><span class="mf">0.1</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.15</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.05</span><span class="o">**</span><span class="mi">2</span><span class="p">])</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">nu</span> <span class="o">/</span>  <span class="p">(</span><span class="n">nu</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sigma_mat</span>
<span class="n">beta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mi">1</span><span class="p">]])</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=92d2209a-028e-40d6-a58a-bad5d0af906b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define function to calculate variance of asset</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">calculate_asset_variance</span><span class="p">(</span><span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="nb">float</span><span class="p">:</span> 

    <span class="k">return</span> <span class="n">beta</span> <span class="o">@</span> <span class="n">cov_mat</span> <span class="o">@</span> <span class="n">beta</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5172cc02-1018-403f-9894-6c013c5008a7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">var</span> <span class="o">=</span> <span class="n">calculate_asset_variance</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="n">var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e3be1890-836b-4460-a06b-d64684015a8e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">std</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
<span class="n">std</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b1b38c01-60d9-4117-94ab-b51530c140ae">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        Following similar arguments as for a portfolio, the Euler decomposition of the standard devation of the asset return reads
       </p>
       $$
\sigma_R(\boldsymbol{\beta}) = \boldsymbol{\beta}^\top \frac{\text{Cov}[\mathbf{Z}]  \boldsymbol{\beta}}{\sqrt{\boldsymbol{\beta}^\top \text{Cov}[\mathbf{Z}] \boldsymbol{\beta}}} = \sum_{i=1}^3 \beta_i \frac{(\text{Cov}[\mathbf{Z}] \boldsymbol{\beta})_i }{\sqrt{\boldsymbol{\beta}^\top \text{Cov}[\mathbf{Z}] \boldsymbol{\beta}}}
$$
       <p>
        Attribute the risk using the above decomposition. Does the risk contributions sum to the total risk? Plot the results.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
       <p>
        We can simply apply the formula from the lecture - just replace portfolio weights with $\boldsymbol{\beta}$!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6f9c95b4-bbdb-448c-8c82-a3a5a13da875">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_marginal_risks</span><span class="p">(</span><span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates marginal risk</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    beta: </span>
<span class="sd">        Factor exposures. </span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>
    
    <span class="n">total_risk</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">@</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span>
    <span class="n">inner_derivative</span> <span class="o">=</span> <span class="n">cov_matrix</span> <span class="o">@</span> <span class="n">beta</span>
    
    <span class="k">return</span> <span class="n">inner_derivative</span> <span class="o">/</span> <span class="n">total_risk</span>

<span class="k">def</span> <span class="nf">calculate_risk_contributions</span><span class="p">(</span><span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates risk contributions</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    beta: </span>
<span class="sd">        Factor exposures.</span>
<span class="sd">    cov_matrix: </span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>
    
    <span class="n">mr</span> <span class="o">=</span> <span class="n">calculate_marginal_risks</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">cov_matrix</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">mr</span>

<span class="n">risk_contrib</span> <span class="o">=</span> <span class="n">calculate_risk_contributions</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Risk contribution:"</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Z_1: </span><span class="si">{:.2f}</span><span class="s2">%'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">risk_contrib</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Z_2: </span><span class="si">{:.2f}</span><span class="s2">%'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">risk_contrib</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">"Idiosyncratic: </span><span class="si">{:.2f}</span><span class="s2">%'"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">risk_contrib</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3bab4b29-54fe-4852-bd44-e5356891d348">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_contrib</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1"># &amp;lt;- YES</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f9a42ba1-359b-4a82-99e6-7a041d24c9f1">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">waterfall_chart</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">risk_contrib</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">"$Z_1$"</span><span class="p">,</span> <span class="s2">"$Z_2$"</span><span class="p">,</span> <span class="s2">"$</span><span class="se">\\</span><span class="s2">alpha + </span><span class="se">\\</span><span class="s2">epsilon$"</span><span class="p">],</span>
                          <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span>
                          <span class="n">total_label</span><span class="o">=</span><span class="s2">"Total risk (std)"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Risk contribution"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Risk contribution using std. as risk measure"</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=4acaa26d-7f80-4e11-957f-405431f60591">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3">
        Problem 3
        <a class="anchor-link" href="#Problem-3">
         ¶
        </a>
       </h2>
       <p>
        We have the general result that if $\mathbf{Z} \sim t(\boldsymbol{\mu}, \boldsymbol{\Sigma}, \nu)$ then
       </p>
       $$
\boldsymbol{a} + \boldsymbol{b} \mathbf{Z} \sim t(\boldsymbol{a}+\boldsymbol{b} \boldsymbol{\mu},\boldsymbol{b} \boldsymbol{\Sigma} \boldsymbol{b}^\top, \nu)
$$
       <p>
        Calculate the $\text{VaR}_{5\%} (\mathbf{R})$.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=f3c4fdca-1faa-4357-8688-79acfced25c6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu_r</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">@</span> <span class="n">mu</span>
<span class="n">var_r</span>  <span class="o">=</span> <span class="n">beta</span> <span class="o">@</span> <span class="n">sigma_mat</span> <span class="o">@</span> <span class="n">beta</span>
<span class="n">std_r</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">var_r</span><span class="p">)</span>

<span class="n">value_at_risk_5pct</span> <span class="o">=</span> <span class="o">-</span><span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu_r</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">std_r</span><span class="p">)</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="mf">0.05</span><span class="p">)</span>
<span class="n">value_at_risk_5pct</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=c0a14bbc-4d3b-4d8d-9678-3096bda530be">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4">
        Problem 4
        <a class="anchor-link" href="#Problem-4">
         ¶
        </a>
       </h2>
       <p>
        We have the general result that if $\mathbf{R} \sim t(\mu, \sigma^2, \nu)$ then
       </p>
       $$
R = \mu + \sigma Y
$$
       <p>
        where $Y \sim t(0, 1, \nu)$. Using this result will enable us to define the Euler decomposition
       </p>
       $$
\text{VaR}_{\alpha} (\mathbf{R}) = \boldsymbol{\beta}^\top (-\boldsymbol{\mu} - \frac{\boldsymbol{\Sigma}  \boldsymbol{\beta}}{\sqrt{\boldsymbol{\beta}^\top \boldsymbol{\Sigma} \boldsymbol{\beta}}} q_t(\alpha))
$$
       <p>
        where $q_t(\alpha)$ is the quantile of a $t(0, 1, \nu)$ distributed random variable.
       </p>
       <p>
        Attribute the risk using the above decomposition. Does the risk contributions sum to the total risk? Plot the results.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a21a54b5-a071-425e-a240-ac1251bf3327">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_risk_contributions_t_var</span><span class="p">(</span><span class="n">beta</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">mu</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma_mat</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">nu</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span> <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.05</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Function that calculates risk contribution using Value-at-Risk as risk measure.</span>
<span class="sd">    It is assumed that risk drivers follow a multivariate t distribution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    factor exposures:</span>
<span class="sd">        Factor exposures</span>
<span class="sd">    mu:</span>
<span class="sd">        Vector of expected returns</span>
<span class="sd">    sigma_mat:</span>
<span class="sd">        Covariance matrix</span>
<span class="sd">    alpha:</span>
<span class="sd">        Confidence level</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Marginal risks</span>
<span class="sd">    """</span>

    <span class="n">mr</span> <span class="o">=</span> <span class="o">-</span><span class="n">mu</span> <span class="o">-</span> <span class="n">sigma_mat</span> <span class="o">@</span> <span class="n">beta</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span> <span class="o">@</span> <span class="n">sigma_mat</span> <span class="o">@</span> <span class="n">beta</span><span class="p">)</span> <span class="o">*</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">nu</span><span class="p">)</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">alpha</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">mr</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=38f73298-c0fc-4003-a791-c9a37ad3d76d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_contrib_var</span> <span class="o">=</span> <span class="n">calculate_risk_contributions_t_var</span><span class="p">(</span><span class="n">beta</span><span class="p">,</span> <span class="n">mu</span><span class="p">,</span> <span class="n">sigma_mat</span><span class="p">,</span> <span class="n">nu</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">)</span>
<span class="n">risk_contrib_var</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4b3be670-1474-474c-a07f-b3f8d0b9a07f">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">risk_contrib_var</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="c1">#&amp;lt;- YES</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9fe3d383-e59b-496b-b1e1-98aae72e8df6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">waterfall_chart</span><span class="p">(</span><span class="n">values</span><span class="o">=</span><span class="n">risk_contrib_var</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span>
                          <span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="s2">"$Z_1$"</span><span class="p">,</span> <span class="s2">"$Z_2$"</span><span class="p">,</span> <span class="s2">"$</span><span class="se">\\</span><span class="s2">alpha + </span><span class="se">\\</span><span class="s2">epsilon$"</span><span class="p">],</span>
                          <span class="n">formatting</span><span class="o">=</span><span class="s1">'</span><span class="si">{:,.1f}</span><span class="s1">%'</span><span class="p">,</span>
                          <span class="n">total_label</span><span class="o">=</span><span class="s2">"Total risk (VaR(5%))"</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Risk contribution"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Risk contribution using Value at Risk"</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">set_size_inches</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Scenario-probability-distribution">
        Scenario probability distribution
        <a class="anchor-link" href="#Scenario-probability-distribution">
         ¶
        </a>
       </h1>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># import relevant packages</span>
<span class="kn">import</span> <span class="nn">yfinance</span> <span class="k">as</span> <span class="nn">yf</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1820f1a0-517b-4e7a-8039-0b76c1b2ac33">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># Define the time period</span>
<span class="n">start_date</span> <span class="o">=</span> <span class="s2">"2006-01-01"</span>
<span class="n">end_date</span> <span class="o">=</span> <span class="s2">"2024-09-16"</span>

<span class="c1"># downloads the Adjusted Close prices for the VIX, S&amp;amp;P 500 ETF (SPY), and Aggregate Bond ETF (AGG</span>
<span class="n">tickers</span> <span class="o">=</span> <span class="p">[</span><span class="s2">"^VIX"</span><span class="p">,</span> <span class="s2">"SPY"</span><span class="p">,</span> <span class="s2">"AGG"</span><span class="p">]</span>
<span class="n">df_data</span> <span class="o">=</span> <span class="n">yf</span><span class="o">.</span><span class="n">download</span><span class="p">(</span><span class="n">tickers</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start_date</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">end_date</span><span class="p">)[</span><span class="s1">'Adj Close'</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=0e2db082-e079-4d3e-a63e-3fab90dd61a7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=02be4b61-e56d-4812-a881-9777be678cd5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        Calculate the log-returns for the for S&amp;amp;P 500 ETF (SPY) and Aggregate Bond ETF (AGG) using the Adj. closing prices.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a2f5ac4e-a161-4364-b8db-fb74444d222c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># get adj. closing prices for price index</span>
<span class="n">price_data</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[[</span><span class="s2">"SPY"</span><span class="p">,</span> <span class="s2">"AGG"</span><span class="p">]]</span>

<span class="c1"># replacing price data with log-returns</span>
<span class="n">df_data</span><span class="p">[[</span><span class="s2">"SPY ret"</span><span class="p">,</span> <span class="s2">"AGG ret"</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">price_data</span> <span class="o">/</span> <span class="n">price_data</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">))</span>
<span class="n">df_data</span><span class="o">.</span><span class="n">dropna</span><span class="p">(</span><span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=c8dd3997-179c-4c7c-af5e-98013d4e1272">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">df_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=6a19ca9e-e84a-4ad9-b1ea-03552f4a6f84">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        Calculate the unconditional covariance and correlation matrix based on the full sample.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=6d26ecc3-9be6-4b1d-bc3f-37bb292a20c7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cov_mat</span>  <span class="o">=</span> <span class="n">df_data</span><span class="p">[[</span><span class="s1">'SPY ret'</span><span class="p">,</span> <span class="s1">'AGG ret'</span><span class="p">]]</span><span class="o">.</span><span class="n">cov</span><span class="p">()</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">df_data</span><span class="p">[[</span><span class="s1">'SPY ret'</span><span class="p">,</span> <span class="s1">'AGG ret'</span><span class="p">]]</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6787ad96-eb81-4a0a-8a60-724e50575845">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=b2b42513-0df2-43cd-aa88-e465fab16a03">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3">
        Problem 3
        <a class="anchor-link" href="#Problem-3">
         ¶
        </a>
       </h2>
       <p>
        Calculate the covariance matrix using scenario probabilities
       </p>
       $$
p_t \propto \left \{\begin{array}{ll} 1 &amp;amp; \text{if } VIX_t \geq 20 \\ 0 &amp;amp; \text{if } VIX_t &amp;lt; 20 \end{array} \right .
$$
       <p>
        Plot the probabilities over time.
       </p>
       <p>
        Use the below function to calculate the probabilities.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e1e3ef60-e769-4a50-a839-be114a46b72c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Tuple</span> 

<span class="k">def</span> <span class="nf">crisp_conditioning_probs</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">typing</span><span class="o">.</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">condition</span><span class="p">:</span> <span class="n">Tuple</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Creates an array of crisp condition probabilities.</span>

<span class="sd">    Currently only works for one state variable.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x:</span>
<span class="sd">        Array for setting the shape of.</span>
<span class="sd">    condition:</span>
<span class="sd">        Tuple with lower and upper bound.</span>
<span class="sd">    axis:</span>
<span class="sd">        The axis to create the weights over. Default is 0.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    ndarray</span>
<span class="sd">        Array of equal weights.</span>
<span class="sd">    """</span>

    <span class="n">probs</span> <span class="o">=</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;gt;=</span> <span class="n">condition</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&amp;amp;</span> <span class="p">(</span><span class="n">x</span> <span class="o">&amp;lt;=</span> <span class="n">condition</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">probs</span> <span class="o">=</span> <span class="n">probs</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">probs</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">probs</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ec64d556-5390-4a78-bb54-d8bc5ff1be54">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=b2d7ab6a-0a6c-4017-953b-7c021839b203">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">probabilities</span> <span class="o">=</span> <span class="n">crisp_conditioning_probs</span><span class="p">(</span><span class="n">df_data</span><span class="p">[</span><span class="s1">'^VIX'</span><span class="p">],</span> <span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
<span class="n">unconditional_probabilities</span> <span class="o">=</span> <span class="n">crisp_conditioning_probs</span><span class="p">(</span><span class="n">df_data</span><span class="p">[</span><span class="s1">'^VIX'</span><span class="p">],</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">inf</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=189fb0ad-ddfd-4d6e-8ac4-d49f7eb47756">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [55]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>

<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">probabilities</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">probabilities</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Scenario probabilities (VIX &amp;gt; 20)"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">unconditional_probabilities</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">unconditional_probabilities</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unconditional"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Probabilities'</span><span class="p">)</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="s2">"upper left"</span><span class="p">);</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">twinx</span><span class="p">()</span>

<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">df_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">df_data</span><span class="p">[</span><span class="s1">'^VIX'</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s2">"VIX"</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'VIX'</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=df65b9f7-d8e9-4887-a0fe-3ea6deb66d26">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-4">
        Problem 4
        <a class="anchor-link" href="#Problem-4">
         ¶
        </a>
       </h2>
       <p>
        Plot a histogram of the unconditional and conditional distribution of SPY log returns the
        <code>
         matplotlib
        </code>
        package.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=cfc6624a-4498-425d-a97a-5f611d919da3">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [82]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_data</span><span class="p">[</span><span class="s1">'SPY ret'</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Conditional"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">weights</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">df_data</span><span class="p">[</span><span class="s1">'SPY ret'</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Unconditional"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">);</span>

<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=73af9b18-cc3e-400c-8391-828dc5d2c3aa">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-5">
        Problem 5
        <a class="anchor-link" href="#Problem-5">
         ¶
        </a>
       </h2>
       <p>
        Calculate the conditional covariance and correlation matrix based on the full sample. You may want to use
        <code>
         numpy.cov
        </code>
        which has an argument
        <code>
         aweights
        </code>
        which together with
        <code>
         ddof=0
        </code>
        can we viewed as probabilities.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=cc598b39-dbb9-4708-8d45-4d601bf3ba51">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [98]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cond_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">df_data</span><span class="p">[[</span><span class="s1">'SPY ret'</span><span class="p">,</span> <span class="s1">'AGG ret'</span><span class="p">]],</span> <span class="n">aweights</span><span class="o">=</span><span class="n">probabilities</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=3d4e20fd-e98a-4846-8d14-f1cf13695d05">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [99]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cond_cov_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=e25d9953-a576-4c47-84e2-e09d6e09661d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [105]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cond_cov_mat</span><span class="p">))</span>
<span class="n">cond_corr_mat</span> <span class="o">=</span> <span class="n">cond_cov_mat</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">vols</span><span class="p">,</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">vols</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=058e624f-ee05-4b44-a83f-2ffb3d576085">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [106]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cond_corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=d3c82804-4456-418c-84eb-af34ce5eb25c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [115]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Alternative</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">codelib.statistics.moments</span> <span class="k">as</span> <span class="nn">mom</span>

<span class="n">statistics</span><span class="o">.</span><span class="n">moments</span><span class="o">.</span><span class="n">calculate_correlation</span><span class="p">(</span><span class="n">df_data</span><span class="p">[</span><span class="s1">'AGG ret'</span><span class="p">],</span> <span class="n">df_data</span><span class="p">[</span><span class="s1">'SPY ret'</span><span class="p">],</span> <span class="n">probs</span><span class="o">=</span><span class="n">probabilities</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=5729489a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Simulating-the-uncertainty-of-sample-correlation-estimator">
        Simulating the uncertainty of sample correlation estimator
        <a class="anchor-link" href="#Simulating-the-uncertainty-of-sample-correlation-estimator">
         ¶
        </a>
       </h1>
       <p>
        Assume that we want to examine the properties of the sample covariance estimator, in particular we want to look at the distribution of the correlations. We assume the correlation matrix $\boldsymbol{C}$
       </p>
       $$
\boldsymbol{C} = \begin{pmatrix} 1 &amp;amp; \rho &amp;amp; \rho  &amp;amp; \rho &amp;amp; \rho \\
\rho &amp;amp; 1 &amp;amp; \rho  &amp;amp; \rho &amp;amp; \rho \\
\rho &amp;amp; \rho &amp;amp; 1  &amp;amp; \rho &amp;amp; \rho \\
\rho &amp;amp; \rho &amp;amp; \rho  &amp;amp; 1 &amp;amp; \rho \\
\rho &amp;amp; \rho &amp;amp; \rho  &amp;amp; \rho &amp;amp; 1 \end{pmatrix}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=c0c4e99c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># import numpy for working with matrices</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="c1"># import matplotlib for plotting</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=02be4b61-e56d-4812-a881-9777be678cd5">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-1">
        Problem 1
        <a class="anchor-link" href="#Problem-1">
         ¶
        </a>
       </h2>
       <p>
        Assume $\rho = 0.5$ and that the data generating process is normal
       </p>
       $$
\mathbf{X} \sim N(\mathbf{0}, \boldsymbol{C})
$$
       <p>
        Simulate $N=25$ observations $10\;000$ times and plot the histogram of the correlation estimates for the first and second variable.
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=a2f5ac4e-a161-4364-b8db-fb74444d222c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define input parameters</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">0.5</span>
<span class="n">num_var</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">num_obs</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10_000</span>

<span class="c1"># define the correlation matrix</span>
<span class="n">corr_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_var</span><span class="p">),</span> <span class="n">rho</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># define the mean-vector </span>
<span class="n">mean_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_var</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=053cd440-2904-4e41-a013-6ee64666d277">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=4297c171-76d5-466f-b821-471489740635">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># simulate data from a multivariate normal distribution </span>
<span class="n">sim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean_vec</span><span class="p">,</span> <span class="n">corr_mat</span><span class="p">,</span> <span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">))</span>

<span class="c1"># calculate covariance matrices</span>
<span class="n">estimated_covariances_matrices</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">)]</span>

<span class="c1"># calculate correlation matrices</span>
<span class="n">estimated_correlation_matrices</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span> <span class="o">*</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">estimated_covariances_matrices</span><span class="p">]</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=5595ac6c-11ea-4d29-b073-93939e05322a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">estimated_correlation_matrices</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=54c87906-135d-49bb-aaea-4f0fc21e0f8c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [68]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">estimated_correlation_matrices</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Correlation estimate"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Correlation estimates between the two first variables"</span><span class="p">);</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=a02ff809-d4a1-470f-a1ea-35b21a0a0c90">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-2">
        Problem 2
        <a class="anchor-link" href="#Problem-2">
         ¶
        </a>
       </h2>
       <p>
        What happens if we increase $\rho$?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=3f4a33cd-d566-4ca1-bb6c-68fe66a27eb0">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [69]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># define input parameters</span>
<span class="n">rho</span> <span class="o">=</span> <span class="mf">0.9</span>
<span class="n">num_var</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">num_obs</span> <span class="o">=</span> <span class="mi">25</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10_000</span>

<span class="c1"># define the correlation matrix</span>
<span class="n">corr_mat_rho_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">((</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_var</span><span class="p">),</span> <span class="n">rho</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">fill_diagonal</span><span class="p">(</span><span class="n">corr_mat_rho_up</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

<span class="c1"># define the mean-vector </span>
<span class="n">mean_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">num_var</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f77cf98a-3e07-4fc0-894d-39e9dc278ae4">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [70]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># simulate data from a multivariate normal distribution </span>
<span class="n">sim_data_rho_up</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean_vec</span><span class="p">,</span> <span class="n">corr_mat_rho_up</span><span class="p">,</span> <span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">))</span>

<span class="c1"># calculate covariance matrices</span>
<span class="n">estimated_covariances_matrices_rho_up</span> <span class="o">=</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data_rho_up</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">)]</span>

<span class="c1"># calculate correlation matrices</span>
<span class="n">estimated_correlation_matrices_rho_up</span> <span class="o">=</span> <span class="p">[</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">c</span><span class="p">)))</span> <span class="o">*</span> <span class="n">c</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">estimated_covariances_matrices_rho_up</span><span class="p">]</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=02c264c0-91f3-4512-a26a-aeec28058973">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [71]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">estimated_correlation_matrices</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">estimated_correlation_matrices_rho_up</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Correlation estimate"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Correlation estimates between the two first variables"</span><span class="p">);</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=cb34178f-a51b-4147-8598-a86c1676f0a6">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Problem-3">
        Problem 3
        <a class="anchor-link" href="#Problem-3">
         ¶
        </a>
       </h2>
       <p>
        What happens if you apply the
        <a href="https://en.wikipedia.org/wiki/Fisher_transformation">
         Fisher transformation
        </a>
        $z = \frac{1}{2} \ln \frac{1 + \hat{\rho}}{1 - \hat{\rho}} = \text{artanh}(\hat{\rho})$?
       </p>
       <h3 id="Solution">
        Solution
        <a class="anchor-link" href="#Solution">
         ¶
        </a>
       </h3>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=e32ad5ec-af1e-48f7-9c50-65b961c90282">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [81]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">estimated_correlation_matrices</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctanh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">estimated_correlation_matrices_rho_up</span><span class="p">)[:,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.75</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">xlabel</span><span class="o">=</span><span class="s2">"Correlation estimate"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Correlation estimates between the two first variables"</span><span class="p">);</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [1]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib.patches</span> <span class="kn">import</span> <span class="n">Polygon</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">animation</span><span class="p">,</span> <span class="n">cm</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">from</span> <span class="nn">scipy.optimize</span> <span class="kn">import</span> <span class="n">minimize</span>
<span class="kn">from</span> <span class="nn">functools</span> <span class="kn">import</span> <span class="n">reduce</span>

<span class="kn">from</span> <span class="nn">sklearn.neighbors</span> <span class="kn">import</span> <span class="n">KernelDensity</span>
<span class="kn">from</span> <span class="nn">sklearn.covariance</span> <span class="kn">import</span> <span class="n">LedoitWolf</span>

<span class="kn">from</span> <span class="nn">statsmodels.tools.numdiff</span> <span class="kn">import</span> <span class="n">approx_fprime</span><span class="p">,</span> <span class="n">approx_hess</span>

<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Union</span><span class="p">,</span> <span class="n">List</span><span class="p">,</span> <span class="n">Tuple</span>

<span class="c1"># convex optimization </span>
<span class="kn">import</span> <span class="nn">cvxpy</span> <span class="k">as</span> <span class="nn">cp</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=f06c9acd">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="The-covariance-and-correlation-matrix">
        The covariance and correlation matrix
        <a class="anchor-link" href="#The-covariance-and-correlation-matrix">
         ¶
        </a>
       </h1>
       <p>
        As we previously have discussed covariance and correlation measure the linear dependence between stochastic variables. The
        <a href="https://en.wikipedia.org/wiki/Covariance_matrix">
         <strong>
          covariance matrix
         </strong>
        </a>
        is a square matrix giving the covariance between each pair of elements of a given random vector. If we consider a $N$ dimensional random vector, $\mathbf{X}$, then the $N \times N$ matrix is a covariance matrix if
       </p>
       <ul>
        <li>
         The matrix is symmetric
        </li>
        <li>
         The matrix has the variances in the diagonal
        </li>
        <li>
         The eigenvalues of the matrix are all non-negative (the matrix is positive semi-definite)
        </li>
       </ul>
       <p>
        We will write
       </p>
       $$
\boldsymbol{\Sigma} = \text{Var} [\mathbf {X} ]= \text{Cov} [\mathbf {X} ]=\text {E} \left[(\mathbf {X} -\text {E} [\mathbf {X} ])(\mathbf {X} -\text {E} [\mathbf {X} ])^\top \right]
$$
       <p>
        The last condition implies that the variance of any linear combination of $\mathbf{X}$, say $\mathbf{a}\mathbf{X}$, always will be larger than (or equal to) zero since
       </p>
       $$
\text{Var}[\mathbf{a}  \mathbf {X} ] = \mathbf{a}^\top \text{Var}[\mathbf {X} ] \mathbf{a} \geq 0
$$
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Correlation#Correlation_matrices">
         <strong>
          correlation matrix
         </strong>
        </a>
        constains the correlations instead of the covariances and satisfies the conditions
       </p>
       <ul>
        <li>
         The matrix is symmetric
        </li>
        <li>
         The matrix has ones in the diagonal
        </li>
        <li>
         The eigenvalues of the matrix are all non-negative (the matrix is positive semi-definite)
        </li>
       </ul>
       <h2 id="The-sample-covariance-and-correlation-matrix">
        The sample covariance and correlation matrix
        <a class="anchor-link" href="#The-sample-covariance-and-correlation-matrix">
         ¶
        </a>
       </h2>
       <p>
        Generally, the covariance and correlation matrix of some random vector are unobserved. Thus, we need to replace them with consistent estimators.
       </p>
       <p>
        If we let $\mathbf{X}$ be $T \times N$ matrix of $T$ independent and identically distributed (iid) observations on a system of $N$ random variables with zero mean (demeaned data) and covariance matrix $\boldsymbol{\Sigma}$
       </p>
       $$
\mathbf{S}_T = \frac{1}{T}\mathbf{X}^\top \mathbf{X}
$$
       <p>
        If $\mathbf{X}$ does not have zero mean, we need to estimate the mean and demean the data
       </p>
       $$
\mathbf{S}_T = \frac{1}{T}(\mathbf{X} - \bar{\mathbf{X}})^\top (\mathbf{X} - \bar{\mathbf{X}})
$$
       <p>
        The problem with the sample covariance estimator is that many applications in finance (e.g. portfolio optimization) require an invertible and well-conditioned covariance matrix (inversion does not increase estimation error). However, the sample covariance matrix is typically not well-conditioned and may in some case not even be invertible. This problem is in particular relevant when $N$ is large compared to $T$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=2ff6d07c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Thinking-about-the-uncertainty-of-the-sample-covariance-and-correlation-matrix">
        Thinking about the uncertainty of the sample covariance and correlation matrix
        <a class="anchor-link" href="#Thinking-about-the-uncertainty-of-the-sample-covariance-and-correlation-matrix">
         ¶
        </a>
       </h2>
       <p>
        Assume that the random vector $\mathbf{X} \sim MVN(\boldsymbol{\mu}, \boldsymbol{\Sigma})$ follows a i.i.d. multivariate normal distribution. In this case, it is possible to show that conditional distribution of the sample mean $\bar{\mathbf{X}}$ is given by
       </p>
       $$
\bar{\mathbf{X}} = \frac{1}{T} \sum_{t=1}^T \mathbf{X}_t \sim MVN(\boldsymbol{\mu}, \frac{1}{T} \boldsymbol{\Sigma})
$$
       <p>
        and it is possible to show that the conditional distribution of the sample covariance is given by
       </p>
       $$
\mathbf{S}_T \sim Wishart(T-1, \frac{1}{T}\Sigma)
$$
       <p>
        <strong>
         Example: The case $N=1$
        </strong>
       </p>
       <p>
        In the univariate case, we obtain the special case
       </p>
       $$
\bar{\mathbf{X}} \sim N(\mu, \frac{\sigma^2}{T})
$$
       <p>
        and
       </p>
       $$
\mathbf{S}_T \sim Wishart(T-1, \frac{\sigma^2}{T})
$$
       <p>
        which is equivalent to
       </p>
       $$
T\frac{\mathbf{S}_T}{\sigma^2} \sim \chi^2_{T-1}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=143ea44b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [2]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">sigma</span> <span class="o">=</span> <span class="mf">0.15</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">0.06</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">10000</span>

<span class="n">m_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">0.12</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">s_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.00001</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="c1"># sim_sample_mean = stats.norm.rvs(loc=mu, scale=sigma / np.sqrt(T), size=num_sim)</span>
<span class="c1"># sim_sample_variance = stats.wishart.rvs(df=T-1, scale=sigma**2 / T, size=num_sim)</span>

<span class="c1"># simulate data</span>
<span class="n">sim_data</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_sim</span><span class="p">,</span> <span class="n">T</span><span class="p">))</span>

<span class="c1"># estimate sample mean and variance</span>
<span class="n">sim_sample_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sim_sample_variance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">ddof</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># calculate pdf values</span>
<span class="n">pdf_sample_mean</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">m_eval</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
<span class="n">pdf_sample_variance</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">wishart</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">s_eval</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">T</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=b92dde9d">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [3]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Sample distribution </span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>

<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_sample_mean</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">m_eval</span><span class="p">,</span> <span class="n">pdf_sample_mean</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Density"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of sample mean"</span><span class="p">)</span>


<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">sim_sample_variance</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"navy"</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">s_eval</span><span class="p">,</span> <span class="n">pdf_sample_variance</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"darkred"</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Density"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Distribution of sample variance"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ba13ac16">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Simulating distribution of the minimum-variance portfolio
        </strong>
       </p>
       <p>
        Assume that the monthly return of 10 assets follows a multivariate normal distribution
       </p>
       $$
\boldsymbol{R} \sim MVN(\mathbf{0}, \mathbf{I}_{10} \cdot 0.05^2)
$$
       <p>
        Thus, all assets are uncorrelated with standard devation $\sigma_i = 0.05, i = 1, ..., 10$.
       </p>
       <p>
        We want to simulate the sample covariance and determine the corresponding minimum-variance portfolio for 10000 simulations assuming a estimation window of 120 months. Thereafter, we want to plot the simulated distribution of the minimum-variance portfolio weights.
       </p>
       <p>
        Note that the the global minimum variance portfolio is the solution to the optimization problem
       </p>
       $$
\mathbf{w}_{\text{GMV}} = \underset{\mathbf{w}}{\text{arg min }} \mathbf{w}^\top \boldsymbol{\Sigma} \mathbf{w}
$$
       <p>
        subject to the budget constraint and positivity constriants
       </p>
       $$
\begin{align}
\mathbf{w}^\top \mathbf{1} &amp;amp;= 1 \\
w_i &amp;amp;\geq 0, \; i=1,..., N
\end{align}
$$
       <p>
        We know that the optimal portfolio, knowing the true covariance matrix, is an equal weighted portfolio.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=62245805">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [4]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define inputs</span>
<span class="sd">"""</span>

<span class="n">T</span> <span class="o">=</span> <span class="mi">120</span>
<span class="n">num_assets</span> <span class="o">=</span> <span class="mi">10</span> 
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">cov_mat_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span> <span class="o">*</span> <span class="mf">0.05</span><span class="o">**</span><span class="mi">2</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=dae1c4be">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [5]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># optimization variable </span>
<span class="n">w</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">(</span><span class="n">num_assets</span><span class="p">)</span>

<span class="c1"># define constraints </span>
<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">w</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">w</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Simulation and optimization </span>
<span class="sd">"""</span>

<span class="n">opt_ports</span> <span class="o">=</span> <span class="p">[]</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span> 
    
    <span class="c1"># simulate covariance matrix</span>
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">wishart</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">df</span><span class="o">=</span><span class="n">T</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span> <span class="n">cov_mat_true</span> <span class="o">/</span> <span class="n">T</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    
    <span class="c1"># define problem </span>
    <span class="n">variance</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">quad_form</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">assume_PSD</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">prob</span> <span class="o">=</span>  <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="n">variance</span><span class="p">),</span> <span class="n">constraints</span><span class="p">)</span>
    
    <span class="c1"># solve problem</span>
    <span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
    
    <span class="c1"># store values</span>
    <span class="n">opt_ports</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>

<span class="c1"># transform to numpy array</span>
<span class="n">opt_ports</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">opt_ports</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=9f2bba6b">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [6]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">boxplot</span><span class="p">(</span><span class="n">opt_ports</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="n">ylabel</span><span class="o">=</span><span class="s2">"Portfolio weights (in %)"</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s2">"Minimum-variance allocations"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=4ee22695">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        This example show that it can be hard to find an optimal portfolio when relying on sample estimates!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=incoming-mirror">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Fixing-the-covariance-and-correlation-matrix">
        Fixing the covariance and correlation matrix
        <a class="anchor-link" href="#Fixing-the-covariance-and-correlation-matrix">
         ¶
        </a>
       </h2>
       <p>
        We require that the covariance (and correlation) matrix is positive semi-definite corresponding to all the eigenvalues being non-negative. Thus, we could implement a check for positive semi-definiteness as
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=plain-needle">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [7]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">check_positive_semi_definite_eig</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Checks that a symmetric square matrix is positive semi-deinite. </span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    matrix: </span>
<span class="sd">        Symmetric, Square matrix. </span>
<span class="sd">        </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Boolean indicating whether the matrix is positive semi-definite</span>
<span class="sd">        </span>
<span class="sd">    """</span>
    
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span> <span class="o">&amp;gt;=</span> <span class="mi">0</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=acute-anderson">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [8]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># a positive semi-definite matrix</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
                   <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]])</span>

<span class="n">check_positive_semi_definite_eig</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=acoustic-powell">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [9]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># a non positive semi-definite matrix</span>
<span class="n">not_a_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">]])</span>

<span class="n">check_positive_semi_definite_eig</span><span class="p">(</span><span class="n">not_a_cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=elder-auditor">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        A computationally more efficient approach is to use
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=indie-table">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [10]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">check_positive_semi_definite</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">):</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Checks that a symmetric square matrix is positive semi-deinite. </span>
<span class="sd">    </span>
<span class="sd">    See https://stackoverflow.com/questions/16266720/find-out-if-matrix-is-positive-definite-with-numpy</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    </span>
<span class="sd">    matrix: </span>
<span class="sd">        Symmetric, Square matrix. </span>
<span class="sd">        </span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        Boolean indicating whether the matrix is positive semi-definite</span>
<span class="sd">        </span>
<span class="sd">    """</span>
    
    <span class="k">try</span><span class="p">:</span>
        <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">cholesky</span><span class="p">(</span><span class="n">matrix</span> <span class="o">+</span> <span class="mf">1e-16</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">LinAlgError</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=commercial-romantic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [11]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># a positive semi-definite matrix</span>
<span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">]])</span>

<span class="n">check_positive_semi_definite</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=human-track">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [12]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># a non positive semi-definite matrix</span>
<span class="n">not_a_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">],</span>
                         <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.01</span><span class="p">]])</span>

<span class="n">check_positive_semi_definite</span><span class="p">(</span><span class="n">not_a_cov_mat</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=level-respondent">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [13]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Checking performance - second method much quicker</span>
<span class="sd">"""</span>

<span class="n">N</span> <span class="o">=</span> <span class="mi">1000</span>

<span class="c1"># set random seed </span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># simulate a random covariance matrix</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">cov_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=reliable-potato">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [14]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">%</span><span class="k">timeit</span> check_positive_semi_definite_eig(cov_true)
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=buried-antique">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [15]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="o">%</span><span class="k">timeit</span> check_positive_semi_definite(cov_true)
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=recent-luther">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Spectral-decomposition">
        Spectral decomposition
        <a class="anchor-link" href="#Spectral-decomposition">
         ¶
        </a>
       </h3>
       <p>
        If we conclude that the estimated (or assumed) covariance matrix is not positive semi-definite, we need to fix it somehow. There exists a large literature on this topic.
       </p>
       <p>
        <a href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=1969689">
         Rebonato and Jaeckel
        </a>
        consider for instance
        <em>
         spectral decomposition
        </em>
        . The idea is to notice that every positive semi-definite matrix can be written as (here the covariance matrix)
       </p>
       $$
\boldsymbol{\Sigma} = \mathbf{A} \mathbf{A}^\top
$$
       <p>
        The characteristic equation defining the eigenvalues
       </p>
       $$
\boldsymbol{\Sigma} \mathbf{V} = \boldsymbol{\Lambda} \mathbf{V}
$$
       <p>
        where $\mathbf{V}$ is the matrix of eigenvectors and $\boldsymbol{\Lambda}$ is a diagonal matrix of eigenvalues. If $\boldsymbol{\Lambda}$ contains negative eigenvalues, we may simple set them equal to zero or some small positive number. We label this new matrix for $\boldsymbol{\Lambda}^*$.
       </p>
       <p>
        Define
       </p>
       $$
\mathbf{A}^* = \mathbf{V} \sqrt{\boldsymbol{\Lambda}^*}
$$
       <p>
        such that we can define
       </p>
       $$
\boldsymbol{\Sigma}^* = \mathbf{A}^* (\mathbf{A}^*)^\top
$$
       <p>
        If we are looking at the correlation matrix where we need the diagonal elements to all be equal to one, we can define
       </p>
       $$
\mathbf{A}^* = \sqrt{\mathbf{T}} \mathbf{V} \sqrt{\boldsymbol{\Lambda}^*}
$$
       <p>
        where $\mathbf{T}$ is a diagonal matrix with elements equal to $t_i  = \left[\sum_{n=1}^N v_{in}^2 \lambda_i^*\right]^{-1}$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=disciplinary-label">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [16]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">fix_nonpositive_semidefinite</span><span class="p">(</span><span class="n">matrix</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">"spectral"</span><span class="p">,</span> <span class="n">scale_diag</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    
    <span class="c1"># Eigendecomposition</span>
    <span class="n">q</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">matrix</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">"spectral"</span><span class="p">:</span>
        <span class="c1"># Remove negative eigenvalues</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">q</span> <span class="o">&amp;gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="n">scale_diag</span><span class="p">:</span>
            
            <span class="c1"># scaling matrix </span>
            <span class="n">scale_diag_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="n">V</span><span class="o">**</span><span class="mi">2</span> <span class="o">@</span> <span class="n">q</span><span class="p">))</span>

            <span class="c1"># scaled eigenvector</span>
            <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">scale_diag_mat</span><span class="p">)</span> <span class="o">@</span> <span class="n">V</span>
        
        <span class="c1"># Reconstruct matrix</span>
        <span class="n">fixed_matrix</span> <span class="o">=</span> <span class="n">V</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">@</span> <span class="n">V</span><span class="o">.</span><span class="n">T</span>
        
    <span class="k">elif</span> <span class="n">method</span> <span class="o">==</span> <span class="s2">"diag"</span><span class="p">:</span>
        
        <span class="n">min_eig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">q</span><span class="p">)</span>
        <span class="n">fixed_matrix</span> <span class="o">=</span> <span class="n">matrix</span> <span class="o">-</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">min_eig</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">matrix</span><span class="p">))</span>
        
        <span class="k">if</span> <span class="n">scale_diag</span><span class="p">:</span>
            <span class="n">sqrt_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">fixed_matrix</span><span class="p">))</span>
            <span class="n">fixed_matrix</span> <span class="o">=</span> <span class="n">fixed_matrix</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">sqrt_diag</span><span class="p">,</span> <span class="n">sqrt_diag</span><span class="p">)</span>
            <span class="n">fixed_matrix</span><span class="p">[</span><span class="n">fixed_matrix</span> <span class="o">&amp;lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">fixed_matrix</span><span class="p">[</span><span class="n">fixed_matrix</span> <span class="o">&amp;gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span>
    
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">NotImplementedError</span><span class="p">(</span><span class="s2">"Method not implemented"</span><span class="p">)</span>
        
    <span class="k">return</span> <span class="n">fixed_matrix</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=earlier-choice">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [17]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Positive semi-definite</span>
<span class="sd">"""</span>

<span class="n">C</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
              <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
              <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">q</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">C</span><span class="p">)</span>
<span class="n">A</span> <span class="o">=</span> <span class="n">V</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">q</span><span class="p">))</span>
<span class="n">A</span>
<span class="n">q</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=nutritional-vision">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Small change may result in the matrix no longer being a correlation / covariance matrix</span>
<span class="sd">"""</span>

<span class="n">C_bad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
                  <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">q</span><span class="p">,</span> <span class="n">V</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">C_bad</span><span class="p">)</span>
<span class="c1">#A = V @ np.sqrt(np.diag(q)) &amp;lt;- throws an error </span>
<span class="c1">#A</span>

<span class="n">q</span> <span class="c1"># &amp;lt;- negative eigenvalue</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=ideal-seven">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">C_fixed</span> <span class="o">=</span> <span class="n">fix_nonpositive_semidefinite</span><span class="p">(</span><span class="n">C_bad</span><span class="p">,</span> <span class="n">scale_diag</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">C_fixed</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=balanced-diabetes">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">q_fixed</span><span class="p">,</span> <span class="n">V_fixed</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">C_fixed</span><span class="p">)</span>
<span class="n">q_fixed</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=85990403">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Find-the-nearest-covariance-or-correlation-matrix-by-minimizing-the-Frobenius-norm">
        Find the nearest covariance or correlation matrix by minimizing the Frobenius norm
        <a class="anchor-link" href="#Find-the-nearest-covariance-or-correlation-matrix-by-minimizing-the-Frobenius-norm">
         ¶
        </a>
       </h3>
       <p>
        We could consider an optimization problem of the form
       </p>
       $$
\min \frac{1}{2} \Vert \mathbf{G} - \mathbf{X} \Vert^2
$$
       <p>
        subject to
       </p>
       $$
\mathbf{X}_{ii} = 1, \; i = 1, ..., n
$$
       <p>
        and
       </p>
       $$
\mathbf{X} \in \mathcal{S}^n
$$
       <p>
        Thus, $\mathbf{X}$ is a symmetric, positive definite matrix.
       </p>
       <p>
        It is possible to show that one can reformulate the problem as a semidefinite program or second-order program - we will just use
        <code>
         cvxpy
        </code>
        to define the problem. It should be noted that for large correlation matrices ($n$ large), then it would be infeasible to solve the problem using standard methods.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=4cc4d5c0">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Define a bad correlation target matrix</span>
<span class="sd">"""</span>
<span class="n">corr_mat_target</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">],</span>
                           <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.3</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">check_positive_semi_definite</span><span class="p">(</span><span class="n">corr_mat_target</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=f54570a8">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Fix the correlation matrix</span>
<span class="sd">"""</span>

<span class="n">X</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Variable</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">symmetric</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">constraints</span> <span class="o">=</span> <span class="p">[</span><span class="n">X</span><span class="o">&amp;gt;&amp;gt;</span><span class="mi">0</span><span class="p">]</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span> 
    <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="n">i</span><span class="p">]</span> <span class="o">==</span><span class="mi">1</span><span class="p">)</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">cp</span><span class="o">.</span><span class="n">Problem</span><span class="p">(</span><span class="n">cp</span><span class="o">.</span><span class="n">Minimize</span><span class="p">(</span><span class="mf">0.5</span><span class="o">*</span><span class="n">cp</span><span class="o">.</span><span class="n">norm2</span><span class="p">(</span><span class="n">X</span> <span class="o">-</span> <span class="n">corr_mat_target</span><span class="p">)),</span>
                  <span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=1eb7ee8a">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">prob</span><span class="o">.</span><span class="n">is_dcp</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=6280ff16">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">prob</span><span class="o">.</span><span class="n">solve</span><span class="p">()</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=21ed8b7e">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Fixed correlation matrix</span>
<span class="sd">"""</span>

<span class="n">X</span><span class="o">.</span><span class="n">value</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=27c92ad7">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">check_positive_semi_definite</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">value</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=exceptional-silence">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Other-approaches">
        Other approaches
        <a class="anchor-link" href="#Other-approaches">
         ¶
        </a>
       </h3>
       <p>
        For more advanced approaches the reader is referred to e.g.
        <a href="http://eprints.maths.manchester.ac.uk/232/1/paper3.pdf">
         Higham (2002), Computing the Nearest Correlation Matrix—
A Problem from Finance
        </a>
        . See also
        <a href="https://nhigham.com/2013/02/13/the-nearest-correlation-matrix/">
         here
        </a>
        .
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=aboriginal-wilderness">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Shrinkage-estimation">
        Shrinkage estimation
        <a class="anchor-link" href="#Shrinkage-estimation">
         ¶
        </a>
       </h2>
       <p>
        As already mentioned, if the sample size, $T$, is small compared to the number of variables (e.g. assets), the sample covariance / correlation estimator may be very unstable. If $T&amp;lt;N$, then the estimated covariance matrix is singular.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=through-climate">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">sim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=adequate-advisory">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># We will get an error message if we run the below command</span>
<span class="c1"># np.linalg.inv(np.cov(sim_data, rowvar=False))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=emerging-basement">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">0.7</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">],</span>
                    <span class="p">[</span><span class="mf">0.7</span><span class="p">,</span> <span class="mf">0.4</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">]])</span>

<span class="n">sim_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="mi">3</span><span class="p">),</span> <span class="n">cov_mat</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigvals</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">sim_data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=suburban-plastic">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        In many finance applications the sample size may be small relative the number of variables (think of 10 years of monthly return observations and 100 assets), why we need better estimators for the covariance matrix.
       </p>
       <p>
        A number of alternative covariance estimators has been suggested that rely on the concept of shrinkage. The simplest versions of the shrinkage estimators is defined by the convex combination of an empirical covariance matrix $\mathbf{S}_T$ (the sample covariance) and some suitable shrinkage target, say $\mathbf{B}$. The estimator will then be defined as
       </p>
       $$
\delta \mathbf{S}_T + (1-\delta) \mathbf{B}
$$
       <p>
        where the parameter $\delta$ (shrinkage intensity) determines the relative weight of the empirical covariance and the shrinkage target. The shrinkage intensity will typically converge to zero with the sample size such that asymptotically, we will have the consistent estimator. The shrinkage estimator will always be positive definite and well conditioned!
       </p>
       <p>
        A number of shrinkage targets has been
        <a href="https://en.wikipedia.org/wiki/Estimation_of_covariance_matrices">
         suggested
        </a>
       </p>
       <ul>
        <li>
         The identity matrix scaled by the average sample variance
        </li>
        <li>
         The single index model
        </li>
        <li>
         The constant correlation model (all pairwise correlations are assumed equal)
        </li>
        <li>
         The two-parameter matrix (all variances and all covariances are equal)
        </li>
        <li>
         The diagonal matrix containing the sample variances on the diagonal and zeros elsewhere
        </li>
        <li>
         The identity matrix
        </li>
       </ul>
       <p>
        We will look at one example of how to implement a shrinkage estimator. The
        <code>
         scikit-learn
        </code>
        package contains different shrinkage estimators. See
        <a href="https://scikit-learn.org/stable/modules/covariance.html">
         here
        </a>
        for documentation.
       </p>
       <h3 id="Ledoit-and-Wolf-(2004)">
        Ledoit and Wolf (2004)
        <a class="anchor-link" href="#Ledoit-and-Wolf-(2004)">
         ¶
        </a>
       </h3>
       <p>
        <a href="https://www.sciencedirect.com/science/article/pii/S0047259X03000964">
         Ledoit and Wolf (2004)
        </a>
        define a shrinkage estimator for the covariance matrix
       </p>
       $$
\boldsymbol{\Sigma}^* = \rho_1 \mathbf{I} + \rho_2 \mathbf{S}
$$
       <p>
        with $\mathbf{S} = \frac{1}{T}\mathbf{X}^\top \mathbf{X} $ (the sample covariance) where $\mathbf{X}$ is $T \times N$ matrix of $T$ independent and identically distributed (iid) observations on a system of $N$ random variables with zero mean (demeaned data) and covariance matrix $\boldsymbol{\Sigma}$.
       </p>
       <p>
        <a href="https://www.sciencedirect.com/science/article/pii/S0047259X03000964">
         Ledoit and Wolf (2004)
        </a>
        show (when defining the Frobenius norm $\Vert \mathbf{A} \Vert = \sqrt{\text{tr} (\mathbf{A}\mathbf{A}^\top) / N} $ ) that the optimal values of $\rho_1$ and $\rho_2$ are given by
       </p>
       $$
\boldsymbol{\Sigma}^* = \frac{\beta^2}{\delta^2} \mu \mathbf{I} + \frac{\alpha^2}{\delta^2} \mathbf{S}
$$
       <p>
        with
       </p>
       \begin{align}
\mu &amp;amp;= \frac{1}{N}\text{tr} (\boldsymbol{\Sigma}) \\
\alpha^2 &amp;amp;= \Vert \boldsymbol{\Sigma} - \mu \mathbf{I} \Vert \\
\beta^2 &amp;amp; = \text{E} \left[\Vert \mathbf{S} - \boldsymbol{\Sigma} \Vert^2 \right]\\
\delta^2 &amp;amp; = \text{E} \left[\Vert \mathbf{S} - \mu \mathbf{I} \Vert^2 \right]
\end{align}
       <p>
        The problem with the above estimator is that it relies on the unobserved covariance matrix $\boldsymbol{\Sigma}$. We do not need to consistently estimate $\boldsymbol{\Sigma}$, but only find consistent estimators for $\mu, \alpha^2, \beta^2$ and $\delta^2$. To this end, we define a consistent estimator for $\mu$ as the sample counterpart (we add $_T$ to denote that the estimator depends on the sample length)
       </p>
       \begin{align}
m_T &amp;amp;= \frac{1}{N}\text{tr} (\mathbf{S}_T)
\end{align}
       <p>
        A consistent estimator of $\delta^2  = \text{E} \left[\Vert \mathbf{S} - \mu \mathbf{I} \Vert^2 \right]$ is also the sample counterpart
       </p>
       $$
d_T^2 = \Vert \mathbf{S}_T  - \mu \mathbf{I} \Vert^2
$$
       <p>
        We can write
       </p>
       $$
\mathbf{S}_T = \frac{1}{T}\mathbf{X}^\top \mathbf{X} = \frac{1}{T} \sum_{t=1}^T \mathbf{x}_t \mathbf{x}_t^\top
$$
       <p>
        where $\mathbf{x}$ is the $N \times 1$ vector representing the $t$'th row of $\mathbf{X}$. Since, we assume independence between $t$'s then we can use the deviations from the average.
        <a href="https://www.sciencedirect.com/science/article/pii/S0047259X03000964">
         Ledoit and Wolf (2004)
        </a>
        suggest to define
       </p>
       $$
\bar{b}_T^2 = \frac{1}{T^2} \sum_{t=1}^T \Vert \mathbf{x}_t \mathbf{x}_t^\top - \mathbf{S}_T \Vert^2
$$
       <p>
        and  $b_T^2 = \min (\bar{b}_T^2, d_T^2)$. Finally, $a_T^2 = d_T^2 - b_T^2$.
       </p>
       <p>
        We can now estimate
       </p>
       $$
\mathbf{S}_T^* = \frac{b_T^2}{d_T^2} m_T \mathbf{I} + \frac{a_T^2}{d_T^2} \mathbf{S}_T
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=quarterly-heritage">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">ledoit_wolf_shrinkage</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">demean</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span> 
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Computes the Ledoit and Wolf (2004) shrinkage covariance matrix </span>
<span class="sd">    </span>
<span class="sd">    See https://www.sciencedirect.com/science/article/pii/S0047259X03000964</span>
<span class="sd">    </span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    data:</span>
<span class="sd">        Num. observations x Num. variables</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray </span>
<span class="sd">        Covariance matrix </span>
<span class="sd">    </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="k">if</span> <span class="n">demean</span><span class="p">:</span> 
        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>
    
    <span class="n">T</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># calculate sample covariance matrix</span>
    <span class="n">S</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">T</span> <span class="o">@</span> <span class="n">data</span> <span class="o">/</span> <span class="n">T</span> <span class="c1"># np.cov(data, rowvar=False)</span>
    
    <span class="c1"># get dimension </span>
    <span class="n">N</span> <span class="o">=</span> <span class="n">S</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    
    <span class="c1"># calculate constant variance </span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">trace</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">/</span> <span class="n">N</span>
    
    <span class="c1"># shrinkage target</span>
    <span class="n">shrink_target</span> <span class="o">=</span> <span class="n">m</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">N</span><span class="p">)</span>
    
    <span class="c1"># delta</span>
    <span class="n">d2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">S</span> <span class="o">-</span> <span class="n">shrink_target</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s1">'fro'</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">/</span> <span class="n">N</span>
    
    <span class="c1"># beta</span>
    <span class="n">b2_bar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:],</span> <span class="n">data</span><span class="p">[</span><span class="n">t</span><span class="p">,</span> <span class="p">:])</span> <span class="o">-</span> <span class="n">S</span><span class="p">,</span> <span class="nb">ord</span><span class="o">=</span><span class="s1">'fro'</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">N</span>  
                     <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">T</span><span class="p">)])</span> <span class="o">/</span> <span class="p">(</span><span class="n">T</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    
    <span class="n">b2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">d2</span><span class="p">,</span> <span class="n">b2_bar</span><span class="p">])</span>
    
    <span class="c1"># alpha </span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">d2</span> <span class="o">-</span> <span class="n">b2</span>
    
    <span class="c1"># calculate new covariance matrix </span>
    <span class="n">shrinkage_cov_mat</span> <span class="o">=</span> <span class="p">(</span><span class="n">b2</span> <span class="o">/</span> <span class="n">d2</span><span class="p">)</span> <span class="o">*</span> <span class="n">shrink_target</span> <span class="o">+</span>  <span class="p">(</span><span class="n">a2</span> <span class="o">/</span> <span class="n">d2</span><span class="p">)</span> <span class="o">*</span> <span class="n">S</span>
    
    
    <span class="k">return</span> <span class="n">shrinkage_cov_mat</span> 
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=employed-bunny">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Multivariate normal
        </strong>
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=interim-license">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">real_cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">.4</span><span class="p">,</span> <span class="mf">.2</span><span class="p">],</span>
                     <span class="p">[</span><span class="mf">.2</span><span class="p">,</span> <span class="mf">.8</span><span class="p">]])</span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                     <span class="n">cov</span><span class="o">=</span><span class="n">real_cov</span><span class="p">,</span>
                                     <span class="n">size</span><span class="o">=</span><span class="mi">50</span><span class="p">)</span>

<span class="c1"># sample covariance matrix </span>
<span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=signed-plane">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># ledoit and wolf (2004)</span>
<span class="n">ledoit_wolf_shrinkage</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="c1"># &amp;lt;- we shrink the diagonals towards the average variance and the cross-terms towards zero</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=tight-equipment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># check with sklearn </span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">LedoitWolf</span><span class="p">()</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
<span class="n">cov</span><span class="o">.</span><span class="n">covariance_</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=monthly-flight">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Simulation study
        </strong>
       </p>
       <p>
        We define the
        <em>
         percentage relative improvement in average loss
        </em>
        of $\mathbf{S}^*$ as (we omit $_T$ for simplicity)
       </p>
       $$
\text{PRIAL}(\mathbf{S}^*) = \frac{\text{E}[\Vert \mathbf{S} - \boldsymbol{\Sigma} \Vert]^2 - \text{E}[\Vert \mathbf{S}^* - \boldsymbol{\Sigma} \Vert]^2}{\text{E}[\Vert \mathbf{S} - \boldsymbol{\Sigma} \Vert]^2}
$$
       <p>
        If PRIAL is positive, then the shrinkage estimator performs better than the sample covariance.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=impressed-christmas">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">N</span> <span class="o">=</span> <span class="mi">100</span>
<span class="n">T</span> <span class="o">=</span> <span class="mi">55</span>
<span class="n">num_sim</span> <span class="o">=</span> <span class="mi">500</span>

<span class="c1"># set random seed </span>
<span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

<span class="c1"># simulate a random covariance matrix "the true covariance matrix"</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">N</span><span class="p">))</span>
<span class="n">cov_true</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="mf">0.01</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">))</span>

<span class="n">sample_sizes</span> <span class="o">=</span> <span class="p">[</span><span class="mi">10</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">1000</span><span class="p">]</span>

<span class="n">prial</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>

<span class="k">for</span> <span class="n">T</span> <span class="ow">in</span> <span class="n">sample_sizes</span><span class="p">:</span>
    <span class="n">loss_sample</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="n">loss_shrinkage</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_sim</span><span class="p">):</span> 

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mean</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">N</span><span class="p">),</span>
                                             <span class="n">cov</span><span class="o">=</span><span class="n">cov_true</span><span class="p">,</span>
                                             <span class="n">size</span><span class="o">=</span><span class="n">T</span><span class="p">)</span>

        <span class="n">sample_cov_mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">shrink_cov_mat</span> <span class="o">=</span> <span class="n">ledoit_wolf_shrinkage</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

        <span class="n">loss_sample</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">sample_cov_mat</span> <span class="o">-</span> <span class="n">cov_true</span><span class="p">))</span> 
        <span class="n">loss_shrinkage</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">shrink_cov_mat</span> <span class="o">-</span> <span class="n">cov_true</span><span class="p">))</span>
    
    <span class="n">prial_temp</span> <span class="o">=</span>  <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_sample</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_shrinkage</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">N</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loss_sample</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">N</span><span class="p">)</span>
    <span class="n">prial</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">prial_temp</span><span class="p">)</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s2">"T=</span><span class="si">{}</span><span class="s2">"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">T</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"PRIAL: </span><span class="si">{:.2f}</span><span class="s2">%"</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prial_temp</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">"</span><span class="se">\n</span><span class="s2">"</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=fresh-suffering">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="A-comment">
        A comment
        <a class="anchor-link" href="#A-comment">
         ¶
        </a>
       </h3>
       <p>
        The above shrinkage estimator has rarely been applied in portfolio optimimzation since we can use stylized facts of financial markets to improve on the shrinkage target. A good shrinkage target comes as close as possible to the true covariance matrix with as few parameters as possible - a balance between accuarcy and parsimony. In finance, this means that we need to exploit the factor structure often found in e.g. stock returns. Often correlations are positive (a universe of stocks) and the average covariance is also positive.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ruled-ireland">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="A-visit-to-random-matrix-theory">
        A visit to random matrix theory
        <a class="anchor-link" href="#A-visit-to-random-matrix-theory">
         ¶
        </a>
       </h2>
       <p>
        <strong>
         Note:
        </strong>
        This sub-section follows
        <a href="https://www.amazon.com/Machine-Learning-Managers-Elements-Quantitative/dp/1108792898">
         Marcos M. Lopéz de Prado (2020), "Machine Learning for Asset Managers"
        </a>
       </p>
       <p>
        To get an idea of the amount of noise, we can consider the
        <a href="https://en.wikipedia.org/wiki/Marchenko%E2%80%93Pastur_distribution">
         Marcenko-Pastur theorem
        </a>
        . If we let $\mathbf{X}$ be a $T \times N$ matrix with independent and identically distributed obervations from at random variable with zero mean and variance $\sigma^2$, then the matrix $\mathbf{C} = \frac{1}{T} \mathbf{X}^\top \mathbf{X}$ (the covariance matrix) has eigenvalues $\lambda$ that converge ($N \to + \infty$ and $T \to + \infty$ with $1 &amp;lt; T / N &amp;lt; + \infty$) to the Marcenko-Pastur density
       </p>
       $$
f_\lambda (\lambda) = \left \{ \begin{array}{ll} \frac{T}{N} \frac{\sqrt{(\lambda_+ - \lambda)(\lambda - \lambda_-)}}{2 \pi \lambda \sigma^2} &amp;amp; \text{if } \lambda \notin [\lambda_-, \lambda_+] \\ 
0 &amp;amp; \text{if } \lambda \notin [\lambda_-, \lambda_+]\end{array} \right.
$$
       <p>
        with
       </p>
       $$
\begin{align*}
\lambda_+ &amp;amp;= \sigma^2 (1 + \sqrt{N/T})^2 \\
\lambda_- &amp;amp;= \sigma^2 (1 - \sqrt{N/T})^2
\end{align*}
$$
       <p>
        <strong>
         Example:
        </strong>
       </p>
       <p>
        Let $N = 1000$ and $T = 2000$. Simulate data when assuming that all variables are normally distributed with zero mean and unit variance. Plot the corresponding Marcenko-Pastur density.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=vocational-patch">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [35]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">marchencko_pastur_bounds</span><span class="p">(</span><span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">float</span><span class="p">,</span> <span class="nb">float</span><span class="p">]:</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates Marcencko-Pastur bounds</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    sigma:</span>
<span class="sd">        Sigma parameter.</span>
<span class="sd">    ratio:</span>
<span class="sd">        Ratio between num. of variables and num. of observations</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    Tuple[float, float]</span>
<span class="sd">        Bounds.</span>

<span class="sd">    """</span>

    <span class="n">sigma2</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">lower</span> <span class="o">=</span> <span class="n">sigma2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>
    <span class="n">upper</span> <span class="o">=</span> <span class="n">sigma2</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">ratio</span><span class="p">))</span> <span class="o">**</span> <span class="mi">2</span>

    <span class="n">bounds</span> <span class="o">=</span> <span class="p">(</span><span class="n">lower</span><span class="p">,</span> <span class="n">upper</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">bounds</span>


<span class="k">def</span> <span class="nf">marchencko_pastur_density</span><span class="p">(</span><span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">sigma</span><span class="p">:</span> <span class="nb">float</span><span class="p">,</span> <span class="n">ratio</span><span class="p">:</span> <span class="nb">float</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Calculates Marcencko-Pastur density</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    x:</span>
<span class="sd">        Points at which to evaluate the density.</span>
<span class="sd">    sigma:</span>
<span class="sd">       Sigma parameter.</span>
<span class="sd">    ratio:</span>
<span class="sd">       Ratio between num. of variables and num. of observations</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">       Densitiy.</span>

<span class="sd">    """</span>

    <span class="n">lower</span><span class="p">,</span> <span class="n">upper</span> <span class="o">=</span> <span class="n">marchencko_pastur_bounds</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>

    <span class="n">indicator</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;gt;=</span> <span class="n">lower</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">(</span><span class="n">x</span> <span class="o">&amp;lt;=</span> <span class="n">upper</span><span class="p">)</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">indicator</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="p">)):</span>
        <span class="n">temp</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">indicator</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">idx</span><span class="p">:</span>
            <span class="n">dv</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">sigma</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">upper</span> <span class="o">-</span> <span class="n">temp</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">temp</span> <span class="o">-</span> <span class="n">lower</span><span class="p">))</span> <span class="o">/</span> <span class="p">(</span><span class="n">ratio</span> <span class="o">*</span> <span class="n">temp</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dv</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=similar-sensitivity">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [36]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">n</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">t</span> <span class="o">=</span> <span class="mi">1500</span>

<span class="n">mu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
<span class="n">cov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>

<span class="n">simulated_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">multivariate_normal</span><span class="p">(</span><span class="n">mu</span><span class="p">,</span> <span class="n">cov</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">t</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">All the true eigenvalues are equal to one!</span>
<span class="sd">"""</span>

<span class="c1"># the first 10 eigenvalues</span>
<span class="n">true_eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">cov</span><span class="p">)</span>
<span class="n">true_eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="mi">10</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=pleasant-houston">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [37]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate covariance matrix (same as correlation matrix in this case) </span>
<span class="sd">"""</span>

<span class="n">corr_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">simulated_data</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>
<span class="n">eig_vals</span><span class="p">,</span> <span class="n">eig_vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">corr_matrix</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plot the density of the eigenvalues</span>
<span class="sd">"""</span>

<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">dv</span> <span class="o">=</span> <span class="n">marchencko_pastur_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">,</span>  <span class="n">n</span><span class="o">/</span><span class="n">t</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Marchencko-Pastur distribution"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Eigenvalues of sample correlation matrix"</span><span class="p">);</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">true_eigenvalues</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">bins</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"blue"</span><span class="p">,</span> <span class="n">rwidth</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Eigenvalues of true correlation matrix'</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=premium-moldova">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        When observing a high dimensional data set, we can think of eigenvalues $\lambda \in [\lambda_-, \lambda_+]$ as consistent with random behaviour and eigenvalues $\lambda \notin [\lambda_-, \lambda_+]$ as consistent with non-random behaviour. We may therefore associate $\lambda \in [0, \lambda_+]$ with noise.
       </p>
       <p>
        Below we see if we can recover the true number of signals.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=beginning-carolina">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [38]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Code adapted from Marcos M. Lopéz de Prado (2020), "Machine Learning for Asset Managers"</span>
<span class="sd">"""</span>

<span class="k">def</span> <span class="nf">fit_kde</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">"gaussian"</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
     
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">eigenvalues</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span> <span class="n">eigenvalues</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">kde</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">(</span><span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">)</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">x</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    
    <span class="n">log_prob</span> <span class="o">=</span> <span class="n">kde</span><span class="o">.</span><span class="n">score_samples</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_prob</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">simulate_random_cov_mat</span><span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Simulate a random covariance matrix with some dependence</span>
<span class="sd">    """</span>
    
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">))</span>
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">x</span> <span class="o">@</span> <span class="n">x</span><span class="o">.</span><span class="n">T</span>
    <span class="n">cov_mat</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="n">num_var</span><span class="p">))</span>
    
    <span class="k">return</span> <span class="n">cov_mat</span>


<span class="k">def</span> <span class="nf">simulate_cov_mat_noise_and_signal</span><span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">,</span>
                                      <span class="n">num_obs</span><span class="p">,</span> <span class="n">alpha</span><span class="p">):</span>
    
    <span class="n">cov_mat_noise</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cov</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">num_obs</span><span class="p">,</span> <span class="n">num_var</span><span class="p">))</span>
                           <span class="p">,</span> <span class="n">rowvar</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cov_mat_signal</span> <span class="o">=</span> <span class="n">simulate_random_cov_mat</span><span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">)</span>
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">cov_mat_noise</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">cov_mat_signal</span>
    
    <span class="k">return</span> <span class="n">cov_mat</span>

<span class="k">def</span> <span class="nf">cov_to_corr_matrix</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">):</span>
    
    <span class="n">vols</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">cov_mat</span><span class="p">))</span>
    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">cov_mat</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
    <span class="n">corr_mat</span><span class="p">[</span><span class="n">corr_mat</span> <span class="o">&amp;lt;</span> <span class="o">-</span><span class="mi">1</span><span class="p">],</span> <span class="n">corr_mat</span><span class="p">[</span><span class="n">corr_mat</span> <span class="o">&amp;gt;</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span> <span class="c1"># numerical error </span>
    
    <span class="k">return</span> <span class="n">corr_mat</span>

<span class="k">def</span> <span class="nf">corr_to_cov_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">,</span> <span class="n">vols</span><span class="p">):</span>
    
    <span class="n">cov_mat</span> <span class="o">=</span> <span class="n">corr_mat</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">vols</span><span class="p">,</span> <span class="n">vols</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">cov_mat</span>

<span class="k">def</span> <span class="nf">fitting_error</span><span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">ratio</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">eigenvalues</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="s2">"gaussian"</span><span class="p">,</span>
                  <span class="n">bandwidth</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
    
    <span class="n">mp_density</span> <span class="o">=</span> <span class="n">marchencko_pastur_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">ratio</span><span class="p">)</span>

    <span class="n">kde_density</span> <span class="o">=</span> <span class="n">fit_kde</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">kernel</span><span class="o">=</span><span class="n">kernel</span><span class="p">,</span> <span class="n">bandwidth</span><span class="o">=</span><span class="n">bandwidth</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">square</span><span class="p">(</span><span class="n">mp_density</span> <span class="o">-</span> <span class="n">kde_density</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=gentle-jamaica">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [39]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Find the sigma that fits best with the observed eigenvalues</span>
<span class="sd">"""</span>
<span class="n">alpha</span><span class="o">=</span><span class="mf">0.99</span>
<span class="n">num_var</span> <span class="o">=</span> <span class="mi">1000</span>
<span class="n">num_obs</span> <span class="o">=</span> <span class="mi">5000</span>
<span class="n">num_factors</span> <span class="o">=</span> <span class="mi">100</span> <span class="c1">#&amp;lt;- number of true factors / signals</span>

<span class="c1"># simulate correlation matrix with some dependence</span>
<span class="n">sim_cov_mat</span> <span class="o">=</span> <span class="n">simulate_cov_mat_noise_and_signal</span><span class="p">(</span><span class="n">num_var</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">,</span> <span class="n">num_obs</span><span class="p">,</span> <span class="n">alpha</span><span class="p">)</span>
<span class="n">sim_corr_mat</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">sim_cov_mat</span><span class="p">)</span>

<span class="c1"># get eigenvalues and eigenvectors</span>
<span class="n">eig_vals</span><span class="p">,</span> <span class="n">eig_vectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">sim_corr_mat</span><span class="p">)</span>


<span class="c1"># fit sigma</span>
<span class="n">x_eval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">5.0</span><span class="p">,</span> <span class="mi">10000</span><span class="p">)</span>
<span class="n">res</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">fitting_error</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span>
                        <span class="n">args</span><span class="o">=</span><span class="p">(</span><span class="n">num_var</span> <span class="o">/</span> <span class="n">num_obs</span><span class="p">,</span> <span class="n">x_eval</span><span class="p">,</span> <span class="n">eig_vals</span><span class="p">),</span>
                        <span class="n">bounds</span><span class="o">=</span><span class="p">((</span><span class="mf">1e-5</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="mf">1e-5</span><span class="p">),))</span>
<span class="n">res</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=positive-diagram">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [40]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># calculate max lambda</span>
<span class="n">lambda_max</span> <span class="o">=</span> <span class="n">marchencko_pastur_bounds</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">num_var</span> <span class="o">/</span> <span class="n">num_obs</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">lambda_max</span>

<span class="c1"># number of recovered true factors</span>
<span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">eig_vals</span> <span class="o">&amp;gt;</span> <span class="n">lambda_max</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=offensive-potter">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [41]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mf">0.0</span><span class="p">,</span> <span class="mf">3.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">dv</span> <span class="o">=</span> <span class="n">marchencko_pastur_density</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>  <span class="n">num_var</span><span class="o">/</span><span class="n">num_obs</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">dv</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"red"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Marchencko-Pastur distribution"</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Eigenvalues of sample correlation matrix"</span><span class="p">);</span> 

<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=exclusive-heather">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Denoising">
        Denoising
        <a class="anchor-link" href="#Denoising">
         ¶
        </a>
       </h3>
       <p>
        <strong>
         Constant residual eigenvalue method
        </strong>
       </p>
       <p>
        This method sets all "random" eigenvectors the corresponding eigenvalue equal to a constant. Let $\{ \lambda \}_{n=1,..., N}$ be the eigenvalues (in descending order) and let $m$ denote the position of the eigenvalue such that $\lambda_m &amp;gt; \lambda_+$ and $\lambda_{m+1} \leq \lambda_+$. Then for $i = m + 1, ...., N$ we set
       </p>
       $$
\lambda_i = \frac{1}{N-i} \sum_{j=m + 1}^M \lambda_j
$$
       <p>
        This will preserve the trace of the correlation matrix.
       </p>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Eigendecomposition_of_a_matrix">
         eigenvector decompostion
        </a>
        tells us that we can write the correlation matrix as
       </p>
       $$
\mathbf{C} = \mathbf{V} \boldsymbol{\Lambda} \mathbf{V}^\top = \mathbf{V} \boldsymbol{\Lambda} \mathbf{V}^{-1}
$$
       <p>
        with $\mathbf{V}$ being the eigenvectors and $\boldsymbol{\Lambda}$ being a diagonal matrix of the eigenvalues.  The last equality holds since $\mathbf{V}$ is an
        <a href="https://en.wikipedia.org/wiki/Orthogonal_matrix">
         orthogonal matrix
        </a>
        .
       </p>
       <p>
        We define the denoised correlation matrix as
       </p>
       $$
\begin{align}
\tilde{\mathbf{C}}_{denoised} &amp;amp;= \mathbf{V} \tilde{\boldsymbol{\Lambda}} \mathbf{V}^\top \\
\mathbf{C}_{denoised} &amp;amp;= \tilde{\mathbf{C}}_{denoised} \left[ \left(\text{diag} \left[\tilde{\mathbf{C}}_{denoised} \right]^{1/2} \right)  \left(\text{diag} \left[\tilde{\mathbf{C}}_{denoised} \right]^{1/2} \right)^\top \right]^{-1}
\end{align}
$$
       <p>
        where $\tilde{\boldsymbol{\Lambda}}$ contains the corrected eigenvalues. The last line ensures that all the diagonal elements equal one.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=surprising-commissioner">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [42]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">crem_denoised_corr_mat</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="n">eigenvectors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span>
                           <span class="n">num_factors</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Denoises correlation matrix by fixing random eigenvalues</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    eigenvalues:</span>
<span class="sd">        Sorted eigenvalues.</span>
<span class="sd">    eigenvectors:</span>
<span class="sd">        Sorted eigenvectors</span>
<span class="sd">    num_factors:</span>
<span class="sd">        Number of factors.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Denoised correlation matrix.</span>

<span class="sd">    """</span>

    <span class="n">eig_vals</span> <span class="o">=</span> <span class="n">eigenvalues</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">eig_vals</span><span class="p">[</span><span class="n">num_factors</span><span class="p">:]</span> <span class="o">=</span> <span class="n">eig_vals</span><span class="p">[</span><span class="n">num_factors</span><span class="p">:]</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">)</span> <span class="o">-</span> <span class="n">num_factors</span><span class="p">)</span>
    <span class="n">eig_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">)</span>

    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">eigenvectors</span> <span class="o">@</span> <span class="n">eig_vals</span> <span class="o">@</span> <span class="n">eigenvectors</span><span class="o">.</span><span class="n">T</span>
    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">corr_mat</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=sitting-renewal">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [43]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># sort eigen vals</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">eig_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">eig_vals_sorted</span> <span class="o">=</span> <span class="n">eig_vals</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
<span class="n">eig_vectors_sorted</span> <span class="o">=</span> <span class="n">eig_vectors</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=supposed-break">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [44]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">denoised_corr</span> <span class="o">=</span> <span class="n">crem_denoised_corr_mat</span><span class="p">(</span><span class="n">eig_vals_sorted</span><span class="p">,</span> <span class="n">eig_vectors_sorted</span><span class="p">,</span> <span class="mi">100</span><span class="p">)</span>
<span class="n">denoised_eig_vals</span><span class="p">,</span> <span class="n">denoised_eig_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">denoised_corr</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=operational-milwaukee">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [45]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># sort eigen vals</span>
<span class="n">indices</span> <span class="o">=</span> <span class="n">denoised_eig_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">denoised_eig_vals_sorted</span> <span class="o">=</span> <span class="n">denoised_eig_vals</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
<span class="n">denoised_eig_vec_sorted</span> <span class="o">=</span> <span class="n">denoised_eig_vec</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=smart-warrant">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [46]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">eig_vals_sorted</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Original eigenvalues"</span><span class="p">);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">denoised_eig_vals_sorted</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Denoised eigenvalues"</span><span class="p">);</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Eigenvalue number"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Eigenvalue [log-scale]"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=union-marketing">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Targeted-shrinkage">
        <strong>
         Targeted shrinkage
        </strong>
        <a class="anchor-link" href="#Targeted-shrinkage">
         ¶
        </a>
       </h3>
       <p>
        The method applies shrinkage strictly to the random eigenvectors
       </p>
       $$
\mathbf{C}_{denoised} = \mathbf{V}_L \boldsymbol{\Lambda}_L \mathbf{V}_L^\top + \alpha \mathbf{V}_R \boldsymbol{\Lambda}_R \mathbf{V}_R^\top + (1-\alpha) \text{diag} \left[ \mathbf{V}_R \boldsymbol{\Lambda}_R \mathbf{V}^\top_R \right] 
$$
       <p>
        where $\mathbf{V}_L$ and $ \boldsymbol{\Lambda}_L$ are associated with the eigenvalues $\lambda &amp;gt; \lambda_{+}$ and $\mathbf{V}_R$ and $ \boldsymbol{\Lambda}_R$ are associated with the eigenvalues $\lambda \leq \lambda_{+}$. $\alpha$ regulates the amount of shrinkage ($\alpha=0$ for total shrinkage).
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=wrong-adoption">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [47]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">tsm_denoised_corr_mat</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">num_factors</span><span class="p">:</span> <span class="nb">int</span><span class="p">,</span>
                          <span class="n">alpha</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">-&amp;gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">:</span>

<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Denoises correlation matrix by shrinkage on eigenvectors</span>

<span class="sd">    Target shrinkage method.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    eigenvalues:</span>
<span class="sd">        Sorted eigenvalues.</span>
<span class="sd">    eigenvectors:</span>
<span class="sd">        Sorted eigenvectors</span>
<span class="sd">    num_factors:</span>
<span class="sd">        Number of factors.</span>
<span class="sd">    alpha:</span>
<span class="sd">        Weight.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    np.ndarray</span>
<span class="sd">        Denoised correlation matrix.</span>

<span class="sd">    """</span>

    <span class="n">eig_vals_l</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[:</span><span class="n">num_factors</span><span class="p">])</span>
    <span class="n">eig_vals_r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="n">num_factors</span><span class="p">:])</span>

    <span class="n">eig_vecs_l</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="p">:</span><span class="n">num_factors</span><span class="p">]</span>
    <span class="n">eig_vecs_r</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">num_factors</span><span class="p">:]</span>

    <span class="n">part1</span> <span class="o">=</span> <span class="n">eig_vecs_l</span> <span class="o">@</span> <span class="n">eig_vals_l</span> <span class="o">@</span> <span class="n">eig_vecs_l</span><span class="o">.</span><span class="n">T</span>
    <span class="n">part2</span> <span class="o">=</span> <span class="n">eig_vecs_r</span> <span class="o">@</span> <span class="n">eig_vals_r</span> <span class="o">@</span> <span class="n">eig_vecs_r</span><span class="o">.</span><span class="n">T</span>
    <span class="n">part3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">part2</span><span class="p">))</span>

    <span class="n">corr_mat</span> <span class="o">=</span> <span class="n">part1</span> <span class="o">+</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">part2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">alpha</span><span class="p">)</span> <span class="o">*</span> <span class="n">part3</span>

    <span class="k">return</span> <span class="n">corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=incredible-grant">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [48]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">denoised_corr</span> <span class="o">=</span> <span class="n">tsm_denoised_corr_mat</span><span class="p">(</span><span class="n">eig_vals_sorted</span><span class="p">,</span> <span class="n">eig_vectors_sorted</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.0</span><span class="p">)</span>
<span class="n">denoised_eig_vals</span><span class="p">,</span> <span class="n">denoised_eig_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eig</span><span class="p">(</span><span class="n">denoised_corr</span><span class="p">)</span>

<span class="n">indices</span> <span class="o">=</span> <span class="n">denoised_eig_vals</span><span class="o">.</span><span class="n">argsort</span><span class="p">()[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">denoised_eig_vals_sorted</span> <span class="o">=</span> <span class="n">denoised_eig_vals</span><span class="p">[</span><span class="n">indices</span><span class="p">]</span>
<span class="n">denoised_eig_vec_sorted</span> <span class="o">=</span> <span class="n">denoised_eig_vec</span><span class="p">[:,</span> <span class="n">indices</span><span class="p">]</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=tamil-transformation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [49]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_vals</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mf">1.0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">eig_vals</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">eig_vals_sorted</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Original eigenvalues"</span><span class="p">);</span> 
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_vals</span><span class="p">,</span> <span class="n">denoised_eig_vals_sorted</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Denoised eigenvalues"</span><span class="p">);</span> 
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">'log'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">();</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">"Eigenvalue number"</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">"Eigenvalue [log-scale]"</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=equal-designation">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Detoning">
        Detoning
        <a class="anchor-link" href="#Detoning">
         ¶
        </a>
       </h3>
       <p>
        In financial markets, the "market" component is often the dominant factor. We can think of it as characterized by the first eigenvector with loadings $\mathbf{V}_{n, 1} \approx 1 / \sqrt{N}$. The market component will affect every item of the covariance matrix why it sometimes make sense to remove the market component if we want a closer look at the remaining covariance structure. This is the similar to beta-adjusted returns in regression analysis.
       </p>
       <p>
        We can define the detoned correlation matrix as
       </p>
       $$
\begin{align}
\tilde{\mathbf{C}}_{detoned} &amp;amp;= \mathbf{C} - \mathbf{V}_M \boldsymbol{\Lambda}_M \mathbf{V}_M^\top = \mathbf{V}_D \boldsymbol{\Lambda}_D \mathbf{V}_D^\top\\
\mathbf{C}_{detoned} &amp;amp;= \tilde{\mathbf{C}}_{detoned} \left[ \left(\text{diag} \left[\tilde{\mathbf{C}}_{detoned} \right]^{1/2} \right)  \left(\text{diag} \left[\tilde{\mathbf{C}}_{detoned} \right]^{1/2} \right)^\top \right]^{-1}
\end{align}
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=stuck-dayton">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [50]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="k">def</span> <span class="nf">calculate_detoned_corr_mat</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">,</span> <span class="n">eigenvectors</span><span class="p">,</span> <span class="n">num_mkt_factors</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">"""</span>
<span class="sd">    Eigenvalues and eigenvectors are assumed sorted </span>
<span class="sd">    </span>
<span class="sd">    """</span>
    
    <span class="n">eig_vec_non_mkt</span> <span class="o">=</span> <span class="n">eigenvectors</span><span class="p">[:,</span> <span class="n">num_mkt_factors</span><span class="p">:]</span>
    
    <span class="n">corr</span> <span class="o">=</span> <span class="n">eig_vec_non_mkt</span> <span class="o">@</span> <span class="n">np</span><span class="o">.</span><span class="n">diag</span><span class="p">(</span><span class="n">eigenvalues</span><span class="p">[</span><span class="n">num_mkt_factors</span><span class="p">:])</span> <span class="o">@</span> <span class="n">eig_vec_non_mkt</span><span class="o">.</span><span class="n">T</span> 
    <span class="n">corr</span> <span class="o">=</span> <span class="n">cov_to_corr_matrix</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">corr</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=backed-incidence">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [51]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">detoned_corr_mat</span> <span class="o">=</span> <span class="n">calculate_detoned_corr_mat</span><span class="p">(</span><span class="n">denoised_eig_vals_sorted</span><span class="p">,</span> <span class="n">denoised_eig_vec_sorted</span><span class="p">,</span> <span class="n">num_mkt_factors</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">detoned_corr_mat</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=814e7570-d4a7-483a-b961-c6fe453a1b9c">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Instability-caused-by-signal">
        Instability caused by signal
        <a class="anchor-link" href="#Instability-caused-by-signal">
         ¶
        </a>
       </h2>
       <p>
        Consider the $2 \times 2$ correlation matrix
       </p>
       $$
\mathbf{C} = \begin{pmatrix} 1 &amp;amp; \rho \\
\rho &amp;amp; 1\end{pmatrix}
$$
       <p>
        which has the eigenvalues $1 + \rho$ and $1 - \rho$. Thus, if we increase the correlation one eigenvalue increase while the other will decrease.
       </p>
       <p>
        The inverse of the correlation matrix is given by
       </p>
       $$
\mathbf{C}^{-1} = \frac{1}{1 - \rho^2} \begin{pmatrix} 1 &amp;amp; -\rho \\
-\rho &amp;amp; 1\end{pmatrix}
$$
       <p>
        with eigenvalues $\frac{1}{1  + \rho}$ and $\frac{1}{1  - \rho}$. Thus, when the correlation comes close to one in absolute terms one of the eigenvalues will descrease to zero while the other one will explode. The determinante of $\mathbf{C}$ ($1 - \rho^2$) will go to zero when the correlation increases in absolute terms causing the inverse of the correlation matrix to explode.
       </p>
       <p>
        This will generally hold true. Besides the simply case of the identity correlation matrix, some variables have higher correlation among each other leading to both large and small eigenvalues in the correlation matrix and thereby also a problematic inverse of the correlation matrix. Since the inverse of the correlation / covariance matrix is important when obtaining optimal portfolios (e.g. think on the analytical formula for the minimum variance portfolio), this can lead to a large sensitivty to estimation error when calculating optimal portfolios.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hourly-passion">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="References">
        References
        <a class="anchor-link" href="#References">
         ¶
        </a>
       </h1>
       <h2 id="Articles">
        Articles
        <a class="anchor-link" href="#Articles">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.sciencedirect.com/science/article/pii/S0047259X03000964">
         Ledoit and Wolf (2004), "A well-conditioned estimator for large-dimensional covariance matrices"
        </a>
       </p>
       <h2 id="Books">
        Books
        <a class="anchor-link" href="#Books">
         ¶
        </a>
       </h2>
       <p>
        <a href="https://www.amazon.com/Machine-Learning-Managers-Elements-Quantitative/dp/1108792898">
         Marcos M. Lopéz de Prado (2020), "Machine Learning for Asset Managers"
        </a>
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
  <main>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=personal-retention">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [18]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="kn">import</span> <span class="nn">sys</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="s1">'C:</span><span class="se">\\</span><span class="s1">code</span><span class="se">\\</span><span class="s1">python_for_the_financial_economist</span><span class="se">\\</span><span class="s1">'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Magic commands</span>
<span class="sd">"""</span>

<span class="o">%</span><span class="k">load_ext</span> autoreload
<span class="o">%</span><span class="k">autoreload</span> 2

<span class="sd">"""</span>
<span class="sd">Load relevant packages</span>
<span class="sd">"""</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>

<span class="sd">"""</span>
<span class="sd">Own packages</span>
<span class="sd">"""</span>

<span class="kn">from</span> <span class="nn">codelib.visualization.layout</span> <span class="kn">import</span> <span class="n">DefaultStyle</span>
<span class="n">DefaultStyle</span><span class="p">();</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=blind-trauma">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h1 id="Univariate-statistics">
        Univariate statistics
        <a class="anchor-link" href="#Univariate-statistics">
         ¶
        </a>
       </h1>
       <p>
        In this Jupyter notebook, we will look at univariate statistics. In particular, we will look at how we can use (primarily) the
        <code>
         scipy.stats
        </code>
        package (see docs
        <a href="https://docs.scipy.org/doc/scipy/reference/stats.html">
         here
        </a>
        ) to work with random variables, distributions, moments, etc.
       </p>
       <p>
        Generally, we will look at continuous random variables, but replacing the integrals with sums will give the corresponding formulas for discrete random variables.
       </p>
       <p>
        A tutorial can be found
        <a href="https://docs.scipy.org/doc/scipy/tutorial/stats.html">
         here
        </a>
        .
       </p>
       <h2 id="Random-variables">
        Random variables
        <a class="anchor-link" href="#Random-variables">
         ¶
        </a>
       </h2>
       <p>
        Working with random variables is key when dealing with uncertain events, e.g. the future development of an equity portfolio.
       </p>
       <p>
        A
        <a href="https://en.wikipedia.org/wiki/Random_variable">
         random variable
        </a>
        $X(\omega)$ is a function of the outcome, $\omega$, in the sample space, $\Omega$, i.e $\omega \in \Omega$, to a measurable set $E$ (typically the real numbes $\mathbb{R}$) such that each possible value $x$ of the random variable defines an event in $\Omega$.
       </p>
       <p>
        The probability that $X$ takes on a value in a measurable set $S \subseteq E$ is
       </p>
       $$
\text{P} (X\in S)= \text{P} (\{\omega \in \Omega \mid X(\omega )\in S\}) 
$$
       <p>
        We will typically describe a random variable in terms of its distribution which can be represented in different ways:
       </p>
       <ul>
        <li>
         Probability function (discrete random variable) or probability density function (continuous random variable)
        </li>
        <li>
         Cummulative distribution function
        </li>
        <li>
         Characteristic function
        </li>
        <li>
         Quantile function
        </li>
       </ul>
       <h3 id="Probability-density-function">
        Probability density function
        <a class="anchor-link" href="#Probability-density-function">
         ¶
        </a>
       </h3>
       <p>
        If $X: \Omega \to \mathbb{R}$ is a continuous random variable, then $f_X$ is a
        <a href="https://en.wikipedia.org/wiki/Probability_density_function">
         probability density function
        </a>
        if
       </p>
       $$
f_X(x) \geq 0
$$
       <p>
        and
       </p>
       $$
\intop_{- \infty}^\infty f_X(x) dx = 1
$$
       <p>
        We will be able to calculate probabilites using the integral
       </p>
       $$
\text{P}(X \in [a, b]) = \intop_{a}^b f_X(x)dx
$$
       <p>
        <strong>
         Example: Normal distribution
        </strong>
       </p>
       <p>
        The density of a normal distribution is given by
       </p>
       $$
f_X\left(x; \mu, \sigma^2 \right) = \frac{1}{\sigma \sqrt{ 2 \pi}} e^{-\frac{1}{2}\left(\frac{x-\mu}{\sigma}\right)^2}
$$
       <p>
        We can use the
        <code>
         norm
        </code>
        class in
        <code>
         scipy.stats
        </code>
        to work with the normal distribution (note that
        <code>
         scipy.stats
        </code>
        is imported as
        <code>
         stats
        </code>
        ). See documentation
        <a href="https://docs.scipy.org/doc/scipy/reference/generated/scipy.stats.norm.html#scipy.stats.norm">
         here
        </a>
        .
        <code>
         norm
        </code>
        contains the method
        <code>
         pdf(x, loc=0, scale=1)
        </code>
        . The location parameter
        <code>
         loc
        </code>
        corresponds to $\mu$ and the scale parameter
        <code>
         scale
        </code>
        corresponds to $\sigma$.
       </p>
       <p>
        We can therefore easily plot the pdf of a normal distribution
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=super-spanish">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [19]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$f_X(x)$'</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="mi">14</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=destroyed-alpha">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Cumulative-distribution-function">
        Cumulative distribution function
        <a class="anchor-link" href="#Cumulative-distribution-function">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Cumulative_distribution_function">
         cummulative distribution function
        </a>
        $F_X$ is defined by the probability that the random variables takes a values less than $x$
       </p>
       $$
F_X(x) = \intop_{-\infty}^x f_x(u)du = \text{P} (\{\omega \in \Omega \mid X(\omega ) \leq x \}) = P(X \leq x) 
$$
       <p>
        This also implies that
       </p>
       $$
\frac{d}{dx} F_X(x) = f_X(x)
$$
       <p>
        It should be notet that
       </p>
       $$
\begin{align}
\underset{x \to \infty}{\lim} F_X(x) &amp;amp;= 1\\
\underset{x \to -\infty}{\lim } F_X(x) &amp;amp;= 0
\end{align}
$$
       <p>
        From simple integration rules, it is clear that we will be able to calculate probabilites using
       </p>
       $$
\text{P}(X \in [a, b]) = \intop_{a}^b f_X(x)dx = \intop_{-\infty}^b f_X(x)dx - \intop_{-\infty}^a f_X(x)dx = F_X(b) - F_X(a)
$$
       <p>
        <strong>
         Example: Normal distribution
        </strong>
       </p>
       <p>
        The cdf of a normal distribution is given by
       </p>
       $$
F_X(x; \mu, \sigma^2) = \frac {1}{2}\left[1+\text {erf} \left({\frac {x-\mu }{\sigma {\sqrt {2}}}}\right)\right]
$$
       <p>
        where $\text{erf}$ is the
        <a href="https://en.wikipedia.org/wiki/Error_function">
         error function
        </a>
        .
       </p>
       <p>
        Again, we can use the
        <code>
         norm
        </code>
        class in
        <code>
         scipy.stats
        </code>
        . The class
        <code>
         norm
        </code>
        contains the method
        <code>
         cdf(x, loc=0, scale=1)
        </code>
        . We can therefore easily plot the cdf of a normal distribution.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=together-potato">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [20]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">cdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">cdf_values</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$F_X(x)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=swedish-columbia">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        We can also easily calculate the probability that the normal random variable is between $a$ and $b$
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=attended-blood">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [21]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mf">3.0</span>
<span class="n">b</span> <span class="o">=</span> <span class="mf">7.0</span>
<span class="n">mu</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">prob</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span> <span class="o">-</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span> 
<span class="n">prob</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=permanent-median">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [22]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">cdf_values</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">cdf_values</span><span class="p">,</span> <span class="n">where</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">x_values</span><span class="o">&amp;gt;</span><span class="mf">2.0</span><span class="p">,</span><span class="n">x_values</span><span class="o">&amp;lt;</span><span class="n">b</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$F_X(x)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=analyzed-groove">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Characteristic-function">
        Characteristic function
        <a class="anchor-link" href="#Characteristic-function">
         ¶
        </a>
       </h3>
       <p>
        The
        <a href="https://en.wikipedia.org/wiki/Characteristic_function_(probability_theory)">
         characteristic function
        </a>
        is defined by the expectation
       </p>
       $$
\varphi_X(t) \equiv \text{E}\left[ e^{i t X} \right]
$$
       <p>
        where $i = \sqrt{-1}$ is the
        <a href="https://en.wikipedia.org/wiki/Imaginary_unit">
         imaginary unit
        </a>
        . It can takes complex values such that $\varphi_X: \mathbb{R} \to \mathbb{C}$.
       </p>
       <p>
        The definition implies that
       </p>
       $$
\varphi_X(t) = \text{E}\left[ e^{i t X} \right] = \intop_{-\infty}^\infty e^{i t x} f_X(x)dx
$$
       <h3 id="Quantile-function">
        Quantile function
        <a class="anchor-link" href="#Quantile-function">
         ¶
        </a>
       </h3>
       <p>
        The quantile function of a random variable, $Q_X$, is the inverse of the cummulative distribution function
       </p>
       $$
Q_X(p) = F_X^{-1}(p)
$$
       <p>
        such that
       </p>
       $$
P(X \leq Q_X(p)) = p
$$
       <p>
        We illustrate the percentiles for a standard normal random variable below.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=impressive-roberts">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [23]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="mf">3.5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">ticks</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.05</span><span class="p">,</span>  <span class="mf">0.25</span><span class="p">,</span>  <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">,</span> <span class="mf">0.99</span><span class="p">]</span>
<span class="n">tick_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">'1%'</span><span class="p">,</span> <span class="s1">'5%'</span><span class="p">,</span> <span class="s1">'25%'</span><span class="p">,</span> <span class="s1">'50%'</span><span class="p">,</span> <span class="s1">'75%'</span><span class="p">,</span> <span class="s1">'95%'</span><span class="p">,</span> <span class="s1">'99%'</span><span class="p">]</span>

<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">perc_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">(</span><span class="n">ticks</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">cdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">percentile_to_plot</span> <span class="o">=</span> <span class="n">perc_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">cdf_val_to_plot</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">cdf</span><span class="p">(</span><span class="n">percentile_to_plot</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">Plotting</span>
<span class="sd">"""</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">6</span><span class="p">))</span>

<span class="sd">"""</span>
<span class="sd">Pdf</span>
<span class="sd">"""</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">fill_between</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">,</span>
                 <span class="n">where</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">logical_and</span><span class="p">(</span><span class="n">x_values</span><span class="o">&amp;gt;-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">x_values</span><span class="o">&amp;lt;</span><span class="n">percentile_to_plot</span><span class="p">))</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">perc_values</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>


<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'Density for standard normal'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Percentile'</span><span class="p">);</span>


<span class="sd">"""</span>
<span class="sd">cdf</span>
<span class="sd">"""</span>

<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">cdf_values</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">perc_values</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">(</span><span class="n">tick_labels</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">axvline</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">percentile_to_plot</span><span class="p">,</span> <span class="n">ymin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ymax</span><span class="o">=</span><span class="n">cdf_val_to_plot</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="o">-</span><span class="mf">3.5</span><span class="p">,</span> <span class="n">percentile_to_plot</span><span class="p">],[</span><span class="n">cdf_val_to_plot</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">'CDF for standard normal'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Cumulative density'</span><span class="p">);</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'Percentile'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=specified-alliance">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        <strong>
         Example: Normal distribution
        </strong>
       </p>
       <p>
        Again, we can use the
        <code>
         norm
        </code>
        class in
        <code>
         scipy.stats
        </code>
        . The class
        <code>
         norm
        </code>
        contains the method
        <code>
         ppf(q, loc=0, scale=1)
        </code>
        . We can therefore easily calculate quantiles of a normal distribution
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=assumed-vaccine">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [24]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="sd">"""</span>
<span class="sd">Calculate the 5th and 95th quantile</span>
<span class="sd">"""</span>

<span class="n">mu</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">quantiles</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">ppf</span><span class="p">([</span><span class="mf">0.05</span><span class="p">,</span> <span class="mf">0.95</span><span class="p">],</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
<span class="n">quantiles</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=digital-announcement">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Moments">
        Moments
        <a class="anchor-link" href="#Moments">
         ¶
        </a>
       </h2>
       <p>
        Moments such as the mean and variance are relevant summary statistics to describe the properties of different distributions.
       </p>
       <h3 id="Expected-value">
        Expected value
        <a class="anchor-link" href="#Expected-value">
         ¶
        </a>
       </h3>
       <p>
        The first moment of the probability distribution of a random variable $X$ is the expected value of $X$ which we will denote by $\text{E}[X]=\mu=\mu_X$. It is defined as
       </p>
       $$
\begin{equation*}
\text{E}[X] = \int_{-\infty}^\infty x f_X(x) dx
\end{equation*}
$$
       <p>
        If $g(X)$ is a function of $X$ (and $\int_{-\infty}^\infty \vert g(x) \vert f_X(x) dx &amp;lt; \infty$) then
       </p>
       $$
\begin{equation*}
\text{E}[g(X)] = \int_{-\infty}^\infty g(x) f_X(x) dx
\end{equation*}
$$
       <p>
        implying the well-known rule
       </p>
       $$
\text{E}[aX + b] = a \text{E}[X] + b
$$
       <p>
        Please note that generally,
       </p>
       $$
g(\text{E}[X]) \neq \text{E}[g(X)]
$$
       <p>
        <strong>
         Example: Normal distribution
        </strong>
       </p>
       <p>
        The expected value of a normal random variable is given by the location parameter $\mu$.
       </p>
       <p>
        Again, we can use the
        <code>
         norm
        </code>
        class in
        <code>
         scipy.stats
        </code>
        . The class
        <code>
         norm
        </code>
        contains the methods
        <code>
         mean(loc=0, scale=1)
        </code>
        ,
        <code>
         moment(n, loc=0, scale=1)
        </code>
        ,
        <code>
         stats(loc=0, scale=1, moments=’mv’)
        </code>
        and
        <code>
         expect(func, args=(), loc=0, scale=1, lb=None, ub=None, conditional=False, **kwds)
        </code>
        that are relevant for calculating moments.
       </p>
       <p>
        Let us try to calculate mean of a normal distribution
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=inappropriate-station">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [25]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=metric-horse">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [26]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># the expected value is the first moment</span>
<span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">moment</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=suspected-hearing">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [27]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="c1"># An alternative method</span>
<span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="s1">'m'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=enclosed-fancy">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <p>
        Consider
       </p>
       $$
g(X) = X^2
$$
       <p>
        We would like to compare $\text{E}[g(X)]$ and $g(\text{E}[X])$ to show that they are generally not the same!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=historic-county">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [28]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="w"> </span><span class="sd">"""</span>
<span class="sd"> Calculate E(g(X))</span>
<span class="sd"> """</span>
<span class="c1"># define a lambda function returning x^2</span>
<span class="n">g</span> <span class="o">=</span> <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">**</span><span class="mi">2</span>

<span class="c1">#def g(x, a): </span>
<span class="c1">#    return a + x**2</span>
    
<span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">expect</span><span class="p">(</span><span class="n">g</span><span class="p">,</span> <span class="n">args</span><span class="o">=</span><span class="p">(),</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=offshore-custom">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [29]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="w"> </span><span class="sd">"""</span>
<span class="sd"> Calculate g(E(X))</span>
<span class="sd"> """</span>

<span class="n">g</span><span class="p">(</span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">))</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=disabled-sperm">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Variance">
        Variance
        <a class="anchor-link" href="#Variance">
         ¶
        </a>
       </h3>
       <p>
        The variance of a random variable is the expected value of its squared deviation from its mean $\mu$ - the dispersion about the centre of the density. The variance is defined by
       </p>
       $$
\begin{equation*}
\text{Var}[X] = \sigma^2 = \text{E}[(X-\mu)^2] = \intop_{-\infty}^\infty (x-\mu)^2 f_X(x) dx
\end{equation*}
$$
       <p>
        We assume that $\text{E}[X^2]$ is finite, but this may not always be the case.
       </p>
       <p>
        We can for a random variable $X$ also write
       </p>
       $$
\begin{equation*}
\text{Var}[X] = \text{E}[X^2] - \mu^2
\end{equation*}
$$
       <p>
        The following rule is often used. Let $X$ be any random variable having mean $\mu$ and where $\text{E}[X^2]$ is finite. Then,
       </p>
       $$
\begin{equation*}
\text{Var}[b + aX] = a^2\text{Var}[X]
\end{equation*}
$$
       <p>
        We define the standard deviation as the square root of the variance
       </p>
       $$
\text{Sd}[X] = \sqrt{\text{Var}[X]}
$$
       <p>
        <strong>
         Example: Normal distribution
        </strong>
       </p>
       <p>
        The variance of a normal random variable is given by the squared scale parameter $\sigma^2$.
       </p>
       <p>
        Again, we can use the
        <code>
         norm
        </code>
        class in
        <code>
         scipy.stats
        </code>
        . The class
        <code>
         norm
        </code>
        contains the methods
        <code>
         var(loc=0, scale=1)
        </code>
        ,
        <code>
         std(loc=0, scale=1)
        </code>
        , and
        <code>
         stats(loc=0, scale=1, moments=’mv’)
        </code>
        for calculating the variance.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=transsexual-corps">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [30]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">var</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=underlying-hardwood">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [31]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">stats</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">moments</span><span class="o">=</span><span class="s1">'v'</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=loving-refrigerator">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h3 id="Higher-order-moments">
        Higher order moments
        <a class="anchor-link" href="#Higher-order-moments">
         ¶
        </a>
       </h3>
       <p>
        Let $X$ be any random variable with $f_X(x)$ and $k$ be any positive integer. The $k$'th moment of $X$ about the origin (raw moment) is given by
       </p>
       $$
\text{RM}^k [X] = \text{E}[X^k]
$$
       <p>
        and the $k$'th moment of $X$ about the mean (central moment) is given by
       </p>
       $$
\text{CM}^k [X] = \text{E}[(X-\mu)^k]
$$
       <p>
        Again, we need the integrals for the expected values to be defined. Thus, $\int_{-\infty}^\infty \vert x \vert^k f_X(x) dx &amp;lt; \infty$.
       </p>
       <p>
        <strong>
         Skewnewss and kurtosis
        </strong>
       </p>
       <p>
        The skewness coefficient
       </p>
       $$
\begin{equation*}
\text{Skew}[X] = \frac{\text{E}[(X-\mu)^3]}{\sigma^3}
\end{equation*}
$$
       <p>
        and the coefficient of (excess) kurtosis
       </p>
       $$
\begin{equation*}
 \text{Kurt}[X] = \frac{\text{E}[(X-\mu)^4]}{\sigma^4} - 3
\end{equation*}
$$
       <p>
        are very important in finance. Excess kurtosis refers to the fact that the kurtosis of a normal distribution is $3$.
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=outer-burden">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [32]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">n_dens</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">t_dens</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">t</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">df</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>

<span class="sd">"""</span>
<span class="sd">Norm vs. t-dist </span>
<span class="sd">"""</span>

<span class="n">ax1</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">n_dens</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">'Normal'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">t_dens</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"gray"</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s2">"--"</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s2">"Leptokurtic, </span><span class="se">\n</span><span class="s2"> kurtosis&amp;gt;0"</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Standard normal vs. t-distribution with n=5"</span><span class="p">)</span>

<span class="n">ax1</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="n">ax1</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">)</span>

<span class="sd">"""</span>
<span class="sd">log-normal</span>
<span class="sd">"""</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>

<span class="n">logn_dens</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">lognorm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">s</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">ax2</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">logn_dens</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s2">"black"</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Log-normal, positively skewed"</span><span class="p">)</span>

<span class="n">ax2</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'x'</span><span class="p">)</span>
<span class="n">ax2</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'Density'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=ruled-handbook">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Drawing-from-a-distribution">
        Drawing from a distribution
        <a class="anchor-link" href="#Drawing-from-a-distribution">
         ¶
        </a>
       </h2>
       <p>
        We will often be interested in drawing random samples from a particular distribution, e.g. when examing the properties of estimators or when performing Monte Carlo simulations.
       </p>
       <p>
        <strong>
         Example: Normal distribution
        </strong>
       </p>
       <p>
        Again, we can use the
        <code>
         norm
        </code>
        class in
        <code>
         scipy.stats
        </code>
        . The class
        <code>
         norm
        </code>
        contains the method
        <code>
         rvs(loc=0, scale=1, size=1)
        </code>
        . We can easily draw a random sample from a normal distribution!
       </p>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell jp-mod-noOutputs" id="cell-id=higher-adams">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [33]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>
<span class="n">size</span> <span class="o">=</span> <span class="mi">1000</span> <span class="c1"># drawing 1000 observations</span>

<span class="n">random_sample</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">rvs</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">size</span><span class="p">)</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-CodeCell jp-Notebook-cell" id="cell-id=appointed-equipment">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
       In [34]:
      </div>
      <div class="jp-CodeMirrorEditor jp-Editor jp-InputArea-editor" data-type="inline">
       <div class="cm-editor cm-s-jupyter">
        <div class="highlight hl-ipython3">
         <pre><span></span><span class="n">mu</span> <span class="o">=</span> <span class="mf">5.0</span>
<span class="n">sigma</span> <span class="o">=</span> <span class="mf">2.0</span>

<span class="n">x_values</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="p">,</span> <span class="mf">12.0</span><span class="p">,</span> <span class="mi">1000</span><span class="p">)</span>
<span class="n">pdf_values</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">pdf</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">loc</span><span class="o">=</span><span class="n">mu</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">sigma</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x_values</span><span class="p">,</span> <span class="n">pdf_values</span><span class="p">);</span>
<span class="n">ax</span><span class="o">.</span><span class="n">hist</span><span class="p">(</span><span class="n">random_sample</span><span class="p">,</span> <span class="n">bins</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">density</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">"Histogram of random sample vs. true density"</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">'$x$'</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">'$f_X(x)$'</span><span class="p">);</span>
</pre>
        </div>
       </div>
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=coastal-subsection">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="The-empirical-distribution">
        The empirical distribution
        <a class="anchor-link" href="#The-empirical-distribution">
         ¶
        </a>
       </h2>
       <p>
        An
        <a href="https://en.wikipedia.org/wiki/Empirical_distribution_function">
         empirical distribution function
        </a>
        is the distribution function associated with the empirical measure of a sample.
       </p>
       <p>
        Let $X_1, ..., X_n$ be a sequence iid random variables with cdf $F_X(x)$, then the empirical distribution function is defined as
       </p>
       $$
F_n(x) = \frac{1}{n}\sum_{i=1}^n I(X_i \leq x)
$$
       <p>
        where $I(X_i \leq x)$ is an indicator function taking the value 1 if $X_i \leq x$ and zero otherwise. Under regularity conditions, the empirical distribution function $F_n$ will converge to the true cdf when $n \to \infty$.
       </p>
       <p>
        We can calculate e.g. the mean and variance of the empirical distribution (integrals are replaced by sums since the empirical distribution is discrete)
       </p>
       $$
\text{E}_n [X] = \frac{1}{n}\sum_{i=1}^N x_i
$$
       <p>
        and
       </p>
       $$
\text{Var}_n [X] = \frac{1}{n}\sum_{i=1}^N (x_i - \text{E}_n[X])^2
$$
       <p>
        We will sometimes use the empirical distribution directly when we want to relate the past and the future. E.g. assuming that
       </p>
       $$
\boldsymbol{X} \sim F_n(x)
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=divine-stations">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Scenario-probabilities">
        Scenario probabilities
        <a class="anchor-link" href="#Scenario-probabilities">
         ¶
        </a>
       </h2>
       <p>
        We will in this course consider assigning different probabilities to each scenario and not necessarily $1 / n$ as for the empirical distribution function above. We will assume that
       </p>
       $$
\boldsymbol{X} \sim \{p_i, x_i \}_{i=1}^n
$$
       <p>
        where
       </p>
       $$
\sum_{i=1}^n p_i = 1 \; \text{ and }\; \{p_i \geq 0 \}_{i=1}^n
$$
       <p>
        We can define the scenario distribution function
       </p>
       $$
F_n(x) = \sum_{i=1}^n p_i I(X_i \leq x)
$$
       <p>
        We can use it to calculate moments, e.g. the mean
       </p>
       $$
\text{E}_n [X] = \sum_{i=1}^n p_i x_i
$$
       <p>
        <strong>
         Example
        </strong>
       </p>
       <p>
        We may have the four scenarios
       </p>
       \begin{equation}
\{p_j, x_j \}_{j=1}^4 = \{(0, 0.33), (0, 0.1), (1, 0.2), (1, 0.37)\}
\end{equation}
       <p>
        Probabilities sum to one and are all positive
       </p>
       $$
\sum_{i=1}^4 p_i = 0.33 + 0.1 + 0.2 + 0.37 = 1
$$
       <p>
        The expected value is given by
       </p>
       $$
\sum_{i=1}^4 p_i x_i = 0.33 \cdot 0 + 0.1 \cdot 0 + 0.2 \cdot 1 + 0.37 \cdot 1 = 0.57
$$
      </div>
     </div>
    </div>
   </div>
   <div class="jp-Cell jp-MarkdownCell jp-Notebook-cell" id="cell-id=hawaiian-professional">
    <div class="jp-Cell-inputWrapper" tabindex="0">
     <div class="jp-Collapser jp-InputCollapser jp-Cell-inputCollapser">
     </div>
     <div class="jp-InputArea jp-Cell-inputArea">
      <div class="jp-InputPrompt jp-InputArea-prompt">
      </div>
      <div class="jp-RenderedHTMLCommon jp-RenderedMarkdown jp-MarkdownOutput" data-mime-type="text/markdown">
       <h2 id="Summary">
        Summary
        <a class="anchor-link" href="#Summary">
         ¶
        </a>
       </h2>
       <p>
        We have revisited basic properties of univariate distributions and how to use
        <code>
         scipy.stats
        </code>
        to calculate densities, moments, etc. for the normal distribution.
       </p>
       <p>
        <code>
         scipy.stats
        </code>
        has implemented numerous distributions that can be used in a similar fashion (see
        <a href="https://docs.scipy.org/doc/scipy/reference/stats.html">
         here
        </a>
        for a list)
       </p>
       <p>
        We note that all the distributions has the method
        <code>
         rvs
        </code>
        that makes it possible to generate random draws from this particular distribution.
       </p>
      </div>
     </div>
    </div>
   </div>
  </main>
 </body>
</html>
